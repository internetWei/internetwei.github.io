<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="AutoreleasePoolï¼šiOS å†…å­˜ç®¡ç†ä¹ç« ä¸­çš„éšç§˜æ—‹å¾‹"><meta name="keywords" content="å†…å­˜ç®¡ç†"><meta name="author" content="å¸ƒå¤š"><meta name="copyright" content="å¸ƒå¤š"><title>AutoreleasePoolï¼šiOS å†…å­˜ç®¡ç†ä¹ç« ä¸­çš„éšç§˜æ—‹å¾‹ | å¸ƒå¤šçš„åšå®¢</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?f0d94d3f99211c3546490e469f6ecbd8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹:${query}"}},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  hexoVersion: '6.3.0'
} </script><link rel="alternate" href="/atom.xml" title="å¸ƒå¤šçš„åšå®¢" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="åˆ‡æ¢æ–‡ç« è¯¦æƒ…">åˆ‡æ¢ç«™ç‚¹æ¦‚è§ˆ</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">ç›®å½•</div><div class="sidebar-toc__progress"><span class="progress-notice">ä½ å·²ç»è¯»äº†</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%AD%E5%BC%80-AutoreleasePool-%E7%9A%84%E9%9D%A2%E7%BA%B1"><span class="toc-number">1.</span> <span class="toc-text">æ­å¼€ AutoreleasePool çš„é¢çº±</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E5%BA%95%E5%B1%82%EF%BC%9AAutoreleasePool-%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6"><span class="toc-number">2.</span> <span class="toc-text">æ·±å…¥åº•å±‚ï¼šAutoreleasePool çš„å®ç°æœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#autoreleasing-%E4%BF%AE%E9%A5%B0%E7%AC%A6%E7%9A%84%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.1.</span> <span class="toc-text">__autoreleasing ä¿®é¥°ç¬¦çš„å†…éƒ¨å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AutoreleasePoolPage%EF%BC%9A%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E7%9A%84%E5%9F%BA%E7%9F%B3"><span class="toc-number">2.2.</span> <span class="toc-text">AutoreleasePoolPageï¼šå†…å­˜ç®¡ç†çš„åŸºçŸ³</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#autoreleasepool-%E7%9A%84%E4%BC%98%E9%9B%85%E4%B9%8B%E9%81%93"><span class="toc-number">2.3.</span> <span class="toc-text">@autoreleasepool çš„ä¼˜é›…ä¹‹é“</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E4%B8%8E-AutoreleasePool%EF%BC%9A%E7%BA%A0%E7%BC%A0%E7%9A%84%E5%8F%8C%E8%9E%BA%E6%97%8B"><span class="toc-number">3.</span> <span class="toc-text">çº¿ç¨‹ä¸ AutoreleasePoolï¼šçº ç¼ çš„åŒèºæ—‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%EF%BC%9ATLS-%E6%9C%BA%E5%88%B6%E8%A7%A3%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">æ€§èƒ½ä¼˜åŒ–ï¼šTLS æœºåˆ¶è§£æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E8%AF%AF%E5%8C%BA%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">5.</span> <span class="toc-text">å¸¸è§è¯¯åŒºä¸æœ€ä½³å®è·µ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">æŠ€æœ¯æ€»ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">7.</span> <span class="toc-text">å‚è€ƒèµ„æ–™</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/images/avatar.jpg"></div><div class="author-info__name text-center">å¸ƒå¤š</div><div class="author-info__description text-center">å‰è¿›ï¼å‰è¿›ï¼ï¼ä¸æ‹©æ‰‹æ®µåœ°å‰è¿›ï¼ï¼ï¼</div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/internetwei">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">æ–‡ç« </span><span class="pull-right">13</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">æ ‡ç­¾</span><span class="pull-right">10</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">åˆ†ç±»</span><span class="pull-right">4</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">å‹é“¾</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://www.coderqi.com/">é½å°èƒ–ä¹‹å®¶</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/images/backgroundImage.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">å¸ƒå¤šçš„åšå®¢</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">é¦–é¡µ</a><a class="site-page" href="/tags">æ ‡ç­¾</a><a class="site-page" href="/categories">åˆ†ç±»</a><a class="site-page" href="/archives">å½’æ¡£</a><a class="site-page" href="/about">å…³äº</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> æœç´¢</span></a></span></div><div id="post-info"><div id="post-title">AutoreleasePoolï¼šiOS å†…å­˜ç®¡ç†ä¹ç« ä¸­çš„éšç§˜æ—‹å¾‹</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2025-03-30</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/iOS/">iOS</a><div class="post-meta-wordcount"><span>å­—æ•°æ€»è®¡: </span><span class="word-count">5.9k</span><span class="post-meta__separator">|</span><span>é˜…è¯»æ—¶é•¿: 20 åˆ†é’Ÿ</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><blockquote>
<p>ç”± å¸ƒå¤š(budo) å‘å¸ƒäº 2025-03-30</p>
</blockquote>
<h2 id="æ­å¼€-AutoreleasePool-çš„é¢çº±"><a href="#æ­å¼€-AutoreleasePool-çš„é¢çº±" class="headerlink" title="æ­å¼€ AutoreleasePool çš„é¢çº±"></a>æ­å¼€ AutoreleasePool çš„é¢çº±</h2><p>AutoreleasePoolï¼ˆä¸­æ–‡ä¹Ÿå«è‡ªåŠ¨é‡Šæ”¾æ± ï¼‰æ˜¯ iOS å†…å­˜ç®¡ç†æœºåˆ¶ä¸­çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ã€‚å®ƒä¼˜é›…åœ°è§£å†³äº†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„é—®é¢˜ - é€šè¿‡å»¶è¿Ÿå¯¹è±¡çš„é‡Šæ”¾æ—¶æœºï¼Œåœ¨åˆé€‚çš„æ—¶é—´ç‚¹ç»Ÿä¸€å›æ”¶å†…å­˜èµ„æºã€‚</p>
<p>è¿™ä¸ªç²¾å¦™çš„è®¾è®¡èƒŒåæœ‰ç€æ€æ ·çš„å®ç°åŸç†å‘¢ï¼Ÿè®©æˆ‘ä»¬ä¸€èµ·æ·±å…¥ <a target="_blank" rel="noopener" href="https://github.com/apple-oss-distributions/objc4/">objc4</a> å¼€æºé¡¹ç›®çš„æºç ï¼Œå»æ¢ç´¢ AutoreleasePool çš„åº•å±‚å®ç°ç»†èŠ‚ã€‚</p>
<blockquote>
<p>ğŸ“ æœ¬æ–‡ä½¿ç”¨çš„ Runtime ç‰ˆæœ¬æ˜¯ <a target="_blank" rel="noopener" href="https://github.com/apple-oss-distributions/objc4/tree/objc4-906">objc4-906</a>ã€‚ä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œæˆ‘å¯¹ä»£ç æ ·å¼å’Œæ’ç‰ˆç•¥ä½œäº†ä¿®æ”¹ï¼Œå¹¶åˆ å‡äº†ä¸€äº›ä¸å½±å“ä¸»é€»è¾‘çš„å†—ä½™ä»£ç ã€‚</p>
<p>ğŸ”§ æˆ‘åœ¨ <a target="_blank" rel="noopener" href="https://github.com/internetWei/ObjCRuntimes">è¿™é‡Œ</a> ç»´æŠ¤äº†ä¸€ä¸ªå¯ä»¥ç›´æ¥è¿è¡Œè°ƒè¯•çš„ Runtime é¡¹ç›®ï¼Œæ¬¢è¿å¤§å®¶ä¸‹è½½è°ƒè¯•æºç ã€‚</p>
</blockquote>
<h2 id="æ·±å…¥åº•å±‚ï¼šAutoreleasePool-çš„å®ç°æœºåˆ¶"><a href="#æ·±å…¥åº•å±‚ï¼šAutoreleasePool-çš„å®ç°æœºåˆ¶" class="headerlink" title="æ·±å…¥åº•å±‚ï¼šAutoreleasePool çš„å®ç°æœºåˆ¶"></a>æ·±å…¥åº•å±‚ï¼šAutoreleasePool çš„å®ç°æœºåˆ¶</h2><p>åœ¨ ARC ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ä½œä¸ºå¼€å‘è€…èƒ½å¤Ÿæ¥è§¦åˆ° AutoreleasePool çš„åœºæ™¯ä¸»è¦æœ‰ä¸¤ç§ï¼š</p>
<ol>
<li><p>ä½¿ç”¨ <code>__autoreleasing</code> ä¿®é¥°ç¬¦</p>
<ul>
<li>å°†å¯¹è±¡æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­</li>
<li>å®ç°å¯¹è±¡çš„å»¶è¿Ÿé‡Šæ”¾æœºåˆ¶</li>
</ul>
</li>
<li><p>ä½¿ç”¨ <code>@autoreleasepool &#123;&#125;</code> è¯­æ³•å—</p>
<ul>
<li>ç²¾ç¡®æ§åˆ¶å†…å­˜çš„é‡Šæ”¾æ—¶æœº</li>
<li>æœ‰æ•ˆæ§åˆ¶å†…å­˜å³°å€¼</li>
</ul>
</li>
</ol>
<p>è®©æˆ‘ä»¬ä¸€èµ·æ·±å…¥æºç å’Œæ±‡ç¼–å±‚é¢ï¼Œæ­å¼€è¿™ä¸¤ç§ä½¿ç”¨åœºæ™¯èƒŒåçš„æŠ€æœ¯å®ç°ç»†èŠ‚ã€‚</p>
<h3 id="autoreleasing-ä¿®é¥°ç¬¦çš„å†…éƒ¨å®ç°"><a href="#autoreleasing-ä¿®é¥°ç¬¦çš„å†…éƒ¨å®ç°" class="headerlink" title="__autoreleasing ä¿®é¥°ç¬¦çš„å†…éƒ¨å®ç°"></a>__autoreleasing ä¿®é¥°ç¬¦çš„å†…éƒ¨å®ç°</h3><p><img src="objc_autorelease%E5%85%A5%E5%8F%A3.png"></p>
<p>ä»æ–­ç‚¹çš„æ±‡ç¼–ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ __autoreleasing ä¿®é¥°ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†å…¶è½¬æ¢ä¸ºå¯¹ objc_autorelease å‡½æ•°çš„è°ƒç”¨ã€‚è¿™ä¸ªæ“ä½œç­‰åŒäºåœ¨ MRC ç¯å¢ƒä¸‹æ‰‹åŠ¨è°ƒç”¨å¯¹è±¡çš„ autorelease æ–¹æ³•ï¼Œå®ƒä»¬åœ¨åº•å±‚å®ç°ä¸Šæ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚</p>
<p>è®©æˆ‘ä»¬æ·±å…¥ Runtime æºç ï¼Œä¸€æ¢ objc_autorelease çš„å†…éƒ¨å®ç°ã€‚ä»¥ä¸‹æ˜¯ç»è¿‡æ•´ç†çš„æ ¸å¿ƒä»£ç ï¼ˆå¦‚æœè§‰å¾—ä»£ç å¤ªé•¿å¯ä»¥å…ˆè·³è¿‡ï¼Œåé¢ä¼šæœ‰è¯¦ç»†è§£é‡Šï¼‰ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">id <span class="title">objc_autorelease</span><span class="params">(id obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> obj-&gt;<span class="built_in">autorelease</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">id <span class="title">objc_object::autorelease</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">     æ£€æŸ¥è¯¥å¯¹è±¡æ˜¯å¦æœ‰è‡ªå®šä¹‰çš„å¼•ç”¨è®¡æ•°(RR = Retain/Release)å®ç°ï¼Œ</span></span><br><span class="line"><span class="comment">     ARC è‚¯å®šæ²¡æœ‰ï¼ŒMRC ä¸€èˆ¬ä¹Ÿä¸ä¼šè‡ªå®šä¹‰è¿™äº›æ–¹æ³•å®ç°ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fastpath</span>(!<span class="built_in">ISA</span>()-&gt;<span class="built_in">hasCustomRR</span>())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">rootAutorelease</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">objc_msgSend</span>(<span class="keyword">this</span>, @<span class="built_in">selector</span>(autorelease));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">id <span class="title">objc_object::rootAutorelease</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå¯¹è±¡æ­£åœ¨é‡Šæ”¾ï¼Œä¸è¦åŠ å…¥åˆ° AutoreleasePool ä¸­ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isa</span>().<span class="built_in">isDeallocating</span>()) <span class="keyword">return</span> (id)<span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      å¦‚æœå¯¹è±¡æœ‰ä½¿ç”¨è¿”å›å€¼ä¼˜åŒ–çš„è¯ï¼Œä¸è¦åŠ å…¥åˆ° AutoreleasePool ä¸­ã€‚</span></span><br><span class="line"><span class="comment">      åé¢çš„ç« èŠ‚ã€Šæ€§èƒ½ä¼˜åŒ–ï¼šTLS æœºåˆ¶è§£æã€‹ä¼šå¯¹è¯¥æœºåˆ¶è¿›è¡Œè¯´æ˜ã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">prepareOptimizedReturn</span>((id)<span class="keyword">this</span>, <span class="literal">true</span>, ReturnAtPlus1)) <span class="keyword">return</span> (id)<span class="keyword">this</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ç±»å¯¹è±¡ï¼Œä¸è¦åŠ å…¥åˆ° AutoreleasePool ä¸­ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">slowpath</span>(<span class="built_in">isClass</span>())) <span class="keyword">return</span> (id)<span class="keyword">this</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">rootAutorelease2</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">id <span class="title">objc_object::rootAutorelease2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> AutoreleasePoolPage::<span class="built_in">autorelease</span>((id)<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼šä»è¿™é‡Œå¼€å§‹ï¼Œåé¢éƒ½æ˜¯ AutoreleasePoolPage çš„å†…éƒ¨å‡½æ•°ã€‚</span></span><br><span class="line"><span class="function"><span class="type">static</span> id <span class="title">autorelease</span><span class="params">(id obj)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">autoreleaseFast</span>(obj);</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">id *<span class="title">autoreleaseFast</span><span class="params">(id obj)</span> </span>&#123;</span><br><span class="line">    AutoreleasePoolPage *page = <span class="built_in">hotPage</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (page &amp;&amp; !page-&gt;<span class="built_in">full</span>()) &#123;</span><br><span class="line">        <span class="comment">// å½“å‰é¡µæœªæ»¡ï¼Œç›´æ¥æ·»åŠ </span></span><br><span class="line">        <span class="keyword">return</span> page-&gt;<span class="built_in">add</span>(obj);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (page) &#123;</span><br><span class="line">        <span class="comment">// å½“å‰é¡µå·²æ»¡ï¼Œåˆ›å»ºæ–°é¡µæ·»åŠ </span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">autoreleaseFullPage</span>(obj, page);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å½“å‰çº¿ç¨‹ä¸­è¿˜æ²¡æœ‰ Pageï¼Œåˆ›å»ºä¸€ä¸ªå¹¶æ·»åŠ å¯¹è±¡ã€‚</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">autoreleaseNoPage</span>(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">id *<span class="title">add</span><span class="params">(id obj)</span> </span>&#123;</span><br><span class="line">    id *ret;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ä¸‹é¢çš„è¿™æ®µä»£ç çš„é€»è¾‘å¤§è‡´æ˜¯ï¼šå¦‚æœå¯ç”¨äº†å¯¹è±¡åˆå¹¶ä¼˜åŒ–æ–¹æ¡ˆï¼Œ</span></span><br><span class="line"><span class="comment">    åˆ™å°†é‡å¤è°ƒç”¨ autorelease çš„å¯¹è±¡è¿›è¡Œåˆå¹¶ï¼Œ</span></span><br><span class="line"><span class="comment">    è¿™ä¹ˆåšçš„ç›®çš„æ˜¯ä¸ºäº†å‡å°‘åŒä¸€ä¸ªå¯¹è±¡è¢«å¤šæ¬¡é‡å¤çš„æ·»åŠ åˆ°è‡ªåŠ¨é‡Šæ”¾æ± ã€‚</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    ä¸€èˆ¬è¿™ç§åœºæ™¯ä¼šå‡ºç°åœ¨å¾ªç¯ä¸­ï¼Œä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼Œ</span></span><br><span class="line"><span class="comment">    å¦‚æœæœªä¼˜åŒ–çš„è¯å°±ä¼šåœ¨ Page ä¸­å­˜æ”¾ 10 ä¸ª Person å¯¹è±¡ï¼›</span></span><br><span class="line"><span class="comment">    ä¼˜åŒ–ååªä¼šå­˜æ”¾ 1 ä¸ª Person å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    for (int i = 0; i &lt; 10; i++) &#123;</span></span><br><span class="line"><span class="comment">        __autoreleasing Person *per = [[Person alloc] init];</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (!DisableAutoreleaseCoalescing || </span><br><span class="line">        !DisableAutoreleaseCoalescingLRU) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!DisableAutoreleaseCoalescingLRU) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">empty</span>() &amp;&amp; (obj != POOL_BOUNDARY)) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                è·å– Page æœ€åçš„å­˜å‚¨å¯¹è±¡ï¼Œæ£€æŸ¥ä¸å½“å‰å¯¹è±¡æ˜¯å¦ç›¸åŒï¼Œ</span></span><br><span class="line"><span class="comment">                å¦‚æœç›¸åŒåˆ™è¿›è¡Œåˆå¹¶ã€‚</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                AutoreleasePoolEntry *topEntry = (AutoreleasePoolEntry *)next - <span class="number">1</span>;</span><br><span class="line">                <span class="comment">// å‘å‰æœ€å¤šæŸ¥æ‰¾ 4 ä¸ªå¯¹è±¡</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">uintptr_t</span> offset = <span class="number">0</span>; offset &lt; <span class="number">4</span>; offset++) &#123;</span><br><span class="line">                    AutoreleasePoolEntry *offsetEntry = topEntry - offset;</span><br><span class="line">                    <span class="comment">// æ£€æŸ¥æ˜¯å¦è¶Šç•Œæˆ–é‡åˆ°æ± è¾¹ç•Œï¼ˆPOOL_BOUNDARYï¼‰</span></span><br><span class="line">                    <span class="keyword">if</span> (offsetEntry &lt;= (AutoreleasePoolEntry*)<span class="built_in">begin</span>() || </span><br><span class="line">                        *(id *)offsetEntry == POOL_BOUNDARY) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// æ‰¾åˆ°ç›¸åŒçš„å¯¹è±¡ä¸”è®¡æ•°æœªè¾¾ä¸Šé™</span></span><br><span class="line">                    <span class="keyword">if</span> (offsetEntry-&gt;<span class="built_in">getPointer</span>() == (<span class="type">uintptr_t</span>)obj &amp;&amp; </span><br><span class="line">                        offsetEntry-&gt;<span class="built_in">getCount</span>() &lt; AutoreleasePoolEntry::maxCount) &#123;</span><br><span class="line">                        <span class="comment">// é€šè¿‡å†…å­˜ç§»åŠ¨ï¼Œå°†åŒ¹é…çš„å¯¹è±¡ç§»åŠ¨åˆ°æ± é¡¶ã€‚</span></span><br><span class="line">                        <span class="keyword">if</span> (offset &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            AutoreleasePoolEntry found = *offsetEntry;</span><br><span class="line">                            <span class="built_in">memmove</span>(offsetEntry, offsetEntry + <span class="number">1</span>, offset * <span class="built_in">sizeof</span>(*offsetEntry));</span><br><span class="line">                            *topEntry = found;</span><br><span class="line">                        &#125;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// å¢åŠ è¿™ä¸ªå¯¹è±¡çš„è®¡æ•°ã€‚</span></span><br><span class="line">                        topEntry-&gt;<span class="built_in">incrementCount</span>();</span><br><span class="line">                        ret = (id *)topEntry;</span><br><span class="line">                        <span class="keyword">goto</span> done;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">empty</span>() &amp;&amp; (obj != POOL_BOUNDARY)) &#123;</span><br><span class="line">                <span class="comment">// ä»…æ£€æŸ¥æ± é¡¶å‰ä¸€ä¸ªå¯¹è±¡å’Œå½“å‰å¯¹è±¡æ˜¯å¦ä¸€è‡´ã€‚</span></span><br><span class="line">                AutoreleasePoolEntry *prevEntry = (AutoreleasePoolEntry *)next - <span class="number">1</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// ç›´æ¥åˆå¹¶åˆ°å‰ä¸€ä¸ªå¯¹è±¡ã€‚</span></span><br><span class="line">                <span class="keyword">if</span> (prevEntry-&gt;<span class="built_in">getPointer</span>() == (<span class="type">uintptr_t</span>)obj &amp;&amp; </span><br><span class="line">                    prevEntry-&gt;<span class="built_in">getCount</span>() &lt; AutoreleasePoolEntry::maxCount) &#123;</span><br><span class="line">                    prevEntry-&gt;<span class="built_in">incrementCount</span>();</span><br><span class="line">                    ret = (id *)prevEntry;</span><br><span class="line">                    <span class="keyword">goto</span> done;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = next;</span><br><span class="line">    *next++ = obj;</span><br><span class="line"></span><br><span class="line"> done:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">id *<span class="title">autoreleaseFullPage</span><span class="params">(id obj, AutoreleasePoolPage *page)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    è·å–ä¸‹ä¸€ä¸ª Page å¯¹è±¡ï¼Œ</span></span><br><span class="line"><span class="comment">    å¦‚æœå®ƒä¸å­˜åœ¨æˆ–è€…å­˜æ»¡äº†å°±åˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (page-&gt;child) page = page-&gt;child;</span><br><span class="line">        <span class="keyword">else</span> page = <span class="keyword">new</span> <span class="built_in">AutoreleasePoolPage</span>(page);</span><br><span class="line">    &#125; <span class="keyword">while</span> (page-&gt;<span class="built_in">full</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°†å½“å‰ Page è®¾ç½®ä¸º hotã€‚</span></span><br><span class="line">    <span class="built_in">setHotPage</span>(page);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°†å¯¹è±¡æ·»åŠ åˆ° Page ä¸­ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> page-&gt;<span class="built_in">add</span>(obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">id *<span class="title">autoreleaseNoPage</span><span class="params">(id obj)</span> </span>&#123;</span><br><span class="line">    <span class="type">bool</span> pushExtraBoundary = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     é¦–æ¬¡åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± æ—¶ï¼Œä¼šç”¨ä¸€ä¸ªå ä½ç¬¦è¡¨ç¤ºç©ºæ± ã€‚</span></span><br><span class="line"><span class="comment">     æ­¤æ—¶è‹¥æ·»åŠ å¯¹è±¡ï¼Œéœ€å…ˆè¡¥ä¸€ä¸ªè¾¹ç•Œã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">haveEmptyPoolPlaceholder</span>()) &#123;</span><br><span class="line">        pushExtraBoundary = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç›´æ¥ä½¿ç”¨ç©ºå ä½ç¬¦ï¼Œé¿å…åˆ›å»ºçœŸå®çš„æ± ç»“æ„ã€‚</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (obj == POOL_BOUNDARY) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setEmptyPoolPlaceholder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ª Pageï¼Œå¹¶è®¾ç½®ä¸º hotã€‚</span></span><br><span class="line">    AutoreleasePoolPage *page = <span class="keyword">new</span> <span class="built_in">AutoreleasePoolPage</span>(nil);</span><br><span class="line">    <span class="built_in">setHotPage</span>(page);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pushExtraBoundary) &#123;</span><br><span class="line">        page-&gt;<span class="built_in">add</span>(POOL_BOUNDARY);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> page-&gt;<span class="built_in">add</span>(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„å‡½æ•°è°ƒç”¨æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">objc_autorelease</span><br><span class="line">â””â”€â”€ autorelease</span><br><span class="line">    â””â”€â”€ rootAutorelease</span><br><span class="line">        â””â”€â”€ rootAutorelease2</span><br><span class="line">            â””â”€â”€ AutoreleasePoolPage::autorelease</span><br><span class="line">                â””â”€â”€ AutoreleasePoolPage::autoreleaseFast</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢çš„ä»£ç åˆ†æä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“ä¸€ä¸ªå¯¹è±¡è¢«æ ‡è®°ä¸º autoreleasing æ—¶ï¼Œç³»ç»Ÿä¼šé€šè¿‡ä¸€ç³»åˆ—å‡½æ•°è°ƒç”¨æœ€ç»ˆå°†å…¶åŠ å…¥åˆ° AutoreleasePoolPage ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸»è¦ç”± autoreleaseFast å‡½æ•°å®Œæˆï¼Œå®ƒè´Ÿè´£ç®¡ç†å¯¹è±¡çš„å…·ä½“å­˜å‚¨å·¥ä½œã€‚åœ¨ autoreleaseFast å‡½æ•°å†…éƒ¨ï¼Œç³»ç»Ÿä¼šè·å–å½“å‰çº¿ç¨‹çš„ hotPageï¼ˆæ‰€è°“çš„ hotPageï¼Œå…¶å®å°±æ˜¯åŒå‘é“¾è¡¨çš„å°¾èŠ‚ç‚¹ï¼‰ï¼Œç„¶åæ ¹æ® page çŠ¶æ€å†³å®šæ‰§è¡Œé€»è¾‘ï¼š</p>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>çŠ¶æ€</th>
<th>æ‰§è¡Œé€»è¾‘</th>
</tr>
</thead>
<tbody><tr>
<td>é€»è¾‘ä¸€</td>
<td>page å­˜åœ¨ä¸”æœªæ»¡</td>
<td>ç›´æ¥è°ƒç”¨ add å‡½æ•°å°†å¯¹è±¡æ·»åŠ åˆ° Page ä¸­</td>
</tr>
<tr>
<td>é€»è¾‘äºŒ</td>
<td>page å­˜åœ¨ä½†å·²æ»¡</td>
<td>è°ƒç”¨ autoreleaseFullPage åˆ›å»ºæ–° Pageï¼Œç„¶åæ·»åŠ å¯¹è±¡</td>
</tr>
<tr>
<td>é€»è¾‘ä¸‰</td>
<td>page ä¸å­˜åœ¨</td>
<td>ç›´æ¥åˆ›å»ºæ–° Pageï¼Œç„¶åæ·»åŠ å¯¹è±¡</td>
</tr>
</tbody></table>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªæœ‰è¶£çš„ä¼˜åŒ–ç»†èŠ‚ï¼šç³»ç»Ÿå¹¶ä¸æ˜¯ç›´æ¥å­˜æ”¾å¯¹è±¡çš„åœ°å€ï¼Œè€Œæ˜¯å°†å…¶åŒ…è£…æˆä¸€ä¸ª AutoreleasePoolEntry å¯¹è±¡ã€‚è¿™æ ·è®¾è®¡çš„åŸå› åœ¨äºç³»ç»Ÿé‡‡ç”¨äº† â€œå¯¹è±¡åˆå¹¶ä¼˜åŒ–â€ æ–¹æ¡ˆ - å½“å¤šä¸ªç›¸åŒå¯¹è±¡è¢«é‡å¤åŠ å…¥ Page æ—¶ï¼Œç³»ç»Ÿåªä¼šä¿ç•™ç¬¬ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶é€šè¿‡ count å€¼è®°å½•è¯¥å¯¹è±¡è¢«é‡å¤åŠ å…¥çš„æ¬¡æ•°ã€‚è¿™ç§ä¼˜åŒ–å¯ä»¥æœ‰æ•ˆå‡å°‘å†…å­˜å ç”¨ï¼ˆå…·ä½“ç»†èŠ‚è¯·é˜…è¯»ä¸Šé¢çš„ add å‡½æ•°ï¼‰ã€‚</p>
<p>è‡³æ­¤ï¼Œautoreleasing å¯¹è±¡å°±å®Œæˆäº†å®ƒè¿›å…¥ AutoreleasePool çš„å…¨è¿‡ç¨‹ã€‚</p>
<p>åœ¨ä¸Šè¿°å®ç°ä¸­ï¼Œæœ‰ä¸€ä¸ªæ ¸å¿ƒç±»å‹å€¼å¾—æˆ‘ä»¬ç‰¹åˆ«å…³æ³¨ - AutoreleasePoolPageã€‚ä½œä¸ºå­˜å‚¨æ•°æ®çš„åº•å±‚ç»“æ„ï¼Œå®ƒåœ¨æ•´ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± æœºåˆ¶ä¸­æ‰®æ¼”ç€è‡³å…³é‡è¦çš„è§’è‰²ã€‚æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ·±å…¥åˆ†æè¿™ä¸ªå…³é”®ç»„ä»¶ã€‚</p>
<h3 id="AutoreleasePoolPageï¼šå†…å­˜ç®¡ç†çš„åŸºçŸ³"><a href="#AutoreleasePoolPageï¼šå†…å­˜ç®¡ç†çš„åŸºçŸ³" class="headerlink" title="AutoreleasePoolPageï¼šå†…å­˜ç®¡ç†çš„åŸºçŸ³"></a>AutoreleasePoolPageï¼šå†…å­˜ç®¡ç†çš„åŸºçŸ³</h3><p>è®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ AutoreleasePoolPage è¿™ä¸ªæ ¸å¿ƒç±»çš„å†…éƒ¨ç»“æ„ã€‚ä¸ºäº†ä¾¿äºç†è§£ï¼Œæˆ‘å¯¹æºç è¿›è¡Œäº†ç²¾ç®€å’Œæ³¨é‡Šï¼Œä¿ç•™äº†æœ€å…³é”®çš„éƒ¨åˆ†ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AutoreleasePoolPage</span> &#123;</span><br><span class="line">    <span class="type">magic_t</span> magic;                <span class="comment">// é­”æ•°ï¼Œç”¨äºæ ¡éªŒ Page çš„æœ‰æ•ˆæ€§å’Œå®Œæ•´æ€§</span></span><br><span class="line">    __unsafe_unretained id *next; <span class="comment">// æŒ‡å‘å½“å‰ Page ä¸­ä¸‹ä¸€ä¸ªå¯ç”¨çš„å­˜å‚¨ä½ç½®</span></span><br><span class="line">    <span class="type">objc_thread_t</span> thread;         <span class="comment">// å½“å‰ Page æ‰€å±çš„çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ AutoreleasePool</span></span><br><span class="line">    AutoreleasePoolPage *parent;  <span class="comment">// æŒ‡å‘åŒå‘é“¾è¡¨ä¸­çš„å‰ä¸€ä¸ª Page</span></span><br><span class="line">    AutoreleasePoolPage *child;   <span class="comment">// æŒ‡å‘åŒå‘é“¾è¡¨ä¸­çš„åä¸€ä¸ª Page</span></span><br><span class="line">    <span class="type">uint32_t</span> depth;               <span class="comment">// å½“å‰ Page åœ¨åŒå‘é“¾è¡¨ä¸­çš„æ·±åº¦ï¼Œä» 0 å¼€å§‹</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     ç”¨äºæ€§èƒ½è°ƒè¯•å’Œç›‘æ§ã€‚è®°å½• AutoreleasePool å†å²å­˜å‚¨å¯¹è±¡æ•°é‡çš„æœ€å¤§å€¼ã€‚</span></span><br><span class="line"><span class="comment">     ç›®å‰çš„é€»è¾‘æ˜¯å½“å¯¹è±¡æ•°é‡è¶…è¿‡é˜ˆå€¼(256)æ—¶ï¼Œä¼šè§¦å‘æ—¥å¿—è®°å½•ï¼ŒåŒ…å«ï¼š</span></span><br><span class="line"><span class="comment">     - å½“å‰çº¿ç¨‹ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     - å¯¹è±¡å­˜å‚¨æ•°é‡</span></span><br><span class="line"><span class="comment">     - å®Œæ•´è°ƒç”¨æ ˆ</span></span><br><span class="line"><span class="comment">     è¿™äº›ä¿¡æ¯æœ‰åŠ©äºæ’æŸ¥å†…å­˜ä½¿ç”¨å¼‚å¸¸çš„æƒ…å†µã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">uint32_t</span> hiwat;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Page å¤§å°å›ºå®šä¸º 4KB(4096å­—èŠ‚)ï¼Œä¸ç³»ç»Ÿå†…å­˜é¡µå¤§å°å¯¹é½</span></span><br><span class="line">    <span class="type">static</span> <span class="type">size_t</span> <span class="type">const</span> SIZE = <span class="number">1</span> &lt;&lt; <span class="number">12</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é‡å†™ new æ“ä½œç¬¦ï¼Œç¡®ä¿åˆ†é…çš„å†…å­˜æŒ‰ SIZE å¯¹é½</span></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> * <span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">        <span class="type">void</span> *result = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> r = <span class="built_in">posix_memalign</span>(&amp;result, SIZE, SIZE);</span><br><span class="line">        <span class="built_in">ASSERT</span>(r == <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†æ›´ç›´è§‚åœ°ç†è§£ AutoreleasePoolPage çš„å†…å­˜ç»“æ„ï¼Œæˆ‘ç»˜åˆ¶äº†ä¸€å¼ ç®€å›¾ï¼š</p>
<p><img src="AutoreleasePoolPage%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84%E5%9B%BE.png"></p>
<p>ç»“åˆ AutoreleasePoolPage çš„å†…éƒ¨ç»“æ„å’Œå‰é¢åˆ†æçš„å‡½æ•°æ‰§è¡Œæµç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ¸…æ™°åœ°ç†è§£ AutoreleasePool çš„åº•å±‚å®ç°ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ™®é€šçš„åŒå‘é“¾è¡¨ç»“æ„ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ª AutoreleasePoolPage å¯¹è±¡ã€‚è¿™äº›å¯¹è±¡é€šè¿‡ parent å’Œ child æŒ‡é’ˆç›¸äº’è¿æ¥ï¼Œå½¢æˆäº†ä¸€ä¸ªå®Œæ•´çš„å†…å­˜ç®¡ç†é“¾æ¡ã€‚æ¯ä¸ª Page ä¸ä»…æ‰¿æ‹…ç€èŠ‚ç‚¹çš„è§’è‰²ï¼Œè¿˜è‚©è´Ÿç€æ•°æ®å­˜å‚¨çš„é‡ä»»ï¼Œæ˜¯æ•´ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± æœºåˆ¶çš„æ ¸å¿ƒè½½ä½“ã€‚</p>
<p>åœ¨å†…å­˜ç®¡ç†çš„å±‚é¢ä¸Šï¼ŒAutoreleasePoolPage çš„è®¾è®¡ä¹Ÿä½“ç°äº†æ·±æ€ç†Ÿè™‘ã€‚é€šè¿‡æŸ¥çœ‹å…¶ new æ–¹æ³•çš„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¯ä¸ª Page çš„å¤§å°è¢«è®¾å®šä¸º 4096 å­—èŠ‚ã€‚è¿™ä¸ªçœ‹ä¼¼éšæ„çš„æ•°å­—å…¶å®æš—å«ç„æœº - å®ƒä¸ç°ä»£æ“ä½œç³»ç»Ÿçš„å†…å­˜é¡µå¤§å°å®Œç¾å¯¹é½ã€‚è¿™ç§è®¾è®¡å¸¦æ¥äº†å¤šé‡ä¼˜åŠ¿ï¼š</p>
<ul>
<li>å‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæé«˜å†…å­˜åˆ©ç”¨æ•ˆç‡ï¼›</li>
<li>å®ç°æ›´é«˜æ•ˆçš„å†…å­˜åˆ†é…ï¼›</li>
<li>ç¡®ä¿å†…å­˜è®¿é—®çš„è¿ç»­æ€§ï¼Œé™ä½ç³»ç»Ÿä¸­æ–­é¢‘ç‡ï¼›</li>
<li>ä¼˜åŒ–ç¼“å­˜å‘½ä¸­ç‡ï¼Œæå‡æ•´ä½“æ€§èƒ½ã€‚</li>
</ul>
<p>è¿™äº›ç»†èŠ‚çš„ä¼˜åŒ–ï¼Œè®© AutoreleasePool åœ¨å®ç°ä¼˜é›…çš„åŒæ—¶ï¼Œä¹Ÿä¿æŒäº†æé«˜çš„è¿è¡Œæ•ˆç‡ã€‚</p>
<h3 id="autoreleasepool-çš„ä¼˜é›…ä¹‹é“"><a href="#autoreleasepool-çš„ä¼˜é›…ä¹‹é“" class="headerlink" title="@autoreleasepool çš„ä¼˜é›…ä¹‹é“"></a>@autoreleasepool çš„ä¼˜é›…ä¹‹é“</h3><p><code>@autoreleasepool &#123;&#125;</code> æ˜¯æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ç»å¸¸ä½¿ç”¨çš„å¦ä¸€ä¸ªé‡è¦ç‰¹æ€§ã€‚è¿™ä¸ªçœ‹ä¼¼ç®€å•çš„è¯­æ³•å—èƒŒåï¼Œéšè—ç€ç¼–è¯‘å™¨çš„å·§å¦™è½¬æ¢å’Œ Runtime çš„ç²¾å¯†é…åˆã€‚è®©æˆ‘ä»¬æ­å¼€å®ƒçš„ç¥ç§˜é¢çº±ï¼Œä¸€æ¢å…¶å®ç°åŸç†ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åŸä»£ç ï¼š</span></span><br><span class="line">@autoreleasepool &#123;    </span><br><span class="line">__autoreleasing Person *per = [Person createPerson]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼–è¯‘åï¼š</span></span><br><span class="line">atautoreleasepoolobj = <span class="built_in">objc_autoreleasePoolPush</span>(); <span class="comment">// å¯¹åº” @autorelease &#123;</span></span><br><span class="line">__autoreleasing Person *per = [Person createPerson];</span><br><span class="line"><span class="built_in">objc_autoreleasePoolPop</span>(atautoreleasepoolobj); <span class="comment">// å¯¹åº” &#125;</span></span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æŸ¥çœ‹ä¸‹é¢çš„æ±‡ç¼–ä»£ç æˆªå›¾ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ç¼–è¯‘å™¨ç¡®å®å°† @autoreleasepool è¯­æ³•å—è½¬æ¢æˆäº† objc_autoreleasePoolPush å’Œ objc_autoreleasePoolPop çš„å‡½æ•°è°ƒç”¨ã€‚è¿™ç§è½¬æ¢ä¸ä»…ä¿è¯äº†ä»£ç çš„æ‰§è¡Œæ•ˆç‡ï¼Œè¿˜ä¸ºå¼€å‘è€…æä¾›äº†ä¸€ç§ä¼˜é›…çš„å†…å­˜ç®¡ç†æ–¹å¼ï¼š</p>
<p><img src="@autorelease%E5%8E%9F%E7%90%86.png"></p>
<p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹ objc_autoreleasePoolPush å‡½æ•°çš„å†…éƒ¨å®ç°ã€‚ä¸ºäº†ä¾¿äºç†è§£ï¼Œæˆ‘å°†ç›¸å…³ä»£ç è¿›è¡Œäº†ç²¾ç®€å’Œæ•´ç†ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> * <span class="title">objc_autoreleasePoolPush</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> AutoreleasePoolPage::<span class="built_in">push</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">push</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ReturnAutoreleaseInfo info = <span class="built_in">getReturnAutoreleaseInfo</span>();</span><br><span class="line">    <span class="comment">// å°† TLS ä¸­çš„å¯¹è±¡è½¬ç§»è‡³å½“å‰é‡Šæ”¾æ± ã€‚</span></span><br><span class="line">    <span class="built_in">moveTLSAutoreleaseToPool</span>(info);</span><br><span class="line">    <span class="comment">// æ’å…¥ä¸€ä¸ªæ± è¾¹ç•Œã€‚</span></span><br><span class="line">    id *dest = <span class="built_in">autoreleaseFast</span>(POOL_BOUNDARY);</span><br><span class="line">    <span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µé€»è¾‘éå¸¸ç®€æ´ä¼˜é›…ï¼šå®ƒé€šè¿‡è°ƒç”¨ autoreleaseFast å‡½æ•°ï¼Œåœ¨å½“å‰çš„ AutoreleasePool ä¸­æ’å…¥ä¸€ä¸ªè¾¹ç•Œæ ‡è®°ï¼ˆPOOL_BOUNDARYï¼‰ã€‚è¿™ä¸ªè¾¹ç•Œæ ‡è®°å°±åƒæ˜¯ä¸€ä¸ªä¹¦ç­¾ï¼Œæ ‡è®°ç€å½“å‰è‡ªåŠ¨é‡Šæ”¾æ± çš„èŒƒå›´èµ·ç‚¹ã€‚</p>
<p>è®©æˆ‘ä»¬ç»§ç»­æ¢ç´¢ objc_autoreleasePoolPop çš„å®ç°ç»†èŠ‚ã€‚ä¸‹é¢æ˜¯ç»è¿‡ç²¾ç®€çš„æ ¸å¿ƒä»£ç ï¼Œæˆ‘ä»¬å°†åˆ†æ­¥éª¤è¯¦ç»†è§£æå…¶å·¥ä½œåŸç†ï¼ˆå¦‚æœè§‰å¾—ä»£ç å¤ªé•¿å¯ä»¥å…ˆè·³è¿‡ï¼Œç¨åæˆ‘ä»¬ä¼šè¯¦ç»†è§£é‡Šå…¶å·¥ä½œåŸç†ï¼‰ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">objc_autoreleasePoolPop</span><span class="params">(<span class="type">void</span> *ctxt)</span> </span>&#123;</span><br><span class="line">    AutoreleasePoolPage::<span class="built_in">pop</span>(ctxt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pop</span><span class="params">(<span class="type">void</span> *token)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ¸…ç† TLS ä¸­çš„æ®‹ç•™å¯¹è±¡ï¼Œç¡®ä¿å…¶ç”Ÿå‘½å‘¨æœŸä¸å½“å‰æ± åŒæ­¥ã€‚</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">releaseReturnAutoreleaseTLS</span>());</span><br><span class="line">    </span><br><span class="line">    AutoreleasePoolPage *page;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// EMPTY_POOL_PLACEHOLDER è¡¨ç¤ºæ¸…ç©º Pool ä¸­çš„æ‰€æœ‰å¯¹è±¡ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (token == (<span class="type">void</span>*)EMPTY_POOL_PLACEHOLDER) &#123;</span><br><span class="line">        page = <span class="built_in">hotPage</span>();</span><br><span class="line">        <span class="keyword">if</span> (!page) &#123;</span><br><span class="line">            <span class="comment">// ä»æœªä½¿ç”¨çš„æ± ç›´æ¥æ¸…é™¤å ä½ç¬¦</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">setHotPage</span>(nil);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        è·å– Pool çš„èµ·å§‹é¡µã€‚å†…éƒ¨é€»è¾‘å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="comment">         </span></span><br><span class="line"><span class="comment">        AutoreleasePoolPage *coldPage() &#123;</span></span><br><span class="line"><span class="comment">            // å…ˆæ‹¿åˆ°å°¾èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="comment">            AutoreleasePoolPage *result = hotPage();</span></span><br><span class="line"><span class="comment">            if (result) &#123;</span></span><br><span class="line"><span class="comment">                // ä¸æ–­è·å–é“¾è¡¨ä¸­çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªã€‚</span></span><br><span class="line"><span class="comment">                while (result-&gt;parent) &#123;</span></span><br><span class="line"><span class="comment">                    result = result-&gt;parent;</span></span><br><span class="line"><span class="comment">                    result-&gt;fastcheck();</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            return result;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        page = <span class="built_in">coldPage</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æŠŠ stop è®¾ç½®ä¸ºç¬¬ä¸€é¡µçš„èµ·ç‚¹ã€‚</span></span><br><span class="line">        token = page-&gt;<span class="built_in">begin</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        page = <span class="built_in">pageForPointer</span>(token);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    id *stop = (id *)token;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     è¿™æ®µé€»è¾‘çš„æ„æ€æ˜¯ï¼š</span></span><br><span class="line"><span class="comment">     å¦‚æœ stop ä¸æ˜¯æ± è¾¹ç•Œ(POOL_BOUNDARY)å°±éœ€è¦è¿›è¡Œæ£€æŸ¥ï¼š</span></span><br><span class="line"><span class="comment">     å¦‚æœ stop æ˜¯è¿™ä¸€é¡µçš„èµ·ç‚¹ï¼Œå¹¶ä¸”è¿™ä¸€é¡µå·²ç»æ˜¯ç¬¬ä¸€é¡µäº†ã€‚</span></span><br><span class="line"><span class="comment">     è¯´æ˜éœ€è¦æ¸…ç†é“¾è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œè¿™æ˜¯æ­£å¸¸æƒ…å†µã€‚</span></span><br><span class="line"><span class="comment">     åä¹‹ï¼Œè¿™æ˜¯ä¸æ­£å¸¸çš„ï¼Œè°ƒç”¨ badPopã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (*stop != POOL_BOUNDARY) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stop == page-&gt;<span class="built_in">begin</span>()  &amp;&amp;  !page-&gt;parent) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">badPop</span>(token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">popPage</span>(token, page, stop);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">popPage</span><span class="params">(<span class="type">void</span> *token, AutoreleasePoolPage *page, id *stop)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     ä»å°¾éƒ¨ä¸€ç›´å¾€å‰é‡Šæ”¾å¯¹è±¡ï¼Œç›´åˆ°é‡åˆ° stopã€‚</span></span><br><span class="line"><span class="comment">     è¿™ä¸€æ­¥æ‰§è¡Œå®Œåï¼Œåªæ˜¯é‡Šæ”¾äº† Page å†…çš„æ•°æ®ï¼ŒPage å¯¹è±¡å¹¶æœªé”€æ¯ã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    page-&gt;<span class="built_in">releaseUntil</span>(stop);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     å¦‚æœè¿™ä¸€é¡µçš„æ•°æ®è¢«åˆ å®Œäº†ï¼Œå°±æŠŠè¿™ä¸ª Page å¯¹è±¡é‡Šæ”¾æ‰ï¼Œ</span></span><br><span class="line"><span class="comment">     å¹¶æŠŠå®ƒçš„çˆ¶ Page è®¾ä¸º hotPageã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (page-&gt;<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        AutoreleasePoolPage *parent = page-&gt;parent;</span><br><span class="line">        page-&gt;<span class="built_in">kill</span>();</span><br><span class="line">        <span class="built_in">setHotPage</span>(parent);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (page-&gt;child) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         å¦‚æœå½“å‰ Page ä¸Šçš„æ•°æ®å°äº Page æ€»å®¹é‡çš„ä¸€åŠï¼Œ</span></span><br><span class="line"><span class="comment">         åˆ™æŠŠä¸‹ä¸€ä¸ª Page é‡Šæ”¾æ‰ï¼ˆå› ä¸ºè¿™ä¸ª Page è¿˜èƒ½å­˜å¾ˆå¤šæ•°æ®ï¼Œ</span></span><br><span class="line"><span class="comment">         å¯èƒ½å¾ˆä¹…éƒ½ç”¨ä¸åˆ°ä¸‹ä¸€é¡µï¼‰ï¼›</span></span><br><span class="line"><span class="comment">         åä¹‹ï¼ŒæŠŠä¸‹ä¸‹ä¸€ä¸ª Page é‡Šæ”¾æ‰ï¼ˆè¿™ä¸€é¡µå¿«å­˜æ»¡äº†ï¼Œ</span></span><br><span class="line"><span class="comment">         å¯èƒ½å¾ˆå¿«å°±è¦ç”¨åˆ°ä¸‹ä¸€é¡µäº†ï¼‰ã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (page-&gt;<span class="built_in">lessThanHalfFull</span>()) &#123;</span><br><span class="line">            page-&gt;child-&gt;<span class="built_in">kill</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (page-&gt;child-&gt;child) &#123;</span><br><span class="line">            page-&gt;child-&gt;child-&gt;<span class="built_in">kill</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">releaseUntil</span><span class="params">(id *stop)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// ä» next å¼€å§‹ï¼Œä¸€ç›´å¾€å‰é‡Šæ”¾å¯¹è±¡ï¼Œç›´åˆ°é‡åˆ° stopã€‚</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">this</span>-&gt;next != stop) &#123;</span><br><span class="line">            AutoreleasePoolPage *page = <span class="built_in">hotPage</span>();</span><br><span class="line">            <span class="comment">// å¦‚æœå½“å‰ Page ä¸ºç©ºï¼Œåˆ™å¾€å‰æ‰¾çˆ¶ Pageã€‚</span></span><br><span class="line">            <span class="keyword">while</span> (page-&gt;<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                page = page-&gt;parent;</span><br><span class="line">                <span class="built_in">setHotPage</span>(page);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è·å–å½“å‰ Page çš„æœ€åä¸€ä¸ªå¯¹è±¡ã€‚</span></span><br><span class="line">            AutoreleasePoolEntry* entry = (AutoreleasePoolEntry*) --page-&gt;next;</span><br><span class="line">            <span class="comment">// è·å–å¯¹è±¡ã€‚</span></span><br><span class="line">            id obj = (id)entry-&gt;<span class="built_in">getPointer</span>();</span><br><span class="line">            <span class="comment">// è·å–å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚</span></span><br><span class="line">            <span class="type">int</span> count = (<span class="type">int</span>)entry-&gt;<span class="built_in">getCount</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* </span></span><br><span class="line"><span class="comment">            å°†åŸå…ˆå­˜æ”¾æ•°æ®çš„é‚£å—ç©ºé—´èµ‹å€¼ä¸ºä¸€ä¸ªé­”æ•° SCRIBBLEï¼Œ</span></span><br><span class="line"><span class="comment">            è¿™ä¹ˆåšçš„ç›®çš„æ˜¯æ–¹ä¾¿åæœŸæ£€æŸ¥ Page æ˜¯å¦è¢«ç ´åã€‚</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="built_in">memset</span>((<span class="type">void</span>*)page-&gt;next, SCRIBBLE, <span class="built_in">sizeof</span>(*page-&gt;next));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¦‚æœ obj ä¸æ˜¯è¾¹ç•Œæ ‡è®°ï¼Œåˆ™æ‰§è¡Œé‡Šæ”¾æ“ä½œã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (obj != POOL_BOUNDARY) &#123;</span><br><span class="line">                <span class="comment">// æ‰§è¡ŒæŒ‡å®šæ¬¡æ•°çš„é‡Šæ”¾æ“ä½œã€‚</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count + <span class="number">1</span>; i++) &#123;</span><br><span class="line">                    <span class="built_in">objc_release</span>(obj);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ¸…ç©º TLS ä¸­çš„ä¸´æ—¶å¯¹è±¡ï¼Œç¡®ä¿å®ƒä»¬å’Œ Page çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ç›¸åŒçš„ã€‚</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="built_in">releaseReturnAutoreleaseTLS</span>());</span><br><span class="line">    <span class="built_in">setHotPage</span>(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡Šæ”¾çš„é€»è¾‘ç¨å¾®å¤æ‚ä¸€äº›ï¼Œæˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹ã€‚å½“æˆ‘ä»¬è°ƒç”¨ pop å‡½æ•°æ—¶ï¼Œç³»ç»Ÿä¼šæŒ‰ç…§ä»¥ä¸‹æµç¨‹è¿›è¡Œå¯¹è±¡çš„é‡Šæ”¾æ“ä½œï¼š</p>
<ol>
<li>é¦–å…ˆï¼Œobjc_autoreleasePoolPop å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå®ƒæ˜¯æ•´ä¸ªé‡Šæ”¾æµç¨‹çš„å…¥å£ã€‚</li>
<li>ç„¶åï¼Œpop å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå®ƒè´Ÿè´£å¤„ç†å…·ä½“çš„é‡Šæ”¾é€»è¾‘ã€‚</li>
<li>æ¥ç€ï¼ŒpopPage å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå®ƒè´Ÿè´£ç®¡ç† Page çš„é‡Šæ”¾ã€‚</li>
<li>æœ€åï¼ŒreleaseUntil å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå®ƒè´Ÿè´£æ‰§è¡Œå®é™…çš„å¯¹è±¡é‡Šæ”¾æ“ä½œã€‚</li>
</ol>
<p>å®Œæ•´çš„å‡½æ•°è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">objc_autoreleasePoolPop</span><br><span class="line">â””â”€â”€ pop</span><br><span class="line">    â””â”€â”€ popPage</span><br><span class="line">        â””â”€â”€ releaseUntil</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™äº›å‡½æ•°ä¸­ï¼ŒreleaseUntil å’Œ popPage æ‰®æ¼”ç€å°¤ä¸ºå…³é”®çš„è§’è‰²ï¼š</p>
<p>releaseUntil å‡½æ•°è´Ÿè´£å¯¹è±¡çš„å…·ä½“é‡Šæ”¾å·¥ä½œã€‚å®ƒä¼šæŒ‰ç…§å…ˆè¿›åå‡ºï¼ˆLIFOï¼‰çš„é¡ºåºï¼Œå°† Page ä¸­çš„å¯¹è±¡é€ä¸€é‡Šæ”¾ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå®ƒä¸ä»…è¦å¤„ç†æ™®é€šå¯¹è±¡çš„é‡Šæ”¾ï¼Œè¿˜è¦è€ƒè™‘å¯¹è±¡åˆå¹¶ä¼˜åŒ–å¸¦æ¥çš„ç‰¹æ®Šæƒ…å†µï¼Œç¡®ä¿æ¯ä¸ªå¯¹è±¡éƒ½èƒ½å¾—åˆ°æ­£ç¡®çš„é‡Šæ”¾æ¬¡æ•°ã€‚åŒæ—¶ï¼Œå®ƒè¿˜ä¼šé€šè¿‡é­”æ•°ï¼ˆSCRIBBLEï¼‰æ ‡è®°å·²é‡Šæ”¾çš„å†…å­˜ç©ºé—´ï¼Œè¿™ä¹ˆåšçš„ç›®çš„æ˜¯æ–¹ä¾¿åæœŸè¿›è¡Œå†…å­˜å®Œæ•´æ€§æ£€æŸ¥ã€‚</p>
<p>popPage å‡½æ•°åˆ™ä¸“æ³¨äº Page å¯¹è±¡æœ¬èº«çš„ç®¡ç†å’Œé‡Šæ”¾ã€‚å®ƒç»´æŠ¤ç€ AutoreleasePool çš„æ•´ä½“ç»“æ„ï¼Œç¡®ä¿å½“ Page ä¸­æ‰€æœ‰çš„å¯¹è±¡éƒ½è¢«é‡Šæ”¾å®Œåï¼ŒPage æœ¬èº«èƒ½å¤Ÿè¢«æ­£ç¡®åœ°é‡Šæ”¾ï¼Œä»è€Œä¿æŒæ•´ä¸ªæ± ç»“æ„çš„é«˜æ•ˆè¿è½¬ã€‚</p>
<p>é€šè¿‡ä¸Šè¿°åˆ†æï¼Œæˆ‘ä»¬å·²ç»æ·±å…¥ç†è§£äº† AutoreleasePool çš„æ ¸å¿ƒå·¥ä½œåŸç†ï¼šç³»ç»Ÿé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„å…¥æ± (Push)å’Œå‡ºæ± (Pop)æœºåˆ¶ï¼Œåœ¨ä¿è¯å†…å­˜ç®¡ç†å®‰å…¨æ€§çš„åŒæ—¶ï¼Œä¹Ÿå®ç°äº†æé«˜çš„è¿è¡Œæ•ˆç‡ã€‚è¿™ç§åŒå‘é“¾è¡¨ç»“æ„ä¸ä»…è®©å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å˜å¾—ä¼˜é›…ï¼Œè¿˜é€šè¿‡è¯¸å¦‚å¯¹è±¡åˆå¹¶ç­‰ä¼˜åŒ–æ‰‹æ®µæå‡äº†è¿è¡Œæ€§èƒ½ã€‚</p>
<p>åœ¨æŒæ¡äº†è¿™äº›åº•å±‚å®ç°ç»†èŠ‚åï¼Œæˆ‘ä»¬å°†è¿›ä¸€æ­¥æ¢è®¨ AutoreleasePool åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„è¡Œä¸ºç‰¹å¾ï¼Œä»¥åŠåœ¨å®é™…å¼€å‘ä¸­çš„æœ€ä½³å®è·µæ–¹æ¡ˆã€‚è¿™äº›çŸ¥è¯†å°†å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°é©¾é©­è¿™ä¸ªå¼ºå¤§çš„å†…å­˜ç®¡ç†å·¥å…·ã€‚</p>
<h2 id="çº¿ç¨‹ä¸-AutoreleasePoolï¼šçº ç¼ çš„åŒèºæ—‹"><a href="#çº¿ç¨‹ä¸-AutoreleasePoolï¼šçº ç¼ çš„åŒèºæ—‹" class="headerlink" title="çº¿ç¨‹ä¸ AutoreleasePoolï¼šçº ç¼ çš„åŒèºæ—‹"></a>çº¿ç¨‹ä¸ AutoreleasePoolï¼šçº ç¼ çš„åŒèºæ—‹</h2><p>AutoreleasePool å’Œçº¿ç¨‹æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ AutoreleasePoolã€‚ä»å®ç°ä¸Šçœ‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”± AutoreleasePoolPage å¯¹è±¡ç»„æˆçš„åŒå‘é“¾è¡¨ç»“æ„ï¼Œçº¿ç¨‹é€šè¿‡ TLS (Thread Local Storage) æœºåˆ¶æŒæœ‰è¿™ä¸ªé“¾è¡¨çš„å°¾èŠ‚ç‚¹ï¼ˆä¹Ÿå°±æ˜¯ hotPageï¼‰ã€‚</p>
<p>å…³äº AutoreleasePool çš„é‡Šæ”¾æ—¶æœºï¼Œè¿™æ˜¯ä¸€ä¸ªç»å¸¸è¢«å¼€å‘è€…è®¨è®ºçš„è¯é¢˜ã€‚ç‰¹åˆ«æ˜¯è¢« __autoreleasing ä¿®é¥°çš„å¯¹è±¡ï¼Œå®ƒä»¬å…·ä½“åœ¨ä»€ä¹ˆæ—¶å€™è¢«é‡Šæ”¾ï¼Ÿ</p>
<p>ç»è¿‡æ·±å…¥ç ”ç©¶ï¼Œæˆ‘å‘ç°ä¸åŒåœºæ™¯ä¸‹å¯¹è±¡çš„é‡Šæ”¾æ—¶æœºæ˜¯ä¸åŒçš„ã€‚è®©æˆ‘ä»¬é€ä¸€åˆ†æï¼š</p>
<p>åœºæ™¯ä¸€ï¼šä¸»çº¿ç¨‹ä¸­çš„ autorelease å¯¹è±¡</p>
<ul>
<li>ç”± RunLoop æ¥ç®¡ç†é‡Šæ”¾æ—¶æœº</li>
<li>é€šå¸¸åœ¨å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæˆåé‡Šæ”¾</li>
<li>å…·ä½“æ—¶æœºå¯ä»¥é€šè¿‡ä¸‹å›¾æ¥ç†è§£ï¼š</li>
</ul>
<p><img src="mainthread.png"></p>
<p>åœºæ™¯äºŒï¼šGCD åˆ›å»ºçš„å­çº¿ç¨‹ä¸­çš„å¯¹è±¡</p>
<ul>
<li>ç”±äº GCD é‡‡ç”¨çº¿ç¨‹æ± æœºåˆ¶ï¼Œçº¿ç¨‹å¯èƒ½ä¼šè¢«å¤ç”¨</li>
<li>é‡Šæ”¾æ—¶æœºæ˜¯åœ¨çº¿ç¨‹ä»»åŠ¡å®Œæˆã€å³å°†è¢«æ”¾å›çº¿ç¨‹æ± æ—¶</li>
<li>é€šè¿‡ä¸‹å›¾å¯ä»¥çœ‹åˆ°å…·ä½“æµç¨‹ï¼š</li>
</ul>
<p><img src="gcd.png"></p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ_dispatch_worker_thread2 å‡½æ•°åœ¨å¤„ç†çº¿ç¨‹ä»»åŠ¡æ—¶éµå¾ªè¿™æ ·çš„é€»è¾‘ï¼šä»é˜Ÿåˆ—ä¸­è·å–å¹¶æ‰§è¡Œä»»åŠ¡ï¼Œå½“é˜Ÿåˆ—ä¸ºç©ºæ—¶è®©çº¿ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€ã€‚åœ¨è¿›å…¥ä¼‘çœ ä¹‹å‰ï¼Œä¼šè°ƒç”¨ _dispatch_last_resort_autorelease_pool_pop æ¥é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ä¸­çš„å¯¹è±¡ã€‚</p>
<p>åœºæ™¯ä¸‰ï¼šé€šè¿‡ NSThread ç­‰æ–¹å¼åˆ›å»ºçš„éå¤ç”¨çº¿ç¨‹ï¼ˆæ—  RunLoopï¼‰</p>
<ul>
<li>å¯¹è±¡ä¼šåœ¨çº¿ç¨‹é”€æ¯æ—¶è¢«é‡Šæ”¾</li>
<li>é‡Šæ”¾è¿‡ç¨‹å¦‚å›¾æ‰€ç¤ºï¼š</li>
</ul>
<p><img src="pthread.png"></p>
<p>åœºæ™¯å››ï¼šé€šè¿‡ NSThread ç­‰æ–¹å¼åˆ›å»ºçš„éå¤ç”¨çº¿ç¨‹ï¼ˆæœ‰ RunLoopï¼‰</p>
<ul>
<li>é‡Šæ”¾æœºåˆ¶ç±»ä¼¼äºä¸»çº¿ç¨‹</li>
<li>åœ¨å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæˆåé‡Šæ”¾</li>
<li>å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</li>
</ul>
<p><img src="pthread_runloop.png"></p>
<p>åœºæ™¯å››ä¸­ä½¿ç”¨çš„ NSThread æ˜¯æˆ‘å¼€å‘çš„ä¸€ä¸ªå¼€æºåº“ <a target="_blank" rel="noopener" href="https://github.com/internetWei/WXLThread">WXLThread</a>ã€‚è¿™ä¸ªåº“å®ç°äº†ä¸€ä¸ªä¼˜é›…çš„å¸¸é©»çº¿ç¨‹æœºåˆ¶ï¼Œå¹¶æä¾›äº†ç®€æ´è€Œå¼ºå¤§çš„ä»»åŠ¡è°ƒåº¦æ¥å£ï¼Œè®©çº¿ç¨‹ç®¡ç†å˜å¾—æ›´åŠ ä¾¿æ·å’Œé«˜æ•ˆã€‚</p>
<p>éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œè¿™äº›é‡Šæ”¾æ—¶æœºå¹¶éå›ºå®šä¸å˜ã€‚å› ä¸º autoreleasing å¯¹è±¡çš„é‡Šæ”¾æœ¬è´¨ä¸Šæ˜¯ç”± pop å‡½æ•°çš„è°ƒç”¨æ—¶æœºå†³å®šçš„ã€‚éšç€ç³»ç»Ÿç‰ˆæœ¬çš„æ›´æ–°å’Œä¼˜åŒ–ï¼Œè¿™äº›è°ƒç”¨æ—¶åºå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚æ¯”å¦‚åœ¨æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œç³»ç»Ÿæ˜¯é€šè¿‡åœ¨ RunLoop ä¸­æ³¨å†Œ Observer æ¥å¤„ç†é‡Šæ”¾æ“ä½œçš„ï¼Œé‡Šæ”¾æ—¶æœºæ˜¯åœ¨çº¿ç¨‹å³å°†è¿›å…¥ä¼‘çœ çŠ¶æ€ä¹‹å‰ã€‚</p>
<p>å¦å¤–ï¼Œå¦‚æœå¯¹è±¡è¢« <code>@autoreleasepool &#123;&#125;</code> è¯­æ³•å—åŒ…è£¹ï¼Œé‚£ä¹ˆå®ƒçš„é‡Šæ”¾æ—¶æœºå°±å¾ˆæ˜ç¡®äº† - å°±æ˜¯åœ¨é€€å‡ºè¿™ä¸ªè¯­æ³•å—ä½œç”¨åŸŸçš„æ—¶å€™ã€‚è¿™æä¾›äº†ä¸€ç§æ›´ç²¾ç¡®çš„å†…å­˜ç®¡ç†æ–¹å¼ã€‚</p>
<h2 id="æ€§èƒ½ä¼˜åŒ–ï¼šTLS-æœºåˆ¶è§£æ"><a href="#æ€§èƒ½ä¼˜åŒ–ï¼šTLS-æœºåˆ¶è§£æ" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–ï¼šTLS æœºåˆ¶è§£æ"></a>æ€§èƒ½ä¼˜åŒ–ï¼šTLS æœºåˆ¶è§£æ</h2><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">- (Person *)createPerson &#123;</span><br><span class="line">    Person *per = [[Person alloc] init];</span><br><span class="line">    <span class="keyword">return</span> per;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    Person *per = [self createPerson];</span><br><span class="line">    <span class="built_in">NSLog</span>(@<span class="string">&quot;%@&quot;</span>, per);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•ä¼˜åŒ–ï¼Œç³»ç»Ÿä¼šåœ¨ return ä¹‹å‰å¯¹ per è°ƒç”¨ release æ–¹æ³•ï¼Œè¿™ä¼šå¯¼è‡´å¯¹è±¡è¿‡æ—©é‡Šæ”¾ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œç¼–è¯‘å™¨ä¼šåœ¨æ–¹æ³•è¿”å›å‰å°†å¯¹è±¡åŠ å…¥åˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­ï¼Œç¡®ä¿è°ƒç”¨æ–¹èƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨è¿™ä¸ªå¯¹è±¡ã€‚ä½†è¿™ç§æ–¹æ¡ˆå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šå³ä½¿å¯¹è±¡é©¬ä¸Šå°±ä¼šè¢«è°ƒç”¨æ–¹ä½¿ç”¨ï¼Œä¹Ÿè¦ç»è¿‡ã€ŒåŠ å…¥è‡ªåŠ¨é‡Šæ”¾æ±  -&gt; ä»è‡ªåŠ¨é‡Šæ”¾æ± å–å‡ºã€è¿™ä¸ªè¿‡ç¨‹ï¼Œè¿™æ— ç–‘ä¼šå¸¦æ¥ä¸€äº›æ€§èƒ½å¼€é”€ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç³»ç»Ÿå¼•å…¥äº†åŸºäº TLS (Thread Local Storage) çš„è¿”å›å€¼ä¼˜åŒ–æœºåˆ¶ã€‚å…·ä½“æ¥è¯´ï¼š</p>
<ol>
<li>åœ¨è¿”å›å¯¹è±¡çš„æ–¹æ³•ä¸­ï¼Œç¼–è¯‘å™¨ä¼šæ’å…¥ <code>objc_autoreleaseReturnValue</code> è°ƒç”¨ï¼›</li>
<li>åœ¨æ¥æ”¶è¿”å›å€¼çš„åœ°æ–¹ï¼Œç¼–è¯‘å™¨ä¼šæ’å…¥ <code>objc_retainAutoreleasedReturnValue</code> è°ƒç”¨ï¼›</li>
<li>è¿™ä¸¤ä¸ªå‡½æ•°ä¼šé…åˆå·¥ä½œï¼šå¦‚æœæ£€æµ‹åˆ°å®ƒä»¬çš„è°ƒç”¨é…å¯¹ï¼Œå°±ä¼šæŠŠå¯¹è±¡æš‚å­˜åœ¨çº¿ç¨‹çš„ TLS ä¸­ï¼Œç›´æ¥ä¼ é€’ç»™è°ƒç”¨æ–¹ï¼Œå®Œå…¨è·³è¿‡è‡ªåŠ¨é‡Šæ”¾æ± çš„è¿‡ç¨‹ã€‚</li>
</ol>
<p>è¿™ç§ä¼˜åŒ–æå¤§åœ°æå‡äº†è¿”å›å¯¹è±¡çš„æ€§èƒ½ï¼Œå°¤å…¶æ˜¯åœ¨é¢‘ç¹æ–¹æ³•è°ƒç”¨çš„åœºæ™¯ä¸‹ã€‚</p>
<p>é€šè¿‡è°ƒè¯•æŸ¥çœ‹æ±‡ç¼–ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°è¿™äº›ä¼˜åŒ–å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ï¼Œå½“ç¼–è¯‘å™¨æ£€æµ‹åˆ°è¿”å›å€¼ä¼˜åŒ–çš„åœºæ™¯æ—¶ï¼Œä¼šè·³è¿‡ä¼ ç»Ÿçš„è‡ªåŠ¨é‡Šæ”¾æ± æµç¨‹ï¼Œç›´æ¥é€šè¿‡ TLS æœºåˆ¶ä¼ é€’å¯¹è±¡æå‡äº†æ€§èƒ½ã€‚è®©æˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„å›¾æ¥ç›´è§‚åœ°ä½“ä¼šè¿™ä¸ªä¼˜åŒ–è¿‡ç¨‹ï¼š</p>
<table>
<thead>
<tr>
<th align="center"><img src="%E8%B0%83%E7%94%A8%E6%96%B9.png"></th>
</tr>
</thead>
<tbody><tr>
<td align="center">æ–¹æ³•è°ƒç”¨æ–¹</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="center"><img src="%E8%BF%94%E5%9B%9E%E6%96%B9.png"></th>
</tr>
</thead>
<tbody><tr>
<td align="center">æ–¹æ³•è¿”å›æ–¹</td>
</tr>
</tbody></table>
<h2 id="å¸¸è§è¯¯åŒºä¸æœ€ä½³å®è·µ"><a href="#å¸¸è§è¯¯åŒºä¸æœ€ä½³å®è·µ" class="headerlink" title="å¸¸è§è¯¯åŒºä¸æœ€ä½³å®è·µ"></a>å¸¸è§è¯¯åŒºä¸æœ€ä½³å®è·µ</h2><p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸€äº›å¯¹ AutoreleasePool ä½¿ç”¨çš„è¯¯åŒºã€‚å…¶ä¸­æœ€å¸¸è§çš„å°±æ˜¯åœ¨å¾ªç¯ä¸­è¿‡åº¦ä½¿ç”¨ @autoreleasepoolï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        Person *per = [[Person alloc] init];</span><br><span class="line">        <span class="comment">// å¯¹ per è¿›è¡Œçš„æ“ä½œâ€¦â€¦</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç ä¸­çš„ per å¯¹è±¡æ˜¯ __strong ç±»å‹ï¼Œå®ƒä¼šåœ¨æ¯æ¬¡å¾ªç¯ç»“æŸæ—¶ç«‹å³é‡Šæ”¾ï¼Œæ— éœ€ç­‰å¾…è‡ªåŠ¨é‡Šæ”¾æ± çš„æ¸…ç†ã€‚è¿™ç§æƒ…å†µä¸‹æ·»åŠ  @autoreleasepool å¹¶ä¸ä¼šå¸¦æ¥ä»»ä½•æ€§èƒ½ä¼˜åŠ¿ï¼Œåè€Œä¼šå› ä¸ºé¢‘ç¹åˆ›å»ºå’Œé”€æ¯è‡ªåŠ¨é‡Šæ”¾æ± è€Œå¢åŠ å¼€é”€ã€‚</p>
<p>å› æ­¤ï¼Œ@autoreleasepool çš„ä½¿ç”¨éœ€è¦éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š</p>
<ol>
<li><p>å¾ªç¯ä¸­åˆ›å»ºäº†å¤§é‡ autoreleasing å¯¹è±¡æ—¶æ‰ä½¿ç”¨ã€‚è¿™ç§æƒ…å†µä¸‹æ‰èƒ½æœ‰æ•ˆé™ä½å†…å­˜å³°å€¼ï¼Œé¿å…å†…å­˜æŒç»­å¢é•¿ã€‚</p>
</li>
<li><p>è°ƒç”¨æœªçŸ¥æ–¹æ³•æ—¶éœ€è¦è°¨æ…è¯„ä¼°ã€‚å› ä¸ºæ–¹æ³•å†…éƒ¨å¯èƒ½ä¼šåˆ›å»º autoreleasing å¯¹è±¡ï¼Œæ­¤æ—¶éœ€è¦ä½¿ç”¨ @autoreleasepool åŒ…è£¹ï¼Œå¦åˆ™ä¹Ÿä¼šå¯¼è‡´å†…å­˜å³°å€¼è¿‡é«˜ã€‚</p>
</li>
</ol>
<p>æ³¨æ„ï¼šé”™è¯¯çš„ä½¿ç”¨ @autoreleasepool ä¸ä»…ä¸ä¼šå¸¦æ¥æ€§èƒ½ä¼˜åŠ¿ï¼Œåè€Œä¼šå› ä¸ºé¢‘ç¹åˆ›å»ºå’Œé”€æ¯è‡ªåŠ¨é‡Šæ”¾æ± è€Œäº§ç”Ÿé¢å¤–å¼€é”€ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨å‰ï¼Œå»ºè®®å…ˆåˆ†æä»£ç ä¸­çš„å¯¹è±¡åˆ›å»ºæƒ…å†µï¼Œå†å†³å®šæ˜¯å¦éœ€è¦æ‰‹åŠ¨ç®¡ç†è‡ªåŠ¨é‡Šæ”¾æ± ã€‚</p>
<h2 id="æŠ€æœ¯æ€»ç»“"><a href="#æŠ€æœ¯æ€»ç»“" class="headerlink" title="æŠ€æœ¯æ€»ç»“"></a>æŠ€æœ¯æ€»ç»“</h2><p>é€šè¿‡å¯¹ AutoreleasePool åº•å±‚å®ç°çš„æ·±å…¥åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºä»¥ä¸‹å‡ ä¸ªå…³é”®ç‚¹ï¼š</p>
<ol>
<li><p>åº•å±‚æ•°æ®ç»“æ„</p>
<ul>
<li>AutoreleasePool æœ¬è´¨æ˜¯ç”± AutoreleasePoolPage å¯¹è±¡ç»„æˆçš„åŒå‘é“¾è¡¨ï¼›</li>
<li>æ¯ä¸ª Page ç›®å‰çš„å¤§å°ä¸º 4KBï¼ŒæŒ‰ç³»ç»Ÿå†…å­˜é¡µå¯¹é½ä»¥ä¼˜åŒ–æ€§èƒ½ï¼›</li>
<li>æ¯ä¸ªçº¿ç¨‹çš„ TLS ä¸­å­˜å‚¨ç€é“¾è¡¨çš„å°¾èŠ‚ç‚¹ï¼ˆhotPageï¼‰ï¼›</li>
<li>Page ä¸­é™¤äº†å­˜å‚¨å¯¹è±¡æŒ‡é’ˆå¤–ï¼Œè¿˜åŒ…å« magicã€nextã€thread ç­‰é‡è¦ä¿¡æ¯ã€‚</li>
</ul>
</li>
<li><p>å¯¹è±¡ç®¡ç†æœºåˆ¶</p>
<ul>
<li><p>æ·»åŠ å¯¹è±¡æ—¶ï¼Œç³»ç»Ÿé¦–å…ˆè·å– hotPageï¼Œæ ¹æ®å…¶çŠ¶æ€æ‰§è¡Œä¸åŒé€»è¾‘ï¼š</p>
<ul>
<li>Page å­˜åœ¨ä¸”æœªæ»¡ï¼šç›´æ¥æ·»åŠ å¯¹è±¡</li>
<li>Page å­˜åœ¨ä½†å·²æ»¡ï¼šåˆ›å»ºæ–° Page åæ·»åŠ </li>
<li>Page ä¸å­˜åœ¨ï¼šåˆ›å»ºé¦–ä¸ª Page åæ·»åŠ </li>
</ul>
</li>
<li><p>æ¸…ç†æ—¶ï¼Œç³»ç»Ÿä¼šä»é“¾è¡¨æœ«å°¾å¾€å‰éå†ï¼Œé€ä¸ªé‡Šæ”¾å¯¹è±¡ç›´åˆ°é‡åˆ°æŒ‡å®šçš„è¾¹ç•Œæ ‡è®°ï¼ˆPOOL_BOUNDARYï¼‰ã€‚</p>
</li>
</ul>
</li>
<li><p>æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ</p>
<ul>
<li>å¯¹è±¡åˆå¹¶ä¼˜åŒ–ï¼šç›¸åŒå¯¹è±¡é‡å¤å…¥æ± æ—¶ï¼Œé€šè¿‡ count è®¡æ•°é¿å…é‡å¤å­˜å‚¨ï¼›</li>
<li>TLS è¿”å›å€¼ä¼˜åŒ–ï¼šæ–¹æ³•è¿”å›å¯¹è±¡æ—¶ï¼Œé€šè¿‡ TLS æœºåˆ¶é¿å…è‡ªåŠ¨é‡Šæ”¾æ± çš„ä¸­è½¬ï¼›</li>
<li>å†…å­˜å¯¹é½ï¼šPage å¤§å°ä¸ç³»ç»Ÿé¡µå¯¹é½ï¼Œæé«˜å†…å­˜è®¿é—®æ•ˆç‡ï¼›</li>
<li>åŒå‘é“¾è¡¨ï¼šæ”¯æŒå¿«é€Ÿçš„æ­£å‘å’Œåå‘éå†ï¼Œé€‚åº”ä¸åŒçš„ä½¿ç”¨åœºæ™¯ã€‚</li>
</ul>
</li>
</ol>
<p>è¿™äº›ç²¾å¦™çš„è®¾è®¡ä¸ä»…ä¿è¯äº† AutoreleasePool çš„æ­£ç¡®æ€§ï¼Œè¿˜åœ¨æ€§èƒ½å’Œå†…å­˜ä½¿ç”¨æ•ˆç‡ä¸Šéƒ½åšåˆ°äº†æè‡´çš„ä¼˜åŒ–ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a target="_blank" rel="noopener" href="https://suhou.github.io/2018/01/21/%E5%B8%A6%E7%9D%80%E9%97%AE%E9%A2%98%E7%9C%8B%E6%BA%90%E7%A0%81----%E5%AD%90%E7%BA%BF%E7%A8%8BAutoRelease%E5%AF%B9%E8%B1%A1%E4%BD%95%E6%97%B6%E9%87%8A%E6%94%BE/">å­çº¿ç¨‹AutoReleaseå¯¹è±¡ä½•æ—¶é‡Šæ”¾ | su</a></li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined">å¸ƒå¤š</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://budo.top/2025/03/30/iOS/AutoreleasePoolï¼šiOS å†…å­˜ç®¡ç†ä¹ç« ä¸­çš„éšç§˜æ—‹å¾‹/">https://budo.top/2025/03/30/iOS/AutoreleasePoolï¼šiOS å†…å­˜ç®¡ç†ä¹ç« ä¸­çš„éšç§˜æ—‹å¾‹/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://budo.top">å¸ƒå¤šçš„åšå®¢</a>ï¼</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/">å†…å­˜ç®¡ç†</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2025/04/02/iOS/Tagged%20Pointer%EF%BC%9A%E8%8B%B9%E6%9E%9C%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%9A%84%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E8%89%BA%E6%9C%AF/"><i class="fa fa-chevron-left">  </i><span>Tagged Pointerï¼šè‹¹æœå·¥ç¨‹å¸ˆçš„å†…å­˜ä¼˜åŒ–è‰ºæœ¯</span></a></div><div class="next-post pull-right"><a href="/2024/12/11/iOS/2024%20%E5%86%8D%E6%8E%A2ObjC-Category%EF%BC%9A%E5%8A%A8%E6%80%81%E7%89%B9%E6%80%A7%E4%B8%8E%E8%BF%90%E8%A1%8C%E6%97%B6%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%9E%81%E8%87%B4%E4%B9%8B%E7%BE%8E/"><span>2024 å†æ¢ObjC-Categoryï¼šåŠ¨æ€ç‰¹æ€§ä¸è¿è¡Œæ—¶å®ç°çš„æè‡´ä¹‹ç¾</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="lv-container" data-id="city" data-uid="MTAyMC81MzU5Ny8zMDA3MA=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></div><footer class="footer-bg" style="background-image: url(/images/backgroundImage.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021 - 2025 By å¸ƒå¤š</div><div class="framework-info"><span>é©±åŠ¨ - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>ä¸»é¢˜ - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">æœ¬åœ°æœç´¢</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« "></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>ç”±</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>æä¾›æ”¯æŒ</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>