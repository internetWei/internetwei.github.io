<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="iOS ä¸­çš„ +load å’Œ +initialize åœ¨ç»§æ‰¿ä¸åˆ†ç±»ä¸­çš„ä¸åŒè¡¨ç°â€‹"><meta name="keywords" content="Runtime,Category"><meta name="author" content="å¸ƒå¤š"><meta name="copyright" content="å¸ƒå¤š"><title>iOS ä¸­çš„ +load å’Œ +initialize åœ¨ç»§æ‰¿ä¸åˆ†ç±»ä¸­çš„ä¸åŒè¡¨ç°â€‹ | å¸ƒå¤šçš„åšå®¢</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?f0d94d3f99211c3546490e469f6ecbd8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹:${query}"}},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  hexoVersion: '6.3.0'
} </script><link rel="alternate" href="/atom.xml" title="å¸ƒå¤šçš„åšå®¢" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="åˆ‡æ¢æ–‡ç« è¯¦æƒ…">åˆ‡æ¢ç«™ç‚¹æ¦‚è§ˆ</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">ç›®å½•</div><div class="sidebar-toc__progress"><span class="progress-notice">ä½ å·²ç»è¯»äº†</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#load-%E6%96%B9%E6%B3%95%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6"><span class="toc-number">2.</span> <span class="toc-text">+load æ–¹æ³•çš„å®ç°æœºåˆ¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#initialize-%E6%96%B9%E6%B3%95%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6"><span class="toc-number">3.</span> <span class="toc-text">+initialize æ–¹æ³•çš„å®ç°æœºåˆ¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#load-%E5%92%8C-initialize-%E7%9A%84%E5%BC%82%E5%90%8C"><span class="toc-number">4.</span> <span class="toc-text">+load å’Œ +initialize çš„å¼‚åŒ</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/images/avatar.jpg"></div><div class="author-info__name text-center">å¸ƒå¤š</div><div class="author-info__description text-center">å‰è¿›ï¼å‰è¿›ï¼ï¼ä¸æ‹©æ‰‹æ®µåœ°å‰è¿›ï¼ï¼ï¼</div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/internetwei">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">æ–‡ç« </span><span class="pull-right">17</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">æ ‡ç­¾</span><span class="pull-right">11</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">åˆ†ç±»</span><span class="pull-right">4</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">å‹é“¾</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://www.coderqi.com/">é½å°èƒ–ä¹‹å®¶</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/images/backgroundImage.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">å¸ƒå¤šçš„åšå®¢</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">é¦–é¡µ</a><a class="site-page" href="/tags">æ ‡ç­¾</a><a class="site-page" href="/categories">åˆ†ç±»</a><a class="site-page" href="/archives">å½’æ¡£</a><a class="site-page" href="/about">å…³äº</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> æœç´¢</span></a></span></div><div id="post-info"><div id="post-title">iOS ä¸­çš„ +load å’Œ +initialize åœ¨ç»§æ‰¿ä¸åˆ†ç±»ä¸­çš„ä¸åŒè¡¨ç°â€‹</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2025-05-14</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/iOS/">iOS</a><div class="post-meta-wordcount"><span>å­—æ•°æ€»è®¡: </span><span class="word-count">3.3k</span><span class="post-meta__separator">|</span><span>é˜…è¯»æ—¶é•¿: 12 åˆ†é’Ÿ</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><blockquote>
<p>ç”± å¸ƒå¤š(budo) å‘å¸ƒäº 2025-05-14</p>
</blockquote>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨ iOS å¼€å‘ä¸­ï¼Œ+load å’Œ +initialize æ˜¯ä¸¤ä¸ªç‰¹æ®Šçš„ç±»æ–¹æ³•ï¼Œå®ƒä»¬éƒ½æ˜¯ç”±ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨ï¼Œä¸”æ­£å¸¸æƒ…å†µä¸‹æ¯ä¸ªç±»åªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚è™½ç„¶è¿™ä¸¤ä¸ªæ–¹æ³•çœ‹èµ·æ¥ç›¸ä¼¼ï¼Œä½†å®ƒä»¬åœ¨è°ƒç”¨æ—¶æœºã€è°ƒç”¨é¡ºåºä»¥åŠç»§æ‰¿å’Œåˆ†ç±»ä¸­çš„è¡¨ç°éƒ½æœ‰æ˜¾è‘—å·®å¼‚ã€‚+load æ–¹æ³•åœ¨ç¨‹åºå¯åŠ¨æ—¶ã€ç±»è¢«åŠ è½½åˆ°å†…å­˜æ—¶å°±ä¼šè°ƒç”¨ï¼Œè€Œ +initialize æ–¹æ³•åˆ™æ˜¯åœ¨ç±»ç¬¬ä¸€æ¬¡æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶æ‰ä¼šè°ƒç”¨ã€‚æœ¬æ–‡å°†æ·±å…¥ <a target="_blank" rel="noopener" href="https://github.com/apple-oss-distributions/objc4/tree/objc4-906">Runtime</a> æºç ï¼Œè¯¦ç»†åˆ†æè¿™ä¸¤ä¸ªæ–¹æ³•çš„åº•å±‚å®ç°æœºåˆ¶ï¼Œå¹¶é‡ç‚¹æ¢è®¨å®ƒä»¬åœ¨ç»§æ‰¿å…³ç³»å’Œåˆ†ç±»å®ç°ä¸­çš„ä¸åŒè¡¨ç°ï¼Œå¸®åŠ©å¼€å‘è€…æ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨å®ƒä»¬ã€‚</p>
<h2 id="load-æ–¹æ³•çš„å®ç°æœºåˆ¶"><a href="#load-æ–¹æ³•çš„å®ç°æœºåˆ¶" class="headerlink" title="+load æ–¹æ³•çš„å®ç°æœºåˆ¶"></a>+load æ–¹æ³•çš„å®ç°æœºåˆ¶</h2><p>åœ¨ <a target="_blank" rel="noopener" href="https://github.com/apple-oss-distributions/objc4/tree/objc4-906">Runtime</a> æºç ä¸­æˆ‘ä»¬å¯ä»¥æ‰¾åˆ° +load æ–¹æ³•çš„å…·ä½“å®ç°ç»†èŠ‚ï¼Œæ•´ç†åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<blockquote>
<p>ğŸ”§ æˆ‘åœ¨ <a target="_blank" rel="noopener" href="https://github.com/internetWei/ObjCRuntimes">è¿™é‡Œ</a> ç»´æŠ¤äº†ä¸€ä¸ªå¯ä»¥ç›´æ¥è¿è¡Œè°ƒè¯•çš„ Runtime é¡¹ç›®ï¼Œæ¬¢è¿å¤§å®¶ä¸‹è½½è°ƒè¯•æºç ã€‚</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">load_images</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> _dyld_objc_notify_mapped_info* info)</span> </span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="type">mutex_locker_t</span> <span class="title">lock2</span><span class="params">(runtimeLock)</span></span>;</span><br><span class="line">        <span class="built_in">loadAllCategoriesIfNeeded</span>();</span><br><span class="line">        <span class="comment">// å°†ç±»å’Œåˆ†ç±»ä¸­çš„ load æ–¹æ³•æ·»åŠ åˆ°å…¨å±€æ•°ç»„ä¸­ï¼Œç­‰å¾…åç»­è°ƒç”¨ã€‚</span></span><br><span class="line">        <span class="built_in">prepare_load_methods</span>((<span class="type">const</span> headerType *)info-&gt;mh, info-&gt;sectionLocationMetadata);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨æ‰€æœ‰çš„ load æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="built_in">call_load_methods</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢çš„æºç åˆ†æå¯ä»¥çœ‹å‡ºï¼Œ+load æ–¹æ³•çš„å®ç°è¿‡ç¨‹ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>è°ƒç”¨ <code>prepare_load_methods</code> å‡½æ•°ï¼Œå°†ç±»å’Œåˆ†ç±»æ‰€æœ‰çš„ +load æ–¹æ³•å‡†å¤‡å¥½ï¼ˆå…¶å®å°±æ˜¯å°†ç±»å’Œåˆ†ç±»ä¸­çš„ +load æ–¹æ³•æ·»åŠ åˆ°ä¸€ä¸ªå…¨å±€æ•°ç»„ä¸­ï¼‰ã€‚</li>
<li>è°ƒç”¨ <code>call_load_methods</code> å‡½æ•°ï¼Œéå†å‰é¢å‡†å¤‡å¥½çš„æ•°ç»„ï¼Œå¹¶è¿›è¡Œè°ƒç”¨ã€‚</li>
</ol>
<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ·±å…¥åˆ†æ <code>prepare_load_methods</code> å‡½æ•°çš„å…·ä½“å®ç°ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•æ”¶é›†è¿™äº› +load æ–¹æ³•çš„ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> </span></span><br><span class="line"><span class="function"><span class="title">prepare_load_methods</span><span class="params">(<span class="type">const</span> headerType *mhdr, <span class="type">const</span> <span class="type">_dyld_section_location_info_t</span> info)</span> </span>&#123;</span><br><span class="line">    <span class="type">size_t</span> count, i;</span><br><span class="line"></span><br><span class="line">    <span class="type">classref_t</span> <span class="type">const</span> *classlist = <span class="built_in">getSectionData</span>&lt;<span class="type">classref_t</span>&gt;(mhdr, </span><br><span class="line">    info, </span><br><span class="line">    _dyld_section_location_data_non_lazy_class_list, </span><br><span class="line">    &amp;count);</span><br><span class="line">    <span class="comment">// æŒ‰ç…§ç¼–è¯‘é¡ºåºéå†æ‰€æœ‰ç±»å¹¶æ·»åŠ  load æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="built_in">schedule_class_load</span>(<span class="built_in">remapClass</span>(classlist[i]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">category_t</span> * <span class="type">const</span> *categorylist = <span class="built_in">getSectionData</span>&lt;<span class="type">category_t</span> *&gt;(mhdr, </span><br><span class="line">    info,</span><br><span class="line">    _dyld_section_location_data_non_lazy_category_list, </span><br><span class="line">    &amp;count);</span><br><span class="line">    <span class="comment">// æŒ‰ç…§ç¼–è¯‘é¡ºåºéå†æ‰€æœ‰åˆ†ç±»å¹¶æ·»åŠ  load æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="type">category_t</span> *cat = categorylist[i];</span><br><span class="line">        Class cls = <span class="built_in">remapClass</span>(cat-&gt;cls);</span><br><span class="line">        <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">realizeClassWithoutSwift</span>(cls, nil);</span><br><span class="line">        <span class="built_in">add_category_to_loadable_list</span>(cat);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡†å¤‡ç±»çš„ load æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">schedule_class_load</span><span class="params">(Class cls)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥è¯¥ç±»çš„ load æ–¹æ³•æ˜¯å¦å·²ç»æ·»åŠ è¿‡ï¼Œé˜²æ­¢é‡å¤æ·»åŠ ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;<span class="built_in">data</span>()-&gt;flags &amp; RW_LOADED) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     é€’å½’è°ƒç”¨ï¼Œç¡®ä¿çˆ¶ç±»çš„ load æ–¹æ³•å…ˆæ·»åŠ ï¼Œ</span></span><br><span class="line"><span class="comment">     ä»è€Œä¿è¯å…ˆè°ƒç”¨çˆ¶ç±»çš„ load æ–¹æ³•å†è°ƒç”¨è‡ªèº«çš„ load æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">schedule_class_load</span>(cls-&gt;<span class="built_in">getSuperclass</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†å½“å‰ç±»çš„ load æ–¹æ³•æ·»åŠ åˆ°å…¨å±€æ•°ç»„ä¸­ã€‚</span></span><br><span class="line">    <span class="built_in">add_class_to_loadable_list</span>(cls);</span><br><span class="line">    cls-&gt;<span class="built_in">setInfo</span>(RW_LOADED);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">loadable_class</span> &#123;</span><br><span class="line">    Class cls;</span><br><span class="line">    IMP method;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¨å±€æ•°ç»„ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰éœ€è¦è°ƒç”¨çš„ç±»çš„ load æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">loadable_class</span> *loadable_classes = nil;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†ç±»çš„ load æ–¹æ³•æ·»åŠ åˆ°å…¨å±€æ•°ç»„ä¸­ã€‚</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">add_class_to_loadable_list</span><span class="params">(Class cls)</span> </span>&#123;</span><br><span class="line">    IMP method;</span><br><span class="line">    method = cls-&gt;<span class="built_in">getLoadMethod</span>();</span><br><span class="line">    <span class="keyword">if</span> (!method) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ¬¡è¿›æ¥æ—¶å…ˆåˆå§‹åŒ–å…¨å±€æ•°ç»„ï¼Œä»¥ç¡®ä¿å®ƒèƒ½å®¹çº³æ‰€æœ‰çš„ load æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (loadable_classes_used == loadable_classes_allocated) &#123;</span><br><span class="line">        loadable_classes_allocated = loadable_classes_allocated*<span class="number">2</span> + <span class="number">16</span>;</span><br><span class="line">        loadable_classes = (<span class="keyword">struct</span> loadable_class *)<span class="built_in">realloc</span>(loadable_classes,</span><br><span class="line">        loadable_classes_allocated * <span class="built_in">sizeof</span>(<span class="keyword">struct</span> loadable_class));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    loadable_classes[loadable_classes_used].cls = cls;</span><br><span class="line">    <span class="comment">// å°† load æ–¹æ³•æ·»åŠ åˆ°å…¨å±€æ•°ç»„ä¸­ã€‚</span></span><br><span class="line">    loadable_classes[loadable_classes_used].method = method;</span><br><span class="line">    loadable_classes_used++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">loadable_category</span> &#123;</span><br><span class="line">    Category cat;</span><br><span class="line">    IMP method;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¨å±€æ•°ç»„ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰éœ€è¦è°ƒç”¨çš„åˆ†ç±»çš„ load æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">loadable_category</span> *loadable_categories = nil;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†åˆ†ç±»çš„ load æ–¹æ³•æ·»åŠ åˆ°å…¨å±€æ•°ç»„ä¸­ã€‚</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">add_category_to_loadable_list</span><span class="params">(Category cat)</span> </span>&#123;</span><br><span class="line">    IMP method;</span><br><span class="line">    method = _category_getLoadMethod(cat);</span><br><span class="line">    <span class="keyword">if</span> (!method) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ¬¡è¿›æ¥æ—¶å…ˆåˆå§‹åŒ–å…¨å±€æ•°ç»„ï¼Œä»¥ç¡®ä¿å®ƒèƒ½å®¹çº³æ‰€æœ‰çš„ load æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (loadable_categories_used == loadable_categories_allocated) &#123;</span><br><span class="line">        loadable_categories_allocated = loadable_categories_allocated*<span class="number">2</span> + <span class="number">16</span>;</span><br><span class="line">        loadable_categories = (<span class="keyword">struct</span> loadable_category *)<span class="built_in">realloc</span>(loadable_categories,</span><br><span class="line">        loadable_categories_allocated * <span class="built_in">sizeof</span>(<span class="keyword">struct</span> loadable_category));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    loadable_categories[loadable_categories_used].cat = cat;</span><br><span class="line">    <span class="comment">// å°†åˆ†ç±»çš„ load æ–¹æ³•æ·»åŠ åˆ°å…¨å±€æ•°ç»„ä¸­ã€‚</span></span><br><span class="line">    loadable_categories[loadable_categories_used].method = method;</span><br><span class="line">    loadable_categories_used++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡åˆ†ææºç ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡º +load æ–¹æ³•çš„åŠ è½½é¡ºåºè§„åˆ™ï¼š</p>
<ol>
<li>ç³»ç»Ÿä¼šæŒ‰ç…§ç¼–è¯‘é¡ºåºéå†æ‰€æœ‰çš„ç±»å’Œåˆ†ç±»ï¼›</li>
<li>å¯¹äºç±»çš„ +load æ–¹æ³•ï¼Œç³»ç»Ÿé€šè¿‡ <code>schedule_class_load</code> å‡½æ•°é€’å½’å¤„ç†ï¼Œç¡®ä¿äº†çˆ¶ç±»çš„ +load æ–¹æ³•å…ˆäºå­ç±»è°ƒç”¨ï¼Œè¿™ä¿è¯äº†ç»§æ‰¿é“¾ä¸Šçš„ +load æ–¹æ³•è°ƒç”¨é¡ºåºæ˜¯ä»çˆ¶ç±»åˆ°å­ç±»ï¼›</li>
<li>å¯¹äºåˆ†ç±»çš„ +load æ–¹æ³•ï¼Œç³»ç»Ÿé€šè¿‡ <code>add_category_to_loadable_list</code> å‡½æ•°æŒ‰ç…§ç¼–è¯‘é¡ºåºæ·»åŠ ã€‚</li>
</ol>
<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ç»§ç»­åˆ†æ <code>call_load_methods</code> å‡½æ•°çš„å…·ä½“å®ç°ï¼Œçœ‹çœ‹ç³»ç»Ÿæ˜¯å¦‚ä½•è°ƒç”¨è¿™äº› +load æ–¹æ³•çš„ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">call_load_methods</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">bool</span> loading = NO;</span><br><span class="line">    <span class="type">bool</span> more_categories;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜²æ­¢é‡å¤è°ƒç”¨ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (loading) <span class="keyword">return</span>;</span><br><span class="line">    loading = YES;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *pool = <span class="built_in">objc_autoreleasePoolPush</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// å…ˆè°ƒç”¨ç±»çš„ +load æ–¹æ³•ã€‚</span></span><br><span class="line">        <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">call_class_loads</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å†è°ƒç”¨åˆ†ç±»çš„ +load æ–¹æ³•ã€‚</span></span><br><span class="line">        more_categories = <span class="built_in">call_category_loads</span>();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¦‚æœç±»å’Œåˆ†ç±»ä¸­è¿˜æœ‰æ²¡è°ƒç”¨çš„ +load æ–¹æ³•ï¼Œåˆ™ç»§ç»­è°ƒç”¨ã€‚</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>  ||  more_categories);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">objc_autoreleasePoolPop</span>(pool);</span><br><span class="line"></span><br><span class="line">    loading = NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨ç±»æ‰€æœ‰çš„ +load æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">call_class_loads</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">loadable_class</span> *classes = loadable_classes;</span><br><span class="line">    <span class="type">int</span> used = loadable_classes_used;</span><br><span class="line">    loadable_classes = nil;</span><br><span class="line">    loadable_classes_allocated = <span class="number">0</span>;</span><br><span class="line">    loadable_classes_used = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// éå†å…¨å±€æ•°ç»„å¹¶è°ƒç”¨æ‰€æœ‰éœ€è¦è°ƒç”¨çš„ +load æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; used; i++) &#123;</span><br><span class="line">        Class cls = classes[i].cls;</span><br><span class="line">        <span class="type">load_method_t</span> load_method = (<span class="type">load_method_t</span>)classes[i].method;</span><br><span class="line">        <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>; </span><br><span class="line">        <span class="comment">// æ‹¿åˆ° load æ–¹æ³•çš„å‡½æ•°æŒ‡é’ˆè¿›è¡Œè°ƒç”¨ã€‚</span></span><br><span class="line">        (*load_method)(cls, @<span class="built_in">selector</span>(load));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (classes) <span class="built_in">free</span>(classes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨åˆ†ç±»æ‰€æœ‰çš„ +load æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">call_category_loads</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> i, shift;</span><br><span class="line">    <span class="type">bool</span> new_categories_added = NO;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">loadable_category</span> *cats = loadable_categories;</span><br><span class="line">    <span class="type">int</span> used = loadable_categories_used;</span><br><span class="line">    <span class="type">int</span> allocated = loadable_categories_allocated;</span><br><span class="line">    loadable_categories = nil;</span><br><span class="line">    loadable_categories_allocated = <span class="number">0</span>;</span><br><span class="line">    loadable_categories_used = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éå†å…¨å±€æ•°ç»„å¹¶è°ƒç”¨æ‰€æœ‰éœ€è¦è°ƒç”¨çš„ +load æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; used; i++) &#123;</span><br><span class="line">        Category cat = cats[i].cat;</span><br><span class="line">        <span class="type">load_method_t</span> load_method = (<span class="type">load_method_t</span>)cats[i].method;</span><br><span class="line">        Class cls;</span><br><span class="line">        <span class="keyword">if</span> (!cat) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        cls = _category_getClass(cat);</span><br><span class="line">        <span class="comment">// ç¡®ä¿ç±»çš„ +load æ–¹æ³•å·²ç»è°ƒç”¨äº†å†è°ƒç”¨åˆ†ç±»çš„ +load æ–¹æ³•ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (cls  &amp;&amp;  cls-&gt;<span class="built_in">isLoadable</span>()) &#123;</span><br><span class="line">            (*load_method)(cls, @<span class="built_in">selector</span>(load));</span><br><span class="line">            cats[i].cat = nil;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    shift = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// å°†åˆ†ç±»ä¸­è¿˜æœªè°ƒç”¨çš„ load æ–¹æ³•æŒªåˆ°æ•°ç»„å‰é¢ã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; used; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cats[i].cat) &#123;</span><br><span class="line">            cats[i-shift] = cats[i];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            shift++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    used -= shift;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰é€šè¿‡è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ çš„åˆ†ç±»ã€‚</span></span><br><span class="line">    new_categories_added = (loadable_categories_used &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; loadable_categories_used; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (used == allocated) &#123;</span><br><span class="line">            allocated = allocated*<span class="number">2</span> + <span class="number">16</span>;</span><br><span class="line">            cats = (<span class="keyword">struct</span> loadable_category *)<span class="built_in">realloc</span>(cats, </span><br><span class="line">            allocated * <span class="built_in">sizeof</span>(<span class="keyword">struct</span> loadable_category));</span><br><span class="line">        &#125;</span><br><span class="line">        cats[used++] = loadable_categories[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (loadable_categories) <span class="built_in">free</span>(loadable_categories);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰é€šè¿‡è¿è¡Œæ—¶æ–°æ·»åŠ çš„åˆ†ç±»ï¼Œå°†å®ƒä»¬èµ‹å€¼ç»™å…¨å±€æ•°ç»„ï¼Œç­‰å¾…åç»­è°ƒç”¨ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (used) &#123;</span><br><span class="line">        loadable_categories = cats;</span><br><span class="line">        loadable_categories_used = used;</span><br><span class="line">        loadable_categories_allocated = allocated;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (cats) <span class="built_in">free</span>(cats);</span><br><span class="line">        loadable_categories = nil;</span><br><span class="line">        loadable_categories_used = <span class="number">0</span>;</span><br><span class="line">        loadable_categories_allocated = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰åŠ¨æ€æ·»åŠ çš„åˆ†ç±»ï¼Œè¿”å› YESï¼Œå¦åˆ™è¿”å› NOã€‚</span></span><br><span class="line">    <span class="keyword">return</span> new_categories_added;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡åˆ†ææºç ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡º +load æ–¹æ³•çš„è°ƒç”¨é¡ºåºè§„åˆ™ï¼š</p>
<ol>
<li>ç³»ç»Ÿä¼šå…ˆè°ƒç”¨ç±»ä¸­çš„ load æ–¹æ³•ï¼Œç„¶åå†è°ƒç”¨åˆ†ç±»ä¸­çš„ load æ–¹æ³•ï¼›</li>
<li>ç³»ç»Ÿåœ¨è°ƒç”¨åˆ†ç±»çš„ +load æ–¹æ³•æ—¶ï¼Œä¼šæœ‰è¯¸å¤šåˆ¤æ–­ï¼Œæ¯”å¦‚æ˜¯å¦å·²ç»è°ƒç”¨è¿‡ç±»çš„ +load æ–¹æ³•ï¼Œæ˜¯å¦æœ‰åŠ¨æ€æ·»åŠ çš„åˆ†ç±»ç­‰ç­‰ã€‚</li>
</ol>
<p>åœ¨è°ƒè¯•çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç°äº†ä¸€ä¸ªå¥‡æ€ªçš„ç°è±¡ï¼Œå½“ä¸€ä¸ªç±»æ²¡æœ‰å®ç° +load æ–¹æ³•ï¼Œä½†æ˜¯å®ƒçš„åˆ†ç±»ï¼ˆæœ‰ä¸”åªæœ‰ä¸€ä¸ªï¼‰å®ç°äº† +load æ–¹æ³•æ—¶ï¼Œè°ƒç”¨é¡ºåºä¼šå‘ç”Ÿå˜åŒ–ã€‚ä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">@implementation Person: NSObject</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation Student: Person</span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)load &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(@<span class="string">&quot;%s&quot;</span>, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@<span class="function">implementation <span class="title">Person</span> <span class="params">(Category1)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">+ <span class="params">(<span class="type">void</span>)</span>load </span>&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(@<span class="string">&quot;%s&quot;</span>, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@<span class="function">implementation <span class="title">Student</span> <span class="params">(Category1)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">+ <span class="params">(<span class="type">void</span>)</span>load </span>&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(@<span class="string">&quot;%s&quot;</span>, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œæˆ‘è§‚å¯Ÿåˆ°ä¸€ä¸ªå¥‡æ€ªçš„è°ƒç”¨é¡ºåºç°è±¡ã€‚æ ¹æ® Runtime æºç çš„å®ç°ï¼Œç†è®ºä¸Šåº”è¯¥æ˜¯å…ˆè°ƒç”¨å®Œæ‰€æœ‰ç±»çš„ +load æ–¹æ³•ï¼Œç„¶åå†è°ƒç”¨åˆ†ç±»çš„ +load æ–¹æ³•ã€‚ä½†å®é™…è¿è¡Œç»“æœå´æ˜¾ç¤ºï¼š</p>
<ol>
<li>é¦–å…ˆè°ƒç”¨ Person åˆ†ç±»çš„ +load æ–¹æ³•</li>
<li>ç„¶åè°ƒç”¨ Student ç±»çš„ +load æ–¹æ³•</li>
<li>æœ€åè°ƒç”¨ Student åˆ†ç±»çš„ +load æ–¹æ³•</li>
</ol>
<p>æ›´å¥‡æ€ªçš„æ˜¯ï¼Œå½“ Person ç±»æœ‰å¤šä¸ªåˆ†ç±»éƒ½å®ç°äº† +load æ–¹æ³•æ—¶ï¼Œè°ƒç”¨é¡ºåºåˆä¼šå›å½’åˆ°é¢„æœŸï¼šå…ˆè°ƒç”¨ Student ç±»çš„ +load æ–¹æ³•ï¼Œç„¶åæŒ‰ç…§ç¼–è¯‘é¡ºåºä¾æ¬¡è°ƒç”¨æ‰€æœ‰åˆ†ç±»çš„ +load æ–¹æ³•ã€‚</p>
<p>è¿™ç§ç‰¹æ®Šç°è±¡å¯èƒ½ä¸ Runtime åœ¨å¤„ç†å•ä¸ªåˆ†ç±»æ—¶çš„ä¼˜åŒ–ç­–ç•¥æœ‰å…³ã€‚å½“ç±»åªæœ‰ä¸€ä¸ªåˆ†ç±»æ—¶ï¼Œç³»ç»Ÿå¯èƒ½é‡‡ç”¨äº†ä¸åŒçš„å¤„ç†è·¯å¾„ï¼Œå¯¼è‡´è°ƒç”¨é¡ºåºå‘ç”Ÿå˜åŒ–ã€‚ä¸è¿‡ï¼Œç”±äºè¿™ç§å·®å¼‚å¹¶ä¸å½±å“ç¨‹åºçš„æ­£ç¡®æ€§ï¼Œä¸”åœ¨å¤šåˆ†ç±»åœºæ™¯ä¸‹è¡¨ç°æ­£å¸¸ï¼Œæ‰€ä»¥è¿™å¾ˆå¯èƒ½æ˜¯ Runtime çš„ä¸€ä¸ªå®ç°ç»†èŠ‚ï¼Œè€Œé bugã€‚ä»¥ä¸Šè§‚ç‚¹ä»…æ˜¯æˆ‘çš„ä¸ªäººçŒœæµ‹ï¼Œå¦‚æœå¤§å®¶æœ‰æ›´æ·±å…¥çš„ç†è§£ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºåˆ†äº«ä½ çš„è§è§£ã€‚</p>
<h2 id="initialize-æ–¹æ³•çš„å®ç°æœºåˆ¶"><a href="#initialize-æ–¹æ³•çš„å®ç°æœºåˆ¶" class="headerlink" title="+initialize æ–¹æ³•çš„å®ç°æœºåˆ¶"></a>+initialize æ–¹æ³•çš„å®ç°æœºåˆ¶</h2><p>ä¸ +load æ–¹æ³•ä¸åŒï¼Œ+initialize æ–¹æ³•æ˜¯åœ¨ç±»ç¬¬ä¸€æ¬¡æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶æ‰ä¼šè¢«è°ƒç”¨ã€‚è¿™ç§å»¶è¿Ÿè°ƒç”¨çš„æœºåˆ¶ä½¿å¾— +initialize æ–¹æ³•æ›´é€‚åˆç”¨äºç±»çš„åˆå§‹åŒ–å·¥ä½œï¼Œå› ä¸ºå®ƒå¯ä»¥ç¡®ä¿ç±»åœ¨è¢«å®é™…ä½¿ç”¨å‰å®Œæˆå¿…è¦çš„è®¾ç½®ã€‚åœ¨ <a target="_blank" rel="noopener" href="https://github.com/apple-oss-distributions/objc4/tree/objc4-906">Runtime</a> æºç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ° +initialize æ–¹æ³•çš„å…·ä½“å®ç°ç»†èŠ‚ï¼Œæ•´ç†åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> Class</span></span><br><span class="line"><span class="function"><span class="title">realizeAndInitializeIfNeeded_locked</span><span class="params">(id inst, Class cls, <span class="type">bool</span> initialize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">slowpath</span>(!cls-&gt;<span class="built_in">isRealized</span>())) &#123;</span><br><span class="line">        cls = <span class="built_in">realizeClassMaybeSwiftAndLeaveLocked</span>(cls, runtimeLock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!cls || !cls-&gt;<span class="built_in">ISA</span>()) <span class="keyword">return</span> nil;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦ä»æœªè°ƒç”¨è¿‡ +initialize æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">slowpath</span>(initialize &amp;&amp; !cls-&gt;<span class="built_in">isInitialized</span>())) &#123;</span><br><span class="line">        cls = <span class="built_in">initializeAndLeaveLocked</span>(cls, inst, runtimeLock);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cls;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> Class</span></span><br><span class="line"><span class="function"><span class="title">initializeAndLeaveLocked</span><span class="params">(Class cls, id obj, <span class="type">mutex_t</span>&amp; lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">initializeAndMaybeRelock</span>(cls, obj, lock, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> Class</span></span><br><span class="line"><span class="function"><span class="title">initializeAndMaybeRelock</span><span class="params">(Class cls,</span></span></span><br><span class="line"><span class="params"><span class="function">                         id inst,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="type">mutex_t</span>&amp; lock, <span class="type">bool</span> leaveLocked)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;<span class="built_in">isInitialized</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!leaveLocked) lock.<span class="built_in">unlock</span>();</span><br><span class="line">        <span class="keyword">return</span> cls;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class nonmeta = <span class="built_in">getMaybeUnrealizedNonMetaClass</span>(cls, inst);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nonmeta-&gt;<span class="built_in">isRealized</span>()) &#123;</span><br><span class="line">        lock.<span class="built_in">unlock</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nonmeta = <span class="built_in">realizeClassMaybeSwiftAndUnlock</span>(nonmeta, lock);</span><br><span class="line">        cls = <span class="built_in">object_getClass</span>(nonmeta);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è°ƒç”¨ç±»çš„ +initialize æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="built_in">initializeNonMetaClass</span>(nonmeta);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (leaveLocked) runtimeLock.<span class="built_in">lock</span>();</span><br><span class="line">    <span class="keyword">return</span> cls;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">initializeNonMetaClass</span><span class="params">(Class cls)</span> </span>&#123;</span><br><span class="line">    Class supercls = cls-&gt;<span class="built_in">getSuperclass</span>();</span><br><span class="line">    <span class="comment">// å…ˆè°ƒç”¨çˆ¶ç±»çš„ +initialize æ–¹æ³•ï¼Œç„¶åå†è°ƒç”¨è‡ªèº«çš„ +initialize æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (supercls  &amp;&amp;  !supercls-&gt;<span class="built_in">isInitialized</span>()) &#123;</span><br><span class="line">        <span class="built_in">initializeNonMetaClass</span>(supercls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">lockClass</span>(cls);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;<span class="built_in">isInitialized</span>()) &#123;</span><br><span class="line">        <span class="built_in">unlockClass</span>(cls);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœç±»æ­£åœ¨å…¶ä»–çº¿ç¨‹è°ƒç”¨ +initialize æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;<span class="built_in">isInitializing</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!MultithreadedForkChild || _thisThreadIsInitializingClass(cls)) &#123;</span><br><span class="line">            <span class="built_in">unlockClass</span>(cls);<span class="comment">// é¿å…æ­»é”å’Œé‡å¤è°ƒç”¨ã€‚</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">lockClass</span>(cls);</span><br><span class="line">            _setThisThreadIsInitializingClass(cls);</span><br><span class="line">            <span class="built_in">performForkChildInitialize</span>(cls, supercls);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SmallVector&lt;_objc_willInitializeClassCallback, <span class="number">1</span>&gt; localWillInitializeFuncs;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="type">mutex_locker_t</span> <span class="title">lock</span><span class="params">(classInitLock)</span></span>;</span><br><span class="line">        cls-&gt;<span class="built_in">setInitializing</span>();</span><br><span class="line">        localWillInitializeFuncs.<span class="built_in">initFrom</span>(willInitializeFuncs);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _setThisThreadIsInitializingClass(cls);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (MultithreadedForkChild) &#123;</span><br><span class="line">        <span class="built_in">performForkChildInitialize</span>(cls, supercls);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> callback : localWillInitializeFuncs) &#123;</span><br><span class="line">        callback.<span class="built_in">f</span>(callback.context, cls);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @<span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ç±»çš„ +initialize æ–¹æ³•ã€‚</span></span><br><span class="line">        <span class="built_in">callInitialize</span>(cls);</span><br><span class="line">    &#125; @<span class="built_in">catch</span> (...) &#123;</span><br><span class="line">        @<span class="keyword">throw</span>;</span><br><span class="line">    &#125; @finally &#123;</span><br><span class="line">        <span class="built_in">lockAndFinishInitializing</span>(cls, supercls);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">callInitialize</span><span class="params">(Class cls)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡æ¶ˆæ¯æœºåˆ¶å‘ cls å‘é€ initialize æ¶ˆæ¯ã€‚</span></span><br><span class="line">    <span class="built_in">objc_msgSend</span>(cls, @<span class="built_in">selector</span>(initialize));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡åˆ†æ Runtime æºç ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡º +initialize æ–¹æ³•çš„è°ƒç”¨æœºåˆ¶å’Œç‰¹ç‚¹ï¼š</p>
<ol>
<li><p>è°ƒç”¨é¡ºåºï¼šç³»ç»Ÿä¼šå…ˆè°ƒç”¨çˆ¶ç±»çš„ +initialize æ–¹æ³•ï¼Œå†è°ƒç”¨å­ç±»çš„ +initialize æ–¹æ³•ï¼Œè¿™ä¿è¯äº†ç»§æ‰¿é“¾ä¸Šçš„åˆå§‹åŒ–é¡ºåºæ˜¯ä»çˆ¶ç±»åˆ°å­ç±»ï¼›</p>
</li>
<li><p>è°ƒç”¨æœºåˆ¶ï¼š+initialize æ–¹æ³•æ˜¯é€šè¿‡ objc_msgSend æ¶ˆæ¯æœºåˆ¶è°ƒç”¨çš„ï¼Œè¿™æ„å‘³ç€ï¼š</p>
<ul>
<li>å¦‚æœå­ç±»æœªå®ç° +initialize æ–¹æ³•ï¼Œä¼šè°ƒç”¨çˆ¶ç±»çš„å®ç°ï¼›</li>
<li>å¦‚æœåˆ†ç±»å®ç°äº† +initialize æ–¹æ³•ï¼Œä¼šè¦†ç›–ç±»æœ¬èº«çš„å®ç°ï¼›</li>
<li>ç”±äºæ˜¯æ¶ˆæ¯æœºåˆ¶ï¼Œæ‰€ä»¥æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€ä¿®æ”¹æ–¹æ³•å®ç°ã€‚</li>
</ul>
</li>
<li><p>è°ƒç”¨æ—¶æœºï¼š+initialize æ–¹æ³•æ˜¯åœ¨ç±»ç¬¬ä¸€æ¬¡æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶æ‰ä¼šè°ƒç”¨ï¼Œè€Œä¸æ˜¯åœ¨ç±»è¢«åŠ è½½åˆ°å†…å­˜æ—¶å°±è°ƒç”¨ï¼Œè¿™ä¸ +load æ–¹æ³•æœ‰æ˜æ˜¾åŒºåˆ«ã€‚</p>
</li>
</ol>
<h2 id="load-å’Œ-initialize-çš„å¼‚åŒ"><a href="#load-å’Œ-initialize-çš„å¼‚åŒ" class="headerlink" title="+load å’Œ +initialize çš„å¼‚åŒ"></a>+load å’Œ +initialize çš„å¼‚åŒ</h2><p>+load å’Œ +initialize çš„ç›¸åŒç‚¹ï¼š</p>
<ul>
<li>å®ƒä»¬éƒ½æ˜¯ç”±ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨ï¼Œä¸”æ­£å¸¸æƒ…å†µä¸‹æ¯ä¸ªç±»åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼›</li>
<li>å®ƒä»¬åœ¨ç»§æ‰¿å…³ç³»ä¸­çš„è°ƒç”¨é¡ºåºæ˜¯ä¸€è‡´çš„ï¼Œéƒ½æ˜¯å…ˆè°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼Œå†è°ƒç”¨å­ç±»æ–¹æ³•ï¼›</li>
</ul>
<p>+load å’Œ +initialize çš„ä¸åŒç‚¹ï¼š</p>
<ul>
<li><p>è°ƒç”¨æ—¶æœºä¸åŒï¼š+load åœ¨ç±»è¢«åŠ è½½åˆ°å†…å­˜æ—¶å°±ä¼šè°ƒç”¨ï¼Œè€Œ +initialize åˆ™æ˜¯åœ¨ç±»ç¬¬ä¸€æ¬¡æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶æ‰ä¼šè°ƒç”¨ã€‚è¿™ä¸ªå·®å¼‚å¯¼è‡´äº†ä¸¤ä¸ªé‡è¦å½±å“ï¼š</p>
<ol>
<li>+load æ–¹æ³•ä¸€å®šä¼šè¢«è°ƒç”¨ï¼Œä¸”æ˜¯åœ¨ APP å¯åŠ¨è¿‡ç¨‹ä¸­è°ƒç”¨ï¼Œå› æ­¤ä¼šå½±å“å¯åŠ¨æ€§èƒ½ï¼›è€Œ +initialize æ–¹æ³•åªæœ‰åœ¨ç±»è¢«ä½¿ç”¨æ—¶æ‰ä¼šè°ƒç”¨ï¼Œå¦‚æœç±»ä»æœªè¢«ä½¿ç”¨åˆ™æ°¸è¿œä¸ä¼šè°ƒç”¨ï¼›</li>
<li>+load æ–¹æ³•é€‚åˆåšå…¨å±€æ€§çš„åˆå§‹åŒ–å·¥ä½œï¼Œè€Œ +initialize æ–¹æ³•é€‚åˆåšç±»çº§åˆ«çš„åˆå§‹åŒ–å·¥ä½œã€‚</li>
</ol>
</li>
<li><p>è°ƒç”¨æœºåˆ¶ä¸åŒï¼š+load æ–¹æ³•æ˜¯é€šè¿‡å‡½æ•°æŒ‡é’ˆç›´æ¥è°ƒç”¨ï¼Œè€Œ +initialize æ–¹æ³•æ˜¯é€šè¿‡æ¶ˆæ¯æœºåˆ¶è°ƒç”¨ã€‚è¿™ä¸ªå·®å¼‚å¯¼è‡´äº†ï¼š</p>
<ol>
<li>+load æ–¹æ³•åœ¨åˆ†ç±»ä¸­çš„å®ç°ä¼šä¸ç±»æœ¬èº«çš„å®ç°å¯ä»¥å…±å­˜ï¼Œè€Œ +initialize æ–¹æ³•åœ¨åˆ†ç±»ä¸­çš„å®ç°ä¼šè¦†ç›–ç±»æœ¬èº«çš„å®ç°ï¼›</li>
<li>å­ç±»æœªå®ç° +initialize æ–¹æ³•æ—¶ä¼šè°ƒç”¨çˆ¶ç±»çš„å®ç°ï¼Œè€Œ +load æ–¹æ³•åˆ™ä¸ä¼šã€‚</li>
</ol>
</li>
</ul>
<p>åŸºäºä»¥ä¸Šç‰¹ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºå®ƒä»¬å„è‡ªçš„æœ€ä½³å®è·µåœºæ™¯ï¼š</p>
<p>+load æ–¹æ³•é€‚ç”¨äºï¼š</p>
<ul>
<li>éœ€è¦åœ¨ APP å¯åŠ¨æ—¶å°±å¿…é¡»å®Œæˆçš„å…¨å±€åˆå§‹åŒ–å·¥ä½œï¼›</li>
<li>æ¡†æ¶çš„è‡ªåŠ¨åˆå§‹åŒ–ï¼Œæ¯”å¦‚æ³¨å†Œé€šçŸ¥è§‚å¯Ÿè€…ã€æ³¨å†Œè·¯ç”±ç­‰ï¼›</li>
<li>æ–¹æ³•äº¤æ¢ç­‰è¿è¡Œæ—¶æ“ä½œã€‚</li>
</ul>
<p>+initialize æ–¹æ³•é€‚ç”¨äºï¼š</p>
<ul>
<li>ç±»çº§åˆ«çš„åˆå§‹åŒ–å·¥ä½œï¼Œæ¯”å¦‚åˆå§‹åŒ–ç±»çš„é™æ€å˜é‡ï¼›</li>
<li>éœ€è¦æ ¹æ®è¿è¡Œæ—¶æ¡ä»¶åŠ¨æ€åˆå§‹åŒ–çš„åœºæ™¯ï¼›</li>
<li>å¸Œæœ›å»¶è¿Ÿåˆ°ç±»é¦–æ¬¡ä½¿ç”¨æ—¶æ‰æ‰§è¡Œçš„åˆå§‹åŒ–æ“ä½œã€‚</li>
</ul>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ +load æ–¹æ³•å®ç°æ¡†æ¶è‡ªåŠ¨åˆå§‹åŒ–çš„ç¤ºä¾‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="type">void</span>)load &#123;</span><br><span class="line">    [<span class="built_in">NSNotificationCenter</span>.defaultCenter addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(appDidFinishLaunching) name:<span class="built_in">UIApplicationDidFinishLaunchingNotification</span> object:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)appDidFinishLaunching &#123;</span><br><span class="line">    [<span class="built_in">NSNotificationCenter</span>.defaultCenter removeObserver:<span class="keyword">self</span> name:<span class="built_in">UIApplicationDidFinishLaunchingNotification</span> object:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åœ¨è¿™é‡Œæ‰§è¡Œæ¡†æ¶çš„åˆå§‹åŒ–é€»è¾‘ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>âš ï¸âš ï¸âš ï¸æ³¨æ„ï¼šç”±äº +load æ–¹æ³•æ˜¯åœ¨ç¨‹åºå¯åŠ¨å‰è°ƒç”¨ï¼Œæ‰€ä»¥å®ƒä¼šé™ä½ APP çš„å¯åŠ¨é€Ÿåº¦ï¼Œå› æ­¤åœ¨ä½¿ç”¨æ—¶éœ€è¦æƒè¡¡åˆ©å¼Šã€‚</p>
</blockquote>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined">å¸ƒå¤š</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://budo.top/2025/05/14/iOS/iOS ä¸­çš„ +load å’Œ +initialize åœ¨ç»§æ‰¿ä¸åˆ†ç±»ä¸­çš„ä¸åŒè¡¨ç°â€‹/">https://budo.top/2025/05/14/iOS/iOS ä¸­çš„ +load å’Œ +initialize åœ¨ç»§æ‰¿ä¸åˆ†ç±»ä¸­çš„ä¸åŒè¡¨ç°â€‹/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://budo.top">å¸ƒå¤šçš„åšå®¢</a>ï¼</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Runtime/">Runtime</a><a class="post-meta__tags" href="/tags/Category/">Category</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2025/05/18/iOS/iOS%20%E5%A6%82%E4%BD%95%E6%89%BE%E5%88%B0%E9%82%A3%E4%B8%AA%E6%96%B9%E6%B3%95%EF%BC%9F%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6%E5%BA%95%E5%B1%82%E6%8E%A2%E7%A7%98/"><i class="fa fa-chevron-left">  </i><span>iOS å¦‚ä½•æ‰¾åˆ°é‚£ä¸ªæ–¹æ³•ï¼Ÿæ¶ˆæ¯æœºåˆ¶åº•å±‚æ¢ç§˜</span></a></div><div class="next-post pull-right"><a href="/2025/05/10/iOS/%E7%AA%A5%E6%8E%A2block%EF%BC%9AiOS%E9%97%AD%E5%8C%85%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/"><span>çª¥æ¢blockï¼šiOSé—­åŒ…åº•å±‚åŸç†å®Œå…¨è§£æ</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="lv-container" data-id="city" data-uid="MTAyMC81MzU5Ny8zMDA3MA=="><script>(function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];
    if (typeof LivereTower === 'function') { return; }
    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;
    e.parentNode.insertBefore(j, e);
})(document, 'script');</script></div></div></div><footer class="footer-bg" style="background-image: url(/images/backgroundImage.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021 - 2025 By å¸ƒå¤š</div><div class="framework-info"><span>é©±åŠ¨ - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>ä¸»é¢˜ - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">æœ¬åœ°æœç´¢</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« "></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>ç”±</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>æä¾›æ”¯æŒ</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>