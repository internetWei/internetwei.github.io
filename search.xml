<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>iOS ä¸­çš„ +load å’Œ +initialize åœ¨ç»§æ‰¿ä¸åˆ†ç±»ä¸­çš„ä¸åŒè¡¨ç°â€‹</title>
      <link href="/2025/05/14/iOS/iOS%20%E4%B8%AD%E7%9A%84%20+load%20%E5%92%8C%20+initialize%20%E5%9C%A8%E7%BB%A7%E6%89%BF%E4%B8%8E%E5%88%86%E7%B1%BB%E4%B8%AD%E7%9A%84%E4%B8%8D%E5%90%8C%E8%A1%A8%E7%8E%B0%E2%80%8B/"/>
      <url>/2025/05/14/iOS/iOS%20%E4%B8%AD%E7%9A%84%20+load%20%E5%92%8C%20+initialize%20%E5%9C%A8%E7%BB%A7%E6%89%BF%E4%B8%8E%E5%88%86%E7%B1%BB%E4%B8%AD%E7%9A%84%E4%B8%8D%E5%90%8C%E8%A1%A8%E7%8E%B0%E2%80%8B/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç”± å¸ƒå¤š(budo) å‘å¸ƒäº 2025-05-14</p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨ iOS å¼€å‘ä¸­ï¼Œ+load å’Œ +initialize æ˜¯ä¸¤ä¸ªç‰¹æ®Šçš„ç±»æ–¹æ³•ï¼Œå®ƒä»¬éƒ½æ˜¯ç”±ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨ï¼Œä¸”æ­£å¸¸æƒ…å†µä¸‹æ¯ä¸ªç±»åªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚è™½ç„¶è¿™ä¸¤ä¸ªæ–¹æ³•çœ‹èµ·æ¥ç›¸ä¼¼ï¼Œä½†å®ƒä»¬åœ¨è°ƒç”¨æ—¶æœºã€è°ƒç”¨é¡ºåºä»¥åŠç»§æ‰¿å’Œåˆ†ç±»ä¸­çš„è¡¨ç°éƒ½æœ‰æ˜¾è‘—å·®å¼‚ã€‚+load æ–¹æ³•åœ¨ç¨‹åºå¯åŠ¨æ—¶ã€ç±»è¢«åŠ è½½åˆ°å†…å­˜æ—¶å°±ä¼šè°ƒç”¨ï¼Œè€Œ +initialize æ–¹æ³•åˆ™æ˜¯åœ¨ç±»ç¬¬ä¸€æ¬¡æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶æ‰ä¼šè°ƒç”¨ã€‚æœ¬æ–‡å°†æ·±å…¥ <a href="https://github.com/apple-oss-distributions/objc4/tree/objc4-906">Runtime</a> æºç ï¼Œè¯¦ç»†åˆ†æè¿™ä¸¤ä¸ªæ–¹æ³•çš„åº•å±‚å®ç°æœºåˆ¶ï¼Œå¹¶é‡ç‚¹æ¢è®¨å®ƒä»¬åœ¨ç»§æ‰¿å…³ç³»å’Œåˆ†ç±»å®ç°ä¸­çš„ä¸åŒè¡¨ç°ï¼Œå¸®åŠ©å¼€å‘è€…æ›´å¥½åœ°ç†è§£å’Œä½¿ç”¨å®ƒä»¬ã€‚</p><h2 id="load-æ–¹æ³•çš„å®ç°æœºåˆ¶"><a href="#load-æ–¹æ³•çš„å®ç°æœºåˆ¶" class="headerlink" title="+load æ–¹æ³•çš„å®ç°æœºåˆ¶"></a>+load æ–¹æ³•çš„å®ç°æœºåˆ¶</h2><p>åœ¨ <a href="https://github.com/apple-oss-distributions/objc4/tree/objc4-906">Runtime</a> æºç ä¸­æˆ‘ä»¬å¯ä»¥æ‰¾åˆ° +load æ–¹æ³•çš„å…·ä½“å®ç°ç»†èŠ‚ï¼Œæ•´ç†åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><blockquote><p>ğŸ”§ æˆ‘åœ¨ <a href="https://github.com/internetWei/ObjCRuntimes">è¿™é‡Œ</a> ç»´æŠ¤äº†ä¸€ä¸ªå¯ä»¥ç›´æ¥è¿è¡Œè°ƒè¯•çš„ Runtime é¡¹ç›®ï¼Œæ¬¢è¿å¤§å®¶ä¸‹è½½è°ƒè¯•æºç ã€‚</p></blockquote><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">load_images</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> _dyld_objc_notify_mapped_info* info)</span> </span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="type">mutex_locker_t</span> <span class="title">lock2</span><span class="params">(runtimeLock)</span></span>;</span><br><span class="line">        <span class="built_in">loadAllCategoriesIfNeeded</span>();</span><br><span class="line">        <span class="comment">// å°†ç±»å’Œåˆ†ç±»ä¸­çš„ load æ–¹æ³•æ·»åŠ åˆ°å…¨å±€æ•°ç»„ä¸­ï¼Œç­‰å¾…åç»­è°ƒç”¨ã€‚</span></span><br><span class="line">        <span class="built_in">prepare_load_methods</span>((<span class="type">const</span> headerType *)info-&gt;mh, info-&gt;sectionLocationMetadata);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨æ‰€æœ‰çš„ load æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="built_in">call_load_methods</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„æºç åˆ†æå¯ä»¥çœ‹å‡ºï¼Œ+load æ–¹æ³•çš„å®ç°è¿‡ç¨‹ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š</p><ol><li>è°ƒç”¨ <code>prepare_load_methods</code> å‡½æ•°ï¼Œå°†ç±»å’Œåˆ†ç±»æ‰€æœ‰çš„ +load æ–¹æ³•å‡†å¤‡å¥½ï¼ˆå…¶å®å°±æ˜¯å°†ç±»å’Œåˆ†ç±»ä¸­çš„ +load æ–¹æ³•æ·»åŠ åˆ°ä¸€ä¸ªå…¨å±€æ•°ç»„ä¸­ï¼‰ã€‚</li><li>è°ƒç”¨ <code>call_load_methods</code> å‡½æ•°ï¼Œéå†å‰é¢å‡†å¤‡å¥½çš„æ•°ç»„ï¼Œå¹¶è¿›è¡Œè°ƒç”¨ã€‚</li></ol><p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ·±å…¥åˆ†æ <code>prepare_load_methods</code> å‡½æ•°çš„å…·ä½“å®ç°ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•æ”¶é›†è¿™äº› +load æ–¹æ³•çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> </span></span><br><span class="line"><span class="function"><span class="title">prepare_load_methods</span><span class="params">(<span class="type">const</span> headerType *mhdr, <span class="type">const</span> <span class="type">_dyld_section_location_info_t</span> info)</span> </span>&#123;</span><br><span class="line">    <span class="type">size_t</span> count, i;</span><br><span class="line"></span><br><span class="line">    <span class="type">classref_t</span> <span class="type">const</span> *classlist = <span class="built_in">getSectionData</span>&lt;<span class="type">classref_t</span>&gt;(mhdr, </span><br><span class="line">    info, </span><br><span class="line">    _dyld_section_location_data_non_lazy_class_list, </span><br><span class="line">    &amp;count);</span><br><span class="line">    <span class="comment">// æŒ‰ç…§ç¼–è¯‘é¡ºåºéå†æ‰€æœ‰ç±»å¹¶æ·»åŠ  load æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="built_in">schedule_class_load</span>(<span class="built_in">remapClass</span>(classlist[i]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">category_t</span> * <span class="type">const</span> *categorylist = <span class="built_in">getSectionData</span>&lt;<span class="type">category_t</span> *&gt;(mhdr, </span><br><span class="line">    info,</span><br><span class="line">    _dyld_section_location_data_non_lazy_category_list, </span><br><span class="line">    &amp;count);</span><br><span class="line">    <span class="comment">// æŒ‰ç…§ç¼–è¯‘é¡ºåºéå†æ‰€æœ‰åˆ†ç±»å¹¶æ·»åŠ  load æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="type">category_t</span> *cat = categorylist[i];</span><br><span class="line">        Class cls = <span class="built_in">remapClass</span>(cat-&gt;cls);</span><br><span class="line">        <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">realizeClassWithoutSwift</span>(cls, nil);</span><br><span class="line">        <span class="built_in">add_category_to_loadable_list</span>(cat);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡†å¤‡ç±»çš„ load æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">schedule_class_load</span><span class="params">(Class cls)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥è¯¥ç±»çš„ load æ–¹æ³•æ˜¯å¦å·²ç»æ·»åŠ è¿‡ï¼Œé˜²æ­¢é‡å¤æ·»åŠ ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;<span class="built_in">data</span>()-&gt;flags &amp; RW_LOADED) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     é€’å½’è°ƒç”¨ï¼Œç¡®ä¿çˆ¶ç±»çš„ load æ–¹æ³•å…ˆæ·»åŠ ï¼Œ</span></span><br><span class="line"><span class="comment">     ä»è€Œä¿è¯å…ˆè°ƒç”¨çˆ¶ç±»çš„ load æ–¹æ³•å†è°ƒç”¨è‡ªèº«çš„ load æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">schedule_class_load</span>(cls-&gt;<span class="built_in">getSuperclass</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†å½“å‰ç±»çš„ load æ–¹æ³•æ·»åŠ åˆ°å…¨å±€æ•°ç»„ä¸­ã€‚</span></span><br><span class="line">    <span class="built_in">add_class_to_loadable_list</span>(cls);</span><br><span class="line">    cls-&gt;<span class="built_in">setInfo</span>(RW_LOADED);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">loadable_class</span> &#123;</span><br><span class="line">    Class cls;</span><br><span class="line">    IMP method;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¨å±€æ•°ç»„ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰éœ€è¦è°ƒç”¨çš„ç±»çš„ load æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">loadable_class</span> *loadable_classes = nil;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†ç±»çš„ load æ–¹æ³•æ·»åŠ åˆ°å…¨å±€æ•°ç»„ä¸­ã€‚</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">add_class_to_loadable_list</span><span class="params">(Class cls)</span> </span>&#123;</span><br><span class="line">    IMP method;</span><br><span class="line">    method = cls-&gt;<span class="built_in">getLoadMethod</span>();</span><br><span class="line">    <span class="keyword">if</span> (!method) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ¬¡è¿›æ¥æ—¶å…ˆåˆå§‹åŒ–å…¨å±€æ•°ç»„ï¼Œä»¥ç¡®ä¿å®ƒèƒ½å®¹çº³æ‰€æœ‰çš„ load æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (loadable_classes_used == loadable_classes_allocated) &#123;</span><br><span class="line">        loadable_classes_allocated = loadable_classes_allocated*<span class="number">2</span> + <span class="number">16</span>;</span><br><span class="line">        loadable_classes = (<span class="keyword">struct</span> loadable_class *)<span class="built_in">realloc</span>(loadable_classes,</span><br><span class="line">        loadable_classes_allocated * <span class="built_in">sizeof</span>(<span class="keyword">struct</span> loadable_class));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    loadable_classes[loadable_classes_used].cls = cls;</span><br><span class="line">    <span class="comment">// å°† load æ–¹æ³•æ·»åŠ åˆ°å…¨å±€æ•°ç»„ä¸­ã€‚</span></span><br><span class="line">    loadable_classes[loadable_classes_used].method = method;</span><br><span class="line">    loadable_classes_used++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">loadable_category</span> &#123;</span><br><span class="line">    Category cat;</span><br><span class="line">    IMP method;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¨å±€æ•°ç»„ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰éœ€è¦è°ƒç”¨çš„åˆ†ç±»çš„ load æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">loadable_category</span> *loadable_categories = nil;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†åˆ†ç±»çš„ load æ–¹æ³•æ·»åŠ åˆ°å…¨å±€æ•°ç»„ä¸­ã€‚</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">add_category_to_loadable_list</span><span class="params">(Category cat)</span> </span>&#123;</span><br><span class="line">    IMP method;</span><br><span class="line">    method = _category_getLoadMethod(cat);</span><br><span class="line">    <span class="keyword">if</span> (!method) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ¬¡è¿›æ¥æ—¶å…ˆåˆå§‹åŒ–å…¨å±€æ•°ç»„ï¼Œä»¥ç¡®ä¿å®ƒèƒ½å®¹çº³æ‰€æœ‰çš„ load æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (loadable_categories_used == loadable_categories_allocated) &#123;</span><br><span class="line">        loadable_categories_allocated = loadable_categories_allocated*<span class="number">2</span> + <span class="number">16</span>;</span><br><span class="line">        loadable_categories = (<span class="keyword">struct</span> loadable_category *)<span class="built_in">realloc</span>(loadable_categories,</span><br><span class="line">        loadable_categories_allocated * <span class="built_in">sizeof</span>(<span class="keyword">struct</span> loadable_category));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    loadable_categories[loadable_categories_used].cat = cat;</span><br><span class="line">    <span class="comment">// å°†åˆ†ç±»çš„ load æ–¹æ³•æ·»åŠ åˆ°å…¨å±€æ•°ç»„ä¸­ã€‚</span></span><br><span class="line">    loadable_categories[loadable_categories_used].method = method;</span><br><span class="line">    loadable_categories_used++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡åˆ†ææºç ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡º +load æ–¹æ³•çš„åŠ è½½é¡ºåºè§„åˆ™ï¼š</p><ol><li>ç³»ç»Ÿä¼šæŒ‰ç…§ç¼–è¯‘é¡ºåºéå†æ‰€æœ‰çš„ç±»å’Œåˆ†ç±»ï¼›</li><li>å¯¹äºç±»çš„ +load æ–¹æ³•ï¼Œç³»ç»Ÿé€šè¿‡ <code>schedule_class_load</code> å‡½æ•°é€’å½’å¤„ç†ï¼Œç¡®ä¿äº†çˆ¶ç±»çš„ +load æ–¹æ³•å…ˆäºå­ç±»è°ƒç”¨ï¼Œè¿™ä¿è¯äº†ç»§æ‰¿é“¾ä¸Šçš„ +load æ–¹æ³•è°ƒç”¨é¡ºåºæ˜¯ä»çˆ¶ç±»åˆ°å­ç±»ï¼›</li><li>å¯¹äºåˆ†ç±»çš„ +load æ–¹æ³•ï¼Œç³»ç»Ÿé€šè¿‡ <code>add_category_to_loadable_list</code> å‡½æ•°æŒ‰ç…§ç¼–è¯‘é¡ºåºæ·»åŠ ã€‚</li></ol><p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ç»§ç»­åˆ†æ <code>call_load_methods</code> å‡½æ•°çš„å…·ä½“å®ç°ï¼Œçœ‹çœ‹ç³»ç»Ÿæ˜¯å¦‚ä½•è°ƒç”¨è¿™äº› +load æ–¹æ³•çš„ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">call_load_methods</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">bool</span> loading = NO;</span><br><span class="line">    <span class="type">bool</span> more_categories;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜²æ­¢é‡å¤è°ƒç”¨ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (loading) <span class="keyword">return</span>;</span><br><span class="line">    loading = YES;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *pool = <span class="built_in">objc_autoreleasePoolPush</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// å…ˆè°ƒç”¨ç±»çš„ +load æ–¹æ³•ã€‚</span></span><br><span class="line">        <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">call_class_loads</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å†è°ƒç”¨åˆ†ç±»çš„ +load æ–¹æ³•ã€‚</span></span><br><span class="line">        more_categories = <span class="built_in">call_category_loads</span>();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¦‚æœç±»å’Œåˆ†ç±»ä¸­è¿˜æœ‰æ²¡è°ƒç”¨çš„ +load æ–¹æ³•ï¼Œåˆ™ç»§ç»­è°ƒç”¨ã€‚</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>  ||  more_categories);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">objc_autoreleasePoolPop</span>(pool);</span><br><span class="line"></span><br><span class="line">    loading = NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨ç±»æ‰€æœ‰çš„ +load æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">call_class_loads</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">loadable_class</span> *classes = loadable_classes;</span><br><span class="line">    <span class="type">int</span> used = loadable_classes_used;</span><br><span class="line">    loadable_classes = nil;</span><br><span class="line">    loadable_classes_allocated = <span class="number">0</span>;</span><br><span class="line">    loadable_classes_used = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// éå†å…¨å±€æ•°ç»„å¹¶è°ƒç”¨æ‰€æœ‰éœ€è¦è°ƒç”¨çš„ +load æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; used; i++) &#123;</span><br><span class="line">        Class cls = classes[i].cls;</span><br><span class="line">        <span class="type">load_method_t</span> load_method = (<span class="type">load_method_t</span>)classes[i].method;</span><br><span class="line">        <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>; </span><br><span class="line">        <span class="comment">// æ‹¿åˆ° load æ–¹æ³•çš„å‡½æ•°æŒ‡é’ˆè¿›è¡Œè°ƒç”¨ã€‚</span></span><br><span class="line">        (*load_method)(cls, @<span class="built_in">selector</span>(load));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (classes) <span class="built_in">free</span>(classes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨åˆ†ç±»æ‰€æœ‰çš„ +load æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">call_category_loads</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> i, shift;</span><br><span class="line">    <span class="type">bool</span> new_categories_added = NO;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">loadable_category</span> *cats = loadable_categories;</span><br><span class="line">    <span class="type">int</span> used = loadable_categories_used;</span><br><span class="line">    <span class="type">int</span> allocated = loadable_categories_allocated;</span><br><span class="line">    loadable_categories = nil;</span><br><span class="line">    loadable_categories_allocated = <span class="number">0</span>;</span><br><span class="line">    loadable_categories_used = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éå†å…¨å±€æ•°ç»„å¹¶è°ƒç”¨æ‰€æœ‰éœ€è¦è°ƒç”¨çš„ +load æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; used; i++) &#123;</span><br><span class="line">        Category cat = cats[i].cat;</span><br><span class="line">        <span class="type">load_method_t</span> load_method = (<span class="type">load_method_t</span>)cats[i].method;</span><br><span class="line">        Class cls;</span><br><span class="line">        <span class="keyword">if</span> (!cat) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        cls = _category_getClass(cat);</span><br><span class="line">        <span class="comment">// ç¡®ä¿ç±»çš„ +load æ–¹æ³•å·²ç»è°ƒç”¨äº†å†è°ƒç”¨åˆ†ç±»çš„ +load æ–¹æ³•ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (cls  &amp;&amp;  cls-&gt;<span class="built_in">isLoadable</span>()) &#123;</span><br><span class="line">            (*load_method)(cls, @<span class="built_in">selector</span>(load));</span><br><span class="line">            cats[i].cat = nil;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    shift = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// å°†åˆ†ç±»ä¸­è¿˜æœªè°ƒç”¨çš„ load æ–¹æ³•æŒªåˆ°æ•°ç»„å‰é¢ã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; used; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cats[i].cat) &#123;</span><br><span class="line">            cats[i-shift] = cats[i];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            shift++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    used -= shift;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰é€šè¿‡è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ çš„åˆ†ç±»ã€‚</span></span><br><span class="line">    new_categories_added = (loadable_categories_used &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; loadable_categories_used; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (used == allocated) &#123;</span><br><span class="line">            allocated = allocated*<span class="number">2</span> + <span class="number">16</span>;</span><br><span class="line">            cats = (<span class="keyword">struct</span> loadable_category *)<span class="built_in">realloc</span>(cats, </span><br><span class="line">            allocated * <span class="built_in">sizeof</span>(<span class="keyword">struct</span> loadable_category));</span><br><span class="line">        &#125;</span><br><span class="line">        cats[used++] = loadable_categories[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (loadable_categories) <span class="built_in">free</span>(loadable_categories);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰é€šè¿‡è¿è¡Œæ—¶æ–°æ·»åŠ çš„åˆ†ç±»ï¼Œå°†å®ƒä»¬èµ‹å€¼ç»™å…¨å±€æ•°ç»„ï¼Œç­‰å¾…åç»­è°ƒç”¨ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (used) &#123;</span><br><span class="line">        loadable_categories = cats;</span><br><span class="line">        loadable_categories_used = used;</span><br><span class="line">        loadable_categories_allocated = allocated;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (cats) <span class="built_in">free</span>(cats);</span><br><span class="line">        loadable_categories = nil;</span><br><span class="line">        loadable_categories_used = <span class="number">0</span>;</span><br><span class="line">        loadable_categories_allocated = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰åŠ¨æ€æ·»åŠ çš„åˆ†ç±»ï¼Œè¿”å› YESï¼Œå¦åˆ™è¿”å› NOã€‚</span></span><br><span class="line">    <span class="keyword">return</span> new_categories_added;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡åˆ†ææºç ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡º +load æ–¹æ³•çš„è°ƒç”¨é¡ºåºè§„åˆ™ï¼š</p><ol><li>ç³»ç»Ÿä¼šå…ˆè°ƒç”¨ç±»ä¸­çš„ load æ–¹æ³•ï¼Œç„¶åå†è°ƒç”¨åˆ†ç±»ä¸­çš„ load æ–¹æ³•ï¼›</li><li>ç³»ç»Ÿåœ¨è°ƒç”¨åˆ†ç±»çš„ +load æ–¹æ³•æ—¶ï¼Œä¼šæœ‰è¯¸å¤šåˆ¤æ–­ï¼Œæ¯”å¦‚æ˜¯å¦å·²ç»è°ƒç”¨è¿‡ç±»çš„ +load æ–¹æ³•ï¼Œæ˜¯å¦æœ‰åŠ¨æ€æ·»åŠ çš„åˆ†ç±»ç­‰ç­‰ã€‚</li></ol><p>åœ¨è°ƒè¯•çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç°äº†ä¸€ä¸ªå¥‡æ€ªçš„ç°è±¡ï¼Œå½“ä¸€ä¸ªç±»æ²¡æœ‰å®ç° +load æ–¹æ³•ï¼Œä½†æ˜¯å®ƒçš„åˆ†ç±»ï¼ˆæœ‰ä¸”åªæœ‰ä¸€ä¸ªï¼‰å®ç°äº† +load æ–¹æ³•æ—¶ï¼Œè°ƒç”¨é¡ºåºä¼šå‘ç”Ÿå˜åŒ–ã€‚ä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">@implementation Person: NSObject</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation Student: Person</span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)load &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(@<span class="string">&quot;%s&quot;</span>, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@<span class="function">implementation <span class="title">Person</span> <span class="params">(Category1)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">+ <span class="params">(<span class="type">void</span>)</span>load </span>&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(@<span class="string">&quot;%s&quot;</span>, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@<span class="function">implementation <span class="title">Student</span> <span class="params">(Category1)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">+ <span class="params">(<span class="type">void</span>)</span>load </span>&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(@<span class="string">&quot;%s&quot;</span>, __func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œæˆ‘è§‚å¯Ÿåˆ°ä¸€ä¸ªå¥‡æ€ªçš„è°ƒç”¨é¡ºåºç°è±¡ã€‚æ ¹æ® Runtime æºç çš„å®ç°ï¼Œç†è®ºä¸Šåº”è¯¥æ˜¯å…ˆè°ƒç”¨å®Œæ‰€æœ‰ç±»çš„ +load æ–¹æ³•ï¼Œç„¶åå†è°ƒç”¨åˆ†ç±»çš„ +load æ–¹æ³•ã€‚ä½†å®é™…è¿è¡Œç»“æœå´æ˜¾ç¤ºï¼š</p><ol><li>é¦–å…ˆè°ƒç”¨ Person åˆ†ç±»çš„ +load æ–¹æ³•</li><li>ç„¶åè°ƒç”¨ Student ç±»çš„ +load æ–¹æ³•</li><li>æœ€åè°ƒç”¨ Student åˆ†ç±»çš„ +load æ–¹æ³•</li></ol><p>æ›´å¥‡æ€ªçš„æ˜¯ï¼Œå½“ Person ç±»æœ‰å¤šä¸ªåˆ†ç±»éƒ½å®ç°äº† +load æ–¹æ³•æ—¶ï¼Œè°ƒç”¨é¡ºåºåˆä¼šå›å½’åˆ°é¢„æœŸï¼šå…ˆè°ƒç”¨ Student ç±»çš„ +load æ–¹æ³•ï¼Œç„¶åæŒ‰ç…§ç¼–è¯‘é¡ºåºä¾æ¬¡è°ƒç”¨æ‰€æœ‰åˆ†ç±»çš„ +load æ–¹æ³•ã€‚</p><p>è¿™ç§ç‰¹æ®Šç°è±¡å¯èƒ½ä¸ Runtime åœ¨å¤„ç†å•ä¸ªåˆ†ç±»æ—¶çš„ä¼˜åŒ–ç­–ç•¥æœ‰å…³ã€‚å½“ç±»åªæœ‰ä¸€ä¸ªåˆ†ç±»æ—¶ï¼Œç³»ç»Ÿå¯èƒ½é‡‡ç”¨äº†ä¸åŒçš„å¤„ç†è·¯å¾„ï¼Œå¯¼è‡´è°ƒç”¨é¡ºåºå‘ç”Ÿå˜åŒ–ã€‚ä¸è¿‡ï¼Œç”±äºè¿™ç§å·®å¼‚å¹¶ä¸å½±å“ç¨‹åºçš„æ­£ç¡®æ€§ï¼Œä¸”åœ¨å¤šåˆ†ç±»åœºæ™¯ä¸‹è¡¨ç°æ­£å¸¸ï¼Œæ‰€ä»¥è¿™å¾ˆå¯èƒ½æ˜¯ Runtime çš„ä¸€ä¸ªå®ç°ç»†èŠ‚ï¼Œè€Œé bugã€‚ä»¥ä¸Šè§‚ç‚¹ä»…æ˜¯æˆ‘çš„ä¸ªäººçŒœæµ‹ï¼Œå¦‚æœå¤§å®¶æœ‰æ›´æ·±å…¥çš„ç†è§£ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºåˆ†äº«ä½ çš„è§è§£ã€‚</p><h2 id="initialize-æ–¹æ³•çš„å®ç°æœºåˆ¶"><a href="#initialize-æ–¹æ³•çš„å®ç°æœºåˆ¶" class="headerlink" title="+initialize æ–¹æ³•çš„å®ç°æœºåˆ¶"></a>+initialize æ–¹æ³•çš„å®ç°æœºåˆ¶</h2><p>ä¸ +load æ–¹æ³•ä¸åŒï¼Œ+initialize æ–¹æ³•æ˜¯åœ¨ç±»ç¬¬ä¸€æ¬¡æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶æ‰ä¼šè¢«è°ƒç”¨ã€‚è¿™ç§å»¶è¿Ÿè°ƒç”¨çš„æœºåˆ¶ä½¿å¾— +initialize æ–¹æ³•æ›´é€‚åˆç”¨äºç±»çš„åˆå§‹åŒ–å·¥ä½œï¼Œå› ä¸ºå®ƒå¯ä»¥ç¡®ä¿ç±»åœ¨è¢«å®é™…ä½¿ç”¨å‰å®Œæˆå¿…è¦çš„è®¾ç½®ã€‚åœ¨ <a href="https://github.com/apple-oss-distributions/objc4/tree/objc4-906">Runtime</a> æºç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ° +initialize æ–¹æ³•çš„å…·ä½“å®ç°ç»†èŠ‚ï¼Œæ•´ç†åçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> Class</span></span><br><span class="line"><span class="function"><span class="title">realizeAndInitializeIfNeeded_locked</span><span class="params">(id inst, Class cls, <span class="type">bool</span> initialize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">slowpath</span>(!cls-&gt;<span class="built_in">isRealized</span>())) &#123;</span><br><span class="line">        cls = <span class="built_in">realizeClassMaybeSwiftAndLeaveLocked</span>(cls, runtimeLock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!cls || !cls-&gt;<span class="built_in">ISA</span>()) <span class="keyword">return</span> nil;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦ä»æœªè°ƒç”¨è¿‡ +initialize æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">slowpath</span>(initialize &amp;&amp; !cls-&gt;<span class="built_in">isInitialized</span>())) &#123;</span><br><span class="line">        cls = <span class="built_in">initializeAndLeaveLocked</span>(cls, inst, runtimeLock);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cls;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> Class</span></span><br><span class="line"><span class="function"><span class="title">initializeAndLeaveLocked</span><span class="params">(Class cls, id obj, <span class="type">mutex_t</span>&amp; lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">initializeAndMaybeRelock</span>(cls, obj, lock, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> Class</span></span><br><span class="line"><span class="function"><span class="title">initializeAndMaybeRelock</span><span class="params">(Class cls,</span></span></span><br><span class="line"><span class="params"><span class="function">                         id inst,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="type">mutex_t</span>&amp; lock, <span class="type">bool</span> leaveLocked)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;<span class="built_in">isInitialized</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!leaveLocked) lock.<span class="built_in">unlock</span>();</span><br><span class="line">        <span class="keyword">return</span> cls;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class nonmeta = <span class="built_in">getMaybeUnrealizedNonMetaClass</span>(cls, inst);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nonmeta-&gt;<span class="built_in">isRealized</span>()) &#123;</span><br><span class="line">        lock.<span class="built_in">unlock</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nonmeta = <span class="built_in">realizeClassMaybeSwiftAndUnlock</span>(nonmeta, lock);</span><br><span class="line">        cls = <span class="built_in">object_getClass</span>(nonmeta);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è°ƒç”¨ç±»çš„ +initialize æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="built_in">initializeNonMetaClass</span>(nonmeta);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (leaveLocked) runtimeLock.<span class="built_in">lock</span>();</span><br><span class="line">    <span class="keyword">return</span> cls;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">initializeNonMetaClass</span><span class="params">(Class cls)</span> </span>&#123;</span><br><span class="line">    Class supercls = cls-&gt;<span class="built_in">getSuperclass</span>();</span><br><span class="line">    <span class="comment">// å…ˆè°ƒç”¨çˆ¶ç±»çš„ +initialize æ–¹æ³•ï¼Œç„¶åå†è°ƒç”¨è‡ªèº«çš„ +initialize æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (supercls  &amp;&amp;  !supercls-&gt;<span class="built_in">isInitialized</span>()) &#123;</span><br><span class="line">        <span class="built_in">initializeNonMetaClass</span>(supercls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">lockClass</span>(cls);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;<span class="built_in">isInitialized</span>()) &#123;</span><br><span class="line">        <span class="built_in">unlockClass</span>(cls);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœç±»æ­£åœ¨å…¶ä»–çº¿ç¨‹è°ƒç”¨ +initialize æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;<span class="built_in">isInitializing</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!MultithreadedForkChild || _thisThreadIsInitializingClass(cls)) &#123;</span><br><span class="line">            <span class="built_in">unlockClass</span>(cls);<span class="comment">// é¿å…æ­»é”å’Œé‡å¤è°ƒç”¨ã€‚</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">lockClass</span>(cls);</span><br><span class="line">            _setThisThreadIsInitializingClass(cls);</span><br><span class="line">            <span class="built_in">performForkChildInitialize</span>(cls, supercls);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SmallVector&lt;_objc_willInitializeClassCallback, <span class="number">1</span>&gt; localWillInitializeFuncs;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="type">mutex_locker_t</span> <span class="title">lock</span><span class="params">(classInitLock)</span></span>;</span><br><span class="line">        cls-&gt;<span class="built_in">setInitializing</span>();</span><br><span class="line">        localWillInitializeFuncs.<span class="built_in">initFrom</span>(willInitializeFuncs);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _setThisThreadIsInitializingClass(cls);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (MultithreadedForkChild) &#123;</span><br><span class="line">        <span class="built_in">performForkChildInitialize</span>(cls, supercls);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> callback : localWillInitializeFuncs) &#123;</span><br><span class="line">        callback.<span class="built_in">f</span>(callback.context, cls);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @<span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ç±»çš„ +initialize æ–¹æ³•ã€‚</span></span><br><span class="line">        <span class="built_in">callInitialize</span>(cls);</span><br><span class="line">    &#125; @<span class="built_in">catch</span> (...) &#123;</span><br><span class="line">        @<span class="keyword">throw</span>;</span><br><span class="line">    &#125; @finally &#123;</span><br><span class="line">        <span class="built_in">lockAndFinishInitializing</span>(cls, supercls);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">callInitialize</span><span class="params">(Class cls)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡æ¶ˆæ¯æœºåˆ¶å‘ cls å‘é€ initialize æ¶ˆæ¯ã€‚</span></span><br><span class="line">    <span class="built_in">objc_msgSend</span>(cls, @<span class="built_in">selector</span>(initialize));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡åˆ†æ Runtime æºç ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡º +initialize æ–¹æ³•çš„è°ƒç”¨æœºåˆ¶å’Œç‰¹ç‚¹ï¼š</p><ol><li><p>è°ƒç”¨é¡ºåºï¼šç³»ç»Ÿä¼šå…ˆè°ƒç”¨çˆ¶ç±»çš„ +initialize æ–¹æ³•ï¼Œå†è°ƒç”¨å­ç±»çš„ +initialize æ–¹æ³•ï¼Œè¿™ä¿è¯äº†ç»§æ‰¿é“¾ä¸Šçš„åˆå§‹åŒ–é¡ºåºæ˜¯ä»çˆ¶ç±»åˆ°å­ç±»ï¼›</p></li><li><p>è°ƒç”¨æœºåˆ¶ï¼š+initialize æ–¹æ³•æ˜¯é€šè¿‡ objc_msgSend æ¶ˆæ¯æœºåˆ¶è°ƒç”¨çš„ï¼Œè¿™æ„å‘³ç€ï¼š</p><ul><li>å¦‚æœå­ç±»æœªå®ç° +initialize æ–¹æ³•ï¼Œä¼šè°ƒç”¨çˆ¶ç±»çš„å®ç°ï¼›</li><li>å¦‚æœåˆ†ç±»å®ç°äº† +initialize æ–¹æ³•ï¼Œä¼šè¦†ç›–ç±»æœ¬èº«çš„å®ç°ï¼›</li><li>ç”±äºæ˜¯æ¶ˆæ¯æœºåˆ¶ï¼Œæ‰€ä»¥æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€ä¿®æ”¹æ–¹æ³•å®ç°ã€‚</li></ul></li><li><p>è°ƒç”¨æ—¶æœºï¼š+initialize æ–¹æ³•æ˜¯åœ¨ç±»ç¬¬ä¸€æ¬¡æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶æ‰ä¼šè°ƒç”¨ï¼Œè€Œä¸æ˜¯åœ¨ç±»è¢«åŠ è½½åˆ°å†…å­˜æ—¶å°±è°ƒç”¨ï¼Œè¿™ä¸ +load æ–¹æ³•æœ‰æ˜æ˜¾åŒºåˆ«ã€‚</p></li></ol><h2 id="load-å’Œ-initialize-çš„å¼‚åŒ"><a href="#load-å’Œ-initialize-çš„å¼‚åŒ" class="headerlink" title="+load å’Œ +initialize çš„å¼‚åŒ"></a>+load å’Œ +initialize çš„å¼‚åŒ</h2><p>+load å’Œ +initialize çš„ç›¸åŒç‚¹ï¼š</p><ul><li>å®ƒä»¬éƒ½æ˜¯ç”±ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨ï¼Œä¸”æ­£å¸¸æƒ…å†µä¸‹æ¯ä¸ªç±»åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼›</li><li>å®ƒä»¬åœ¨ç»§æ‰¿å…³ç³»ä¸­çš„è°ƒç”¨é¡ºåºæ˜¯ä¸€è‡´çš„ï¼Œéƒ½æ˜¯å…ˆè°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼Œå†è°ƒç”¨å­ç±»æ–¹æ³•ï¼›</li></ul><p>+load å’Œ +initialize çš„ä¸åŒç‚¹ï¼š</p><ul><li><p>è°ƒç”¨æ—¶æœºä¸åŒï¼š+load åœ¨ç±»è¢«åŠ è½½åˆ°å†…å­˜æ—¶å°±ä¼šè°ƒç”¨ï¼Œè€Œ +initialize åˆ™æ˜¯åœ¨ç±»ç¬¬ä¸€æ¬¡æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶æ‰ä¼šè°ƒç”¨ã€‚è¿™ä¸ªå·®å¼‚å¯¼è‡´äº†ä¸¤ä¸ªé‡è¦å½±å“ï¼š</p><ol><li>+load æ–¹æ³•ä¸€å®šä¼šè¢«è°ƒç”¨ï¼Œä¸”æ˜¯åœ¨ APP å¯åŠ¨è¿‡ç¨‹ä¸­è°ƒç”¨ï¼Œå› æ­¤ä¼šå½±å“å¯åŠ¨æ€§èƒ½ï¼›è€Œ +initialize æ–¹æ³•åªæœ‰åœ¨ç±»è¢«ä½¿ç”¨æ—¶æ‰ä¼šè°ƒç”¨ï¼Œå¦‚æœç±»ä»æœªè¢«ä½¿ç”¨åˆ™æ°¸è¿œä¸ä¼šè°ƒç”¨ï¼›</li><li>+load æ–¹æ³•é€‚åˆåšå…¨å±€æ€§çš„åˆå§‹åŒ–å·¥ä½œï¼Œè€Œ +initialize æ–¹æ³•é€‚åˆåšç±»çº§åˆ«çš„åˆå§‹åŒ–å·¥ä½œã€‚</li></ol></li><li><p>è°ƒç”¨æœºåˆ¶ä¸åŒï¼š+load æ–¹æ³•æ˜¯é€šè¿‡å‡½æ•°æŒ‡é’ˆç›´æ¥è°ƒç”¨ï¼Œè€Œ +initialize æ–¹æ³•æ˜¯é€šè¿‡æ¶ˆæ¯æœºåˆ¶è°ƒç”¨ã€‚è¿™ä¸ªå·®å¼‚å¯¼è‡´äº†ï¼š</p><ol><li>+load æ–¹æ³•åœ¨åˆ†ç±»ä¸­çš„å®ç°ä¼šä¸ç±»æœ¬èº«çš„å®ç°å¯ä»¥å…±å­˜ï¼Œè€Œ +initialize æ–¹æ³•åœ¨åˆ†ç±»ä¸­çš„å®ç°ä¼šè¦†ç›–ç±»æœ¬èº«çš„å®ç°ï¼›</li><li>å­ç±»æœªå®ç° +initialize æ–¹æ³•æ—¶ä¼šè°ƒç”¨çˆ¶ç±»çš„å®ç°ï¼Œè€Œ +load æ–¹æ³•åˆ™ä¸ä¼šã€‚</li></ol></li></ul><p>åŸºäºä»¥ä¸Šç‰¹ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºå®ƒä»¬å„è‡ªçš„æœ€ä½³å®è·µåœºæ™¯ï¼š</p><p>+load æ–¹æ³•é€‚ç”¨äºï¼š</p><ul><li>éœ€è¦åœ¨ APP å¯åŠ¨æ—¶å°±å¿…é¡»å®Œæˆçš„å…¨å±€åˆå§‹åŒ–å·¥ä½œï¼›</li><li>æ¡†æ¶çš„è‡ªåŠ¨åˆå§‹åŒ–ï¼Œæ¯”å¦‚æ³¨å†Œé€šçŸ¥è§‚å¯Ÿè€…ã€æ³¨å†Œè·¯ç”±ç­‰ï¼›</li><li>æ–¹æ³•äº¤æ¢ç­‰è¿è¡Œæ—¶æ“ä½œã€‚</li></ul><p>+initialize æ–¹æ³•é€‚ç”¨äºï¼š</p><ul><li>ç±»çº§åˆ«çš„åˆå§‹åŒ–å·¥ä½œï¼Œæ¯”å¦‚åˆå§‹åŒ–ç±»çš„é™æ€å˜é‡ï¼›</li><li>éœ€è¦æ ¹æ®è¿è¡Œæ—¶æ¡ä»¶åŠ¨æ€åˆå§‹åŒ–çš„åœºæ™¯ï¼›</li><li>å¸Œæœ›å»¶è¿Ÿåˆ°ç±»é¦–æ¬¡ä½¿ç”¨æ—¶æ‰æ‰§è¡Œçš„åˆå§‹åŒ–æ“ä½œã€‚</li></ul><p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ +load æ–¹æ³•å®ç°æ¡†æ¶è‡ªåŠ¨åˆå§‹åŒ–çš„ç¤ºä¾‹ï¼š</p><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="type">void</span>)load &#123;</span><br><span class="line">    [<span class="built_in">NSNotificationCenter</span>.defaultCenter addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(appDidFinishLaunching) name:<span class="built_in">UIApplicationDidFinishLaunchingNotification</span> object:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)appDidFinishLaunching &#123;</span><br><span class="line">    [<span class="built_in">NSNotificationCenter</span>.defaultCenter removeObserver:<span class="keyword">self</span> name:<span class="built_in">UIApplicationDidFinishLaunchingNotification</span> object:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åœ¨è¿™é‡Œæ‰§è¡Œæ¡†æ¶çš„åˆå§‹åŒ–é€»è¾‘ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>âš ï¸âš ï¸âš ï¸æ³¨æ„ï¼šç”±äº +load æ–¹æ³•æ˜¯åœ¨ç¨‹åºå¯åŠ¨å‰è°ƒç”¨ï¼Œæ‰€ä»¥å®ƒä¼šé™ä½ APP çš„å¯åŠ¨é€Ÿåº¦ï¼Œå› æ­¤åœ¨ä½¿ç”¨æ—¶éœ€è¦æƒè¡¡åˆ©å¼Šã€‚</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Runtime </tag>
            
            <tag> Category </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>çª¥æ¢blockï¼šiOSé—­åŒ…åº•å±‚åŸç†å®Œå…¨è§£æ</title>
      <link href="/2025/05/10/iOS/%E7%AA%A5%E6%8E%A2block%EF%BC%9AiOS%E9%97%AD%E5%8C%85%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/"/>
      <url>/2025/05/10/iOS/%E7%AA%A5%E6%8E%A2block%EF%BC%9AiOS%E9%97%AD%E5%8C%85%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E5%AE%8C%E5%85%A8%E8%A7%A3%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç”± å¸ƒå¤š(budo) å‘å¸ƒäº 2025-05-10</p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>block æ˜¯ iOS å¼€å‘ä¸­ä¸€ä¸ªéå¸¸å¸¸ç”¨çš„ç‰¹æ€§ï¼Œå®ƒå…è®¸æˆ‘ä»¬å°†æ‰§è¡Œé€»è¾‘å’Œæ•°æ®å°è£…æˆä¸€ä¸ªä»£ç å—ï¼Œå¹¶å°†å…¶ä½œä¸ºå‡½æ•°å‚æ•°ã€è¿”å›å€¼è¿›è¡Œä¼ é€’ã€‚è¿™ç§è®¾è®¡ä½¿å¾— block åœ¨å®ç°å›è°ƒã€å¼‚æ­¥æ“ä½œã€é“¾å¼è°ƒç”¨ç­‰åœºæ™¯æ—¶å˜å¾—å¼‚å¸¸ä¼˜é›…å’Œé«˜æ•ˆã€‚block æœ€å¼•äººæ³¨ç›®çš„ç‰¹æ€§åœ¨äºå®ƒèƒ½å¤Ÿæ•è·å¹¶æŒæœ‰å¤–éƒ¨å˜é‡ï¼Œè¿™ä½¿å¾—å®ƒåœ¨å¤„ç†å¼‚æ­¥ä»»åŠ¡ã€äº‹ä»¶å“åº”ç­‰åœºæ™¯ä¸­è¡¨ç°å‡ºè‰²ï¼ŒåŒæ—¶ä¹Ÿä¸ºå¼€å‘è€…æä¾›äº†æå¤§çš„çµæ´»æ€§ã€‚</p><p>æœ¬æ–‡å°†å’Œå¤§å®¶ä¸€èµ·æ·±å…¥å‰–æ block çš„åº•å±‚å®ç°åŸç†ï¼Œä»å†…éƒ¨æ•°æ®ç»“æ„ã€å†…å­˜ç®¡ç†æœºåˆ¶åˆ°ä½¿ç”¨æ³¨æ„äº‹é¡¹ç­‰å¤šä¸ªç»´åº¦ï¼Œå¸®åŠ©è¯»è€…å…¨é¢ç†è§£è¿™ä¸€æŠ€æœ¯çš„ç²¾é«“ï¼Œä»è€Œåœ¨å®é™…å¼€å‘ä¸­æ›´å¥½åœ°è¿ç”¨ block ç‰¹æ€§ã€‚</p><p>å…³äº block çš„æ•°æ®ç»“æ„æ˜¯å¼€æºçš„ï¼Œåœ¨ <a href="https://github.com/apple-oss-distributions/libclosure/tree/main">libclosure</a> åº“ä¸­ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å»çœ‹ä¸€ä¸‹ã€‚</p><h2 id="block-çš„æœ¬è´¨"><a href="#block-çš„æœ¬è´¨" class="headerlink" title="block çš„æœ¬è´¨"></a>block çš„æœ¬è´¨</h2><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="built_in">void</span> (^block)(<span class="type">void</span>) = ^&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;----block-----\n&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">block</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ®µä»£ç å±•ç¤ºäº† block çš„åŸºæœ¬ç”¨æ³•ã€‚ä¸ºäº†æ·±å…¥ç†è§£ block çš„åº•å±‚å®ç°åŸç†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ clang ç¼–è¯‘å™¨å°†å…¶è½¬æ¢ä¸º C++ ä»£ç ã€‚é€šè¿‡åˆ†æè½¬æ¢åçš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ° block åœ¨åº•å±‚çš„å…·ä½“ç»“æ„ï¼ŒåŒ…æ‹¬å…¶å†…éƒ¨çš„æ•°æ®ç»„ç»‡æ–¹å¼ã€å‡½æ•°æŒ‡é’ˆçš„å­˜å‚¨ä½ç½®ä»¥åŠå†…å­˜å¸ƒå±€ç­‰å…³é”®ç»†èŠ‚ã€‚</p><blockquote><p>ä½¿ç”¨ <code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc -fobjc-arc -fobjc-runtime=ios-18.0.0 main.m</code> å‘½ä»¤å¯ä»¥å°† main.m æ–‡ä»¶å†…çš„ä»£ç è½¬æ¢ä¸º C++ ä»£ç ã€‚ æ³¨æ„ï¼šè½¬æ¢åçš„ C++ ä»£ç å¹¶ä¸æ˜¯çœŸæ­£æ‰§è¡Œçš„ä»£ç ï¼Œä»…ä¾›å‚è€ƒã€‚</p></blockquote><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// block çš„ç»“æ„ä½“ã€‚</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">__main_block_impl_0</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">__block_impl</span> impl;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">__main_block_desc_0</span>* Desc;</span><br><span class="line">  </span><br><span class="line">  __main_block_impl_0(<span class="type">void</span> *fp, <span class="keyword">struct</span> __main_block_desc_0 *desc, <span class="type">int</span> flags=<span class="number">0</span>) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackblock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// block çš„æ‰§è¡Œä½“ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;----block-----\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// block çš„æè¿°ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">__main_block_desc_0</span> &#123;</span><br><span class="line">  <span class="type">size_t</span> reserved;</span><br><span class="line">  <span class="type">size_t</span> block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="built_in">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0)&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">__block_impl</span> &#123;</span><br><span class="line">  <span class="type">void</span> *isa;</span><br><span class="line">  <span class="type">int</span> Flags;</span><br><span class="line">  <span class="type">int</span> Reserved;</span><br><span class="line">  <span class="comment">// æŒ‡å‘ block æ‰§è¡Œä½“çš„å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">  <span class="type">void</span> *FuncPtr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="built_in">void</span> (*block)(<span class="type">void</span>) = &amp;__main_block_impl_0(__main_block_func_0, &amp;__main_block_desc_0_DATA);</span><br><span class="line">    block-&gt;<span class="built_in">FuncPtr</span>(block);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡åˆ†æè½¬æ¢åçš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š</p><ol><li><p>block æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª ObjC å¯¹è±¡ã€‚å› ä¸ºåœ¨ ObjC ä¸­ï¼Œä»»ä½•ä»¥ <code>isa</code> æŒ‡é’ˆä½œä¸ºé¦–æˆå‘˜çš„ç»“æ„ä½“éƒ½å¯ä»¥è¢«è§†ä¸ºä¸€ä¸ªå¯¹è±¡ã€‚ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ<code>__block_impl</code> ç»“æ„ä½“çš„ç¬¬ä¸€ä¸ªæˆå‘˜å°±æ˜¯ <code>void *isa</code>ã€‚</p></li><li><p>block çš„åˆ›å»ºè¿‡ç¨‹å®é™…ä¸Šæ˜¯åœ¨åˆå§‹åŒ–ä¸€ä¸ª <code>__main_block_impl_XXX</code> ç»“æ„ä½“å®ä¾‹ã€‚è¿™ä¸ªç»“æ„ä½“ä¸»è¦åŒ…å«äº†ï¼š</p><ul><li><code>__block_impl</code> ç»“æ„ä½“ï¼ˆä¸»è¦åŒ…å« isa æŒ‡é’ˆå’Œå‡½æ•°æŒ‡é’ˆï¼‰ï¼›</li><li><code>__main_block_desc_0</code> ç»“æ„ä½“æŒ‡é’ˆï¼ˆä¸»è¦åŒ…å« block ç›¸å…³çš„æè¿°ä¿¡æ¯ï¼‰ã€‚</li></ul></li><li><p>block çš„æ‰§è¡Œè¿‡ç¨‹ï¼š</p><ul><li>ç³»ç»Ÿä¼šå°† block çš„ä»£ç å—ç¼–è¯‘æˆä¸€ä¸ªå…¨å±€å‡½æ•°ï¼ˆå¦‚ <code>__main_block_func_0</code>ï¼‰ï¼›</li><li>è¿™ä¸ªå…¨å±€å‡½æ•°çš„åœ°å€ä¼šè¢«ä¿å­˜åœ¨ <code>__block_impl</code> çš„ <code>FuncPtr</code> æˆå‘˜ä¸­ï¼›</li><li>å½“è°ƒç”¨ block æ—¶ï¼Œå®é™…ä¸Šæ˜¯é€šè¿‡ <code>FuncPtr</code> æ‰¾åˆ°è¿™ä¸ªå…¨å±€å‡½æ•°è°ƒç”¨ï¼Œå¹¶æŠŠ block æœ¬èº«ä½œä¸ºå‚æ•°ä¼ é€’ç»™è¿™ä¸ªå‡½æ•°ã€‚</li></ul></li></ol><h2 id="å˜é‡æ•è·æœºåˆ¶"><a href="#å˜é‡æ•è·æœºåˆ¶" class="headerlink" title="å˜é‡æ•è·æœºåˆ¶"></a>å˜é‡æ•è·æœºåˆ¶</h2><p>å½“ block æ•è·å¤–éƒ¨å˜é‡æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®æ•è·å˜é‡çš„ç±»å‹å’Œä¿®é¥°ç¬¦ï¼Œç”Ÿæˆä¸åŒçš„ block ç»“æ„ä½“ã€‚è¿™ç§è®¾è®¡ä½¿å¾— block èƒ½å¤Ÿæ­£ç¡®åœ°ç®¡ç†ä¸åŒç±»å‹å˜é‡çš„å†…å­˜å’Œç”Ÿå‘½å‘¨æœŸã€‚ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç§æ•è·æƒ…å†µï¼š</p><ol><li>æ•è·å…¨å±€å˜é‡ï¼›</li><li>æ•è·å±€éƒ¨å˜é‡(åˆ†ä¸ºåŸºæœ¬ç±»å‹å’Œå¯¹è±¡ç±»å‹)ï¼›</li><li>æ•è·é™æ€å˜é‡ã€‚</li></ol><p>å¦å¤–è¿˜æœ‰å…³äºæ•è· __block ä¿®é¥°çš„å˜é‡ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¼šåœ¨åé¢çš„ <a href="#block-%E4%BF%AE%E9%A5%B0%E7%AC%A6%E8%AF%A6%E8%A7%A3">__block ä¿®é¥°ç¬¦è¯¦è§£</a> ç« èŠ‚è¯¦ç»†è®¨è®ºã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> global_age = <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> age = <span class="number">10</span>;</span><br><span class="line">  <span class="type">static</span> <span class="type">int</span> static_age = <span class="number">20</span>;</span><br><span class="line">  Person *per = [[Person alloc] init];</span><br><span class="line">  <span class="function">__weak <span class="title">typeof</span><span class="params">(per)</span> weakPer </span>= per;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">void</span> (^block)(<span class="type">void</span>) = ^&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;block: %p, %p, %d, %d, %d\n&quot;</span>, per, weakPer, age, static_age, global_age);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="built_in">block</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç å±•ç¤ºäº† block æ•è·å¤–éƒ¨å˜é‡çš„å‡ ç§å…¸å‹åœºæ™¯ï¼šå…¨å±€å˜é‡ï¼ˆglobal_ageï¼‰ã€å±€éƒ¨åŸºæœ¬ç±»å‹å˜é‡ï¼ˆageï¼‰ã€å±€éƒ¨å¯¹è±¡ç±»å‹å˜é‡ï¼ˆper å’Œ weakPerï¼‰ä»¥åŠé™æ€å˜é‡ï¼ˆstatic_ageï¼‰ã€‚é€šè¿‡åˆ†æè¿™äº›ä¸åŒåœºæ™¯ä¸‹çš„ block å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å…¨é¢åœ°ç†è§£ block çš„å˜é‡æ•è·æœºåˆ¶ã€‚ä¸‹é¢è®©æˆ‘ä»¬é€šè¿‡è½¬æ¢åçš„ C++ ä»£ç æ¥æ·±å…¥åˆ†æå…¶åº•å±‚å®ç°ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// block çš„ç»“æ„ä½“ã€‚</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">__main_block_impl_0</span> &#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">__block_impl</span> impl;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">__main_block_desc_0</span>* Desc;</span><br><span class="line">  Person *__strong per;</span><br><span class="line">  Person *__weak weakPer;</span><br><span class="line">  <span class="type">int</span> age;</span><br><span class="line">  <span class="type">int</span> *static_age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// block çš„æ‰§è¡Œä½“ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line">    Person *__strong per = __cself-&gt;per;</span><br><span class="line">    Person *__weak weakPer = __cself-&gt;weakPer;</span><br><span class="line">    <span class="type">int</span> age = __cself-&gt;age;</span><br><span class="line">    <span class="type">int</span> *static_age = __cself-&gt;static_age;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;block: %p, %p, %d, %d, %d\n&quot;</span>, per, weakPer, age, *static_age, global_age);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“ block è¢«æ‹·è´åˆ°å †ä¸Šæ—¶ï¼Œä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°å¯¹æ•è·çš„å¯¹è±¡å˜é‡è¿›è¡Œå†…å­˜ç®¡ç†ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __main_block_copy_0(<span class="keyword">struct</span> __main_block_impl_0*dst, <span class="keyword">struct</span> __main_block_impl_0*src) &#123;</span><br><span class="line">    _block_object_assign((<span class="type">void</span>*)&amp;dst-&gt;per, (<span class="type">void</span>*)src-&gt;per, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“ block é‡Šæ”¾æ—¶ï¼Œä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°å¯¹æ•è·çš„å¯¹è±¡å˜é‡è¿›è¡Œé‡Šæ”¾ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __main_block_dispose_0(<span class="keyword">struct</span> __main_block_impl_0*src) &#123;</span><br><span class="line">    _block_object_dispose((<span class="type">void</span>*)src-&gt;per, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// block çš„æè¿°ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">__main_block_desc_0</span> &#123;</span><br><span class="line">  <span class="type">size_t</span> reserved;</span><br><span class="line">  <span class="type">size_t</span> block_size;</span><br><span class="line">  <span class="built_in">void</span> (*copy)(<span class="keyword">struct</span> __main_block_impl_0*, <span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">  <span class="built_in">void</span> (*dispose)(<span class="keyword">struct</span> __main_block_impl_0*);</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="built_in">sizeof</span>(<span class="keyword">struct</span> __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ­¤å¤„çœç•¥äº† ageã€perã€weakPerã€static_age çš„åˆå§‹åŒ–ä»£ç ã€‚</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">void</span> (*block)(<span class="type">void</span>) = &amp;__main_block_impl_0(__main_block_func_0, </span><br><span class="line">                                            &amp;__main_block_desc_0_DATA, </span><br><span class="line">                                            per, weakPer, age, </span><br><span class="line">                                            &amp;static_age, <span class="number">570425344</span>);</span><br><span class="line">  block-&gt;<span class="built_in">FuncPtr</span>(block);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡åˆ†æè½¬æ¢åçš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ° block æ•è·å˜é‡çš„æœ¬è´¨ï¼šblock ä¼šå°†æ•è·çš„å˜é‡ä½œä¸ºæˆå‘˜å˜é‡å­˜å‚¨åœ¨å…¶ç»“æ„ä½“ä¸­ã€‚æ ¹æ®å˜é‡çš„ä½œç”¨åŸŸå’Œç±»å‹ï¼Œblock çš„æ•è·æœºåˆ¶å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p><ol><li><p>å±€éƒ¨å˜é‡ï¼šblock ä¼šå°†å±€éƒ¨å˜é‡ä½œä¸ºåˆå§‹åŒ–å‚æ•°ä¼ å…¥ï¼Œå¹¶ä½œä¸ºæˆå‘˜å˜é‡å­˜å‚¨åœ¨ç»“æ„ä½“ä¸­ã€‚è¿™ç§æ•è·æ–¹å¼å¯¹åŸºæœ¬ç±»å‹å’Œå¯¹è±¡ç±»å‹éƒ½é€‚ç”¨ï¼Œå¦å¤–ï¼Œå¦‚æœæ•è·äº†å¯¹è±¡ç±»å‹ï¼Œè¿˜ä¼šä¿ç•™å…¶å†…å­˜ä¿®é¥°ç¬¦ï¼ˆå¦‚ __strongã€__weakï¼‰ã€‚</p></li><li><p>å…¨å±€å˜é‡ï¼šç”±äºå…¨å±€å˜é‡åœ¨æ•´ä¸ªç¨‹åºç”Ÿå‘½å‘¨æœŸå†…éƒ½å­˜åœ¨ï¼Œblock ä¸ä¼šå¯¹å…¶è¿›è¡Œæ•è·ï¼Œè€Œæ˜¯åœ¨å†…éƒ¨ç›´æ¥è®¿é—®ã€‚</p></li><li><p>é™æ€å˜é‡ï¼šblock ä¼šæ•è·å±€éƒ¨ static å˜é‡çš„æŒ‡é’ˆè€Œä¸æ˜¯å˜é‡çš„å€¼ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ç»“æ„ä½“ä¸­ã€‚è¿™æ ·è®¾è®¡ä½¿å¾— block å¯ä»¥è®¿é—®å’Œä¿®æ”¹é™æ€å˜é‡çš„å€¼ã€‚</p></li></ol><p>å…³äº block çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œä¸»è¦æ¶‰åŠä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼š</p><ol><li><p>å¯¹è±¡å˜é‡çš„æ•è·ç®¡ç†ï¼šåœ¨ ARC ç¯å¢ƒä¸‹ï¼Œå½“ block æ•è·äº†å¯¹è±¡ç±»å‹çš„å˜é‡æ—¶ï¼Œç³»ç»Ÿä¼šè°ƒç”¨ <code>__main_block_copy_XXX</code> å‡½æ•°è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œç¡®ä¿å¯¹è±¡åœ¨ block æ‰§è¡ŒæœŸé—´ä¸ä¼šè¢«é‡Šæ”¾ã€‚</p></li><li><p>å¯¹è±¡å˜é‡çš„é‡Šæ”¾ç®¡ç†ï¼šå½“ block è¢«é‡Šæ”¾æ—¶ï¼Œç³»ç»Ÿä¼šè°ƒç”¨ <code>__main_block_dispose_XXX</code> å‡½æ•°ï¼Œå¯¹æ•è·çš„å¯¹è±¡å˜é‡è¿›è¡Œé€‚å½“çš„é‡Šæ”¾æ“ä½œï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚</p></li><li><p>block åœ¨æ•è·å¯¹è±¡ç±»å‹å˜é‡æ—¶ï¼Œä¼šåŒæ—¶æ•è·å…¶å†…å­˜ä¿®é¥°ç¬¦ï¼ˆå¦‚ __strongã€__weakï¼‰ã€‚ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œper å’Œ weakPer åœ¨ç»“æ„ä½“ä¸­è¢«åˆ†åˆ«å£°æ˜ä¸º __strong å’Œ __weak ç±»å‹ã€‚è¿™ç§è®¾è®¡ä½¿å¾— block èƒ½å¤Ÿæ­£ç¡®å¤„ç†å¯¹è±¡çš„å†…å­˜ç®¡ç†ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨ block å†…éƒ¨ä½¿ç”¨ weak å¼•ç”¨å¯ä»¥æœ‰æ•ˆé¿å…å¾ªç¯å¼•ç”¨çš„æ ¹æœ¬åŸå› ã€‚</p></li></ol><h2 id="block-ä¿®é¥°ç¬¦è¯¦è§£"><a href="#block-ä¿®é¥°ç¬¦è¯¦è§£" class="headerlink" title="__block ä¿®é¥°ç¬¦è¯¦è§£"></a>__block ä¿®é¥°ç¬¦è¯¦è§£</h2><p>åœ¨ block ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹æ•è·çš„å˜é‡æ˜¯åªè¯»çš„ï¼Œæ— æ³•åœ¨ block å†…éƒ¨ä¿®æ”¹ã€‚è¿™æ˜¯å› ä¸º block åœ¨æ•è·å˜é‡æ—¶ï¼Œå®é™…ä¸Šæ˜¯å°†å˜é‡çš„å€¼å¤åˆ¶åˆ°è‡ªå·±çš„ç»“æ„ä½“ä¸­ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦åœ¨ block å†…éƒ¨ä¿®æ”¹æ•è·çš„å˜é‡ï¼Œå¹¶åœ¨ block æ‰§è¡Œåä¿æŒè¿™äº›ä¿®æ”¹ï¼Œå°±éœ€è¦ä½¿ç”¨ __block ä¿®é¥°ç¬¦ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">  __block <span class="type">int</span> age = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">void</span> (^block)(<span class="type">void</span>) = ^&#123;</span><br><span class="line">    age = <span class="number">20</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">block</span>();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;age: %d&quot;</span>, age);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ clang ç¼–è¯‘å™¨å°†ä¸Šè¿°ä»£ç è½¬æ¢ä¸º C++ ä»£ç åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° __block ä¿®é¥°ç¬¦çš„åº•å±‚å®ç°ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// __block ä¿®é¥°ç¬¦çš„ç»“æ„ä½“ã€‚</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">__block_byref_age_0</span> &#123;</span><br><span class="line">  <span class="type">void</span> *__isa;</span><br><span class="line">  __block_byref_age_0 *__forwarding;</span><br><span class="line">  <span class="type">int</span> __flags;</span><br><span class="line">  <span class="type">int</span> __size;</span><br><span class="line">  <span class="type">int</span> age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// block çš„æ‰§è¡Œä½“ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __main_block_func_0(<span class="keyword">struct</span> __main_block_impl_0 *__cself) &#123;</span><br><span class="line">    __block_byref_age_0 *age = __cself-&gt;age;</span><br><span class="line">    age-&gt;__forwarding-&gt;age = <span class="number">20</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ç­‰ä»·äº __block int age = 10;</span></span><br><span class="line">  __block_byref_age_0 age = &#123;</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    &amp;age,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="built_in">sizeof</span>(__block_byref_age_0),</span><br><span class="line">    <span class="number">20</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">void</span> (*block)(<span class="type">void</span>) = &amp;__main_block_impl_0(__main_block_func_0,</span><br><span class="line">                                            &amp;__main_block_desc_0_DATA,</span><br><span class="line">                                            &amp;age,</span><br><span class="line">                                            <span class="number">570425344</span>);</span><br><span class="line"></span><br><span class="line">  block-&gt;<span class="built_in">FuncPtr</span>(block);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;age: %d&quot;</span>, age.__forwarding-&gt;age);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡åˆ†æ clang è½¬æ¢åçš„ C++ ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥æ·±å…¥ç†è§£ __block ä¿®é¥°ç¬¦çš„åº•å±‚å®ç°æœºåˆ¶ï¼š</p><ol><li><p>__block ä¿®é¥°ç¬¦çš„æœ¬è´¨æ˜¯å°†å˜é‡åŒ…è£…æˆä¸€ä¸ªç»“æ„ä½“å¯¹è±¡ï¼ˆ__block_byref_xxxï¼‰ï¼Œè¿™ä¸ªç»“æ„ä½“åŒ…å«äº†å˜é‡çš„å€¼ã€__forwarding æŒ‡é’ˆç­‰å…ƒæ•°æ®ã€‚</p></li><li><p>å½“ block æ•è· __block å˜é‡æ—¶ï¼Œå®é™…ä¸Šæ•è·çš„æ˜¯è¿™ä¸ªç»“æ„ä½“å¯¹è±¡çš„æŒ‡é’ˆã€‚è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯ï¼š</p><ul><li>é€šè¿‡æŒ‡é’ˆè®¿é—®ï¼Œblock å¯ä»¥ä¿®æ”¹åŸå§‹å˜é‡çš„å€¼</li><li>__forwarding æŒ‡é’ˆçš„å­˜åœ¨ï¼Œä½¿å¾—å˜é‡åœ¨ block è¢«æ‹·è´åˆ°å †ä¸Šæ—¶ä»èƒ½æ­£ç¡®è®¿é—®</li><li>å®ç°äº†å˜é‡çš„å¯ä¿®æ”¹æ€§å’Œæ•°æ®åŒæ­¥</li></ul></li><li><p>è¿™ç§å®ç°è™½ç„¶å·§å¦™ï¼Œä½†ä¹Ÿå¸¦æ¥äº†ä¸€äº›æ€§èƒ½å¼€é”€ï¼š</p><ul><li>æ¯æ¬¡è®¿é—®å˜é‡éƒ½éœ€è¦é€šè¿‡æŒ‡é’ˆé—´æ¥è®¿é—®</li><li>ç»“æ„ä½“å¯¹è±¡æœ¬èº«ä¼šå ç”¨é¢å¤–çš„å†…å­˜ç©ºé—´</li><li>åœ¨é¢‘ç¹è®¿é—®çš„åœºæ™¯ä¸‹å¯èƒ½ä¼šå½±å“æ€§èƒ½</li></ul></li></ol><p>å› æ­¤ï¼Œåœ¨ä½¿ç”¨ __block ä¿®é¥°ç¬¦æ—¶ï¼Œéœ€è¦æƒè¡¡å…¶å¸¦æ¥çš„ä¾¿åˆ©æ€§å’Œæ€§èƒ½å¼€é”€ã€‚å¯¹äºç®€å•çš„åœºæ™¯ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æŒ‡é’ˆæˆ–å…¶ä»–æ›¿ä»£æ–¹æ¡ˆã€‚</p><p>ä¸‹é¢è¿™æ®µä»£ç å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨æŒ‡é’ˆæ¥æ›¿ä»£ __block ä¿®é¥°ç¬¦ï¼Œå®ç° block å†…éƒ¨ä¿®æ”¹å¤–éƒ¨å˜é‡çš„åŠŸèƒ½ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> age = <span class="number">10</span>;</span><br><span class="line">  <span class="type">int</span> *pointer_age = &amp;age;</span><br><span class="line">  <span class="built_in">void</span> (^block)(<span class="type">void</span>) = ^&#123;</span><br><span class="line">     *pointer_age = <span class="number">20</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="built_in">block</span>();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;age: %d\n&quot;</span>, age);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="block-çš„ä¸‰ç§ç±»å‹"><a href="#block-çš„ä¸‰ç§ç±»å‹" class="headerlink" title="block çš„ä¸‰ç§ç±»å‹"></a>block çš„ä¸‰ç§ç±»å‹</h2><p>ä» <a href="https://github.com/apple-oss-distributions/libclosure/tree/main">libclosure</a> åº“çš„æºç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° block åœ¨åº•å±‚å®ç°ä¸­å®šä¹‰äº† 6 ç§ç±»å‹ï¼š_NSConcreteStackblockã€_NSConcreteMallocblockã€_NSConcreteAutoblockã€_NSConcreteFinalizingblockã€_NSConcreteGlobalblock å’Œ _NSConcreteWeakblockVariableã€‚</p><p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬æœ€å¸¸é‡åˆ°çš„æ˜¯ä»¥ä¸‹ä¸‰ç§ç±»å‹ï¼š</p><ul><li><p>_NSConcreteGlobalblockï¼ˆå…¨å±€ blockï¼‰ï¼šè¿™ç§ç±»å‹çš„ block å­˜å‚¨åœ¨æ•°æ®åŒºï¼ˆ.data æ®µï¼‰ï¼Œç‰¹ç‚¹æ˜¯æœªæ•è·ä»»ä½•å¤–éƒ¨å˜é‡ã€‚ç”±äºä¸éœ€è¦ä¿å­˜ä¸Šä¸‹æ–‡ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¸ç¨‹åºç›¸åŒï¼Œæ˜¯æœ€è½»é‡çº§çš„ block ç±»å‹ã€‚</p></li><li><p>_NSConcreteStackblockï¼ˆæ ˆ blockï¼‰ï¼šè¿™ç§ç±»å‹çš„ block å­˜å‚¨åœ¨æ ˆåŒºï¼Œåœ¨ ARC ç¯å¢ƒä¸‹æˆ‘ä»¬å¾ˆå°‘ç›´æ¥é‡åˆ°è¿™ç§ç±»å‹ã€‚è¿™æ˜¯å› ä¸º ARC ä¼šè‡ªåŠ¨å°†è¢«å¼ºå¼•ç”¨çš„ block ä»æ ˆä¸Šæ‹·è´åˆ°å †ä¸Šã€‚</p></li><li><p>_NSConcreteMallocblockï¼ˆå † blockï¼‰ï¼šè¿™ç§ç±»å‹çš„ block å­˜å‚¨åœ¨å †åŒºï¼Œæ˜¯æˆ‘ä»¬åœ¨ ARC ç¯å¢ƒä¸‹æœ€å¸¸è§åˆ°çš„ block ç±»å‹ã€‚å½“ block æ•è·äº†å¯¹è±¡å˜é‡æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†å…¶æ‹·è´åˆ°å †ä¸Šï¼Œå¹¶è°ƒç”¨ <code>__main_block_copy_XXX</code> å’Œ <code>__main_block_dispose_XXX</code> å‡½æ•°æ¥ç®¡ç†æ•è·çš„å¯¹è±¡å˜é‡çš„å†…å­˜ç”Ÿå‘½å‘¨æœŸã€‚</p></li></ul><h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><p>åœ¨ä½¿ç”¨ block æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ä¸ªå…³é”®ç‚¹ï¼š</p><ol><li><p><strong>å†…å­˜ç®¡ç†</strong></p><p> åœ¨ ARC ç¯å¢ƒä¸‹ï¼Œblock ä¼šè‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Œä½†å¯¹äºæ•è·çš„å¯¹è±¡ç±»å‹ï¼Œblock ä¼šå¼ºå¼•ç”¨è¯¥å¯¹è±¡ï¼Œæ­¤æ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚å¯æƒœä½¿ç”¨ weak å¼•ç”¨æ¥é¿å…å¾ªç¯å¼•ç”¨ã€‚</p></li><li><p><strong>å˜é‡æ•è·æœºåˆ¶</strong></p><p> block é»˜è®¤é‡‡ç”¨å€¼æ•è·æ–¹å¼ï¼Œä¼šå¤åˆ¶å¤–éƒ¨å˜é‡çš„å€¼åˆ° block å†…éƒ¨ã€‚å¦‚æœä½ éœ€è¦ä¿®æ”¹å¤–éƒ¨çš„å˜é‡å€¼ï¼Œå¯ä»¥ä½¿ç”¨ __block ä¿®é¥°ç¬¦ã€‚ä½†ä½¿ç”¨ __block ä¿®é¥°ç¬¦ä¼šå¸¦æ¥é¢å¤–çš„å†…å­˜å¼€é”€ï¼Œåœ¨æ€§èƒ½æ•æ„Ÿåœºæ™¯ä¸‹ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æŒ‡é’ˆæ›¿ä»£ __block ä¿®é¥°ç¬¦ã€‚</p></li><li><p><strong>çº¿ç¨‹å®‰å…¨</strong></p><p> block æœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†éœ€è¦æ³¨æ„åœ¨å¤šä¸ªçº¿ç¨‹çš„ block ä¸­åŒæ—¶è®¿é—®å…±äº«èµ„æºæ—¶å¯èƒ½å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚å»ºè®®ä½¿ç”¨é€‚å½“çš„åŒæ­¥æœºåˆ¶ï¼ˆå¦‚ dispatch_syncã€é”ç­‰ï¼‰ã€‚</p></li><li><p><strong>ä½¿ç”¨å»ºè®®</strong></p><ul><li>ä¼˜å…ˆä½¿ç”¨æ™®é€šå˜é‡è€Œä¸æ˜¯ __blockï¼Œé™¤éç¡®å®éœ€è¦ä¿®æ”¹å˜é‡å€¼</li><li>å¯¹äºç®€å•çš„å›è°ƒåœºæ™¯ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ delegate æ¨¡å¼ä»£æ›¿ block</li><li>åœ¨å¼‚æ­¥æ“ä½œä¸­ï¼Œæ³¨æ„å¤„ç† block çš„è°ƒç”¨æ—¶æœºå’Œå†…å­˜ç®¡ç†</li></ul></li></ol><p>é€šè¿‡åˆç†ä½¿ç”¨è¿™äº›ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å……åˆ†å‘æŒ¥ block çš„ä¼˜åŠ¿ï¼ŒåŒæ—¶é¿å…å¸¸è§çš„å†…å­˜å’Œæ€§èƒ½é—®é¢˜ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é€šè¿‡åˆ†æ clang è½¬æ¢åçš„ C++ ä»£ç å’Œ <a href="https://github.com/apple-oss-distributions/libclosure/tree/main">libclosure</a> æºç ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ° block çš„æœ¬è´¨ï¼šå®ƒæ˜¯ä¸€ä¸ªå°è£…äº†å‡½æ•°æ‰§è¡Œé€»è¾‘å’Œä¸Šä¸‹æ–‡ç¯å¢ƒçš„ ObjC å¯¹è±¡ã€‚</p><p>åœ¨ç¼–è¯‘é˜¶æ®µï¼Œç¼–è¯‘å™¨ä¼šè¿›è¡Œä»¥ä¸‹è½¬æ¢ï¼š</p><ol><li>å°† block çš„ä»£ç å—ç¼–è¯‘æˆä¸€ä¸ªå…¨å±€å‡½æ•°ã€‚</li><li>åˆ›å»ºä¸€ä¸ª block å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸»è¦åŒ…å«ï¼š<ul><li>æŒ‡å‘å…¨å±€å‡½æ•°çš„å‡½æ•°æŒ‡é’ˆ</li><li>block çš„æè¿°ä¿¡æ¯ï¼ˆå¦‚ç±»å‹ã€å¤§å°ç­‰ï¼‰</li><li>æ•è·çš„å¤–éƒ¨å˜é‡</li></ul></li></ol><p>å½“ block è¢«è°ƒç”¨æ—¶ï¼Œç³»ç»Ÿä¼šï¼š</p><ol><li>é€šè¿‡ block å¯¹è±¡è·å–å†…éƒ¨å‡½æ•°æŒ‡é’ˆ</li><li>å°† block å¯¹è±¡æœ¬èº«ä½œä¸ºå‚æ•°ä¼ é€’ç»™è¯¥å‡½æ•°</li><li>å‡½æ•°å†…éƒ¨å¯ä»¥é€šè¿‡ block å¯¹è±¡è®¿é—®å’Œä¿®æ”¹æ•è·çš„å˜é‡</li></ol><p>è¿™ç§è®¾è®¡éå¸¸å·§å¦™ï¼Œä½¿å¾— block æ—¢èƒ½åƒæ™®é€šå¯¹è±¡ä¸€æ ·è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œåˆèƒ½åƒå‡½æ•°ä¸€æ ·è¢«è°ƒç”¨ï¼ŒåŒæ—¶è¿˜èƒ½æ•è·å¤–éƒ¨å˜é‡ã€‚è¿™ç§å¤šé¢æ€§ä½¿å¾— block æˆä¸ºäº† iOS å¼€å‘ä¸­æœ€å¼ºå¤§çš„ç¼–ç¨‹ç‰¹æ€§ä¹‹ä¸€ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> block </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iOSåˆ†ç±»ä¸­çš„å…³è”å¯¹è±¡ï¼šå¦‚ä½•ç”¨è¿è¡Œæ—¶çªç ´Categoryçš„å­˜å‚¨é™åˆ¶</title>
      <link href="/2025/04/07/iOS/iOS%E5%88%86%E7%B1%BB%E4%B8%AD%E7%9A%84%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E7%94%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E7%AA%81%E7%A0%B4Category%E7%9A%84%E5%AD%98%E5%82%A8%E9%99%90%E5%88%B6/"/>
      <url>/2025/04/07/iOS/iOS%E5%88%86%E7%B1%BB%E4%B8%AD%E7%9A%84%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%EF%BC%9A%E5%A6%82%E4%BD%95%E7%94%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E7%AA%81%E7%A0%B4Category%E7%9A%84%E5%AD%98%E5%82%A8%E9%99%90%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç”± å¸ƒå¤š(budo) å‘å¸ƒäº 2025-04-07</p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨ iOS å¼€å‘ä¸­ï¼Œå…³è”å¯¹è±¡ï¼ˆAssociated Objectsï¼‰æ˜¯ä¸€ç§å¼ºå¤§çš„è¿è¡Œæ—¶ç‰¹æ€§ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨ Category ä¸­ä¸ºå·²æœ‰çš„ç±»åŠ¨æ€æ·»åŠ â€å±æ€§â€ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼ŒCategory çš„ä¸€ä¸ªé‡è¦é™åˆ¶æ˜¯æ— æ³•ç›´æ¥æ·»åŠ å®ä¾‹å˜é‡ï¼Œè¿™æ˜¯å› ä¸º Category æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½çš„ï¼Œè€Œç±»çš„å†…å­˜å¸ƒå±€ï¼ˆåŒ…æ‹¬å®ä¾‹å˜é‡çš„å¤§å°å’Œåç§»é‡ï¼‰å¿…é¡»åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šä¸‹æ¥ã€‚å…³è”å¯¹è±¡é€šè¿‡ Runtime æœºåˆ¶å·§å¦™åœ°ç»•è¿‡äº†è¿™ä¸€é™åˆ¶ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿåœ¨è¿è¡Œæ—¶ä¸ºå¯¹è±¡åŠ¨æ€å…³è”ä»»æ„å€¼ï¼Œä»è€Œå®ç°ç±»ä¼¼å®ä¾‹å˜é‡çš„æ•ˆæœã€‚</p><p>è™½ç„¶ç½‘ä¸Šå…³äºå¦‚ä½•ä½¿ç”¨å…³è”å¯¹è±¡çš„æ•™ç¨‹å¾ˆå¤šï¼Œä½†å¤§å¤šæ•°éƒ½åœç•™åœ¨ä½¿ç”¨å±‚é¢ï¼Œå¯¹å…¶å†…éƒ¨å®ç°åŸç†é²œæœ‰æ·±å…¥æ¢è®¨ã€‚æœ¬æ–‡å°†ä» Runtime æºç çš„è§’åº¦ï¼Œå’Œå¤§å®¶ä¸€èµ·æ·±å…¥å‰–æå…³è”å¯¹è±¡çš„åº•å±‚å®ç°åŸç†ï¼ŒåŒ…æ‹¬å…¶å†…éƒ¨æ•°æ®ç»“æ„ã€å†…å­˜ç®¡ç†æœºåˆ¶ã€çº¿ç¨‹å®‰å…¨æ€§ä»¥åŠæ€§èƒ½è€ƒé‡ç­‰å…³é”®ç»†èŠ‚ã€‚é€šè¿‡æœ¬æ–‡ï¼Œä½ å°†å…¨é¢äº†è§£å…³è”å¯¹è±¡çš„å·¥ä½œåŸç†ï¼Œä»è€Œèƒ½å¤Ÿæ›´å¥½åœ°åœ¨å®é™…å¼€å‘ä¸­è¿ç”¨è¿™ä¸€æŠ€æœ¯ã€‚ä¸ºäº†èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£æœ¬æ–‡å†…å®¹ï¼Œå»ºè®®è¯»è€…å·²ç»å¯¹å…³è”å¯¹è±¡çš„åŸºæœ¬ä½¿ç”¨æœ‰æ‰€äº†è§£ã€‚</p><h2 id="å…³è”å¯¹è±¡çš„åº•å±‚åŸç†"><a href="#å…³è”å¯¹è±¡çš„åº•å±‚åŸç†" class="headerlink" title="å…³è”å¯¹è±¡çš„åº•å±‚åŸç†"></a>å…³è”å¯¹è±¡çš„åº•å±‚åŸç†</h2><p>è¦ç†è§£å…³è”å¯¹è±¡çš„åº•å±‚åŸç†ï¼Œæˆ‘ä»¬éœ€è¦ä» Runtime æä¾›çš„ä¸‰ä¸ªæ ¸å¿ƒ API å¼€å§‹ï¼š</p><ol><li>objc_setAssociatedObject - ç”¨äºè®¾ç½®å…³è”å¯¹è±¡</li><li>objc_getAssociatedObject - ç”¨äºè·å–å…³è”å¯¹è±¡</li><li>objc_removeAssociatedObjects - ç”¨äºç§»é™¤å¯¹è±¡çš„æ‰€æœ‰å…³è”å¯¹è±¡</li></ol><p>è¿™ä¸‰ä¸ª API å…±åŒæ„æˆäº†å…³è”å¯¹è±¡æŠ€æœ¯çš„åŸºç¡€ï¼Œå®ƒä»¬åˆ†åˆ«è´Ÿè´£å…³è”å¯¹è±¡çš„åˆ›å»ºã€è®¿é—®å’Œæ¸…ç†å·¥ä½œã€‚è®©æˆ‘ä»¬å…ˆä» objc_setAssociatedObject çš„å®ç°å¼€å§‹ï¼Œæ·±å…¥äº†è§£å…³è”å¯¹è±¡æ˜¯å¦‚ä½•è¢«å­˜å‚¨å’Œç®¡ç†çš„ã€‚</p><blockquote><p>ğŸ“ æœ¬æ–‡ä½¿ç”¨çš„ Runtime ç‰ˆæœ¬æ˜¯ <a href="https://github.com/apple-oss-distributions/objc4/tree/objc4-906">objc4-906</a>ã€‚ä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œæˆ‘å¯¹ä»£ç æ ·å¼å’Œæ’ç‰ˆç•¥ä½œäº†ä¿®æ”¹ï¼Œå¹¶åˆ å‡äº†ä¸€äº›ä¸å½±å“ä¸»é€»è¾‘çš„å†—ä½™ä»£ç ã€‚</p><p>ğŸ”§ æˆ‘åœ¨ <a href="https://github.com/internetWei/ObjCRuntimes">è¿™é‡Œ</a> ç»´æŠ¤äº†ä¸€ä¸ªå¯ä»¥ç›´æ¥è¿è¡Œè°ƒè¯•çš„ Runtime é¡¹ç›®ï¼Œæ¬¢è¿å¤§å®¶ä¸‹è½½è°ƒè¯•æºç ã€‚</p></blockquote><h3 id="å¦‚ä½•æ·»åŠ å…³è”å¯¹è±¡"><a href="#å¦‚ä½•æ·»åŠ å…³è”å¯¹è±¡" class="headerlink" title="å¦‚ä½•æ·»åŠ å…³è”å¯¹è±¡"></a>å¦‚ä½•æ·»åŠ å…³è”å¯¹è±¡</h3><p>å½“æˆ‘ä»¬è°ƒç”¨ objc_setAssociatedObject å‡½æ•°æ¥è®¾ç½®å…³è”å¯¹è±¡æ—¶ï¼ŒRuntime ç³»ç»Ÿä¼šæ‰§è¡Œä¸€ç³»åˆ—å¤æ‚çš„æ“ä½œæ¥ç¡®ä¿å…³è”å¯¹è±¡è¢«æ­£ç¡®åœ°å­˜å‚¨å’Œç®¡ç†ã€‚è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ°å†…å­˜ç®¡ç†ã€çº¿ç¨‹å®‰å…¨ä»¥åŠå“ˆå¸Œè¡¨æ“ä½œç­‰å¤šä¸ªå…³é”®ç¯èŠ‚ã€‚è®©æˆ‘ä»¬é€šè¿‡åˆ†ææºç ï¼Œä¸€æ­¥æ­¥æ­å¼€å…³è”å¯¹è±¡æ·»åŠ è¿‡ç¨‹çš„ç¥ç§˜é¢çº±ã€‚ç›¸å…³æºç æ•´ç†åå¦‚ä¸‹æ‰€ç¤ºï¼ˆå¦‚æœè§‰å¾—ä»£ç å¤ªé•¿å¯ä»¥å…ˆè·³è¿‡ï¼Œåé¢ä¼šæœ‰è¯¦ç»†è§£é‡Šï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> </span></span><br><span class="line"><span class="function"><span class="title">objc_setAssociatedObject</span><span class="params">(id object, <span class="type">void</span> *key, id value, objc_AssociationPolicy policy)</span> </span>&#123;</span><br><span class="line">    _object_set_associative_reference(object, key, value, policy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line">_object_set_associative_reference(id object, <span class="type">void</span> *key, id value, <span class="type">uintptr_t</span> policy) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     å°† object å¯¹è±¡åŒ…è£…æˆ DisguisedPtrï¼Œ</span></span><br><span class="line"><span class="comment">     è¿™ä¹ˆåšæœ‰å¦‚ä¸‹ç›®çš„ï¼š</span></span><br><span class="line"><span class="comment">     1. é¿å…è¢« ARC é”™è¯¯å¤„ç†ï¼›</span></span><br><span class="line"><span class="comment">     2. åŸç”ŸæŒ‡é’ˆå€¼çš„å“ˆå¸Œåˆ†å¸ƒå¯èƒ½ä¸å‡åŒ€ï¼Œå¯¼è‡´å“ˆå¸Œå†²çªç‡é«˜ï¼›</span></span><br><span class="line"><span class="comment">     3. é˜²é€†å‘åˆ†æã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DisguisedPtr&lt;objc_object&gt; disguised&#123;(objc_object *)object&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°† value å’Œ policy(å†…å­˜ç®¡ç†ç­–ç•¥) åŒ…è£…æˆä¸€ä¸ª ObjcAssociation å¯¹è±¡ã€‚</span></span><br><span class="line">    ObjcAssociation association&#123;policy, value&#125;;</span><br><span class="line"></span><br><span class="line">    association.<span class="built_in">acquireValue</span>() = &#123;</span><br><span class="line">      <span class="keyword">if</span> (_value) &#123;</span><br><span class="line">             <span class="comment">// æ ¹æ®å†…å­˜ç®¡ç†ç­–ç•¥å¯¹ value æ‰§è¡Œ retain æˆ– copy æ“ä½œã€‚</span></span><br><span class="line">             <span class="keyword">switch</span> (_policy &amp; <span class="number">0xFF</span>) &#123;</span><br><span class="line">             <span class="keyword">case</span> OBJC_ASSOCIATION_SETTER_RETAIN:</span><br><span class="line">                 _value = <span class="built_in">objc_retain</span>(_value);</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             <span class="keyword">case</span> OBJC_ASSOCIATION_SETTER_COPY:</span><br><span class="line">                 _value = ((<span class="built_in">id</span>(*)(id, SEL))objc_msgSend)(_value, @<span class="built_in">selector</span>(copy));</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> isFirstAssociation = <span class="literal">false</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// è·å–å…¨å±€é”ï¼ˆåœ¨æ„é€ å‡½æ•°ä¸­åŠ é”ï¼Œåœ¨ææ„å‡½æ•°ä¸­è§£é”ï¼Œè¿™é¡¹æŠ€æœ¯è¢«ç§°ä¸º RAIIï¼‰</span></span><br><span class="line">        AssociationsManager manager;</span><br><span class="line">        <span class="comment">// è·å–å…¨å±€å…³è”å¯¹è±¡çš„å“ˆå¸Œè¡¨ã€‚</span></span><br><span class="line">        <span class="function">AssociationsHashMap &amp;<span class="title">associations</span><span class="params">(manager.get())</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (value) &#123;<span class="comment">// è®¾ç½®å…³è”å€¼</span></span><br><span class="line">            <span class="keyword">auto</span> refs_result = associations.<span class="built_in">try_emplace</span>(disguised, ObjectAssociationMap&#123;&#125;);</span><br><span class="line">            <span class="comment">// æ ‡è®°æ˜¯å¦ä¸ºé¦–æ¬¡å…³è”</span></span><br><span class="line">            <span class="keyword">if</span> (refs_result.second) &#123;</span><br><span class="line">                isFirstAssociation = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·å– object å¯¹åº”çš„å…³è”è¡¨ï¼ˆå†…å±‚å“ˆå¸Œè¡¨ï¼‰</span></span><br><span class="line">            <span class="keyword">auto</span> &amp;refs = refs_result.first-&gt;second;</span><br><span class="line">            <span class="comment">// æ’å…¥æˆ–æ›¿æ¢ key å¯¹åº”çš„å…³è”å€¼</span></span><br><span class="line">            <span class="keyword">auto</span> result = refs.<span class="built_in">try_emplace</span>(key, std::<span class="built_in">move</span>(association));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è‹¥ key å·²å­˜åœ¨ï¼Œäº¤æ¢æ—§å€¼ç”¨äºåç»­é‡Šæ”¾</span></span><br><span class="line">            <span class="keyword">if</span> (!result.second) &#123;</span><br><span class="line">                association.<span class="built_in">swap</span>(result.first-&gt;second);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">// åˆ é™¤å…³è”å€¼</span></span><br><span class="line">            <span class="keyword">auto</span> refs_it = associations.<span class="built_in">find</span>(disguised);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ£€æŸ¥å…³è”è¡¨æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">            <span class="keyword">if</span> (refs_it != associations.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                <span class="comment">// è·å– object å¯¹åº”çš„å…³è”è¡¨ï¼ˆå†…å±‚å“ˆå¸Œè¡¨ï¼‰</span></span><br><span class="line">                <span class="keyword">auto</span> &amp;refs = refs_it-&gt;second;</span><br><span class="line">                <span class="comment">// è·å– key å¯¹åº”çš„æ•°æ®ã€‚</span></span><br><span class="line">                <span class="keyword">auto</span> it = refs.<span class="built_in">find</span>(key);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (it != refs.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                    <span class="comment">// è·å–æ—§å€¼ç”¨äºé‡Šæ”¾ã€‚</span></span><br><span class="line">                    association.<span class="built_in">swap</span>(it-&gt;second);</span><br><span class="line">                    <span class="comment">// ä»å†…éƒ¨è¡¨ä¸Šåˆ é™¤é”®å€¼å¯¹</span></span><br><span class="line">                    refs.<span class="built_in">erase</span>(it);</span><br><span class="line">                    <span class="comment">// è‹¥å†…å±‚è¡¨ä¸ºç©ºï¼Œä»å…¨å±€å…³è”è¡¨ä¸­ç§»é™¤è¿™ä¸ªå†…å±‚è¡¨ã€‚</span></span><br><span class="line">                    <span class="keyword">if</span> (refs.<span class="built_in">size</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">                        associations.<span class="built_in">erase</span>(refs_it);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="comment">// è¿™é‡Œä¼šé‡Šæ”¾å±€éƒ¨å˜é‡ managerï¼Œå¹¶æ‰§è¡Œå®ƒçš„ææ„å‡½æ•°ç„¶åé‡Šæ”¾æ‰å…¨å±€é”ã€‚</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯é¦–æ¬¡è®¾ç½®å…³è”å¯¹è±¡ï¼Œä¿®æ”¹ isa ä¸Šçš„ has_assoc å­—æ®µä¸º trueã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (isFirstAssociation) &#123;</span><br><span class="line">        object-&gt;<span class="built_in">setHasAssociatedObjects</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾æ—§å€¼</span></span><br><span class="line">    association.<span class="built_in">releaseHeldValue</span>() = &#123;</span><br><span class="line">        <span class="keyword">if</span> (_value &amp;&amp; (_policy &amp; OBJC_ASSOCIATION_SETTER_RETAIN)) &#123;</span><br><span class="line">            <span class="built_in">objc_release</span>(_value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡åˆ†æä¸Šè¿°æºç å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°å…³è”å¯¹è±¡çš„æ ¸å¿ƒå­˜å‚¨ç»“æ„ï¼Œä¸€ä¸ªç²¾å¿ƒè®¾è®¡çš„åŒå±‚å“ˆå¸Œè¡¨ç³»ç»Ÿï¼š</p><ol><li>ç¬¬ä¸€å±‚å“ˆå¸Œè¡¨(AssociationsHashMap)ï¼šä»¥å¯¹è±¡çš„å†…å­˜åœ°å€(<code>å³ self</code>)ä¸ºé”®ï¼Œæ˜ å°„åˆ°è¯¥å¯¹è±¡çš„æ‰€æœ‰å…³è”å¯¹è±¡å­˜å‚¨è¡¨ï¼›</li><li>ç¬¬äºŒå±‚å“ˆå¸Œè¡¨(ObjectAssociationMap)ï¼šä»¥ä¼ å…¥çš„keyä¸ºé”®ï¼Œå­˜å‚¨å…·ä½“çš„å…³è”å¯¹è±¡ä¿¡æ¯ã€‚</li></ol><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç³»ç»Ÿå¹¶ä¸æ˜¯ç›´æ¥å­˜å‚¨ä¼ å…¥çš„ value å¯¹è±¡ï¼Œè€Œæ˜¯å°†å…¶å°è£…åœ¨ä¸€ ä¸ªObjcAssociation ç±»å‹ä¸­ã€‚è¿™ä¸ªç»“æ„ä½“åŒ…å«ä¸¤ä¸ªå…³é”®ä¿¡æ¯ï¼š</p><ul><li>value: å®é™…å­˜å‚¨çš„å…³è”å¯¹è±¡ï¼›</li><li>policy: å†…å­˜ç®¡ç†ç­–ç•¥(å¦‚retainã€copyç­‰)ã€‚</li></ul><p>è¿™ç§è®¾è®¡æ—¢ä¿è¯äº†å…³è”å¯¹è±¡çš„å¿«é€Ÿå­˜å–ï¼Œåˆå®ç°äº†çµæ´»çš„å†…å­˜ç®¡ç†ã€‚</p><p>æˆ‘ç»˜åˆ¶äº†ä¸€å¼ ç»“æ„ç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="structure.png"></p><p>è®©æˆ‘ä»¬ä»¥ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥è¯´æ˜è¿™ä¸ªå­˜å‚¨ç»“æ„ï¼š</p><p>ä»¥ <code>objc_setAssociatedObject(self, @selector(name), @&quot;budo&quot;, OBJC_ASSOCIATION_COPY_NONATOMIC)</code> è¿™è¡Œä»£ç ä¸ºä¾‹ã€‚</p><ul><li>ç¬¬ä¸€ä¸ªå‚æ•° <code>self</code> å¯¹åº”ç¬¬ä¸€å±‚å“ˆå¸Œè¡¨(AssociationsHashMap)çš„é”®ï¼›</li><li>ç¬¬äºŒä¸ªå‚æ•° <code>@selector(name)</code> å¯¹åº”ç¬¬äºŒå±‚å“ˆå¸Œè¡¨(ObjectAssociationMap)çš„é”®ï¼›</li><li>ç¬¬ä¸‰ä¸ªå‚æ•° <code>@&quot;budo&quot;</code> å’Œç¬¬å››ä¸ªå‚æ•° <code>OBJC_ASSOCIATION_COPY_NONATOMIC</code> åˆ™è¢«åŒ…è£…æˆä¸€ä¸ª ObjcAssociation å¯¹è±¡ã€‚</li></ul><p>å¦å¤–ï¼Œå…³äºå†…å­˜ç®¡ç†ä¿®é¥°ç¬¦çš„ä¸€ä¸ªé‡è¦å‘ç°ï¼šOBJC_ASSOCIATION_RETAIN_NONATOMIC å’Œ OBJC_ASSOCIATION_RETAIN åœ¨å®é™…è¿è¡Œæ—¶çš„è¡Œä¸ºæ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œä»ä¸Šé¢çš„æºç ä¸­ä¹Ÿå¯ä»¥å‘ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘å†™äº†ä¸€ä¸ªæµ‹è¯•ï¼Œä»£ç åœ¨ <a href="https://github.com/internetWei/OmniTest/blob/main/%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1NONATOMIC%E7%9A%84%E4%BD%9C%E7%94%A8/ViewController.m">è¿™é‡Œ</a>ï¼Œç»“æœæ˜¾ç¤º OBJC_ASSOCIATION_RETAIN_NONATOMIC å’Œ OBJC_ASSOCIATION_RETAIN åœ¨å®é™…è¿è¡Œæ—¶çš„è¡Œä¸ºæ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚è¿™æ˜¯å› ä¸ºå…³è”å¯¹è±¡çš„æ‰€æœ‰æ“ä½œéƒ½ä¼šè·å–å…¨å±€é”æ¥ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œæ‰€ä»¥æ— è®ºæ˜¯å¦æŒ‡å®š NONATOMICï¼Œéƒ½ä¼šå¾—åˆ°ç›¸åŒçº§åˆ«çš„åŒæ­¥ä¿æŠ¤ã€‚è¿™ä¸€ç‚¹ä¸å±æ€§ä¿®é¥°ç¬¦ atomic&#x2F;nonatomic çš„è¡Œä¸ºæœ‰æ‰€ä¸åŒã€‚</p><h3 id="å¦‚ä½•è·å–å…³è”å¯¹è±¡"><a href="#å¦‚ä½•è·å–å…³è”å¯¹è±¡" class="headerlink" title="å¦‚ä½•è·å–å…³è”å¯¹è±¡"></a>å¦‚ä½•è·å–å…³è”å¯¹è±¡</h3><p>è·å–å…³è”å¯¹è±¡çš„å€¼ï¼Œæ˜¯é€šè¿‡ <code>objc_getAssociatedObject</code> å‡½æ•°å®ç°çš„ã€‚è¿™ä¸ªå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨ <code>_object_get_associative_reference</code> æ¥å®Œæˆå®é™…çš„è·å–æ“ä½œã€‚æ•´ä¸ªè¿‡ç¨‹ä¹Ÿæ˜¯å›´ç»•ç€åŒå±‚å“ˆå¸Œè¡¨è¿›è¡Œï¼Œç›¸å…³çš„æºç æ•´ç†åå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">id <span class="title">objc_getAssociatedObject</span><span class="params">(id object, <span class="type">const</span> <span class="type">void</span> *key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _object_get_associative_reference(object, key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">id</span><br><span class="line">_object_get_associative_reference(id object, <span class="type">const</span> <span class="type">void</span> *key) &#123;</span><br><span class="line">    ObjcAssociation association&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// è·å–å…¨å±€é”ï¼ˆåœ¨æ„é€ å‡½æ•°ä¸­åŠ é”ï¼Œåœ¨ææ„å‡½æ•°ä¸­è§£é”ï¼‰</span></span><br><span class="line">        AssociationsManager manager;</span><br><span class="line">        <span class="comment">// è·å–å…¨å±€å…³è”å¯¹è±¡å“ˆå¸Œè¡¨</span></span><br><span class="line">        <span class="function">AssociationsHashMap &amp;<span class="title">associations</span><span class="params">(manager.get())</span></span>;</span><br><span class="line">        <span class="comment">// è·å– object å¯¹åº”çš„å…³è”è¡¨ï¼ˆå†…å±‚å“ˆå¸Œè¡¨ï¼‰</span></span><br><span class="line">        AssociationsHashMap::iterator i = associations.<span class="built_in">find</span>((objc_object *)object);</span><br><span class="line">        <span class="comment">// åˆ¤æ–­å†…å±‚è¡¨æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> (i != associations.<span class="built_in">end</span>()) &#123;</span><br><span class="line">            ObjectAssociationMap &amp;refs = i-&gt;second;</span><br><span class="line">            <span class="comment">// é€šè¿‡ key æ‰¾åˆ°å¯¹åº”æ•°æ®ã€‚</span></span><br><span class="line">            ObjectAssociationMap::iterator j = refs.<span class="built_in">find</span>(key);</span><br><span class="line">            <span class="keyword">if</span> (j != refs.<span class="built_in">end</span>()) &#123;</span><br><span class="line">                association = j-&gt;second;</span><br><span class="line">                <span class="comment">// è·å–å¯¹è±¡å¹¶æ‰§è¡Œ retain æ“ä½œã€‚</span></span><br><span class="line">                association.<span class="built_in">retainReturnedValue</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="comment">// è¿™é‡Œä¼šæ‰§è¡Œ manager çš„ææ„å‡½æ•°å¹¶é‡Šæ”¾å…¨å±€é”ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†å¯¹è±¡åŠ å…¥è‡ªåŠ¨é‡Šæ”¾æ± å¹¶è¿”å›ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> association.<span class="built_in">autoreleaseReturnedValue</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä»¥ä¸Šä»£ç å¯ä»¥çœ‹å‡ºï¼Œè·å–å…³è”å¯¹è±¡çš„è¿‡ç¨‹ç›¸å¯¹ç®€å•ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li>é¦–å…ˆè·å–å…¨å±€é”ä»¥ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼›</li><li>é€šè¿‡ object ä½œä¸ºé”®åœ¨ç¬¬ä¸€å±‚å“ˆå¸Œè¡¨(AssociationsHashMap)ä¸­æŸ¥æ‰¾å¯¹åº”çš„å†…å±‚å“ˆå¸Œè¡¨ï¼›</li><li>å¦‚æœæ‰¾åˆ°å†…å±‚è¡¨ï¼Œåˆ™ä½¿ç”¨ key ä½œä¸ºé”®åœ¨ç¬¬äºŒå±‚å“ˆå¸Œè¡¨(ObjectAssociationMap)ä¸­æŸ¥æ‰¾ ObjcAssociation å¯¹è±¡ï¼›</li><li>å¦‚æœæ‰¾åˆ° ObjcAssociation å¯¹è±¡ï¼Œåˆ™æ ¹æ®å…¶å†…å­˜ç®¡ç†ç­–ç•¥å¯¹ value æ‰§è¡Œ retain æ“ä½œï¼›</li><li>æœ€åå°† value åŠ å…¥è‡ªåŠ¨é‡Šæ”¾æ± å¹¶è¿”å›ã€‚</li></ol><p>æ•´ä¸ªè¿‡ç¨‹ä¸­çš„å…³é”®æ˜¯åŒå±‚å“ˆå¸Œè¡¨çš„è®¾è®¡ï¼Œè¿™ç§è®¾è®¡è®©æˆ‘ä»¬èƒ½å¤Ÿé«˜æ•ˆåœ°é€šè¿‡å¯¹è±¡å’Œé”®çš„ç»„åˆæ¥å­˜å–å…³è”å€¼ã€‚åŒæ—¶ï¼Œé€šè¿‡ RAII æŠ€æœ¯å’Œè‡ªåŠ¨é‡Šæ”¾æ± çš„ä½¿ç”¨ï¼Œä¿è¯äº†å†…å­˜ç®¡ç†çš„å®‰å…¨æ€§ã€‚</p><h3 id="å¦‚ä½•ç§»é™¤æ‰€æœ‰å…³è”å¯¹è±¡"><a href="#å¦‚ä½•ç§»é™¤æ‰€æœ‰å…³è”å¯¹è±¡" class="headerlink" title="å¦‚ä½•ç§»é™¤æ‰€æœ‰å…³è”å¯¹è±¡"></a>å¦‚ä½•ç§»é™¤æ‰€æœ‰å…³è”å¯¹è±¡</h3><p>å…³è”å¯¹è±¡çš„ç§»é™¤æœ‰ä¸¤ç§æ–¹å¼ï¼šç§»é™¤å•ä¸ªå…³è”å€¼å’Œç§»é™¤æ‰€æœ‰å…³è”å€¼ã€‚</p><p>å¯¹äºå•ä¸ªå…³è”å€¼çš„ç§»é™¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨ <code>objc_setAssociatedObject</code> å‡½æ•°å¹¶å°† value å‚æ•°è®¾ç½®ä¸º nil æ¥å®ç°ã€‚è¿™ç§æ–¹å¼å®é™…ä¸Šæ˜¯å¤ç”¨äº†å…³è”å¯¹è±¡çš„è®¾ç½®é€»è¾‘ï¼Œå½“ value ä¸º nil æ—¶ï¼ŒRuntime ç³»ç»Ÿä¼šè‡ªåŠ¨æ¸…ç†å¯¹åº”çš„å…³è”å€¼ã€‚å…·ä½“çš„å®ç°ç»†èŠ‚å¯ä»¥å‚è€ƒä¸Šé¢çš„ç« èŠ‚ï¼š<a href="#%E5%A6%82%E4%BD%95%E6%B7%BB%E5%8A%A0%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1">å¦‚ä½•æ·»åŠ å…³è”å¯¹è±¡</a>ã€‚</p><p>è€Œæœ¬èŠ‚æˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨å¦‚ä½•é€šè¿‡ <code>objc_removeAssociatedObjects</code> å‡½æ•°ä¸€æ¬¡æ€§ç§»é™¤å¯¹è±¡çš„æ‰€æœ‰å…³è”å€¼ã€‚è¿™ä¸ªå‡½æ•°é€šå¸¸åœ¨å¯¹è±¡è¢«é‡Šæ”¾æ—¶ç”± Runtime ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦æ‰‹åŠ¨è°ƒç”¨å®ƒã€‚è®©æˆ‘ä»¬ä¸€èµ·æ¥åˆ†æè¿™ä¸ªå‡½æ•°çš„å…·ä½“å®ç°ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">objc_removeAssociatedObjects</span><span class="params">(id object)</span>  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (object &amp;&amp; object-&gt;<span class="built_in">hasAssociatedObjects</span>()) &#123;</span><br><span class="line">        _object_remove_associations(object, <span class="comment">/*deallocating*/</span><span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line">_object_remove_associations(id object, <span class="type">bool</span> deallocating) &#123;</span><br><span class="line">    ObjectAssociationMap refs&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// è·å–å…¨å±€é”ï¼ˆåœ¨æ„é€ å‡½æ•°ä¸­åŠ é”ï¼Œåœ¨ææ„å‡½æ•°ä¸­è§£é”ï¼‰</span></span><br><span class="line">        AssociationsManager manager;</span><br><span class="line">        <span class="comment">// è·å–å…¨å±€å…³è”å¯¹è±¡å“ˆå¸Œè¡¨</span></span><br><span class="line">        <span class="function">AssociationsHashMap &amp;<span class="title">associations</span><span class="params">(manager.get())</span></span>;</span><br><span class="line">        <span class="comment">// è·å– object å¯¹åº”çš„å…³è”è¡¨ï¼ˆå†…å±‚å“ˆå¸Œè¡¨ï¼‰</span></span><br><span class="line">        AssociationsHashMap::iterator i = associations.<span class="built_in">find</span>((objc_object *)object);</span><br><span class="line">        <span class="keyword">if</span> (i != associations.<span class="built_in">end</span>()) &#123;</span><br><span class="line">            <span class="comment">// è·å–æ—§å€¼ç”¨äºé‡Šæ”¾</span></span><br><span class="line">            refs.<span class="built_in">swap</span>(i-&gt;second);</span><br><span class="line">            </span><br><span class="line">            <span class="type">bool</span> didReInsert = <span class="literal">false</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             å¦‚æœæ˜¯ç”± dealloc è§¦å‘çš„ï¼Œä¼šæ£€æŸ¥å…³è”å¯¹è±¡çš„å†…å­˜ç®¡ç†ç­–ç•¥æ˜¯å¦ä¸º OBJC_ASSOCIATION_SYSTEM_OBJECTã€‚</span></span><br><span class="line"><span class="comment">             è¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿå†…éƒ¨ä½¿ç”¨çš„ç‰¹æ®Šç­–ç•¥ï¼Œå®ƒè¦æ±‚ç›¸å…³å¯¹è±¡å¿…é¡»åœ¨å…¶å®ƒæ‰€æœ‰æ™®é€šå…³è”å¯¹è±¡éƒ½é‡Šæ”¾å®Œæˆåæ‰èƒ½è¢«é‡Šæ”¾ã€‚</span></span><br><span class="line"><span class="comment">             çŒœæµ‹è¿™ç§è®¾è®¡å¯èƒ½æ˜¯ä¸ºäº†ç¡®ä¿æŸäº›ç³»ç»Ÿçº§å¯¹è±¡èƒ½åœ¨æ•´ä¸ªé‡Šæ”¾æµç¨‹ä¸­ä¿æŒå¯ç”¨çŠ¶æ€ã€‚</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (!deallocating) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;ref: refs) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ref.second.<span class="built_in">policy</span>() &amp; OBJC_ASSOCIATION_SYSTEM_OBJECT) &#123;</span><br><span class="line">                        i-&gt;second.<span class="built_in">insert</span>(ref);</span><br><span class="line">                        didReInsert = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!didReInsert) &#123;</span><br><span class="line">                <span class="comment">// ä»å…¨å±€å…³è”è¡¨ä¸­ç§»é™¤è¿™ä¸ªå†…éƒ¨è¡¨</span></span><br><span class="line">                associations.<span class="built_in">erase</span>(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="comment">// è¿™é‡Œä¼šæ‰§è¡Œ manager çš„ææ„å‡½æ•°å¹¶é‡Šæ”¾å…¨å±€é”ã€‚</span></span><br><span class="line">    </span><br><span class="line">    SmallVector&lt;ObjcAssociation *, <span class="number">4</span>&gt; laterRefs;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// éå†å¹¶é‡Šæ”¾æ‰€æœ‰çš„å…³è”å¯¹è±¡ã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;i: refs) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i.second.<span class="built_in">policy</span>() &amp; OBJC_ASSOCIATION_SYSTEM_OBJECT) &#123;</span><br><span class="line">            <span class="keyword">if</span> (deallocating)</span><br><span class="line">                laterRefs.<span class="built_in">append</span>(&amp;i.second);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// é‡Šæ”¾ç›®æ ‡å¯¹è±¡ã€‚</span></span><br><span class="line">            i.second.<span class="built_in">releaseHeldValue</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// éå†å¹¶é‡Šæ”¾ OBJC_ASSOCIATION_SYSTEM_OBJECT å¯¹è±¡ã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> *later: laterRefs) &#123;</span><br><span class="line">        later-&gt;<span class="built_in">releaseHeldValue</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡Šæ”¾æ‰€æœ‰å…³è”å¯¹è±¡çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä½†éœ€è¦æ³¨æ„ä¸€äº›ç»†èŠ‚ï¼Œå®ƒçš„ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>è·å–å…¨å±€å…³è”è¡¨ï¼ˆAssociationsHashMapï¼‰ï¼Œç„¶åæ ¹æ®å‚æ•° object(å³ self) è·å–å¯¹åº”çš„å†…å±‚è¡¨ï¼ˆObjectAssociationMapï¼‰ï¼›</li><li>æŠŠå†…å±‚è¡¨ä¸­çš„å…³è”å¯¹è±¡å­˜å‚¨åˆ°ä¸€ä¸ªä¸´æ—¶å˜é‡ refs ä¸­ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†é¿å…åœ¨éå†è¿‡ç¨‹ä¸­ä¿®æ”¹å“ˆå¸Œè¡¨ã€‚</li><li>æ£€æŸ¥æ˜¯å¦å­˜åœ¨ OBJC_ASSOCIATION_SYSTEM_OBJECT ç±»å‹çš„å…³è”å¯¹è±¡ã€‚å¦‚æœå­˜åœ¨ä¸”ä¸æ˜¯ç”± dealloc è§¦å‘çš„ï¼Œåˆ™éœ€è¦å°†è¿™äº›å¯¹è±¡é‡æ–°æ’å…¥åˆ°å†…å±‚è¡¨ä¸­ï¼Œä»¥ç¡®ä¿å®ƒä»¬èƒ½åœ¨æœ€åè¢«é‡Šæ”¾ã€‚</li><li>å¦‚æœå†…å±‚è¡¨ä¸­æ²¡æœ‰é‡æ–°æ’å…¥çš„å¯¹è±¡ï¼Œåˆ™ä»å…¨å±€å…³è”è¡¨ä¸­ç§»é™¤ object å¯¹åº”çš„å†…å±‚è¡¨ã€‚</li><li>åˆ†ä¸¤æ­¥é‡Šæ”¾å…³è”å¯¹è±¡ï¼šå…ˆé‡Šæ”¾æ™®é€šå…³è”å¯¹è±¡ï¼Œå†é‡Šæ”¾ OBJC_ASSOCIATION_SYSTEM_OBJECT ç±»å‹çš„å…³è”å¯¹è±¡ã€‚è¿™ç§è®¾è®¡å¯èƒ½æ˜¯ä¸ºäº†ç¡®ä¿ç³»ç»Ÿå¯¹è±¡åœ¨æ•´ä¸ªé‡Šæ”¾æµç¨‹ä¸­ä¿æŒå¯ç”¨çŠ¶æ€ã€‚</li></ol><p>æ•´ä¸ªè¿‡ç¨‹éƒ½æ˜¯åœ¨å…¨å±€é”çš„ä¿æŠ¤ä¸‹è¿›è¡Œçš„ï¼Œè¿™ä¿è¯äº†çº¿ç¨‹å®‰å…¨ï¼Œä½†ä¹Ÿæ„å‘³ç€å¤§é‡ä½¿ç”¨å…³è”å¯¹è±¡å¯èƒ½ä¼šå½±å“æ€§èƒ½ã€‚</p><h2 id="ç›¸å…³ç–‘é—®ä¸æ³¨æ„äº‹é¡¹"><a href="#ç›¸å…³ç–‘é—®ä¸æ³¨æ„äº‹é¡¹" class="headerlink" title="ç›¸å…³ç–‘é—®ä¸æ³¨æ„äº‹é¡¹"></a>ç›¸å…³ç–‘é—®ä¸æ³¨æ„äº‹é¡¹</h2><h3 id="å¦‚ä½•åœ¨å…³è”å¯¹è±¡ä¸­ä½¿ç”¨-weak-å±æ€§"><a href="#å¦‚ä½•åœ¨å…³è”å¯¹è±¡ä¸­ä½¿ç”¨-weak-å±æ€§" class="headerlink" title="å¦‚ä½•åœ¨å…³è”å¯¹è±¡ä¸­ä½¿ç”¨ weak å±æ€§"></a>å¦‚ä½•åœ¨å…³è”å¯¹è±¡ä¸­ä½¿ç”¨ weak å±æ€§</h3><p>å…³è”å¯¹è±¡é»˜è®¤æ˜¯ä¸æ”¯æŒ weak å±æ€§çš„ã€‚è¿™æ˜¯å› ä¸º weak ç‰¹æ€§çš„å®ç°éœ€è¦èƒ½å¤Ÿè·å–åˆ°å±æ€§æŒ‡é’ˆçš„åœ°å€ï¼Œä»¥ä¾¿åœ¨å¯¹è±¡é‡Šæ”¾æ—¶å°†æŒ‡é’ˆç½®ä¸º nilã€‚è€Œå…³è”å¯¹è±¡æ˜¯é€šè¿‡å“ˆå¸Œè¡¨å­˜å‚¨çš„ï¼Œæˆ‘ä»¬æ— æ³•è·å–åˆ°å­˜å‚¨å€¼çš„å†…å­˜åœ°å€ï¼Œæ•…è€Œä¸èƒ½ç›´æ¥ä½¿ç”¨ weak ç‰¹æ€§ã€‚</p><p>å¦‚æœä½ ç¡®å®éœ€è¦åœ¨å…³è”å¯¹è±¡ä¸­å®ç°ç±»ä¼¼ weak çš„æ•ˆæœï¼Œæœ‰ä»¥ä¸‹å‡ ç§æ›¿ä»£æ–¹æ¡ˆï¼š</p><ol><li>ä½¿ç”¨ä¸­é—´å¯¹è±¡ï¼šåˆ›å»ºä¸€ä¸ªä¸­é—´å¯¹è±¡ï¼Œå°† weak å±æ€§å­˜å‚¨åœ¨è¿™ä¸ªå¯¹è±¡ä¸­ï¼Œç„¶åé€šè¿‡è¿™ä¸ªä¸­é—´å¯¹è±¡æ¥é—´æ¥å®ç° weak æ•ˆæœï¼›</li><li>ä½¿ç”¨ NSHashTable ç­‰å¼±å¼•ç”¨å®¹å™¨ï¼›</li><li>æ‰‹åŠ¨å®ç°å¼•ç”¨è®¡æ•°ç®¡ç†ã€‚</li></ol><p>å…³äºâ€œä¸­é—´å¯¹è±¡â€çš„å…·ä½“å®ç°æ–¹æ¡ˆå’Œ weak æŒ‡é’ˆçš„æ›´å¤šè¯¦ç»†å†…å®¹ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ï¼š<a href="https://budo.top/2023/10/21/iOS/%E6%8F%AD%E5%BC%80%20iOS%20%E4%B8%AD%20weak%20%E6%8C%87%E9%92%88%E7%9A%84%E7%A5%9E%E7%A7%98%E9%9D%A2%E7%BA%B1%EF%BC%9A%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E5%AE%9E%E8%B7%B5/#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%83%BD%E7%BB%99-Category-%E6%B7%BB%E5%8A%A0-weak-%E5%B1%9E%E6%80%A7%EF%BC%9F">æ­å¼€ iOS ä¸­ weak æŒ‡é’ˆçš„ç¥ç§˜é¢çº±ï¼šä»åŸç†åˆ°å®è·µ</a></p><h3 id="å…³è”å¯¹è±¡ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥æ·»åŠ æˆå‘˜å˜é‡"><a href="#å…³è”å¯¹è±¡ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥æ·»åŠ æˆå‘˜å˜é‡" class="headerlink" title="å…³è”å¯¹è±¡ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥æ·»åŠ æˆå‘˜å˜é‡"></a>å…³è”å¯¹è±¡ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥æ·»åŠ æˆå‘˜å˜é‡</h3><p>è¿™ä¸ªé—®é¢˜éœ€è¦ä»ä¸¤ä¸ªè§’åº¦æ¥ç†è§£ï¼šæŠ€æœ¯å®ç°å±‚é¢å’Œè®¾è®¡ç›®çš„å±‚é¢ã€‚</p><p>ä»æŠ€æœ¯å®ç°å±‚é¢æ¥è¯´ï¼Œç±»çš„å†…å­˜å¸ƒå±€ï¼ˆåŒ…æ‹¬å®ä¾‹å˜é‡çš„å¤§å°å’Œåç§»é‡ï¼‰å¿…é¡»åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šä¸‹æ¥ã€‚ä¸€æ—¦ç±»è¢«ç¼–è¯‘å®Œæˆï¼Œå…¶å†…å­˜å¸ƒå±€å°±å·²ç»å›ºå®šï¼Œæ— æ³•å†åŠ¨æ€åœ°æ·»åŠ å®ä¾‹å˜é‡ã€‚å› ä¸ºåˆ†ç±»ä¸ä»…é€‚ç”¨äºæˆ‘ä»¬è‡ªå·±é¡¹ç›®ä¸­çš„ç±»ï¼Œæ›´é‡è¦çš„æ˜¯è¿˜åŒ…æ‹¬ç³»ç»Ÿæ¡†æ¶å’Œç¬¬ä¸‰æ–¹åº“ä¸­çš„ç±»ã€‚</p><p>ä»è®¾è®¡ç›®çš„å±‚é¢æ¥è¯´ï¼Œå…³è”å¯¹è±¡çš„è®¾è®¡åˆè¡·å°±æ˜¯ä¸ºäº†åœ¨ä¸æ”¹å˜ç±»å†…å­˜å¸ƒå±€çš„æƒ…å†µä¸‹ï¼Œå®ç°åŠ¨æ€åœ°ä¸ºå¯¹è±¡æ·»åŠ å­˜å‚¨èƒ½åŠ›ã€‚è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥ï¼š</p><ol><li>åœ¨ Category ä¸­æ·»åŠ â€å±æ€§â€ï¼Œçªç ´ Category çš„å­˜å‚¨é™åˆ¶ï¼›</li><li>ä¸ºç³»ç»Ÿç±»æ·»åŠ è‡ªå®šä¹‰å±æ€§ï¼Œè€Œæ— éœ€ç»§æ‰¿ï¼›</li><li>åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°ä¸ºä»»æ„å¯¹è±¡å…³è”æ•°æ®ã€‚</li></ol><p>å¦‚æœå…³è”å¯¹è±¡çš„å®ç°è¢«é™åˆ¶ä¸ºåªèƒ½ç»™å½“å‰é¡¹ç›®ä¸­çš„ç±»æ·»åŠ å±æ€§ï¼Œé‚£ä¹ˆç†è®ºä¸Šç¡®å®å¯ä»¥é€šè¿‡ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´ä¿®æ”¹ç±»çš„å†…å­˜å¸ƒå±€æ¥å®ç°ã€‚ä½†è¿™æ ·å°±å¤±å»äº†å…³è”å¯¹è±¡æœ€é‡è¦çš„ç‰¹æ€§ - è¿è¡Œæ—¶åŠ¨æ€æ€§ï¼Œä¹Ÿæ— æ³•å®ç°å¯¹ç³»ç»Ÿå’Œä¸‰æ–¹åº“ä¸­çš„ç±»è¿›è¡Œæ‰©å±•ã€‚</p><p>å¦‚æœä½ æƒ³äº†è§£æ›´å¤š Category æ–¹é¢çš„çŸ¥è¯†ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ï¼š<a href="https://budo.top/2024/12/11/iOS/2024%20%E5%86%8D%E6%8E%A2ObjC-Category%EF%BC%9A%E5%8A%A8%E6%80%81%E7%89%B9%E6%80%A7%E4%B8%8E%E8%BF%90%E8%A1%8C%E6%97%B6%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%9E%81%E8%87%B4%E4%B9%8B%E7%BE%8E/#Category-%E4%B9%8B%E8%BF%90%E8%A1%8C%E6%97%B6%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82%EF%BC%9A%E6%8E%A2%E7%B4%A2%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86">2024 å†æ¢ObjC-Categoryï¼šåŠ¨æ€ç‰¹æ€§ä¸è¿è¡Œæ—¶å®ç°çš„æè‡´ä¹‹ç¾</a>ã€‚</p><h3 id="å…³è”å¯¹è±¡å’ŒçœŸæ­£çš„å±æ€§æœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#å…³è”å¯¹è±¡å’ŒçœŸæ­£çš„å±æ€§æœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="å…³è”å¯¹è±¡å’ŒçœŸæ­£çš„å±æ€§æœ‰ä»€ä¹ˆåŒºåˆ«"></a>å…³è”å¯¹è±¡å’ŒçœŸæ­£çš„å±æ€§æœ‰ä»€ä¹ˆåŒºåˆ«</h3><p>è™½ç„¶å…³è”å¯¹è±¡åœ¨ä½¿ç”¨ä¸Šä¸æ™®é€šå±æ€§éå¸¸ç›¸ä¼¼ï¼Œä½†å®ƒä»¬åœ¨å®ç°æœºåˆ¶å’Œæ€§èƒ½ç‰¹å¾ä¸Šå­˜åœ¨æ˜¾è‘—å·®å¼‚ï¼š</p><ol><li><p>å®ç°æœºåˆ¶ï¼š</p><ul><li>å±æ€§æ˜¯åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šçš„å®ä¾‹å˜é‡ï¼Œç›´æ¥å­˜å‚¨åœ¨å¯¹è±¡çš„å†…å­˜å¸ƒå±€ä¸­ã€‚</li><li>å…³è”å¯¹è±¡æ˜¯è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ çš„ï¼Œé€šè¿‡å…¨å±€å“ˆå¸Œè¡¨æ¥å­˜å‚¨å’Œç®¡ç†ã€‚</li></ul></li><li><p>æ€§èƒ½å¼€é”€ï¼š</p><ul><li>å±æ€§è®¿é—®åªéœ€è¦ä¸€æ¬¡ç®€å•çš„å†…å­˜åç§»è®¡ç®—ã€‚</li><li>å…³è”å¯¹è±¡éœ€è¦å“ˆå¸Œè¡¨æŸ¥æ‰¾ã€åŠ è§£é”ç­‰å¤šä¸ªæ“ä½œæ­¥éª¤ï¼Œæ€§èƒ½å¼€é”€è¾ƒå¤§ï¼Œæˆ‘åœ¨ iPhone 8 Plus(iOS15.8.3) è®¾å¤‡ä¸Šåšäº†ä¸€ä¸ªæµ‹è¯•ï¼Œä»£ç åœ¨ <a href="https://github.com/internetWei/OmniTest/blob/main/%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%E4%B8%8E%E5%B1%9E%E6%80%A7%E7%9A%84%E8%AF%BB%E5%86%99%E6%80%A7%E8%83%BD/ViewController.m">è¿™é‡Œ</a>ï¼Œç»“æœæ˜¾ç¤ºå±æ€§æ¯”å…³è”å¯¹è±¡å¿«äº† 4 å€å·¦å³ï¼Œè¿™é‡Œåªæµ‹è¯•äº†å•çº¿ç¨‹çš„æƒ…å†µï¼Œä¸èƒ½åæ˜ å¤šçº¿ç¨‹ä¸‹çš„å®é™…æ€§èƒ½ï¼Œç»“æœåªå½“ä½œä¸€ä¸ªå‚è€ƒã€‚</li></ul><p> <img src="performance.png"></p></li><li><p>çº¿ç¨‹å®‰å…¨ï¼š</p><ul><li>iOS ä¸­çš„å±æ€§ä¸€èˆ¬æ˜¯éåŸå­çš„(nonatomic)ï¼Œå¤šçº¿ç¨‹è®¿é—®éœ€è¦æ‰‹åŠ¨åŠ é”ã€‚</li><li>å…³è”å¯¹è±¡é€šè¿‡å…¨å±€é”ä¿è¯äº†æ“ä½œçš„åŸå­æ€§ã€‚</li></ul></li><li><p>å†…å­˜ç®¡ç†ï¼š</p><ul><li>å±æ€§çš„å†…å­˜ç®¡ç†ç”±ç¼–è¯‘å™¨è‡ªåŠ¨å¤„ç†ï¼Œé€šè¿‡ strongã€weak ç­‰å±æ€§ä¿®é¥°ç¬¦æŒ‡å®šã€‚</li><li>å…³è”å¯¹è±¡éœ€è¦æ‰‹åŠ¨æŒ‡å®šå†…å­˜ç®¡ç†ç­–ç•¥ï¼Œä¸”ä¸æ”¯æŒ weak å¼•ç”¨ã€‚</li></ul></li><li><p>ä½¿ç”¨åœºæ™¯ï¼š</p><ul><li>å±æ€§é€‚ç”¨äºç±»çš„æ ¸å¿ƒåŠŸèƒ½å®ç°ã€‚</li><li>å…³è”å¯¹è±¡ä¸»è¦ç”¨äºè¿è¡Œæ—¶åŠ¨æ€æ‰©å±•åŠŸèƒ½ï¼Œå°¤å…¶æ˜¯åœ¨åˆ†ç±»ä¸­æ·»åŠ å­˜å‚¨èƒ½åŠ›ã€‚</li></ul></li></ol><p>å› æ­¤ï¼Œè™½ç„¶å…³è”å¯¹è±¡ä¸ºæˆ‘ä»¬æä¾›äº†å¼ºå¤§çš„åŠ¨æ€æ‰©å±•èƒ½åŠ›ï¼Œä½†åœ¨æ€§èƒ½è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ä¸‹ï¼Œåº”ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨å±æ€§æ¥å®ç°ã€‚</p><h3 id="å…³è”å¯¹è±¡çš„é‡Šæ”¾æ—¶æœº"><a href="#å…³è”å¯¹è±¡çš„é‡Šæ”¾æ—¶æœº" class="headerlink" title="å…³è”å¯¹è±¡çš„é‡Šæ”¾æ—¶æœº"></a>å…³è”å¯¹è±¡çš„é‡Šæ”¾æ—¶æœº</h3><p>å…³è”å¯¹è±¡çš„é‡Šæ”¾æ—¶æœºä¸å¯¹è±¡æœ¬èº«çš„é‡Šæ”¾æ—¶æœºå®Œå…¨ä¸€è‡´ã€‚å½“ä¸€ä¸ªå¯¹è±¡è¢«é‡Šæ”¾æ—¶ï¼ŒRuntime ç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒç”¨ <code>_object_remove_associations</code> å‡½æ•°æ¥ç§»é™¤è¯¥å¯¹è±¡çš„æ‰€æœ‰å…³è”å¯¹è±¡(å’Œæ‰‹åŠ¨è°ƒç”¨ <code>objc_removeAssociatedObjects</code> å‡½æ•°æ•ˆæœç±»ä¼¼ï¼Œé™¤äº†ç¬¬äºŒä¸ªå‚æ•°å€¼ä¸ä¸€æ ·)ã€‚æ•´ä¸ªè°ƒç”¨é“¾è·¯å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">dealloc</span><br><span class="line">â””â”€â”€ _objc_rootDealloc</span><br><span class="line">    â””â”€â”€ rootDealloc</span><br><span class="line">        â””â”€â”€ object_dispose</span><br><span class="line">            â””â”€â”€ objc_destructInstance</span><br><span class="line">                â””â”€â”€ _object_remove_associations</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨å…³è”å¯¹è±¡æ—¶çš„æ³¨æ„äº‹é¡¹"><a href="#ä½¿ç”¨å…³è”å¯¹è±¡æ—¶çš„æ³¨æ„äº‹é¡¹" class="headerlink" title="ä½¿ç”¨å…³è”å¯¹è±¡æ—¶çš„æ³¨æ„äº‹é¡¹"></a>ä½¿ç”¨å…³è”å¯¹è±¡æ—¶çš„æ³¨æ„äº‹é¡¹</h3><p>è™½ç„¶å…³è”å¯¹è±¡ä¸ºæˆ‘ä»¬æä¾›äº†å¼ºå¤§çš„åŠ¨æ€æ‰©å±•èƒ½åŠ›ï¼Œä½†ç”±äºå…¶ç‰¹æ®Šçš„å®ç°æœºåˆ¶ï¼Œåœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­æˆ‘ä»¬ä»éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ä¸ªå…³é”®ç‚¹ï¼Œä»¥é¿å…æ½œåœ¨çš„é—®é¢˜ï¼š</p><ol><li><p>å†…å­˜ç®¡ç†ç­–ç•¥çš„é€‰æ‹©</p><ul><li>è°¨æ…ä½¿ç”¨ OBJC_ASSOCIATION_ASSIGNï¼šè¿™ç§ç­–ç•¥ä¸ä¼šæŒæœ‰å¯¹è±¡ï¼Œå®¹æ˜“é€ æˆé‡æŒ‡é’ˆå´©æºƒã€‚ä»…åœ¨ä»¥ä¸‹ç‰¹æ®Šåœºæ™¯è€ƒè™‘ä½¿ç”¨ï¼š<ul><li>å…³è”å¯¹è±¡æ˜¯ Tagged Pointerï¼ˆå¦‚å°æ•´æ•°çš„ NSNumberï¼‰ï¼›</li><li>å…³è”å¯¹è±¡ä¸è¢«å…³è”å¯¹è±¡å…·æœ‰ç›¸åŒçš„ç”Ÿå‘½å‘¨æœŸï¼›</li><li>éœ€è¦æ‰“ç ´å¾ªç¯å¼•ç”¨çš„åœºæ™¯ã€‚</li></ul></li><li>å³ä½¿æ˜¯ Tagged Pointer å¯¹è±¡ï¼Œä¹Ÿå»ºè®®ä½¿ç”¨å¸¦æœ‰ RETAIN æˆ– COPY çš„å†…å­˜ç®¡ç†ç­–ç•¥ï¼Œå› ä¸º Runtime ç³»ç»Ÿå†…éƒ¨ä¼šè‡ªåŠ¨å¤„ç† Tagged Pointer çš„å†…å­˜ç®¡ç†ã€‚</li></ul></li><li><p>æ€§èƒ½è€ƒé‡ï¼šå…³è”å¯¹è±¡çš„å­˜å–æ¶‰åŠå…¨å±€å“ˆå¸Œè¡¨æ“ä½œå’ŒåŠ é”ï¼Œæ€§èƒ½å¼€é”€æ¯”ç›´æ¥è®¿é—®å®ä¾‹å˜é‡å¤§ï¼›æ‰€ä»¥ä¸è¦åœ¨æ€§èƒ½æ•æ„Ÿçš„ä»£ç è·¯å¾„ä¸­é¢‘ç¹æ“ä½œå…³è”å¯¹è±¡ï¼›å¯ä»¥è€ƒè™‘ä½¿ç”¨ç¼“å­˜æœºåˆ¶å‡å°‘è®¿é—®é¢‘ç‡ã€‚</p></li><li><p>çº¿ç¨‹å®‰å…¨ï¼šå…³è”å¯¹è±¡åªä¿è¯äº†è¯»å†™æ“ä½œæ˜¯åŸå­çš„ï¼Œä½†å¤šçº¿ç¨‹è®¿é—®æ—¶ä»éœ€æ³¨æ„æ•°æ®ä¸€è‡´æ€§ï¼ˆä¾‹å¦‚å¤šçº¿ç¨‹å¯¹å¯å˜å¯¹è±¡çš„ä¿®æ”¹ï¼‰ï¼›å¤æ‚æ“ä½œæ—¶å»ºè®®é¢å¤–åŠ é”ä¿æŠ¤ã€‚</p></li><li><p>å†…å­˜ç®¡ç†</p><ul><li>åœ¨å¯¹è±¡é‡Šæ”¾æ—¶ï¼Œå…¶å…³è”å¯¹è±¡ä¼šè¢«è‡ªåŠ¨ç§»é™¤ï¼›</li><li>ä½¿ç”¨ RETAIN&#x2F;COPY ç­–ç•¥æ—¶è¦æ³¨æ„é¿å…å¾ªç¯å¼•ç”¨ï¼›</li><li>å¦‚æœç¡®å®éœ€è¦ weak å¼•ç”¨æ•ˆæœï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ â€œä¸­é—´å¯¹è±¡â€ æˆ– NSHashTable ç­‰æ–¹æ¡ˆã€‚</li></ul></li><li><p>è°ƒè¯•ä¸ç»´æŠ¤</p><ul><li>å…³è”å¯¹è±¡ä¸ä¼šå‡ºç°åœ¨ç±»çš„å±æ€§åˆ—è¡¨ä¸­ï¼Œè°ƒè¯•æ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼›</li><li>å»ºè®®ç»Ÿä¸€ç®¡ç†å…³è”å¯¹è±¡çš„ keyï¼Œé¿å…å†²çªï¼›</li><li>é€‚å½“æ·»åŠ æ³¨é‡Šè¯´æ˜å…³è”å¯¹è±¡çš„ç”¨é€”å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†æ–¹å¼ã€‚</li></ul></li></ol><h2 id="æŠ€æœ¯æ€»ç»“"><a href="#æŠ€æœ¯æ€»ç»“" class="headerlink" title="æŠ€æœ¯æ€»ç»“"></a>æŠ€æœ¯æ€»ç»“</h2><p>é€šè¿‡å¯¹å…³è”å¯¹è±¡åº•å±‚å®ç°åŸç†çš„æ·±å…¥åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä»¥ä¸‹å…³é”®ç»“è®ºï¼š</p><ol><li><p>å­˜å‚¨ç»“æ„</p><ul><li>å…³è”å¯¹è±¡çš„åº•å±‚é‡‡ç”¨åŒå±‚å“ˆå¸Œè¡¨ç»“æ„å®ç°ï¼Œä¿è¯äº†å¿«é€Ÿçš„å­˜å–æ•ˆç‡ï¼›</li><li>ç¬¬ä¸€å±‚ä»¥å¯¹è±¡åœ°å€ä¸ºé”®ï¼Œæ˜ å°„åˆ°è¯¥å¯¹è±¡çš„æ‰€æœ‰å…³è”å¯¹è±¡ï¼›</li><li>ç¬¬äºŒå±‚ä»¥å…³è”é”®ä¸ºç´¢å¼•ï¼Œå­˜å‚¨å…·ä½“çš„å…³è”å€¼å’Œå†…å­˜ç®¡ç†ç­–ç•¥ã€‚</li></ul></li><li><p>çº¿ç¨‹å®‰å…¨</p><ul><li>å…³è”å¯¹è±¡å†…éƒ¨é€šè¿‡å…¨å±€é”ä¿è¯äº†å­˜å–æ“ä½œçš„åŸå­æ€§ï¼›</li><li>é‡‡ç”¨ RAII æŠ€æœ¯è‡ªåŠ¨ç®¡ç†é”çš„è·å–å’Œé‡Šæ”¾ï¼›</li><li>ä½†æ˜¯å¤æ‚æ“ä½œæ—¶ä»éœ€è€ƒè™‘é¢å¤–çš„åŒæ­¥æœºåˆ¶ã€‚</li></ul></li><li><p>å†…å­˜ç®¡ç†</p><ul><li>æ”¯æŒ retain&#x2F;copy&#x2F;assign å¤šç§å†…å­˜ç®¡ç†ç­–ç•¥ï¼Œä½†ä¸æ”¯æŒ weak å¼•ç”¨ï¼›</li><li>è‡ªåŠ¨å¤„ç†å…³è”å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä¸€è‡´ï¼›</li><li>é€šè¿‡ ObjcAssociation å°è£…å®ç°ç»Ÿä¸€çš„å†…å­˜ç®¡ç†ã€‚</li></ul></li></ol><p>å…³è”å¯¹è±¡æŠ€æœ¯ä¸º Category çªç ´äº†å­˜å‚¨é™åˆ¶ï¼Œä½†ä¹Ÿå¸¦æ¥äº†é¢å¤–çš„å¤æ‚æ€§å’Œæ€§èƒ½å¼€é”€ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œåº”å½“æ ¹æ®å…·ä½“åœºæ™¯æƒè¡¡ä½¿ç”¨ï¼Œåˆç†ä½¿ç”¨è¿™æŠŠ â€œåŒåˆƒå‰‘â€ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Runtime </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tagged Pointerï¼šè‹¹æœå·¥ç¨‹å¸ˆçš„å†…å­˜ä¼˜åŒ–è‰ºæœ¯</title>
      <link href="/2025/04/02/iOS/Tagged%20Pointer%EF%BC%9A%E8%8B%B9%E6%9E%9C%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%9A%84%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E8%89%BA%E6%9C%AF/"/>
      <url>/2025/04/02/iOS/Tagged%20Pointer%EF%BC%9A%E8%8B%B9%E6%9E%9C%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%9A%84%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E8%89%BA%E6%9C%AF/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç”± å¸ƒå¤š(budo) å‘å¸ƒäº 2025-04-02</p></blockquote><h2 id="Tagged-Pointer-çš„å‰ä¸–ä»Šç”Ÿ"><a href="#Tagged-Pointer-çš„å‰ä¸–ä»Šç”Ÿ" class="headerlink" title="Tagged Pointer çš„å‰ä¸–ä»Šç”Ÿ"></a>Tagged Pointer çš„å‰ä¸–ä»Šç”Ÿ</h2><p>åœ¨ iOS å¼€å‘çš„æ—©æœŸé˜¶æ®µï¼Œæ‰€æœ‰å¯¹è±¡éƒ½é‡‡ç”¨ä¼ ç»Ÿçš„å †å†…å­˜å­˜å‚¨æ–¹å¼ã€‚æ¯ä¸ªå¯¹è±¡æŒ‡é’ˆéƒ½æŒ‡å‘å †å†…å­˜ä¸­çš„ä¸€å—åŒºåŸŸï¼Œè¿™å—åŒºåŸŸä¸ä»…å­˜å‚¨ç€å¯¹è±¡çš„å®é™…æ•°æ®ï¼Œè¿˜åŒ…å«äº†ç±»å‹ä¿¡æ¯ã€å¼•ç”¨è®¡æ•°ç­‰å…ƒæ•°æ®ã€‚è¿™ç§å­˜å‚¨æ–¹å¼è™½ç„¶é€šç”¨ä¸”çµæ´»ï¼Œä½†å¯¹äºä¸€äº›ç®€å•çš„æ•°æ®ç±»å‹ï¼ˆå¦‚ NSNumber å­˜å‚¨çš„å°æ•´æ•° 10ã€200 ç­‰ï¼‰ï¼Œå´æ˜¾å¾—æœ‰äº›â€å¤§æå°ç”¨â€ã€‚è¯•æƒ³ï¼Œä»…ä»…ä¸ºäº†å­˜å‚¨ä¸€ä¸ªå°æ•´æ•°ï¼Œå°±éœ€è¦åœ¨å †ä¸Šåˆ†é…å†…å­˜ã€ç»´æŠ¤å¼•ç”¨è®¡æ•°ã€è¿›è¡Œå†…å­˜å›æ”¶ï¼Œè¿™ä¸ä»…é€ æˆäº†å†…å­˜ç©ºé—´çš„æµªè´¹ï¼Œè¿˜ä¼šå› ä¸ºé¢‘ç¹çš„å†…å­˜æ“ä½œè€Œå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè‹¹æœçš„å·¥ç¨‹å¸ˆä»¬æå‡ºäº† Tagged Pointer æŠ€æœ¯ã€‚è¿™é¡¹æŠ€æœ¯çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå¯¹äºä¸€äº›å°å‹æ•°æ®ï¼Œå°†å…¶ç›´æ¥ç¼–ç åˆ°æŒ‡é’ˆä¸­ï¼Œè€Œä¸æ˜¯åœ¨å †ä¸Šåˆ†é…å†…å­˜ã€‚è¿™ç§å·§å¦™çš„è®¾è®¡ä¸ä»…èŠ‚çœäº†å®è´µçš„å†…å­˜ç©ºé—´ï¼Œè¿˜é€šè¿‡å‡å°‘å†…å­˜åˆ†é…å’Œé‡Šæ”¾æ“ä½œæ˜¾è‘—æå‡äº†æ€§èƒ½ã€‚</p><p>è¿™ç§åˆ›æ–°çš„æ•ˆæœæ˜¯ç«‹ç«¿è§å½±çš„ã€‚æ ¹æ® WWDC2013 è‹¹æœå®˜æ–¹å‘å¸ƒçš„æ•°æ®æ˜¾ç¤ºï¼Œé‡‡ç”¨ Tagged Pointer æŠ€æœ¯åï¼Œç›¸å…³æ“ä½œè·å¾—äº†æ˜¾è‘—çš„æ€§èƒ½æå‡ï¼šå†…å­˜å ç”¨ç›´æ¥å‡å°‘äº† 50%ï¼Œæ•°æ®è®¿é—®é€Ÿåº¦æå‡äº† 3 å€ï¼Œè€Œå¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯é€Ÿåº¦æ›´æ˜¯å®ç°äº†æƒŠäººçš„ 100 å€æå‡ã€‚è¿™äº›æ•°æ®å……åˆ†è¯æ˜äº† Tagged Pointer æŠ€æœ¯åœ¨å†…å­˜ä¼˜åŒ–å’Œæ€§èƒ½æå‡æ–¹é¢çš„å·¨å¤§ä»·å€¼ã€‚</p><h2 id="æŠ€æœ¯åŸç†æ·±åº¦è§£æ"><a href="#æŠ€æœ¯åŸç†æ·±åº¦è§£æ" class="headerlink" title="æŠ€æœ¯åŸç†æ·±åº¦è§£æ"></a>æŠ€æœ¯åŸç†æ·±åº¦è§£æ</h2><p>è™½ç„¶ Tagged Pointer æŠ€æœ¯åœ¨ iOS ä¸­è¢«å¹¿æ³›åº”ç”¨äº NSNumberã€NSDateã€NSString ç­‰å¤šä¸ªå¯¹è±¡ç±»å‹ï¼Œä½† NSNumber æ˜¯æœ€å…·ä»£è¡¨æ€§çš„ä¾‹å­ã€‚å› æ­¤ï¼Œæœ¬æ–‡å°†ä»¥ NSNumber ä¸ºä¾‹æ·±å…¥è®²è§£å…¶å®ç°åŸç†ã€‚å…¶å®ƒå¯¹è±¡çš„å®ç°æœºåˆ¶ä¸ NSNumber ç±»ä¼¼ï¼Œè¯»è€…å¯ä»¥ä¸¾ä¸€åä¸‰ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ç°ä»£ Xcode ç‰ˆæœ¬ä¸­ï¼ˆå…·ä½“ä»å“ªä¸ªç‰ˆæœ¬å¼€å§‹ä¸å¤ªç¡®å®šï¼‰ï¼Œè‹¹æœä¸ºäº†å¢å¼ºæ•°æ®å®‰å…¨æ€§ï¼Œå¯¹ Tagged Pointer è¿›è¡Œäº†æ•°æ®æ··æ·†å¤„ç†ã€‚è¿™ç§æ··æ·†æœºåˆ¶ä½¿å¾—å¼€å‘è€…æ— æ³•é€šè¿‡ç›´æ¥æ‰“å°æŒ‡é’ˆæ¥åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦ä¸º Tagged Pointerï¼Œä¹Ÿæ— æ³•è§£æå…¶ä¸­å­˜å‚¨çš„å…·ä½“æ•°æ®ã€‚</p><p>ä¸ºäº†ä¾¿äºè°ƒè¯•å’Œè§‚å¯Ÿ Tagged Pointer çš„åº•å±‚å®ç°ï¼Œæˆ‘ä»¬éœ€è¦å…³é—­è¿™ä¸ªæ•°æ®æ··æ·†åŠŸèƒ½ã€‚åªéœ€è¦å°†ç¯å¢ƒå˜é‡ <code>OBJC_DISABLE_TAG_OBFUSCATION</code> è®¾ç½®ä¸º <code>YES</code> å³å¯ã€‚</p><p><img src="operator.png"></p><p>ç”±äº NSNumber çš„æºç æœªå¼€æºï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡åˆ†æç»“æœæ¥äº†è§£ Tagged Pointer çš„å®ç°åŸç†ã€‚ä»¥ä¸‹æ˜¯æˆ‘çš„è°ƒè¯•ç»“æœï¼š</p><p><img src="result1.png"></p><p>é€šè¿‡åˆ†ææ‰“å°ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Tagged Pointer çš„ç²¾å¦™è®¾è®¡ï¼šå®ƒå°†æ•°æ®ç›´æ¥ç¼–ç åœ¨æŒ‡é’ˆä¸­ï¼Œè€Œä¸æ˜¯åœ¨å †å†…å­˜ä¸­åˆ†é…ç©ºé—´ã€‚å…·ä½“æ¥è¯´ï¼š</p><ol><li><p>æŒ‡é’ˆçš„ç¬¬ 6 ä½åˆ°ç¬¬ 60 ä½ï¼ˆä»å·¦å¾€å³æ•°ï¼‰ç”¨äºå­˜å‚¨å®é™…æ•°æ®ã€‚è¿™æ„å‘³ç€ä¸€ä¸ª NSNumber å¯¹è±¡æœ€å¤šå¯ä»¥å­˜å‚¨ 55 ä½çš„æ•°æ®ï¼Œå³ 0x7FFFFFFFFFFFFFï¼Œå¯¹åº”çš„åè¿›åˆ¶ä¸º 36028797018963967ã€‚</p></li><li><p>æŒ‡é’ˆçš„å…¶ä½™ä½åˆ™ç”¨äºå­˜å‚¨å…ƒæ•°æ®ï¼š</p><ul><li>ç¬¬ 1 ä½ï¼ˆæœ€é«˜ä½ï¼‰ä½œä¸º Tag æ ‡è®°ï¼Œç”¨äºæ ‡è¯†è¿™æ˜¯ä¸€ä¸ª Tagged Pointerï¼›</li><li>ç¬¬ 2-5 ä½ç”¨äºå­˜å‚¨å¯¹è±¡ç±»å‹ï¼ˆå¦‚ NSNumber ä¸º 3ï¼ŒNSString ä¸º 2ï¼‰ï¼›</li><li>æœ€å 4 ä½ç”¨äºå­˜å‚¨æ•°æ®ç±»å‹ï¼ˆå¦‚ int ä¸º 2ï¼Œlong ä¸º 3ï¼‰ã€‚</li></ul></li></ol><p>Tagged Pointer çš„å†…å­˜åˆ†å¸ƒå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="TaggedPointer.png"></p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸åŒå¹³å°å’Œç³»ç»Ÿç‰ˆæœ¬ä¸‹ï¼ŒTagged Pointer çš„å®ç°ç»†èŠ‚å¯èƒ½æœ‰æ‰€ä¸åŒã€‚ä¾‹å¦‚ï¼Œåœ¨ iOS æ¨¡æ‹Ÿå™¨å’ŒçœŸæœºç¯å¢ƒä¸­ï¼ŒTag ä½å’Œæ•°æ®ä½çš„å­˜å‚¨ä½ç½®å°±å­˜åœ¨å·®å¼‚ï¼šæ¨¡æ‹Ÿå™¨ä¸­ Tag ä½åœ¨æœ€ä½ä½ï¼Œè€ŒçœŸæœºä¸­ Tag ä½åœ¨æœ€é«˜ä½ã€‚è¿™ç§å·®å¼‚ä¸»è¦æ˜¯ç”±äºä¸åŒå¹³å°çš„å†…å­˜å¯¹é½è¦æ±‚å’Œå¤„ç†å™¨æ¶æ„ç‰¹æ€§å¯¼è‡´çš„ã€‚å› æ­¤ï¼Œåœ¨è°ƒè¯•è¿‡ç¨‹ä¸­å¦‚æœå‘ç°ç»“æœä¸é¢„æœŸä¸ç¬¦ï¼Œå¯ä»¥çœ‹çœ‹æ˜¯ä¸æ˜¯å¹³å°æˆ–ç³»ç»Ÿç‰ˆæœ¬çš„é—®é¢˜ã€‚</p></blockquote><p>è¿™ç§è®¾è®¡å·§å¦™åœ°åˆ©ç”¨äº† 64 ä½ç³»ç»Ÿçš„ç‰¹æ€§ã€‚åœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œç”±äºè™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´çš„é™åˆ¶ï¼Œ64 ä½æŒ‡é’ˆå®é™…ä¸Šåªä½¿ç”¨äº†æœ€ä½çš„ 47 ä½æ¥å¯»å€ï¼Œè¿™æ„å‘³ç€åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œåˆæ³•çš„å†…å­˜åœ°å€æœ€é«˜ä½ä¸€å®šæ˜¯ 0ã€‚Tagged Pointer æ­£æ˜¯å·§å¦™åˆ©ç”¨äº†è¿™ä¸€ç‰¹ç‚¹ï¼Œé€šè¿‡å°†æœ€é«˜ä½è®¾ä¸º 1 æ¥æ ‡è¯†è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æŒ‡é’ˆã€‚Tagged Pointer è¿˜å°†è¿™äº› â€œç©ºé—²â€ çš„ä½è¿›è¡Œäº†é‡æ–°è§„åˆ’åˆ©ç”¨ï¼šä¸€éƒ¨åˆ†ç”¨äºå­˜å‚¨ç±»å‹æ ‡è®°ï¼Œå¦ä¸€éƒ¨åˆ†ç”¨äºç›´æ¥å­˜å‚¨æ•°æ®ã€‚è¿™æ ·ï¼Œå¯¹äºå°å‹æ•°æ®ï¼ˆå¦‚å°æ•´æ•°ã€çŸ­å­—ç¬¦ä¸²ç­‰ï¼‰å°±ä¸å†éœ€è¦é¢å¤–åˆ†é…å †å†…å­˜ï¼Œè€Œæ˜¯ç›´æ¥å°†æ•°æ®ç¼–ç åœ¨æŒ‡é’ˆä¸­ã€‚è¿™ç§è®¾è®¡ä¸ä»…å®Œç¾åœ°ä¿è¯äº†æ•°æ®çš„å®Œæ•´æ€§å’Œè®¿é—®æ•ˆç‡ï¼Œè¿˜é€šè¿‡æ¶ˆé™¤å †å†…å­˜åˆ†é…ã€å¼•ç”¨è®¡æ•°ç®¡ç†ç­‰å¼€é”€ï¼Œå®ç°äº†å†…å­˜ä½¿ç”¨çš„æè‡´ä¼˜åŒ–ã€‚</p><p>è™½ç„¶ NSNumber çš„æºç æœªå¼€æºï¼Œä½†æˆ‘é€šè¿‡æ·±å…¥åˆ†æ <code>objc_runtime</code> æºç ï¼Œè¿˜æ˜¯æ‰¾åˆ°äº†ä¸€äº›å…³é”®çš„å…¥å£å‡½æ•°ã€‚è¿™äº›å‡½æ•°æ­ç¤ºäº† Tagged Pointer çš„åº•å±‚è¿ä½œæœºåˆ¶ï¼ŒåŒ…æ‹¬æ•°æ®æ··æ·†(å…¶å®å°±æ˜¯å¯åŠ¨çš„æ—¶å€™ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼Œç„¶åè¿›è¡Œå¼‚æˆ– ^ è¿ç®—)ä»¥åŠ Tag å’Œ Data çš„å­˜å‚¨ä½ç½®ç­‰æ ¸å¿ƒå®ç°ç»†èŠ‚ã€‚ä»¥ä¸‹æ˜¯å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å‡½æ•°ï¼Œç¢äºç¯‡å¹…è¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ä¸‹è½½ <a href="https://github.com/apple-oss-distributions/objc4/tree/objc4-906">runtime</a> è‡ªè¡Œç ”ç©¶ï¼Œå®ƒä»¬å…±åŒæ„æˆäº† Tagged Pointer çš„åŸºç¡€æ¡†æ¶ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">isTaggedPointer =&gt; åˆ¤æ–­æ˜¯å¦æ˜¯ Tagged Pointer</span><br><span class="line">_objc_makeTaggedPointer =&gt; ç”Ÿæˆ Tagged Pointer</span><br><span class="line">_objc_getTaggedPointerTag =&gt; è·å– Tag</span><br><span class="line">_objc_getTaggedPointerValue =&gt; è·å– Value</span><br><span class="line">initializeTaggedPointerObfuscator =&gt; runtime å¯åŠ¨æ—¶åˆå§‹åŒ– Tagged Pointer æ··æ·†å™¨</span><br></pre></td></tr></table></figure><h3 id="Tagged-Pointer-çš„ç±»å‹ç¼–ç "><a href="#Tagged-Pointer-çš„ç±»å‹ç¼–ç " class="headerlink" title="Tagged Pointer çš„ç±»å‹ç¼–ç "></a>Tagged Pointer çš„ç±»å‹ç¼–ç </h3><p>åœ¨ Tagged Pointer ä¸­ï¼Œç³»ç»Ÿä½¿ç”¨ç‰¹å®šçš„ä½æ¥ç¼–ç å¯¹è±¡ç±»å‹å’Œæ•°æ®ç±»å‹ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„ç¼–ç å¯¹ç…§è¡¨ï¼š</p><h4 id="å¯¹è±¡ç±»å‹ç¼–ç "><a href="#å¯¹è±¡ç±»å‹ç¼–ç " class="headerlink" title="å¯¹è±¡ç±»å‹ç¼–ç "></a>å¯¹è±¡ç±»å‹ç¼–ç </h4><p>å¯¹è±¡ç±»å‹ç¼–ç å­˜å‚¨åœ¨æŒ‡é’ˆçš„ç¬¬ 2-5 ä½ã€‚</p><table><thead><tr><th align="center">å€¼</th><th align="center">å¯¹è±¡ç±»å‹</th></tr></thead><tbody><tr><td align="center">2</td><td align="center">NSString</td></tr><tr><td align="center">3</td><td align="center">NSNumber</td></tr><tr><td align="center">4</td><td align="center">NSIndexPath</td></tr><tr><td align="center">5</td><td align="center">NSManagedObjectID</td></tr><tr><td align="center">6</td><td align="center">NSDate</td></tr></tbody></table><h4 id="æ•°æ®ç±»å‹ç¼–ç "><a href="#æ•°æ®ç±»å‹ç¼–ç " class="headerlink" title="æ•°æ®ç±»å‹ç¼–ç "></a>æ•°æ®ç±»å‹ç¼–ç </h4><p>æ•°æ®ç±»å‹ç¼–ç å­˜å‚¨åœ¨æŒ‡é’ˆçš„æœ€å4ä½ã€‚</p><table><thead><tr><th align="center">å€¼</th><th align="center">æ•°æ®ç±»å‹</th></tr></thead><tbody><tr><td align="center">0</td><td align="center">char</td></tr><tr><td align="center">1</td><td align="center">short</td></tr><tr><td align="center">2</td><td align="center">int</td></tr><tr><td align="center">3</td><td align="center">long</td></tr><tr><td align="center">4</td><td align="center">float</td></tr><tr><td align="center">5</td><td align="center">double</td></tr><tr><td align="center">6</td><td align="center">long long</td></tr></tbody></table><h2 id="åˆ¤æ–­-Tagged-Pointer-çš„åŸç†"><a href="#åˆ¤æ–­-Tagged-Pointer-çš„åŸç†" class="headerlink" title="åˆ¤æ–­ Tagged Pointer çš„åŸç†"></a>åˆ¤æ–­ Tagged Pointer çš„åŸç†</h2><p>ç³»ç»Ÿæ˜¯å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªæŒ‡é’ˆæ˜¯å¦æ˜¯ Tagged Pointer çš„å‘¢ï¼Ÿå…¶å®ï¼Œåœ¨ <a href="https://github.com/apple-oss-distributions/objc4/tree/objc4-906">objc4-906</a> æºç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ° <code>isTaggedPointer</code> çš„å®ç°ç»†èŠ‚ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isTaggedPointer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _objc_isTaggedPointer(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _OBJC_TAG_MASK (1UL&lt;&lt;63)</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> _objc_isTaggedPointer(<span class="type">void</span> *ptr) &#123;</span><br><span class="line">    <span class="keyword">return</span> ((<span class="type">uintptr_t</span>)ptr &amp; _OBJC_TAG_MASK) == _OBJC_TAG_MASK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œç³»ç»Ÿé€šè¿‡ä½è¿ç®— <code>&amp;</code> æ“ä½œè·å–æŒ‡é’ˆçš„æœ€é«˜ä½ï¼Œå¹¶ä¸ <code>_OBJC_TAG_MASK</code>ï¼ˆ1UL&lt;&lt;63ï¼Œå³æœ€é«˜ä½ä¸º1çš„æ©ç ï¼‰è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœç»“æœç­‰äº <code>_OBJC_TAG_MASK</code>ï¼Œå°±è¡¨ç¤ºè¿™ä¸ªæŒ‡é’ˆæ˜¯ä¸€ä¸ª Tagged Pointer(ç®€å•çš„è¯´å°±æ˜¯åˆ¤æ–­æŒ‡é’ˆçš„ç¬¬ä¸€ä½æ˜¯å¦ä¸º1)ã€‚è¿™ç§åˆ¤æ–­æ–¹å¼ç®€å•é«˜æ•ˆï¼Œåªéœ€è¦ä¸€æ¬¡ä½è¿ç®—å°±èƒ½å®Œæˆåˆ¤æ–­ã€‚</p><h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><p>è™½ç„¶æˆ‘ä»¬ä¸€èˆ¬ä¸éœ€è¦å…³å¿ƒ Tagged Pointer çš„å…·ä½“å®ç°ç»†èŠ‚ï¼Œä½†åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­è¿˜æ˜¯æœ‰ä¸€äº›éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼š</p><ul><li><p>Tagged Pointer ä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ ObjC å¯¹è±¡ï¼Œå®ƒæ²¡æœ‰å¸¸è§„å¯¹è±¡æ‰€å…·æœ‰çš„ <code>isa</code> æŒ‡é’ˆã€‚å› æ­¤ï¼Œä¸è¦å°è¯•ç›´æ¥è®¿é—®æˆ–æ“ä½œå…¶ isa æŒ‡é’ˆï¼Œåº”è¯¥å§‹ç»ˆé€šè¿‡ç³»ç»Ÿæä¾›çš„å…¬å¼€æ¥å£æ¥æ“ä½œè¿™äº›å¯¹è±¡ã€‚</p></li><li><p>å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œåœ¨ç°ä»£ Xcode ç‰ˆæœ¬ä¸­ï¼Œè‹¹æœå¯¹ Tagged Pointer å®ç°äº†æ•°æ®æ··æ·†æœºåˆ¶ã€‚è¿™æ„å‘³ç€å³ä½¿ä½ é€šè¿‡æŸç§æ–¹å¼è·å–åˆ°äº†æŒ‡é’ˆçš„åŸå§‹å€¼ï¼Œä¹Ÿæ— æ³•ç›´æ¥è§£æå‡ºå…¶ä¸­å­˜å‚¨çš„æ•°æ®ã€‚æ­£ç¡®çš„åšæ³•æ˜¯ä½¿ç”¨æ¡†æ¶æä¾›çš„æ ‡å‡†æ–¹æ³•æ¥è®¿é—®æ•°æ®ã€‚</p></li><li><p>Tagged Pointer çš„å…·ä½“å®ç°ç»†èŠ‚å¯èƒ½ä¼šéšç€ç³»ç»Ÿç‰ˆæœ¬çš„æ›´æ–°è€Œæ”¹å˜ã€‚å› æ­¤ï¼Œä¸è¦åœ¨ä»£ç ä¸­ä¾èµ–å…¶å½“å‰çš„å®ç°æ–¹å¼ï¼ˆå¦‚ä½ç¼–ç è§„åˆ™ï¼‰ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ä½ çš„åº”ç”¨åœ¨æœªæ¥çš„ç³»ç»Ÿç‰ˆæœ¬ä¸­å‡ºç°å…¼å®¹æ€§é—®é¢˜ã€‚</p></li><li><p>åœ¨è¿›è¡Œå†…å­˜è°ƒè¯•æˆ–æ€§èƒ½åˆ†ææ—¶ï¼Œè¦æ³¨æ„ Tagged Pointer å¯¹è±¡çš„ç‰¹æ®Šæ€§ã€‚å®ƒä»¬ä¸ä¼šå‡ºç°åœ¨å¸¸è§„çš„å†…å­˜åˆ†é…ç»Ÿè®¡ä¸­ï¼Œå› ä¸ºå®ƒä»¬å®é™…ä¸Šå¹¶ä¸å ç”¨å †å†…å­˜ã€‚</p></li></ul><p>å…³äº Tagged Pointer æœ‰ä¸€ä¸ªé¢è¯•é¢˜ï¼Œç¢äºç¯‡å¹…ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ä¸€ä¸‹ <a href="https://juejin.cn/post/6844904132940136462#heading-16">è€ç”Ÿå¸¸è°ˆå†…å­˜ç®¡ç†</a> ä¸­çš„ â€œç›¸å…³é¢˜ç›®â€ ç« èŠ‚ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://juejin.cn/post/6844904132940136462">è€ç”Ÿå¸¸è°ˆå†…å­˜ç®¡ç†ï¼šTagged Pointer</a></li><li><a href="https://blog.devtang.com/2014/05/30/understand-tagged-pointer/">æ·±å…¥ç†è§£Tagged Pointer Â· å”å·§çš„åšå®¢</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…å­˜ç®¡ç† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AutoreleasePoolï¼šiOS å†…å­˜ç®¡ç†ä¹ç« ä¸­çš„éšç§˜æ—‹å¾‹</title>
      <link href="/2025/03/30/iOS/AutoreleasePool%EF%BC%9AiOS%20%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E4%B9%90%E7%AB%A0%E4%B8%AD%E7%9A%84%E9%9A%90%E7%A7%98%E6%97%8B%E5%BE%8B/"/>
      <url>/2025/03/30/iOS/AutoreleasePool%EF%BC%9AiOS%20%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E4%B9%90%E7%AB%A0%E4%B8%AD%E7%9A%84%E9%9A%90%E7%A7%98%E6%97%8B%E5%BE%8B/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç”± å¸ƒå¤š(budo) å‘å¸ƒäº 2025-03-30</p></blockquote><h2 id="æ­å¼€-AutoreleasePool-çš„é¢çº±"><a href="#æ­å¼€-AutoreleasePool-çš„é¢çº±" class="headerlink" title="æ­å¼€ AutoreleasePool çš„é¢çº±"></a>æ­å¼€ AutoreleasePool çš„é¢çº±</h2><p>AutoreleasePoolï¼ˆä¸­æ–‡ä¹Ÿå«è‡ªåŠ¨é‡Šæ”¾æ± ï¼‰æ˜¯ iOS å†…å­˜ç®¡ç†æœºåˆ¶ä¸­çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ã€‚å®ƒä¼˜é›…åœ°è§£å†³äº†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„é—®é¢˜ - é€šè¿‡å»¶è¿Ÿå¯¹è±¡çš„é‡Šæ”¾æ—¶æœºï¼Œåœ¨åˆé€‚çš„æ—¶é—´ç‚¹ç»Ÿä¸€å›æ”¶å†…å­˜èµ„æºã€‚</p><p>è¿™ä¸ªç²¾å¦™çš„è®¾è®¡èƒŒåæœ‰ç€æ€æ ·çš„å®ç°åŸç†å‘¢ï¼Ÿè®©æˆ‘ä»¬ä¸€èµ·æ·±å…¥ <a href="https://github.com/apple-oss-distributions/objc4/">objc4</a> å¼€æºé¡¹ç›®çš„æºç ï¼Œå»æ¢ç´¢ AutoreleasePool çš„åº•å±‚å®ç°ç»†èŠ‚ã€‚</p><blockquote><p>ğŸ“ æœ¬æ–‡ä½¿ç”¨çš„ Runtime ç‰ˆæœ¬æ˜¯ <a href="https://github.com/apple-oss-distributions/objc4/tree/objc4-906">objc4-906</a>ã€‚ä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œæˆ‘å¯¹ä»£ç æ ·å¼å’Œæ’ç‰ˆç•¥ä½œäº†ä¿®æ”¹ï¼Œå¹¶åˆ å‡äº†ä¸€äº›ä¸å½±å“ä¸»é€»è¾‘çš„å†—ä½™ä»£ç ã€‚</p><p>ğŸ”§ æˆ‘åœ¨ <a href="https://github.com/internetWei/ObjCRuntimes">è¿™é‡Œ</a> ç»´æŠ¤äº†ä¸€ä¸ªå¯ä»¥ç›´æ¥è¿è¡Œè°ƒè¯•çš„ Runtime é¡¹ç›®ï¼Œæ¬¢è¿å¤§å®¶ä¸‹è½½è°ƒè¯•æºç ã€‚</p></blockquote><h2 id="æ·±å…¥åº•å±‚ï¼šAutoreleasePool-çš„å®ç°æœºåˆ¶"><a href="#æ·±å…¥åº•å±‚ï¼šAutoreleasePool-çš„å®ç°æœºåˆ¶" class="headerlink" title="æ·±å…¥åº•å±‚ï¼šAutoreleasePool çš„å®ç°æœºåˆ¶"></a>æ·±å…¥åº•å±‚ï¼šAutoreleasePool çš„å®ç°æœºåˆ¶</h2><p>åœ¨ ARC ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ä½œä¸ºå¼€å‘è€…èƒ½å¤Ÿæ¥è§¦åˆ° AutoreleasePool çš„åœºæ™¯ä¸»è¦æœ‰ä¸¤ç§ï¼š</p><ol><li><p>ä½¿ç”¨ <code>__autoreleasing</code> ä¿®é¥°ç¬¦</p><ul><li>å°†å¯¹è±¡æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­</li><li>å®ç°å¯¹è±¡çš„å»¶è¿Ÿé‡Šæ”¾æœºåˆ¶</li></ul></li><li><p>ä½¿ç”¨ <code>@autoreleasepool &#123;&#125;</code> è¯­æ³•å—</p><ul><li>ç²¾ç¡®æ§åˆ¶å†…å­˜çš„é‡Šæ”¾æ—¶æœº</li><li>æœ‰æ•ˆæ§åˆ¶å†…å­˜å³°å€¼</li></ul></li></ol><p>è®©æˆ‘ä»¬ä¸€èµ·æ·±å…¥æºç å’Œæ±‡ç¼–å±‚é¢ï¼Œæ­å¼€è¿™ä¸¤ç§ä½¿ç”¨åœºæ™¯èƒŒåçš„æŠ€æœ¯å®ç°ç»†èŠ‚ã€‚</p><h3 id="autoreleasing-ä¿®é¥°ç¬¦çš„å†…éƒ¨å®ç°"><a href="#autoreleasing-ä¿®é¥°ç¬¦çš„å†…éƒ¨å®ç°" class="headerlink" title="__autoreleasing ä¿®é¥°ç¬¦çš„å†…éƒ¨å®ç°"></a>__autoreleasing ä¿®é¥°ç¬¦çš„å†…éƒ¨å®ç°</h3><p><img src="objc_autorelease%E5%85%A5%E5%8F%A3.png"></p><p>ä»æ–­ç‚¹çš„æ±‡ç¼–ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ __autoreleasing ä¿®é¥°ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†å…¶è½¬æ¢ä¸ºå¯¹ objc_autorelease å‡½æ•°çš„è°ƒç”¨ã€‚è¿™ä¸ªæ“ä½œç­‰åŒäºåœ¨ MRC ç¯å¢ƒä¸‹æ‰‹åŠ¨è°ƒç”¨å¯¹è±¡çš„ autorelease æ–¹æ³•ï¼Œå®ƒä»¬åœ¨åº•å±‚å®ç°ä¸Šæ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚</p><p>è®©æˆ‘ä»¬æ·±å…¥ Runtime æºç ï¼Œä¸€æ¢ objc_autorelease çš„å†…éƒ¨å®ç°ã€‚ä»¥ä¸‹æ˜¯ç»è¿‡æ•´ç†çš„æ ¸å¿ƒä»£ç ï¼ˆå¦‚æœè§‰å¾—ä»£ç å¤ªé•¿å¯ä»¥å…ˆè·³è¿‡ï¼Œåé¢ä¼šæœ‰è¯¦ç»†è§£é‡Šï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">id <span class="title">objc_autorelease</span><span class="params">(id obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> obj-&gt;<span class="built_in">autorelease</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">id <span class="title">objc_object::autorelease</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">     æ£€æŸ¥è¯¥å¯¹è±¡æ˜¯å¦æœ‰è‡ªå®šä¹‰çš„å¼•ç”¨è®¡æ•°(RR = Retain/Release)å®ç°ï¼Œ</span></span><br><span class="line"><span class="comment">     ARC è‚¯å®šæ²¡æœ‰ï¼ŒMRC ä¸€èˆ¬ä¹Ÿä¸ä¼šè‡ªå®šä¹‰è¿™äº›æ–¹æ³•å®ç°ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fastpath</span>(!<span class="built_in">ISA</span>()-&gt;<span class="built_in">hasCustomRR</span>())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">rootAutorelease</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">objc_msgSend</span>(<span class="keyword">this</span>, @<span class="built_in">selector</span>(autorelease));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">id <span class="title">objc_object::rootAutorelease</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå¯¹è±¡æ­£åœ¨é‡Šæ”¾ï¼Œä¸è¦åŠ å…¥åˆ° AutoreleasePool ä¸­ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isa</span>().<span class="built_in">isDeallocating</span>()) <span class="keyword">return</span> (id)<span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      å¦‚æœå¯¹è±¡æœ‰ä½¿ç”¨è¿”å›å€¼ä¼˜åŒ–çš„è¯ï¼Œä¸è¦åŠ å…¥åˆ° AutoreleasePool ä¸­ã€‚</span></span><br><span class="line"><span class="comment">      åé¢çš„ç« èŠ‚ã€Šæ€§èƒ½ä¼˜åŒ–ï¼šTLS æœºåˆ¶è§£æã€‹ä¼šå¯¹è¯¥æœºåˆ¶è¿›è¡Œè¯´æ˜ã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">prepareOptimizedReturn</span>((id)<span class="keyword">this</span>, <span class="literal">true</span>, ReturnAtPlus1)) <span class="keyword">return</span> (id)<span class="keyword">this</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ç±»å¯¹è±¡ï¼Œä¸è¦åŠ å…¥åˆ° AutoreleasePool ä¸­ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">slowpath</span>(<span class="built_in">isClass</span>())) <span class="keyword">return</span> (id)<span class="keyword">this</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">rootAutorelease2</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">id <span class="title">objc_object::rootAutorelease2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> AutoreleasePoolPage::<span class="built_in">autorelease</span>((id)<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼šä»è¿™é‡Œå¼€å§‹ï¼Œåé¢éƒ½æ˜¯ AutoreleasePoolPage çš„å†…éƒ¨å‡½æ•°ã€‚</span></span><br><span class="line"><span class="function"><span class="type">static</span> id <span class="title">autorelease</span><span class="params">(id obj)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">autoreleaseFast</span>(obj);</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">id *<span class="title">autoreleaseFast</span><span class="params">(id obj)</span> </span>&#123;</span><br><span class="line">    AutoreleasePoolPage *page = <span class="built_in">hotPage</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (page &amp;&amp; !page-&gt;<span class="built_in">full</span>()) &#123;</span><br><span class="line">        <span class="comment">// å½“å‰é¡µæœªæ»¡ï¼Œç›´æ¥æ·»åŠ </span></span><br><span class="line">        <span class="keyword">return</span> page-&gt;<span class="built_in">add</span>(obj);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (page) &#123;</span><br><span class="line">        <span class="comment">// å½“å‰é¡µå·²æ»¡ï¼Œåˆ›å»ºæ–°é¡µæ·»åŠ </span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">autoreleaseFullPage</span>(obj, page);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å½“å‰çº¿ç¨‹ä¸­è¿˜æ²¡æœ‰ Pageï¼Œåˆ›å»ºä¸€ä¸ªå¹¶æ·»åŠ å¯¹è±¡ã€‚</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">autoreleaseNoPage</span>(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">id *<span class="title">add</span><span class="params">(id obj)</span> </span>&#123;</span><br><span class="line">    id *ret;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ä¸‹é¢çš„è¿™æ®µä»£ç çš„é€»è¾‘å¤§è‡´æ˜¯ï¼šå¦‚æœå¯ç”¨äº†å¯¹è±¡åˆå¹¶ä¼˜åŒ–æ–¹æ¡ˆï¼Œ</span></span><br><span class="line"><span class="comment">    åˆ™å°†é‡å¤è°ƒç”¨ autorelease çš„å¯¹è±¡è¿›è¡Œåˆå¹¶ï¼Œ</span></span><br><span class="line"><span class="comment">    è¿™ä¹ˆåšçš„ç›®çš„æ˜¯ä¸ºäº†å‡å°‘åŒä¸€ä¸ªå¯¹è±¡è¢«å¤šæ¬¡é‡å¤çš„æ·»åŠ åˆ°è‡ªåŠ¨é‡Šæ”¾æ± ã€‚</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    ä¸€èˆ¬è¿™ç§åœºæ™¯ä¼šå‡ºç°åœ¨å¾ªç¯ä¸­ï¼Œä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼Œ</span></span><br><span class="line"><span class="comment">    å¦‚æœæœªä¼˜åŒ–çš„è¯å°±ä¼šåœ¨ Page ä¸­å­˜æ”¾ 10 ä¸ª Person å¯¹è±¡ï¼›</span></span><br><span class="line"><span class="comment">    ä¼˜åŒ–ååªä¼šå­˜æ”¾ 1 ä¸ª Person å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    for (int i = 0; i &lt; 10; i++) &#123;</span></span><br><span class="line"><span class="comment">        __autoreleasing Person *per = [[Person alloc] init];</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (!DisableAutoreleaseCoalescing || </span><br><span class="line">        !DisableAutoreleaseCoalescingLRU) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!DisableAutoreleaseCoalescingLRU) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">empty</span>() &amp;&amp; (obj != POOL_BOUNDARY)) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                è·å– Page æœ€åçš„å­˜å‚¨å¯¹è±¡ï¼Œæ£€æŸ¥ä¸å½“å‰å¯¹è±¡æ˜¯å¦ç›¸åŒï¼Œ</span></span><br><span class="line"><span class="comment">                å¦‚æœç›¸åŒåˆ™è¿›è¡Œåˆå¹¶ã€‚</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                AutoreleasePoolEntry *topEntry = (AutoreleasePoolEntry *)next - <span class="number">1</span>;</span><br><span class="line">                <span class="comment">// å‘å‰æœ€å¤šæŸ¥æ‰¾ 4 ä¸ªå¯¹è±¡</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">uintptr_t</span> offset = <span class="number">0</span>; offset &lt; <span class="number">4</span>; offset++) &#123;</span><br><span class="line">                    AutoreleasePoolEntry *offsetEntry = topEntry - offset;</span><br><span class="line">                    <span class="comment">// æ£€æŸ¥æ˜¯å¦è¶Šç•Œæˆ–é‡åˆ°æ± è¾¹ç•Œï¼ˆPOOL_BOUNDARYï¼‰</span></span><br><span class="line">                    <span class="keyword">if</span> (offsetEntry &lt;= (AutoreleasePoolEntry*)<span class="built_in">begin</span>() || </span><br><span class="line">                        *(id *)offsetEntry == POOL_BOUNDARY) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// æ‰¾åˆ°ç›¸åŒçš„å¯¹è±¡ä¸”è®¡æ•°æœªè¾¾ä¸Šé™</span></span><br><span class="line">                    <span class="keyword">if</span> (offsetEntry-&gt;<span class="built_in">getPointer</span>() == (<span class="type">uintptr_t</span>)obj &amp;&amp; </span><br><span class="line">                        offsetEntry-&gt;<span class="built_in">getCount</span>() &lt; AutoreleasePoolEntry::maxCount) &#123;</span><br><span class="line">                        <span class="comment">// é€šè¿‡å†…å­˜ç§»åŠ¨ï¼Œå°†åŒ¹é…çš„å¯¹è±¡ç§»åŠ¨åˆ°æ± é¡¶ã€‚</span></span><br><span class="line">                        <span class="keyword">if</span> (offset &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            AutoreleasePoolEntry found = *offsetEntry;</span><br><span class="line">                            <span class="built_in">memmove</span>(offsetEntry, offsetEntry + <span class="number">1</span>, offset * <span class="built_in">sizeof</span>(*offsetEntry));</span><br><span class="line">                            *topEntry = found;</span><br><span class="line">                        &#125;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// å¢åŠ è¿™ä¸ªå¯¹è±¡çš„è®¡æ•°ã€‚</span></span><br><span class="line">                        topEntry-&gt;<span class="built_in">incrementCount</span>();</span><br><span class="line">                        ret = (id *)topEntry;</span><br><span class="line">                        <span class="keyword">goto</span> done;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">empty</span>() &amp;&amp; (obj != POOL_BOUNDARY)) &#123;</span><br><span class="line">                <span class="comment">// ä»…æ£€æŸ¥æ± é¡¶å‰ä¸€ä¸ªå¯¹è±¡å’Œå½“å‰å¯¹è±¡æ˜¯å¦ä¸€è‡´ã€‚</span></span><br><span class="line">                AutoreleasePoolEntry *prevEntry = (AutoreleasePoolEntry *)next - <span class="number">1</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// ç›´æ¥åˆå¹¶åˆ°å‰ä¸€ä¸ªå¯¹è±¡ã€‚</span></span><br><span class="line">                <span class="keyword">if</span> (prevEntry-&gt;<span class="built_in">getPointer</span>() == (<span class="type">uintptr_t</span>)obj &amp;&amp; </span><br><span class="line">                    prevEntry-&gt;<span class="built_in">getCount</span>() &lt; AutoreleasePoolEntry::maxCount) &#123;</span><br><span class="line">                    prevEntry-&gt;<span class="built_in">incrementCount</span>();</span><br><span class="line">                    ret = (id *)prevEntry;</span><br><span class="line">                    <span class="keyword">goto</span> done;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = next;</span><br><span class="line">    *next++ = obj;</span><br><span class="line"></span><br><span class="line"> done:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">id *<span class="title">autoreleaseFullPage</span><span class="params">(id obj, AutoreleasePoolPage *page)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    è·å–ä¸‹ä¸€ä¸ª Page å¯¹è±¡ï¼Œ</span></span><br><span class="line"><span class="comment">    å¦‚æœå®ƒä¸å­˜åœ¨æˆ–è€…å­˜æ»¡äº†å°±åˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (page-&gt;child) page = page-&gt;child;</span><br><span class="line">        <span class="keyword">else</span> page = <span class="keyword">new</span> <span class="built_in">AutoreleasePoolPage</span>(page);</span><br><span class="line">    &#125; <span class="keyword">while</span> (page-&gt;<span class="built_in">full</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°†å½“å‰ Page è®¾ç½®ä¸º hotã€‚</span></span><br><span class="line">    <span class="built_in">setHotPage</span>(page);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°†å¯¹è±¡æ·»åŠ åˆ° Page ä¸­ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> page-&gt;<span class="built_in">add</span>(obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">id *<span class="title">autoreleaseNoPage</span><span class="params">(id obj)</span> </span>&#123;</span><br><span class="line">    <span class="type">bool</span> pushExtraBoundary = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     é¦–æ¬¡åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± æ—¶ï¼Œä¼šç”¨ä¸€ä¸ªå ä½ç¬¦è¡¨ç¤ºç©ºæ± ã€‚</span></span><br><span class="line"><span class="comment">     æ­¤æ—¶è‹¥æ·»åŠ å¯¹è±¡ï¼Œéœ€å…ˆè¡¥ä¸€ä¸ªè¾¹ç•Œã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">haveEmptyPoolPlaceholder</span>()) &#123;</span><br><span class="line">        pushExtraBoundary = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç›´æ¥ä½¿ç”¨ç©ºå ä½ç¬¦ï¼Œé¿å…åˆ›å»ºçœŸå®çš„æ± ç»“æ„ã€‚</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (obj == POOL_BOUNDARY) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">setEmptyPoolPlaceholder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ª Pageï¼Œå¹¶è®¾ç½®ä¸º hotã€‚</span></span><br><span class="line">    AutoreleasePoolPage *page = <span class="keyword">new</span> <span class="built_in">AutoreleasePoolPage</span>(nil);</span><br><span class="line">    <span class="built_in">setHotPage</span>(page);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (pushExtraBoundary) &#123;</span><br><span class="line">        page-&gt;<span class="built_in">add</span>(POOL_BOUNDARY);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> page-&gt;<span class="built_in">add</span>(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„å‡½æ•°è°ƒç”¨æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">objc_autorelease</span><br><span class="line">â””â”€â”€ autorelease</span><br><span class="line">    â””â”€â”€ rootAutorelease</span><br><span class="line">        â””â”€â”€ rootAutorelease2</span><br><span class="line">            â””â”€â”€ AutoreleasePoolPage::autorelease</span><br><span class="line">                â””â”€â”€ AutoreleasePoolPage::autoreleaseFast</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä»£ç åˆ†æä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“ä¸€ä¸ªå¯¹è±¡è¢«æ ‡è®°ä¸º autoreleasing æ—¶ï¼Œç³»ç»Ÿä¼šé€šè¿‡ä¸€ç³»åˆ—å‡½æ•°è°ƒç”¨æœ€ç»ˆå°†å…¶åŠ å…¥åˆ° AutoreleasePoolPage ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸»è¦ç”± autoreleaseFast å‡½æ•°å®Œæˆï¼Œå®ƒè´Ÿè´£ç®¡ç†å¯¹è±¡çš„å…·ä½“å­˜å‚¨å·¥ä½œã€‚åœ¨ autoreleaseFast å‡½æ•°å†…éƒ¨ï¼Œç³»ç»Ÿä¼šè·å–å½“å‰çº¿ç¨‹çš„ hotPageï¼ˆæ‰€è°“çš„ hotPageï¼Œå…¶å®å°±æ˜¯åŒå‘é“¾è¡¨çš„å°¾èŠ‚ç‚¹ï¼‰ï¼Œç„¶åæ ¹æ® page çŠ¶æ€å†³å®šæ‰§è¡Œé€»è¾‘ï¼š</p><table><thead><tr><th>åœºæ™¯</th><th>çŠ¶æ€</th><th>æ‰§è¡Œé€»è¾‘</th></tr></thead><tbody><tr><td>é€»è¾‘ä¸€</td><td>page å­˜åœ¨ä¸”æœªæ»¡</td><td>ç›´æ¥è°ƒç”¨ add å‡½æ•°å°†å¯¹è±¡æ·»åŠ åˆ° Page ä¸­</td></tr><tr><td>é€»è¾‘äºŒ</td><td>page å­˜åœ¨ä½†å·²æ»¡</td><td>è°ƒç”¨ autoreleaseFullPage åˆ›å»ºæ–° Pageï¼Œç„¶åæ·»åŠ å¯¹è±¡</td></tr><tr><td>é€»è¾‘ä¸‰</td><td>page ä¸å­˜åœ¨</td><td>ç›´æ¥åˆ›å»ºæ–° Pageï¼Œç„¶åæ·»åŠ å¯¹è±¡</td></tr></tbody></table><p>è¿™é‡Œæœ‰ä¸€ä¸ªæœ‰è¶£çš„ä¼˜åŒ–ç»†èŠ‚ï¼šç³»ç»Ÿå¹¶ä¸æ˜¯ç›´æ¥å­˜æ”¾å¯¹è±¡çš„åœ°å€ï¼Œè€Œæ˜¯å°†å…¶åŒ…è£…æˆä¸€ä¸ª AutoreleasePoolEntry å¯¹è±¡ã€‚è¿™æ ·è®¾è®¡çš„åŸå› åœ¨äºç³»ç»Ÿé‡‡ç”¨äº† â€œå¯¹è±¡åˆå¹¶ä¼˜åŒ–â€ æ–¹æ¡ˆ - å½“å¤šä¸ªç›¸åŒå¯¹è±¡è¢«é‡å¤åŠ å…¥ Page æ—¶ï¼Œç³»ç»Ÿåªä¼šä¿ç•™ç¬¬ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶é€šè¿‡ count å€¼è®°å½•è¯¥å¯¹è±¡è¢«é‡å¤åŠ å…¥çš„æ¬¡æ•°ã€‚è¿™ç§ä¼˜åŒ–å¯ä»¥æœ‰æ•ˆå‡å°‘å†…å­˜å ç”¨ï¼ˆå…·ä½“ç»†èŠ‚è¯·é˜…è¯»ä¸Šé¢çš„ add å‡½æ•°ï¼‰ã€‚</p><p>è‡³æ­¤ï¼Œautoreleasing å¯¹è±¡å°±å®Œæˆäº†å®ƒè¿›å…¥ AutoreleasePool çš„å…¨è¿‡ç¨‹ã€‚</p><p>åœ¨ä¸Šè¿°å®ç°ä¸­ï¼Œæœ‰ä¸€ä¸ªæ ¸å¿ƒç±»å‹å€¼å¾—æˆ‘ä»¬ç‰¹åˆ«å…³æ³¨ - AutoreleasePoolPageã€‚ä½œä¸ºå­˜å‚¨æ•°æ®çš„åº•å±‚ç»“æ„ï¼Œå®ƒåœ¨æ•´ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± æœºåˆ¶ä¸­æ‰®æ¼”ç€è‡³å…³é‡è¦çš„è§’è‰²ã€‚æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ·±å…¥åˆ†æè¿™ä¸ªå…³é”®ç»„ä»¶ã€‚</p><h3 id="AutoreleasePoolPageï¼šå†…å­˜ç®¡ç†çš„åŸºçŸ³"><a href="#AutoreleasePoolPageï¼šå†…å­˜ç®¡ç†çš„åŸºçŸ³" class="headerlink" title="AutoreleasePoolPageï¼šå†…å­˜ç®¡ç†çš„åŸºçŸ³"></a>AutoreleasePoolPageï¼šå†…å­˜ç®¡ç†çš„åŸºçŸ³</h3><p>è®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ AutoreleasePoolPage è¿™ä¸ªæ ¸å¿ƒç±»çš„å†…éƒ¨ç»“æ„ã€‚ä¸ºäº†ä¾¿äºç†è§£ï¼Œæˆ‘å¯¹æºç è¿›è¡Œäº†ç²¾ç®€å’Œæ³¨é‡Šï¼Œä¿ç•™äº†æœ€å…³é”®çš„éƒ¨åˆ†ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AutoreleasePoolPage</span> &#123;</span><br><span class="line">    <span class="type">magic_t</span> magic;                <span class="comment">// é­”æ•°ï¼Œç”¨äºæ ¡éªŒ Page çš„æœ‰æ•ˆæ€§å’Œå®Œæ•´æ€§</span></span><br><span class="line">    __unsafe_unretained id *next; <span class="comment">// æŒ‡å‘å½“å‰ Page ä¸­ä¸‹ä¸€ä¸ªå¯ç”¨çš„å­˜å‚¨ä½ç½®</span></span><br><span class="line">    <span class="type">objc_thread_t</span> thread;         <span class="comment">// å½“å‰ Page æ‰€å±çš„çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ AutoreleasePool</span></span><br><span class="line">    AutoreleasePoolPage *parent;  <span class="comment">// æŒ‡å‘åŒå‘é“¾è¡¨ä¸­çš„å‰ä¸€ä¸ª Page</span></span><br><span class="line">    AutoreleasePoolPage *child;   <span class="comment">// æŒ‡å‘åŒå‘é“¾è¡¨ä¸­çš„åä¸€ä¸ª Page</span></span><br><span class="line">    <span class="type">uint32_t</span> depth;               <span class="comment">// å½“å‰ Page åœ¨åŒå‘é“¾è¡¨ä¸­çš„æ·±åº¦ï¼Œä» 0 å¼€å§‹</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     ç”¨äºæ€§èƒ½è°ƒè¯•å’Œç›‘æ§ã€‚è®°å½• AutoreleasePool å†å²å­˜å‚¨å¯¹è±¡æ•°é‡çš„æœ€å¤§å€¼ã€‚</span></span><br><span class="line"><span class="comment">     ç›®å‰çš„é€»è¾‘æ˜¯å½“å¯¹è±¡æ•°é‡è¶…è¿‡é˜ˆå€¼(256)æ—¶ï¼Œä¼šè§¦å‘æ—¥å¿—è®°å½•ï¼ŒåŒ…å«ï¼š</span></span><br><span class="line"><span class="comment">     - å½“å‰çº¿ç¨‹ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     - å¯¹è±¡å­˜å‚¨æ•°é‡</span></span><br><span class="line"><span class="comment">     - å®Œæ•´è°ƒç”¨æ ˆ</span></span><br><span class="line"><span class="comment">     è¿™äº›ä¿¡æ¯æœ‰åŠ©äºæ’æŸ¥å†…å­˜ä½¿ç”¨å¼‚å¸¸çš„æƒ…å†µã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">uint32_t</span> hiwat;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Page å¤§å°å›ºå®šä¸º 4KB(4096å­—èŠ‚)ï¼Œä¸ç³»ç»Ÿå†…å­˜é¡µå¤§å°å¯¹é½</span></span><br><span class="line">    <span class="type">static</span> <span class="type">size_t</span> <span class="type">const</span> SIZE = <span class="number">1</span> &lt;&lt; <span class="number">12</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é‡å†™ new æ“ä½œç¬¦ï¼Œç¡®ä¿åˆ†é…çš„å†…å­˜æŒ‰ SIZE å¯¹é½</span></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> * <span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="type">size_t</span> size)</span> </span>&#123;</span><br><span class="line">        <span class="type">void</span> *result = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> r = <span class="built_in">posix_memalign</span>(&amp;result, SIZE, SIZE);</span><br><span class="line">        <span class="built_in">ASSERT</span>(r == <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ›´ç›´è§‚åœ°ç†è§£ AutoreleasePoolPage çš„å†…å­˜ç»“æ„ï¼Œæˆ‘ç»˜åˆ¶äº†ä¸€å¼ ç®€å›¾ï¼š</p><p><img src="AutoreleasePoolPage%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84%E5%9B%BE.png"></p><p>ç»“åˆ AutoreleasePoolPage çš„å†…éƒ¨ç»“æ„å’Œå‰é¢åˆ†æçš„å‡½æ•°æ‰§è¡Œæµç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ¸…æ™°åœ°ç†è§£ AutoreleasePool çš„åº•å±‚å®ç°ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ™®é€šçš„åŒå‘é“¾è¡¨ç»“æ„ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ª AutoreleasePoolPage å¯¹è±¡ã€‚è¿™äº›å¯¹è±¡é€šè¿‡ parent å’Œ child æŒ‡é’ˆç›¸äº’è¿æ¥ï¼Œå½¢æˆäº†ä¸€ä¸ªå®Œæ•´çš„å†…å­˜ç®¡ç†é“¾æ¡ã€‚æ¯ä¸ª Page ä¸ä»…æ‰¿æ‹…ç€èŠ‚ç‚¹çš„è§’è‰²ï¼Œè¿˜è‚©è´Ÿç€æ•°æ®å­˜å‚¨çš„é‡ä»»ï¼Œæ˜¯æ•´ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± æœºåˆ¶çš„æ ¸å¿ƒè½½ä½“ã€‚</p><p>åœ¨å†…å­˜ç®¡ç†çš„å±‚é¢ä¸Šï¼ŒAutoreleasePoolPage çš„è®¾è®¡ä¹Ÿä½“ç°äº†æ·±æ€ç†Ÿè™‘ã€‚é€šè¿‡æŸ¥çœ‹å…¶ new æ–¹æ³•çš„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¯ä¸ª Page çš„å¤§å°è¢«è®¾å®šä¸º 4096 å­—èŠ‚ã€‚è¿™ä¸ªçœ‹ä¼¼éšæ„çš„æ•°å­—å…¶å®æš—å«ç„æœº - å®ƒä¸ç°ä»£æ“ä½œç³»ç»Ÿçš„å†…å­˜é¡µå¤§å°å®Œç¾å¯¹é½ã€‚è¿™ç§è®¾è®¡å¸¦æ¥äº†å¤šé‡ä¼˜åŠ¿ï¼š</p><ul><li>å‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæé«˜å†…å­˜åˆ©ç”¨æ•ˆç‡ï¼›</li><li>å®ç°æ›´é«˜æ•ˆçš„å†…å­˜åˆ†é…ï¼›</li><li>ç¡®ä¿å†…å­˜è®¿é—®çš„è¿ç»­æ€§ï¼Œé™ä½ç³»ç»Ÿä¸­æ–­é¢‘ç‡ï¼›</li><li>ä¼˜åŒ–ç¼“å­˜å‘½ä¸­ç‡ï¼Œæå‡æ•´ä½“æ€§èƒ½ã€‚</li></ul><p>è¿™äº›ç»†èŠ‚çš„ä¼˜åŒ–ï¼Œè®© AutoreleasePool åœ¨å®ç°ä¼˜é›…çš„åŒæ—¶ï¼Œä¹Ÿä¿æŒäº†æé«˜çš„è¿è¡Œæ•ˆç‡ã€‚</p><h3 id="autoreleasepool-çš„ä¼˜é›…ä¹‹é“"><a href="#autoreleasepool-çš„ä¼˜é›…ä¹‹é“" class="headerlink" title="@autoreleasepool çš„ä¼˜é›…ä¹‹é“"></a>@autoreleasepool çš„ä¼˜é›…ä¹‹é“</h3><p><code>@autoreleasepool &#123;&#125;</code> æ˜¯æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ç»å¸¸ä½¿ç”¨çš„å¦ä¸€ä¸ªé‡è¦ç‰¹æ€§ã€‚è¿™ä¸ªçœ‹ä¼¼ç®€å•çš„è¯­æ³•å—èƒŒåï¼Œéšè—ç€ç¼–è¯‘å™¨çš„å·§å¦™è½¬æ¢å’Œ Runtime çš„ç²¾å¯†é…åˆã€‚è®©æˆ‘ä»¬æ­å¼€å®ƒçš„ç¥ç§˜é¢çº±ï¼Œä¸€æ¢å…¶å®ç°åŸç†ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åŸä»£ç ï¼š</span></span><br><span class="line">@autoreleasepool &#123;    </span><br><span class="line">__autoreleasing Person *per = [Person createPerson]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼–è¯‘åï¼š</span></span><br><span class="line">atautoreleasepoolobj = <span class="built_in">objc_autoreleasePoolPush</span>(); <span class="comment">// å¯¹åº” @autorelease &#123;</span></span><br><span class="line">__autoreleasing Person *per = [Person createPerson];</span><br><span class="line"><span class="built_in">objc_autoreleasePoolPop</span>(atautoreleasepoolobj); <span class="comment">// å¯¹åº” &#125;</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡æŸ¥çœ‹ä¸‹é¢çš„æ±‡ç¼–ä»£ç æˆªå›¾ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ç¼–è¯‘å™¨ç¡®å®å°† @autoreleasepool è¯­æ³•å—è½¬æ¢æˆäº† objc_autoreleasePoolPush å’Œ objc_autoreleasePoolPop çš„å‡½æ•°è°ƒç”¨ã€‚è¿™ç§è½¬æ¢ä¸ä»…ä¿è¯äº†ä»£ç çš„æ‰§è¡Œæ•ˆç‡ï¼Œè¿˜ä¸ºå¼€å‘è€…æä¾›äº†ä¸€ç§ä¼˜é›…çš„å†…å­˜ç®¡ç†æ–¹å¼ï¼š</p><p><img src="@autorelease%E5%8E%9F%E7%90%86.png"></p><p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹ objc_autoreleasePoolPush å‡½æ•°çš„å†…éƒ¨å®ç°ã€‚ä¸ºäº†ä¾¿äºç†è§£ï¼Œæˆ‘å°†ç›¸å…³ä»£ç è¿›è¡Œäº†ç²¾ç®€å’Œæ•´ç†ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> * <span class="title">objc_autoreleasePoolPush</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> AutoreleasePoolPage::<span class="built_in">push</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">push</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ReturnAutoreleaseInfo info = <span class="built_in">getReturnAutoreleaseInfo</span>();</span><br><span class="line">    <span class="comment">// å°† TLS ä¸­çš„å¯¹è±¡è½¬ç§»è‡³å½“å‰é‡Šæ”¾æ± ã€‚</span></span><br><span class="line">    <span class="built_in">moveTLSAutoreleaseToPool</span>(info);</span><br><span class="line">    <span class="comment">// æ’å…¥ä¸€ä¸ªæ± è¾¹ç•Œã€‚</span></span><br><span class="line">    id *dest = <span class="built_in">autoreleaseFast</span>(POOL_BOUNDARY);</span><br><span class="line">    <span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µé€»è¾‘éå¸¸ç®€æ´ä¼˜é›…ï¼šå®ƒé€šè¿‡è°ƒç”¨ autoreleaseFast å‡½æ•°ï¼Œåœ¨å½“å‰çš„ AutoreleasePool ä¸­æ’å…¥ä¸€ä¸ªè¾¹ç•Œæ ‡è®°ï¼ˆPOOL_BOUNDARYï¼‰ã€‚è¿™ä¸ªè¾¹ç•Œæ ‡è®°å°±åƒæ˜¯ä¸€ä¸ªä¹¦ç­¾ï¼Œæ ‡è®°ç€å½“å‰è‡ªåŠ¨é‡Šæ”¾æ± çš„èŒƒå›´èµ·ç‚¹ã€‚</p><p>è®©æˆ‘ä»¬ç»§ç»­æ¢ç´¢ objc_autoreleasePoolPop çš„å®ç°ç»†èŠ‚ã€‚ä¸‹é¢æ˜¯ç»è¿‡ç²¾ç®€çš„æ ¸å¿ƒä»£ç ï¼Œæˆ‘ä»¬å°†åˆ†æ­¥éª¤è¯¦ç»†è§£æå…¶å·¥ä½œåŸç†ï¼ˆå¦‚æœè§‰å¾—ä»£ç å¤ªé•¿å¯ä»¥å…ˆè·³è¿‡ï¼Œç¨åæˆ‘ä»¬ä¼šè¯¦ç»†è§£é‡Šå…¶å·¥ä½œåŸç†ï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">objc_autoreleasePoolPop</span><span class="params">(<span class="type">void</span> *ctxt)</span> </span>&#123;</span><br><span class="line">    AutoreleasePoolPage::<span class="built_in">pop</span>(ctxt);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">pop</span><span class="params">(<span class="type">void</span> *token)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ¸…ç† TLS ä¸­çš„æ®‹ç•™å¯¹è±¡ï¼Œç¡®ä¿å…¶ç”Ÿå‘½å‘¨æœŸä¸å½“å‰æ± åŒæ­¥ã€‚</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">releaseReturnAutoreleaseTLS</span>());</span><br><span class="line">    </span><br><span class="line">    AutoreleasePoolPage *page;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// EMPTY_POOL_PLACEHOLDER è¡¨ç¤ºæ¸…ç©º Pool ä¸­çš„æ‰€æœ‰å¯¹è±¡ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (token == (<span class="type">void</span>*)EMPTY_POOL_PLACEHOLDER) &#123;</span><br><span class="line">        page = <span class="built_in">hotPage</span>();</span><br><span class="line">        <span class="keyword">if</span> (!page) &#123;</span><br><span class="line">            <span class="comment">// ä»æœªä½¿ç”¨çš„æ± ç›´æ¥æ¸…é™¤å ä½ç¬¦</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">setHotPage</span>(nil);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        è·å– Pool çš„èµ·å§‹é¡µã€‚å†…éƒ¨é€»è¾‘å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="comment">         </span></span><br><span class="line"><span class="comment">        AutoreleasePoolPage *coldPage() &#123;</span></span><br><span class="line"><span class="comment">            // å…ˆæ‹¿åˆ°å°¾èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="comment">            AutoreleasePoolPage *result = hotPage();</span></span><br><span class="line"><span class="comment">            if (result) &#123;</span></span><br><span class="line"><span class="comment">                // ä¸æ–­è·å–é“¾è¡¨ä¸­çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªã€‚</span></span><br><span class="line"><span class="comment">                while (result-&gt;parent) &#123;</span></span><br><span class="line"><span class="comment">                    result = result-&gt;parent;</span></span><br><span class="line"><span class="comment">                    result-&gt;fastcheck();</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            return result;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        page = <span class="built_in">coldPage</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æŠŠ stop è®¾ç½®ä¸ºç¬¬ä¸€é¡µçš„èµ·ç‚¹ã€‚</span></span><br><span class="line">        token = page-&gt;<span class="built_in">begin</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        page = <span class="built_in">pageForPointer</span>(token);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    id *stop = (id *)token;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     è¿™æ®µé€»è¾‘çš„æ„æ€æ˜¯ï¼š</span></span><br><span class="line"><span class="comment">     å¦‚æœ stop ä¸æ˜¯æ± è¾¹ç•Œ(POOL_BOUNDARY)å°±éœ€è¦è¿›è¡Œæ£€æŸ¥ï¼š</span></span><br><span class="line"><span class="comment">     å¦‚æœ stop æ˜¯è¿™ä¸€é¡µçš„èµ·ç‚¹ï¼Œå¹¶ä¸”è¿™ä¸€é¡µå·²ç»æ˜¯ç¬¬ä¸€é¡µäº†ã€‚</span></span><br><span class="line"><span class="comment">     è¯´æ˜éœ€è¦æ¸…ç†é“¾è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œè¿™æ˜¯æ­£å¸¸æƒ…å†µã€‚</span></span><br><span class="line"><span class="comment">     åä¹‹ï¼Œè¿™æ˜¯ä¸æ­£å¸¸çš„ï¼Œè°ƒç”¨ badPopã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (*stop != POOL_BOUNDARY) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stop == page-&gt;<span class="built_in">begin</span>()  &amp;&amp;  !page-&gt;parent) &#123;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">badPop</span>(token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">popPage</span>(token, page, stop);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">popPage</span><span class="params">(<span class="type">void</span> *token, AutoreleasePoolPage *page, id *stop)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     ä»å°¾éƒ¨ä¸€ç›´å¾€å‰é‡Šæ”¾å¯¹è±¡ï¼Œç›´åˆ°é‡åˆ° stopã€‚</span></span><br><span class="line"><span class="comment">     è¿™ä¸€æ­¥æ‰§è¡Œå®Œåï¼Œåªæ˜¯é‡Šæ”¾äº† Page å†…çš„æ•°æ®ï¼ŒPage å¯¹è±¡å¹¶æœªé”€æ¯ã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    page-&gt;<span class="built_in">releaseUntil</span>(stop);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     å¦‚æœè¿™ä¸€é¡µçš„æ•°æ®è¢«åˆ å®Œäº†ï¼Œå°±æŠŠè¿™ä¸ª Page å¯¹è±¡é‡Šæ”¾æ‰ï¼Œ</span></span><br><span class="line"><span class="comment">     å¹¶æŠŠå®ƒçš„çˆ¶ Page è®¾ä¸º hotPageã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (page-&gt;<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        AutoreleasePoolPage *parent = page-&gt;parent;</span><br><span class="line">        page-&gt;<span class="built_in">kill</span>();</span><br><span class="line">        <span class="built_in">setHotPage</span>(parent);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (page-&gt;child) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         å¦‚æœå½“å‰ Page ä¸Šçš„æ•°æ®å°äº Page æ€»å®¹é‡çš„ä¸€åŠï¼Œ</span></span><br><span class="line"><span class="comment">         åˆ™æŠŠä¸‹ä¸€ä¸ª Page é‡Šæ”¾æ‰ï¼ˆå› ä¸ºè¿™ä¸ª Page è¿˜èƒ½å­˜å¾ˆå¤šæ•°æ®ï¼Œ</span></span><br><span class="line"><span class="comment">         å¯èƒ½å¾ˆä¹…éƒ½ç”¨ä¸åˆ°ä¸‹ä¸€é¡µï¼‰ï¼›</span></span><br><span class="line"><span class="comment">         åä¹‹ï¼ŒæŠŠä¸‹ä¸‹ä¸€ä¸ª Page é‡Šæ”¾æ‰ï¼ˆè¿™ä¸€é¡µå¿«å­˜æ»¡äº†ï¼Œ</span></span><br><span class="line"><span class="comment">         å¯èƒ½å¾ˆå¿«å°±è¦ç”¨åˆ°ä¸‹ä¸€é¡µäº†ï¼‰ã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (page-&gt;<span class="built_in">lessThanHalfFull</span>()) &#123;</span><br><span class="line">            page-&gt;child-&gt;<span class="built_in">kill</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (page-&gt;child-&gt;child) &#123;</span><br><span class="line">            page-&gt;child-&gt;child-&gt;<span class="built_in">kill</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">releaseUntil</span><span class="params">(id *stop)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// ä» next å¼€å§‹ï¼Œä¸€ç›´å¾€å‰é‡Šæ”¾å¯¹è±¡ï¼Œç›´åˆ°é‡åˆ° stopã€‚</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">this</span>-&gt;next != stop) &#123;</span><br><span class="line">            AutoreleasePoolPage *page = <span class="built_in">hotPage</span>();</span><br><span class="line">            <span class="comment">// å¦‚æœå½“å‰ Page ä¸ºç©ºï¼Œåˆ™å¾€å‰æ‰¾çˆ¶ Pageã€‚</span></span><br><span class="line">            <span class="keyword">while</span> (page-&gt;<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                page = page-&gt;parent;</span><br><span class="line">                <span class="built_in">setHotPage</span>(page);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è·å–å½“å‰ Page çš„æœ€åä¸€ä¸ªå¯¹è±¡ã€‚</span></span><br><span class="line">            AutoreleasePoolEntry* entry = (AutoreleasePoolEntry*) --page-&gt;next;</span><br><span class="line">            <span class="comment">// è·å–å¯¹è±¡ã€‚</span></span><br><span class="line">            id obj = (id)entry-&gt;<span class="built_in">getPointer</span>();</span><br><span class="line">            <span class="comment">// è·å–å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚</span></span><br><span class="line">            <span class="type">int</span> count = (<span class="type">int</span>)entry-&gt;<span class="built_in">getCount</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* </span></span><br><span class="line"><span class="comment">            å°†åŸå…ˆå­˜æ”¾æ•°æ®çš„é‚£å—ç©ºé—´èµ‹å€¼ä¸ºä¸€ä¸ªé­”æ•° SCRIBBLEï¼Œ</span></span><br><span class="line"><span class="comment">            è¿™ä¹ˆåšçš„ç›®çš„æ˜¯æ–¹ä¾¿åæœŸæ£€æŸ¥ Page æ˜¯å¦è¢«ç ´åã€‚</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="built_in">memset</span>((<span class="type">void</span>*)page-&gt;next, SCRIBBLE, <span class="built_in">sizeof</span>(*page-&gt;next));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¦‚æœ obj ä¸æ˜¯è¾¹ç•Œæ ‡è®°ï¼Œåˆ™æ‰§è¡Œé‡Šæ”¾æ“ä½œã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (obj != POOL_BOUNDARY) &#123;</span><br><span class="line">                <span class="comment">// æ‰§è¡ŒæŒ‡å®šæ¬¡æ•°çš„é‡Šæ”¾æ“ä½œã€‚</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count + <span class="number">1</span>; i++) &#123;</span><br><span class="line">                    <span class="built_in">objc_release</span>(obj);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ¸…ç©º TLS ä¸­çš„ä¸´æ—¶å¯¹è±¡ï¼Œç¡®ä¿å®ƒä»¬å’Œ Page çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ç›¸åŒçš„ã€‚</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="built_in">releaseReturnAutoreleaseTLS</span>());</span><br><span class="line">    <span class="built_in">setHotPage</span>(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡Šæ”¾çš„é€»è¾‘ç¨å¾®å¤æ‚ä¸€äº›ï¼Œæˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹ã€‚å½“æˆ‘ä»¬è°ƒç”¨ pop å‡½æ•°æ—¶ï¼Œç³»ç»Ÿä¼šæŒ‰ç…§ä»¥ä¸‹æµç¨‹è¿›è¡Œå¯¹è±¡çš„é‡Šæ”¾æ“ä½œï¼š</p><ol><li>é¦–å…ˆï¼Œobjc_autoreleasePoolPop å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå®ƒæ˜¯æ•´ä¸ªé‡Šæ”¾æµç¨‹çš„å…¥å£ã€‚</li><li>ç„¶åï¼Œpop å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå®ƒè´Ÿè´£å¤„ç†å…·ä½“çš„é‡Šæ”¾é€»è¾‘ã€‚</li><li>æ¥ç€ï¼ŒpopPage å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå®ƒè´Ÿè´£ç®¡ç† Page çš„é‡Šæ”¾ã€‚</li><li>æœ€åï¼ŒreleaseUntil å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå®ƒè´Ÿè´£æ‰§è¡Œå®é™…çš„å¯¹è±¡é‡Šæ”¾æ“ä½œã€‚</li></ol><p>å®Œæ•´çš„å‡½æ•°è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">objc_autoreleasePoolPop</span><br><span class="line">â””â”€â”€ pop</span><br><span class="line">    â””â”€â”€ popPage</span><br><span class="line">        â””â”€â”€ releaseUntil</span><br></pre></td></tr></table></figure><p>åœ¨è¿™äº›å‡½æ•°ä¸­ï¼ŒreleaseUntil å’Œ popPage æ‰®æ¼”ç€å°¤ä¸ºå…³é”®çš„è§’è‰²ï¼š</p><p>releaseUntil å‡½æ•°è´Ÿè´£å¯¹è±¡çš„å…·ä½“é‡Šæ”¾å·¥ä½œã€‚å®ƒä¼šæŒ‰ç…§å…ˆè¿›åå‡ºï¼ˆLIFOï¼‰çš„é¡ºåºï¼Œå°† Page ä¸­çš„å¯¹è±¡é€ä¸€é‡Šæ”¾ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå®ƒä¸ä»…è¦å¤„ç†æ™®é€šå¯¹è±¡çš„é‡Šæ”¾ï¼Œè¿˜è¦è€ƒè™‘å¯¹è±¡åˆå¹¶ä¼˜åŒ–å¸¦æ¥çš„ç‰¹æ®Šæƒ…å†µï¼Œç¡®ä¿æ¯ä¸ªå¯¹è±¡éƒ½èƒ½å¾—åˆ°æ­£ç¡®çš„é‡Šæ”¾æ¬¡æ•°ã€‚åŒæ—¶ï¼Œå®ƒè¿˜ä¼šé€šè¿‡é­”æ•°ï¼ˆSCRIBBLEï¼‰æ ‡è®°å·²é‡Šæ”¾çš„å†…å­˜ç©ºé—´ï¼Œè¿™ä¹ˆåšçš„ç›®çš„æ˜¯æ–¹ä¾¿åæœŸè¿›è¡Œå†…å­˜å®Œæ•´æ€§æ£€æŸ¥ã€‚</p><p>popPage å‡½æ•°åˆ™ä¸“æ³¨äº Page å¯¹è±¡æœ¬èº«çš„ç®¡ç†å’Œé‡Šæ”¾ã€‚å®ƒç»´æŠ¤ç€ AutoreleasePool çš„æ•´ä½“ç»“æ„ï¼Œç¡®ä¿å½“ Page ä¸­æ‰€æœ‰çš„å¯¹è±¡éƒ½è¢«é‡Šæ”¾å®Œåï¼ŒPage æœ¬èº«èƒ½å¤Ÿè¢«æ­£ç¡®åœ°é‡Šæ”¾ï¼Œä»è€Œä¿æŒæ•´ä¸ªæ± ç»“æ„çš„é«˜æ•ˆè¿è½¬ã€‚</p><p>é€šè¿‡ä¸Šè¿°åˆ†æï¼Œæˆ‘ä»¬å·²ç»æ·±å…¥ç†è§£äº† AutoreleasePool çš„æ ¸å¿ƒå·¥ä½œåŸç†ï¼šç³»ç»Ÿé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„å…¥æ± (Push)å’Œå‡ºæ± (Pop)æœºåˆ¶ï¼Œåœ¨ä¿è¯å†…å­˜ç®¡ç†å®‰å…¨æ€§çš„åŒæ—¶ï¼Œä¹Ÿå®ç°äº†æé«˜çš„è¿è¡Œæ•ˆç‡ã€‚è¿™ç§åŒå‘é“¾è¡¨ç»“æ„ä¸ä»…è®©å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å˜å¾—ä¼˜é›…ï¼Œè¿˜é€šè¿‡è¯¸å¦‚å¯¹è±¡åˆå¹¶ç­‰ä¼˜åŒ–æ‰‹æ®µæå‡äº†è¿è¡Œæ€§èƒ½ã€‚</p><p>åœ¨æŒæ¡äº†è¿™äº›åº•å±‚å®ç°ç»†èŠ‚åï¼Œæˆ‘ä»¬å°†è¿›ä¸€æ­¥æ¢è®¨ AutoreleasePool åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„è¡Œä¸ºç‰¹å¾ï¼Œä»¥åŠåœ¨å®é™…å¼€å‘ä¸­çš„æœ€ä½³å®è·µæ–¹æ¡ˆã€‚è¿™äº›çŸ¥è¯†å°†å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°é©¾é©­è¿™ä¸ªå¼ºå¤§çš„å†…å­˜ç®¡ç†å·¥å…·ã€‚</p><h2 id="çº¿ç¨‹ä¸-AutoreleasePoolï¼šçº ç¼ çš„åŒèºæ—‹"><a href="#çº¿ç¨‹ä¸-AutoreleasePoolï¼šçº ç¼ çš„åŒèºæ—‹" class="headerlink" title="çº¿ç¨‹ä¸ AutoreleasePoolï¼šçº ç¼ çš„åŒèºæ—‹"></a>çº¿ç¨‹ä¸ AutoreleasePoolï¼šçº ç¼ çš„åŒèºæ—‹</h2><p>AutoreleasePool å’Œçº¿ç¨‹æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ AutoreleasePoolã€‚ä»å®ç°ä¸Šçœ‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”± AutoreleasePoolPage å¯¹è±¡ç»„æˆçš„åŒå‘é“¾è¡¨ç»“æ„ï¼Œçº¿ç¨‹é€šè¿‡ TLS (Thread Local Storage) æœºåˆ¶æŒæœ‰è¿™ä¸ªé“¾è¡¨çš„å°¾èŠ‚ç‚¹ï¼ˆä¹Ÿå°±æ˜¯ hotPageï¼‰ã€‚</p><p>å…³äº AutoreleasePool çš„é‡Šæ”¾æ—¶æœºï¼Œè¿™æ˜¯ä¸€ä¸ªç»å¸¸è¢«å¼€å‘è€…è®¨è®ºçš„è¯é¢˜ã€‚ç‰¹åˆ«æ˜¯è¢« __autoreleasing ä¿®é¥°çš„å¯¹è±¡ï¼Œå®ƒä»¬å…·ä½“åœ¨ä»€ä¹ˆæ—¶å€™è¢«é‡Šæ”¾ï¼Ÿ</p><p>ç»è¿‡æ·±å…¥ç ”ç©¶ï¼Œæˆ‘å‘ç°ä¸åŒåœºæ™¯ä¸‹å¯¹è±¡çš„é‡Šæ”¾æ—¶æœºæ˜¯ä¸åŒçš„ã€‚è®©æˆ‘ä»¬é€ä¸€åˆ†æï¼š</p><p>åœºæ™¯ä¸€ï¼šä¸»çº¿ç¨‹ä¸­çš„ autorelease å¯¹è±¡</p><ul><li>ç”± RunLoop æ¥ç®¡ç†é‡Šæ”¾æ—¶æœº</li><li>é€šå¸¸åœ¨å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæˆåé‡Šæ”¾</li><li>å…·ä½“æ—¶æœºå¯ä»¥é€šè¿‡ä¸‹å›¾æ¥ç†è§£ï¼š</li></ul><p><img src="mainthread.png"></p><p>åœºæ™¯äºŒï¼šGCD åˆ›å»ºçš„å­çº¿ç¨‹ä¸­çš„å¯¹è±¡</p><ul><li>ç”±äº GCD é‡‡ç”¨çº¿ç¨‹æ± æœºåˆ¶ï¼Œçº¿ç¨‹å¯èƒ½ä¼šè¢«å¤ç”¨</li><li>é‡Šæ”¾æ—¶æœºæ˜¯åœ¨çº¿ç¨‹ä»»åŠ¡å®Œæˆã€å³å°†è¢«æ”¾å›çº¿ç¨‹æ± æ—¶</li><li>é€šè¿‡ä¸‹å›¾å¯ä»¥çœ‹åˆ°å…·ä½“æµç¨‹ï¼š</li></ul><p><img src="gcd.png"></p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ_dispatch_worker_thread2 å‡½æ•°åœ¨å¤„ç†çº¿ç¨‹ä»»åŠ¡æ—¶éµå¾ªè¿™æ ·çš„é€»è¾‘ï¼šä»é˜Ÿåˆ—ä¸­è·å–å¹¶æ‰§è¡Œä»»åŠ¡ï¼Œå½“é˜Ÿåˆ—ä¸ºç©ºæ—¶è®©çº¿ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€ã€‚åœ¨è¿›å…¥ä¼‘çœ ä¹‹å‰ï¼Œä¼šè°ƒç”¨ _dispatch_last_resort_autorelease_pool_pop æ¥é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ä¸­çš„å¯¹è±¡ã€‚</p><p>åœºæ™¯ä¸‰ï¼šé€šè¿‡ NSThread ç­‰æ–¹å¼åˆ›å»ºçš„éå¤ç”¨çº¿ç¨‹ï¼ˆæ—  RunLoopï¼‰</p><ul><li>å¯¹è±¡ä¼šåœ¨çº¿ç¨‹é”€æ¯æ—¶è¢«é‡Šæ”¾</li><li>é‡Šæ”¾è¿‡ç¨‹å¦‚å›¾æ‰€ç¤ºï¼š</li></ul><p><img src="pthread.png"></p><p>åœºæ™¯å››ï¼šé€šè¿‡ NSThread ç­‰æ–¹å¼åˆ›å»ºçš„éå¤ç”¨çº¿ç¨‹ï¼ˆæœ‰ RunLoopï¼‰</p><ul><li>é‡Šæ”¾æœºåˆ¶ç±»ä¼¼äºä¸»çº¿ç¨‹</li><li>åœ¨å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæˆåé‡Šæ”¾</li><li>å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</li></ul><p><img src="pthread_runloop.png"></p><p>åœºæ™¯å››ä¸­ä½¿ç”¨çš„ NSThread æ˜¯æˆ‘å¼€å‘çš„ä¸€ä¸ªå¼€æºåº“ <a href="https://github.com/internetWei/WXLThread">WXLThread</a>ã€‚è¿™ä¸ªåº“å®ç°äº†ä¸€ä¸ªä¼˜é›…çš„å¸¸é©»çº¿ç¨‹æœºåˆ¶ï¼Œå¹¶æä¾›äº†ç®€æ´è€Œå¼ºå¤§çš„ä»»åŠ¡è°ƒåº¦æ¥å£ï¼Œè®©çº¿ç¨‹ç®¡ç†å˜å¾—æ›´åŠ ä¾¿æ·å’Œé«˜æ•ˆã€‚</p><p>éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œè¿™äº›é‡Šæ”¾æ—¶æœºå¹¶éå›ºå®šä¸å˜ã€‚å› ä¸º autoreleasing å¯¹è±¡çš„é‡Šæ”¾æœ¬è´¨ä¸Šæ˜¯ç”± pop å‡½æ•°çš„è°ƒç”¨æ—¶æœºå†³å®šçš„ã€‚éšç€ç³»ç»Ÿç‰ˆæœ¬çš„æ›´æ–°å’Œä¼˜åŒ–ï¼Œè¿™äº›è°ƒç”¨æ—¶åºå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚æ¯”å¦‚åœ¨æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œç³»ç»Ÿæ˜¯é€šè¿‡åœ¨ RunLoop ä¸­æ³¨å†Œ Observer æ¥å¤„ç†é‡Šæ”¾æ“ä½œçš„ï¼Œé‡Šæ”¾æ—¶æœºæ˜¯åœ¨çº¿ç¨‹å³å°†è¿›å…¥ä¼‘çœ çŠ¶æ€ä¹‹å‰ã€‚</p><p>å¦å¤–ï¼Œå¦‚æœå¯¹è±¡è¢« <code>@autoreleasepool &#123;&#125;</code> è¯­æ³•å—åŒ…è£¹ï¼Œé‚£ä¹ˆå®ƒçš„é‡Šæ”¾æ—¶æœºå°±å¾ˆæ˜ç¡®äº† - å°±æ˜¯åœ¨é€€å‡ºè¿™ä¸ªè¯­æ³•å—ä½œç”¨åŸŸçš„æ—¶å€™ã€‚è¿™æä¾›äº†ä¸€ç§æ›´ç²¾ç¡®çš„å†…å­˜ç®¡ç†æ–¹å¼ã€‚</p><h2 id="æ€§èƒ½ä¼˜åŒ–ï¼šTLS-æœºåˆ¶è§£æ"><a href="#æ€§èƒ½ä¼˜åŒ–ï¼šTLS-æœºåˆ¶è§£æ" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–ï¼šTLS æœºåˆ¶è§£æ"></a>æ€§èƒ½ä¼˜åŒ–ï¼šTLS æœºåˆ¶è§£æ</h2><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">- (Person *)createPerson &#123;</span><br><span class="line">    Person *per = [[Person alloc] init];</span><br><span class="line">    <span class="keyword">return</span> per;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    Person *per = [self createPerson];</span><br><span class="line">    <span class="built_in">NSLog</span>(@<span class="string">&quot;%@&quot;</span>, per);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•ä¼˜åŒ–ï¼Œç³»ç»Ÿä¼šåœ¨ return ä¹‹å‰å¯¹ per è°ƒç”¨ release æ–¹æ³•ï¼Œè¿™ä¼šå¯¼è‡´å¯¹è±¡è¿‡æ—©é‡Šæ”¾ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œç¼–è¯‘å™¨ä¼šåœ¨æ–¹æ³•è¿”å›å‰å°†å¯¹è±¡åŠ å…¥åˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­ï¼Œç¡®ä¿è°ƒç”¨æ–¹èƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨è¿™ä¸ªå¯¹è±¡ã€‚ä½†è¿™ç§æ–¹æ¡ˆå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šå³ä½¿å¯¹è±¡é©¬ä¸Šå°±ä¼šè¢«è°ƒç”¨æ–¹ä½¿ç”¨ï¼Œä¹Ÿè¦ç»è¿‡ã€ŒåŠ å…¥è‡ªåŠ¨é‡Šæ”¾æ±  -&gt; ä»è‡ªåŠ¨é‡Šæ”¾æ± å–å‡ºã€è¿™ä¸ªè¿‡ç¨‹ï¼Œè¿™æ— ç–‘ä¼šå¸¦æ¥ä¸€äº›æ€§èƒ½å¼€é”€ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç³»ç»Ÿå¼•å…¥äº†åŸºäº TLS (Thread Local Storage) çš„è¿”å›å€¼ä¼˜åŒ–æœºåˆ¶ã€‚å…·ä½“æ¥è¯´ï¼š</p><ol><li>åœ¨è¿”å›å¯¹è±¡çš„æ–¹æ³•ä¸­ï¼Œç¼–è¯‘å™¨ä¼šæ’å…¥ <code>objc_autoreleaseReturnValue</code> è°ƒç”¨ï¼›</li><li>åœ¨æ¥æ”¶è¿”å›å€¼çš„åœ°æ–¹ï¼Œç¼–è¯‘å™¨ä¼šæ’å…¥ <code>objc_retainAutoreleasedReturnValue</code> è°ƒç”¨ï¼›</li><li>è¿™ä¸¤ä¸ªå‡½æ•°ä¼šé…åˆå·¥ä½œï¼šå¦‚æœæ£€æµ‹åˆ°å®ƒä»¬çš„è°ƒç”¨é…å¯¹ï¼Œå°±ä¼šæŠŠå¯¹è±¡æš‚å­˜åœ¨çº¿ç¨‹çš„ TLS ä¸­ï¼Œç›´æ¥ä¼ é€’ç»™è°ƒç”¨æ–¹ï¼Œå®Œå…¨è·³è¿‡è‡ªåŠ¨é‡Šæ”¾æ± çš„è¿‡ç¨‹ã€‚</li></ol><p>è¿™ç§ä¼˜åŒ–æå¤§åœ°æå‡äº†è¿”å›å¯¹è±¡çš„æ€§èƒ½ï¼Œå°¤å…¶æ˜¯åœ¨é¢‘ç¹æ–¹æ³•è°ƒç”¨çš„åœºæ™¯ä¸‹ã€‚</p><p>é€šè¿‡è°ƒè¯•æŸ¥çœ‹æ±‡ç¼–ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°è¿™äº›ä¼˜åŒ–å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ï¼Œå½“ç¼–è¯‘å™¨æ£€æµ‹åˆ°è¿”å›å€¼ä¼˜åŒ–çš„åœºæ™¯æ—¶ï¼Œä¼šè·³è¿‡ä¼ ç»Ÿçš„è‡ªåŠ¨é‡Šæ”¾æ± æµç¨‹ï¼Œç›´æ¥é€šè¿‡ TLS æœºåˆ¶ä¼ é€’å¯¹è±¡æå‡äº†æ€§èƒ½ã€‚è®©æˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„å›¾æ¥ç›´è§‚åœ°ä½“ä¼šè¿™ä¸ªä¼˜åŒ–è¿‡ç¨‹ï¼š</p><table><thead><tr><th align="center"><img src="%E8%B0%83%E7%94%A8%E6%96%B9.png"></th></tr></thead><tbody><tr><td align="center">æ–¹æ³•è°ƒç”¨æ–¹</td></tr></tbody></table><table><thead><tr><th align="center"><img src="%E8%BF%94%E5%9B%9E%E6%96%B9.png"></th></tr></thead><tbody><tr><td align="center">æ–¹æ³•è¿”å›æ–¹</td></tr></tbody></table><h2 id="å¸¸è§è¯¯åŒºä¸æœ€ä½³å®è·µ"><a href="#å¸¸è§è¯¯åŒºä¸æœ€ä½³å®è·µ" class="headerlink" title="å¸¸è§è¯¯åŒºä¸æœ€ä½³å®è·µ"></a>å¸¸è§è¯¯åŒºä¸æœ€ä½³å®è·µ</h2><p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸€äº›å¯¹ AutoreleasePool ä½¿ç”¨çš„è¯¯åŒºã€‚å…¶ä¸­æœ€å¸¸è§çš„å°±æ˜¯åœ¨å¾ªç¯ä¸­è¿‡åº¦ä½¿ç”¨ @autoreleasepoolï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        Person *per = [[Person alloc] init];</span><br><span class="line">        <span class="comment">// å¯¹ per è¿›è¡Œçš„æ“ä½œâ€¦â€¦</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¸­çš„ per å¯¹è±¡æ˜¯ __strong ç±»å‹ï¼Œå®ƒä¼šåœ¨æ¯æ¬¡å¾ªç¯ç»“æŸæ—¶ç«‹å³é‡Šæ”¾ï¼Œæ— éœ€ç­‰å¾…è‡ªåŠ¨é‡Šæ”¾æ± çš„æ¸…ç†ã€‚è¿™ç§æƒ…å†µä¸‹æ·»åŠ  @autoreleasepool å¹¶ä¸ä¼šå¸¦æ¥ä»»ä½•æ€§èƒ½ä¼˜åŠ¿ï¼Œåè€Œä¼šå› ä¸ºé¢‘ç¹åˆ›å»ºå’Œé”€æ¯è‡ªåŠ¨é‡Šæ”¾æ± è€Œå¢åŠ å¼€é”€ã€‚</p><p>å› æ­¤ï¼Œ@autoreleasepool çš„ä½¿ç”¨éœ€è¦éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š</p><ol><li><p>å¾ªç¯ä¸­åˆ›å»ºäº†å¤§é‡ autoreleasing å¯¹è±¡æ—¶æ‰ä½¿ç”¨ã€‚è¿™ç§æƒ…å†µä¸‹æ‰èƒ½æœ‰æ•ˆé™ä½å†…å­˜å³°å€¼ï¼Œé¿å…å†…å­˜æŒç»­å¢é•¿ã€‚</p></li><li><p>è°ƒç”¨æœªçŸ¥æ–¹æ³•æ—¶éœ€è¦è°¨æ…è¯„ä¼°ã€‚å› ä¸ºæ–¹æ³•å†…éƒ¨å¯èƒ½ä¼šåˆ›å»º autoreleasing å¯¹è±¡ï¼Œæ­¤æ—¶éœ€è¦ä½¿ç”¨ @autoreleasepool åŒ…è£¹ï¼Œå¦åˆ™ä¹Ÿä¼šå¯¼è‡´å†…å­˜å³°å€¼è¿‡é«˜ã€‚</p></li></ol><p>æ³¨æ„ï¼šé”™è¯¯çš„ä½¿ç”¨ @autoreleasepool ä¸ä»…ä¸ä¼šå¸¦æ¥æ€§èƒ½ä¼˜åŠ¿ï¼Œåè€Œä¼šå› ä¸ºé¢‘ç¹åˆ›å»ºå’Œé”€æ¯è‡ªåŠ¨é‡Šæ”¾æ± è€Œäº§ç”Ÿé¢å¤–å¼€é”€ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨å‰ï¼Œå»ºè®®å…ˆåˆ†æä»£ç ä¸­çš„å¯¹è±¡åˆ›å»ºæƒ…å†µï¼Œå†å†³å®šæ˜¯å¦éœ€è¦æ‰‹åŠ¨ç®¡ç†è‡ªåŠ¨é‡Šæ”¾æ± ã€‚</p><h2 id="æŠ€æœ¯æ€»ç»“"><a href="#æŠ€æœ¯æ€»ç»“" class="headerlink" title="æŠ€æœ¯æ€»ç»“"></a>æŠ€æœ¯æ€»ç»“</h2><p>é€šè¿‡å¯¹ AutoreleasePool åº•å±‚å®ç°çš„æ·±å…¥åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºä»¥ä¸‹å‡ ä¸ªå…³é”®ç‚¹ï¼š</p><ol><li><p>åº•å±‚æ•°æ®ç»“æ„</p><ul><li>AutoreleasePool æœ¬è´¨æ˜¯ç”± AutoreleasePoolPage å¯¹è±¡ç»„æˆçš„åŒå‘é“¾è¡¨ï¼›</li><li>æ¯ä¸ª Page ç›®å‰çš„å¤§å°ä¸º 4KBï¼ŒæŒ‰ç³»ç»Ÿå†…å­˜é¡µå¯¹é½ä»¥ä¼˜åŒ–æ€§èƒ½ï¼›</li><li>æ¯ä¸ªçº¿ç¨‹çš„ TLS ä¸­å­˜å‚¨ç€é“¾è¡¨çš„å°¾èŠ‚ç‚¹ï¼ˆhotPageï¼‰ï¼›</li><li>Page ä¸­é™¤äº†å­˜å‚¨å¯¹è±¡æŒ‡é’ˆå¤–ï¼Œè¿˜åŒ…å« magicã€nextã€thread ç­‰é‡è¦ä¿¡æ¯ã€‚</li></ul></li><li><p>å¯¹è±¡ç®¡ç†æœºåˆ¶</p><ul><li><p>æ·»åŠ å¯¹è±¡æ—¶ï¼Œç³»ç»Ÿé¦–å…ˆè·å– hotPageï¼Œæ ¹æ®å…¶çŠ¶æ€æ‰§è¡Œä¸åŒé€»è¾‘ï¼š</p><ul><li>Page å­˜åœ¨ä¸”æœªæ»¡ï¼šç›´æ¥æ·»åŠ å¯¹è±¡</li><li>Page å­˜åœ¨ä½†å·²æ»¡ï¼šåˆ›å»ºæ–° Page åæ·»åŠ </li><li>Page ä¸å­˜åœ¨ï¼šåˆ›å»ºé¦–ä¸ª Page åæ·»åŠ </li></ul></li><li><p>æ¸…ç†æ—¶ï¼Œç³»ç»Ÿä¼šä»é“¾è¡¨æœ«å°¾å¾€å‰éå†ï¼Œé€ä¸ªé‡Šæ”¾å¯¹è±¡ç›´åˆ°é‡åˆ°æŒ‡å®šçš„è¾¹ç•Œæ ‡è®°ï¼ˆPOOL_BOUNDARYï¼‰ã€‚</p></li></ul></li><li><p>æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ</p><ul><li>å¯¹è±¡åˆå¹¶ä¼˜åŒ–ï¼šç›¸åŒå¯¹è±¡é‡å¤å…¥æ± æ—¶ï¼Œé€šè¿‡ count è®¡æ•°é¿å…é‡å¤å­˜å‚¨ï¼›</li><li>TLS è¿”å›å€¼ä¼˜åŒ–ï¼šæ–¹æ³•è¿”å›å¯¹è±¡æ—¶ï¼Œé€šè¿‡ TLS æœºåˆ¶é¿å…è‡ªåŠ¨é‡Šæ”¾æ± çš„ä¸­è½¬ï¼›</li><li>å†…å­˜å¯¹é½ï¼šPage å¤§å°ä¸ç³»ç»Ÿé¡µå¯¹é½ï¼Œæé«˜å†…å­˜è®¿é—®æ•ˆç‡ï¼›</li><li>åŒå‘é“¾è¡¨ï¼šæ”¯æŒå¿«é€Ÿçš„æ­£å‘å’Œåå‘éå†ï¼Œé€‚åº”ä¸åŒçš„ä½¿ç”¨åœºæ™¯ã€‚</li></ul></li></ol><p>è¿™äº›ç²¾å¦™çš„è®¾è®¡ä¸ä»…ä¿è¯äº† AutoreleasePool çš„æ­£ç¡®æ€§ï¼Œè¿˜åœ¨æ€§èƒ½å’Œå†…å­˜ä½¿ç”¨æ•ˆç‡ä¸Šéƒ½åšåˆ°äº†æè‡´çš„ä¼˜åŒ–ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://suhou.github.io/2018/01/21/%E5%B8%A6%E7%9D%80%E9%97%AE%E9%A2%98%E7%9C%8B%E6%BA%90%E7%A0%81----%E5%AD%90%E7%BA%BF%E7%A8%8BAutoRelease%E5%AF%B9%E8%B1%A1%E4%BD%95%E6%97%B6%E9%87%8A%E6%94%BE/">å­çº¿ç¨‹AutoReleaseå¯¹è±¡ä½•æ—¶é‡Šæ”¾ | su</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å†…å­˜ç®¡ç† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2024 å†æ¢ObjC-Categoryï¼šåŠ¨æ€ç‰¹æ€§ä¸è¿è¡Œæ—¶å®ç°çš„æè‡´ä¹‹ç¾</title>
      <link href="/2024/12/11/iOS/2024%20%E5%86%8D%E6%8E%A2ObjC-Category%EF%BC%9A%E5%8A%A8%E6%80%81%E7%89%B9%E6%80%A7%E4%B8%8E%E8%BF%90%E8%A1%8C%E6%97%B6%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%9E%81%E8%87%B4%E4%B9%8B%E7%BE%8E/"/>
      <url>/2024/12/11/iOS/2024%20%E5%86%8D%E6%8E%A2ObjC-Category%EF%BC%9A%E5%8A%A8%E6%80%81%E7%89%B9%E6%80%A7%E4%B8%8E%E8%BF%90%E8%A1%8C%E6%97%B6%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%9E%81%E8%87%B4%E4%B9%8B%E7%BE%8E/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç”± å¸ƒå¤š(budo) å‘å¸ƒäº 2024-12-11 â€¢ æœ€åæ›´æ–°äº2025-02-26</p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Category æ˜¯ ObjC ä¸­ä¸€ä¸ªåŸºç¡€ä¸”é‡è¦çš„æ¦‚å¿µã€‚æœ¬æ–‡å°†ä» Runtime æºç å…¥æ‰‹ï¼Œå‘ä½ ä»‹ç» Category çš„æ¦‚å¿µä»¥åŠåº•å±‚çš„å®ç°åŸç†ã€‚</p><h2 id="Category-æ¦‚å¿µ"><a href="#Category-æ¦‚å¿µ" class="headerlink" title="Category æ¦‚å¿µ"></a>Category æ¦‚å¿µ</h2><p>Category ä¸»è¦æ˜¯ç”¨æ¥ç»™å·²å­˜åœ¨çš„ç±»åŠ¨æ€æ·»åŠ æ–¹æ³•å®ç°ï¼Œä¹Ÿå¯æ‰©å±•åè®®å’Œå±æ€§ã€‚åŸºäºæ­¤ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ Category å®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š</p><ul><li><p>å°†ä¸€ä¸ªåºå¤§çš„ç±»åˆ†è§£æˆå¤šä¸ª Categoryï¼Œæ¯ä¸ª Category åªå®Œæˆå°‘é‡çš„ä»»åŠ¡ï¼Œä»è€Œæé«˜æ¨¡å—åŒ–å’Œä»£ç è§£è€¦ç¨‹åº¦ã€‚</p></li><li><p>åœ¨ä¸ç»§æ‰¿çš„æƒ…å†µä¸‹ç»™å·²æœ‰ç±»åŠ¨æ€çš„æ·»åŠ æ–°æ–¹æ³•ã€‚</p></li><li><p>æ¨¡æ‹Ÿå¤šç»§æ‰¿ï¼Œæ¯”å¦‚è®©å·²æœ‰ç±»æ”¯æŒæ–°åè®®ã€‚</p></li></ul><h2 id="Category-ä¹‹ç¼–è¯‘æœŸå®ç°ç»†èŠ‚"><a href="#Category-ä¹‹ç¼–è¯‘æœŸå®ç°ç»†èŠ‚" class="headerlink" title="Category ä¹‹ç¼–è¯‘æœŸå®ç°ç»†èŠ‚"></a>Category ä¹‹ç¼–è¯‘æœŸå®ç°ç»†èŠ‚</h2><p>åˆ›å»ºä¸€ä¸ª ObjC æºä»£ç æ–‡ä»¶å¹¶å°†å…¶å‘½åä¸º <code>test_category.m</code>ï¼Œç„¶ååœ¨æ–‡ä»¶å†…è¾“å…¥å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">WXLCategory</span>)&lt;<span class="title">NSCopying</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> () <span class="built_in">NSInteger</span> wxl_ist_prot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">class</span>) <span class="built_in">NSInteger</span> wxl_cls_prot;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)wxl_ist_func;</span><br><span class="line">+ (<span class="type">void</span>)wxl_cls_func;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">WXLExtension</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)wxl_ist_func &#123;&#125;</span><br><span class="line">+ (<span class="type">void</span>)wxl_cls_func &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œæˆ‘ç‰¹æ„åªå†™äº†æ–¹æ³•çš„å®ç°ï¼Œè€Œæ²¡æœ‰å†™å±æ€§å’Œåè®®çš„å®ç°ï¼Œåé¢ä¼šè§£é‡Šä¸ºä»€ä¹ˆã€‚</p></blockquote><p>ä½¿ç”¨ <code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc test_category.m</code> å‘½ä»¤å¯ä»¥å°†ä¸Šè¿°ä»£ç ç¼–è¯‘ä¸º C++ æ–‡ä»¶ï¼Œä»£ç ç²¾ç®€åå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">category_t</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">class_t</span> *cls;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">method_list_t</span> *instance_methods;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">method_list_t</span> *class_methods;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">protocol_list_t</span> *protocols;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">prop_list_t</span> *instanceProperties;</span><br><span class="line">    <span class="comment">// Fields below this point are not always present on disk.</span></span><br><span class="line">    <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">prop_list_t</span> *_classProperties;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">category_t</span> _OBJC_$_CATEGORY_NSObject_$_WXLCategory </span><br><span class="line">__attribute__ ((used, <span class="built_in">section</span> (<span class="string">&quot;__DATA, __objc_const&quot;</span>))) = </span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;NSObject&quot;</span>,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">(<span class="type">const</span> <span class="keyword">struct</span> <span class="type">method_list_t</span> *)&amp;_OBJC_$_CATEGORY_INSTANCE_METHODS_NSObject_$_WXLCategory,</span><br><span class="line">(<span class="type">const</span> <span class="keyword">struct</span> <span class="type">method_list_t</span> *)&amp;_OBJC_$_CATEGORY_CLASS_METHODS_NSObject_$_WXLCategory,</span><br><span class="line">(<span class="type">const</span> <span class="keyword">struct</span> <span class="type">protocol_list_t</span> *)&amp;_OBJC_CATEGORY_PROTOCOLS_$_NSObject_$_WXLCategory,</span><br><span class="line">(<span class="type">const</span> <span class="keyword">struct</span> <span class="type">prop_list_t</span> *)&amp;_OBJC_$_INSTANCE_PROP_LIST_NSObject_$_WXLCategory,</span><br><span class="line">(<span class="type">const</span> <span class="keyword">struct</span> <span class="type">prop_list_t</span> *)&amp;_OBJC_$_CLASS_PROP_LIST_NSObject_$_WXLCategory,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p><code>_classProperties</code> å˜é‡æ˜¯æˆ‘å‚è€ƒ Runtime æºç åæ‰‹åŠ¨åŠ ä¸Šçš„ï¼Œä½ ç¼–è¯‘çš„ä»£ç å¯èƒ½ä¼šæ²¡æœ‰ã€‚</p></blockquote><p>ä»ç¼–è¯‘åçš„ä»£ç ä¸­ä¸éš¾çœ‹å‡ºï¼Œä¸€ä¸ª Category å¯¹è±¡ï¼Œå…¶åº•å±‚å…¶å®å°±æ˜¯1ä¸ª <code>category_t</code> çš„ç»“æ„ä½“å¯¹è±¡ï¼Œè¿™ä¸ªç»“æ„ä½“ä¸­åŒ…å«äº†å®ä¾‹å±æ€§ã€ç±»å±æ€§ã€å®ä¾‹æ–¹æ³•ã€ç±»æ–¹æ³•ä»¥åŠåè®®ç­‰å˜é‡ç”¨æ¥ä¿å­˜åˆ†ç±»ä¸­çš„ç›¸å…³æ•°æ®ã€‚</p><p>æœ€åï¼Œç¼–è¯‘å™¨ä¼šæŠŠ <code>category_t</code> ç›¸å…³æ•°æ®ä¿å­˜åœ¨ Mach-O æ–‡ä»¶çš„ objc_const æ•°æ®æ®µä¸‹ï¼Œç­‰å¾…è¿è¡Œæ—¶è§£æã€‚</p><h2 id="Category-ä¹‹è¿è¡Œæ—¶å®ç°ç»†èŠ‚ï¼šæ¢ç´¢å†…éƒ¨å®ç°åŸç†"><a href="#Category-ä¹‹è¿è¡Œæ—¶å®ç°ç»†èŠ‚ï¼šæ¢ç´¢å†…éƒ¨å®ç°åŸç†" class="headerlink" title="Category ä¹‹è¿è¡Œæ—¶å®ç°ç»†èŠ‚ï¼šæ¢ç´¢å†…éƒ¨å®ç°åŸç†"></a>Category ä¹‹è¿è¡Œæ—¶å®ç°ç»†èŠ‚ï¼šæ¢ç´¢å†…éƒ¨å®ç°åŸç†</h2><p>ç›¸å…³ä»£ç æ•´ç†åå¦‚ä¸‹æ‰€ç¤ºï¼ˆä»£ç æœ‰ç‚¹é•¿ï¼Œä¸æƒ³çœ‹å¯ä»¥è·³è¿‡ï¼Œåé¢æœ‰è§£é‡Šï¼‰ï¼š</p><blockquote><p>æœ¬æ–‡ä½¿ç”¨çš„ Runtime ç‰ˆæœ¬æ˜¯ <a href="https://github.com/apple-oss-distributions/objc4/tree/objc4-928.2">objc4-928.2</a>ï¼Œä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œæˆ‘å¯¹ä»£ç æ ·å¼å’Œæ’ç‰ˆç•¥ä½œäº†ä¿®æ”¹ä»¥åŠåˆ å‡äº†ä¸€äº›ä¸å½±å“ä¸»é€»è¾‘çš„å†—ä½™ä»£ç ã€‚</p><p>æˆ‘åœ¨ <a href="https://github.com/internetWei/ObjCRuntimes">è¿™é‡Œ</a> ç»´æŠ¤äº†ä¸€ä¸ªå¯ä»¥ç›´æ¥è¿è¡Œè°ƒè¯•çš„ Runtime é¡¹ç›®ï¼Œæ–¹ä¾¿å¤§å®¶ç›´æ¥è°ƒè¯•æºç ã€‚</p></blockquote><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">load_images</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> _dyld_objc_notify_mapped_info* info)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥è¯¥æ¨¡å—æ˜¯å¦æœ‰ +load æ–¹æ³•çš„å®ç°ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">hasLoadMethods</span>((<span class="type">const</span> headerType *)info-&gt;mh,</span><br><span class="line">                        info-&gt;sectionLocationMetadata)) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åŠ è½½æ‰€æœ‰åˆ†ç±»ã€‚</span></span><br><span class="line">    <span class="built_in">loadAllCategoriesIfNeeded</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> didInitialAttachCategories = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">loadAllCategoriesIfNeeded</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ§åˆ¶ä¸è¦é‡å¤åŠ è½½åˆ†ç±»æ•°æ®ï¼Œæ¯åŠ è½½ä¸€ä¸ªæ¨¡å—æ—¶éƒ½å¯èƒ½ä¼šæ¥åˆ°è¿™é‡Œã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (!didInitialAttachCategories) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         éå†æ‰€æœ‰æ¨¡å—å¹¶åŠ è½½å®ƒä»¬çš„åˆ†ç±»æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">         </span></span><br><span class="line"><span class="comment">         æ³¨æ„ï¼šåœ¨åŠ è½½ç¬¬1ä¸ªæ¨¡å—æ—¶å°±ä¼šæ‰§è¡Œè¯¥å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment">         è¿™æ„å‘³ç€åœ¨åŠ è½½ç¬¬1ä¸ªæ¨¡å—æ—¶å°±ä¼šæŠŠæ‰€æœ‰æ¨¡å—ä¸­çš„åˆ†ç±»æ•°æ®éƒ½åŠ è½½ï¼Œ</span></span><br><span class="line"><span class="comment">         è€Œä¸æ˜¯åªåŠ è½½å½“å‰æ¨¡å—ä¸­çš„åˆ†ç±»æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> *hi = FirstHeader; hi != <span class="literal">NULL</span>; hi = hi-&gt;<span class="built_in">getNext</span>()) &#123;</span><br><span class="line">            <span class="built_in">load_categories_nolock</span>(hi);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        didInitialAttachCategories = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">load_categories_nolock</span><span class="params">(header_info *hi)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å½“å‰æ¨¡å—æ˜¯å¦æœ‰åˆ†ç±»ç±»å±æ€§ã€‚</span></span><br><span class="line">    <span class="type">bool</span> hasClassProperties = hi-&gt;<span class="built_in">info</span>()-&gt;<span class="built_in">hasCategoryClassProperties</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="type">size_t</span> count;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// éå†å½“å‰æ¨¡å—ä¸­çš„æ‰€æœ‰åˆ†ç±»æ•°æ®å¹¶è¿›è¡Œå¤„ç†ã€‚</span></span><br><span class="line">    <span class="keyword">auto</span> processCatlist = [&amp;](<span class="type">category_t</span> * <span class="type">const</span> *catlist) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">unsigned</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            <span class="type">category_t</span> *cat = catlist[i];</span><br><span class="line">            Class cls = <span class="built_in">remapClass</span>(cat-&gt;cls);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æŠŠ catã€clsã€hi åŒ…è£…ä¸€ä¸‹ï¼Œæ–¹ä¾¿åé¢è°ƒç”¨å‡½æ•°æ—¶ä¼ å‚ã€‚</span></span><br><span class="line">            <span class="type">locstamped_category_t</span> lc&#123;cat, cls, hi&#125;;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ£€æŸ¥è¿™ä¸ªåˆ†ç±»ä¸­æ˜¯å¦æœ‰å®ä¾‹æ–¹æ³•ã€åè®®ã€å®ä¾‹å±æ€§ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (cat-&gt;instanceMethods ||</span><br><span class="line">                cat-&gt;protocols ||</span><br><span class="line">                cat-&gt;instanceProperties) &#123;</span><br><span class="line">                <span class="comment">// æ£€æŸ¥ cls æ˜¯å¦å·²å®ç°ï¼Œ</span></span><br><span class="line">                <span class="keyword">if</span> (cls-&gt;<span class="built_in">isRealized</span>()) &#123;</span><br><span class="line">                    <span class="comment">// å°†åˆ†ç±»ä¸­çš„å®ä¾‹æ–¹æ³•ã€åè®®ã€å®ä¾‹å±æ€§æ·»åŠ åˆ° cls ä¸Šã€‚</span></span><br><span class="line">                    <span class="built_in">attachCategories</span>(cls, &amp;lc, <span class="number">1</span>, cls, ATTACH_EXISTING);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// å°†åˆ†ç±»æ•°æ®å’Œç±»å¯¹è±¡ä¿å­˜èµ·æ¥ï¼Œç­‰ç±»å¯¹è±¡å®ç°åå†è¿›è¡ŒåŠ è½½ã€‚</span></span><br><span class="line">                    objc::unattachedCategories.<span class="built_in">addForClass</span>(lc, cls);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             æ£€æŸ¥è¿™ä¸ªåˆ†ç±»ä¸­æ˜¯å¦æœ‰ç±»æ–¹æ³•ã€åè®®ã€ç±»å±æ€§ã€‚</span></span><br><span class="line"><span class="comment">             </span></span><br><span class="line"><span class="comment">             æ³¨æ„ `(hasClassProperties &amp;&amp; cat-&gt;_classProperties)` è¿™æ®µä»£ç ï¼Œ</span></span><br><span class="line"><span class="comment">             å¯èƒ½æ˜¯å› ä¸ºä½¿ç”¨ç±»å±æ€§çš„é¡¹ç›®éå¸¸å°‘ï¼Œæ‰€ä»¥åŠ å…¥äº†è¿™ä¸€ä¸ªåˆ¤æ–­ã€‚</span></span><br><span class="line"><span class="comment">             </span></span><br><span class="line"><span class="comment">             è¿™é‡Œæ˜¯åœ¨ç»™å…ƒç±»å¯¹è±¡æ·»åŠ æ–¹æ³•å’Œå±æ€§ï¼Œä½†æ˜¯ï¼Œå…ƒç±»å¯¹è±¡æ˜¯æ²¡æœ‰åè®®çš„ã€‚ä¸æ¸…æ¥šè¿™</span></span><br><span class="line"><span class="comment">             é‡Œä¸ºä»€ä¹ˆè¦åˆ¤æ–­ `cat-&gt;protocols`ã€‚</span></span><br><span class="line"><span class="comment">             </span></span><br><span class="line"><span class="comment">             å¦å¤–ï¼Œåœ¨åé¢è·å–åˆ†ç±»çš„åè®®åˆ—è¡¨æ—¶ä¹Ÿæœ‰åˆ¤æ–­ï¼Œå¦‚æœæ˜¯ç»™å…ƒç±»æ·»åŠ çš„è¯å°±ç›´æ¥è¿”å› </span></span><br><span class="line"><span class="comment">             NULLã€‚æ„Ÿè§‰è¿™æ®µä»£ç å…¶å®å¯ä»¥åˆ æ‰ï¼Œä¸çŸ¥é“æ˜¯å¦æœ‰å…¶å®ƒéšæƒ…ï¼Ÿ</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (cat-&gt;classMethods ||</span><br><span class="line">                cat-&gt;protocols ||</span><br><span class="line">                (hasClassProperties &amp;&amp; cat-&gt;_classProperties)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cls-&gt;<span class="built_in">ISA</span>()-&gt;<span class="built_in">isRealized</span>()) &#123;</span><br><span class="line">                    <span class="comment">// å°†åˆ†ç±»ä¸­çš„ç±»æ–¹æ³•ã€ç±»å±æ€§åŠ è½½åˆ°å…ƒç±»ä¸Šã€‚</span></span><br><span class="line">                    <span class="built_in">attachCategories</span>(cls-&gt;<span class="built_in">ISA</span>(), &amp;lc, <span class="number">1</span>, cls, </span><br><span class="line">                    ATTACH_EXISTING | ATTACH_METACLASS);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// å°†åˆ†ç±»æ•°æ®å’Œå…ƒç±»å¯¹è±¡ä¿å­˜èµ·æ¥ï¼Œç­‰å…ƒç±»å¯¹è±¡å®ç°åå†è¿›è¡ŒåŠ è½½ã€‚</span></span><br><span class="line">                    objc::unattachedCategories.<span class="built_in">addForClass</span>(</span><br><span class="line">                    lc.<span class="built_in">reSignedForMetaclass</span>(cls), </span><br><span class="line">                    cls-&gt;<span class="built_in">ISA</span>());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">processCatlist</span>(hi-&gt;<span class="built_in">catlist</span>(&amp;count));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> cls: éœ€è¦æŠŠåˆ†ç±»æ•°æ®æ·»åŠ åˆ°å“ªä¸ªç±»ä¸Šã€‚</span></span><br><span class="line"><span class="comment"> å¦‚æœæ·»åŠ çš„æ˜¯å®ä¾‹æ–¹æ³•ã€å®ä¾‹å±æ€§ã€åè®®ï¼Œè¿™ä¸ªå‚æ•°å°±æ˜¯ç±»å¯¹è±¡ï¼›</span></span><br><span class="line"><span class="comment"> å¦‚æœæ·»åŠ çš„æ˜¯ç±»æ–¹æ³•ã€ç±»å±æ€§ï¼Œè¿™ä¸ªå‚æ•°å°±æ˜¯å…ƒç±»å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> cats_list: éœ€è¦è¢«æ·»åŠ çš„åˆ†ç±»æ•°æ®ï¼Œæ³¨æ„è¿™æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> catsListKey: åˆ†ç±»æ‰€å±çš„ç±»å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment"> ä¸ç®¡æ·»åŠ çš„æ˜¯å®ä¾‹æ–¹æ³•è¿˜æ˜¯ç±»æ–¹æ³•ï¼Œå§‹ç»ˆæŒ‡å‘è¯¥åˆ†ç±»æ‰€å±çš„ç±»å¯¹è±¡ï¼Œä¸ä¼šæ˜¯å…ƒç±»å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">attachCategories</span><span class="params">(Class cls,</span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="type">const</span> <span class="type">locstamped_category_t</span> *cats_list,</span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="type">uint32_t</span> cats_count,</span></span></span><br><span class="line"><span class="params"><span class="function">                 Class catsListKey,</span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="type">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="type">uint32_t</span> ATTACH_BUFSIZ = <span class="number">64</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     ä¸€ä¸ªä¸´æ—¶çš„ç¼“å­˜ç»“æ„ã€‚åˆ†ç±»ä¸­çš„æ–¹æ³•ã€å±æ€§ã€åè®®ä¼šè¢«ä¸´æ—¶æ·»åŠ åˆ°è¿™ä¸ªç¼“å­˜å¯¹è±¡ä¸­å»ï¼Œ</span></span><br><span class="line"><span class="comment">     å½“ç¼“å­˜å®¹é‡æ»¡äº†ï¼Œæˆ–è€…åˆ†ç±»ä¸­çš„æ•°æ®åŠ è½½å®Œäº†ï¼Œå†ä¸€æ¬¡æ€§æ·»åŠ åˆ°ç±»ä¸­å»ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Lists</span> &#123;</span><br><span class="line">        ReversedFixedSizeArray&lt;<span class="type">method_list_t</span> *, ATTACH_BUFSIZ&gt; methods;</span><br><span class="line">        ReversedFixedSizeArray&lt;<span class="type">property_list_t</span> *, ATTACH_BUFSIZ&gt; properties;</span><br><span class="line">        ReversedFixedSizeArray&lt;<span class="type">protocol_list_t</span> *, ATTACH_BUFSIZ&gt; protocols;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    Lists normalLists;</span><br><span class="line">    </span><br><span class="line">    <span class="type">bool</span> isMeta = (flags &amp; ATTACH_METACLASS);</span><br><span class="line">    <span class="keyword">auto</span> rwe = cls-&gt;<span class="built_in">data</span>()-&gt;<span class="built_in">extAllocIfNeeded</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; cats_count; i++) &#123;</span><br><span class="line">        <span class="comment">// entry çš„åŸå‹ï¼šlocstamped_category_t &#123;cat, cls, hi&#125;</span></span><br><span class="line">        <span class="keyword">auto</span>&amp; entry = cats_list[i];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–åˆ†ç±»ä¸­çš„æ–¹æ³•åˆ—è¡¨ã€‚</span></span><br><span class="line">        <span class="type">method_list_t</span> *mlist = entry.<span class="built_in">getCategory</span>(catsListKey)-&gt;<span class="built_in">methodsForMeta</span>(isMeta);</span><br><span class="line">        Lists *lists = &amp;normalLists;</span><br><span class="line">        <span class="type">bool</span> isPreattached = </span><br><span class="line">        entry.hi-&gt;<span class="built_in">info</span>()-&gt;<span class="built_in">dyldCategoriesOptimized</span>() &amp;&amp; !DisablePreattachedCategories;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (mlist) &#123;</span><br><span class="line">            <span class="keyword">if</span> (lists-&gt;methods.<span class="built_in">isFull</span>()) &#123;</span><br><span class="line">                <span class="comment">// å°†ç¼“å­˜ä¸­çš„æ–¹æ³•å…¨éƒ¨æ·»åŠ åˆ°ç±»/å…ƒç±»ä¸­ã€‚</span></span><br><span class="line">                rwe-&gt;methods.<span class="built_in">attachLists</span>(lists-&gt;methods.array, </span><br><span class="line">                lists-&gt;methods.count, </span><br><span class="line">                isPreattached, </span><br><span class="line">                PrintPreopt ? <span class="string">&quot;methods&quot;</span> : <span class="literal">nullptr</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// æ¸…ç©ºç¼“å­˜ã€‚</span></span><br><span class="line">                lists-&gt;methods.<span class="built_in">clear</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å°†åˆ†ç±»ä¸­çš„æ–¹æ³•æ·»åŠ åˆ°ç¼“å­˜ã€‚</span></span><br><span class="line">            lists-&gt;methods.<span class="built_in">add</span>(mlist);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–åˆ†ç±»ä¸­çš„å±æ€§åˆ—è¡¨ã€‚</span></span><br><span class="line">        <span class="type">property_list_t</span> *proplist =</span><br><span class="line">        entry.<span class="built_in">getCategory</span>(catsListKey)-&gt;<span class="built_in">propertiesForMeta</span>(isMeta, entry.hi);</span><br><span class="line">        <span class="keyword">if</span> (proplist) &#123;</span><br><span class="line">            <span class="keyword">if</span> (lists-&gt;properties.<span class="built_in">isFull</span>()) &#123;</span><br><span class="line">                <span class="comment">// å°†ç¼“å­˜ä¸­çš„å±æ€§å…¨éƒ¨æ·»åŠ åˆ°ç±»/å…ƒç±»ä¸­ã€‚</span></span><br><span class="line">                rwe-&gt;properties.<span class="built_in">attachLists</span>(lists-&gt;properties.array, </span><br><span class="line">                lists-&gt;properties.count, </span><br><span class="line">                isPreattached, </span><br><span class="line">                PrintPreopt ? <span class="string">&quot;properties&quot;</span> : <span class="literal">nullptr</span>);</span><br><span class="line">                </span><br><span class="line">                lists-&gt;properties.<span class="built_in">clear</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å°†åˆ†ç±»ä¸­çš„å±æ€§æ·»åŠ åˆ°ç¼“å­˜ã€‚</span></span><br><span class="line">            lists-&gt;properties.<span class="built_in">add</span>(proplist);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–åˆ†ç±»ä¸­çš„åè®®åˆ—è¡¨ï¼Œå†…éƒ¨ä¼šé€šè¿‡ isMeta åˆ¤æ–­å¦‚æœæ˜¯å…ƒç±»å°±è¿”å› NULLã€‚</span></span><br><span class="line">        <span class="type">protocol_list_t</span> *protolist = </span><br><span class="line">        entry.<span class="built_in">getCategory</span>(catsListKey)-&gt;<span class="built_in">protocolsForMeta</span>(isMeta);</span><br><span class="line">        <span class="keyword">if</span> (protolist) &#123;</span><br><span class="line">            <span class="keyword">if</span> (lists-&gt;protocols.<span class="built_in">isFull</span>()) &#123;</span><br><span class="line">                <span class="comment">// å°†ç¼“å­˜ä¸­çš„åè®®å…¨éƒ¨æ·»åŠ åˆ°ç±»/å…ƒç±»ä¸­ã€‚</span></span><br><span class="line">                rwe-&gt;protocols.<span class="built_in">attachLists</span>(lists-&gt;protocols.array, </span><br><span class="line">                lists-&gt;protocols.count, </span><br><span class="line">                isPreattached, </span><br><span class="line">                PrintPreopt ? <span class="string">&quot;protocols&quot;</span> : <span class="literal">nullptr</span>);</span><br><span class="line">                </span><br><span class="line">                lists-&gt;protocols.<span class="built_in">clear</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å°†åˆ†ç±»ä¸­çš„åè®®æ·»åŠ åˆ°ç¼“å­˜ã€‚</span></span><br><span class="line">            lists-&gt;protocols.<span class="built_in">add</span>(protolist);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°†ç¼“å­˜é‡Œçš„æ–¹æ³•ã€å±æ€§ã€åè®®å…¨éƒ¨æ·»åŠ åˆ°ç±»/å…ƒç±»ä¸­ã€‚</span></span><br><span class="line">    <span class="keyword">auto</span> attach = [&amp;](Lists *lists, <span class="type">bool</span> isPreattached) &#123;</span><br><span class="line">        <span class="comment">// å°†ç¼“å­˜é‡Œçš„æ–¹æ³•æ·»åŠ åˆ°ç±»/å…ƒç±»ä¸­ã€‚</span></span><br><span class="line">        rwe-&gt;methods.<span class="built_in">attachLists</span>(lists-&gt;methods.<span class="built_in">begin</span>(), </span><br><span class="line">        lists-&gt;methods.count, </span><br><span class="line">        isPreattached, </span><br><span class="line">        PrintPreopt ? <span class="string">&quot;methods&quot;</span> : <span class="literal">nullptr</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å°†ç¼“å­˜é‡Œçš„å±æ€§æ·»åŠ åˆ°ç±»/å…ƒç±»ä¸­ã€‚</span></span><br><span class="line">        rwe-&gt;properties.<span class="built_in">attachLists</span>(lists-&gt;properties.<span class="built_in">begin</span>(), </span><br><span class="line">        lists-&gt;properties.count, </span><br><span class="line">        isPreattached, </span><br><span class="line">        PrintPreopt ? <span class="string">&quot;properties&quot;</span> : <span class="literal">nullptr</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å°†ç¼“å­˜é‡Œçš„åè®®æ·»åŠ åˆ°ç±»ä¸­ã€‚</span></span><br><span class="line">        rwe-&gt;protocols.<span class="built_in">attachLists</span>(lists-&gt;protocols.<span class="built_in">begin</span>(), </span><br><span class="line">        lists-&gt;protocols.count, </span><br><span class="line">        isPreattached, </span><br><span class="line">        PrintPreopt ? <span class="string">&quot;protocols&quot;</span> : <span class="literal">nullptr</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">attach</span>(&amp;normalLists, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯æŠŠæ–¹æ³•ã€å±æ€§ã€åè®®æ·»åŠ åˆ°ç±»/å…ƒç±»ä¸­ï¼Œ</span></span><br><span class="line"><span class="comment"> ä¸ä¸€å®šæ˜¯æ·»åŠ åˆ†ç±»ä¸­çš„æ•°æ®ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æ·»åŠ ç±»è‡ªèº«çš„æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">attachLists</span><span class="params">(List* <span class="type">const</span> * addedLists,</span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="type">uint32_t</span> addedCount,</span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="type">bool</span> preoptimized,</span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="type">const</span> <span class="type">char</span> *logKind)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (addedCount == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿™ä¸ªåˆ†æ”¯é€šå¸¸æ˜¯ç”¨æ¥æ·»åŠ ç±»è‡ªèº«çš„æ–¹æ³•ã€å±æ€§ã€åè®®ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (storage.<span class="built_in">isNull</span>() &amp;&amp; addedCount == <span class="number">1</span>) &#123;</span><br><span class="line">        storage.<span class="built_in">set</span>(*addedLists);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è¿™ä¸ªåˆ†æ”¯é€šå¸¸æ˜¯ç”¨æ¥å¤„ç†ç¬¬1ä¸ªåˆ†ç±»çš„æ•°æ®ã€‚</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (storage.<span class="built_in">isNull</span>() || storage.<span class="keyword">template</span> <span class="built_in">is</span>&lt;List *&gt;()) &#123;</span><br><span class="line">        <span class="comment">// 0 or 1 list -&gt; many lists</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–æ—§æ•°æ®ã€‚</span></span><br><span class="line">        List *oldList = storage.<span class="keyword">template</span> <span class="built_in">dyn_cast</span>&lt;List *&gt;();</span><br><span class="line">        <span class="type">uint32_t</span> oldCount = oldList ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">        <span class="type">uint32_t</span> newCount = oldCount + addedCount;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¼€è¾Ÿä¸€ä¸ªæ–°æ•°ç»„ï¼Œè¶³ä»¥å®¹çº³æ—§æ•°æ®åŠ ä¸Šåˆ†ç±»ä¸­çš„æ–°æ•°æ®ã€‚</span></span><br><span class="line">        <span class="type">array_t</span> *array = (<span class="type">array_t</span> *)<span class="built_in">malloc</span>(<span class="type">array_t</span>::<span class="built_in">byteSize</span>(newCount));</span><br><span class="line">        storage.<span class="built_in">set</span>(array);</span><br><span class="line">        array-&gt;count = newCount;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         å°†ç±»ä¸­åŸæ¥çš„æ•°æ®ï¼ˆæ–¹æ³•ã€å±æ€§ã€åè®®ï¼‰æ”¾åˆ°æ•°ç»„æœ€åé¢ã€‚</span></span><br><span class="line"><span class="comment">         è¿™ä¸€æ­¥ä¿è¯äº†ç±»è‡ªèº«çš„æ•°æ®æ°¸è¿œå¤„äºåˆ—è¡¨çš„æœ€åé¢ã€‚         </span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (oldList) array-&gt;lists[addedCount] = oldList;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å°†åˆ†ç±»ä¸­çš„æ•°æ®æ’å…¥åˆ°æ•°ç»„çš„å‰é¢ã€‚</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">unsigned</span> i = <span class="number">0</span>; i &lt; addedCount; i++)</span><br><span class="line">            array-&gt;lists[i] = addedLists[i];</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// è¿™ä¸ªåˆ†æ”¯é€šå¸¸æ˜¯ç”¨æ¥åŠ è½½ç¬¬2ä¸ªåŠä¹‹åçš„åˆ†ç±»æ•°æ®ã€‚</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">array_t</span> *array = storage.<span class="keyword">template</span> <span class="built_in">dyn_cast</span>&lt;<span class="type">array_t</span> *&gt;()) &#123;</span><br><span class="line">        <span class="comment">// many lists -&gt; many lists</span></span><br><span class="line">        <span class="type">uint32_t</span> oldCount = array-&gt;count;</span><br><span class="line">        <span class="type">uint32_t</span> newCount = oldCount + addedCount;</span><br><span class="line">        <span class="type">array_t</span> *newArray = (<span class="type">array_t</span> *)<span class="built_in">malloc</span>(<span class="type">array_t</span>::<span class="built_in">byteSize</span>(newCount));</span><br><span class="line">        newArray-&gt;count = newCount;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æŠŠæ—§æ•°æ®æŒ‰ç…§ä¹‹å‰çš„é¡ºåºæ”¾åˆ°æ–°æ•°ç»„çš„æœ€åé¢ã€‚</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = oldCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">            newArray-&gt;lists[i + addedCount] = array-&gt;lists[i];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         å°†åˆ†ç±»æ•°æ®ä¾æ¬¡æ·»åŠ åˆ°æ•°ç»„çš„å‰é¢ï¼Œ</span></span><br><span class="line"><span class="comment">         è¿™ä¸€æ­¥æ“ä½œä¼šå¯¼è‡´æœ€åç¼–è¯‘çš„åˆ†ç±»æ•°æ®å°†ä¼šè¢«æ·»åŠ åœ¨æ•°ç»„çš„æœ€å‰é¢ã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">unsigned</span> i = <span class="number">0</span>; i &lt; addedCount; i++)</span><br><span class="line">            newArray-&gt;lists[i] = addedLists[i];</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">free</span>(array);</span><br><span class="line">        storage.<span class="built_in">set</span>(newArray);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šæ¥åˆ°è¿™ä¸ªåˆ†æ”¯ï¼Œ</span></span><br><span class="line"><span class="comment">         åœ¨ä¹‹å‰çš„å‡½æ•° load_categories_nolock ä¸­æœ‰è¿™æ ·ä¸€è¡Œä»£ç ï¼š</span></span><br><span class="line"><span class="comment">         `objc::unattachedCategories.addForClass(lc, cls);`</span></span><br><span class="line"><span class="comment">         è¿™ä¸ªåˆ†æ”¯å°±æ˜¯ç”¨æ¥å¤„ç†è¿™ç§æƒ…å†µã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">auto</span> *listList = storage.<span class="keyword">template</span> dyn_cast&lt;<span class="type">relative_list_list_t</span>&lt;List&gt; *&gt;()) &#123;</span><br><span class="line">        <span class="comment">// list-of-lists -&gt; many lists</span></span><br><span class="line">        <span class="keyword">auto</span> listListBegin = listList-&gt;<span class="built_in">beginLists</span>();</span><br><span class="line">        <span class="type">uint32_t</span> oldCount = listList-&gt;<span class="built_in">countLists</span>();</span><br><span class="line">        <span class="type">uint32_t</span> newCount = oldCount + addedCount;</span><br><span class="line">        <span class="type">array_t</span> *newArray = (<span class="type">array_t</span> *)<span class="built_in">malloc</span>(<span class="type">array_t</span>::<span class="built_in">byteSize</span>(newCount));</span><br><span class="line">        newArray-&gt;count = newCount;</span><br><span class="line">        </span><br><span class="line">        <span class="type">uint32_t</span> i;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; addedCount; i++) &#123;</span><br><span class="line">            newArray-&gt;lists[i] = addedLists[i];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (; i &lt; newCount; i++) &#123;</span><br><span class="line">            newArray-&gt;lists[i] = *listListBegin;</span><br><span class="line">            ++listListBegin;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        storage.<span class="built_in">set</span>(newArray);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»æºç ä¸­ä¸éš¾å‘ç°ï¼ŒCategory ä¸­çš„æ•°æ®ï¼ˆæ–¹æ³•ã€å±æ€§ã€åè®®ï¼‰éƒ½æ˜¯åœ¨è¿è¡Œæ—¶é€šè¿‡ Runtime åŠ¨æ€æ·»åŠ åˆ°ç±»ä¸­ä¸€ä¸ªå«åš rwe çš„å¯¹è±¡ä¸­ã€‚</p><p>åœ¨ rwe è¿™ä¸ªå¯¹è±¡ä¸­æ‹¥æœ‰ä¸‰ä¸ªå˜é‡ï¼Œåˆ†åˆ«æ˜¯ï¼šæ–¹æ³•åˆ—è¡¨ã€å±æ€§åˆ—è¡¨ã€åè®®åˆ—è¡¨ï¼Œè¿™ä¸ªå˜é‡å…¶å®å°±æ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„ã€‚ä»¥æ–¹æ³•åˆ—è¡¨ä¸ºä¾‹ï¼Œç±»è‡ªèº«çš„æ‰€æœ‰æ–¹æ³•æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ª Category ä¸­çš„æ‰€æœ‰æ–¹æ³•æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå®ƒä»¬éƒ½è¢«æ”¾åœ¨è¿™ä¸ªäºŒç»´æ•°ç»„ä¸­ï¼Œæ³¨æ„ï¼Œç±»è‡ªèº«çš„æ–¹æ³•åˆ—è¡¨æ”¾åœ¨è¿™ä¸ªäºŒç»´æ•°ç»„çš„æœ€åé¢ï¼Œæœ€åç¼–è¯‘çš„é‚£ä¸ª Category ä¸­çš„æ–¹æ³•åˆ—è¡¨æ”¾åœ¨è¿™ä¸ªäºŒç»´æ•°ç»„çš„æœ€å‰é¢ã€‚</p><p>æ­£æ˜¯å› ä¸ºè¿™ä¸ªç‰¹ç‚¹æ‰å¯¼è‡´äº† Category ä¸­çš„æ–¹æ³•å®ç°ä¼šè¦†ç›–ä¸ç±»æœ¬èº«åŒåçš„æ–¹æ³•å®ç°ã€‚æ‰€ä»¥ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­æˆ‘ä»¬ç»å¸¸ä¼šçœ‹åˆ°å¾ˆå¤šæ¡†æ¶éƒ½ä¼šç»™ Category çš„æ–¹æ³•å’Œå±æ€§æ·»åŠ å‰ç¼€ï¼Œå…¶ç›®çš„å°±æ˜¯ä¸ºäº†é™ä½é‡åçš„å¯èƒ½æ€§ã€‚</p><p>æœ‰äº›äººè¯´ Category ä¸æ”¯æŒæ·»åŠ å®ä¾‹å˜é‡æ˜¯å› ä¸º <code>category_t</code> ç»“æ„ä½“ä¸­æ²¡æœ‰ <code>ivars</code> å­—æ®µã€‚å…¶å®å¹¶ä¸æ˜¯æ·»åŠ ä¸€ä¸ªå­—æ®µçš„äº‹ï¼Œæ ¹æœ¬åŸå› æ˜¯å› ä¸ºå¼€å‘è€…å¯èƒ½ä¼šç”¨ Category ç»™å·²ç»ç¼–è¯‘å¥½çš„ç±»ï¼ˆä¾‹å¦‚ç³»ç»Ÿç±»ï¼‰æ·»åŠ æ•°æ®ï¼Œè€Œè¿™äº›ç±»çš„å†…å­˜å¸ƒå±€ä¸åœ°å€å·²ç»å›ºå®šæ­»äº†ï¼Œå¦‚æœè¦ç»™å®ƒæ·»åŠ å®ä¾‹å˜é‡åŠ¿å¿…è¦ä¿®æ”¹å…¶å†…å­˜å¸ƒå±€ä¸åœ°å€ã€‚</p><p>å¦å¤–ï¼Œä¹Ÿä¸èƒ½ç»™ Category æ·»åŠ  weak å±æ€§ï¼Œå¦‚æœä¸€å®šè¦æ·»åŠ  weak å±æ€§çš„è¯ï¼Œå¯ä»¥é‡‡ç”¨ä¸­é—´è€…æ¨¡å¼ï¼Œå³ç»™ Category æ·»åŠ ä¸€ä¸ªä¸­é—´è€…å¯¹è±¡ï¼Œç„¶åç»™è¿™ä¸ªä¸­é—´ç±»å£°æ˜ä¸€ä¸ª weak å±æ€§ã€‚å…³äº weak æŒ‡é’ˆçš„æ›´å¤šç»†èŠ‚è¯·çœ‹æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç«  <a href="/2023/10/21/iOS/%E6%8F%AD%E5%BC%80%20iOS%20%E4%B8%AD%20weak%20%E6%8C%87%E9%92%88%E7%9A%84%E7%A5%9E%E7%A7%98%E9%9D%A2%E7%BA%B1%EF%BC%9A%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E5%AE%9E%E8%B7%B5/" title="æ­å¼€ iOS ä¸­ weak æŒ‡é’ˆçš„ç¥ç§˜é¢çº±ï¼šä»åŸç†åˆ°å®è·µ">æ­å¼€ iOS ä¸­ weak æŒ‡é’ˆçš„ç¥ç§˜é¢çº±ï¼šä»åŸç†åˆ°å®è·µ</a></p><p>æˆ‘åœ¨ç½‘ä¸Šçœ‹åˆ°æœ‰äº›äººè¯´ä¸ºä»€ä¹ˆè¦æŠŠ Category è®¾è®¡æˆä½¿ç”¨ Runtime è¿è¡Œæ—¶åŠ è½½ï¼Œç›´æ¥è®¾è®¡æˆç¼–è¯‘æ—¶åŠ è½½ä¸æ˜¯æ›´å¥½å—ï¼Ÿä»–ä»¬çš„æƒ³æ³•æ˜¯ï¼šâ€œåœ¨ç»™é¡¹ç›®ä¸­æŸä¸ªç±»ï¼ˆè¿™ä¸ªç±»æ˜¯åœ¨é¡¹ç›®ä¸­åˆ›å»ºçš„ï¼‰ï¼Œä¾‹å¦‚ CustomClass åˆ›å»ºåˆ†ç±»æ—¶ï¼Œç¼–è¯‘å™¨å…¶å®èƒ½æ‹¿åˆ° CustomClass çš„å®ç°æ–‡ä»¶ï¼Œé‚£ä¹ˆåªè¦æŠŠåˆ†ç±»ä¸­çš„æ–¹æ³•å’Œè¿™ä¸ªç±»è‡ªèº«çš„æ–¹æ³•åˆå¹¶ä¸å°±è¡Œäº†ï¼Œè¿™æ ·è¿˜èƒ½å®ç°åœ¨ Category ä¸­ç»™è¿™ä¸ªç±»æ·»åŠ å®ä¾‹å˜é‡ã€‚â€ ä¹ä¸€çœ‹æ²¡å•¥é—®é¢˜ã€‚ä½†æ˜¯ï¼ŒCategory è¿˜æ”¯æŒç»™å·²ç»ç¼–è¯‘å¥½çš„ç±»ï¼ˆä¾‹å¦‚ç³»ç»Ÿç±»ï¼‰æ·»åŠ æ–¹æ³•å®ç°ï¼Œè€Œè¿™äº›ç±»çš„å¸ƒå±€å’Œåœ°å€å·²ç»å›ºå®šæ­»äº†ï¼Œå› è€Œä¸èƒ½è¿™ä¹ˆå¹²ã€‚</p><p>åœ¨é˜…è¯»æºç çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘è¿˜å‘ç°äº†ä¸€äº›å…¶å®ƒé—®é¢˜ï¼š</p><ol><li><p>åœ¨å‰é¢çš„ <code>test_category.m</code> æ–‡ä»¶ä¸­ï¼Œæˆ‘ç‰¹æ„æ²¡æœ‰åœ¨å®ç°ä¸­å†™ä¸Šå±æ€§å’Œåè®®çš„å®ç°ã€‚å› ä¸ºç»è¿‡æˆ‘çš„è°ƒè¯•å‘ç°ï¼ŒRuntime åœ¨è§£æ Category ä¸­çš„å±æ€§å’Œåè®®æ—¶ï¼Œåªçœ‹å£°æ˜å¹¶ä¸çœ‹å®ç°ï¼Œåªè¦æœ‰å±æ€§ã€åè®®å£°æ˜ï¼Œä¸ç®¡æœ‰æ²¡æœ‰å®ç°éƒ½ä¼šè¢«æ·»åŠ åˆ°ç±»çš„å±æ€§åˆ—è¡¨å’Œåè®®åˆ—è¡¨ä¸­ã€‚ä½†æ˜¯åœ¨è§£ææ–¹æ³•çš„æ—¶å€™æ˜¯åè¿‡æ¥çš„ï¼Œåªä¼šæŠŠæœ‰æ–¹æ³•å®ç°çš„é‚£äº›æ–¹æ³•æ·»åŠ åˆ°æ–¹æ³•åˆ—è¡¨ä¸­ã€‚</p></li><li><p>åœ¨ç¬¬1ä¸ªå‡½æ•° load_images ä¸­æœ‰è¿™ä¹ˆä¸€ä¸ªåˆ¤æ–­ï¼šå¦‚æœè¯¥æ¨¡å—ä¸­æ²¡æœ‰ <code>+load</code> æ–¹æ³•å®ç°å°±ä¸æ·»åŠ  Category æ•°æ®ã€‚æˆ‘æŸ¥é˜…äº†è®¸å¤šèµ„æ–™ï¼Œä½†æ˜¯éƒ½æ²¡æœ‰æ‰¾åˆ°å¯ä¿¡çš„è¯æ®è§£é‡Šä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Ÿå¦‚æœä½ çŸ¥é“ä¸ºä»€ä¹ˆçš„è¯è¿˜è¯·ç•™è¨€å‘ŠçŸ¥ã€‚</p></li><li><p>Runtime ä¼šåœ¨ <code>loadAllCategoriesIfNeeded</code> å‡½æ•°å†…ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ¨¡å—ä¸­çš„åˆ†ç±»æ•°æ®ï¼Œè€Œä¸æ˜¯éå†ä¸€ä¸ªæ¨¡å—åŠ è½½ä¸€ä¸ªæ¨¡å—ä¸­çš„åˆ†ç±»æ•°æ®ã€‚æˆ‘æƒ³äº†ä¸€ä¸‹ï¼Œè¿™ä¹ˆåšæœ‰ä»¥ä¸‹å¥½å¤„ï¼šé™ä½ç¨‹åºçš„å¤æ‚åº¦å’Œæé«˜æ€§èƒ½ã€‚å¦‚æœæ˜¯éå†ä¸€ä¸ªæ¨¡å—åŠ è½½ä¸€ä¸ªæ¨¡å—çš„æ•°æ®ï¼Œé‚£å°±ä¸èƒ½åªä½¿ç”¨ä¸€ä¸ªå…¨å±€å˜é‡ <code>didInitialAttachCategories</code> æ¥æ ‡è®°åˆ†ç±»æ•°æ®æ˜¯å¦å·²åŠ è½½ï¼Ÿå¯èƒ½è¦ç»´æŠ¤ä¸€ä¸ªå­—å…¸ï¼Œä¾‹å¦‚ key æ˜¯æ¨¡å—åç§°ï¼Œvalue è¡¨ç¤ºè¯¥æ¨¡å—æ˜¯å¦å·²åŠ è½½åˆ†ç±»ã€‚è¿™ä¹ˆåšæ˜¾ç„¶æ¯”ç»´æŠ¤ä¸€ä¸ªå…¨å±€å˜é‡æˆæœ¬æ›´é«˜ã€‚</p></li></ol><h2 id="Category-ä¸-Extension-çš„åŒºåˆ«"><a href="#Category-ä¸-Extension-çš„åŒºåˆ«" class="headerlink" title="Category ä¸ Extension çš„åŒºåˆ«"></a>Category ä¸ Extension çš„åŒºåˆ«</h2><p>ç»å¸¸æœ‰äººæŠŠ Category å’Œ Extension æ‹¿åˆ°ä¸€èµ·æ¥è¯´ï¼Œå¯èƒ½æ˜¯å› ä¸ºå®ƒä»¬çš„å£°æ˜æ–¹å¼æœ‰ç‚¹åƒå§ï¼Œä»¥ä¸‹æ˜¯ Category å’Œ Extension çš„å£°æ˜ä»£ç ï¼š</p><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Category å£°æ˜</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> (<span class="title">CategoryName</span>) @<span class="title">end</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Extension å£°æ˜</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> () @<span class="title">end</span></span></span><br></pre></td></tr></table></figure><p>ä»ä»£ç æ¥çœ‹ï¼ŒCategory ä¼¼ä¹åªå¤šäº†ä¸€ä¸ª name è€Œå·²ã€‚æ‰€ä»¥å¯¼è‡´å¾ˆå¤šäººä»¥ä¸ºå®ƒä»¬çš„åº•å±‚å®ç°å¯èƒ½å·®ä¸å¤šï¼Œä½†å…¶å®å®ƒä»¬çš„å®ç°å‹æ ¹ä¸ä¸€æ ·ã€‚</p><h3 id="Extension-çš„ç‰¹ç‚¹"><a href="#Extension-çš„ç‰¹ç‚¹" class="headerlink" title="Extension çš„ç‰¹ç‚¹"></a>Extension çš„ç‰¹ç‚¹</h3><p>ä»åŠŸèƒ½å’Œåº•å±‚å®ç°ä¸Šæ¥çœ‹ï¼Œå…¶å® Extension å’Œ Interface(ç±»å£°æ˜) æ›´åƒä¸€äº›ï¼ŒInterface èƒ½å¹²çš„äº‹ï¼Œå®ƒåŸºæœ¬ä¸Šéƒ½èƒ½å¹²ï¼Œé™¤äº†ä¸èƒ½æŒ‡å®šçˆ¶ç±»ã€‚</p><p>Interface ä¸€èˆ¬æ˜¯ç”¨æ¥å¯¹å¤–æä¾›æ¥å£æ•°æ®ï¼Œä½†æœ‰æ—¶å€™æˆ‘ä»¬ä¼šæƒ³æŠŠä¸€äº›å±æ€§ã€æ–¹æ³•ã€å®ä¾‹å˜é‡éšè—èµ·æ¥ã€‚Extension å°±æ˜¯ä¸“é—¨ç”¨æ¥å¹²è¿™ä¸ªçš„ï¼Œå› ä¸º Interface åªèƒ½æœ‰ä¸€ä¸ªï¼Œä½† Extension å¯ä»¥æœ‰å¤šä¸ªã€‚Extension å’Œç±»å£°æ˜éƒ½æ˜¯ç¼–è¯‘ç‰¹æ€§ï¼Œä½ å¯ä»¥åœ¨ Extension ä¸­å£°æ˜å®ä¾‹å˜é‡ã€å±æ€§ã€æ–¹æ³•ã€åè®®ï¼Œè¿™å’Œåœ¨ Interface ä¸­å†™æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œè™½ç„¶åœ¨ Extension ä¸­å¯ä»¥å£°æ˜å®ä¾‹å˜é‡ï¼Œä½†ä»…åœ¨æ‹¥æœ‰ implementation å®ç°çš„è¿™ä¸ªæ–‡ä»¶ä¸­è¿™ä¹ˆåšæ‰å¯ä»¥ï¼Œä¾‹å¦‚ä»¥ä¸‹ä»£ç å°±å¯ä»¥ï¼Œå› ä¸ºè¿™ä¸ªæ–‡ä»¶ä¸­æ‹¥æœ‰ Book çš„å®ç°ï¼š</p><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Book</span> () </span>&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *_name;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Book</span></span></span><br><span class="line">- (<span class="type">void</span>)testFun &#123;</span><br><span class="line">    _name = <span class="string">@&quot;&quot;</span>;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, _name);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ä¸‹é¢çš„ä»£ç å°±ä¸è¡Œï¼Œå› ä¸ºè¿™ä¸ªæ–‡ä»¶ä¸­æ²¡æœ‰ Book ç±»çš„å®ç°ï¼Œæ­¤æ—¶ä½ ä¼šå¾—åˆ°ä¸€ä¸ªç¼–è¯‘é”™è¯¯ï¼š</p><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Book</span> () </span>&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *_name;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Book</span> (<span class="title">CategoryName</span>)</span></span><br><span class="line">- (<span class="type">void</span>)testFun &#123;</span><br><span class="line">    _name = <span class="string">@&quot;&quot;</span>;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, _name);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></blockquote><p>å¦å¤–ï¼Œè™½ç„¶åœ¨ä»»ä½•åœ°æ–¹éƒ½èƒ½ä½¿ç”¨ Extensionï¼Œä½†æ˜¯å’Œä¸Šé¢çš„å®ä¾‹å˜é‡ä¸€æ ·ï¼Œå¦‚æœéœ€è¦ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆå®ç°ä»£ç ï¼ˆä¾‹å¦‚å±æ€§ï¼‰ï¼Œé‚£å°±ä¸èƒ½åœ¨ implementation ä¹‹å¤–çš„æ–‡ä»¶ä½¿ç”¨ï¼Œåˆ‡è®°ï¼ï¼ï¼</p><p>Extension è¿˜æœ‰ä¸€ä¸ªå¥½ç”¨çš„åŠŸèƒ½å°±æ˜¯å£°æ˜ç§æœ‰æ–¹æ³•ï¼Œè¿™æ ·å°±èƒ½åœ¨åé¢çš„ä»£ç ä¸­ç›´æ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•äº†ï¼Œè€Œä¸æ˜¯å†™æˆè¿™æ ·ï¼š<code>[self performSelector:@selector(testFun)]</code>ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šäººæ˜¯ä½¿ç”¨ Category å¹²è¿™ä¸ªäº‹ï¼Œå…¶å® Extension ä¹Ÿå¯ä»¥ï¼Œä¸ªäººæ„Ÿè§‰è¿™æ ·æ›´ä¼˜é›…ã€‚</p><h3 id="Category-çš„ç‰¹ç‚¹"><a href="#Category-çš„ç‰¹ç‚¹" class="headerlink" title="Category çš„ç‰¹ç‚¹"></a>Category çš„ç‰¹ç‚¹</h3><p>ä¸ Extension ç›¸æ¯”ï¼ŒCategory æ˜¯ç¼–è¯‘å™¨åŠ ä¸Š Runtime å…±åŒå®Œæˆçš„ã€‚ç¼–è¯‘å™¨è´Ÿè´£å°† Category ç¼–è¯‘æˆ <code>category_t</code> å¯¹è±¡ï¼Œç„¶åæ·»åŠ åˆ° Mach-O æ–‡ä»¶ä¸­ã€‚Runtime è´Ÿè´£åœ¨è¿è¡Œæ—¶å°† <code>category_t</code> ä¸­çš„æ•°æ®è§£æå¹¶æ·»åŠ åˆ°å¯¹åº”çš„ç±»ä¸­ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä»è‹¹æœæä¾›çš„æºç ä¸­æˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œå…¶å® Category çš„åº•å±‚å®ç°å¹¶ä¸å¤æ‚ï¼Œå…¶æœ¬è´¨å°±æ˜¯å°† Category è½¬åŒ–æˆä¸€ä¸ªç»“æ„ä½“ç”¨æ¥ä¿å­˜ç›¸å…³æ•°æ®ï¼ˆå±æ€§ã€æ–¹æ³•ã€åè®®ï¼‰ï¼Œç„¶åé€šè¿‡ Runtime åœ¨è¿è¡Œæ—¶å°†è¿™ä¸ªç»“æ„ä½“ä¸­çš„æ•°æ®è§£æå‡ºæ¥å¹¶ä¸”æ·»åŠ åˆ°ç±»ä¸­ã€‚è€Œè¿™ä¸ªç±»å¯¹è±¡å†…éƒ¨æœ‰ä¸€ä¸ªäºŒç»´æ•°ç»„æ¥å­˜å‚¨æ¯ä¸ªåˆ†ç±»ä¸­çš„æ•°æ®ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ObjC </tag>
            
            <tag> Runtime </tag>
            
            <tag> Category </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥è§£æ iOS-RunLoopï¼šäº‹ä»¶é©±åŠ¨çš„æ ¸å¿ƒæœºåˆ¶</title>
      <link href="/2024/04/28/iOS/%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90%20iOS-RunLoop%EF%BC%9A%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E7%9A%84%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6/"/>
      <url>/2024/04/28/iOS/%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90%20iOS-RunLoop%EF%BC%9A%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8%E7%9A%84%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç”± å¸ƒå¤š(budo) å‘å¸ƒäº 2024-04-28 â€¢ æœ€åæ›´æ–°äº 2025-03-21</p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>RunLoop æ˜¯ iOS å¼€å‘ä¸­çš„ä¸€ä¸ªåŸºç¡€æ¦‚å¿µï¼Œè‹¹æœæœ‰è®¸å¤šåŠŸèƒ½éƒ½ä¾èµ–äº RunLoopï¼Œä¾‹å¦‚çº¿ç¨‹ä¸­çš„è‡ªåŠ¨é‡Šæ”¾æ± ã€NSTimerã€ç³»ç»Ÿäº‹ä»¶å“åº”ã€å±å¹•åˆ·æ–°ç­‰ã€‚æœ¬æ–‡å°†æ·±å…¥å‰–æ iOS ä¸­ RunLoop çš„å†…éƒ¨å®ç°ç»†èŠ‚ï¼Œå¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£è¿™ä¸€æœºåˆ¶ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯-Even-Loop"><a href="#ä»€ä¹ˆæ˜¯-Even-Loop" class="headerlink" title="ä»€ä¹ˆæ˜¯ Even Loop"></a>ä»€ä¹ˆæ˜¯ Even Loop</h2><p>åœ¨è®¨è®º RunLoop ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹çº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µã€‚é€šå¸¸ï¼Œçº¿ç¨‹æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡åå°±ä¼šé€€å‡ºï¼Œè¦é‡æ–°æ‰§è¡Œä»»åŠ¡åªèƒ½å†åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ã€‚ä½†å¦‚æœæˆ‘ä»¬å¸Œæœ›çº¿ç¨‹åœ¨å¤„ç†å®Œä»»åŠ¡åä¸é€€å‡ºï¼Œè€Œæ˜¯ç­‰å¾…å¹¶å¤„ç†æ–°çš„ä»»åŠ¡ï¼Œå°±éœ€è¦ä¸€ç§æœºåˆ¶æ¥ä¿æŒçº¿ç¨‹çš„æ´»åŠ¨çŠ¶æ€ï¼Œè¿™å°±æ˜¯ <a href="https://en.wikipedia.org/wiki/Event_loop">Even Loop</a>ï¼ˆäº‹ä»¶å¾ªç¯ï¼‰ã€‚</p><p>åœ¨ iOS ä¸­ï¼Œè¿™ä¸ªæœºåˆ¶ç”± RunLoop å®ç°ã€‚å®ƒæ˜¯ä¸€ä¸ªæŒç»­è¿è¡Œçš„å¾ªç¯ï¼Œè´Ÿè´£ç®¡ç†çº¿ç¨‹ä¸­çš„äº‹ä»¶å’Œæ¶ˆæ¯ï¼Œç¡®ä¿çº¿ç¨‹åœ¨æ²¡æœ‰ä»»åŠ¡æ—¶è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œåœ¨æœ‰ä»»åŠ¡æ—¶è¢«å”¤é†’å¹¶å¤„ç†ã€‚</p><h2 id="RunLoop-çš„å·¥ä½œåŸç†"><a href="#RunLoop-çš„å·¥ä½œåŸç†" class="headerlink" title="RunLoop çš„å·¥ä½œåŸç†"></a>RunLoop çš„å·¥ä½œåŸç†</h2><p>RunLoop æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒç®¡ç†éœ€è¦å¤„ç†çš„äº‹ä»¶ã€‚çº¿ç¨‹å¯åŠ¨ RunLoop åï¼Œä¼šä¸€ç›´å¤„ç†ã€Œæ¥å—æ¶ˆæ¯ -&gt; å¤„ç†æ¶ˆæ¯ -&gt; ç­‰å¾…æ¶ˆæ¯ã€çš„å¾ªç¯ä¸­ï¼Œå®ç°é€»è¾‘å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">startRunLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        var message = <span class="built_in">get_next_message</span>();</span><br><span class="line">        <span class="built_in">process_message</span>(message);</span><br><span class="line">    &#125; <span class="keyword">while</span> (message != quit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="RunLoop-çš„å®ç°ç»†èŠ‚"><a href="#RunLoop-çš„å®ç°ç»†èŠ‚" class="headerlink" title="RunLoop çš„å®ç°ç»†èŠ‚"></a>RunLoop çš„å®ç°ç»†èŠ‚</h2><p>åœ¨ iOS ä¸­ï¼ŒRunLoop é€šè¿‡ä¸¤ä¸ªå¯¹è±¡æä¾›ï¼šNSRunLoop å’Œ CFRunLoopRefã€‚å…¶ä¸­ï¼ŒNSRunLoop æ˜¯ CFRunLoopRef çš„å°è£…ï¼Œæä¾›äº†é¢å‘å¯¹è±¡çš„ APIã€‚</p><p>RunLoop è¢«åŒ…å«åœ¨å¼€æºé¡¹ç›® <a href="https://github.com/apple-oss-distributions/CF">Core Foundation</a> ä¸­ï¼Œä½ å¯ä»¥ä¸‹è½½æŸ¥çœ‹ã€‚</p><blockquote><p>æœ¬æ–‡ä½¿ç”¨çš„ Core Foundation ç‰ˆæœ¬æ˜¯ <a href="https://github.com/apple-oss-distributions/CF/releases/tag/CF-1153.18">CF-1153.18</a>ï¼Œä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œæˆ‘å¯¹ä»£ç æ ·å¼å’Œæ’ç‰ˆç•¥ä½œäº†ä¿®æ”¹ä»¥åŠåˆ å‡äº†ä¸€äº›ä¸å½±å“ä¸»é€»è¾‘çš„å†—ä½™ä»£ç ã€‚</p></blockquote><h3 id="RunLoop-å…¥å£"><a href="#RunLoop-å…¥å£" class="headerlink" title="RunLoop å…¥å£"></a>RunLoop å…¥å£</h3><p>é¦–å…ˆçœ‹çœ‹ CFRunLoopRun å’Œ CFRunLoopRunInMode çš„å®ç°ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°è´Ÿè´£å¯åŠ¨ RunLoopï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨é»˜è®¤ Mode å¯åŠ¨ã€‚</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CFRunLoopRun</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="type">int32_t</span> result;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        result = <span class="built_in">CFRunLoopRunSpecific</span>(<span class="built_in">CFRunLoopGetCurrent</span>(), kCFRunLoopDefaultMode, <span class="number">1.0e10</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">while</span> (kCFRunLoopRunStopped != result &amp;&amp; kCFRunLoopRunFinished != result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">- modeName: æŒ‡å®šè¦ä½¿ç”¨çš„ Modeã€‚</span></span><br><span class="line"><span class="comment">- seconds: è®¾ç½® RunLoop çš„è¶…æ—¶æ—¶é—´ã€‚</span></span><br><span class="line"><span class="comment">- returnAfterSourceHandled: å¦‚æœæ˜¯YESï¼Œåˆ™è¿è¡Œå®Œåç«‹å³è¿”å›ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">SInt32 <span class="title">CFRunLoopRunInMode</span><span class="params">(CFStringRef modeName,</span></span></span><br><span class="line"><span class="params"><span class="function">                          CFTimeInterval seconds,</span></span></span><br><span class="line"><span class="params"><span class="function">                          Boolean returnAfterSourceHandled)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CFRunLoopRunSpecific</span>(<span class="built_in">CFRunLoopGetCurrent</span>(),</span><br><span class="line">                                modeName,</span><br><span class="line">                                seconds,</span><br><span class="line">                                returnAfterSourceHandled);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è°ƒç”¨ <code>CFRunLoopRunSpecific</code>ï¼ŒRunLoop ä¼šè¿›å…¥å…·ä½“çš„æ¨¡å¼è¿›è¡Œè¿è¡Œï¼Œç›´åˆ°æ»¡è¶³é€€å‡ºçš„æ¡ä»¶ã€‚</p><p>æ¥ä¸‹æ¥çš„å…³é”®å‡½æ•°æ˜¯ CFRunLoopRunSpecificï¼Œå®ƒä¼šè·å–æŒ‡å®šçš„ Modeï¼Œç„¶åè¿›å…¥ RunLoopï¼Œç›¸å…³ä»£ç æ•´ç†åå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">SInt32 <span class="title">CFRunLoopRunSpecific</span><span class="params">(CFRunLoopRef rl,</span></span></span><br><span class="line"><span class="params"><span class="function">                            CFStringRef modeName,</span></span></span><br><span class="line"><span class="params"><span class="function">                            CFTimeInterval seconds,</span></span></span><br><span class="line"><span class="params"><span class="function">                            Boolean returnAfterSourceHandled)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å¯¹åº” Modeã€‚</span></span><br><span class="line">    CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, modeName, <span class="literal">false</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰ Mode ä¸‹æ²¡æœ‰ä»»ä½•äº‹ä»¶ï¼Œç«‹å³è¿”å›ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == currentMode ||</span><br><span class="line">        __CFRunLoopModeIsEmpty(rl, currentMode, rl-&gt;_currentMode)) &#123;</span><br><span class="line">        <span class="keyword">return</span> kCFRunLoopRunFinished;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æŠŠ Loop å½“å‰çš„æ•°æ®ä¸´æ—¶ä¿å­˜èµ·æ¥ã€‚</span></span><br><span class="line">    <span class="keyword">volatile</span> _per_run_data *previousPerRun = __CFRunLoopPushPerRunData(rl);</span><br><span class="line">    CFRunLoopModeRef previousMode = rl-&gt;_currentMode;</span><br><span class="line">    rl-&gt;_currentMode = currentMode;</span><br><span class="line">    <span class="type">int32_t</span> result = kCFRunLoopRunFinished;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é€šçŸ¥ Observerï¼Œå³å°†è¿›å…¥ Loopã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (currentMode-&gt;_observerMask &amp; kCFRunLoopEntry) &#123;</span><br><span class="line">        __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopEntry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿›å…¥ RunLoopã€‚</span></span><br><span class="line">result = __CFRunLoopRun(rl, currentMode, seconds, returnAfterSourceHandled, previousMode);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é€šçŸ¥ Observerï¼Œå³å°†é€€å‡º Loopã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (currentMode-&gt;_observerMask &amp; kCFRunLoopExit) &#123;</span><br><span class="line">        __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopExit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¢å¤ä¹‹å‰ä¿å­˜çš„ä¸´æ—¶æ•°æ®ã€‚</span></span><br><span class="line">    __CFRunLoopPopPerRunData(rl, previousPerRun);</span><br><span class="line">    <span class="comment">// æŠŠ Mode æ¢å¤æˆä¹‹å‰çš„ Modeã€‚</span></span><br><span class="line">    rl-&gt;_currentMode = previousMode;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="RunLoop-æ ¸å¿ƒ"><a href="#RunLoop-æ ¸å¿ƒ" class="headerlink" title="RunLoop æ ¸å¿ƒ"></a>RunLoop æ ¸å¿ƒ</h3><p>åœ¨ <code>__CFRunLoopRun</code> ä¸­ï¼ŒRunLoop ä¼šè¿›å…¥ do while å¾ªç¯ï¼Œä¸æ–­æ£€æŸ¥å¹¶å¤„ç†äº‹ä»¶ï¼Œç›´åˆ°æ»¡è¶³é€€å‡ºæ¡ä»¶ï¼ˆè¶…æ—¶ã€æ‰‹åŠ¨åœæ­¢ç­‰ï¼‰ã€‚æ ¸å¿ƒçš„å®ç°ä¾èµ–äº <code>mach_msg</code> å‡½æ•°ï¼Œç³»ç»Ÿä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°å°†çº¿ç¨‹ç½®äºä¼‘çœ çŠ¶æ€ï¼Œç­‰å¾…æ¶ˆæ¯çš„åˆ°æ¥ï¼Œæ¯å½“æœ‰äº‹ä»¶ï¼ˆä¾‹å¦‚æ¥è‡ª <code>mach_port</code> çš„æ¶ˆæ¯æˆ–å®šæ—¶å™¨è§¦å‘ï¼‰æ—¶ï¼ŒRunLoop ä¼šè¢«å”¤é†’å¤„ç†ç›¸å…³äº‹ä»¶ã€‚ç›¸å…³ä»£ç æ•´ç†åå¦‚ä¸‹æ‰€ç¤ºï¼ˆå‡½æ•°æœ‰ç‚¹é•¿ï¼Œä¸æƒ³çœ‹å¯ä»¥è·³è¿‡ï¼Œåé¢æœ‰è§£é‡Šï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int32_t</span> __CFRunLoopRun(CFRunLoopRef rl,</span><br><span class="line">                              CFRunLoopModeRef rlm,</span><br><span class="line">                              CFTimeInterval seconds,</span><br><span class="line">                              Boolean stopAfterHandle,</span><br><span class="line">                              CFRunLoopModeRef previousMode) &#123;</span><br><span class="line">    <span class="type">uint64_t</span> startTSR = <span class="built_in">mach_absolute_time</span>();</span><br><span class="line">    <span class="type">mach_port_name_t</span> dispatchPort = MACH_PORT_NULL;</span><br><span class="line">    </span><br><span class="line">    <span class="type">dispatch_source_t</span> timeout_timer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">__timeout_context</span> *timeout_context = (<span class="keyword">struct</span> __timeout_context *)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(*timeout_context));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (seconds &lt;= <span class="number">0.0</span>) &#123;</span><br><span class="line">        timeout_context-&gt;termTSR = <span class="number">0ULL</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (seconds &lt;= TIMER_INTERVAL_LIMIT) &#123;</span><br><span class="line">        <span class="comment">// ... å¯¹ timeout_timer å’Œ timeout_context çš„åˆå§‹åŒ–åŠå…¶å®ƒæ“ä½œã€‚</span></span><br><span class="line">        <span class="comment">// æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œé˜…è¯»æºç ã€‚</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è®¾ç½® RunLoop çš„ç›®æ ‡è¶…æ—¶æ—¶é—´ï¼Œæ¯”å¦‚å½“å‰æ˜¯ç¬¬ 10 ç§’ï¼Œ</span></span><br><span class="line">        <span class="comment">// è¶…æ—¶æ—¶é—´æ˜¯ 100 ç§’ï¼Œé‚£ç›®æ ‡è¶…æ—¶æ—¶é—´å°±æ˜¯ç¬¬ 110 ç§’ã€‚</span></span><br><span class="line">        timeout_context-&gt;termTSR = startTSR + __CFTimeIntervalToTSR(seconds);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ³¨å†Œ RunLoop è¶…æ—¶å›è°ƒã€‚</span></span><br><span class="line">        <span class="built_in">dispatch_source_set_event_handler_f</span>(timeout_timer, __CFRunLoopTimeout);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        timeout_context-&gt;termTSR = UINT64_MAX;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Boolean didDispatchPortLastTime = <span class="literal">true</span>;</span><br><span class="line">    <span class="type">int32_t</span> retVal = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿›å…¥ RunLoop</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="type">voucher_mach_msg_state_t</span> voucherState = VOUCHER_MACH_MSG_STATE_UNCHANGED;</span><br><span class="line">        <span class="type">voucher_t</span> voucherCopy = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="type">uint8_t</span> msg_buffer[<span class="number">3</span> * <span class="number">1024</span>];</span><br><span class="line">        <span class="type">mach_msg_header_t</span> *msg = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="type">mach_port_t</span> livePort = MACH_PORT_NULL;</span><br><span class="line">        __CFPortSet waitSet = rlm-&gt;_portSet;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é€šçŸ¥ Observerï¼Œå³å°†å¤„ç† Timerã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeTimers) &#123;</span><br><span class="line">            __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é€šçŸ¥ Observerï¼Œå³å°†å¤„ç† Sourceã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeSources) &#123;</span><br><span class="line">            __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç”¨æˆ·å¯èƒ½ä¼šåœ¨ observer ä¸­æ·»åŠ  Blockï¼Œ</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œéœ€è¦å¤„ç†å®ƒä»¬ã€‚</span></span><br><span class="line">        __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‰§è¡Œ Source0 äº‹ä»¶ã€‚</span></span><br><span class="line">        Boolean sourceHandledThisLoop = __CFRunLoopDoSources0(rl, rlm, stopAfterHandle);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åŒç†ï¼Œç”¨æˆ·å¯èƒ½åœ¨ Source ä¸­æ·»åŠ  Blockã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (sourceHandledThisLoop) &#123;</span><br><span class="line">            __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¦‚æœæœ‰ Source1 äº‹ä»¶ï¼Œåˆ™å¤„ç†å®ƒç„¶åè·³åˆ° handle_msg å»å¤„ç†æ¶ˆæ¯ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (MACH_PORT_NULL != dispatchPort &amp;&amp; !didDispatchPortLastTime) &#123;</span><br><span class="line">            msg = (<span class="type">mach_msg_header_t</span> *)msg_buffer;</span><br><span class="line">            <span class="keyword">if</span> (__CFRunLoopServiceMachPort(dispatchPort, &amp;msg, <span class="built_in">sizeof</span>(msg_buffer), &amp;livePort, <span class="number">0</span>, &amp;voucherState, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">                <span class="keyword">goto</span> handle_msg;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        didDispatchPortLastTime = <span class="literal">false</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é€šçŸ¥ Observerï¼Œå³å°†è¿›å…¥ä¼‘çœ ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeWaiting) &#123;</span><br><span class="line">            __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeWaiting);</span><br><span class="line">        &#125;</span><br><span class="line">                </span><br><span class="line">        msg = (<span class="type">mach_msg_header_t</span> *)msg_buffer;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         çº¿ç¨‹è¿›å…¥ä¼‘çœ ï¼Œå¹¶ç›‘å¬ mach port æ¶ˆæ¯ã€‚</span></span><br><span class="line"><span class="comment">         ç›´åˆ°è¢«ä¸‹é¢çš„æŸä¸ªäº‹ä»¶å”¤é†’ï¼š</span></span><br><span class="line"><span class="comment">         1. åŸºäº port çš„ Source äº‹ä»¶ã€‚</span></span><br><span class="line"><span class="comment">         2. Timer äº‹ä»¶ã€‚</span></span><br><span class="line"><span class="comment">         3. RunLoop çš„è¶…æ—¶æ—¶é—´åˆ°äº†ã€‚</span></span><br><span class="line"><span class="comment">         4. è¢«å…¶å®ƒè°ƒç”¨è€…æ‰‹åŠ¨å”¤é†’ã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        __CFRunLoopServiceMachPort(waitSet, &amp;msg, <span class="built_in">sizeof</span>(msg_buffer), &amp;livePort, TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é€šçŸ¥ Observerï¼Œä»ä¼‘çœ ä¸­å”¤é†’ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (rlm-&gt;_observerMask &amp; kCFRunLoopAfterWaiting) &#123;</span><br><span class="line">            __CFRunLoopDoObservers(rl, rlm, kCFRunLoopAfterWaiting);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¤„ç†æ¶ˆæ¯ï¼š</span></span><br><span class="line">        handle_msg:;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¤„ç†é€šè¿‡ Timer å”¤é†’çš„äº‹ä»¶ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (livePort == rlm-&gt;_timerPort) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!__CFRunLoopDoTimers(rl, rlm, <span class="built_in">mach_absolute_time</span>())) &#123;</span><br><span class="line">                <span class="comment">// Re-arm the next timer</span></span><br><span class="line">                __CFArmNextTimerInMode(rlm, rl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¤„ç†é€šè¿‡ GCD å”¤é†’çš„äº‹ä»¶ï¼Œä¾‹å¦‚ dispatch åˆ° main_queue çš„ blockã€‚</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (livePort == dispatchPort) &#123;</span><br><span class="line">            __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);</span><br><span class="line">            sourceHandledThisLoop = <span class="literal">true</span>;</span><br><span class="line">            didDispatchPortLastTime = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¤„ç†é€šè¿‡ Source1 å”¤é†’çš„äº‹ä»¶ã€‚</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            CFRunLoopSourceRef rls = __CFRunLoopModeFindSourceForMachPort(rl, rlm, livePort);</span><br><span class="line">            <span class="keyword">if</span> (rls) &#123;</span><br><span class="line">                <span class="type">mach_msg_header_t</span> *reply = <span class="literal">NULL</span>;</span><br><span class="line">                sourceHandledThisLoop = __CFRunLoopDoSource1(rl, rlm, rls, msg, msg-&gt;msgh_size, &amp;reply) || sourceHandledThisLoop;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">NULL</span> != reply) &#123;</span><br><span class="line">                    (<span class="type">void</span>)<span class="built_in">mach_msg</span>(reply, MACH_SEND_MSG, reply-&gt;msgh_size, <span class="number">0</span>, MACH_PORT_NULL, <span class="number">0</span>, MACH_PORT_NULL);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‰§è¡Œæ·»åŠ åˆ° Loop ä¸­çš„ Blockã€‚</span></span><br><span class="line">        __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         è¿›å…¥ Loop æ—¶è®¾ç½®äº† stopAfterHandle ä¸º YESï¼Œ</span></span><br><span class="line"><span class="comment">         æ„æ€æ˜¯å¤„ç†å®Œäº‹ä»¶å°±è¿”å›ã€‚</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;</span><br><span class="line">            retVal = kCFRunLoopRunHandledSource;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// RunLoop è¿è¡Œè¶…æ—¶äº†ã€‚</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (timeout_context-&gt;termTSR &lt; <span class="built_in">mach_absolute_time</span>()) &#123;</span><br><span class="line">            retVal = kCFRunLoopRunTimedOut;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// RunLoop è¢«å¤–éƒ¨å¼ºè¡Œåœæ­¢äº†ã€‚</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (__CFRunLoopIsStopped(rl)) &#123;</span><br><span class="line">            retVal = kCFRunLoopRunStopped;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å½“å‰è¿è¡Œçš„ Mode è¢«åœæ­¢äº†ã€‚</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (rlm-&gt;_stopped) &#123;</span><br><span class="line">            rlm-&gt;_stopped = <span class="literal">false</span>;</span><br><span class="line">            retVal = kCFRunLoopRunStopped;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Mode é‡Œæ²¡æœ‰è¦å¤„ç†çš„äº‹ä»¶äº†ã€‚</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (__CFRunLoopModeIsEmpty(rl, rlm, previousMode)) &#123;</span><br><span class="line">            retVal = kCFRunLoopRunFinished;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¦‚æœå‚æ•°æ²¡è¯´è¿è¡Œå®Œå°±ç»“æŸã€æ²¡è¶…æ—¶ã€Loop æ²¡è¢«åœæ­¢ã€Mode æ²¡è¢«åœæ­¢ã€Mode ä¸ä¸ºç©ºï¼›åˆ™ç»§ç»­ã€‚</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="number">0</span> == retVal);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> retVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä»£ç ä¸­ä¸éš¾å‘ç°ï¼ŒRunLoop å†…éƒ¨å…¶å®å°±æ˜¯ä¸€ä¸ª <code>do while</code> å¾ªç¯ï¼Œå½“çº¿ç¨‹å¯åŠ¨ RunLoop åï¼Œå°±ä¼šä¸€ç›´å¤„äºè¿™ä¸ªå¾ªç¯é‡Œï¼Œæœ‰ä»»åŠ¡æ—¶å°±å¤„ç†ä»»åŠ¡ï¼Œæ¯æ¬¡å¤„ç†å®Œ Source1 ä»»åŠ¡åéƒ½ä¼šåˆ¤æ–­ä¸€ä¸‹æ˜¯å¦æ»¡è¶³é€€å‡ºæ¡ä»¶ï¼ˆè¶…æ—¶ã€å¼ºè¡Œåœæ­¢ã€ä»»åŠ¡åˆ—è¡¨ä¸ºç©ºç­‰ï¼‰ï¼Œå¦‚æœä¸æ»¡è¶³å°±è¿›å…¥ä¸‹ä¸€è½®ã€‚</p><p>RunLoop çš„æ ¸å¿ƒå®ç°ä¾èµ–äº <code>mach_msg()</code>ï¼Œè¿™ä¸ªå‡½æ•°åœ¨ <code>__CFRunLoopServiceMachPort</code> å†…éƒ¨è°ƒç”¨ã€‚RunLoop è°ƒç”¨ <code>mach_msg()</code> ä¹‹åï¼Œå†…æ ¸å°±ä¼šå°†çº¿ç¨‹ç½®äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°æœ‰ port å‘é€æ¶ˆæ¯æˆ–å®šæ—¶å™¨è§¦å‘ã€‚</p><p>ä½ å¯ä»¥ä½¿ç”¨ Xcode è¿è¡Œä¸€ä¸ª iOS é¡¹ç›®ï¼Œç„¶ååœ¨ APP é™æ­¢æ—¶ç‚¹å‡»æš‚åœï¼Œæ­¤æ—¶ä½ ä¼šçœ‹åˆ°ä¸»çº¿ç¨‹è°ƒç”¨æ ˆåœç•™åœ¨ä¸€ä¸ªå«åš <code>mach_msg2_trap()</code> çš„å‡½æ•°ä¸­ã€‚</p><p>æˆ‘ç”»äº†ä¸€ä¸ª RunLoop è¿è¡Œæµç¨‹å›¾ï¼Œè¯·å‚è€ƒä¸‹å›¾ï¼š</p><p><img src="runloop0.png" alt="RunLoop è¿è¡Œæµç¨‹å›¾"></p><h2 id="RunLoop-ä¸-RunLoopMode"><a href="#RunLoop-ä¸-RunLoopMode" class="headerlink" title="RunLoop ä¸ RunLoopMode"></a>RunLoop ä¸ RunLoopMode</h2><p>ä¸€ä¸ª RunLoop å¯èƒ½ä¼šåŒ…å«å¤šä¸ª Modeï¼Œæ¯ä¸ª Mode åˆå¯èƒ½åŒ…å«è‹¥å¹²ä¸ª Sourceã€Timerã€Observerã€‚ç›¸å…³ä»£ç æ•´ç†åå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">__CFRunLoop</span> *CFRunLoopRef;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RunLoop çš„åº•å±‚ç»“æ„ã€‚</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">__CFRunLoop</span> &#123;</span><br><span class="line">    CFMutableSetRef _commonModes;</span><br><span class="line">    CFMutableSetRef _commonModeItems;</span><br><span class="line">    CFRunLoopModeRef _currentMode;</span><br><span class="line">    CFMutableSetRef _modes;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">__CFRunLoopMode</span> *CFRunLoopModeRef;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RunLoopMode çš„åº•å±‚ç»“æ„ã€‚</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">__CFRunLoopMode</span> &#123;</span><br><span class="line">    CFStringRef _name;<span class="comment">// Mode çš„åç§°ã€‚</span></span><br><span class="line">    CFMutableSetRef _sources0;<span class="comment">// åŒ…å«æ‰€æœ‰ Source0ï¼Œä¸€ä¸ª Setã€‚</span></span><br><span class="line">    CFMutableSetRef _sources1;<span class="comment">// åŒ…å«æ‰€æœ‰ Source1ï¼Œä¸€ä¸ª Setã€‚</span></span><br><span class="line">    CFMutableArrayRef _observers;<span class="comment">// åŒ…å«æ‰€æœ‰ Observerï¼Œä¸€ä¸ª Arrayã€‚</span></span><br><span class="line">    CFMutableArrayRef _timers;<span class="comment">// åŒ…å«æ‰€æœ‰ Timerï¼Œä¸€ä¸ª Arrayã€‚</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>RunLoop ä¸ Mode çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="runLoop1.png" alt="RunLoop ä¸ Mode çš„å…³ç³»"></p><p>RunLoop æ¯æ¬¡åªèƒ½æŒ‡å®šä¸€ä¸ª Mode è¿è¡Œï¼Œè¿™ä¸ª Mode è¢«ç§°ä¸º currentModeã€‚å¦‚æœéœ€è¦åˆ‡æ¢ Modeï¼Œåªèƒ½é€€å‡º Loopï¼Œç„¶åé‡æ–°æŒ‡å®š Mode è¿è¡Œã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†å°†ä¸åŒçš„ Sourceã€Timerã€Observer åˆ†éš”å¼€ï¼Œé¿å…å®ƒä»¬ç›¸äº’å¹²æ‰°ã€‚</p><p>Mode å†…éƒ¨æœ‰ä»¥ä¸‹ä¸‰ç§ç±»å‹çš„äº‹ä»¶ï¼š</p><p><strong>CFRunLoopSourceRef</strong> è¡¨ç¤ºæ‰€æœ‰ source0 å’Œ source1 äº‹ä»¶ã€‚</p><ul><li>source0 åªåŒ…å«ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆå›è°ƒï¼Œå®ƒä¸èƒ½ä¸»åŠ¨è§¦å‘äº‹ä»¶ï¼Œåªèƒ½å…ˆè°ƒç”¨ <code>CFRunLoopSourceSignal(source)</code> å°†è¿™ä¸ª Source æ ‡è®°ä¸ºå¾…å¤„ç†ï¼Œç„¶åè°ƒç”¨ <code>CFRunLoopWakeUp(runloop)</code> å”¤é†’ RunLoop å»å¤„ç†è¢«æ ‡è®°çš„äº‹ä»¶ã€‚</li><li>source1 æ˜¯ mach port å‘å‡ºçš„äº‹ä»¶ï¼Œè¢«ç”¨äºé€šè¿‡å†…æ ¸å’Œå…¶å®ƒè¿›ç¨‹ç›¸äº’å‘é€æ¶ˆæ¯ï¼Œè¿™ç§äº‹ä»¶å¯ä»¥ä¸»åŠ¨å”¤é†’ RunLoopã€‚</li></ul><p><strong>CFRunLoopTimerRef</strong> æ˜¯ä¸€ä¸ªå®šæ—¶å™¨äº‹ä»¶ï¼Œå®ƒå’Œ NSTimer æ˜¯å…è´¹æ¡¥æ¥çš„ï¼Œå½“å®ƒè¢«åŠ å…¥åˆ° RunLoop åï¼ŒRunLoop ä¼šåœ¨å¯¹åº”çš„æ—¶é—´ç‚¹æ³¨å†Œäº‹ä»¶ï¼Œå½“æ—¶é—´ç‚¹åˆ°è¾¾æ—¶ Loop ä¼šè¢«å”¤é†’å¹¶å¤„ç†è¿™ä¸ªäº‹ä»¶ã€‚</p><p><strong>CFRunLoopObserverRef</strong> æ˜¯ä¸€ä¸ªè§‚å¯Ÿè€…äº‹ä»¶ï¼Œå½“ RunLoop çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡æ³¨å†Œ Observer æ¥å“åº”è¿™äº›å˜åŒ–ï¼Œå¯ä»¥è§‚å¯Ÿçš„çŠ¶æ€æœ‰ä»¥ä¸‹ 6 ä¸ªï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">CF_OPTIONS</span><span class="params">(CFOptionFlags, CFRunLoopActivity)</span> </span>&#123;</span><br><span class="line">    kCFRunLoopEntry = (<span class="number">1UL</span> &lt;&lt; <span class="number">0</span>), <span class="comment">// å³å°†è¿›å…¥ Loopã€‚</span></span><br><span class="line">    kCFRunLoopBeforeTimers = (<span class="number">1UL</span> &lt;&lt; <span class="number">1</span>), <span class="comment">// å³å°†å¤„ç† Timerã€‚</span></span><br><span class="line">    kCFRunLoopBeforeSources = (<span class="number">1UL</span> &lt;&lt; <span class="number">2</span>), <span class="comment">// å³å°†å¤„ç† Sourceã€‚</span></span><br><span class="line">    kCFRunLoopBeforeWaiting = (<span class="number">1UL</span> &lt;&lt; <span class="number">5</span>), <span class="comment">// å³å°†è¿›å…¥ä¼‘çœ ã€‚</span></span><br><span class="line">    kCFRunLoopAfterWaiting = (<span class="number">1UL</span> &lt;&lt; <span class="number">6</span>), <span class="comment">// ä»ä¼‘çœ ä¸­å”¤é†’ã€‚</span></span><br><span class="line">    kCFRunLoopExit = (<span class="number">1UL</span> &lt;&lt; <span class="number">7</span>), <span class="comment">// å³å°†é€€å‡º Loopã€‚</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šçš„ Sourceã€Timerã€Observer ç»Ÿç§°ä¸º mode itemï¼Œä¸€ä¸ª item ä¸èƒ½é‡å¤åŠ å…¥åŒä¸€ä¸ª Modeï¼Œä½†æ˜¯å¯ä»¥åŒæ—¶åŠ å…¥å¤šä¸ª mode ä¸­ï¼Œå¦å¤–ï¼Œå¦‚æœ mode é‡Œæ²¡æœ‰ itemï¼Œåˆ™ RunLoop ä¼šç›´æ¥é€€å‡ºï¼Œä¸ä¼šè¿›å…¥åˆ°å¾ªç¯ä¸­ã€‚</p><h2 id="å…³äº-CommonModes"><a href="#å…³äº-CommonModes" class="headerlink" title="å…³äº CommonModes"></a>å…³äº CommonModes</h2><p>CommonModes æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ¦‚å¿µï¼Œå…¶å…è®¸ä¸€ä¸ªäº‹ä»¶åŒæ—¶åœ¨å¤šä¸ª Mode ä¸­è§¦å‘ã€‚é€šè¿‡ <code>CFRunLoopAddCommonMode</code> å‡½æ•°ï¼Œå¯ä»¥å°†æŸä¸ª Mode æ ‡è®°ä¸º â€œCommonâ€ æ¨¡å¼ï¼Œè¿™æ ·è¯¥æ¨¡å¼ä¸‹çš„äº‹ä»¶å°±ä¼šè‡ªåŠ¨åŒæ­¥åˆ°å…¶å®ƒ Mode ä¸­å»ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>CFRunLoopAddCommonMode</code> ä¸­æ·»åŠ ä¸€ä¸ªå®šæ—¶å™¨ï¼Œè¿™æ ·å®ƒå°±èƒ½åŒæ—¶åœ¨å¤šä¸ªæ¨¡å¼ä¸‹è¿è¡Œã€‚</p><p>ç›¸å…³å®ç°ä»£ç ç²¾ç®€åå¦‚ä¸‹æ‰€ç¤ºï¼ˆä¸æƒ³çœ‹å¯ä»¥è·³è¿‡ï¼Œåé¢æœ‰è§£é‡Šï¼‰ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CFRunLoopAddObserver</span><span class="params">(CFRunLoopRef rl, CFRunLoopObserverRef rlo, CFStringRef modeName)</span> </span>&#123;</span><br><span class="line">    CFRunLoopModeRef rlm;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (modeName == kCFRunLoopCommonModes) &#123;</span><br><span class="line">        CFSetRef set = rl-&gt;_commonModes ? <span class="built_in">CFSetCreateCopy</span>(kCFAllocatorSystemDefault, rl-&gt;_commonModes) : <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> == rl-&gt;_commonModeItems) &#123;</span><br><span class="line">            rl-&gt;_commonModeItems = <span class="built_in">CFSetCreateMutable</span>(kCFAllocatorSystemDefault, <span class="number">0</span>, &amp;kCFTypeSetCallBacks);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">CFSetAddValue</span>(rl-&gt;_commonModeItems, rlo);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> != set) &#123;</span><br><span class="line">            CFTypeRef context[<span class="number">2</span>] = &#123;rl, rlo&#125;;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             è¿™é‡Œä¼šéå† rl-&gt;_commonModes ä¸­çš„æ‰€æœ‰ Modeï¼Œ</span></span><br><span class="line"><span class="comment">             ç„¶åæ‰§è¡Œ __CFRunLoopAddItemToCommonModesï¼Œ</span></span><br><span class="line"><span class="comment">             æŠŠäº‹ä»¶æ·»åŠ åˆ°æ¯ä¸ªå…·ä½“çš„ Mode ä¸­å»ã€‚</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="built_in">CFSetApplyFunction</span>(set, (__CFRunLoopAddItemToCommonModes), (<span class="type">void</span> *)context);</span><br><span class="line">            <span class="built_in">CFRelease</span>(set);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ... é NSRunLoopCommonModes çš„å¤„ç†é€»è¾‘ã€‚</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CFRunLoopAddCommonMode</span><span class="params">(CFRunLoopRef rl, CFStringRef modeName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">CFSetContainsValue</span>(rl-&gt;_commonModes, modeName)) &#123;</span><br><span class="line">        CFSetRef set = rl-&gt;_commonModeItems ? <span class="built_in">CFSetCreateCopy</span>(kCFAllocatorSystemDefault, rl-&gt;_commonModeItems) : <span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">CFSetAddValue</span>(rl-&gt;_commonModes, modeName);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> != set) &#123;</span><br><span class="line">            CFTypeRef context[<span class="number">2</span>] = &#123;rl, modeName&#125;;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             æŠŠ modeName å¯¹åº” Mode ä¸­çš„æ‰€æœ‰äº‹ä»¶ï¼Œ</span></span><br><span class="line"><span class="comment">             åŒæ­¥åˆ° rl-&gt;_commonModeItems çš„æ‰€æœ‰ Mode ä¸­å»ã€‚</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="built_in">CFSetApplyFunction</span>(set, (__CFRunLoopAddItemsToCommonMode), (<span class="type">void</span> *)context);</span><br><span class="line">            <span class="built_in">CFRelease</span>(set);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æåˆ°çš„ CFRunLoopAddObserver å‡½æ•°ï¼Œè¿˜æœ‰ä¸¤ä¸ªå‡½æ•°å’Œå®ƒç±»ä¼¼ï¼šCFRunLoopAddTimer å’Œ CFRunLoopAddSourceï¼Œå®ƒä»¬çš„å†…éƒ¨å®ç°åŸç†åŸºæœ¬ä¸€è‡´ï¼Œæ‰€ä»¥æˆ‘åªä»‹ç»äº† CFRunLoopAddObserverã€‚</p><p>å½“ä½ å¾€ NSRunLoopCommonModes ä¸­æ·»åŠ ä¸€ä¸ªäº‹ä»¶æ—¶ï¼Œç³»ç»Ÿä¼šæ‹¿åˆ° _commonModes å¹¶éå†å…¶æ¯ä¸ª Modeï¼Œç„¶åä¸ºå…¶æ·»åŠ è¿™ä¸ªäº‹ä»¶ã€‚</p><p>å½“ä½ è°ƒç”¨ CFRunLoopAddCommonMode å°†æŸä¸ª Mode æ ‡è®°ä¸º â€œCommonâ€ æ¨¡å¼æ—¶ï¼Œç³»ç»Ÿä¼šå–å‡ºè¿™ä¸ª Mode ä¸­çš„æ‰€æœ‰äº‹ä»¶ï¼Œç„¶åéå† _commonModes å¹¶ç»™æ¯ä¸ª Mode æ·»åŠ è¿™äº›äº‹ä»¶ã€‚</p><h2 id="RunLoop-ä¸çº¿ç¨‹çš„å…³ç³»"><a href="#RunLoop-ä¸çº¿ç¨‹çš„å…³ç³»" class="headerlink" title="RunLoop ä¸çº¿ç¨‹çš„å…³ç³»"></a>RunLoop ä¸çº¿ç¨‹çš„å…³ç³»</h2><p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ RunLoopï¼ŒiOS ä¸å…è®¸æˆ‘ä»¬åˆ›å»º RunLoopï¼Œä½†æä¾›äº†ä¸¤ä¸ªå‡½æ•°æ¥è·å–å½“å‰çº¿ç¨‹å’Œä¸»çº¿ç¨‹çš„ RunLoopï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–ä¸»çº¿ç¨‹ä¸­çš„ RunLoopã€‚</span></span><br><span class="line"><span class="function">CFRunLoopRef <span class="title">CFRunLoopGetMain</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="type">static</span> CFRunLoopRef __main = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (!__main) __main = _CFRunLoopGet0(<span class="built_in">pthread_main_thread_np</span>());</span><br><span class="line">    <span class="keyword">return</span> __main;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„ RunLoopã€‚</span></span><br><span class="line"><span class="function">CFRunLoopRef <span class="title">CFRunLoopGetCurrent</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä»å½“å‰çº¿ç¨‹çš„å±€éƒ¨å­˜å‚¨ä¸­è·å– RunLoop å¯¹è±¡ã€‚</span></span><br><span class="line">    CFRunLoopRef rl = (CFRunLoopRef)_CFGetTSD(__CFTSDKeyRunLoop);</span><br><span class="line">    <span class="keyword">if</span> (rl) <span class="keyword">return</span> rl;</span><br><span class="line">    <span class="keyword">return</span> _CFRunLoopGet0(<span class="built_in">pthread_self</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¨å±€ Dictï¼Œkey æ˜¯çº¿ç¨‹ï¼Œvalue æ˜¯ RunLoopã€‚</span></span><br><span class="line"><span class="type">static</span> CFMutableDictionaryRef __CFRunLoops = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">CF_EXPORT CFRunLoopRef _CFRunLoopGet0(<span class="type">pthread_t</span> t) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     ç¬¬ 1 æ¬¡è·å– RunLoop å¯¹è±¡æ—¶ï¼Œ</span></span><br><span class="line"><span class="comment">     è‡ªåŠ¨åˆ›å»ºå…¨å±€ Dict å’Œä¸»çº¿ç¨‹çš„ RunLoopã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!__CFRunLoops) &#123;</span><br><span class="line">        CFMutableDictionaryRef dict = <span class="built_in">CFDictionaryCreateMutable</span>(kCFAllocatorSystemDefault, <span class="number">0</span>,</span><br><span class="line">                                      <span class="literal">NULL</span>, &amp;kCFTypeDictionaryValueCallBacks);</span><br><span class="line">        CFRunLoopRef mainLoop = __CFRunLoopCreate(<span class="built_in">pthread_main_thread_np</span>());</span><br><span class="line">        <span class="built_in">CFDictionarySetValue</span>(dict, <span class="built_in">pthreadPointer</span>(<span class="built_in">pthread_main_thread_np</span>()), mainLoop);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    CFRunLoopRef loop = (CFRunLoopRef)<span class="built_in">CFDictionaryGetValue</span>(__CFRunLoops, <span class="built_in">pthreadPointer</span>(t));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!loop) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹è¿˜æ²¡æœ‰ RunLoopï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚</span></span><br><span class="line">        CFRunLoopRef newLoop = __CFRunLoopCreate(t);</span><br><span class="line">        <span class="built_in">CFDictionarySetValue</span>(__CFRunLoops, <span class="built_in">pthreadPointer</span>(t), newLoop);</span><br><span class="line">        loop = newLoop;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">pthread_equal</span>(t, <span class="built_in">pthread_self</span>())) &#123;</span><br><span class="line">        _CFSetTSD(__CFTSDKeyRunLoop, (<span class="type">void</span> *)loop, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == _CFGetTSD(__CFTSDKeyRunLoopCntr)) &#123;</span><br><span class="line">            <span class="comment">// æ³¨å†Œä¸€ä¸ªå›è°ƒï¼Œå½“çº¿ç¨‹é”€æ¯æ—¶ï¼Œé¡ºä¾¿é”€æ¯å…¶å¯¹åº”çš„ RunLoopã€‚</span></span><br><span class="line">            _CFSetTSD(__CFTSDKeyRunLoopCntr, </span><br><span class="line">            (<span class="type">void</span> *)(PTHREAD_DESTRUCTOR_ITERATIONS<span class="number">-1</span>), </span><br><span class="line">            (<span class="built_in">void</span> (*)(<span class="type">void</span> *))__CFFinalizeRunLoop);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> loop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä»£ç ä¸­ä¸éš¾å‘ç°ï¼Œçº¿ç¨‹å’Œ RunLoop çš„å…³ç³»æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå…¶å…³ç³»ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€å­—å…¸ä¸­ã€‚å¦å¤–ï¼ŒiOS ä¼šä¸ºæ¯ä¸ªçº¿ç¨‹æ‡’åŠ è½½ RunLoop å¯¹è±¡ï¼Œå¹¶åœ¨çº¿ç¨‹é”€æ¯æ—¶è‡ªåŠ¨é‡Šæ”¾å®ƒã€‚</p><p>æˆ‘ä»¬åªèƒ½è·å–å½“å‰çº¿ç¨‹çš„ RunLoop å¯¹è±¡ï¼ˆä¸»çº¿ç¨‹çš„ RunLoop é™¤å¤–ï¼‰ã€‚</p><h2 id="è‹¹æœåˆ©ç”¨-RunLoop-å®ç°çš„åŠŸèƒ½"><a href="#è‹¹æœåˆ©ç”¨-RunLoop-å®ç°çš„åŠŸèƒ½" class="headerlink" title="è‹¹æœåˆ©ç”¨ RunLoop å®ç°çš„åŠŸèƒ½"></a>è‹¹æœåˆ©ç”¨ RunLoop å®ç°çš„åŠŸèƒ½</h2><h3 id="AutoreleasePool-ä¸-RunLoop"><a href="#AutoreleasePool-ä¸-RunLoop" class="headerlink" title="AutoreleasePool ä¸ RunLoop"></a>AutoreleasePool ä¸ RunLoop</h3><p>ç½‘ç»œä¸Šæœ‰ä¸€äº›è¿™æ–¹é¢ç›¸å…³çš„æ—§æ–‡ç« ï¼Œä»–ä»¬ä¼šå‘Šè¯‰ä½ ï¼šiOS åœ¨ APP å¯åŠ¨åä¼šå¾€ä¸»çº¿ç¨‹çš„ RunLoop é‡Œæ³¨å†Œå¤šä¸ª Observerï¼Œç”¨æ¥ç›‘å¬ä»¥ä¸‹ä¸‰ç§çŠ¶æ€ï¼š</p><p>å³å°†è¿›å…¥ RunLoopï¼šåˆ›å»º AutoreleasePoolã€‚</p><p>RunLoop å‡†å¤‡ä¼‘çœ ï¼šé‡Šæ”¾ä¹‹å‰åˆ›å»ºçš„ AutoreleasePoolï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„ AutoreleasePoolã€‚</p><p>RunLoop å³å°†é€€å‡ºï¼šé‡Šæ”¾ä¹‹å‰åˆ›å»ºçš„ AutoreleasePoolã€‚</p><p>ä½†æ˜¯ï¼Œæ ¹æ®æˆ‘çš„è°ƒè¯•å‘ç°ï¼Œæ–°çš„ RunLoop å·²ç»ä¸æ˜¯ä¸Šè¿°é€»è¾‘äº†ã€‚ç³»ç»Ÿä¼šåœ¨æ¯ä¸ªä»»åŠ¡çš„æ‰§è¡Œå‰åè‡ªåŠ¨æ’å…¥ç›¸å…³ä»£ç æ¥å®ç° AutoreleasePool çš„åˆ›å»ºå’Œé‡Šæ”¾æ“ä½œï¼Œè€Œä¸æ˜¯ç­‰åˆ°çº¿ç¨‹ä¼‘çœ å‰æ‰é‡Šæ”¾ã€‚</p><p>å…³äº AutoreleasePool çš„æ›´å¤šç»†èŠ‚ï¼Œè¯·é˜…è¯»æˆ‘å†™çš„å¦ä¸€ç¯‡æ–‡ç« ï¼š<a href="/2025/03/30/iOS/AutoreleasePool%EF%BC%9AiOS%20%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E4%B9%90%E7%AB%A0%E4%B8%AD%E7%9A%84%E9%9A%90%E7%A7%98%E6%97%8B%E5%BE%8B/" title="AutoreleasePoolï¼šiOS å†…å­˜ç®¡ç†ä¹ç« ä¸­çš„éšç§˜æ—‹å¾‹">AutoreleasePoolï¼šiOS å†…å­˜ç®¡ç†ä¹ç« ä¸­çš„éšç§˜æ—‹å¾‹</a></p><h3 id="NSTimer-ä¸-RunLoop"><a href="#NSTimer-ä¸-RunLoop" class="headerlink" title="NSTimer ä¸ RunLoop"></a>NSTimer ä¸ RunLoop</h3><p>iOS ä¸­çš„ NSTimer å’Œ RunLoop ä¸­çš„ CFRunLoopTimerRef æ˜¯å…è´¹æ¡¥æ¥çš„ã€‚å½“ä½ æ·»åŠ ä¸€ä¸ª Timer åˆ° RunLoop æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨ä¸‹ä¸€ä¸ªæ—¶é—´ç‚¹æ³¨å†Œäº‹ä»¶ï¼ŒåŒæ—¶ï¼Œä¸ºäº†èŠ‚çœèµ„æºï¼ŒRunLoop å¹¶ä¸ä¼šåœ¨éå¸¸å‡†ç¡®çš„æ—¶é—´ç‚¹å›è°ƒ Timerï¼ŒTimer æœ‰ä¸ªå±æ€§å« toleranceï¼Œè¡¨ç¤ºå½“æ—¶é—´ç‚¹åˆ°è¾¾åï¼Œå®¹è®¸æœ‰å¤šå°‘è¯¯å·®ã€‚</p><p>å¦‚æœæŸä¸ªæ—¶é—´ç‚¹é”™è¿‡äº†ï¼Œæ¯”å¦‚æˆ‘åˆ›å»ºäº†ä¸€ä¸ª 1 ç§’æ‰§è¡Œä¸€æ¬¡çš„ Timerï¼Œä½† RunLoop æ‰§è¡Œäº†ä¸€æ®µé€»è¾‘æ¶ˆè€—äº† 5 ç§’ï¼Œæ­¤æ—¶ï¼ŒRunLoop ä¼šåœ¨ç¬¬ 6 ç§’çš„æ—¶å€™å›è°ƒ Timerï¼Œæ‰§è¡Œè¿™ä¸€æ¬¡äº‹ä»¶ä»¥åŠä¸Šä¸€æ¬¡çš„äº‹ä»¶ã€‚æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">46</span>:<span class="number">19</span>: å®šæ—¶å™¨<span class="number">1</span></span><br><span class="line"><span class="number">16</span>:<span class="number">46</span>:<span class="number">20</span>: å®šæ—¶å™¨<span class="number">2</span></span><br><span class="line"><span class="comment">// æ‰§è¡Œäº†è€—æ—¶é€»è¾‘ï¼Œæ¶ˆè€—äº† 5 ç§’ã€‚</span></span><br><span class="line"><span class="number">16</span>:<span class="number">46</span>:<span class="number">26</span>: å®šæ—¶å™¨<span class="number">3</span></span><br><span class="line"><span class="number">16</span>:<span class="number">46</span>:<span class="number">26</span>: å®šæ—¶å™¨<span class="number">4</span></span><br><span class="line"><span class="number">16</span>:<span class="number">46</span>:<span class="number">27</span>: å®šæ—¶å™¨<span class="number">5</span></span><br><span class="line"><span class="number">16</span>:<span class="number">46</span>:<span class="number">28</span>: å®šæ—¶å™¨<span class="number">6</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ â€œå®šæ—¶å™¨3â€ å’Œ â€œå®šæ—¶å™¨4â€ è¿™ä¸¤ä¸ªäº‹ä»¶ï¼Œå®ƒä»¬çš„æ‰§è¡Œæ—¶é—´éƒ½æ˜¯ç¬¬ 26 ç§’ï¼Œå…¶ä¸­ â€œå®šæ—¶å™¨3â€ æœ¬æ¥æ˜¯ç¬¬ 21 ç§’åº”è¯¥æ‰§è¡Œçš„äº‹ä»¶ï¼Œä½†æ˜¯é‚£ä¸ªæ—¶é—´ç‚¹ RunLoop æ²¡ç©ºï¼Œæ‰€ä»¥å®ƒè¢«æ¨è¿Ÿåˆ°äº†ç¬¬ 26 ç§’å’Œ â€œå®šæ—¶å™¨4â€ è¿™ä¸ªäº‹ä»¶ä¸€èµ·æ‰§è¡Œå¹¶è¾“å‡ºã€‚ä»è¿™ä¸ªæ–¹é¢ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œå½“ RunLoop ç¹å¿™çš„æ—¶å€™ï¼ŒNSTimer å¯èƒ½ä¼šå‡ºç°è°ƒç”¨ä¸åŠæ—¶çš„ç°è±¡ã€‚</p><h3 id="PerformSelector-ä¸-RunLoop"><a href="#PerformSelector-ä¸-RunLoop" class="headerlink" title="PerformSelector ä¸ RunLoop"></a>PerformSelector ä¸ RunLoop</h3><p>å½“ä½ è°ƒç”¨ NSObject çš„ <code>performSelecter:afterDelay:</code> åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª NSTimer å¹¶æ·»åŠ åˆ°å½“å‰çº¿ç¨‹çš„ RunLoop ä¸­ã€‚å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰ RunLoop çš„è¯ï¼Œåˆ™è¿™ä¸ªæ–¹æ³•å°±ä¼šå¤±æ•ˆï¼ˆå­çº¿ç¨‹é»˜è®¤æ²¡æœ‰ RunLoopï¼‰ã€‚</p><p>æ³¨æ„ï¼Œè°ƒç”¨ <code>performSelector:onThread:</code> æ—¶ï¼Œç³»ç»Ÿä¹Ÿä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª NSTimerï¼Œæ‰€ä»¥ï¼Œå¦‚æœå¯¹åº”çº¿ç¨‹æ²¡æœ‰ RunLoop çš„è¯è¯¥æ–¹æ³•ä¹Ÿä¼šå¤±æ•ˆã€‚</p><h3 id="GCD-ä¸-RunLoop"><a href="#GCD-ä¸-RunLoop" class="headerlink" title="GCD ä¸ RunLoop"></a>GCD ä¸ RunLoop</h3><p>GCD å’Œ RunLoop ä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ²¡æœ‰äº¤é›†ï¼Œä½†æ˜¯å½“ä½ åœ¨å­çº¿ç¨‹è°ƒç”¨äº† <code>dispatch_async(dispatch_get_main_queue(), block)</code> æ—¶ï¼ŒGCD ä¼šå‘ä¸»çº¿ç¨‹çš„ RunLoop å‘é€æ¶ˆæ¯ï¼Œæ­¤æ—¶ä¸»çº¿ç¨‹çš„ RunLoop ä¼šè¢«å”¤é†’è°ƒç”¨ <code>__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__()</code> æ¥å¤„ç†è¿™ä¸ªäº‹ä»¶ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåªæœ‰ä»å­çº¿ç¨‹å›åˆ°ä¸»çº¿ç¨‹æ‰ä¼šä½¿ç”¨ RunLoop å¤„ç†ï¼Œä»å­çº¿ç¨‹Aåˆ°å­çº¿ç¨‹Bæ˜¯ä¸ä¼šä½¿ç”¨ç›®æ ‡çº¿ç¨‹çš„ RunLoop æ¥å¤„ç†çš„ã€‚</p><h2 id="æˆ‘ä»¬èƒ½åˆ©ç”¨-RunLoop-å¹²ä»€ä¹ˆ"><a href="#æˆ‘ä»¬èƒ½åˆ©ç”¨-RunLoop-å¹²ä»€ä¹ˆ" class="headerlink" title="æˆ‘ä»¬èƒ½åˆ©ç”¨ RunLoop å¹²ä»€ä¹ˆ"></a>æˆ‘ä»¬èƒ½åˆ©ç”¨ RunLoop å¹²ä»€ä¹ˆ</h2><h3 id="APP-å¡é¡¿ç›‘æ§"><a href="#APP-å¡é¡¿ç›‘æ§" class="headerlink" title="APP å¡é¡¿ç›‘æ§"></a>APP å¡é¡¿ç›‘æ§</h3><p>å…¶å®ç°åŸç†æ˜¯å¾€ä¸»çº¿ç¨‹çš„ RunLoop ä¸­æ³¨å†Œä¸€ä¸ª Observer ç›‘å¬æ‰€æœ‰çŠ¶æ€ï¼Œç„¶ååœ¨å›è°ƒä¸­å¼€å¯ä¸€ä¸ªå­çº¿ç¨‹ç”¨æ¥åˆ¤æ–­ä¸»çº¿ç¨‹æ˜¯å¦å‘ç”Ÿäº†å¡é¡¿ï¼Œåˆ¤æ–­çš„é€»è¾‘å¤§è‡´æ˜¯ï¼Œå¦‚æœ RunLoop åœ¨æŸäº›çŠ¶æ€ä¸‹æŒç»­æ—¶é—´è¿‡é•¿ï¼ˆä¸€èˆ¬æ˜¯ 60 msï¼‰ï¼Œåˆ™åˆ¤å®šä¸ºå¡é¡¿ã€‚å¦‚æœä½ æƒ³äº†è§£æ›´å¤šç»†èŠ‚ï¼Œè¯·æŸ¥çœ‹æˆ‘å†™çš„è¿™ä¸ªé¡¹ç›®ï¼š<a href="https://github.com/internetWei/WXLLagMonitoring">WXLLagMonitoring</a>ã€‚</p><h3 id="çº¿ç¨‹ä¿æ´»"><a href="#çº¿ç¨‹ä¿æ´»" class="headerlink" title="çº¿ç¨‹ä¿æ´»"></a>çº¿ç¨‹ä¿æ´»</h3><p>æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½éœ€è¦é¢‘ç¹çš„åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œä¸€äº›ä»£ç é€»è¾‘ï¼Œå¦‚æœæ¯æ¬¡æ‰§è¡Œéƒ½å¼€å¯ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œå¯èƒ½ä¼šå¸¦æ¥ä¸€äº›ä¸å¿…è¦çš„æ€§èƒ½æŸè€—ã€‚å¦‚æœæˆ‘ä»¬èƒ½è®©è¿™ä¸ªå­çº¿ç¨‹åƒä¸»çº¿ç¨‹ä¸€æ ·ï¼Œæœ‰ä»»åŠ¡çš„æ—¶å€™å¤„ç†ä»»åŠ¡ï¼Œæ²¡ä»»åŠ¡çš„æ—¶å€™å°±ä¼‘çœ å°±å¥½äº†ã€‚å¦‚æœä½ æƒ³äº†è§£æ›´å¤šå®ç°ç»†èŠ‚ï¼Œè¯·æŸ¥çœ‹æˆ‘å†™çš„è¿™ä¸ªé¡¹ç›®ï¼š<a href="https://github.com/internetWei/WXLThread">WXLThread</a>ã€‚</p><h3 id="æ€§èƒ½ä¼˜åŒ–"><a href="#æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h3><p>æ¯”å¦‚ï¼Œä½ å¯ä»¥å°†å¤šæ¬¡æ“ä½œåˆå¹¶æˆä¸€æ¬¡æ“ä½œã€‚å…¶é€»è¾‘å¤§è‡´æ˜¯ç›‘å¬ RunLoop å³å°†è¿›å…¥ä¼‘çœ çš„çŠ¶æ€ï¼Œåœ¨ä¼‘çœ ä¹‹å‰å°†æ‰€æœ‰æ“ä½œåˆå¹¶æˆä¸€æ¬¡æ“ä½œï¼Œç³»ç»Ÿçš„ç•Œé¢åˆ·æ–°å°±æ˜¯è¿™ä¸ªåŸç†ï¼Œä½ åœ¨æ›´æ–° UI è§†å›¾åï¼Œç³»ç»Ÿå¹¶ä¸ä¼šç«‹é©¬æ›´æ–°ï¼Œè€Œæ˜¯åœ¨ RunLoop ä¼‘çœ ä¹‹å‰å°†è¿™äº›æ›´æ–°æ“ä½œåˆå¹¶æˆä¸€æ¬¡æ›´æ–°ã€‚</p><p>æœ‰ä¸ªæ¡†æ¶ FDTemplateLayoutCell å°±ç”¨åˆ°äº† RunLoopï¼Œå®ƒä¼šåœ¨ NSDefaultRunLoopMode æ¨¡å¼ä¸‹æ³¨å†Œä¸€ä¸ª Observer å¹¶è§‚å¯Ÿå³å°†ä¼‘çœ çš„çŠ¶æ€ï¼Œåœ¨å›è°ƒä¸­ä¼šæ‰§è¡Œé¢„åŠ è½½é€»è¾‘ã€‚</p><h2 id="RunLoop-ç›¸å…³ç–‘æƒ‘"><a href="#RunLoop-ç›¸å…³ç–‘æƒ‘" class="headerlink" title="RunLoop ç›¸å…³ç–‘æƒ‘"></a>RunLoop ç›¸å…³ç–‘æƒ‘</h2><h3 id="CommonModes-ä¸­çš„ä»»åŠ¡æ˜¯å¦‚ä½•åŒæ­¥çš„ï¼Ÿ"><a href="#CommonModes-ä¸­çš„ä»»åŠ¡æ˜¯å¦‚ä½•åŒæ­¥çš„ï¼Ÿ" class="headerlink" title="CommonModes ä¸­çš„ä»»åŠ¡æ˜¯å¦‚ä½•åŒæ­¥çš„ï¼Ÿ"></a>CommonModes ä¸­çš„ä»»åŠ¡æ˜¯å¦‚ä½•åŒæ­¥çš„ï¼Ÿ</h3><p>å½“ä½ æ‰§è¡Œè¿™æ ·ä¸€è¡Œä»£ç ï¼š<code>[[NSRunLoop currentRunLoop] addTimer:timer forMode:NSRunLoopCommonModes]</code> æ—¶ï¼Œç³»ç»Ÿæ˜¯å¦‚ä½•è®© timer åŒæ—¶åœ¨ NSDefaultRunLoopMode å’Œ UITrackingRunLoopMode ä¸­è¿è¡Œçš„ï¼Ÿ</p><p>ç½‘ç»œä¸Šæœ‰äº›è¿™æ–¹é¢ç›¸å…³çš„æ—§æ–‡ç« ï¼Œä»–ä»¬å¯èƒ½ä¼šå‘Šè¯‰ä½ ï¼štimer ä¼šè¢«æ·»åŠ åˆ° RunLoop çš„ _commonModeItems ä¸­ï¼Œç„¶ååœ¨æ¯æ¬¡è¿›å…¥ Loop çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šæ£€æŸ¥å½“å‰ Mode æ˜¯å¦å±äº â€œCommonâ€ æ¨¡å¼ï¼Œå¦‚æœå±äºçš„è¯ï¼Œå°±éå† _commonModeItems ä¸­çš„ä»»åŠ¡å¹¶æ·»åŠ åˆ°å½“å‰ Mode ä¸­å»ã€‚</p><p>è¿™ç§è¯´æ³•åœ¨å½“æ—¶æ˜¯å¦å‡†ç¡®æˆ‘ä¸å¤ªæ¸…æ¥šï¼Œä½†åœ¨å¦‚ä»Šçš„ RunLoop é‡Œæ˜¯é”™è¯¯çš„ï¼Œå…¶åŸå› æˆ‘å·²ç»åœ¨ <a href="#%E5%85%B3%E4%BA%8E-CommonModes">å…³äº CommonModes</a> ä¸­è¯¦ç»†è§£é‡Šäº†ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>iOS ä¸­çš„ RunLoop æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å†…éƒ¨æœ‰ä¸€ä¸ªå±æ€§ Modeï¼ŒMode é‡Œä¿å­˜äº†è¦æ‰§è¡Œçš„æ‰€æœ‰äº‹ä»¶ã€‚å½“çº¿ç¨‹å¯åŠ¨ RunLoop åï¼Œå…¶å†…éƒ¨å°±ä¼šå¼€å¯ä¸€ä¸ª <code>do while</code> å¾ªç¯ã€‚å¦‚æœæœ‰ä»»åŠ¡å°±ä¼šä» Mode ä¸­å–å‡ºå¹¶å¤„ç†ï¼Œä»»åŠ¡æ‰§è¡Œå®Œåå°±ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œè¿›å…¥ä¼‘çœ çš„åŸç†æ˜¯è°ƒç”¨äº† <code>mach_msg</code> å‡½æ•°ã€‚é™¤éæ»¡è¶³é€€å‡ºæ¡ä»¶ï¼ˆè¶…æ—¶ã€å¼ºè¡Œåœæ­¢ã€æ— äº‹ä»¶äº†ç­‰ï¼‰ï¼Œå¦åˆ™å°±ä¼šè¿›å…¥ä¸‹ä¸€è½®å¾ªç¯ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://blog.ibireme.com/2015/05/18/runloop/">æ·±å…¥ç†è§£RunLoop | Garan no dou</a></li><li><a href="https://juejin.cn/post/7005112607707398157">iOS çš„å“åº”é“¾å°ç»“ | æ˜é‡‘</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RunLoop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ­å¼€ iOS ä¸­ weak æŒ‡é’ˆçš„ç¥ç§˜é¢çº±ï¼šä»åŸç†åˆ°å®è·µ</title>
      <link href="/2023/10/21/iOS/%E6%8F%AD%E5%BC%80%20iOS%20%E4%B8%AD%20weak%20%E6%8C%87%E9%92%88%E7%9A%84%E7%A5%9E%E7%A7%98%E9%9D%A2%E7%BA%B1%EF%BC%9A%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E5%AE%9E%E8%B7%B5/"/>
      <url>/2023/10/21/iOS/%E6%8F%AD%E5%BC%80%20iOS%20%E4%B8%AD%20weak%20%E6%8C%87%E9%92%88%E7%9A%84%E7%A5%9E%E7%A7%98%E9%9D%A2%E7%BA%B1%EF%BC%9A%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0%E5%AE%9E%E8%B7%B5/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç”± å¸ƒå¤š(budo) å‘å¸ƒäº 2023-10-21 â€¢ æœ€åæ›´æ–°äº 2025-02-26</p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>weak æŒ‡é’ˆæ˜¯ iOS å¼€å‘ä¸­ä¸€ä¸ªéå¸¸åŸºç¡€çš„æ¦‚å¿µï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­æˆ‘ä»¬ç»å¸¸ä½¿ç”¨å®ƒï¼Œå®ƒåˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿè¿™ç¯‡æ–‡ç« å°†ä» Runtime æºç å…¥æ‰‹ï¼Œä¸ºä½ ä»‹ç» weak æŒ‡é’ˆçš„å®ç°åŸç†ï¼›è®©ä½ çŸ¥å…¶ç„¶ï¼Œæ›´çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚</p><h2 id="weak-æŒ‡é’ˆä¹‹ç¼–è¯‘æœŸå®ç°"><a href="#weak-æŒ‡é’ˆä¹‹ç¼–è¯‘æœŸå®ç°" class="headerlink" title="weak æŒ‡é’ˆä¹‹ç¼–è¯‘æœŸå®ç°"></a>weak æŒ‡é’ˆä¹‹ç¼–è¯‘æœŸå®ç°</h2><p>å½“æˆ‘ä»¬åˆå§‹åŒ–ä¸€ä¸ª weak æŒ‡é’ˆæ—¶ï¼š <code>__weak typeof(obj) weakObj = obj;</code>ï¼Œç¼–è¯‘å™¨å…¶å®ä¼šæŠŠå®ƒä»¬è½¬æ¢æˆç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š<code>objc_initWeak((void *)&amp;weakObj, obj);</code></p><p><img src="entrance.png" alt="weak æŒ‡é’ˆçš„åˆå§‹åŒ–å…¥å£"></p><p>ä»ä¸Šå›¾çš„æ–­ç‚¹ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥å‘ç°ï¼Œweak æŒ‡é’ˆè°ƒç”¨äº† <code>objc_initWeak</code> å‡½æ•°æ¥å®Œæˆåˆå§‹åŒ–ã€‚åœ¨ Runtime æºç ä¸­æˆ‘ä»¬å¯ä»¥æ‰¾åˆ° <code>objc_initWeak</code> ç›¸å…³çš„å®ç°ç»†èŠ‚ã€‚</p><blockquote><p>æœ¬æ–‡ä½¿ç”¨çš„ Runtime ç‰ˆæœ¬æ˜¯ <a href="https://github.com/apple-oss-distributions/objc4/tree/objc4-906">objc4-906</a>ï¼Œä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œæˆ‘å¯¹ä»£ç æ ·å¼å’Œæ’ç‰ˆç•¥ä½œäº†ä¿®æ”¹ä»¥åŠåˆ å‡äº†ä¸€äº›ä¸å½±å“ä¸»é€»è¾‘çš„å†—ä½™ä»£ç ã€‚</p><p>æˆ‘åœ¨ <a href="https://github.com/internetWei/ObjCRuntimes">è¿™é‡Œ</a> ç»´æŠ¤äº†ä¸€ä¸ªå¯ä»¥ç›´æ¥è¿è¡Œè°ƒè¯•çš„ Runtime é¡¹ç›®ï¼Œæ–¹ä¾¿å¤§å®¶ç›´æ¥è°ƒè¯•æºç ã€‚</p></blockquote><h2 id="weak-æŒ‡é’ˆä¹‹è¿è¡Œæ—¶å®ç°"><a href="#weak-æŒ‡é’ˆä¹‹è¿è¡Œæ—¶å®ç°" class="headerlink" title="weak æŒ‡é’ˆä¹‹è¿è¡Œæ—¶å®ç°"></a>weak æŒ‡é’ˆä¹‹è¿è¡Œæ—¶å®ç°</h2><p>ä¸ weak æŒ‡é’ˆåˆå§‹åŒ–ç›¸å…³çš„å‡½æ•°æœ‰ä»¥ä¸‹ 4 ä¸ªï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–ä¸€ä¸ªå…¨æ–°çš„ weak æŒ‡é’ˆã€‚</span></span><br><span class="line"><span class="function">id <span class="title">objc_initWeak</span><span class="params">(id *location, id newObj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!newObj) &#123;</span><br><span class="line">        *location = nil;</span><br><span class="line">        <span class="keyword">return</span> nil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">storeWeak</span>&lt;DontHaveOld, DoHaveNew, DoCrashIfDeallocating&gt;(location, (objc_object*)newObj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å’Œå‰é¢çš„ objc_initWeak ä¸€æ ·ï¼Œ</span></span><br><span class="line"><span class="comment">// ä½†æ˜¯ï¼Œå¦‚æœæŒ‡å‘çš„å¯¹è±¡ï¼ˆå³ newObjï¼‰æ­£åœ¨é‡Šæ”¾çš„è¯ä¸è¦æŠ¥é”™è€Œæ˜¯è¿”å› nilã€‚</span></span><br><span class="line"><span class="function">id <span class="title">objc_initWeakOrNil</span><span class="params">(id *location, id newObj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!newObj) &#123;</span><br><span class="line">        *location = nil;</span><br><span class="line">        <span class="keyword">return</span> nil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">storeWeak</span>&lt;DontHaveOld, DoHaveNew, DontCrashIfDeallocating&gt;(location, (objc_object*)newObj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡Šæ”¾ weak æŒ‡é’ˆå½“å‰æŒ‡å‘çš„å¯¹è±¡ï¼Œå¹¶å°†å®ƒæŒ‡å‘æ–°å¯¹è±¡ï¼ˆå³ newObjï¼‰ã€‚</span></span><br><span class="line"><span class="function">id <span class="title">objc_storeWeak</span><span class="params">(id *location, id newObj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">storeWeak</span>&lt;DoHaveOld, DoHaveNew, DoCrashIfDeallocating&gt;(location, (objc_object *)newObj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å’Œ objc_storeWeak ä¸€æ ·ã€‚</span></span><br><span class="line"><span class="comment">// ä½†æ˜¯ï¼Œå¦‚æœæŒ‡å‘çš„å¯¹è±¡ï¼ˆå³ newObjï¼‰æ­£åœ¨é‡Šæ”¾çš„è¯ä¸è¦æŠ¥é”™è€Œæ˜¯è¿”å› nilã€‚</span></span><br><span class="line"><span class="function">id <span class="title">objc_initWeakOrNil</span><span class="params">(id *location, id newObj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!newObj) &#123;</span><br><span class="line">        *location = nil;</span><br><span class="line">        <span class="keyword">return</span> nil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">storeWeak</span>&lt;DontHaveOld, DoHaveNew, DontCrashIfDeallocating&gt;(location, (objc_object*)newObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³äºå‡½æ•° objc_initWeak å’Œ objc_storeWeak çš„åŒºåˆ«ï¼š</p><ul><li><p><code>objc_initWeak</code>ï¼šç”¨æ¥åˆå§‹åŒ–ä¸€ä¸ªå…¨æ–°çš„ weak æŒ‡é’ˆã€‚ä¾‹å¦‚ä»¥ä¸‹åœºæ™¯ï¼š</p>  <figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSObject</span> *obj = ...;</span><br><span class="line">__<span class="keyword">weak</span> <span class="type">id</span> weakPtr = obj;<span class="comment">// åœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±æŒ‡å‘äº†å¯¹è±¡ã€‚</span></span><br></pre></td></tr></table></figure></li><li><p><code>objc_storeWeak</code>ï¼šå½“ weak æŒ‡é’ˆè¢«èµ‹å€¼çš„æ—¶å€™è°ƒç”¨ã€‚ä¾‹å¦‚ä»¥ä¸‹åœºæ™¯ï¼š</p>  <figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSObject</span> *obj = ...;</span><br><span class="line">__<span class="keyword">weak</span> <span class="type">id</span> weakPtr;</span><br><span class="line">weakPtr = obj;<span class="comment">// å…ˆåˆå§‹åŒ–ï¼Œåèµ‹å€¼ã€‚</span></span><br></pre></td></tr></table></figure></li></ul><p>ä»ä»¥ä¸Š 4 ä¸ªåˆå§‹åŒ–å‡½æ•°ä¸éš¾å‘ç°ï¼Œå®ƒä»¬æœ€ç»ˆéƒ½è°ƒç”¨äº†åŒä¸€ä¸ªå‡½æ•° <code>storeWeak</code>ï¼ŒåŒºåˆ«å°±æ˜¯ä¼ é€’ç»™å‡½æ•°çš„æ¨¡æ¿å‚æ•°ç•¥æœ‰ä¸åŒã€‚</p><h3 id="weak-æŒ‡é’ˆçš„åˆå§‹åŒ–ç»†èŠ‚ï¼šstoreWeak"><a href="#weak-æŒ‡é’ˆçš„åˆå§‹åŒ–ç»†èŠ‚ï¼šstoreWeak" class="headerlink" title="weak æŒ‡é’ˆçš„åˆå§‹åŒ–ç»†èŠ‚ï¼šstoreWeak"></a>weak æŒ‡é’ˆçš„åˆå§‹åŒ–ç»†èŠ‚ï¼šstoreWeak</h3><p><code>storeWeak</code> å‡½æ•°çš„ç›¸å…³ä»£ç æ•´ç†åå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">HaveOld</span> &#123; DontHaveOld = <span class="literal">false</span>, DoHaveOld = <span class="literal">true</span> &#125;;</span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">HaveNew</span> &#123; DontHaveNew = <span class="literal">false</span>, DoHaveNew = <span class="literal">true</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">CrashIfDeallocating</span> &#123;</span><br><span class="line">    DontCrashIfDeallocating = <span class="literal">false</span>, DoCrashIfDeallocating = <span class="literal">true</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">location: weak æŒ‡é’ˆçš„å†…å­˜åœ°å€ï¼Œå³ `__weak id weakPtr;` ä¸­çš„ &amp;weakPtrã€‚</span></span><br><span class="line"><span class="comment">newObj: weak æŒ‡é’ˆè¦æŒ‡å‘çš„å¯¹è±¡ï¼Œå³ `__weak id weakPtr = obj;` ä¸­çš„ objã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">template</span> &lt;HaveOld haveOld, HaveNew haveNew, </span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">CrashIfDeallocating</span> crashIfDeallocating&gt;</span><br><span class="line"><span class="function"><span class="type">static</span> id <span class="title">storeWeak</span><span class="params">(id *location, objc_object *newObj)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å½“ newObj çš„ç±»å‹è¿˜æœªåˆå§‹åŒ–çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚</span></span><br><span class="line">    Class previouslyInitializedClass = nil;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¿å­˜ weak æŒ‡é’ˆå½“å‰æŒ‡å‘çš„å¯¹è±¡ã€‚</span></span><br><span class="line">    id oldObj;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SideTable æ˜¯ç”¨æ¥å­˜å‚¨å¼±å¼•ç”¨å…³è”çš„ 1 ä¸ªæ•°æ®ç»“æ„ï¼Œåé¢ä¼šå•ç‹¬è®²ã€‚</span></span><br><span class="line">    SideTable *oldTable;</span><br><span class="line">    SideTable *newTable;</span><br><span class="line"></span><br><span class="line"> retry:</span><br><span class="line">    <span class="keyword">if</span> (haveOld) &#123;</span><br><span class="line">        oldObj = *location;</span><br><span class="line">        <span class="comment">// è°ƒç”¨å…¨å±€å‡½æ•° SideTables è·å– oldObj å¯¹åº”çš„ SideTable å¯¹è±¡ã€‚</span></span><br><span class="line">        oldTable = &amp;<span class="built_in">SideTables</span>()[oldObj];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        oldTable = nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (haveNew) &#123;</span><br><span class="line">        newTable = &amp;<span class="built_in">SideTables</span>()[newObj];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        newTable = nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¯¥å‡½æ•°ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥æ‰§è¡Œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œ</span></span><br><span class="line">    <span class="comment">// weak æŒ‡é’ˆçš„å€¼æœ‰å¯èƒ½è¢«å…¶å®ƒçº¿ç¨‹ä¿®æ”¹äº†ï¼Œ</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯çš„è¯å°±è·³è½¬åˆ° retry é‡æ–°è·å–æ•°æ®ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (haveOld &amp;&amp; *location != oldObj) &#123;</span><br><span class="line">        <span class="keyword">goto</span> retry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (haveNew &amp;&amp; newObj) &#123;</span><br><span class="line">        Class cls = newObj-&gt;<span class="built_in">getIsa</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        æ£€æŸ¥ newObj çš„ç±»å‹æ˜¯å¦å·²ç»å®Œæˆåˆå§‹åŒ–ã€‚</span></span><br><span class="line"><span class="comment">        ä¸€èˆ¬éƒ½ä¸ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œé™¤éä½ åœ¨ +initialize ä¸­å¯¹è¯¥å¯¹è±¡è¿›è¡Œå¼±å¼•ç”¨ï¼Œ</span></span><br><span class="line"><span class="comment">        ä¾‹å¦‚ä»¥ä¸‹åœºæ™¯ï¼š</span></span><br><span class="line"><span class="comment">        @implementation Person</span></span><br><span class="line"><span class="comment">        + (void)initialize &#123;</span></span><br><span class="line"><span class="comment">           Person *obj = [[self alloc] init];</span></span><br><span class="line"><span class="comment">           // æ­¤æ—¶ Person ç±»è¿˜æœªå®Œæˆåˆå§‹åŒ–æ“ä½œã€‚</span></span><br><span class="line"><span class="comment">           __weak typeof(obj) weakObj = obj;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        @end</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (cls != previouslyInitializedClass &amp;&amp;  </span><br><span class="line">            !cls-&gt;<span class="built_in">isInitialized</span>()) &#123;  </span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å¯¹ newObj ç±»å‹è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œç„¶åè·³è½¬ retry é‡æ–°è·å–æ•°æ®ã€‚</span></span><br><span class="line">            <span class="built_in">class_initialize</span>(cls, newObj);</span><br><span class="line">            previouslyInitializedClass = cls;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> retry;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (haveOld) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœ weak æŒ‡é’ˆå½“å‰æŒæœ‰äº†ä¸€ä¸ªå¯¹è±¡ï¼Œå…ˆè§£é™¤ä¸è¿™ä¸ªå¯¹è±¡çš„å¼±å¼•ç”¨å…³è”ã€‚</span></span><br><span class="line">        <span class="built_in">weak_unregister_no_lock</span>(&amp;oldTable-&gt;weak_table, oldObj, location);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (haveNew) &#123;</span><br><span class="line">        <span class="comment">// å°† weak æŒ‡é’ˆä¸æ–°å¯¹è±¡å»ºç«‹å¼±å¼•ç”¨å…³è”ã€‚</span></span><br><span class="line">        newObj = <span class="built_in">weak_register_no_lock</span>(&amp;newTable-&gt;weak_table,</span><br><span class="line">        (id)newObj,</span><br><span class="line">        location,</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        ä¹‹å‰åœ¨åˆå§‹åŒ–å‡½æ•°é‚£é‡Œæåˆ°è¿‡å¸¦ OrNil åç¼€å’Œä¸å¸¦åç¼€çš„åŒºåˆ«ï¼Œ</span></span><br><span class="line"><span class="comment">        é‡ç‚¹å°±åœ¨è¿™é‡Œï¼Œå¸¦åç¼€çš„å‡½æ•°è¿™é‡Œä¼šä¼ é€’ ReturnNilIfDeallocatingï¼Œ</span></span><br><span class="line"><span class="comment">        ä¸å¸¦åç¼€çš„ä¼šä¼ é€’ CrashIfDeallocatingã€‚</span></span><br><span class="line"><span class="comment">        å‡½æ•°å†…éƒ¨ä¼šæ£€æŸ¥ newObj æ˜¯å¦æ­£åœ¨é‡Šæ”¾è¿‡ç¨‹ä¸­ï¼Œ</span></span><br><span class="line"><span class="comment">        å¦‚æœæ˜¯çš„è¯å°±ä¼šä½¿ç”¨è¿™ä¸ªå‚æ•°æ¥å†³å®šæ€ä¹ˆå¤„ç†ã€‚</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        crashIfDeallocating ? CrashIfDeallocating : ReturnNilIfDeallocating);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¿®æ”¹ newObj å¯¹è±¡çš„ isa ä¸­å…³äºæ˜¯å¦æœ‰å¼±å¼•ç”¨çš„æ ‡è®°ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (!_objc_isTaggedPointerOrNil(newObj)) &#123;</span><br><span class="line">            newObj-&gt;<span class="built_in">setWeaklyReferenced_nolock</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°† weak æŒ‡é’ˆæŒ‡å‘ newObjã€‚</span></span><br><span class="line">        *location = (id)newObj;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">    è¿™ä¸ªå‡½æ•°æˆ‘ç¿»äº†å¾€å¹´çš„ runtime æºç ï¼Œå‘ç°æ˜¯ä» objc4-818.2 å¼€å§‹å¼•å…¥çš„ã€‚</span></span><br><span class="line"><span class="comment">    å®ƒçš„å†…éƒ¨é€»è¾‘å¤§è‡´å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    1. æ£€æŸ¥å¯¹è±¡æ˜¯å¦å®ç°äº†æ‰‹åŠ¨å¼•ç”¨è®¡æ•°ã€‚</span></span><br><span class="line"><span class="comment">    2. å¦‚æœæ”¯æŒçš„è¯ï¼Œå†åˆ¤æ–­å¯¹è±¡æ˜¯å¦æœ‰å®ä¾‹æ–¹æ³• _setWeaklyReferenced çš„å®ç°ï¼Œå¦‚æœæœ‰çš„è¯å°±è°ƒç”¨ã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">callSetWeaklyReferenced</span>((id)newObj);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (id)newObj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å°±æ˜¯ weak æŒ‡é’ˆåˆå§‹åŒ–çš„æœ€ç»ˆå‡½æ•°ã€‚ä»å‡½æ•°ä¸­ä¸éš¾å‘ç°ï¼Œå®ƒä¸»è¦å°±å¹²äº† 2 ä»¶äº‹ï¼š</p><ol><li>è°ƒç”¨ <code>weak_unregister_no_lock</code>ï¼šå°† weak æŒ‡é’ˆä¸å½“å‰å¯¹è±¡è§£é™¤å¼±å¼•ç”¨å…³è”ã€‚</li><li>è°ƒç”¨ <code>weak_register_no_lock</code>ï¼šå°† weak æŒ‡é’ˆä¸æ–°å¯¹è±¡å»ºç«‹å¼±å¼•ç”¨å…³è”ã€‚</li></ol><h3 id="weak-æŒ‡é’ˆè§£é™¤å…³è”çš„ç»†èŠ‚ï¼šweak-unregister-no-lock"><a href="#weak-æŒ‡é’ˆè§£é™¤å…³è”çš„ç»†èŠ‚ï¼šweak-unregister-no-lock" class="headerlink" title="weak æŒ‡é’ˆè§£é™¤å…³è”çš„ç»†èŠ‚ï¼šweak_unregister_no_lock"></a>weak æŒ‡é’ˆè§£é™¤å…³è”çš„ç»†èŠ‚ï¼šweak_unregister_no_lock</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">weak_unregister_no_lock</span><span class="params">(<span class="type">weak_table_t</span> *weak_table,</span></span></span><br><span class="line"><span class="params"><span class="function">                        id referent_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                        id *referrer_id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// weak æŒ‡é’ˆå½“å‰æŒ‡å‘çš„å¯¹è±¡ï¼Œå³ `__weak id weakPtr = obj;` ä¸­çš„ objã€‚</span></span><br><span class="line">    objc_object *referent = (objc_object *)referent_id;</span><br><span class="line">    <span class="comment">// weak æŒ‡é’ˆçš„å†…å­˜åœ°å€ï¼Œå³ `__weak id weakPtr;` ä¸­çš„ &amp;weakPtrã€‚</span></span><br><span class="line">    objc_object **referrer = (objc_object **)referrer_id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// referent å¯¹è±¡çš„å¼±å¼•ç”¨è¡¨ã€‚</span></span><br><span class="line">    <span class="type">weak_entry_t</span> *entry;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!referent) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä» weak_table ä¸­å–å‡º referent å¯¹åº”çš„å¼±å¼•ç”¨è¡¨ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> ((entry = <span class="built_in">weak_entry_for_referent</span>(weak_table, referent))) &#123;</span><br><span class="line">        <span class="comment">// ä»å¼±å¼•ç”¨è¡¨ä¸­ç§»é™¤ weak æŒ‡é’ˆçš„åœ°å€ï¼Œå³ç§»é™¤ referrerã€‚</span></span><br><span class="line">        <span class="built_in">remove_referrer</span>(entry, referrer);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç§»é™¤åæ£€æŸ¥ä¸€ä¸‹è¡¨æ˜¯å¦ä¸ºç©ºï¼Œ</span></span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯çš„è¯å°±åˆ é™¤è¿™ä¸ªè¡¨ã€‚</span></span><br><span class="line">        <span class="type">bool</span> empty = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (entry-&gt;<span class="built_in">out_of_line</span>() &amp;&amp;</span><br><span class="line">            entry-&gt;num_refs != <span class="number">0</span>) &#123;</span><br><span class="line">            empty = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (entry-&gt;inline_referrers[i]) &#123;</span><br><span class="line">                    empty = <span class="literal">false</span>; </span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (empty) &#123;</span><br><span class="line">            <span class="built_in">weak_entry_remove</span>(weak_table, entry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»å¼±å¼•ç”¨è¡¨ä¸­è·å–æŸä¸ªå¯¹è±¡å¯¹åº”çš„é‚£å¼ è¡¨æ•°æ®ã€‚</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">weak_entry_t</span> *</span></span><br><span class="line"><span class="function"><span class="title">weak_entry_for_referent</span><span class="params">(<span class="type">weak_table_t</span> *weak_table, objc_object *referent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¸‹é¢çš„é€»è¾‘æ˜¯ä¸€æ®µå…¸å‹çš„å“ˆå¸Œè¡¨å®ç°ç»†èŠ‚ï¼Œå…³äºå“ˆå¸Œè¡¨çš„å®ç°åŸç†è¯·è‡ªè¡Œäº†è§£ã€‚</span></span><br><span class="line">    <span class="type">weak_entry_t</span> *weak_entries = weak_table-&gt;weak_entries;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!weak_entries) <span class="keyword">return</span> nil;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> begin = <span class="built_in">hash_pointer</span>(referent) &amp; weak_table-&gt;mask;</span><br><span class="line">    <span class="type">size_t</span> index = begin;</span><br><span class="line">    <span class="type">size_t</span> hash_displacement = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (weak_table-&gt;weak_entries[index].referent != referent) &#123;</span><br><span class="line">        index = (index+<span class="number">1</span>) &amp; weak_table-&gt;mask;</span><br><span class="line">        <span class="keyword">if</span> (index == begin) <span class="built_in">bad_weak_table</span>(weak_table-&gt;weak_entries);</span><br><span class="line">        hash_displacement++;</span><br><span class="line">        <span class="keyword">if</span> (hash_displacement &gt; weak_table-&gt;max_hash_displacement) &#123;</span><br><span class="line">            <span class="keyword">return</span> nil;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &amp;weak_table-&gt;weak_entries[index];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»å¼±å¼•ç”¨è¡¨ä¸­ç§»é™¤æŒ‡å®šçš„ weak æŒ‡é’ˆã€‚</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">remove_referrer</span><span class="params">(<span class="type">weak_entry_t</span> *entry, objc_object **old_referrer)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç³»ç»Ÿåœ¨å­˜å‚¨å¼±æŒ‡é’ˆæ•°æ®çš„æ—¶å€™ä¼šé‡‡ç”¨ 2 å¥—æ–¹æ¡ˆã€‚</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ•°æ®é‡æ¯”è¾ƒå°å°±ä¼šä½¿ç”¨é™æ€æ•°ç»„å­˜æ”¾ã€‚</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„é€»è¾‘å°±æ˜¯åˆ¤æ–­ï¼Œå¦‚æœæ˜¯é™æ€æ•°ç»„æ–¹æ¡ˆå°±æ‰§è¡Œè¿™æ®µé€»è¾‘ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (!entry-&gt;<span class="built_in">out_of_line</span>()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (entry-&gt;inline_referrers[i] == old_referrer) &#123;</span><br><span class="line">                entry-&gt;inline_referrers[i] = nil;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯åŠ¨æ€æ•°ç»„å­˜å‚¨çš„è¯ï¼Œå°±æ‰§è¡Œè¿™æ®µé€»è¾‘ã€‚</span></span><br><span class="line">    <span class="type">size_t</span> begin = <span class="built_in">w_hash_pointer</span>(old_referrer) &amp; (entry-&gt;mask);</span><br><span class="line">    <span class="type">size_t</span> index = begin;</span><br><span class="line">    <span class="type">size_t</span> hash_displacement = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (entry-&gt;referrers[index] != old_referrer) &#123;</span><br><span class="line">        index = (index+<span class="number">1</span>) &amp; entry-&gt;mask;</span><br><span class="line">        <span class="keyword">if</span> (index == begin) <span class="built_in">bad_weak_table</span>(entry);</span><br><span class="line">        hash_displacement++;</span><br><span class="line">        <span class="keyword">if</span> (hash_displacement &gt; entry-&gt;max_hash_displacement) &#123;</span><br><span class="line">            <span class="comment">// å¼±å¼•ç”¨è¡¨ä¸­æ²¡æœ‰è¿™ä¸ªå¼±æŒ‡é’ˆæ•°æ®ï¼Œä¸éœ€è¦ç§»é™¤ã€‚</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    entry-&gt;referrers[index] = nil;</span><br><span class="line">    entry-&gt;num_refs--;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»å¼±å¼•ç”¨è¡¨ä¸­ç§»é™¤æŸå¼ è¡¨ã€‚</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">weak_entry_remove</span><span class="params">(<span class="type">weak_table_t</span> *weak_table, <span class="type">weak_entry_t</span> *entry)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯åŠ¨æ€æ•°ç»„æ–¹æ¡ˆçš„è¯ï¼Œé‡Šæ”¾åˆ›å»ºçš„åŠ¨æ€æ•°ç»„ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (entry-&gt;<span class="built_in">out_of_line</span>()) <span class="built_in">free</span>(entry-&gt;referrers);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(entry, <span class="number">0</span>, <span class="built_in">sizeof</span>(*entry));</span><br><span class="line"></span><br><span class="line">    weak_table-&gt;num_entries--;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœéœ€è¦çš„è¯ï¼Œå¯¹å¼±å¼•ç”¨è¡¨è¿›è¡Œç¼©å®¹ã€‚</span></span><br><span class="line">    <span class="built_in">weak_compact_maybe</span>(weak_table);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç ç¨å¾®æœ‰ç‚¹å¤šï¼Œä½†æ•´ä½“çš„é€»è¾‘æ¯”è¾ƒæ¸…æ™°ã€‚<code>weak_unregister_no_lock</code> å‡½æ•°ä¸­ä¸»è¦åšäº† 3 ä»¶äº‹ï¼š</p><ol><li>è°ƒç”¨ <code>weak_entry_for_referent</code> ä»å¼±å¼•ç”¨è¡¨ä¸­è·å–æŒ‡å®šçš„é‚£å¼ è¡¨æ•°æ®ã€‚</li><li>è°ƒç”¨ <code>remove_referrer</code> ä»è¡¨ä¸­ç§»é™¤å¼±æŒ‡é’ˆï¼ˆå³ referrerï¼‰ã€‚</li><li>æ£€æŸ¥è¡¨æ˜¯å¦ä¸ºç©ºï¼Œæ˜¯çš„è¯å°±è°ƒç”¨ <code>weak_entry_remove</code> ä» weak_table ä¸­ç§»é™¤è¿™å¼ è¡¨ã€‚</li></ol><p>ç§»é™¤å¼±å¼•ç”¨å…³è”ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä» weak_table ä¸­æ‰¾åˆ°å¯¹è±¡å¯¹åº”çš„å¼±å¼•ç”¨æ•°ç»„ï¼Œç„¶åä»æ•°ç»„ä¸­æ‰¾åˆ°éœ€è¦ç§»é™¤çš„ weak æŒ‡é’ˆå¹¶å°†å…¶ç½®ç©ºã€‚weak_table å…¶å®å°±æ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œå…³äºå“ˆå¸Œè¡¨çš„å®ç°åŸç†è¯·è‡ªè¡Œäº†è§£ã€‚</p><h3 id="weak-æŒ‡é’ˆå»ºç«‹å…³è”çš„ç»†èŠ‚ï¼šweak-register-no-lock"><a href="#weak-æŒ‡é’ˆå»ºç«‹å…³è”çš„ç»†èŠ‚ï¼šweak-register-no-lock" class="headerlink" title="weak æŒ‡é’ˆå»ºç«‹å…³è”çš„ç»†èŠ‚ï¼šweak_register_no_lock"></a>weak æŒ‡é’ˆå»ºç«‹å…³è”çš„ç»†èŠ‚ï¼šweak_register_no_lock</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">id </span></span><br><span class="line"><span class="function"><span class="title">weak_register_no_lock</span><span class="params">(<span class="type">weak_table_t</span> *weak_table,</span></span></span><br><span class="line"><span class="params"><span class="function">                      id referent_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                      id *referrer_id,</span></span></span><br><span class="line"><span class="params"><span class="function">                      WeakRegisterDeallocatingOptions deallocatingOptions)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// weak æŒ‡é’ˆå½“å‰æŒ‡å‘çš„å¯¹è±¡ï¼Œå³ `__weak id weakPtr = obj;` ä¸­çš„ objã€‚</span></span><br><span class="line">    objc_object *referent = (objc_object *)referent_id;</span><br><span class="line">    <span class="comment">// weak æŒ‡é’ˆçš„å†…å­˜åœ°å€ï¼Œå³ `__weak id weakPtr;` ä¸­çš„ &amp;weakPtrã€‚</span></span><br><span class="line">    objc_object **referrer = (objc_object **)referrer_id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯ç¡®ä¿ weak æŒ‡é’ˆè¦æŒ‡å‘çš„é‚£ä¸ªå¯¹è±¡æ˜¯æœ‰æ•ˆçš„ï¼ˆå³æ²¡æœ‰æ­£åœ¨é‡Šæ”¾ï¼‰ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (deallocatingOptions == ReturnNilIfDeallocating ||</span><br><span class="line">        deallocatingOptions == CrashIfDeallocating) &#123;</span><br><span class="line">        <span class="type">bool</span> deallocating;</span><br><span class="line">        <span class="keyword">if</span> (!referent-&gt;<span class="built_in">ISA</span>()-&gt;<span class="built_in">hasCustomRR</span>()) &#123;</span><br><span class="line">            deallocating = referent-&gt;<span class="built_in">rootIsDeallocating</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">auto</span> allowsWeakReference = (<span class="built_in">BOOL</span>(*)(objc_object *, SEL))</span><br><span class="line">            <span class="built_in">lookUpImpOrForwardTryCache</span>((id)referent, @<span class="built_in">selector</span>(allowsWeakReference),</span><br><span class="line">                                       referent-&gt;<span class="built_in">getIsa</span>());</span><br><span class="line">            <span class="keyword">if</span> ((IMP)allowsWeakReference == _objc_msgForward) &#123;</span><br><span class="line">                <span class="keyword">return</span> nil;</span><br><span class="line">            &#125;</span><br><span class="line">            deallocating =</span><br><span class="line">            ! (*allowsWeakReference)(referent, @<span class="built_in">selector</span>(allowsWeakReference));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœæ­£åœ¨é‡Šæ”¾çš„è¯ï¼Œæ ¹æ®å‚æ•° deallocatingOptions æ¥å†³å®šæ‰§è¡Œä»€ä¹ˆæ“ä½œã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (deallocating) &#123;</span><br><span class="line">            <span class="keyword">if</span> (deallocatingOptions == CrashIfDeallocating) &#123;</span><br><span class="line">                _objc_fatal(<span class="string">&quot;Cannot form weak reference to instance (%p) of &quot;</span></span><br><span class="line">                            <span class="string">&quot;class %s. It is possible that this object was &quot;</span></span><br><span class="line">                            <span class="string">&quot;over-released, or is in the process of deallocation.&quot;</span>,</span><br><span class="line">                            (<span class="type">void</span>*)referent, <span class="built_in">object_getClassName</span>((id)referent));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> nil;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">weak_entry_t</span> *entry;</span><br><span class="line">    <span class="comment">// weak_entry_for_referent å‡½æ•°åœ¨å‰é¢çš„ weak_unregister_no_lock ä¸­å·²è§£é‡Šè¿‡ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> ((entry = <span class="built_in">weak_entry_for_referent</span>(weak_table, referent))) &#123;</span><br><span class="line">        <span class="built_in">append_referrer</span>(entry, referrer);</span><br><span class="line">    &#125;  <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æ‰¾ä¸åˆ°å¯¹åº”çš„è¡¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°è¡¨ã€‚</span></span><br><span class="line">        <span class="type">weak_entry_t</span> <span class="built_in">new_entry</span>(referent, referrer);</span><br><span class="line">        <span class="comment">// å¦‚æœéœ€è¦çš„è¯ï¼Œå¯¹ weak_table è¿›è¡Œæ‰©å®¹ã€‚</span></span><br><span class="line">        <span class="built_in">weak_grow_maybe</span>(weak_table);</span><br><span class="line">        <span class="comment">// å°†æ–°è¡¨æ’å…¥åˆ° weak_table ä¸­ã€‚</span></span><br><span class="line">        <span class="built_in">weak_entry_insert</span>(weak_table, &amp;new_entry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> referent_id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘å¼±å¼•ç”¨è¡¨ä¸­æ·»åŠ ä¸€ä¸ª weak æŒ‡é’ˆã€‚</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">append_referrer</span><span class="params">(<span class="type">weak_entry_t</span> *entry, objc_object **new_referrer)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰é‡‡ç”¨çš„æ˜¯é™æ€æ•°ç»„æ–¹æ¡ˆå°±æ‰§è¡Œè¿™æ®µé€»è¾‘ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (!entry-&gt;<span class="built_in">out_of_line</span>()) &#123;</span><br><span class="line">        <span class="comment">// å°è¯•åœ¨é™æ€æ•°ç»„ä¸­æ’å…¥æ•°æ®ã€‚</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (entry-&gt;inline_referrers[i] == nil) &#123;</span><br><span class="line">                entry-&gt;inline_referrers[i] = new_referrer;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¥åˆ°è¿™é‡Œè¯´æ˜é™æ€æ•°ç»„å·²ç»å­˜æ»¡äº†ï¼Œåé¢çš„é€»è¾‘æ˜¯æŠŠé™æ€æ•°ç»„è½¬ä¸ºåŠ¨æ€æ•°ç»„å­˜å‚¨ã€‚</span></span><br><span class="line">        <span class="type">weak_referrer_t</span> *new_referrers = (<span class="type">weak_referrer_t</span> *)</span><br><span class="line">            <span class="built_in">calloc</span>(<span class="number">4</span>, <span class="built_in">sizeof</span>(<span class="type">weak_referrer_t</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            new_referrers[i] = entry-&gt;inline_referrers[i];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        entry-&gt;referrers = new_referrers;</span><br><span class="line">        entry-&gt;num_refs = <span class="number">4</span>;</span><br><span class="line">        entry-&gt;out_of_line_ness = <span class="number">2</span>;</span><br><span class="line">        entry-&gt;mask = <span class="number">4</span> - <span class="number">1</span>;</span><br><span class="line">        entry-&gt;max_hash_displacement = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ•°ç»„çš„å…ƒç´ æ•°é‡å¤§äºç­‰äºæ€»å®¹é‡çš„ 3/4ï¼Œåˆ™å¯¹æ•°ç»„è¿›è¡Œæ‰©å®¹å¹¶æ’å…¥æ–°æ•°æ®ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (entry-&gt;num_refs &gt;= (entry-&gt;mask + <span class="number">1</span>) * <span class="number">3</span>/<span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">grow_refs_and_insert</span>(entry, new_referrer);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">size_t</span> begin = <span class="built_in">w_hash_pointer</span>(new_referrer) &amp; (entry-&gt;mask);</span><br><span class="line">    <span class="type">size_t</span> index = begin;</span><br><span class="line">    <span class="type">size_t</span> hash_displacement = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (entry-&gt;referrers[index] != nil) &#123;</span><br><span class="line">        hash_displacement++;</span><br><span class="line">        index = (index+<span class="number">1</span>) &amp; entry-&gt;mask;</span><br><span class="line">        <span class="keyword">if</span> (index == begin) <span class="built_in">bad_weak_table</span>(entry);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// hash_displacement ä¿å­˜çš„æ˜¯æ­¤æ¬¡é‡åˆ°çš„å“ˆå¸Œå†²çªæ¬¡æ•°ï¼Œ</span></span><br><span class="line">    <span class="comment">// ä¹‹æ‰€ä»¥è¦ä¿å­˜è¿™ä¸ªå€¼ï¼Œæ˜¯å› ä¸ºå–å€¼çš„æ—¶å€™ä¹Ÿä¼šé‡åˆ°å“ˆå¸Œå†²çªï¼Œ</span></span><br><span class="line">    <span class="comment">// æ­¤æ—¶éœ€è¦å’Œè¿™ä¸ªå€¼è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå¤§äºè¿™ä¸ªå€¼çš„è¯å°±è¯´æ˜å“ˆå¸Œè¡¨ä¸­æ²¡æœ‰è¦æ‰¾çš„æ•°æ®ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (hash_displacement &gt; entry-&gt;max_hash_displacement) &#123;</span><br><span class="line">        entry-&gt;max_hash_displacement = hash_displacement;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">weak_referrer_t</span> &amp;ref = entry-&gt;referrers[index];</span><br><span class="line">    ref = new_referrer;</span><br><span class="line">    entry-&gt;num_refs++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å»ºç«‹å…³è”å’Œè§£é™¤å…³è”çš„é€»è¾‘ç›¸ä¼¼ï¼Œæœ¬è´¨éƒ½æ˜¯é€šè¿‡ <code>weak_entry_for_referent</code> è·å–å¯¹åº”çš„è¡¨ã€‚ç„¶ååœ¨é€šè¿‡ weak æŒ‡é’ˆè¿›è¡Œä¸€ç³»åˆ—å“ˆå¸Œè¿ç®—ï¼Œä»è€Œæ‹¿åˆ°è¦æ·»åŠ &#x2F;è¦åˆ é™¤çš„æ•°ç»„ç´¢å¼•ï¼Œæœ€ç»ˆå¯¹æ•°ç»„å…ƒç´ è¿›è¡Œæ·»åŠ &#x2F;åˆ é™¤æ“ä½œã€‚</p><p>æˆªæ­¢åˆ°è¿™é‡Œï¼Œå…³äº weak æŒ‡é’ˆçš„æ•´ä¸ªåˆå§‹åŒ–è¿‡ç¨‹å·²ç»å…¨éƒ¨è®²å®Œäº†ã€‚å¦‚æœä½ è¿˜æƒ³äº†è§£æ›´å¤šç»†èŠ‚çš„è¯å¯ä»¥ç»§ç»­é˜…è¯»åé¢çš„å†…å®¹ã€‚</p><h2 id="æ·±å…¥å‰–æ-SideTable-ç±»å‹"><a href="#æ·±å…¥å‰–æ-SideTable-ç±»å‹" class="headerlink" title="æ·±å…¥å‰–æ SideTable ç±»å‹"></a>æ·±å…¥å‰–æ SideTable ç±»å‹</h2><p>SideTable æ˜¯ç”¨æ¥å­˜å‚¨å¼±å¼•ç”¨æ•°æ®å’Œå¼•ç”¨è®¡æ•°çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œç”±äºè¿™ç¯‡æ–‡ç« åªæ¶‰åŠå¼±å¼•ç”¨ç›¸å…³é—®é¢˜ï¼Œæ‰€ä»¥åœ¨åé¢çš„æºç ä¸­æˆ‘ä¼šç‰¹æ„å»æ‰ä¸æ–‡ç« ä¸ç›¸å…³çš„å†…å®¹ï¼Œå¦‚æœä½ æƒ³äº†è§£å…¨éƒ¨ç»†èŠ‚çš„è¯è¯·é˜…è¯»æºç ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">SideTable</span> &#123;</span><br><span class="line"> <span class="comment">// ä½ å¯ä»¥æŠŠå®ƒç†è§£æˆä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œ</span></span><br><span class="line">    <span class="comment">// key æ˜¯å¯¹è±¡ï¼›value æ˜¯å¯¹è±¡å¯¹åº”çš„å¼±å¼•ç”¨è¡¨æ•°æ®ã€‚</span></span><br><span class="line">    <span class="type">weak_table_t</span> weak_table;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">weak_table_t</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    è¿™æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ª weak_entry_t å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment">    weak_entry_t é‡Œå­˜å‚¨äº†å¼±å¼•ç”¨çš„ç›¸å…³æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="type">weak_entry_t</span> *weak_entries;</span><br><span class="line">    <span class="comment">// æ•°ç»„ weak_entries çš„å…ƒç´ æ•°é‡ã€‚</span></span><br><span class="line">    <span class="type">size_t</span>    num_entries;</span><br><span class="line">    <span class="comment">// æ•°ç»„ weak_entries çš„é•¿åº¦å‡ä¸€ï¼Œæ±‚æ•°ç»„ç´¢å¼•æ—¶éœ€è¦ç”¨åˆ°ã€‚</span></span><br><span class="line">    <span class="type">uintptr_t</span> mask;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    è®°å½•åœ¨å­˜å‚¨å…ƒç´ æ—¶é‡åˆ°çš„æœ€å¤§çš„å“ˆå¸Œå†²çªæ¬¡æ•°ã€‚</span></span><br><span class="line"><span class="comment">    åœ¨æŸ¥æ‰¾å…ƒç´ çš„æ—¶å€™ä¼šè¢«ç”¨åˆ°ï¼Œ</span></span><br><span class="line"><span class="comment">    å¦‚æœæŸ¥æ‰¾è¿‡ç¨‹ä¸­å“ˆå¸Œå†²çªæ¬¡æ•°å¤§äºè¿™ä¸ªå€¼å°±è¯´æ˜å“ˆå¸Œè¡¨ä¸­æ²¡æœ‰è¦æ‰¾çš„æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">uintptr_t</span> max_hash_displacement;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çœŸæ­£ç”¨æ¥å­˜å‚¨å¼±å¼•ç”¨æ•°æ®çš„ç»“æ„ã€‚</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">weak_entry_t</span> &#123;</span><br><span class="line">    <span class="comment">// weak æŒ‡é’ˆæ‰€æŒ‡å‘çš„é‚£ä¸ªå¯¹è±¡ï¼ˆç±»ä¼¼å“ˆå¸Œè¡¨ä¸­çš„ keyï¼‰ã€‚</span></span><br><span class="line">    id referent;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ä»ä»¥ä¸‹ä»£ç å¯ä»¥å‘ç°ï¼šç³»ç»Ÿå†…éƒ¨åœ¨å­˜å‚¨å¼±å¼•ç”¨æ•°æ®çš„æ—¶å€™æœ‰ 2 å¥—æ–¹æ¡ˆï¼Œ</span></span><br><span class="line"><span class="comment">    å¦‚æœæ•°æ®æ¯”è¾ƒå°‘å°±ä½¿ç”¨é™æ€æ•°ç»„ inline_referrers å­˜å‚¨ï¼›</span></span><br><span class="line"><span class="comment">    å¦‚æœæ•°æ®æ¯”è¾ƒå¤šå°±ä½¿ç”¨åŠ¨æ€æ•°ç»„ referrers å­˜å‚¨ã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            <span class="comment">// ç”¨æ¥å­˜å‚¨å¼±å¼•ç”¨çš„åŠ¨æ€æ•°ç»„ã€‚</span></span><br><span class="line">            id *referrers;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            ä¸€ä¸ªæ ‡è®°ä½ï¼Œå¦‚æœè¿™ä¸ªå€¼æ˜¯ 2 çš„è¯å°±è¡¨ç¤ºä½¿ç”¨çš„æ˜¯åŠ¨æ€æ•°ç»„ã€‚</span></span><br><span class="line"><span class="comment">            å› ä¸º objc å¯¹è±¡çš„å†…å­˜åœ°å€çš„æœ€åä¸€ä½åªä¼šæ˜¯ 0x8 æˆ– 0x0ï¼Œ</span></span><br><span class="line"><span class="comment">            å³ï¼šå¦‚æœé‡‡ç”¨çš„æ˜¯é™æ€æ•°ç»„æ–¹æ¡ˆçš„è¯ï¼Œè¿™ä¸ªä½ç½®çš„æ•°æ®ç»å¯¹æ˜¯ 0ã€‚</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="type">uintptr_t</span>        out_of_line_ness : <span class="number">2</span>;</span><br><span class="line">            <span class="comment">// æ•°ç»„ referrers çš„å…ƒç´ æ•°é‡ã€‚</span></span><br><span class="line">            <span class="type">uintptr_t</span>        num_refs : <span class="number">62</span>;</span><br><span class="line">            <span class="comment">// æ•°ç»„ referrers çš„é•¿åº¦å‡ä¸€ï¼Œå’Œ weak_table_t ä¸­çš„ mask åŠŸèƒ½ä¸€æ ·ã€‚</span></span><br><span class="line">            <span class="type">uintptr_t</span>        mask;</span><br><span class="line">            <span class="comment">// å’Œ weak_table_t ä¸­çš„ max_hash_displacement åŠŸèƒ½ä¸€æ ·ã€‚</span></span><br><span class="line">            <span class="type">uintptr_t</span>        max_hash_displacement;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            <span class="comment">// ç”¨æ¥å­˜å‚¨å¼±å¼•ç”¨çš„é™æ€æ•°ç»„ã€‚</span></span><br><span class="line">            id inline_referrers[<span class="number">4</span>];</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä½ å¯ä»¥æŠŠ SideTable ç†è§£æˆä¸€ä¸ªè·å–å¼±å¼•ç”¨è¡¨çš„å…¥å£ï¼Œweak_table ç±»ä¼¼ä¸€ä¸ªå¤§å“ˆå¸Œè¡¨ï¼Œè¿™ä¸ªå“ˆå¸Œè¡¨çš„ key æ˜¯ objc å¯¹è±¡ï¼Œvalue æ˜¯å¯¹åº”çš„å¼±å¼•ç”¨æ•°ç»„ã€‚å…³äº weak æŒ‡é’ˆçš„æ“ä½œï¼Œä¾‹å¦‚è§£é™¤å…³è”å’Œå»ºç«‹å…³è”ï¼Œå…¶å®å°±æ˜¯ä» weak_table ä¸­è·å–å…¶å¯¹åº”çš„å¼±å¼•ç”¨æ•°ç»„ï¼Œç„¶åä»è¿™ä¸ªæ•°ç»„ä¸­ç§»é™¤æˆ–æ·»åŠ å¯¹åº”çš„å¼±æŒ‡é’ˆåœ°å€ã€‚</p><h2 id="weak-æŒ‡é’ˆè‡ªåŠ¨èµ‹å€¼-nil-çš„å®ç°ç»†èŠ‚ï¼šweak-clear-no-lock"><a href="#weak-æŒ‡é’ˆè‡ªåŠ¨èµ‹å€¼-nil-çš„å®ç°ç»†èŠ‚ï¼šweak-clear-no-lock" class="headerlink" title="weak æŒ‡é’ˆè‡ªåŠ¨èµ‹å€¼ nil çš„å®ç°ç»†èŠ‚ï¼šweak_clear_no_lock"></a>weak æŒ‡é’ˆè‡ªåŠ¨èµ‹å€¼ nil çš„å®ç°ç»†èŠ‚ï¼šweak_clear_no_lock</h2><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œweak æŒ‡é’ˆåœ¨å¯¹è±¡è¢«é‡Šæ”¾ä¹‹åä¼šè‡ªåŠ¨æŒ‡å‘ nilï¼Œé‚£ä¹ˆå®ƒåˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p><p>å…³äºé‡Šæ”¾æµç¨‹çš„å‡½æ•°è°ƒç”¨é¡ºåºè¿™é‡Œå°±ä¸å…·ä½“å±•å¼€äº†ï¼Œåœ¨ <a href="https://github.com/apple-oss-distributions/objc4/tree/objc4-906">objc4-906</a> ç‰ˆæœ¬ä¸­ï¼Œå…¶å‡½æ•°è°ƒç”¨é¡ºåºå¦‚ä¸‹ï¼šdealloc &#x3D;&gt; _objc_rootDealloc &#x3D;&gt; rootDealloc &#x3D;&gt; object_dispose &#x3D;&gt; objc_destructInstance &#x3D;&gt; clearDeallocating &#x3D;&gt; clearDeallocating_slow &#x3D;&gt; weak_clear_no_lockï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹æœ€åä¸€ä¸ªå‡½æ•° <code>weak_clear_no_lock</code> çš„å®ç°ç»†èŠ‚ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> </span></span><br><span class="line"><span class="function"><span class="title">weak_clear_no_lock</span><span class="params">(<span class="type">weak_table_t</span> *weak_table, id referent_id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ­£åœ¨é‡Šæ”¾çš„å¯¹è±¡ã€‚</span></span><br><span class="line">    objc_object *referent = (objc_object *)referent_id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å½“å‰å¯¹è±¡å¯¹åº”çš„å¼±å¼•ç”¨è¡¨ã€‚</span></span><br><span class="line">    <span class="type">weak_entry_t</span> *entry = <span class="built_in">weak_entry_for_referent</span>(weak_table, referent);</span><br><span class="line">    <span class="keyword">if</span> (entry == nil) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">weak_referrer_t</span> *referrers;</span><br><span class="line">    <span class="type">size_t</span> count;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–å¼±æŒ‡é’ˆæ•°ç»„å’Œæ•°ç»„å®¹é‡ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (entry-&gt;<span class="built_in">out_of_line</span>()) &#123;</span><br><span class="line">        referrers = entry-&gt;referrers;</span><br><span class="line">        count = (entry-&gt;mask ? entry-&gt;mask + <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        referrers = entry-&gt;inline_referrers;</span><br><span class="line">        count = <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é‡ç‚¹ï¼šç³»ç»Ÿä¼šéå†å¼±æŒ‡é’ˆæ•°ç»„ä¸­çš„æ¯ä¸ªåœ°å€ï¼Œå¹¶å°†å®ƒä»¬èµ‹å€¼ä¸º nilã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line">        objc_object **referrer = referrers[i];</span><br><span class="line">        <span class="keyword">if</span> (referrer) &#123;</span><br><span class="line">            <span class="keyword">if</span> (*referrer == referent) &#123;<span class="comment">// ç­‰ä»·äº weakSelf == self(self è¡¨ç¤ºå½“å‰æ­£åœ¨é‡Šæ”¾çš„å¯¹è±¡)</span></span><br><span class="line">                *referrer = nil;<span class="comment">// ç­‰ä»·äº weakSelf = nil;</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (*referrer) &#123;</span><br><span class="line">                <span class="built_in">REPORT_WEAK_ERROR</span>(<span class="string">&quot;__weak variable at %p holds %p instead of %p. &quot;</span></span><br><span class="line">                                  <span class="string">&quot;This is probably incorrect use of &quot;</span></span><br><span class="line">                                  <span class="string">&quot;objc_storeWeak() and objc_loadWeak().&quot;</span>,</span><br><span class="line">                                  referrer, (<span class="type">void</span>*)*referrer, (<span class="type">void</span>*)referent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»å¼±å¼•ç”¨è¡¨ä¸­ç§»é™¤è¿™å¼ è¡¨ã€‚</span></span><br><span class="line">    <span class="built_in">weak_entry_remove</span>(weak_table, entry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»æºç ä¸­ä¸éš¾å‘ç°ï¼Œç³»ç»Ÿä¼šåœ¨å¯¹è±¡é‡Šæ”¾çš„æ—¶å€™ï¼Œè·å–å…¶å¯¹åº”çš„å¼±å¼•ç”¨è¡¨ï¼Œç„¶åéå†è¿™ä¸ªè¡¨ä¸­çš„ weak æŒ‡é’ˆå¹¶å°†å…¶èµ‹å€¼ä¸º nilã€‚</p><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œå…³äº weak æŒ‡é’ˆçš„æ‰€æœ‰å†…å®¹å°±è®²å®Œäº†ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åœ¨ runtime åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ä¸€ä¸ªå…¨å±€å‡½æ•° <code>side_tables_init</code> åˆå§‹åŒ–ä¸€ä¸ªå…¨å±€æ•°ç»„ï¼Œæ•°ç»„çš„å…ƒç´ æ˜¯ SideTable å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡å…¨å±€å‡½æ•° <code>SideTables</code> æ‹¿åˆ°è¿™ä¸ªæ•°ç»„ä»¥åŠå¯¹è±¡å¯¹åº”çš„ SideTable å¯¹è±¡ã€‚</p><p>SideTable ä¸­æœ‰ä¸€ä¸ªå˜é‡ weak_tableï¼Œä½ å¯ä»¥å°†å®ƒç†è§£æˆä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œå“ˆå¸Œè¡¨çš„ key æ˜¯å¯¹è±¡ï¼Œvalue æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„å…ƒç´ å°±æ˜¯æŒ‡å‘è¿™ä¸ª key çš„ weak æŒ‡é’ˆåœ°å€ã€‚</p><p>weak æŒ‡é’ˆçš„åˆå§‹åŒ–æ“ä½œå°±æ˜¯æ‹¿åˆ°è¿™ä¸ªå¯¹è±¡å¯¹åº”çš„å¼±æŒ‡é’ˆæ•°ç»„ï¼Œç„¶åå¾€æ•°ç»„é‡Œé¢æŠŠ weak æŒ‡é’ˆçš„å†…å­˜åœ°å€æ·»åŠ è¿›å»ã€‚</p><p>å¦‚æœ weak æŒ‡é’ˆéœ€è¦æŒ‡å‘åˆ«çš„å¯¹è±¡ï¼Œéœ€è¦æ‹¿åˆ°æ—§å¯¹è±¡å¯¹åº”çš„å¼±æŒ‡é’ˆæ•°ç»„å¹¶å°†æ•°ç»„ä¸­å­˜æ”¾ weak æŒ‡é’ˆçš„é‚£ä¸ªä½ç½®ç½®ç©ºï¼Œç„¶åæ‹¿åˆ°æ–°å¯¹è±¡å¯¹åº”çš„å¼±æŒ‡é’ˆæ•°ç»„å¹¶å°† weak æŒ‡é’ˆæ·»åŠ è¿›å»ã€‚</p><p>å¦‚æœå¯¹è±¡é‡Šæ”¾äº†ï¼Œå°±æ‹¿åˆ°è¿™ä¸ªå¯¹è±¡å¯¹åº”çš„å¼±æŒ‡é’ˆæ•°ç»„å¹¶æŒ¨ä¸ªå°†é‡Œé¢çš„ weak æŒ‡é’ˆèµ‹å€¼ä¸º nilã€‚</p><p>ä¸ºäº†åŠ æ·±è‡ªå·±çš„ç†è§£ï¼Œæˆ‘æ¨¡ä»¿ç³»ç»Ÿçš„å®ç°å†™äº†ä¸€ä¸ªç¤ºä¾‹é¡¹ç›® <a href="https://github.com/internetWei/WeakPointer">WeakPointer</a>ï¼Œæˆ‘åœ¨è¿™ä¸ªé¡¹ç›®é‡Œè¿˜ç»™åˆ†ç±»å±æ€§ä¹Ÿæ”¯æŒäº† weak ç‰¹æ€§ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚</p><h2 id="å…³äº-weak-æŒ‡é’ˆçš„ä¸€äº›ç–‘é—®ä¸è§£ç­”"><a href="#å…³äº-weak-æŒ‡é’ˆçš„ä¸€äº›ç–‘é—®ä¸è§£ç­”" class="headerlink" title="å…³äº weak æŒ‡é’ˆçš„ä¸€äº›ç–‘é—®ä¸è§£ç­”"></a>å…³äº weak æŒ‡é’ˆçš„ä¸€äº›ç–‘é—®ä¸è§£ç­”</h2><h3 id="ä¸ºä»€ä¹ˆä¸èƒ½ç»™-Category-æ·»åŠ -weak-å±æ€§ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä¸èƒ½ç»™-Category-æ·»åŠ -weak-å±æ€§ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä¸èƒ½ç»™ Category æ·»åŠ  weak å±æ€§ï¼Ÿ"></a>ä¸ºä»€ä¹ˆä¸èƒ½ç»™ Category æ·»åŠ  weak å±æ€§ï¼Ÿ</h3><p>æˆ‘ä»¬ä¸€èˆ¬æ˜¯è¿™æ ·åˆå§‹åŒ–ä¸€ä¸ª weak æŒ‡é’ˆï¼š<code>__weak id weakPtr = obj;</code>ï¼Œä»æºç ä¸­æˆ‘ä»¬çŸ¥é“ç¼–è¯‘å™¨ä¼šæŠŠä»£ç è½¬æ¢æˆè¿™æ ·ï¼š<code>objc_storeWeak((void *)&amp;weakPtr, obj);</code>ã€‚</p><p>ä»è¿™é‡Œå¯ä»¥å‘ç°ï¼Œè¦å®ç° weak ç‰¹æ€§ï¼Œä½ å¿…é¡»èƒ½æ‹¿åˆ° obj å¯¹è±¡å’Œ weak æŒ‡é’ˆçš„å†…å­˜åœ°å€ï¼Œè€Œ Category ä¸­çš„å±æ€§æ˜¯ä¾é  runtime ä¸­çš„ <code>objc_setAssociatedObject</code> å’Œ <code>objc_getAssociatedObject</code> è¿™ 2 ä¸ªå‡½æ•°æ¥å®ç°çš„ï¼Œæˆ‘ä»¬æ‹¿ä¸åˆ° weak æŒ‡é’ˆçš„å†…å­˜åœ°å€ï¼Œæ•…è€Œæ— æ³•ç»™ Category çš„å±æ€§æ”¯æŒ weak ç‰¹æ€§ã€‚</p><p>ç±»çš„å±æ€§ä¹‹æ‰€ä»¥æ”¯æŒ weak ç‰¹æ€§ï¼Œæ˜¯å› ä¸ºç¼–è¯‘å™¨èƒ½æ‹¿åˆ°è¿™ä¸ªå±æ€§çš„æˆå‘˜å˜é‡çš„åœ°å€ï¼ˆå³ weak æŒ‡é’ˆçš„å†…å­˜åœ°å€ï¼‰ã€‚</p><p>å¦‚æœä½ ä¸€å®šè¦ç»™ Category æ·»åŠ  weak å±æ€§çš„è¯ï¼Œæœ‰ä»¥ä¸‹ 2 ä¸ªæ€è·¯ï¼ˆå»ºè®®é€‰æ‹©ç¬¬ 2 ä¸ªï¼‰ï¼š</p><ol><li><p>å‚è€ƒæˆ‘çš„è¿™ä¸ªé¡¹ç›® <a href="https://github.com/internetWei/WeakPointer">WeakPointer</a> æ¨¡ä»¿ç³»ç»Ÿçš„å®ç°æ‰‹åŠ¨ç»´æŠ¤ä¸€ä¸ªå¼±å¼•ç”¨è¡¨æ¥æ”¯æŒ Category çš„ weak å±æ€§ã€‚</p></li><li><p>åˆ›å»ºä¸€ä¸ªä¸­é—´ç±»ï¼Œç»™ä¸­é—´ç±»å£°æ˜ä¸€ä¸ª weak å±æ€§ï¼ŒCategory çš„å±æ€§å¼ºå¼•ç”¨è¿™ä¸ªä¸­é—´ç±»ï¼Œä¸­é—´ç±»çš„ weak å±æ€§æŒ‡å‘çœŸæ­£çš„å¯¹è±¡ã€‚</p><p> ç¤ºä¾‹ä»£ç ï¼š</p> <figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">WeakTarget</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="type">id</span> weakObj;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span>(<span class="title">Category</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="type">id</span> weakObj;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span> (<span class="title">Category</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)setWeakObj:(<span class="built_in">NSObject</span> *)obj &#123;</span><br><span class="line">    WeakTarget *target = [[WeakTarget alloc] init];</span><br><span class="line">    target.weakObj = obj;</span><br><span class="line"></span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(weakObj), target, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)weakObj &#123;</span><br><span class="line">    WeakTarget *target = objc_getAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(weakObj));</span><br><span class="line">    <span class="keyword">return</span> target.weakObj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">WeakTarget</span> @<span class="title">end</span></span></span><br></pre></td></tr></table></figure></li></ol><h3 id="ä¸ºä»€ä¹ˆåœ¨-block-ä¸­ä¸èƒ½ä½¿ç”¨-weak-æŒ‡é’ˆè®¿é—®å…¶æˆå‘˜å˜é‡ã€‚"><a href="#ä¸ºä»€ä¹ˆåœ¨-block-ä¸­ä¸èƒ½ä½¿ç”¨-weak-æŒ‡é’ˆè®¿é—®å…¶æˆå‘˜å˜é‡ã€‚" class="headerlink" title="ä¸ºä»€ä¹ˆåœ¨ block ä¸­ä¸èƒ½ä½¿ç”¨ weak æŒ‡é’ˆè®¿é—®å…¶æˆå‘˜å˜é‡ã€‚"></a>ä¸ºä»€ä¹ˆåœ¨ block ä¸­ä¸èƒ½ä½¿ç”¨ weak æŒ‡é’ˆè®¿é—®å…¶æˆå‘˜å˜é‡ã€‚</h3><p>è¿™æ˜¯æˆ‘åœ¨é¡¹ç›®ä¸­å®é™…é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">__<span class="keyword">weak</span> <span class="keyword">typeof</span>(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    </span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    weakSelf-&gt;_propertyName;<span class="comment">// ä½¿ç”¨ weak æŒ‡é’ˆç›´æ¥è®¿é—®æˆå‘˜å˜é‡ã€‚</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç æ— æ³•é€šè¿‡ç¼–è¯‘ï¼Œå¦‚æœæ”¹æˆè¿™æ ·å°±æ²¡é—®é¢˜äº†ï¼š<code>weakSelf.propertyName;</code>ã€‚</p><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨ objc é‡Œè®¿é—®å±æ€§æœ€ç»ˆè¿˜æ˜¯ä¼šè®¿é—®æˆå‘˜å˜é‡ã€‚é‚£ä¸ºä»€ä¹ˆè®¿é—®å±æ€§å°±æ­£å¸¸ï¼Œè®¿é—®æˆå‘˜å˜é‡å°±ä¼šæŠ¥é”™å‘¢ï¼Ÿ</p><p>ä¹‹æ‰€ä»¥ä¼šè¿™æ ·ï¼Œæ˜¯å› ä¸ºç°åœ¨çš„ç¼–è¯‘å™¨æ¯”è¾ƒæ™ºèƒ½ï¼Œè€ƒè™‘çš„æ¯”è¾ƒå¤šã€‚weakSelf åœ¨è¿è¡Œæ—¶æœ‰å¯èƒ½ä¸º nil ä»è€Œå¯¼è‡´å´©æºƒï¼Œç¼–è¯‘å™¨è®¤ä¸ºè¿™æ ·çš„ä»£ç ä¸å®‰å…¨æ‰€ä»¥æŠ¥é”™ã€‚ä½†æ˜¯ä½¿ç”¨ weakSelf è®¿é—®å±æ€§æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºè®¿é—®å±æ€§å®é™…ä¸Šæ˜¯è°ƒç”¨äº†å±æ€§çš„ get&#x2F;set æ–¹æ³•ï¼Œåœ¨ objc é‡Œå¯¹ nil è°ƒç”¨æ–¹æ³•æ˜¯ä¸ä¼šå¯¼è‡´å¼‚å¸¸ã€‚</p><p>ä¸Šé¢çš„æŠ¥é”™ä»£ç å¯ä»¥æ”¹æˆä»¥ä¸‹ä»£ç æ¥è§£å†³ç¼–è¯‘æŠ¥é”™ï¼š</p><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    <span class="keyword">if</span> (weakSelf) &#123;<span class="comment">// è¿™ä¸€æ­¥å¾ˆé‡è¦ï¼Œå› ä¸ºè¿™é‡Œçš„ weak æŒ‡é’ˆæœ‰å¯èƒ½å·²ç»æ˜¯ nil äº†ã€‚</span></span><br><span class="line">        __<span class="keyword">strong</span> <span class="keyword">typeof</span>(weakSelf) strongSelf = weakSelf;</span><br><span class="line">        strongSelf-&gt;_propertyName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="ä¸ºä»€ä¹ˆåœ¨å¯¹è±¡æ²¡æœ‰å¼±å¼•ç”¨æ—¶ä¹Ÿä¼šæ‰§è¡Œ-weak-clear-no-lock"><a href="#ä¸ºä»€ä¹ˆåœ¨å¯¹è±¡æ²¡æœ‰å¼±å¼•ç”¨æ—¶ä¹Ÿä¼šæ‰§è¡Œ-weak-clear-no-lock" class="headerlink" title="ä¸ºä»€ä¹ˆåœ¨å¯¹è±¡æ²¡æœ‰å¼±å¼•ç”¨æ—¶ä¹Ÿä¼šæ‰§è¡Œ weak_clear_no_lock"></a>ä¸ºä»€ä¹ˆåœ¨å¯¹è±¡æ²¡æœ‰å¼±å¼•ç”¨æ—¶ä¹Ÿä¼šæ‰§è¡Œ weak_clear_no_lock</h3><p>åœ¨ç ”ç©¶ weak æŒ‡é’ˆè‡ªåŠ¨èµ‹å€¼ nil çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç°ï¼Œå¯¹è±¡åªè¦æ›¾ç»è¢« weak æŒ‡é’ˆæŒ‡å‘è¿‡ï¼Œåœ¨å¯¹è±¡é‡Šæ”¾çš„æ—¶å€™å³ä½¿æ²¡æœ‰æŒ‡å‘å®ƒçš„ weak æŒ‡é’ˆï¼Œä¹Ÿä¼šæ‰§è¡Œåˆ° weak_clear_no_lock å‡½æ•°ã€‚</p><p>åœ¨ storeWeak å‡½æ•°ä¸­ä¼šè°ƒç”¨è¿™è¡Œä»£ç è®¾ç½®å¯¹è±¡è¢« weak æŒ‡é’ˆæŒ‡å‘çš„æ ‡è®°ï¼š<code>newObj-&gt;setWeaklyReferenced_nolock();</code>ã€‚</p><p>ä½†æ˜¯ï¼Œå½“å¯¹è±¡æ²¡æœ‰ä»»ä½• weak æŒ‡é’ˆæŒ‡å‘æ—¶ï¼Œweak_unregister_no_lock å‡½æ•°ä¸­å¹¶æ²¡æœ‰è°ƒç”¨ç›¸å…³å‡½æ•°å°†æ ‡è®°è®¾ç½®ä¸º falseã€‚</p><p>è¿™ä¼šå¯¼è‡´åœ¨å¯¹è±¡é‡Šæ”¾çš„æ—¶å€™ï¼Œå³è°ƒç”¨åˆ° rootDealloc å‡½æ•°æ—¶æ— æ³•æ‰§è¡Œå¿«é€Ÿé‡Šæ”¾é€»è¾‘ã€‚</p><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">objc_object::rootDealloc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isTaggedPointer</span>()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fastpath</span>(<span class="built_in">isa</span>().nonpointer                     &amp;&amp;</span><br><span class="line">    <span class="comment">// å¦‚æœå¯¹è±¡æ›¾ç»è¢« weak æŒ‡é’ˆæŒ‡å‘è¿‡ï¼Œå³ä½¿ç°åœ¨æ²¡æœ‰äº†ï¼Œweakly_referenced ä¹Ÿæ˜¯ trueã€‚</span></span><br><span class="line">                 !<span class="built_in">isa</span>().weakly_referenced             &amp;&amp;</span><br><span class="line">                 !<span class="built_in">isa</span>().has_assoc                     &amp;&amp;</span><br><span class="line">                 !<span class="built_in">isa</span>().<span class="built_in">getClass</span>(<span class="literal">false</span>)-&gt;<span class="built_in">hasCxxDtor</span>() &amp;&amp;</span><br><span class="line">                 !<span class="built_in">isa</span>().has_sidetable_rc)) &#123;</span><br><span class="line">        <span class="built_in">free</span>(<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">object_dispose</span>((id)<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä¹Ÿä¸å¤ªæ¸…æ¥šä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼Ÿå¦‚æœä½ çŸ¥é“å…¶ä¸­çš„å…·ä½“ç»†èŠ‚çš„è¯ï¼Œè¿˜è¯·ç•™è¨€å‘ŠçŸ¥ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ObjC </tag>
            
            <tag> Runtime </tag>
            
            <tag> ARC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ…ç”¨unsignedç±»å‹</title>
      <link href="/2022/07/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%85%8E%E7%94%A8unsigned%E7%B1%BB%E5%9E%8B/"/>
      <url>/2022/07/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%85%8E%E7%94%A8unsigned%E7%B1%BB%E5%9E%8B/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç”± å¸ƒå¤š(budo) å‘å¸ƒäº 2022-07-22</p></blockquote><p>è¿™ç¯‡æ–‡ç« æˆ‘ä¼šä»è®¡ç®—æœºåŸºç¡€çš„è§’åº¦å‘å¤§å®¶è§£é‡Š unsigned ç±»å‹ å’Œ signed ç±»å‹åœ¨å†…å­˜ä¸­åˆ°åº•æ˜¯å¦‚ä½•å­˜å‚¨çš„ï¼Œä»¥åŠä¸ºä»€ä¹ˆè¦æ…ç”¨ unsigned ç±»å‹ã€‚</p><blockquote><p>æˆ‘æ˜¯ç«™åœ¨ iOS å¼€å‘è§’åº¦å†™çš„è¿™ç¯‡æ–‡ç« ï¼Œæ‰€ä»¥ä¼šå‡ºç°ä¸€äº›OCä»£ç ï¼Œå¦‚æœä½ çœ‹ä¸æ‡‚çš„è¯å¯ä»¥è·³è¿‡è¿™äº›éƒ¨åˆ†ã€‚</p></blockquote><p>åœ¨OCä¸­æˆ‘ä»¬ä¸€èˆ¬ä¼šä½¿ç”¨ <strong>NSUInteger</strong> è€Œé <strong>unsigned</strong> è¡¨ç¤ºæ— ç¬¦å·æ•´æ•°ï¼Œä½†å…¶å®å®ƒä»¬æ˜¯ä¸€æ ·çš„ï¼ŒNSUInteger åªæ˜¯ unsigned çš„ç±»å‹åˆ«åè€Œå·²ï¼›NSObjCRuntime.h æ–‡ä»¶ä¸­æœ‰å…³äº NSUInteger çš„è¯¦ç»†å®šä¹‰ã€‚</p><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> __LP64__ || TARGET_OS_WIN32 || NS_BUILD_32_LIKE_64</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="built_in">NSUInteger</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="built_in">NSUInteger</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><h2 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h2><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="type">void</span>)reversePrintObjectWithArray:(<span class="built_in">NSArray</span> *)array &#123;</span><br><span class="line">    <span class="keyword">if</span> (![array isKindOfClass:<span class="built_in">NSArray</span>.class]) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = array.count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;ç¬¬%luä¸ªå…ƒç´ : %@&quot;</span>, i, array[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ªæ–¹æ³•åªæ˜¯ç®€å•çš„å€’åºæ‰“å°æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œè€Œä¸”åœ¨æ‰“å°å‰ä¹Ÿåšäº†ç±»å‹æ£€æŸ¥å’Œåˆ¤ç©ºæ“ä½œã€‚ä½†æ˜¯å®ƒè¿˜æ˜¯æœ‰é—®é¢˜ï¼Œä½ èƒ½çœ‹å‡ºæ¥å—ï¼Ÿ</p><p>å½“ä½ ä¼ é€’çš„å‚æ•°æ˜¯ nilã€é NSArray ç±»å‹ï¼Œæˆ–è€…éç©ºæ•°ç»„æ—¶ï¼Œä¸€åˆ‡éƒ½æ­£å¸¸ï¼›ä½†å¦‚æœä½ ä¸å°å¿ƒä¼ é€’äº†ä¸€ä¸ªç©ºæ•°ç»„ï¼Œå°†ä¼šå¯¼è‡´å´©æºƒï¼Œå´©æºƒåŸå› æ˜¯æ•°ç»„è®¿é—®è¶Šç•Œï¼Œè¶Šç•Œçš„ç´¢å¼•æ˜¯ 18446744073709551615(<code>å¦‚æœåœ¨32ä½ç¯å¢ƒä¸‹ï¼Œä¼šæ˜¯4294967295</code>)ã€‚ä½ ä¹Ÿå¯ä»¥æŠŠè¿™æ®µä»£ç ç²˜è´´åˆ°ä½ çš„é¡¹ç›®ä¸­ï¼Œæµ‹è¯•ä¸€ä¸‹çœ‹çœ‹ç»“æœæ˜¯å¦å’Œæˆ‘è¯´çš„ä¸€æ ·ã€‚</p><p>ï¼Ÿï¼Ÿï¼Ÿæ˜¯ä¸æ˜¯è§‰å¾—æ¡ä»¶éƒ½ä¸ç¬¦åˆï¼Œå¾ªç¯åº”è¯¥ä¸€æ¬¡éƒ½æ²¡æ‰§è¡Œï¼Œè¿˜æœ‰ 18446744073709551615 æ˜¯å“ªæ¥çš„ï¼Ÿ</p><p>å…¶å®é€ æˆè¿™ä¸€åˆ‡çš„æ ¹æºåœ¨äº __è®¡ç®—æœºå¯¹äºæ­£æ•°å’Œè´Ÿæ•°çš„è¯»å†™æ–¹å¼ä¸ä¸€æ ·__ã€‚</p><hr><p>ä¸‹é¢æˆ‘å°†ç”¨Cä»£ç æ¥å¸®åŠ©å¤§å®¶ç†è§£ _è®¡ç®—æœºæ˜¯å¦‚ä½•è¯»å†™æ­£æ•°å’Œè´Ÿæ•°_ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">short</span> a = <span class="number">-18</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span> b = <span class="number">65518</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;a: %hd, %hu\n&quot;</span>, a, a);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;b: %hd, %hu\n&quot;</span>, b, b);</span><br></pre></td></tr></table></figure><p><img src="2022_07_20_16.37.50.png" alt="è¿è¡Œç»“æœ"></p><p>è®¡ç®—æœºè§„å®šæ•´æ•°å¿…é¡»ä»¥è¡¥ç å½¢å¼è¿›è¡Œå­˜å‚¨ï¼Œå¦‚æœä½ æƒ³å¼„æ˜ç™½ä¸ºä»€ä¹ˆï¼Œè¯·é˜…è¯»<a href="#jump1">é¢˜å¤–è¯(ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¡¥ç )</a>ã€‚</p><blockquote><p>æ³¨æ„ï¼šåªæœ‰è´Ÿæ•°éœ€è¦è®¡ç®—è¡¥ç ï¼Œæ­£æ•°çš„åç ã€è¡¥ç å…¶å®å’ŒåŸç ä¸€æ ·ã€‚</p></blockquote><p>å˜é‡açš„è¡¥ç è®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-18</span><br><span class="line">= 10010(18çš„äºŒè¿›åˆ¶)</span><br><span class="line">= 0000 0000 0001 0010(short ç±»å‹å ç”¨ 2 * 8 = 16 ä¸ªæ¯”ç‰¹ä½ï¼Œæ‰€ä»¥å‰é¢éœ€è¦è¡¥0)</span><br><span class="line">= 1000 0000 0001 0010(è®¡ç®—æœºè§„å®šï¼Œæœ‰ç¬¦å·æ•°çš„ç¬¬1ä¸ªæ¯”ç‰¹ä½ç”¨äºå­˜å‚¨ç¬¦å·ä½ï¼Œ1è¡¨ç¤ºè´Ÿ</span><br><span class="line">æ•°ï¼Œ0è¡¨ç¤ºæ­£æ•°ï¼›è¿™å°±æ˜¯-18çš„åŸç )</span><br><span class="line">= 1111 1111 1110 1101(è¿™æ˜¯-18çš„åç ï¼Œåç å°±æ˜¯æŠŠé™¤ç¬¦å·ä½ä¹‹å¤–çš„æ‰€æœ‰æ•°æ®å–å)</span><br><span class="line">= 1111 1111 1110 1110(è¿™æ˜¯-18çš„è¡¥ç ï¼Œè¡¥ç æ˜¯åœ¨åç çš„åŸºç¡€ä¸ŠåŠ 1)</span><br></pre></td></tr></table></figure><p>å˜é‡aå®é™…å­˜å‚¨åœ¨å†…å­˜ä¸­çš„æ•°æ®ä¸æ˜¯åŸç  <code>1000 0000 0001 0010</code> è€Œæ˜¯è¡¥ç  <code>1111 1111 1110 1110</code>ï¼›åœ¨ä½¿ç”¨ <code>%hd</code> æ‰“å°çš„æ—¶å€™ï¼Œè®¡ç®—æœºä¼šæŠŠå†…å­˜ä¸­çš„æ•°æ®å½“ä½œè¡¥ç å¤„ç†ï¼Œæ‰€ä»¥éœ€è¦å…ˆå°†å®ƒè¿˜åŸæˆåŸç  <code>1000 0000 0001 0010</code>ï¼Œç„¶åæŠŠåŸç è½¬ä¸ºåè¿›åˆ¶ï¼Œæ‰€ä»¥è¾“å‡ºçš„æ˜¯ -18ã€‚</p><p>å½“ä½ ä½¿ç”¨ <code>%hu</code> å»æ‰“å°å˜é‡açš„æ—¶å€™ï¼Œè®¡ç®—æœºä¼šæŠŠè¿™å—å†…å­˜çš„æ•°æ®è§£é‡Šä¸ºæ­£æ•°ï¼Œè¿˜è®°å¾—ä¹‹å‰æåˆ°çš„æ­£æ•°çš„è¡¥ç å’ŒåŸç ä¸€æ ·å—ï¼Œè®¡ç®—æœºä¼šæŠŠå†…å­˜ä¸­çš„æ•°æ®ç›´æ¥å½“ä½œåŸç å¤„ç†ï¼Œ <code>1111 1111 1110 1110</code> è½¬ä¸ºåè¿›åˆ¶æ­£å¥½å°±æ˜¯ 65518 ã€‚</p><p>çœ‹å®Œå˜é‡açš„è®²è§£åï¼Œä½ æ˜¯å¦èƒ½æ‰‹åŠ¨éªŒè¯å˜é‡bçš„ç»“æœå‘¢ï¼Ÿ</p><p>å˜é‡bçš„åŸç æ˜¯ <code>1111 1111 1110 1110</code>ï¼Œç”±äºå®ƒæ˜¯æ­£æ•°ï¼Œæ‰€ä»¥è¡¥ç å°±ç­‰äºåŸç ï¼›åœ¨ä½¿ç”¨ <code>%hu</code> æ‰“å°çš„æ—¶å€™ï¼Œè®¡ç®—æœºä¼šæŠŠå†…å­˜ä¸­çš„æ•°æ®ç›´æ¥å½“æˆåŸç å¤„ç†ï¼Œæ‰€ä»¥ä¼šè¾“å‡º 65518ã€‚</p><p>å¦‚æœä½¿ç”¨ <code>%hd</code> æ‰“å°çš„è¯ï¼Œè®¡ç®—æœºä¼šæŠŠå†…å­˜ä¸­çš„æ•°æ®å½“åšè¡¥ç ï¼Œè¡¥ç è½¬ä¸ºåŸç æ˜¯ <code>1000 0000 0001 0010</code>ï¼Œå‘ç°äº†å—ï¼Œè¿™ä¸å°±æ˜¯ -18 çš„åŸç å—ã€‚</p><blockquote><p>å‘ç°äº†å—ï¼Œ65518 çš„è¡¥ç &#x2F;åŸç æ­£å¥½å’Œ -18 çš„è¡¥ç ä¸€æ ·(<code>ç®€å•çš„è¯´ï¼Œåœ¨å†…å­˜ä¸­ 65518 å’Œ -18 çš„æ•°æ®æ˜¯ä¸€æ ·çš„</code>)ï¼›æœ‰æ—¶å€™ç°å®ä¸­2ä¸ªå®Œå…¨ä¸åŒçš„æ•°å¯èƒ½åœ¨å†…å­˜ä¸­çš„è¡¨ç°ä¼šä¸€æ¨¡ä¸€æ ·ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¤§éƒ¨åˆ†æƒ…å†µä¸‹äºŒè¿›åˆ¶æ— æ³•è¿˜åŸå›é«˜çº§è¯­è¨€çš„åŸå› ã€‚</p></blockquote><blockquote><p>ä»¥å˜é‡aä¸ºä¾‹ï¼Œä¸ç®¡å®ƒçš„ç±»å‹æ˜¯ <code>short</code> è¿˜æ˜¯ <code>unsigned short</code>ï¼Œéƒ½ä¸ä¼šå½±å“ -18 è¿™ä¸ªå€¼åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼ï¼Œåœ¨è¯»å–å˜é‡açš„å€¼æ—¶ï¼Œè®¡ç®—æœºé¦–å…ˆæ‰¾åˆ°å˜é‡açš„åœ°å€ï¼Œç„¶åæ ¹æ®ç±»å‹å¾—åˆ°å®ƒçš„é•¿åº¦ï¼Œshort çš„é•¿åº¦æ˜¯ 2 * 8 &#x3D; 16 ä¸ªæ¯”ç‰¹ä½ï¼Œä»å˜é‡açš„åœ°å€å¼€å§‹ï¼Œå¾€å16ä¸ªæ¯”ç‰¹ä½å°±æ˜¯å˜é‡aåœ¨å†…å­˜ä¸­å­˜å‚¨çš„æ•°æ®ï¼Œä½¿ç”¨ä¸åŒçš„ç¬¦å·æ‰“å°(%huã€%hd)ä¼šå½±å“è®¡ç®—æœºå¯¹è¿™å—å†…å­˜çš„è§£é‡Šï¼Œä½†ä¸ä¼šå½±å“å†…å­˜ä¸­çš„æ•°æ®ã€‚</p></blockquote><hr><p>å›åˆ°å¼€å¤´é‚£ä¸ªæ•°ç»„è¶Šç•Œçš„é—®é¢˜ï¼Œ18446744073709551615 å…¶å®å°±æ˜¯æŠŠ -1 å½“ä½œæ— ç¬¦å·æ•°è¯»å–è€Œæ¥çš„ã€‚</p><p>ç”±äº <code>NSUInteger</code> å®é™…æ˜¯ long ç±»å‹ï¼Œå ç”¨ <code>8 * 8 = 64</code> ä¸ªæ¯”ç‰¹ä½ï¼Œ-1 çš„åŸç æ˜¯ <code>1000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0001</code>ï¼Œè¡¥ç æ˜¯ <code>1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111 1111</code>ï¼Œç”±äº <code>NSUInteger</code> æ˜¯æ— ç¬¦å·æ•°ï¼Œæ‰€ä»¥è®¡ç®—æœºä¼šæŠŠè¡¥ç å½“æˆåŸç ä½¿ç”¨ï¼Œè½¬ä¸ºåè¿›åˆ¶æ­£å¥½å°±æ˜¯ 18446744073709551615 ã€‚</p><p>è§£å†³èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼ŒæŠŠ <code>NSUInteger</code> ç”¨ <code>NSInteger</code> ä»£æ›¿å°±è¡Œäº†ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åœ¨é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œé™¤äº†è¿”å›å€¼ã€å‚æ•°ç­‰ç‰¹æ®Šåœ°æ–¹ï¼Œå»ºè®®ç»Ÿä¸€ä½¿ç”¨æœ‰ç¬¦å·æ•°(<code>NSInteger</code>)ä»£æ›¿æ— ç¬¦å·æ•°(<code>NSUInteger</code>)ï¼Œè¿™æœ‰å¦‚ä¸‹å¥½å¤„ï¼š</p><ol><li>æé«˜ä»£ç çš„ç»Ÿä¸€æ€§å’Œå…¼å®¹æ€§ã€‚</li><li>é¿å…ä¸åŒæ•°å­—ç±»å‹ä¹‹é—´çš„è½¬æ¢é—®é¢˜ï¼Œå‡å°‘ä»£ç å¤æ‚åº¦ï¼Œé™ä½ä»£ç BUGç‡ã€‚</li></ol><p>å¦‚æœå¿…é¡»è¦ä½¿ç”¨æ— ç¬¦å·æ•°ï¼Œä¾‹å¦‚è¿”å›å€¼ã€å‚æ•°ç­‰ï¼Œåˆ‡è®°ä¸€å®šè¦åœ¨ä½¿ç”¨å‰æ£€æŸ¥æ•°æ®æ­£ç¡®æ€§ï¼Œä¾‹å¦‚ä½¿ç”¨å¼ºè½¬åˆ¤æ–­å€¼æ˜¯å¦æ­£ç¡®ã€‚</p><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ— ç¬¦å·æ•°ä½œä¸ºæ–¹æ³•å‚æ•°</span></span><br><span class="line">- (<span class="type">void</span>)fun:(<span class="built_in">NSUInteger</span>)index &#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="built_in">NSInteger</span>)index &lt; <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ— ç¬¦å·æ•°ä½œä¸ºè¿”å›å€¼</span></span><br><span class="line"><span class="built_in">NSInteger</span> _count;</span><br><span class="line">- (<span class="built_in">NSUInteger</span>)count &#123;</span><br><span class="line">    <span class="keyword">return</span> _count &lt; <span class="number">0</span> ? <span class="number">0</span> : (<span class="built_in">NSUInteger</span>)_count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åƒæ–‡ç« ä¸­çš„è¿™ç§é—®é¢˜å±äºæ•°æ®å¼‚å¸¸ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹æ•°æ®å¼‚å¸¸è¿œæ¯”å´©æºƒè¿˜è¦ä¸¥é‡ã€‚</p><p>æ•°æ®å¼‚å¸¸å¯èƒ½ä¼šç»™ç”¨æˆ·æˆ–å…¬å¸å¸¦æ¥å·¨å¤§æŸå¤±ï¼›å‡è®¾ä½ å¼€å‘ä¸€ä¸ªè®¡ç®—å™¨è½¯ä»¶ï¼ŒæŠŠå€¼ç®—é”™äº†å¤§æ¦‚ç‡ä¼šå¯¼è‡´éå¸¸ä¸¥é‡çš„åæœå’ŒæŸå¤±ï¼Œå¦‚æœè®©ç¨‹åºå´©æºƒæˆ–æ­»æœºï¼Œè‡³å°‘å®¢æˆ·ä¼šé€‰æ‹©å…¶ä»–è®¡ç®—å™¨æˆ–è®¡ç®—æ–¹å¼è€Œä¸ä¼šé€ æˆåé¢æ›´ä¸¥é‡çš„æŸå¤±ã€‚</p><p>å¦å¤–æ•°æ®å¼‚å¸¸è¿™ç§é—®é¢˜é€šå¸¸å¾ˆéš¾å‘ç°ï¼Œå¾ˆå®¹æ˜“æˆä¸ºçº¿ä¸ŠBUGå¯¼è‡´ç³Ÿç³•çš„ç”¨æˆ·ä½“éªŒ(<code>å»ºè®®å¤§å®¶å¹³å¸¸ä½¿ç”¨å•å…ƒæµ‹è¯•æ¥å¯¹ä»£ç è¿›è¡Œå®šæœŸä½“æ£€ï¼Œè¿™æ ·èƒ½å¤§å¤§é™ä½ç±»ä¼¼çš„è¿™ç§é”™è¯¯</code>)ã€‚</p><p>åœ¨Swiftä¸­ï¼Œå¦‚æœä½ å¯¹ä¸€ä¸ªæ— ç¬¦å·ç±»å‹(<code>UInt</code>)å˜é‡ä¸å°å¿ƒèµ‹å€¼äº†è´Ÿæ•°çš„è¯ï¼Œå°†ä¼šå¾—åˆ°ä¸€ä¸ªè¿è¡Œæ—¶å´©æºƒï¼Œè¯´æ˜æ•°æ®å¼‚å¸¸ç¡®å®æ¯”APPå´©æºƒæ›´ä¸¥é‡ã€‚</p><h2 id="é¢˜å¤–è¯-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¡¥ç "><a href="#é¢˜å¤–è¯-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¡¥ç " class="headerlink" title="é¢˜å¤–è¯(ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¡¥ç )"></a><span id = "jump1">é¢˜å¤–è¯(ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¡¥ç )</span></h2><p>ç”±äºåŠ æ³•å’Œå‡æ³•è¿™ç§æ“ä½œéå¸¸é¢‘ç¹ï¼Œä¸ºäº†æé«˜è¿ç®—æ•ˆç‡ï¼Œæ‰€ä»¥å®ƒä»¬ä¸€èˆ¬éƒ½ç”±ç¡¬ä»¶ç›´æ¥æ”¯æŒï¼›å¦‚æœç›´æ¥ä½¿ç”¨åŸç å­˜å‚¨çš„è¯ï¼Œåœ¨è®¡ç®—ç±»ä¼¼ <code>6 - 18</code> è¿™æ ·çš„è¡¨è¾¾å¼æ—¶å°†ä¼šå¾—åˆ°é”™è¯¯çš„ç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">6 - 18 = 6 + (-18)</span><br><span class="line">= 0000 0000 0000 0110(åŸ) + 1000 0000 0001 0010(åŸ)</span><br><span class="line">= 1000 0000 0001 1000(åŸ)</span><br><span class="line">= -24</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾è®¡ç®—ç»“æœæ˜¯ä¸å¯¹çš„ï¼Œäºæ˜¯æœ‰äº›äººè®¾è®¡å‡ºäº†åç ï¼Œç”¨åç è®¡ç®—ç¡®å®è§£å†³äº† <code>6 - 18</code> çš„é—®é¢˜ï¼Œä½†æ˜¯ç±»ä¼¼ <code>18 - 6</code> è¿™æ ·çš„è®¡ç®—åˆå‡ºé”™äº†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">18 - 6 = 18 + (-6)</span><br><span class="line">= 0000 0000 0001 0010(åŸ) + 0000 0000 0000 0110(åŸ)</span><br><span class="line">= 0000 0000 0001 0010(å) + 1111 1111 1111 1001(å)</span><br><span class="line">= 1 0000 0000 0000 1011(å) </span><br><span class="line">= 0000 0000 0000 1011(å) // æœ€å·¦è¾¹çš„1å†…å­˜å®¹çº³ä¸äº†ï¼Œæ‰€ä»¥ç›´æ¥æˆªæ‰ã€‚</span><br><span class="line">= 0000 0000 0000 1011(åŸ)</span><br><span class="line">= 11</span><br></pre></td></tr></table></figure><p>è®¡ç®—ç»“æœç¦»æ­£ç¡®å€¼è¿˜å·®1ï¼Œ__å¦‚æœæŒ‰ç…§åç è®¡ç®—çš„è¯ï¼Œå°æ•°å‡å»å¤§æ•°ä¼šæ­£ç¡®ï¼Œä½†å¤§æ•°å‡å»å°æ•°å°±å§‹ç»ˆä¼šç›¸å·®1__ï¼Œè¿˜æ˜¯é‚£ç¾¤äººï¼Œåˆç»å°½è„‘æ±çš„è®¾è®¡å‡ºäº†è¡¥ç (<code>è¯¥è®¾è®¡è€…å› æ­¤è·å¾—äº†å›¾çµå¥–</code>)ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">18 - 6 = 18 + (-6)</span><br><span class="line">= 0000 0000 0001 0010(åŸ) + 0000 0000 0000 0110(åŸ)</span><br><span class="line">= 0000 0000 0001 0010(å) + 1111 1111 1111 1001(å)</span><br><span class="line">= 0000 0000 0001 0010(è¡¥) + 1111 1111 1111 1010(è¡¥)</span><br><span class="line">= 1 0000 0000 0000 1100(è¡¥)</span><br><span class="line">= 0000 0000 0000 1100(è¡¥) // æœ€å·¦è¾¹çš„1å†…å­˜å®¹çº³ä¸äº†ï¼Œæ‰€ä»¥ç›´æ¥æˆªæ‰ã€‚</span><br><span class="line">= 0000 0000 0000 1100(å)</span><br><span class="line">= 0000 0000 0000 1100(åŸ)</span><br><span class="line">= 12</span><br></pre></td></tr></table></figure><p>ç»“æœç»ˆäºæ­£ç¡®äº†ï¼Œå¦‚æœå¤§å®¶æ„Ÿå…´è¶£çš„è¯å¯ä»¥æ‰‹åŠ¨è®¡ç®—ä¸€ä¸‹ <code>13 - 5</code>ã€<code>5 - 13</code> ç­‰ç­‰æ¥å·©å›ºä½ å­¦åˆ°çš„çŸ¥è¯†ã€‚</p><blockquote><p>è®¡ç®—æœºçš„è®¾è®¡æ˜¯ä¸€é—¨è‰ºæœ¯ï¼Œå¾ˆå¤šå®ç”¨çš„æŠ€æœ¯éƒ½æ˜¯æƒè¡¡å’Œå¦¥åçš„ç»“æœã€‚</p></blockquote><p>å¦‚æœä½ è¿˜æ˜¯ä¸ç†è§£çš„è¯ï¼Œå»ºè®®ä½ çœ‹çœ‹ <a href="http://c.biancheng.net/view/vip_1761.html">æ•´æ•°åœ¨å†…å­˜ä¸­æ˜¯å¦‚ä½•å­˜å‚¨çš„ï¼Œä¸ºä»€ä¹ˆå®ƒå ªç§°å¤©æ‰èˆ¬çš„è®¾è®¡</a>(<code>è¿™æ˜¯ä¸€ç¯‡ä»˜è´¹æ–‡ç« ï¼Œå¦‚æœä½ ä¸æƒ³ä»˜è´¹çš„è¯è¯·è‡ªè¡Œç™¾åº¦æœç´¢å…³é”®å­—</code>)ã€‚</p><h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><p>ä¸è¦æŠŠæ— ç¬¦å·æ•°ã€æœ‰ç¬¦å·æ•°å’Œæ­£æ•°ã€è´Ÿæ•°ææ··ï¼Œæ— ç¬¦å·æ•°è‚¯å®šæ˜¯æ­£æ•°ï¼Œä½†æœ‰ç¬¦å·æ•°æœªå¿…æ˜¯è´Ÿæ•°ã€‚</p><p>è®¡ç®—æœºæ˜¯å¯¹æ­£æ•°å’Œè´Ÿæ•°çš„è¯»å†™è§„åˆ™ä¸ä¸€æ ·ï¼Œä¸æ˜¯å¯¹æ— ç¬¦å·æ•°å’Œæœ‰ç¬¦å·æ•°çš„è¯»å†™è§„åˆ™ä¸ä¸€æ ·ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> è®¡ç®—æœºåŸºç¡€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Code Reviewè§„èŒƒ</title>
      <link href="/2022/01/20/%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83/Code%20Reivew%E8%A7%84%E8%8C%83/"/>
      <url>/2022/01/20/%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83/Code%20Reivew%E8%A7%84%E8%8C%83/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç”± å¸ƒå¤š(budo) å‘å¸ƒäº 2022-01-20</p></blockquote><blockquote><p>æœ¬æ–‡çš„åè¯è§£é‡Šï¼š</p><ul><li>CRï¼šcode review</li><li>CLï¼šchange list(æŒ‡è¿™æ¬¡æ”¹åŠ¨)</li></ul></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™ç¯‡æ–‡ç« æ˜¯ç«™åœ¨å…¬å¸çš„è§’åº¦åŸºäº Googleçš„ä»£ç å®¡æŸ¥æŒ‡å— å’Œç¬”è€…å®é™…ç»éªŒçš„ä¸ªäººæ€»ç»“ï¼Œæ‰€ä»¥ç›¸å¯¹åŸæ–‡(Googleçš„ä»£ç å®¡æŸ¥æŒ‡å—)æœ‰é€‚å½“çš„åˆ å‡ï¼Œæƒ³çœ‹å®Œæ•´ç‰ˆçš„è¯·é˜…è¯»<a href="https://google.github.io/eng-practices/review/reviewer/">Googleçš„ä»£ç å®¡æŸ¥æŒ‡å—</a>ã€‚</p><p>è¯¥è§„èŒƒçš„ç›®çš„æ—¨åœ¨æé«˜å…¬å¸å†…éƒ¨é¡¹ç›®çš„ä»£ç åº“è´¨é‡ã€‚</p><h2 id="åŸåˆ™"><a href="#åŸåˆ™" class="headerlink" title="åŸåˆ™"></a>åŸåˆ™</h2><ol><li><p>æŠ€æœ¯äº‹å®å’Œæ•°æ®åº”è¯¥å‡Œé©¾äºæ„è§å’Œä¸ªäººåå¥½ä¹‹ä¸Šï¼›åœ¨ä»£ç é£æ ¼æ–¹é¢ï¼Œé£æ ¼æŒ‡å—æ˜¯ç»å¯¹æƒå¨ï¼Œä»»ä½•ä¸åœ¨æŒ‡å—ä¸­çš„ç‚¹(å¦‚ç©ºæ ¼ç­‰)éƒ½æ˜¯ä¸ªäººåå¥½çš„é—®é¢˜ï¼Œè¿™äº›ç‚¹åŸåˆ™ä¸Šåº”è¯¥ä¸ç°æœ‰çš„é£æ ¼ä¿æŒä¸€è‡´ï¼Œä½†æ˜¯å¦‚æœè¿™äº›ç‚¹ç°åœ¨è¿˜æ²¡æœ‰å½¢æˆä¸€å®šçš„é£æ ¼ï¼Œé‚£ä¹ˆåº”è¯¥æ¥å—ä½œè€…çš„é£æ ¼ã€‚</p></li><li><p>è½¯ä»¶è®¾è®¡çš„å„ä¸ªæ–¹é¢å‡ ä¹ä»æ¥ä¸æ˜¯çº¯ç²¹çš„é£æ ¼é—®é¢˜ï¼Œä¹Ÿä¸åªæ˜¯ä¸ªäººåå¥½ï¼Œå®ƒä»¬æ˜¯å»ºç«‹åœ¨åŸºæœ¬åŸåˆ™çš„åŸºç¡€ä¸Šçš„ï¼Œåº”è¯¥åœ¨è¿™äº›åŸåˆ™çš„åŸºç¡€ä¸ŠåŠ ä»¥è¡¡é‡ï¼Œè€Œä¸ä»…ä»…æ˜¯åªè€ƒè™‘ä¸ªäººæ„è§ã€‚æœ‰æ—¶ï¼Œå¦‚æœä½œè€…èƒ½å¤Ÿè¯æ˜(é€šè¿‡æ•°æ®æˆ–åŸºäºå¯é çš„å·¥ç¨‹åŸç†)å®ƒçš„æ–¹æ³•æ˜¯åŒæ ·æœ‰æ•ˆçš„ï¼Œé‚£ä¹ˆå®¡æŸ¥è€…åº”è¯¥æ¥å—ä½œè€…çš„åå¥½ã€‚å¦åˆ™ï¼Œå®¡æŸ¥è€…çš„é€‰æ‹©åº”è¯¥å–å†³äºè½¯ä»¶è®¾è®¡çš„æ ‡å‡†åŸåˆ™ã€‚</p></li></ol><h3 id="CRçš„æ ‡å‡†"><a href="#CRçš„æ ‡å‡†" class="headerlink" title="CRçš„æ ‡å‡†"></a>CRçš„æ ‡å‡†</h3><ol><li><p>Code Reivewçš„ä¸»è¦ç›®çš„æ˜¯ç¡®ä¿ä»£ç åº“çš„ <strong>æ•´ä½“ä»£ç </strong> è¿è¡ŒçŠ¶å†µéšç€ <strong>æ—¶é—´çš„æ¨ç§»</strong> è€Œ <strong>å¾—åˆ°æ”¹å–„</strong>ï¼ŒCode Reviewçš„æ‰€æœ‰å·¥å…·å’Œæµç¨‹éƒ½ä¸ºæ­¤è€Œè®¾è®¡ã€‚</p></li><li><p>ä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼Œå¿…é¡» <strong>ç»¼åˆè€ƒè™‘è®¸å¤šå› ç´ </strong>ï¼Œå¹¶ä¸”åšå‡º <strong>å–èˆå’Œå¹³è¡¡</strong>ã€‚</p></li><li><p>å®¡æŸ¥è€…æœ‰è´£ä»»ç¡®ä¿æ¯ä¸ªCLéƒ½å…·æœ‰è¿™æ ·çš„è´¨é‡ï¼šå³éšç€æ—¶é—´çš„æ¨ç§»ï¼Œä»£ç åº“çš„æ•´ä½“ä»£ç å¥åº·çŠ¶å†µä¸ä¼šé™ä½ã€‚è¿™å¯èƒ½ä¼šå¾ˆæ£˜æ‰‹ï¼Œç‰¹åˆ«æ˜¯å½“å›¢é˜Ÿçš„äº¤ä»˜å—åˆ°ä¸¥é‡çš„æ—¶é—´é™åˆ¶å¹¶ä¸”ä»–ä»¬è§‰å¾—å¿…é¡»é‡‡å–æ·å¾„æ‰èƒ½å®ç°ç›®æ ‡æ—¶ã€‚</p></li><li><p>æ²¡æœ‰ <strong>å®Œç¾</strong> çš„ä»£ç ï¼Œåªæœ‰ <strong>æ›´å¥½çš„ä»£ç </strong>ï¼Œå®¡æŸ¥è€…åº”è¯¥æƒè¡¡å‘å±•çš„éœ€è¦å’Œåˆ«äººçš„å»ºè®®ï¼›ä¸åº”è¯¥è¿½æ±‚å®Œç¾ï¼Œè€Œåº”è¿½æ±‚æŒç»­æ”¹è¿›ï¼Œä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œå¦‚æœCLèƒ½æé«˜æ•´ä¸ªç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§ã€å¯è¯»æ€§ã€å¯ç†è§£æ€§ï¼Œé‚£ä¹ˆä¸åº”è¯¥å› ä¸ºå®ƒä¸ â€œå®Œç¾â€ è€Œæ‹’ç»ã€‚</p></li><li><p>å¦‚æœå¼€å‘äººå‘˜æœ‰äº›åœ°æ–¹åšçš„å¾ˆå¥½ï¼Œåº”è¯¥å‘Šè¯‰å¹¶é¼“åŠ±å¼€å‘äººå‘˜ï¼Œä½†æ˜¯å¦‚æœè¿™ä¸ªæ”¹è¿›ä¸æ˜¯å¾ˆé‡è¦ï¼Œå¯ä»¥å‘Šè¯‰ä½œè€…è¿™ç§æ”¹è¿›åªæ˜¯ä¸€ç§é”¦ä¸Šæ·»èŠ±çš„æ•ˆæœï¼Œä½œè€…å¯ä»¥é€‰æ‹©å¿½ç•¥é¿å…é‡å¤å·¥ä½œã€‚</p></li></ol><h3 id="CRå…³æ³¨ç‚¹"><a href="#CRå…³æ³¨ç‚¹" class="headerlink" title="CRå…³æ³¨ç‚¹"></a>CRå…³æ³¨ç‚¹</h3><ol><li><p>åœ¨CRä¸­æœ€é‡è¦çš„æ˜¯çœ‹CLçš„æ•´ä½“è®¾è®¡ä¸ç»“æ„ã€‚CLä¸­ä¸åŒä»£ç æ®µçš„äº¤äº’æ˜¯å¦æœ‰æ„ä¹‰ï¼Ÿå®ƒä¸ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†æ˜¯å¦é›†æˆè‰¯å¥½ï¼Ÿç°åœ¨æ˜¯æ·»åŠ æ­¤åŠŸèƒ½çš„åˆé€‚æ—¶æœºå—ï¼Ÿ</p></li><li><p>å®¡æŸ¥è€…åº”è¯¥æŒ‰ç…§ <a href="https://juejin.cn/post/7018484631057989663"><strong>é£æ ¼æŒ‡å—</strong></a>ã€<a href="https://juejin.cn/post/7055164422662127647"><strong>å¼€å‘è§„èŒƒ</strong></a> è¿›è¡Œæ£€æŸ¥ã€‚</p></li><li><p>å®¡æŸ¥è€…åº”è¯¥è€ƒè™‘ä¸€äº›è¾¹ç¼˜çŠ¶å†µï¼Œå¯»æ‰¾å¹¶å‘æ€§é—®é¢˜ï¼Œå°è¯•åƒç”¨æˆ·ä¸€æ ·æ€è€ƒï¼Œå¹¶ç¡®ä¿ä¸ä¼šçœ‹åˆ°ä»…é€šè¿‡é˜…è¯»ä»£ç å°±èƒ½å‘ç°çš„é”™è¯¯ã€‚</p></li><li><p>å®¡æŸ¥è€…åº”è¯¥ä¸¥æŸ¥ä½¿ç”¨äº†è®¾è®¡æ¨¡å¼çš„åœ°æ–¹(ä¾‹å¦‚ä½¿ç”¨äº†å•ä¾‹ï¼Œé‚£ä¹ˆå°±æ£€æŸ¥æ˜¯å¦ä¸€å®šéœ€è¦ä½¿ç”¨)ã€‚</p></li><li><p>å¦‚æœæœ‰å¿…è¦çš„è¯å¯ä»¥è‡ªå·±å»éªŒè¯CLã€‚æœ‰äº›æ—¶å€™åœ¨é˜…è¯»ä»£ç æ—¶ï¼Œå¾ˆéš¾ç†è§£æŸäº›æ›´æ”¹ä¼šå¯¹ç”¨æˆ·äº§ç”Ÿæ€æ ·çš„å½±å“ï¼Œä¾‹å¦‚UIæ›´æ”¹ã€‚å¯¹äºè¿™æ ·çš„æ›´æ”¹ï¼Œå¦‚æœä¸æ–¹ä¾¿è‡ªå·±æµ‹è¯•ï¼Œå¯ä»¥è®©å¼€å‘äººå‘˜æ¼”ç¤ºè¯¥åŠŸèƒ½ã€‚</p></li><li><p>åœ¨CRæœŸé—´å¦ä¸€ä¸ªç‰¹åˆ«é‡è¦çš„äº‹æƒ…æ˜¯æŸ¥çœ‹ä»£ç ä¸­æ˜¯å¦å­˜åœ¨æŸç§ <strong>å¹¶å‘ç¼–ç¨‹</strong>ï¼Œç†è®ºä¸Šå¯èƒ½å¯¼è‡´æ­»é”æˆ–ç«äº‰æ¡ä»¶ï¼Œè¿™äº›ç±»å‹çš„é—®é¢˜å¾ˆéš¾é€šè¿‡è¿è¡Œä»£ç æ¥æ£€æµ‹ï¼Œé€šå¸¸éœ€è¦æœ‰äºº(å¼€å‘äººå‘˜æˆ–å®¡æŸ¥è€…)ä»”ç»†è€ƒè™‘å®ƒä»¬ä»¥ç¡®ä¿ä¸ä¼šå¼•å…¥é—®é¢˜ã€‚</p></li></ol><h3 id="å¤æ‚åº¦"><a href="#å¤æ‚åº¦" class="headerlink" title="å¤æ‚åº¦"></a>å¤æ‚åº¦</h3><ol><li><p>ä»£ç çš„å¤æ‚åº¦æ˜¯å¦è¶…è¿‡é¢„æœŸï¼Ÿæœ‰æ²¡æœ‰æ›´ç®€å•çš„å®ç°æ–¹å¼ï¼Ÿå•è¡Œä»£ç æ˜¯å¦è¿‡äºå¤æ‚ï¼Ÿå‡½æ•°æˆ–æ–¹æ³•æ˜¯å¦è¿‡äºå¤æ‚ï¼Ÿç±»æ˜¯å¦è¿‡äºå¤æ‚ï¼Ÿâ€œå¤æ‚â€ é€šå¸¸æ„å‘³ç€è¯¥ä»£ç å¾ˆéš¾é˜…è¯»ï¼Œä¹Ÿæ„å‘³ç€ â€œå½“å¼€å‘äººå‘˜è¯•å›¾è°ƒç”¨æˆ–ä¿®æ”¹è¿™æ®µä»£ç æ—¶ï¼Œä»–ä»¬å¾ˆå¯èƒ½ä¼šå¼•å…¥BUGâ€ã€‚</p></li><li><p>æœ‰ä¸€ç§å¤æ‚æ€§æ˜¯è¿‡åº¦è®¾è®¡é€ æˆçš„ï¼Œå¼€å‘è€…è®©é‚£æ®µä»£ç è¿‡åº¦é€šç”¨åŒ–ï¼Œè¶…è¿‡äº†åŸæœ¬æ‰€éœ€è¦çš„ï¼Œæˆ–è€…æ˜¯å¢åŠ äº†ç³»ç»Ÿç›®å‰ä¸éœ€è¦çš„åŠŸèƒ½ï¼›å®¡æŸ¥è€…åº”ç‰¹åˆ«æ³¨æ„ä¸€ä¸‹è¿‡åº¦è®¾è®¡ï¼Œé¼“åŠ±å¼€å‘è€…è§£å†³ä»–ä»¬ç°åœ¨éœ€è¦è§£å†³çš„é—®é¢˜ï¼Œè€Œä¸æ˜¯æ¨æµ‹å°†æ¥å¯èƒ½éœ€è¦è§£å†³çš„é—®é¢˜ï¼Œå½“é‚£äº›é—®é¢˜å‡ºç°çš„æ—¶å€™å†å»è§£å†³å®ƒä»¬ï¼Œå› ä¸ºé‚£ä¸ªæ—¶å€™ä½ å¯ä»¥æ›´æ¸…æ™°çš„çœ‹è§é—®é¢˜çš„æ ·å­ã€‚</p></li></ol><h3 id="å¦‚ä½•æµè§ˆCL"><a href="#å¦‚ä½•æµè§ˆCL" class="headerlink" title="å¦‚ä½•æµè§ˆCL"></a>å¦‚ä½•æµè§ˆCL</h3><ol><li><p>ç”¨å®è§‚çš„è§’åº¦æ¥çœ‹å¾…æ”¹åŠ¨ï¼ŒæŸ¥çœ‹CLæè¿°ä»¥åŠå®ƒåšäº†ä»€ä¹ˆã€‚</p></li><li><p>æ‰¾åˆ°CLæœ€æ ¸å¿ƒçš„éƒ¨åˆ†æ–‡ä»¶ï¼Œé¦–å…ˆæŸ¥çœ‹è¿™äº›ä¸»è¦éƒ¨åˆ†ã€‚è¿™æœ‰åŠ©äºä¸ºCLçš„å…¶ä»–è¾ƒå°éƒ¨åˆ†æä¾›é€»è¾‘ï¼Œè€Œä¸”è¿™æ ·å¯ä»¥æé«˜CRé€Ÿåº¦ã€‚å¦‚æœCLå¤ªå¤§å¯¼è‡´æ— æ³•ç¡®å®šå“ªé‡Œæ˜¯ä¸»è¦éƒ¨åˆ†æ—¶ï¼Œè¯·å‘å¼€å‘è€…è¯¢é—®é‡è¦çš„éƒ¨åˆ†ï¼Œæˆ–è€…è¦æ±‚ä»–ä»¬å°†CLæ‹†åˆ†ä¸ºå¤šä¸ªCLã€‚å¦‚æœåœ¨ä¸»è¦éƒ¨åˆ†å‘ç°å­˜åœ¨ä¸»è¦çš„è®¾è®¡é—®é¢˜ï¼Œåº”è¯¥ç«‹å³å‘Šè¯‰å¼€å‘è€…ä¿®æ”¹ã€‚å› ä¸ºå¦‚æœè®¾è®¡é—®é¢˜è¶³å¤Ÿä¸¥é‡çš„è¯ï¼Œç»§ç»­CRå…¶ä»–éƒ¨åˆ†çš„ä»£ç å¯èƒ½åªæ˜¯æµªè´¹æ—¶é—´ã€‚</p></li></ol><h3 id="æµè§ˆæ¯ä¸€è¡Œä»£ç "><a href="#æµè§ˆæ¯ä¸€è¡Œä»£ç " class="headerlink" title="æµè§ˆæ¯ä¸€è¡Œä»£ç "></a>æµè§ˆæ¯ä¸€è¡Œä»£ç </h3><ol><li><p>ä»”ç»†å®¡æŸ¥æ¯ä¸€è¡Œä»£ç ã€‚æœ‰äº›ä¸œè¥¿ï¼Œä¾‹å¦‚èµ„æ–™æ–‡ä»¶ã€ç”Ÿæˆçš„ä»£ç ã€å¤§å‹æ•°æ®ç»“æ„ï¼Œä½ å¯ä»¥ç¨å¾®æ‰«è¿‡ï¼Œä½†æ˜¯ä¸è¦æ‰«è¿‡å¼€å‘è€…å†™çš„ç±»ã€å‡½æ•°ã€æ–¹æ³•ã€ä»£ç åŒºå—ï¼Œæ›´ä¸èƒ½å‡è®¾å®ƒå†…éƒ¨æ˜¯æ²¡é—®é¢˜çš„ã€‚</p></li><li><p>å¦‚æœä»£ç è¿‡äºå¤æ‚å¹¶ä¸”éœ€è¦å‡æ…¢å®¡æŸ¥é€Ÿåº¦æ—¶ï¼Œé‚£ä¹ˆè¯·ä½ å‘Šè¯‰å¼€å‘è€…è¿™ä»¶äº‹ï¼Œè®©ä»–ä»¬ä¸ºè¿™æ®µä»£ç åšå‡ºè§£é‡Šã€‚ä½ è¦æ±‚å¼€å‘è€…å»è¯´æ¸…æ¥šè¿™æ®µä»£ç æ—¶ï¼ŒåŒæ—¶ä¹Ÿåœ¨å¸®åŠ©æœªæ¥çš„å¼€å‘äººå‘˜ç†è§£è¿™äº›ä»£ç ã€‚</p></li></ol><h3 id="ä¸Šä¸‹æ–‡"><a href="#ä¸Šä¸‹æ–‡" class="headerlink" title="ä¸Šä¸‹æ–‡"></a>ä¸Šä¸‹æ–‡</h3><ol><li>è¯·ç»“åˆä¸Šä¸‹æ–‡æŸ¥çœ‹CLï¼Œè¯¥CLæ˜¯å¦æ”¹å–„äº†æ•´ä½“ç³»ç»Ÿçš„ä»£ç è´¨é‡ï¼Œä¼šä¸ä¼šè®©æ•´ä¸ªç³»ç»Ÿæ›´åŠ å¤æ‚ï¼Ÿæ˜¯å¦ç¼ºå°‘æµ‹è¯•ï¼Ÿåƒä¸‡ä¸è¦æˆå—ä¼šé™ä½æ•´ä½“ç³»ç»Ÿä»£ç è´¨é‡çš„CLã€‚å› ä¸ºå¤§å¤šæ•°ç³»ç»Ÿæ˜¯ç”±äºè®¸å¤šå°æ”¹åŠ¨çš„ç´¯ç§¯è€Œå˜å¾—å¤æ‚çš„ã€‚</li></ol><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><ol><li><p>ä¸€èˆ¬æ¥è¯´ï¼Œæµ‹è¯•åº”è¯¥æ·»åŠ åˆ°ä¸ç”Ÿäº§ä»£ç ç›¸åŒçš„CLä¸­ï¼Œé™¤éCLæ­£åœ¨å¤„ç†ç´§æ€¥æƒ…å†µã€‚</p></li><li><p>å®¡æŸ¥è€…æœ‰å¿…è¦ç¡®ä¿æµ‹è¯•æ˜¯æ­£ç¡®ã€åˆç†ã€æœ‰ç”¨çš„ã€‚å½“ä»£ç çœŸçš„æœ‰é—®é¢˜ï¼Œæµ‹è¯•æ˜¯å¦ä¼šå¤±è´¥ï¼Ÿå¦‚æœè¢«æµ‹è¯•çš„ç¨‹åºå‘ç”Ÿæ”¹åŠ¨æ—¶ï¼Œæµ‹è¯•æ˜¯å¦ä¼šäº§ç”Ÿè¯¯æŠ¥ï¼Ÿæ¯ä¸€ä¸ªæµ‹è¯•æ˜¯å¦åšå‡ºäº†ç®€å•è€Œæœ‰ç”¨çš„æ–­è¨€ï¼Ÿä¸åŒçš„æµ‹è¯•æ–¹æ³•ä¹‹é—´æ˜¯å¦é€‚å½“åˆ†å¼€ï¼Ÿ</p></li><li><p>è¯·è®°ä½ï¼Œæµ‹è¯•ä»£ç ä¹Ÿæ˜¯éœ€è¦ç»´æŠ¤çš„ä»£ç ã€‚ä¸è¦å› ä¸ºæµ‹è¯•ä¸æ˜¯ä¸»åˆ†æ”¯çš„ä¸€éƒ¨åˆ†å°±æ¥å—æµ‹è¯•ä¸­çš„å¤æ‚æ€§ã€‚</p></li></ol><h3 id="è§£å†³å†²çª"><a href="#è§£å†³å†²çª" class="headerlink" title="è§£å†³å†²çª"></a>è§£å†³å†²çª</h3><ol><li><p>åœ¨CRä¸­é‡åˆ°ä»»ä½•å†²çªï¼Œé¦–å…ˆåº”è¯¥æ˜¯å¼€å‘äººå‘˜å’Œå®¡æŸ¥è€…é€šè¿‡æœ¬æ–‡æ¡£çš„å†…å®¹å’Œä»£ç è§„èŒƒå°è¯•è¾¾æˆå…±è¯†ã€‚</p></li><li><p>å½“è¾¾æˆå…±è¯†æ¯”è¾ƒå›°éš¾æ—¶ï¼Œå®¡æŸ¥è€…å¯ä»¥å’Œä½œè€…è¿›è¡Œé¢å¯¹é¢æ²Ÿé€šã€‚å¦‚æœè¿˜ä¸èƒ½è§£å†³é—®é¢˜ï¼Œå¯ä»¥è®©æ›´å¤šçš„äºº(ä¾‹å¦‚é¡¹ç›®ç®¡ç†è€…)å‚ä¸è¿›æ¥ä¸€èµ·è®¨è®ºè§£å†³å†²çªã€‚</p></li></ol><h3 id="ç´§æ€¥çŠ¶å†µ"><a href="#ç´§æ€¥çŠ¶å†µ" class="headerlink" title="ç´§æ€¥çŠ¶å†µ"></a>ç´§æ€¥çŠ¶å†µ</h3><ol><li><p>ç´§æ€¥æäº¤å†å²åªèƒ½æ˜¯ä¸€ä¸ªå°çš„æ›´æ”¹ï¼šä¿®å¤ä¸¥é‡å½±å“ç”Ÿäº§ä¸­ç”¨æˆ·çš„é”™è¯¯ï¼Œå¤„ç†ç´§è¿«çš„æ³•å¾‹é—®é¢˜ï¼Œå…³é—­ä¸»è¦çš„å®‰å…¨æ¼æ´ç­‰ã€‚</p></li><li><p>åœ¨ç´§æ€¥æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ›´å…³å¿ƒæ•´ä¸ªä»£ç å®¡æŸ¥è¿‡ç¨‹çš„é€Ÿåº¦ï¼Œä»…åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®¡æŸ¥è€…åº”è¯¥æ›´å…³å¿ƒå®¡æŸ¥çš„é€Ÿåº¦å’Œä»£ç çš„æ­£ç¡®æ€§(å®ƒæ˜¯å¦çœŸçš„è§£å†³äº†ç´§æ€¥æƒ…å†µï¼Ÿ)è€Œä¸æ˜¯å…¶ä»–ä»»ä½•äº‹æƒ…ã€‚æ­¤å¤–è¿™ç§å®¡æ ¸åº”è¯¥ä¼˜å…ˆäºæ‰€æœ‰å…¶ä»–ä»£ç å®¡æŸ¥ã€‚</p></li><li><p>ä½†æ˜¯ï¼Œåœ¨ç´§æ€¥æƒ…å†µè§£å†³åï¼Œæ‚¨åº”è¯¥å†æ¬¡æŸ¥çœ‹ç´§æ€¥æƒ…å†µæäº¤å†å²å¹¶å¯¹å…¶è¿›è¡Œæ›´å½»åº•çš„å®¡æŸ¥ã€‚</p></li></ol><h3 id="ä»€ä¹ˆä¸æ˜¯ç´§æ€¥æƒ…å†µï¼Ÿ"><a href="#ä»€ä¹ˆä¸æ˜¯ç´§æ€¥æƒ…å†µï¼Ÿ" class="headerlink" title="ä»€ä¹ˆä¸æ˜¯ç´§æ€¥æƒ…å†µï¼Ÿ"></a>ä»€ä¹ˆä¸æ˜¯ç´§æ€¥æƒ…å†µï¼Ÿ</h3><ol><li>ä»¥ä¸‹æƒ…å†µä¸æ˜¯ç´§æ€¥æƒ…å†µï¼š<ul><li>æƒ³è¦åœ¨æœ¬å‘¨è€Œä¸æ˜¯ä¸‹å‘¨å‘å¸ƒ(é™¤éæœ‰ä¸€äº›å®é™…çš„ç¡¬æ€§å‘å¸ƒæœŸé™ï¼Œä¾‹å¦‚åˆåŒåè®®)ã€‚</li><li>å¼€å‘äººå‘˜å·²ç»åœ¨ä¸€ä¸ªåŠŸèƒ½ä¸Šå·¥ä½œäº†å¾ˆé•¿æ—¶é—´ï¼Œä»–ä»¬å¾ˆæƒ³å®¡æŸ¥é€šè¿‡ã€‚</li><li>ä»Šå¤©æ˜¯æ˜ŸæœŸäº”ï¼Œåœ¨å¼€å‘äººå‘˜å¼€å§‹å‘¨æœ«ä¹‹å‰å®¡æŸ¥é€šè¿‡ä¼šå¾ˆæ£’ã€‚</li><li>â€¦â€¦</li></ul></li></ol><h3 id="ä»€ä¹ˆæ˜¯ç¡¬æœŸé™ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯ç¡¬æœŸé™ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ç¡¬æœŸé™ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ç¡¬æœŸé™ï¼Ÿ</h3><ol><li><p>ç¡¬æœŸé™æŒ‡çš„æ˜¯ä¸¥æ ¼çš„æˆªæ­¢æ—¥æœŸï¼Œå¦‚æœæ‚¨é”™è¿‡å®ƒå°± <strong>ä¼šå‘ç”Ÿç¾éš¾æ€§äº‹æƒ…</strong> çš„æˆªæ­¢æ—¥æœŸã€‚ä¾‹å¦‚ï¼š</p><ul><li>ä¸ºäº†å±¥è¡ŒåˆåŒä¹‰åŠ¡ï¼Œå¿…é¡»åœ¨æŸä¸ªæ—¥æœŸä¹‹å‰å®Œæˆã€‚</li><li>å¦‚æœæœªåœ¨ç‰¹å®šæ—¥æœŸä¹‹å‰å‘å¸ƒï¼Œæ‚¨çš„äº§å“å°†åœ¨å¸‚åœºä¸Šå®Œå…¨å¤±è´¥ã€‚</li><li>ä¸€äº›ç¡¬ä»¶åˆ¶é€ å•†æ¯å¹´åªå‘è´§ä¸€æ¬¡æ–°ç¡¬ä»¶ï¼Œå¦‚æœæ‚¨é”™è¿‡äº†å‘ä»–ä»¬æäº¤ä»£ç çš„æˆªæ­¢æ—¥æœŸï¼Œé‚£å¯èƒ½æ˜¯ç¾éš¾æ€§çš„ã€‚</li><li>â€¦â€¦</li></ul></li><li><p>å¤§å¤šæ•°æˆªæ­¢æ—¥æœŸéƒ½æ˜¯è½¯æˆªæ­¢æ—¥æœŸï¼Œè€Œä¸æ˜¯ç¡¬æˆªæ­¢æ—¥æœŸï¼›å®ƒä»¬ä»£è¡¨äº†åœ¨æŸä¸ªæ—¶é—´å®ŒæˆæŸé¡¹åŠŸèƒ½çš„æ„¿æœ›ï¼Œå®ƒä»¬å¾ˆé‡è¦ï¼Œä½†ä¸åº”è¯¥ç‰ºç‰²ä»£ç è´¨é‡æ¥è¾¾åˆ°ç›®çš„ã€‚</p></li></ol><h3 id="CRå¤ªä¸¥æ ¼è¢«æŠ±æ€¨æ€ä¹ˆåŠï¼Ÿ"><a href="#CRå¤ªä¸¥æ ¼è¢«æŠ±æ€¨æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="CRå¤ªä¸¥æ ¼è¢«æŠ±æ€¨æ€ä¹ˆåŠï¼Ÿ"></a>CRå¤ªä¸¥æ ¼è¢«æŠ±æ€¨æ€ä¹ˆåŠï¼Ÿ</h3><ol><li><p>æé«˜CRçš„é€Ÿåº¦é€šå¸¸ä¼šè®©è¿™äº›æŠ±æ€¨é€æ¸æ¶ˆå¤±ã€‚å¯èƒ½éœ€è¦æ•°ä¸ªæœˆï¼Œä½†æœ€ç»ˆå¼€å‘äººå‘˜ä¼šçœ‹åˆ°ä¸¥æ ¼çš„CRæ‰€å¸¦æ¥çš„ä»·å€¼ï¼Œå› ä¸ºä¸¥æ ¼çš„CRä¼šå¸®åŠ©ä»–ä»¬äº§ç”Ÿæ›´ä¼˜ç§€çš„ä»£ç ã€‚</p></li><li><p>å¦‚æœä½ éµå¾ªè¿™äº›å‡†åˆ™ï¼Œå¹¶ä¸”å¦‚æœCRéå¸¸ä¸¥æ ¼çš„è¯ï¼Œåé¢ä½ ä¼šå‘ç°æ•´ä¸ªCRæµç¨‹ä¼šè¶Šæ¥è¶Šå¿«ã€‚å› ä¸ºå¼€å‘è€…ä¼šçŸ¥é“ä»€ä¹ˆæ˜¯è´¨é‡å¥½çš„ä»£ç ï¼Œå¹¶ä¸”åœ¨å¼€å§‹å°±æäº¤ä¸€ä¸ªå¾ˆæ£’çš„CLã€‚ä½†ä¸è¦ä¸ºæé«˜æƒ³è±¡ä¸­çš„é€Ÿåº¦ï¼Œè€Œå¯¹CRæ ‡å‡†å’Œä»£ç è´¨é‡åšå‡ºå¦¥åï¼Œæ¯•ç«Ÿä»é•¿è¿œæ¥çœ‹å®ƒå®é™…ä¸Šå¹¶ä¸ä¼šè®©ä»»ä½•äº‹æƒ…å‘ç”Ÿçš„æ›´å¿«ã€‚</p></li></ol><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><ol><li>å¯ä»¥è½¬è½½ï¼Œä½†æ˜¯è¯·æ³¨æ˜æ¥æºã€‚</li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://google.github.io/eng-practices/review/reviewer/">Googleçš„ä»£ç å®¡æŸ¥æŒ‡å—</a></li><li><a href="https://juejin.cn/post/7460478066612977704">Code Reviewï¼šæå‡ä»£ç è´¨é‡ä¸å›¢é˜Ÿèƒ½åŠ›çš„åˆ©å™¨ä½œè€…- æ˜é‡‘</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘è§„èŒƒ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ObjC å¼€å‘è§„èŒƒ</title>
      <link href="/2022/01/20/iOS/ObjC%20%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83/"/>
      <url>/2022/01/20/iOS/ObjC%20%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç”± å¸ƒå¤š(budo) å‘å¸ƒäº 2022-01-20 â€¢ æœ€åæ›´æ–°äº 2025-02-13</p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™ç¯‡æ–‡ç« æ˜¯åŸºäºç¬”è€…ä¸ªäººç»éªŒä»¥åŠä¸€äº›å¼€å‘è§„èŒƒæ€»ç»“è€Œæˆï¼Œç›®çš„æ˜¯æé«˜å…¬å¸å†…éƒ¨é¡¹ç›®çš„ç¨³å®šæ€§ä¸æ•ˆç‡ã€‚<br>æ–‡ç« çš„å‰åŠéƒ¨åˆ†æ˜¯ä¸€äº›é€šç”¨å¼€å‘è§„èŒƒï¼Œé€‚ç”¨äºæ‰€æœ‰ç¼–ç¨‹è¯­è¨€ç”šè‡³æ˜¯ç”Ÿæ´»ä¸­é‡åˆ°çš„é—®é¢˜ï¼›<br>ååŠéƒ¨åˆ†æ˜¯å…³äºOCçš„å¼€å‘è§„èŒƒä»¥åŠå¼€å‘ä¸­å®¹æ˜“çŠ¯çš„é”™è¯¯ï¼Œå¦‚æœä¸æƒ³çœ‹å¯ä»¥è·³è¿‡ã€‚</p><h2 id="åŸåˆ™"><a href="#åŸåˆ™" class="headerlink" title="åŸåˆ™"></a>åŸåˆ™</h2><p>æˆ‘ä»¬æ— æ³•å†™å‡ºå®Œå…¨æ²¡æœ‰BUGçš„ä»£ç ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å°½é‡å†™å‡ºå®¹æ˜“é˜…è¯»å’Œé€»è¾‘ç®€å•æ¸…æ¥šçš„ä»£ç ï¼Œå®¹æ˜“é˜…è¯»å’Œé€»è¾‘ç®€å•æ¸…æ¥šçš„ä»£ç ä»æŸç§ç¨‹åº¦ä¸Šä¼šå‡å°‘BUGä»¥åŠBUGçš„ä¿®å¤éš¾åº¦ã€‚</p><h2 id="é€šç”¨è§„èŒƒ"><a href="#é€šç”¨è§„èŒƒ" class="headerlink" title="é€šç”¨è§„èŒƒ"></a>é€šç”¨è§„èŒƒ</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips:</span><br><span class="line">è™½ç„¶BUGæ— æ³•å®Œå…¨é¿å…ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥éµå¾ªä¸€äº›è§„èŒƒå’Œè§„åˆ™è®©BUGå°½æ—©æš´éœ²ï¼Œæˆ–è€…è®©å®ƒä¾¿äºæ’æŸ¥ã€‚</span><br></pre></td></tr></table></figure><ul><li><p><strong>[å¿…é¡»]</strong> å¼€å‘å®Œä¸€ä¸ªæ¨¡å—(<code>åŠŸèƒ½ã€é¡µé¢ç­‰ç­‰</code>)æ—¶ï¼Œè‡ªæµ‹ä¸€éï¼Œç¡®è®¤æ²¡æœ‰é—®é¢˜åå†å¼€å‘ä¸‹ä¸€ä¸ªæ¨¡å—ï¼Œå¦‚æœä¸€ä¸ªæ¨¡å—å¾ˆå¤§ï¼Œå¯ä»¥å®Œæˆä¸€ä¸ªå°åŠŸèƒ½æ—¶è‡ªæµ‹ä¸€éï¼Œä¸è¦æŠŠæ‰€æœ‰é—®é¢˜éƒ½æ”¾åˆ°æœ€åæµ‹è¯•ï¼Œæ›´ä¸è¦ä¾èµ–æµ‹è¯•äººå‘˜ã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> ç¦æ­¢å®ç°æœªæ¥å¯èƒ½éœ€è¦çš„åŠŸèƒ½ï¼Œå¦‚æœè¿™ä¸ªåŠŸèƒ½ç°åœ¨ä¸éœ€è¦å°±ä¸è¦å®ç°å®ƒï¼Œç­‰æœªæ¥éœ€è¦çš„æ—¶å€™å†å»å®ç°å®ƒï¼Œå› ä¸ºé‚£ä¸ªæ—¶å€™ä½ å¯ä»¥æ›´æ¸…æ™°çš„çœ‹åˆ°é‚£ä¸ªåŠŸèƒ½å®Œæ•´çš„æ¨¡æ ·(<code>å¦‚æœå¿…é¡»è¦å®ç°å®ƒï¼Œå¿…é¡»è¦è€ƒè™‘æ‰€æœ‰å¯èƒ½å‘ç”Ÿçš„æƒ…å†µä»¥åŠç»†èŠ‚ï¼Œå¹¶ä¸”åŠ ä¸Šæ³¨é‡Šè¯´æ˜</code>)ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips:</span><br><span class="line">å®ç°ä¸€ä¸ªæœªæ¥å¯èƒ½éœ€è¦çš„åŠŸèƒ½åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½æ˜¯å¾—ä¸å¿å¤±çš„ï¼Œæœ‰ä»¥ä¸‹ç¼ºç‚¹ï¼š</span><br><span class="line">1. æœªæ¥å¯èƒ½ä¸éœ€è¦è¿™ä¸ªåŠŸèƒ½ã€‚</span><br><span class="line">2. å¢åŠ åƒåœ¾ä»£ç ï¼Œå½“åˆ«äººçœ‹è§è¿™æ®µä»£ç æ—¶ä¸ç†è§£ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå†™ã€‚</span><br><span class="line">3. å¢åŠ ç»´æŠ¤æˆæœ¬å’Œå¼€å‘æ—¶é—´(å³ä½¿æŸæ®µä»£ç ä¸ä½¿ç”¨ä¹Ÿæ˜¯éœ€è¦ç»´æŠ¤çš„)ã€‚</span><br><span class="line">4. åæœŸçœŸæ­£è¦ç”¨çš„æ—¶å€™å¯èƒ½ä¼šå‘ç°å½“åˆå®ç°çš„æ—¶å€™è€ƒè™‘ä¸å…¨é¢ï¼Œæœ€åè¿˜æ˜¯è¦é‡æ–°å†™ä¸€éã€‚</span><br><span class="line">5. â€¦â€¦</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> ä¸è¦å°è¯•å»æ¨æµ‹å¹¶è§£å†³æœªæ¥å¯èƒ½å‘ç”Ÿçš„é—®é¢˜ï¼Œç­‰é—®é¢˜å‡ºç°çš„æ—¶å€™å†å»è§£å†³å®ƒï¼Œå› ä¸ºé‚£ä¸ªæ—¶å€™ä½ å¯ä»¥æ›´æ¸…æ™°çš„çœ‹è§é—®é¢˜çš„çœŸå®æ ·å­ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips:</span><br><span class="line">è¿™ä¸ªè§„åˆ™ä¸æ˜¯è¯´è¦ä½ å‘ç°é—®é¢˜äº†ä¸å»è§£å†³ç­‰åˆ°è¢«åˆ«äººå‘ç°æå‡ºåå†è§£å†³ï¼›</span><br><span class="line">ç°å®ç”Ÿæ´»ä¸­æœ‰ä¸€äº›å®Œç¾ä¸»ä¹‰è€…æƒ³è®©è‡ªå·±å†™çš„ä»£ç éå¸¸å®Œç¾æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œæ‰€ä»¥ä»–ä»¬ä¼šå°½</span><br><span class="line">é‡å‡è®¾å„ç§å„æ ·çš„æƒ…å†µï¼Œç”šè‡³å¾ˆå¤šæç«¯æƒ…å†µï¼Œæœ‰æ—¶å€™ä¼šä¸ºäº†ä¸€ä¸ªå‘ç”Ÿæ¦‚ç‡å¾ˆå°å¹¶ä¸”</span><br><span class="line">å½±å“ä¸æ˜¯å¾ˆé‡è¦çš„é—®é¢˜è€Œå¤§æ”¹ç‰¹æ”¹ï¼Œç›´åˆ°æ»¡æ„ä¸ºæ­¢ï¼Œè¿™ä¹ˆåšå¾ˆå¯èƒ½ä¼šå½±å“åˆ«äººç”šè‡³å¯¼è‡´é¡¹ç›®å»¶è¿Ÿä¸Šçº¿ã€‚</span><br><span class="line">åœ¨ä¿®æ”¹è¿‡ç¨‹ä¸­å¦‚æœæ”¹åŠ¨çš„èŒƒå›´ç‰¹åˆ«å¤§è¿˜å¯èƒ½ä¼šå¼•è¿›æ–°çš„é—®é¢˜ï¼Œè€Œä¸”ç”±äºè¿™ä¸ªé—®é¢˜æ˜¯æœªæ¥</span><br><span class="line">å¯èƒ½ä¼šå‘ç”Ÿçš„é—®é¢˜ï¼Œæ‰€ä»¥å¯èƒ½è¿˜ä¼šæœ‰ä½ æ²¡è€ƒè™‘åˆ°çš„åœ°æ–¹ï¼Œæœ€åæ—¢å¼•è¿›äº†æ–°çš„é—®é¢˜è¿˜å¯èƒ½æ²¡è§£å†³é—®é¢˜ã€‚</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> å¯¹äºæœåŠ¡ç«¯è¿”å›çš„å€¼ï¼Œæ°¸è¿œä¸è¦å‡è®¾å®ƒæ˜¯æ­£ç¡®çš„ç±»å‹å’Œå€¼(<code>å³ä½¿æœåŠ¡ç«¯çš„äººä¿è¯</code>)ï¼Œä½¿ç”¨ä¹‹å‰å¿…é¡»æ£€æŸ¥å®ƒçš„çœŸå®ç±»å‹å’Œå€¼æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> ä¸è¦è®©ä»£ç è„±ç¦»å¼€å‘è€…çš„æŒæ§ã€‚å½“æˆ‘ä»¬å¼€å‘ä¸€ä¸ªåŠŸèƒ½æ—¶ï¼Œæ€»æ˜¯å¸Œæœ›è®©ä½¿ç”¨è€…è°ƒç”¨æ›´å°‘çš„APIæˆ–è€…è‡ªåŠ¨è°ƒç”¨ï¼Œä½†æ˜¯æœ‰äº›æ­¥éª¤è®©ä½¿ç”¨è€…ä¸»åŠ¨è°ƒç”¨ä¼šæ›´å¥½ä¸€äº›ï¼Œè¿™æ ·ä½¿ç”¨è€…çŸ¥é“ä»–å¹²äº†ä»€ä¹ˆï¼Œè€Œä¸æ˜¯å‡ºäº†é—®é¢˜æ—¶ä¸€å¤´é›¾æ°´ï¼Œå½“ä½ æŠŠæŸä¸ªæ­¥éª¤è®¾ç½®æˆè‡ªåŠ¨è°ƒç”¨æ—¶æƒ³ä¸€ä¸‹è¿™æ˜¯å¦æœ‰å¿…è¦ï¼Ÿå¦‚æœä¸æ˜¯è¯·è®©ä½¿ç”¨è€…ä¸»åŠ¨è°ƒç”¨å®ƒå¹¶åœ¨æ–‡æ¡£ä¸­åŠ ä»¥è¯´æ˜ã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> æ‰€è§å³æ‰€å¾—ï¼Œä¾‹å¦‚é¡µé¢ä¸Š2ä¸ªæ§ä»¶çš„é—´è·æ˜¯10ï¼Œé‚£ä¹ˆä»£ç ä¸­çš„é—´è·è®¾ç½®ä¹Ÿåº”è¯¥æ˜¯10ï¼Œè€Œä¸åº”è¯¥æ˜¯ä¸€ä¸ªæ§ä»¶å¾ˆé«˜ï¼Œæœ‰å¾ˆå¤šçš„ç©ºç™½åŒºåŸŸï¼Œç„¶åç”¨-xx(è´Ÿé—´è·)å»å¡«å……ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">UILabel *label1 = [[UILabel alloc] init];</span><br><span class="line">label1.frame = CGRectMake(0, 0, 100, 30);</span><br><span class="line"></span><br><span class="line">UILabel *label2 = [[UILabel alloc] init];</span><br><span class="line">label2.frame = CGRectMake(0, 30 + 10, 100, 30);</span><br><span class="line">ä¸Šè¿°ä»£ç æ˜æ˜¾çš„å‘Šè¯‰ä½  label2 çš„é¡¶éƒ¨å’Œ label1 çš„åº•éƒ¨é—´è·ä¸º10ã€‚</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">UILabel *label1 = [[UILabel alloc] init];</span><br><span class="line">label1.frame = CGRectMake(0, 0, 100, 30);</span><br><span class="line"></span><br><span class="line">UILabel *label2 = [[UILabel alloc] init];</span><br><span class="line">label2.frame = CGRectMake(0, -20, 100, 90);</span><br><span class="line">å‡è®¾æ–‡å­—å®é™…å±•ç¤ºéœ€è¦ 30 é«˜åº¦ï¼Œä¸Šè¿°ä»£ç å’Œæ­£ä¾‹ä¸­çš„ä»£ç ç»™ç”¨æˆ·çš„æ„Ÿè§‰æ˜¯ä¸€æ ·çš„ï¼Œ</span><br><span class="line">ä½†æ˜¯é˜…è¯»æ€§å´éå¸¸å·®ã€‚</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> ä¸€èˆ¬æƒ…å†µä¸‹ç¦æ­¢ä½¿ç”¨è¿‡æ—¶çš„æ–¹æ³•æˆ–ç±»ï¼Œåº”è¯¥åŠæ—¶å»äº†è§£å’Œä½¿ç”¨æ–°æ–¹æ³•æˆ–ç±»ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips:</span><br><span class="line">å¯¹äºè¿‡æ—¶çš„æ–¹æ³•æˆ–ç±»ï¼Œå¤§éƒ½æ˜¯å› ä¸ºå…¶è‡ªèº«æœ‰ç¼ºé™·æˆ–BUGï¼Œ</span><br><span class="line">ä½¿ç”¨æ–°æ–¹æ³•å‰å»ºè®®äº†è§£ä¸€ä¸‹æ—§æ–¹æ³•/ç±»åºŸå¼ƒçš„åŸå› ã€‚</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> å°½é‡ä¸è¦ä½¿ç”¨runtimeå»äº¤æ¢æ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨ä¸­é—´è€…æ¨¡å¼æˆ–è€…å…¶ä»–æ–¹æ³•ä»£æ›¿ï¼Œå¦‚æœä¸€å®šè¦è¿™ä¹ˆåšï¼Œé‚£ä¹ˆè¯·ç•™ä¸‹æ³¨é‡Šè¯´æ˜äº¤æ¢æ–¹æ³•ååšäº†ä»€ä¹ˆï¼Œä»¥åŠä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿ</p></li><li><p><strong>[å¿…é¡»]</strong> å°½é‡ä¸è¦ç›´æ¥ä½¿ç”¨æˆå‘˜å˜é‡ï¼Œè€Œæ˜¯ä½¿ç”¨å±æ€§æ›¿ä»£å®ƒã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> åœ¨deallocæ–¹æ³•å†…ç¦æ­¢å°†selfä¼ é€’å‡ºå»ï¼Œå¦‚æœselfè¢«retainï¼Œåˆ°ä¸‹ä¸ªrunloopå‘¨æœŸå†é‡Šæ”¾åˆ™ä¼šå¤šæ¬¡é‡Šæ”¾å¯¼è‡´crashã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">åä¾‹ï¼š</span><br><span class="line">- (void)dealloc &#123;</span><br><span class="line">    [self unsafeMethod:self];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> å¯¹å‰ªåˆ‡æ¿çš„è¯»å–æ“ä½œå¿…é¡»æ”¾åœ¨å­çº¿ç¨‹ä¸­è¿›è¡Œï¼Œå› ä¸ºç”¨æˆ·å¯èƒ½åœ¨Macä¸Šå¤åˆ¶å¤§é‡æ•°æ®ç„¶åé€šè¿‡æ¥åŠ›åŒæ­¥åˆ°iPhoneä¸Šã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> å½“æ–¹æ³•å¯èƒ½ä¼šæå‰returnæ—¶ï¼Œéœ€è¦æ³¨æ„å¯¹è±¡çš„é‡Šæ”¾é—®é¢˜ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">åä¾‹ï¼š</span><br><span class="line">CFArrayRef arrayRef = (__bridge CFArrayRef)array;</span><br><span class="line"></span><br><span class="line">if (x == YES) return;</span><br><span class="line"> </span><br><span class="line">CFRelease(arrayRef);</span><br><span class="line"></span><br><span class="line">å¦‚æœifæ¡ä»¶æˆç«‹é‚£ä¹ˆarrayRefå¯¹è±¡å°±ä¼šå†…å­˜æ³„æ¼ã€‚</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> ä½¿ç”¨@tryå¤„ç†å¼‚å¸¸æ—¶ï¼Œéœ€è¦æ³¨æ„å¯¹è±¡çš„é‡Šæ”¾é—®é¢˜ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">åä¾‹ï¼š</span><br><span class="line">@try &#123;</span><br><span class="line">CFArrayRef arrayRef = (__bridge CFArrayRef)array;</span><br><span class="line">    </span><br><span class="line">do some thingâ€¦â€¦</span><br><span class="line"></span><br><span class="line">CFRelease(arrayRef);</span><br><span class="line">        </span><br><span class="line">&#125; @catch (NSException *exception) &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">å¦‚æœdo some thingâ€¦â€¦å‡ºç°å¼‚å¸¸çš„è¯é‚£ä¹ˆarrayRefå°±ä¼šå‡ºç°å†…å­˜æ³„æ¼ã€‚</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> å¦‚æœä½¿ç”¨åˆ°çš„å€¼å’Œå¦ä¸€ä¸ªå€¼æœ‰æ‰€å…³è”ï¼Œåœ¨ä»£ç ä¸­ä½“ç°å‡ºè¿™ç§å…³è”æ€§ï¼Œè¿™èƒ½å¢åŠ ä»£ç å¯è¯»æ€§ï¼Œä¹Ÿèƒ½å¢åŠ ä»£ç ç¨³å®šæ€§ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips:</span><br><span class="line">ä¾‹å¦‚æœ‰1ä¸ªå¤´åƒæ§ä»¶éœ€è¦æ˜¾ç¤ºä¸ºåœ†å½¢ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šè¿™æ ·è®¾ç½®ï¼š</span><br><span class="line">1. ç»™å¤´åƒæ§ä»¶è®¾ç½®åœ†è§’ï¼šlayer.cornerRadius = 15.0;</span><br><span class="line">2. ç»™å¤´åƒæ§ä»¶è®¾ç½®å®½é«˜ï¼š.frame = CGRectMake(0, 0, 30.0, 30.0);</span><br><span class="line">// ä¸Šè¿°ä»£ç ä¸­çš„15.0 å’Œ 30.0 å°±æ²¡æœ‰ä»»ä½•å…³è”æ€§ï¼Œå¦‚æœå®ƒä»¬ä¹‹é—´ç›¸éš”äº†å¾ˆå¤šä»£ç ï¼Œ</span><br><span class="line">   ä¿®æ”¹å®½é«˜çš„æ—¶å€™å¯èƒ½ä¼šå¿˜è®°ä¿®æ”¹cornerRadiusã€‚</span><br><span class="line">   </span><br><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">1. ç»™å¤´åƒæ§ä»¶è®¾ç½®åœ†è§’ï¼šlayer.cornerRadius = 15.0;</span><br><span class="line">2. ç»™å¤´åƒæ§ä»¶è®¾ç½®å®½é«˜ï¼š.frame = CGRectMake(0, 0, layer.cornerRadius * 2.0, layer.cornerRadius * 2.0);</span><br><span class="line">// è¿™æ ·åé¢é˜…è¯»ä»£ç çš„äººä¸€çœ¼å°±èƒ½æ˜ç™½å®½é«˜å’Œ layer.cornerRadius çš„å…³ç³»ï¼Œæ—¢å¢åŠ äº†å¯è¯»æ€§ï¼Œåˆå¢åŠ äº†ç¨³å®šæ€§ã€‚</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> å¦‚æœä¸€ä¸ªå€¼éœ€è¦ç‰¹åˆ«å¤šä¸ªå˜é‡è®¡ç®—å‡ºæ¥ï¼Œè¯·æŠŠå®ƒä»¬æå–æˆä¸€ä¸ªå˜é‡å¹¶ä¸”åŠ ä¸Šæ³¨é‡Šè¯´æ˜è¿™ä¸ªå˜é‡æ˜¯æ€ä¹ˆç»„æˆçš„ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">// å±å¹•å®½åº¦ - labelå·¦è¾¹è· - labelå³è¾¹è· - å¼€å…³æŒ‰é’®å®½åº¦ - æŒ‰é’®å³è¾¹è·</span><br><span class="line">Â  Â  CGFloat titleMaxWidth = kScreenWidth - labelLeftSpacing - labelRightSpacing - buttonWidth - buttonRightSpacing;</span><br><span class="line"></span><br><span class="line">// è¿™æ ·å†™çš„å¥½å¤„åœ¨äºä»¥åå¦‚æœéœ€è¦ä¿®æ”¹æŸä¸ªæ§ä»¶çš„å¸ƒå±€ä¿¡æ¯ï¼Œåªéœ€è¦ä¿®æ”¹ä¸€å¤„å³å¯ï¼Œé™ä½äº†åç»­ç»´æŠ¤éš¾åº¦ã€‚</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> å£°æ˜å¸¸é‡å°½é‡ä½¿ç”¨constç±»å‹ï¼Œä¸è¦ä½¿ç”¨#defineã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips: </span><br><span class="line">å®å®šä¹‰å£°æ˜å¸¸é‡çš„ç¼ºç‚¹ï¼š</span><br><span class="line">1. å®å®šä¹‰åªæ˜¯ç®€å•çš„æ›¿æ¢ï¼Œç¼ºå°‘ç¼–è¯‘æ£€æŸ¥ï¼Œè¿è¡ŒæœŸå¯èƒ½ä¼šå‡ºç°æº¢å‡ºæˆ–æ•°æ®é”™è¯¯ç­‰é—®é¢˜ã€‚</span><br><span class="line">2. å®å®šä¹‰ç¼ºå°‘ç±»å‹ï¼Œä¸æ–¹ä¾¿ç¼–å†™æ–‡æ¡£ç”¨ä¾‹ã€‚</span><br><span class="line">3. å®å®šä¹‰å¯èƒ½ä¼šè¢«æ›¿æ¢ã€‚</span><br><span class="line">4. å®å®šä¹‰æ— æ³•ç¼–å†™ç¬¦åˆè§„èŒƒçš„æ³¨é‡Šä¿¡æ¯ã€‚</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">#define kTime @&quot;10&quot;</span><br><span class="line">    </span><br><span class="line">if (NO) &#123;</span><br><span class="line">#define kTime @&quot;20&quot;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">NSLog(@&quot;time = %@&quot;, kTime);</span><br><span class="line"></span><br><span class="line">å³ä½¿ifæ°¸è¿œä¸ä¼šæ‰§è¡Œï¼Œä½†æ˜¯ç¼–è¯‘å™¨ä¹Ÿä¼šå°†kTimeæ›¿æ¢ä¸º@&quot;20&quot;</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> å·¥å…·ç±»å°½é‡åœ¨å¤´æ–‡ä»¶çš„æ³¨é‡Šä¸­å†™æ¸…æ¥šè¯¥åŠŸèƒ½å¦‚ä½•ä½¿ç”¨ï¼Œä»¥åŠéœ€è¦æ³¨æ„çš„äº‹é¡¹ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips:</span><br><span class="line">1. å¦‚æœæ˜¯ä¸€ä¸ªUIå·¥å…·ï¼Œä½¿ç”¨æ—¶æ˜¯å¦éœ€è¦æå‰è®¾ç½®frameï¼Œæ˜¯å¦å¯ä»¥ä½¿ç”¨çº¦æŸå¸ƒå±€ï¼Ÿ</span><br><span class="line">2. å¯¹äºä¸€äº›æ¯”è¾ƒå¤æ‚çš„å·¥å…·ï¼Œæœ€å¥½åœ¨æ³¨é‡Šä¸­ç»™å‡ºä¸€æ®µç¤ºä¾‹ä»£ç ã€‚</span><br><span class="line">åŒ…æ‹¬ä½†ä¸é™äºä¸Šè¿°çš„æ³¨æ„äº‹é¡¹ï¼Œ</span><br><span class="line">ä¾‹å¦‚ä¸€ä¸ªå°è£…å¥½çš„å¼¹çª—å·¥å…·ï¼Œåº”è¯¥è¯´æ˜å¦‚ä½•å¼¹å‡ºï¼Œæ˜¯å¦éœ€è¦æå‰è®¾ç½®frameæˆ–è€…çº¦æŸ</span><br><span class="line"></span><br><span class="line">ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ä¼ªä»£ç :</span><br><span class="line">/**</span><br><span class="line">* @brief UIActivityIndicatorViewçš„å¢å¼ºç‰ˆï¼Œå’ŒUIActivityIndicatorViewä½¿ç”¨æ–¹å¼ä¸€è‡´ï¼Œä½†æ‰©å±•äº†ä¸€äº›é¢å¤–åŠŸèƒ½ã€‚</span><br><span class="line">* @discussion 1. é™¤äº†å¯ä»¥è‡ªå®šä¹‰é¢œè‰²ä¹‹å¤–ï¼Œè¿˜å¯ä»¥è‡ªå®šä¹‰æŒ‡ç¤ºå™¨çš„è¯¦ç»†å¤§å°(ä¾‹å¦‚æŒ‡ç¤ºå™¨å®½åº¦ã€é«˜åº¦ã€ç¦»å¿ƒè·ç¦»ç­‰)ã€‚</span><br><span class="line">* @discussion 2. å†…éƒ¨ä¼šè‡ªåŠ¨è®¡ç®—æ§ä»¶æ‰€éœ€è¦çš„æœ€å°å®½é«˜ï¼Œå¯ä»¥ä¸è®¾ç½®å®½é«˜çº¦æŸæˆ–å®½é«˜Frameã€‚</span><br><span class="line">* @discussion 3. å¯ä»¥æš‚åœ/æ¢å¤æŒ‡ç¤ºå™¨åŠ¨ç”»ã€‚</span><br><span class="line">* @code</span><br><span class="line">* LLActivityIndicatorView *activityIndicatorView = [LLActivityIndicatorView activityIndicatorWithStyle:LLActivityIndicatorViewStyleGrayMedium];</span><br><span class="line">* activityIndicatorView.backgroundColor = UIColor.redColor;</span><br><span class="line">* activityIndicatorView.frame = CGRectMake(0, 0, 50, 50);</span><br><span class="line">* activityIndicatorView.center = self.view.center;</span><br><span class="line">* [self.view addSubview:activityIndicatorView];</span><br><span class="line">* [activityIndicatorView startAnimating];</span><br><span class="line">* @encode</span><br><span class="line">*/</span><br><span class="line">@interface LLActivityIndicatorView : UIView</span><br><span class="line">@end</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> ä¸è¦æ»¥ç”¨æ‡’åŠ è½½ï¼Œåªåœ¨å¿…è¦æ—¶åˆ»ä½¿ç”¨å®ƒã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">åªåœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¸‹æ‰ä½¿ç”¨æ‡’åŠ è½½ï¼š</span><br><span class="line">1. å¯¹è±¡çš„åˆ›å»ºéœ€è¦ä¾èµ–å…¶ä»–å¯¹è±¡</span><br><span class="line">2. å¯¹è±¡å¯èƒ½è¢«ä½¿ç”¨ï¼Œä¹Ÿå¯èƒ½ä¸è¢«ä½¿ç”¨</span><br><span class="line">3. å¯¹è±¡åˆ›å»ºæ¯”è¾ƒæ¶ˆè€—æ€§èƒ½</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> ä½¿ç”¨NSUserDefaultså­˜å‚¨æ•°æ®æ—¶ç¦æ­¢è°ƒç”¨synchronizeæ–¹æ³•ï¼Œå› ä¸ºç³»ç»Ÿä¼šåœ¨åˆé€‚çš„æ—¶æœºå°†æ•°æ®ä¿å­˜åˆ°æœ¬åœ°(å³ä½¿ç¨‹åºé—ªé€€ç­‰æç«¯æƒ…å†µ)ã€‚</p></li><li><p><strong>[å»ºè®®]</strong> å¯¹äºä¸€äº›ä½“ç§¯å°å¹¶ä¸”ä¸æ˜¯ç‰¹åˆ«é‡è¦çš„æ•°æ®ï¼Œä¸è¦é¢‘ç¹çš„è¿›è¡Œå†™å…¥æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨NSUserDefaultsã€‚å®ƒä¼šåœ¨åˆé€‚çš„æ—¶æœºå°†æ•°æ®å­˜å‚¨åˆ°æœ¬åœ°ï¼Œè¿™é¿å…äº†é¢‘ç¹çš„å†™å…¥æ“ä½œï¼Œè€Œä¸”åœ¨æŸäº›æç«¯æƒ…å†µä¸‹å®ƒä¹Ÿèƒ½ä¿è¯æ•°æ®å­˜å‚¨åˆ°æœ¬åœ°(ä¾‹å¦‚ç¨‹åºé—ªé€€ç­‰æƒ…å†µ)ã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> æ·»åŠ åˆ°é›†åˆä¸­çš„å¯¹è±¡åº”è¯¥æ˜¯ä¸å¯å˜çš„ï¼Œæˆ–è€…åœ¨åŠ å…¥ä¹‹åå…¶å“ˆå¸Œå€¼æ˜¯ä¸å¯å˜çš„ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">åä¾‹ï¼š</span><br><span class="line">NSMutableSet *sets = [NSMutableSet set];</span><br><span class="line">NSMutableString *string1 = [NSMutableString stringWithString:@&quot;1&quot;];</span><br><span class="line">[sets addObject:string1];</span><br><span class="line">[sets addObject:@&quot;12&quot;];</span><br><span class="line">    </span><br><span class="line">[string1 appendString:@&quot;2&quot;];</span><br><span class="line"></span><br><span class="line">å½“ [string1 appendString:@&quot;2&quot;] æ‰§è¡Œå®Œä»¥åsetså¯¹è±¡å†…ä¼šåŒ…å«2ä¸ª@&quot;12&quot;ã€‚</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> ä¸å¯å˜å¯¹è±¡è¯·ä½¿ç”¨copyä¿®é¥°ï¼Œå¦‚æœé‡å†™setæ–¹æ³•ï¼Œè¯·æ³¨æ„è°ƒç”¨copyæ–¹æ³•ã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> è¯·ä½¿ç”¨CGRectGetå‡½æ•°è·å–Frameçš„å„ç§å€¼ï¼Œè€Œä¸æ˜¯é€šè¿‡frame.çš„æ–¹å¼è·å–ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips:</span><br><span class="line">CGRect t_frame = CGRectMake(-10, -10, -10, -10);</span><br><span class="line">å½“ä¸€ä¸ªviewçš„frameè®¾ç½®æˆt_frameåï¼Œå…¶åæ ‡ä¼šéšå¼çš„è½¬æ¢ä¸ºCGRectMake(-20, -20, 10, 10)ï¼Œ</span><br><span class="line">å› ä¸ºå®½é«˜ä¸å¯èƒ½å‡ºç°è´Ÿå€¼ï¼›</span><br><span class="line">è¿™æ—¶é€šè¿‡t_frame.çš„æ–¹å¼è·å–çš„å€¼éƒ½æ˜¯é”™è¯¯çš„ï¼Œè€ŒCGRectGetä¼šè‡ªåŠ¨å¸®æ‚¨å¤„ç†è¿™äº›éšå¼è½¬æ¢ã€‚</span><br><span class="line"></span><br><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">CGRectGetWidth(frame)ã€CGRectGetMinX(frame)ã€CGRectGetMaxX(frame)</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">frame.size.widthã€frame.origin.xã€frame.size.width + frame.origin.x</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> ä»£ç ä¸­å•è¡Œå­—ç¬¦æ•°ä¸è¦è¶…è¿‡150ä¸ªï¼Œè¶…è¿‡è¯·æ¢è¡Œ(ç©ºæ ¼é™¤å¤–)ï¼Œå¯ä»¥åœ¨ Xcode -&gt; Preferencesâ€¦ -&gt; Text Editing -&gt; Page guide at column ä¸­è®¾ç½®ä¸º150æ–¹ä¾¿æ’æŸ¥ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">- (void)setImageWithURL:(nullable NSURL *)imageURL</span><br><span class="line">            placeholder:(nullable UIImage *)placeholder</span><br><span class="line">                options:(YYWebImageOptions)options</span><br><span class="line">               progress:(nullable YYWebImageProgressBlock)progress</span><br><span class="line">               ransform:(nullable YYWebImageTransformBlock)transform</span><br><span class="line">             completion:(nullable YYWebImageCompletionBlock)completion;</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> å•ä¸ªæ–¹æ³•çš„è¡Œæ•°å»ºè®®ä¸è¶…è¿‡80è¡Œï¼Œæ³¨é‡Šã€å·¦å³å¤§æ‹¬å·ã€ç©ºè¡Œã€å›è½¦ç­‰é™¤å¤–ã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è°¨æ…ä½¿ç”¨å¯å˜é›†åˆï¼Œå¿…è¦æ—¶å€™å¯ä»¥é‡‡ç”¨åŠ é”æˆ–GCDçš„åŒæ­¥çº¿ç¨‹è¿›è¡Œä¿æŠ¤ï¼Œæˆ–è€…åœ¨è®¿é—®å¯å˜é›†åˆæ—¶å…ˆå°†å…¶copyä¸ºä¸å¯å˜å¯¹è±¡ç„¶åå†å¯¹å…¶è®¿é—®ã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> å±æ€§å’Œæ–¹æ³•å¿…é¡»æœ‰ <strong>nullable</strong> æˆ– <strong>nonnull</strong> é™å®šç¬¦ï¼Œç”±äºOCæ˜¯åŠ¨æ€è¯­è¨€ï¼Œæ‰€ä»¥å³ä½¿ä½¿ç”¨ <code>nonnull</code> å£°æ˜å¯¹è±¡ä¸ä¸ºç©ºï¼Œä½¿ç”¨å‰ä¹Ÿå¿…é¡»åˆ¤æ–­æ˜¯å¦ä¸ºç©ºã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">- (void)setName:(NSString * _Nonnull)name &#123;</span><br><span class="line">    if (name == nil) &#123;</span><br><span class="line">      â€¦â€¦â€¦</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> å¦‚æœæœ‰ä½¿ç”¨åˆ°æ•°ç»„ã€å­—å…¸ç­‰ç±»å‹ï¼Œå°½é‡ä½¿ç”¨æ³›å‹å£°æ˜å…¶åŒ…å«çš„ç±»å‹ï¼Œè¿™æ ·å¯ä»¥æé«˜ä»£ç å¯è¯»æ€§ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">NSArray&lt;NSString *&gt; *array;</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">NSArray *array;</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> å¦‚æœç±»ä¸­åŒ…å«å¤šä¸ªåˆå§‹åŒ–æ–¹æ³•ï¼Œè¯·ä½¿ç”¨ <code>NS_DESIGNATED_INITIALIZER</code> å’Œ <code>NS_UNAVAILABLE</code> å®æ ‡è®°æé«˜ä»£ç å¯è¯»æ€§ã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> é¿å…ä½¿ç”¨æ— ç¬¦å·æ•´æ•°(é™¤éåŒ¹é…ç³»ç»Ÿæ¥å£ä½¿ç”¨çš„ç±»å‹)ï¼Œåœ¨å·¥ç¨‹ä¸­å…¨éƒ¨ä½¿ç”¨ä¸€ç§ç±»å‹å¯ä»¥æé«˜ä»£ç å®‰å…¨ä¸ä¸€è‡´æ€§ï¼Œæ— ç¬¦å·æ•´æ•°åœ¨è¿›è¡Œæ•°å­¦è¿ç®—å’Œå€’æ•°åˆ°é›¶çš„æ—¶å€™ä¼šå‡ºç°ç»†å¾®çš„é”™è¯¯ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">NSUInteger numberOfObjects = array.count;</span><br><span class="line">for (NSInteger counter = numberOfObjects - 1; counter &gt; 0; counter--)</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">for (NSUInteger counter = numberOfObjects - 1, counter &gt; 0; counter--)</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> åœ¨è‡ªåŠ¨å¼•ç”¨è®¡æ•°ä¸‹ï¼ŒOCå¯¹è±¡ä¼šè‡ªåŠ¨åˆå§‹åŒ–ä¸ºnilï¼Œä½†æ˜¯æœ‰äº›å¯¹è±¡ä¸ä¼šè‡ªåŠ¨åˆå§‹åŒ–ä¸ºnilï¼Œä¾‹å¦‚CoreFoundationä¸­çš„å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨å£°æ˜å±€éƒ¨å¯¹è±¡æ—¶éœ€è¦æ‰‹åŠ¨åˆå§‹åŒ–ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">NSObject *obj = nil;</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">NSObject *obj;</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> ä¸è¦ä½¿ç”¨ä¸€ä¸ªç±»å»ç»´æŠ¤å¤šä¸ªç±»çš„å†…å®¹ï¼Œä¾‹å¦‚ä½¿ç”¨ä¸€ä¸ªå¸¸é‡ç±»ç»´æŠ¤æ‰€æœ‰çš„å¸¸é‡ï¼Œè¦æŒ‰åŠŸèƒ½è¿›è¡Œå½’ç±»ï¼Œåˆ†å¼€ç»´æŠ¤ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips: </span><br><span class="line">å¤§è€Œå…¨çš„ç±»ï¼Œæ‚ä¹±æ— ç« ï¼Œä½¿ç”¨æŸ¥æ‰¾åŠŸèƒ½æ‰èƒ½å®šä½åˆ°å…·ä½“ä½ç½®ï¼Œä¸åˆ©äºç†è§£ä¹Ÿä¸åˆ©äºç»´æŠ¤ã€‚</span><br><span class="line"></span><br><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">ç¼“å­˜ç›¸å…³å¸¸é‡ç±»æ”¾åœ¨CacheConstsä¸‹ï¼Œç³»ç»Ÿé…ç½®ç›¸å…³å¸¸é‡ç±»æ”¾åœ¨SystemConfigConstsä¸‹ã€‚</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> å¦‚æœè¶…ç±»çš„æŸä¸ªåˆå§‹åŒ–æ–¹æ³•ä¸é€‚ç”¨äºå­ç±»ï¼Œé‚£ä¹ˆå­ç±»ä¸€å®šè¦é‡å†™è¶…ç±»çš„è¿™ä¸ªæ–¹æ³•è§£å†³é—®é¢˜æˆ–æŠ›å‡ºå¼‚å¸¸ã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> æŠŠä¸€äº›ç¨³å®šçš„ã€å…¬å…±çš„å˜é‡æˆ–è€…æ–¹æ³•æŠ½å–åˆ°çˆ¶ç±»ä¸­ã€‚å­ç±»å°½é‡åªç»´æŒçˆ¶ç±»æ‰€ä¸å…·å¤‡çš„ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> ç¦æ­¢å°†å¸ƒå°”å¯¹è±¡ç›´æ¥å’Œ YES æˆ–è€… NOè¿›è¡Œåˆ¤æ–­ï¼Œä¾‹å¦‚ &#x3D;&#x3D; YESï¼Œ !&#x3D; YESï¼Œ&#x3D;&#x3D; NOï¼Œ!&#x3D; NOã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips:</span><br><span class="line">åœ¨32ä½æœºå™¨ä¸ŠYESè¢«å®šä¹‰ä¸º1ï¼ŒNOå®šä¹‰ä¸º0ï¼›</span><br><span class="line">è€Œ64ä½æœºå™¨ä¸ŠYESè¢«å®šä¹‰ä¸ºé0ï¼ŒNOå®šä¹‰ä¸º0ï¼›</span><br><span class="line"></span><br><span class="line">BOOL result = 4;</span><br><span class="line"></span><br><span class="line">if (result == YES) &#123;</span><br><span class="line">    NSLog(@&quot;YES&quot;);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    NSLog(@&quot;NO&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ä»¥ä¸Šä»£ç åœ¨64ä½æœºå™¨ä¼šè¾“å‡ºYESï¼Œè€Œä¸Š32ä½æœºå™¨ä¸Šåˆ™ä¼šè¾“å‡ºNOã€‚å› ä¸ºåœ¨32ä½æœºå™¨ä¸Š </span><br><span class="line">(result == YES) ä¼šè¢«è§£é‡Šä¸º (4 == (signed int) 1)ï¼Œ</span><br><span class="line">æ‰€ä»¥ä¼šè¾“å‡ºNOï¼Œè€Œåœ¨64ä½æœºå™¨ä¸Šä¼šè®¤ä¸ºresultä¸ç­‰äº0æ‰€ä»¥è¾“å‡ºYESã€‚</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> åˆ é™¤ä»£ç æ—¶å°†å†…éƒ¨ç”¨åˆ°çš„æ— ç”¨æ–‡ä»¶ã€æ— ç”¨ç±»ã€æ— ç”¨å‡½æ•°ç­‰ç»Ÿä¸€åˆ é™¤å¹²å‡€ã€‚</p></li><li><p><strong>[å»ºè®®]</strong> å¦‚æœå¯ä»¥ï¼Œå°½é‡ä½¿ç”¨ #undef é™åˆ¶å®çš„ä½œç”¨èŒƒå›´ã€‚</p></li><li><p><strong>[å»ºè®®]</strong> å±€éƒ¨å˜é‡å°½é‡å®šä¹‰åœ¨æœ€é è¿‘ä½¿ç”¨å®ƒçš„åœ°æ–¹ã€‚</p></li><li><p><strong>[å»ºè®®]</strong> åœ¨å†™ä¸€äº›ç®€å•çš„ç±»æ–¹æ³•å’Œå®æ–¹æ³•æ—¶ï¼Œå°½é‡ä½¿ç”¨å†…è”å‡½æ•°æˆ–å…¨å±€å‡½æ•°ä»£æ›¿å®ƒã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips:</span><br><span class="line">å‡½æ•°ä¸é€šè¿‡å¯¹è±¡è°ƒç”¨ï¼Œæ‰€ä»¥ä¸ä¼šèµ°OCçš„æ¶ˆæ¯è½¬å‘æµç¨‹ï¼Œæ•ˆç‡é«˜äºæ–¹æ³•è°ƒç”¨ï¼›</span><br><span class="line">è€Œä¸”å‡½æ•°ä¼šæœ‰è¿”å›å€¼å’Œå‚æ•°ç±»å‹ä»¥åŠå‚æ•°æ£€æŸ¥ï¼Œè¿™äº›éƒ½æ˜¯å®å®šä¹‰æ²¡æœ‰çš„ã€‚</span><br><span class="line"></span><br><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">UIKIT_STATIC_INLINE NSString * kNSStringFromInteger(NSInteger a) &#123;</span><br><span class="line">    return [NSString stringWithFormat:@&quot;%zd&quot;, a];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">#define kNSStringFromInteger(a) [NSString stringWithFormat:@&quot;%zd&quot;, a]</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> å¦‚æœç”¨åˆ°äº†å¾ˆå¤šåè®®ï¼Œå¿…è¦æ—¶å¯ä»¥æŠŠåè®®å°è£…åˆ°ä¸€ä¸ªå•ç‹¬çš„å¤´æ–‡ä»¶ä¸­ï¼Œè¿™æ ·åšä¸ä»…å¯ä»¥å‡å°‘ç¼–è¯‘æ—¶é—´ï¼Œè¿˜èƒ½é¿å…å¾ªç¯å¼•ç”¨ã€‚</p></li><li><p><strong>[å»ºè®®]</strong> ä½¿ç”¨switchæšä¸¾æ—¶å°½é‡å°†æ‰€æœ‰æšä¸¾ç±»å‹éƒ½caseå‡ºæ¥è€Œä¸è¦ä½¿ç”¨defaultï¼Œè¿™æ ·çš„è¯ä»¥åå¢åŠ æˆ–åˆ é™¤æšä¸¾ç±»å‹æ—¶å¦‚æœswitchæ²¡æœ‰å¤„ç†çš„è¯ç¼–è¯‘å™¨ä¼šæœ‰è­¦å‘Šæé†’ã€‚</p></li><li><p><strong>[å»ºè®®]</strong> å°½é‡ä½¿ç”¨å­—é¢é‡è¯­æ³•åˆ›å»ºå¯¹è±¡ï¼Œå°‘ç”¨ä¸ä¹‹ç­‰ä»·çš„æ–¹æ³•ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips:</span><br><span class="line">OCä¸­çš„NSArrayã€NSStringã€NSDictionaryã€NSNumberéƒ½æœ‰ä¸ä¹‹å¯¹åº”çš„å­—é¢é‡è¯­æ³•: @[]ã€@&quot;&quot;ã€@&#123;&#125;ã€@()ï¼›</span><br><span class="line">ä½¿ç”¨å®ƒä»¬æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š</span><br><span class="line">1. ç®€å•æ˜“è¯»ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§å’Œç»´æŠ¤æ€§ã€‚</span><br><span class="line">2. ä½¿ç”¨å­—é¢é‡åˆ›å»ºæ•°ç»„ã€å­—å…¸æ—¶å¦‚æœå…ƒç´ é‡Œåœ¨nilåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œ</span><br><span class="line">   è€Œä½¿ç”¨arrayWithObjects:æ–¹æ³•åˆ›å»ºåˆ™ä¼šä¸¢å¤±nilåçš„æ•°æ®ï¼Œ</span><br><span class="line">   æŠ›å‡ºå¼‚å¸¸èƒ½è®©ä½ çŸ¥é“è¿™é‡Œæœ‰é—®é¢˜åŠæ—¶ä¿®æ”¹é˜²æ­¢é—®é¢˜åœ¨çº¿ä¸Šå‘ç”Ÿã€‚</span><br><span class="line"></span><br><span class="line">ç¼ºç‚¹ï¼š</span><br><span class="line">1. ä½¿ç”¨å­—é¢é‡åˆ›å»ºçš„å¯¹è±¡é»˜è®¤æ˜¯ä¸å¯å˜çš„ï¼Œå¦‚æœè¦åˆ›å»ºå¯å˜å¯¹è±¡éœ€è¦è¿›è¡ŒmutableCopyæ“ä½œã€‚</span><br><span class="line">2. ä¸æ”¯æŒå­ç±»ï¼Œå¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªNSStringçš„å­ç±»ï¼Œ@&quot;&quot;å¹¶ä¸ä¼šè¿”å›ä½ æƒ³è¦çš„å­ç±»å¯¹è±¡ã€‚</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> UIæ§ä»¶å°½é‡ä½¿ç”¨weakä¿®é¥°è€Œä¸æ˜¯strongä¿®é¥°ï¼Œè¿™æ ·å¯¹æ¢³ç†å¯¹è±¡å¼•ç”¨ä¼šæ›´æ¸…æ™°æ˜äº†ã€‚</p></li><li><p><strong>[å»ºè®®]</strong> å°½é‡ä¸è¦ä½¿ç”¨+loadæ–¹æ³•ï¼Œå¦‚æœå¿…é¡»è¦ä½¿ç”¨é‚£ä¹ˆä¸è¦åœ¨æ–¹æ³•å†…å®ç°å¤æ‚é€»è¾‘æˆ–å µå¡çº¿ç¨‹ã€‚</p></li><li><p><strong>[å»ºè®®]</strong> å°½é‡å‡å°‘ç»§æ‰¿å±‚çº§ï¼Œç±»çš„ç»§æ‰¿å»ºè®®ä¸è¦è¶…è¿‡3å±‚ï¼Œå¿…è¦æ—¶åˆ»å¯ä»¥è€ƒè™‘ç”¨åˆ†ç±»ã€åè®®æ¥ä»£æ›¿ç»§æ‰¿ã€‚</p></li></ul><h2 id="å¤´æ–‡ä»¶è§„èŒƒ"><a href="#å¤´æ–‡ä»¶è§„èŒƒ" class="headerlink" title="å¤´æ–‡ä»¶è§„èŒƒ"></a>å¤´æ–‡ä»¶è§„èŒƒ</h2><ul><li><p><strong>[å¿…é¡»]</strong> å¤´æ–‡ä»¶ä¸­å°½é‡ä¸è¦ç›´æ¥å¼•ç”¨å…¶ä»–å¤´æ–‡ä»¶ï¼Œè€Œæ˜¯ä½¿ç”¨@classå‘å‰å£°æ˜ï¼Œæ¯æ¬¡å¼•å…¥å…¶ä»–å¤´æ–‡ä»¶æ—¶å…ˆé—®é—®è‡ªå·±æ˜¯å¦å¿…é¡»è¦è¿™æ ·åšã€‚</p></li><li><p><strong>[å»ºè®®]</strong> å¤´æ–‡ä»¶ä¸­æš´éœ²çš„æ–¹æ³•å’Œå±æ€§å°½å¯èƒ½å°‘ï¼Œä¾‹å¦‚å¤–éƒ¨åªéœ€è¦è¦†å€¼æ“ä½œï¼Œé‚£å°±ä¸è¦æä¾›getteræ–¹æ³•æˆ–è€…å±æ€§ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">@interface BookView : NSObject</span><br><span class="line"></span><br><span class="line">- (void)setBookName:(NSString *)bookName;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">@interface BookView : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic, strong) NSString *bookName;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> å¤´æ–‡ä»¶ä¸­çš„å±æ€§å°½é‡å£°æ˜ä¸ºåªè¯»ï¼Œå¯ä»¥åœ¨å®ç°æ–‡ä»¶ä¸­å†å°†å±æ€§å£°æ˜ä¸ºå¯è¯»å¯å†™ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">@interface WXYZModel : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic, readonly) NSString *name;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface WXYZModel ()</span><br><span class="line"></span><br><span class="line">@property (nonatomic, strong) NSString *name;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation WXYZModel</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure></li></ul><h2 id="Blockå¼€å‘è§„èŒƒ"><a href="#Blockå¼€å‘è§„èŒƒ" class="headerlink" title="Blockå¼€å‘è§„èŒƒ"></a>Blockå¼€å‘è§„èŒƒ</h2><ul><li><p><strong>[å¿…é¡»]</strong> åœ¨Blockå†…éƒ¨ä½¿ç”¨ä¸Šä¸‹æ–‡çš„å¯¹è±¡æ—¶è¦æ³¨æ„ç›¸äº’å¼•ç”¨çš„é—®é¢˜(<code>ä¸ä¸€å®šè¦åœ¨ block å†…ä½¿ç”¨ self æ‰ä¼šç›¸äº’å¼•ç”¨</code>)ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips: </span><br><span class="line">1. ä¸ä¸€å®šåœ¨Blockå†…ä½¿ç”¨selfæ‰ä¼šç›¸äº’å¼•ç”¨ï¼Œå¦‚ä¸‹æƒ…å†µä¹Ÿä¼šé€ æˆå¾ªç¯å¼•ç”¨:</span><br><span class="line">- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath &#123;</span><br><span class="line">    WXYZ_TitleTableViewCell *cell = â€¦â€¦â€¦</span><br><span class="line">    </span><br><span class="line">    cell.refreshTableViewBlock = ^&#123;</span><br><span class="line">        [tableView reloadData];</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    return cell;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">2. Blockå†…éƒ¨æ˜¯å¦è¦ä½¿ç”¨weakéœ€è¦çœ‹Blockæœ¬èº«å’Œweakçš„è¿™ä¸ªå¯¹è±¡æ˜¯å¦å­˜åœ¨ç›´æ¥æˆ–é—´æ¥çš„ç›¸äº’å¼•ç”¨ï¼Œ</span><br><span class="line">   è‹¥æ— ç›¸äº’å¼•ç”¨åˆ™ä¸éœ€è¦ä½¿ç”¨weakã€‚</span><br><span class="line"></span><br><span class="line">3. å¦‚æœBlockå†…éƒ¨ä½¿ç”¨äº†strongä¿®é¥°äº†å¤–éƒ¨çš„weakå˜é‡ï¼Œé‚£ä¹ˆå½“ä½¿ç”¨strongæŒ‡å‘æˆå‘˜å˜é‡æ—¶éœ€è¦è¿›è¡Œåˆ¤ç©ºï¼Œå¦åˆ™ä¼šå´©æºƒï¼Œå‚è€ƒä»¥ä¸‹ä»£ç :</span><br><span class="line">__weak typeof(self) weakSelf = self;</span><br><span class="line">    cell.refreshTableViewBlock = ^&#123;</span><br><span class="line">        __strong typeof(weakSelf) strongSelf = weakSelf;</span><br><span class="line">        if (strongSelf != nil) &#123;</span><br><span class="line">            strongSelf-&gt;_name = @&quot;name&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">å¦‚æœæŠŠ(strongSelf != nil)çš„åˆ¤æ–­å»æ‰é‚£ä¹ˆå¯èƒ½ä¼šå´©æºƒã€‚</span><br></pre></td></tr></table></figure></li></ul><h2 id="é€šçŸ¥å¼€å‘è§„èŒƒ"><a href="#é€šçŸ¥å¼€å‘è§„èŒƒ" class="headerlink" title="é€šçŸ¥å¼€å‘è§„èŒƒ"></a>é€šçŸ¥å¼€å‘è§„èŒƒ</h2><ul><li><p><strong>[å¿…é¡»]</strong> åœ¨å‘é€é€šçŸ¥æ—¶ï¼Œè¯·ä½¿ç”¨<code>userInfo</code>å¯¹è±¡è¿›è¡Œä¼ å€¼ï¼Œè€Œä¸æ˜¯<code>object</code>ã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> é¿å…é‡å¤æ³¨å†Œé€šçŸ¥ï¼Œè¿™ä¼šå¯¼è‡´é‡å¤æ‰§è¡Œé€šçŸ¥æ–¹æ³•ã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> åœ¨ä½¿ç”¨é€šçŸ¥çš„<code>object</code>å‚æ•°æ—¶ï¼Œéœ€è¦ç¡®ä¿æ¥æ”¶æ–¹å’Œå‘é€æ–¹çš„objectå¯¹è±¡ç±»å‹æ˜¯ä¸€è‡´çš„ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">åä¾‹ï¼š</span><br><span class="line">[NSNotificationCenter.defaultCenter addObserver:self selector:@selector(testFunction) name:@&quot;testNotificationName&quot; object:model.bookID];</span><br><span class="line">[NSNotificationCenter.defaultCenter postNotificationName:@&quot;testNotificationName&quot; object:@&quot;123&quot;];</span><br><span class="line"></span><br><span class="line">å‡è®¾ model.bookID çš„å€¼å°±æ˜¯å­—ç¬¦ä¸²123ï¼Œä¹Ÿå¯èƒ½æ— æ³•æ”¶åˆ°é€šçŸ¥ï¼Œ</span><br><span class="line">å› ä¸ºNSStringæœ‰__NSCFConstantStringï¼Œ __NSCFStringï¼Œ NSTaggedPointerStringç­‰å¤šä¸ªå­ç±»å¯¹è±¡ï¼Œ</span><br><span class="line">å¦‚æœ model.bookID çš„çœŸå®å¯¹è±¡ç±»å‹æ˜¯ NSTaggedPointerString çš„è¯å°±ä¼šæ”¶ä¸åˆ°é€šçŸ¥ã€‚</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> åœ¨å·¥ç¨‹é‡Œèƒ½ä¸ç”¨é€šçŸ¥å°½é‡ä¸ç”¨é€šçŸ¥ï¼Œé€šçŸ¥è™½ç„¶çµæ´»å¼ºå¤§ï¼Œä½†æ˜¯å¦‚æœæ»¥ç”¨ä¼šå¯¼è‡´å·¥ç¨‹è´¨é‡ä¸‹é™å¹¶ä¸”å¢åŠ ç»´æŠ¤éš¾åº¦ã€‚</p></li></ul><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol><li><a href="https://book.douban.com/subject/25829244/">Effective Objective-C 2.0  ç¼–å†™é«˜è´¨é‡iOSä¸OS Xä»£ç çš„52ä¸ªæœ‰æ•ˆæ–¹æ³•</a></li><li><a href="https://google.github.io/styleguide/objcguide.html">Googleçš„Objective-Cé£æ ¼æŒ‡å—</a></li><li><a href="https://google.github.io/eng-practices/review/reviewer/">Googleçš„ä»£ç å®¡æŸ¥æŒ‡å—</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
          <category> å¼€å‘è§„èŒƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ObjC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gitå‘½ä»¤æ‰‹å†Œ</title>
      <link href="/2021/08/11/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Git%E5%91%BD%E4%BB%A4%E6%89%8B%E5%86%8C/"/>
      <url>/2021/08/11/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Git%E5%91%BD%E4%BB%A4%E6%89%8B%E5%86%8C/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç”± å¸ƒå¤š(budo) å‘å¸ƒäº 2021-08-11</p></blockquote><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><hr><p>&nbsp;&nbsp;&nbsp;&nbsp;è¯¥æ‰‹å†Œ(ä»¥ä¸‹ç®€ç§°å®ƒ)ä¸æ˜¯Gitå…¥é—¨æ•™ç¨‹ï¼Œå¦‚æœæ‚¨æƒ³å…¥é—¨Gitæ¨è<a href="https://www.liaoxuefeng.com/wiki/896043488029600">å»–é›ªå³°çš„Gitæ•™ç¨‹</a></p><p>&nbsp;&nbsp;&nbsp;&nbsp;è¿™åªæ˜¯ä¸€ç¯‡ä¸ªäººå­¦ä¹ Gitæ—¶é¡ºå¸¦è®°å½•çš„å‘½ä»¤æ‰‹å†Œä»¥åŠå¯¹Gitçš„ä¸€äº›ç†è§£å¿ƒå¾—ï¼Œå¦‚æœ‰ä¸æ­£ç¡®çš„åœ°æ–¹æ¬¢è¿å¤§å®¶ç•™è¨€æŒ‡æ­£ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;å®ƒåŒ…å«äº†Gitå‡ ä¹æ‰€æœ‰çš„é«˜çº§å‘½ä»¤å’Œéƒ¨åˆ†åº•å±‚å‘½ä»¤ï¼Œæ¯ä¸ªå‘½ä»¤éƒ½æœ‰è¯¦ç»†çš„è§£é‡Šå’Œç¤ºä¾‹å‘Šè¯‰æ‚¨å¦‚ä½•ä½¿ç”¨ï¼Œä»¥åŠä½¿ç”¨æ—¶éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼›å†…å®¹æŒ‰æ¨¡å—åˆ’åˆ†ï¼Œæ¯”å¦‚å’Œ<code>add</code>ç›¸å…³çš„å‘½ä»¤å°±éƒ½ä¼šé›†ä¸­åœ¨ä¸€ä¸ªæ¨¡å—ï¼Œå¤§å®¶å¯ä»¥é€‰æ‹©è‡ªå·±æ„Ÿå…´è¶£çš„æ¨¡å—è‡ªç”±é˜…è¯»ï¼Œç”±äºæŸäº›å‘½ä»¤çš„é€‰é¡¹éå¸¸å¤šä½†æ˜¯å¹¶ä¸å¸¸ç”¨ï¼Œæ‰€ä»¥è¯¥æ‰‹å†Œå¯èƒ½æ²¡æœ‰è®°å½•ï¼Œå¦‚æœæƒ³æŸ¥çœ‹æŸä¸ªå‘½ä»¤çš„æ‰€æœ‰é€‰é¡¹è¯·æŸ¥é˜…<a href="https://git-scm.com/docs">Gitå‘½ä»¤å‚è€ƒ</a>ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;æœ‰äº›æ¯”è¾ƒç®€å•çš„å‘½ä»¤è¿™é‡Œå¯èƒ½æ²¡æœ‰è®°å½•ï¼Œæ–‡ç« ä¸­çš„()è¡¨ç¤ºçš„æ˜¯å…¨ç§°ï¼Œä¾‹å¦‚{u(upstream)}ï¼Œè¡¨ç¤ºupstreamæ˜¯uçš„å…¨ç§°ï¼Œå®é™…ä½¿ç”¨çš„æ—¶å€™ç”¨@{u}æˆ–è€…@{upstream}éƒ½å¯ä»¥ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;Gitæœ¬èº«æ˜¯ä¸€ä¸ªå†…å®¹å¯»å€æ–‡ä»¶ç³»ç»Ÿï¼ŒGitçš„æ ¸å¿ƒéƒ¨åˆ†æ˜¯ä¸€ä¸ªç®€å•çš„é”®å€¼å¯¹æ•°æ®åº“ï¼Œä½ å¯ä»¥å‘Gitä»“åº“ä¸­æ’å…¥ä»»æ„ç±»å‹çš„å†…å®¹ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªå”¯ä¸€çš„é”®ï¼Œé€šè¿‡è¯¥é”®å¯ä»¥åœ¨ä»»æ„æ—¶åˆ»å†æ¬¡å–å›è¯¥å†…å®¹ã€‚</p><blockquote><p>Tipsï¼š </p><ol><li><p>Gité‡Œä¸€äº›åŒåçš„é€‰é¡¹åœ¨ç›¸ä¼¼çš„åœ°æ–¹ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚ä¾‹å¦‚<code>--abort</code>é€‰é¡¹ï¼Œå’Œ<code>git merge --abort</code>æ­é…å¯ä»¥æ’¤é”€åˆå¹¶æ“ä½œï¼Œå’Œ<code>git rebase --abort</code>æ­é…å¯ä»¥æ’¤é”€rebaseæ“ä½œã€‚</p></li><li><p>Gité‡Œçš„å¤§éƒ¨åˆ†é€‰é¡¹éƒ½æ˜¯å¯ä»¥æ­é…ä¸€èµ·ä½¿ç”¨çš„ï¼Œä¾‹å¦‚<code>git log --author=&#39;internetwei&#39; --after=&quot;2020-01-01&quot; --before=&quot;2020-06-01&quot; --no-merges -- WXReader/Book/BookRack/BookReader</code><br>è¿™è¡Œå‘½ä»¤æ­é…äº†å¤šè¾¾5ä¸ªé€‰é¡¹(æŒ‡å®šä½œè€…ï¼ŒæŒ‡å®šå¼€å§‹æ—¶é—´ï¼ŒæŒ‡å®šç»“æŸæ—¶é—´ï¼Œéåˆå¹¶æäº¤ï¼ŒæŒ‡å®šè·¯å¾„)ï¼Œ å®ƒçš„æ„æ€æ˜¯ï¼šæ‰“å°<code>internetwei</code>ä½œè€…åœ¨2020å¹´1æœˆ1å·åˆ°2020å¹´6æœˆ1å·ä¹‹é—´å¯¹<code>WXReader/Book/BookRack/BookReader</code>è¿™ä¸ªæ–‡ä»¶å¤¹(åŒ…æ‹¬æ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰æ–‡ä»¶)è¿›è¡Œä¿®æ”¹çš„æ‰€æœ‰æäº¤è®°å½•ä½†ä¸åŒ…æ‹¬åˆå¹¶æäº¤ã€‚</p></li><li><p>Gité‡Œéœ€è¦ä½¿ç”¨å“ˆå¸Œå€¼çš„åœ°æ–¹ä¸éœ€è¦å¤åˆ¶æ•´ä¸ªå“ˆå¸Œå­—ç¬¦ä¸²ï¼Œé€šå¸¸åªéœ€è¦å¤åˆ¶å‰6~8ä¸ªå­—ç¬¦å°±å¤Ÿäº†ï¼Œå¦‚æœé¡¹ç›®æ¯”è¾ƒå¤§å¯ä»¥æ‰©å¤§åˆ°å‰8~10ä¸ªï¼Œå³ä½¿æ˜¯åƒ<code>Linux</code>è¿™æ ·çš„é¡¹ç›®ä¹Ÿåªéœ€è¦å‰10~12ä¸ªå­—ç¬¦å³å¯ä¿è¯å”¯ä¸€æ€§ã€‚</p></li></ol></blockquote><h3 id="Gitçš„ç‰¹ç‚¹"><a href="#Gitçš„ç‰¹ç‚¹" class="headerlink" title="Gitçš„ç‰¹ç‚¹"></a>Gitçš„ç‰¹ç‚¹</h3><hr><ol><li><p>Gitå’ŒSVN(å…¶ä»–ç‰ˆæœ¬æ§åˆ¶å·¥å…·)å¯¹å¾…æ–‡ä»¶çš„åŒºåˆ«ï¼Ÿ</p><blockquote><p>Gitä¿å­˜çš„ä¸æ˜¯æ–‡ä»¶çš„å·®å¼‚æˆ–å˜åŒ–ï¼Œè€Œæ˜¯æ–‡ä»¶å¿«ç…§(å¿«ç…§å¯ä»¥ç®€å•çš„ç†è§£ä¸ºè¿™ä¸ªæ–‡ä»¶çš„å‰¯æœ¬)ï¼Œå¦‚æœä¸€ä¸ªæ–‡ä»¶åœ¨æäº¤çš„æ—¶å€™æ²¡æœ‰ä»»ä½•å˜åŒ–é‚£ä¹ˆGitåªä¼šä¿ç•™ä¸€ä¸ªé“¾æ¥æŒ‡å‘ä¹‹å‰å­˜å‚¨çš„å†…å®¹ï¼›è€ŒSVNä¿å­˜çš„æ˜¯è¿™ä¸ªæ–‡ä»¶æäº¤æ—¶çš„å·®å¼‚å˜åŒ–ã€‚ </p></blockquote></li><li><p>Gitå¦‚ä½•ä¿è¯å®Œæ•´æ€§?</p><blockquote><p>Gitæ‰€æœ‰çš„æ•°æ®åœ¨å­˜å‚¨å‰éƒ½ä¼šè®¡ç®—æ ¡éªŒå’Œï¼Œè®¡ç®—æ ¡éªŒå’Œçš„æœºåˆ¶å«åšSHAï¼1æ•£åˆ—(hashã€å“ˆå¸Œ)ï¼Œè¿™æ˜¯ä¸€ä¸ªç”±40ä¸ª16è¿›åˆ¶å­—ç¬¦(0<del>9,a</del>f)ç»„æˆçš„å­—ç¬¦ä¸²ï¼ŒåŸºäºæ–‡ä»¶çš„å†…å®¹å’Œç›®å½•ç»“æ„è®¡ç®—å‡ºæ¥çš„(ç”±äºç›¸åŒçš„æ–‡ä»¶è®¡ç®—å‡ºæ¥çš„å“ˆå¸Œå€¼æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥å½“ä½ å­˜å‚¨ä¸€ä¸ªæ–‡ä»¶åˆ°Gitä»“åº“æ—¶ï¼Œå¦‚æœGitå‘ç°å·²ç»æœ‰äº†å°±åªä¼šåˆ›å»ºä¸€ä¸ªé“¾æ¥æŒ‡å‘ä¹‹å‰å­˜å‚¨çš„é‚£ä¸ªå¯¹è±¡)ï¼Œè®¡ç®—å‡ºæ¥çš„å“ˆå¸Œå€¼å°±åƒè¿™æ ·ï¼š<code>a6b6695a3594cc79b3c3fa9ef5772df036ec8d8e</code>ï¼Œæ ¡éªŒå’Œçš„å‰ä¸¤ä¸ªå­—ç¬¦ç”¨äºå‘½åå­ç›®å½•ï¼Œå‰©ä¸‹çš„38ä¸ªå­—ç¬¦åˆ™ç”¨ä½œæ–‡ä»¶åï¼ŒGitæ•°æ®åº“ä¸­ä¿å­˜çš„ä¿¡æ¯éƒ½æ˜¯ä»¥å“ˆå¸Œå€¼æ¥ç´¢å¼•ã€‚</p></blockquote></li><li><p>Gitæš‚å­˜å’Œæäº¤æ—¶åˆ†åˆ«åšäº†ä»€ä¹ˆï¼Ÿ</p><blockquote><p>å½“ä½ è¿›è¡Œæš‚å­˜æ“ä½œæ—¶ï¼ŒGitä¼šå¯¹æ¯ä¸ªæ–‡ä»¶è®¡ç®—æ ¡éªŒå’Œï¼Œç„¶åå°†è¿™äº›æ ¡éªŒå’ŒåŠ å…¥åˆ°æš‚å­˜åŒºç­‰å¾…æäº¤ã€‚</p><p>å½“ä½ è¿›è¡Œæäº¤æ“ä½œæ—¶ï¼ŒGitä¼šè®¡ç®—æ¯ä¸ªå­ç›®å½•çš„æ ¡éªŒå’Œä»¥åŠå¯¹æ‰€æœ‰çš„æ–‡ä»¶åˆ›å»ºå¿«ç…§å¹¶ä¿å­˜å¿«ç…§çš„ç´¢å¼•ï¼Œç„¶åGitä¼šåœ¨ä»“åº“ä¸­æŠŠè¿™äº›æ ¡éªŒå’Œä¿å­˜ä¸ºä¸€ä¸ªæ ‘å¯¹è±¡ï¼Œç„¶åGitä¼šåˆ›å»ºä¸€ä¸ªæäº¤å¯¹è±¡ï¼Œå®ƒåŒ…å«ä¸€ä¸ªæŒ‡å‘æœ€ä¸Šå±‚æ ‘å¯¹è±¡çš„æŒ‡é’ˆå’Œä¸€ä¸ªæŒ‡å‘çˆ¶å¯¹è±¡çš„æŒ‡é’ˆ(å¦‚æœæ˜¯åˆå¹¶æäº¤ä¼šæœ‰2ä¸ªçˆ¶å¯¹è±¡ï¼Œå¦‚å›¾1)ï¼Œè¿˜æœ‰ä½œè€…çš„åç§°ã€é‚®ç®±åœ°å€ã€æäº¤è¯´æ˜ã€‚</p></blockquote><p> <img src="50c7be27cd9a4bca9c4a75c2f7df54ea~tplv-k3u1fbpfcp-zoom-1.image"> å›¾1</p></li><li><p>Gitæš‚å­˜åŒºçš„ä½œç”¨</p><blockquote><p>å¤§éƒ¨åˆ†çš„ç‰ˆæœ¬ç®¡ç†(SVN)éƒ½æ²¡æœ‰æš‚å­˜åŒºçš„æ¦‚å¿µï¼ŒGitçš„addå‘½ä»¤å’Œå…¶ä»–ç±»ä¼¼å·¥å…·çš„addå‘½ä»¤ä¹Ÿä¸å¤ªä¸€æ ·ï¼Œå…¶ä»–å·¥å…·çš„addå‘½ä»¤æ˜¯å°†æ–‡ä»¶åŠ å…¥åˆ°ç‰ˆæœ¬ç®¡ç†ï¼Œè€ŒGitçš„addå‘½ä»¤æœ‰3ç§ä½œç”¨ï¼š1. å°†æœªè·Ÿè¸ªçš„æ–‡ä»¶åŠ å…¥åˆ°ç‰ˆæœ¬ç®¡ç†ï¼›2. å°†å·²ä¿®æ”¹çš„æ–‡ä»¶å†…å®¹åŠ å…¥åˆ°æš‚å­˜åŒºï¼›3. å°†å†²çªæ–‡ä»¶æ ‡è®°ä¸ºå†²çªå·²è§£å†³çŠ¶æ€ã€‚ç”±äºGitæš‚å­˜åŒºçš„å­˜åœ¨ï¼Œä½ å¯ä»¥åœ¨å®Œæˆæäº¤å‰å®¡æŸ¥ä½ çš„æäº¤å†…å®¹ï¼Œè¿˜å¯ä»¥ç²¾ç¡®çš„æ§åˆ¶æ¯ä¸€è¡Œçš„æäº¤å†…å®¹ã€‚ä¾‹å¦‚ä¸€ä¸ªæ–‡ä»¶æœ‰20è¡Œæ˜¯ä¿®æ”¹BUGï¼Œå¦å¤–æœ‰100è¡Œæ˜¯æ·»åŠ æ–°åŠŸèƒ½ï¼Œç°åœ¨æˆ‘åªæƒ³æäº¤è¿™ä¸ªæ–‡ä»¶çš„ä¿®æ”¹BUGçš„é‚£20è¡Œä»£ç ï¼Œé‚£ä¹ˆåªéœ€è¦æŠŠè¿™20è¡Œä»£ç åŠ å…¥åˆ°æš‚å­˜åŒºå°±è¡Œäº†ã€‚ </p></blockquote></li><li><p>Mergeçš„é€»è¾‘</p><blockquote><p>å¦‚æœGitå‘ç°å¯ä»¥å¿«è¿›åˆå¹¶çš„è¯é‚£ä¹ˆGitä¼šç›´æ¥æŠŠå½“å‰åˆ†æ”¯æŒ‡å‘åˆå¹¶åˆ†æ”¯çš„æœ€æ–°æäº¤(å¿«è¿›åˆå¹¶æœ‰ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯å½“ä½ åˆ é™¤åˆå¹¶åˆ†æ”¯åä¼šæ— æ³•çŸ¥é“è¿™ä¸ªåˆ†æ”¯ä»¥å‰æ˜¯ä»å“ªä¸ªåˆ†æ”¯åˆå¹¶è¿‡æ¥çš„ï¼Œå¦‚æœæƒ³ç¦ç”¨å¿«è¿›åˆå¹¶å¯ä»¥ä½¿ç”¨<code>--no-ff</code>é€‰é¡¹ï¼Œè¿™æ ·Gitä¼šåˆ›å»ºä¸€ä¸ªåˆå¹¶æäº¤)ï¼Œå¦‚æœä¸å¯ä»¥å¿«è¿›åˆå¹¶çš„è¯Gitä¼šä½¿ç”¨è¿™ä¸¤ä¸ªåˆ†æ”¯çš„æœ«ç«¯æäº¤å¯¹è±¡ä»¥åŠè¿™ä¸¤ä¸ªåˆ†æ”¯çš„é¦–ä¸ªå…¬å…±ç¥–å…ˆæäº¤ï¼Œåšä¸€ä¸ªç®€å•çš„ä¸‰æ–¹åˆå¹¶ã€‚</p></blockquote></li><li><p>GPGç­¾å</p><blockquote><p>GPGå¯ä»¥ç­¾åä½ çš„æäº¤æˆ–æ ‡ç­¾ï¼Œå®ƒèƒ½å¤Ÿæœ‰æ•ˆçš„æé«˜Gitä»“åº“çš„å®‰å…¨æ€§ï¼Œå› ä¸ºå®ƒå¯ä»¥è¯æ˜è¿™ä¸ªæäº¤æˆ–æ ‡ç­¾æ˜¯é€šè¿‡ä½ ä¿¡ä»»çš„ç”µè„‘æäº¤çš„è€Œä¸æ˜¯æŸä¸ªå†’ç”¨ä½ åå·çš„é»‘å®¢ï¼Œè¿™ç›¸å½“äºèµ‹äºˆäº†æäº¤å¯¹è±¡ä¸€ç§ä¸å¯æ›´æ”¹æ€§ï¼Œå³ä½¿é»‘å®¢é€šè¿‡æŸç§åŠæ³•æ‹¿åˆ°äº†Gitä»“åº“çš„è¯»å†™æƒï¼Œä»–ä¹Ÿæ²¡æœ‰åŠæ³•æ·»åŠ æˆ–ä½¿ç”¨â€“forceä¿®æ”¹ä»»ä½•å¸¦æœ‰ä½ GPGç­¾åçš„æäº¤æˆ–æ ‡ç­¾ã€‚</p><p>ç”±äºGitçš„ä½œè€…åç§°å’Œé‚®ç®±åœ°å€æ˜¯å¯ä»¥éšæ„å¡«å†™çš„ï¼Œå¦‚æœæœ‰äººå°†ä»–çš„ä½œè€…åç§°å’Œé‚®ç®±åœ°å€æ”¹æˆå’Œä½ çš„ä¸€æ ·ï¼Œç„¶åé€šè¿‡æŸç§æ–¹å¼å°†ä»£ç æ¨é€åˆ°äº†ä½ çš„ä»“åº“ä¸­â€¦â€¦è¿™å¯èƒ½ä¼šå¯¼è‡´ä½ æˆ–å…¶ä»–äººé­å—æŸå¤±ï¼Œä½¿ç”¨GPGç­¾åå¯ä»¥å°½é‡é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿã€‚ä½¿ç”¨GPGç­¾åè¿‡çš„æäº¤åœ¨Githubä¸Šæ˜¾ç¤ºå¦‚å›¾2ï¼Œä½ å¯ä»¥ç‚¹å‡»æ ‡ç­¾æŸ¥çœ‹å…·ä½“çš„ç­¾åä¿¡æ¯ã€‚<br> <img src="5e21c63b735445c6b17e2d4790a291a1~tplv-k3u1fbpfcp-zoom-1.image"> å›¾2 </p></blockquote></li><li><p>HEADæ˜¯ä»€ä¹ˆï¼Ÿ</p><blockquote><p>HEADæœ¬è´¨å°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä¹Ÿå¯ä»¥å«åšç¬¦å·æŒ‡é’ˆï¼Œå› ä¸ºé€šå¸¸æƒ…å†µä¸‹å®ƒæŒ‡å‘ä¸€ä¸ªåˆ†æ”¯(ç¬¦å·)ï¼Œé€šè¿‡å®ƒå¯ä»¥è·å–ä½ ä»“åº“å½“å‰çš„çŠ¶æ€ï¼Œå¯ä»¥ä½¿ç”¨<code>git symbolic-ref HEAD</code>æŸ¥çœ‹å½“å‰HEADçš„çŠ¶æ€ã€‚</p><p>å½“HEADæŒ‡å‘ä¸€ä¸ªå…·ä½“çš„æäº¤å¯¹è±¡è€Œä¸æ˜¯åˆ†æ”¯å¼•ç”¨æ—¶ï¼ŒGitä¼šæç¤ºæ‚¨å¤„äºâ€œæ¸¸ç¦»çŠ¶æ€â€ï¼Œâ€œæ¸¸ç¦»çŠ¶æ€â€è¡¨ç¤ºä½ å½“å‰ä¸å¤„äºä»»ä½•åˆ†æ”¯ï¼Œæ‰€ä»¥ä½ ä¸èƒ½è¿›è¡Œæäº¤ï¼Œåªèƒ½æŸ¥çœ‹æäº¤å¿«ç…§çš„å†…å®¹ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œä¿®æ”¹è¿è¡Œï¼Œå¦‚æœä½ æƒ³è¦è¿›è¡Œæäº¤åˆ™éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªåˆ†æ”¯ï¼Œâ€œæ¸¸ç¦»çŠ¶æ€â€é€šå¸¸ç”¨äºè°ƒè¯•æˆ–å›æ»šæŸæ¬¡æäº¤ã€‚ </p></blockquote></li><li><p>HEAD^å’ŒHEAD~çš„åŒºåˆ«ï¼Ÿ</p><blockquote><p>å½“åé¢ä¸è·Ÿæ•°å­—çš„æ—¶å€™^å’Œ~è¡¨ç¤ºçš„æ„æ€ç›¸åŒï¼Œéƒ½è¡¨ç¤ºç¬¬1ä¸ªçˆ¶æäº¤å¯¹è±¡ï¼›å¦‚æœåé¢è·Ÿä¸Šæ•°å­—å°±æœ‰å·®åˆ«äº†ï¼Œ^åé¢åªèƒ½è·Ÿæ•°å­—1æˆ–è€…æ•°å­—2ï¼Œ^1è¡¨ç¤ºå½“å‰å¯¹è±¡çš„ç¬¬1çˆ¶æäº¤ï¼Œ^2è¡¨ç¤ºå½“å‰å¯¹è±¡çš„ç¬¬2çˆ¶æäº¤ï¼Œåªæœ‰åˆå¹¶æäº¤å¯¹è±¡æ‰æœ‰ç¬¬2çˆ¶æäº¤ï¼Œç¬¬1çˆ¶æäº¤å°±æ˜¯åˆå¹¶æ—¶æ¥å—åˆå¹¶çš„åˆ†æ”¯ï¼Œç¬¬2çˆ¶æäº¤å°±æ˜¯åˆå¹¶æ—¶è¢«åˆå¹¶çš„é‚£ä¸ªåˆ†æ”¯ï¼›~åé¢ç†è®ºä¸Šå¯ä»¥è·Ÿä»»æ„å¤§äº0çš„æ•°å­—ï¼Œ~1è¡¨ç¤ºå½“å‰æäº¤å¯¹è±¡çš„ç¬¬1ä¸ªçˆ¶æäº¤å¯¹è±¡ï¼Œ~2è¡¨ç¤ºå½“å‰æäº¤å¯¹è±¡çš„ç¬¬2ä¸ªçˆ¶æäº¤å¯¹è±¡ï¼Œä»¥æ­¤ç±»æ¨ï¼Œ~2å’Œ~~è¡¨è¾¾åŒä¸€ä¸ªæ„æ€ï¼Œä¸è¿‡å½“ä½ æƒ³è¡¨ç¤ºç¬¬100ä¸ªçˆ¶æäº¤æ—¶ï¼Œæ˜¾ç„¶ç”¨~100æ¯”å†™100ä¸ª~æ›´ç°å®ï¼Œ~å’Œ^å¯ä»¥ç»„åˆä½¿ç”¨ï¼Œä¾‹å¦‚<code>git show HEAD~2^2</code>è¿™è¡Œå‘½ä»¤è¡¨ç¤ºæŸ¥çœ‹å½“å‰æäº¤çš„ç¬¬2ä¸ªçˆ¶æäº¤çš„ç¬¬2çˆ¶æäº¤å†…å®¹ã€‚ </p></blockquote></li><li><p>Gitä¸­å±é™©çš„å‘½ä»¤</p><blockquote><p>åœ¨Gitä¸­ä»»ä½•å·²æäº¤çš„å†…å®¹å‡ ä¹éƒ½æ˜¯å¯ä»¥æ¢å¤çš„(é‚£äº›è¢«è¦†ç›–çš„æäº¤ä¹Ÿå¯ä»¥æ¢å¤)ï¼Œä½†æ˜¯æœªæäº¤çš„å†…å®¹ä¸¢å¤±åå¯èƒ½å†ä¹Ÿæ‰¾ä¸å›äº†ï¼Œä»»ä½•å¯èƒ½ä¼šå¯¼è‡´å·¥ä½œåŒºå†…å®¹ä¸¢å¤±çš„å‘½ä»¤éƒ½æ˜¯å±é™©çš„å‘½ä»¤ï¼Œåœ¨Gitä¸­å±é™©çš„å‘½ä»¤æ€»å…±å¯ä»¥åˆ†ä¸º3ç±»:</p><ol><li>æ‰€æœ‰å¸¦<code>-f</code>é€‰é¡¹çš„å‘½ä»¤ï¼Œ<code>-f</code>çš„å…¨ç§°æ˜¯<code>--force</code>ï¼Œå®ƒè¡¨ç¤ºå¼ºåˆ¶çš„æ„æ€ï¼Œä¾‹å¦‚<code>git push -f</code>è¡¨ç¤ºå¼ºè¡Œå°†æœ¬åœ°ä»“åº“æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼Œ<code>git switch -f dev</code>è¡¨ç¤ºå¼ºè¡Œåˆ‡æ¢åˆ°devåˆ†æ”¯ï¼Œæ€»ä¹‹ä½¿ç”¨<code>-f</code>é€‰é¡¹æ—¶è¯·å°å¿ƒã€‚</li><li><code>git reset</code>å‘½ä»¤æ€»å…±æœ‰3ä¸ªé€‰é¡¹ï¼Œ<code>--soft</code>ã€<code>--mixed</code>ã€<code>--hard</code>ï¼Œå…¶ä¸­åªæœ‰<code>--hard</code>é€‰é¡¹æ˜¯å±é™©çš„å‘½ä»¤ï¼Œå…¶ä»–ä¸¤ä¸ªéƒ½æ˜¯å®‰å…¨çš„ï¼Œå½“ä½ ä½¿ç”¨<code>--hard</code>é€‰é¡¹æ—¶Gitä¼šä½¿ç”¨ä»“åº“ä¸­æŒ‡å®šçš„å¿«ç…§å†…å®¹è¦†ç›–å·¥ä½œåŒºã€‚</li><li><code>git checkout</code>å‘½ä»¤çš„æœ¬è´¨æ˜¯æ“çºµHEADæŒ‡é’ˆï¼Œå®ƒçš„åé¢å¯ä»¥æ˜¯åˆ†æ”¯åè¡¨ç¤ºåˆ‡æ¢åˆ†æ”¯ï¼Œä¹Ÿå¯ä»¥æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœåé¢æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸€ä¸ªå±é™©çš„å‘½ä»¤ï¼ŒGitä¼šä½¿ç”¨ä»“åº“ä¸­æŒ‡å®šçš„å¿«ç…§å†…å®¹è¦†ç›–å·¥ä½œåŒºçš„æŒ‡å®šæ–‡ä»¶(å»ºè®®ä½¿ç”¨switchå‘½ä»¤æ¥åˆ‡æ¢åˆ†æ”¯ï¼Œé˜²æ­¢è¯¯æ“ä½œå¯¼è‡´ä¸¢å¤±æ–‡ä»¶å†…å®¹)ã€‚</li></ol></blockquote></li><li><p>checkoutå’Œresetçš„åŒºåˆ«</p><blockquote><p>å¾ˆå¤šäººå®¹æ˜“æŠŠ<code>checkout</code>å’Œ<code>reset</code>å¼„æ··ï¼Œå› ä¸ºå®ƒä»¬éƒ½å¯ä»¥ç”¨æ¥å›æ»šå†å²æäº¤ï¼Œè™½ç„¶æœ€ç»ˆæ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯å®ç°è¿‡ç¨‹ç¡®ä¸ä¸€æ ·ï¼›ç®€å•çš„è¯´checkoutå‘½ä»¤ä¼šç›´æ¥ä¿®æ”¹HEADæŒ‡é’ˆçš„æŒ‡å‘ï¼Œè€Œresetå‘½ä»¤ä¿®æ”¹çš„æ˜¯HEADæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ã€‚</p><p>å‡è®¾masteråˆ†æ”¯æœ‰ä¸€ä¸ªæäº¤å¯¹è±¡(ab4adf)ï¼Œä½ æƒ³å›æ»šåˆ°è¿™æ¬¡æäº¤ï¼ŒGitæä¾›äº†2ç§æ–¹å¼ï¼š<code>git checkout ab4adf</code>å’Œ<code>git reset --hard ab4adf</code>éƒ½å¯ä»¥è¾¾åˆ°ä½ çš„ç›®çš„ï¼Œä½†å®ƒä»¬çš„å®ç°æœºåˆ¶ç•¥å¾®ä¸ä¸€æ ·ï¼›<code>git checkout ab4adf</code>ä¼šæŠŠHEADæŒ‡é’ˆç›´æ¥æŒ‡å‘ab4adfè¿™ä¸ªæäº¤å¯¹è±¡ï¼Œç„¶åå†ä½¿ç”¨ab4adfè¿™ä¸ªæäº¤å¯¹è±¡çš„å¿«ç…§å†…å®¹è¦†ç›–å·¥ä½œåŒºçš„å†…å®¹æ¥è¾¾åˆ°ç›®çš„(å¦‚æœä½ ç»†å¿ƒè§‚å¯Ÿçš„è¯ä¼šå‘ç°Gitä¼šæç¤ºä½ å½“å‰è¿›å…¥äº†HEADæ¸¸ç¦»çŠ¶æ€)ï¼Œå¦‚å›¾3æ‰€ç¤ºï¼›<code>git reset --hard ab4adf</code>çš„å®ç°å°±ç¨å¾®å¤æ‚ä¸€äº›ï¼Œå®ƒä¼šæ“çºµHEADæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡(è¿™é‡Œæ˜¯masteråˆ†æ”¯)æŒ‡å‘ab4adfè¿™æ¬¡æäº¤ï¼Œç„¶åå†ä½¿ç”¨ab4adfè¿™æ¬¡æäº¤ä¸­çš„å¿«ç…§å†…å®¹è¦†ç›–æš‚å­˜åŒºå’Œå·¥ä½œåŒºçš„å†…å®¹ï¼Œå¦‚å›¾4æ‰€ç¤ºã€‚<br><img src="%E6%88%AA%E5%B1%8F2021-08-03%2015.49.02.png"> å›¾3<br><img src="%E6%88%AA%E5%B1%8F2021-08-03%2015.49.49.png"> å›¾4</p></blockquote></li><li><p>Gitåè®®çš„åŒºåˆ«</p><blockquote><p>HTTPåè®®</p><blockquote><p>HTTPåè®®æœ‰2ä¸ªç‰ˆæœ¬ï¼Œä¸€ç§æ˜¯å“‘åè®®(åªèƒ½é€šè¿‡GETæ–¹å¼è¯»å–ä»“åº“å†…å®¹)ï¼Œå¦ä¸€ç§æ˜¯æ™ºèƒ½åè®®ï¼Œå“‘åè®®ç”±äºè‡ªèº«é—®é¢˜å·²ç»åŸºæœ¬é€€å‡ºèˆå°äº†ï¼›ç›¸æ¯”SSHåè®®ï¼ŒHTTPåè®®å¯ä»¥ä½¿ç”¨ç”¨æˆ·åã€å¯†ç æˆæƒæ˜¯ä¸€ä¸ªä¼˜åŠ¿ï¼Œå°±ç®—ä¸çŸ¥é“ç”¨æˆ·åå’Œå¯†ç ä¹Ÿå¯ä»¥è·å–é¡¹ç›®ï¼Œè¿™å¾ˆé€‚åˆå¼€æºé¡¹ç›®çš„æ¨å¹¿ï¼Œå¦ä¸€ä¸ªä¼˜åŠ¿å°±æ˜¯HTTPSåè®®è¢«å¹¿æ³›ä½¿ç”¨ï¼Œä¸€èˆ¬çš„ä¼ä¸šé˜²ç«å¢™éƒ½ä¼šå…è®¸è¿™äº›ç«¯å£çš„æ•°æ®é€šè¿‡ï¼›å”¯ä¸€çš„ç¼ºç‚¹å°±æ˜¯åœ¨ä¸€äº›æœåŠ¡å™¨ä¸Šï¼Œæ¶è®¾HTTPSåè®®çš„æœåŠ¡ç«¯ç¨å¾®æ£˜æ‰‹ä¸€äº›</p><blockquote><p>åœ¨ä½¿ç”¨HTTPSåè®®æ—¶ï¼Œå¯èƒ½è¦é‡å¤è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œè¿™æ—¶å¯ä»¥æ‰§è¡Œ<code>git config --global credential.helper cache</code>å‘½ä»¤æ¥å°†ç”¨æˆ·åå’Œå¯†ç ä¸´æ—¶ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œå¯ä»¥ä½¿ç”¨<code>--timeout &lt;seconds&gt;</code>é€‰é¡¹æ§åˆ¶ä¿ç•™æ—¶é•¿ï¼Œé»˜è®¤æ˜¯900ç§’(15åˆ†é’Ÿ)</p></blockquote></blockquote></blockquote><blockquote><p>SSHåè®®</p><blockquote><p>æ¶è®¾SSHåè®®ç›¸å¯¹ç®€å•ï¼ŒSSHå®ˆæŠ¤è¿›ç¨‹å¾ˆå¸¸è§ï¼Œå¤šæ•°ç®¡ç†å‘˜éƒ½ä¼šä½¿ç”¨ï¼Œå¤šæ•°æ“ä½œç³»ç»Ÿéƒ½åŒ…å«å®ƒåŠç›¸å…³çš„ç®¡ç†å·¥å…·ï¼Œç›¸å¯¹äºHTTPSåè®®å®ƒä¸ç”¨è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ä¹Ÿæ›´åŠ æ–¹ä¾¿ï¼›å®ƒçš„ç¼ºç‚¹æ˜¯ä¸æ”¯æŒåŒ¿åè®¿é—®Gitä»“åº“ï¼Œå³ä½¿åªæ˜¯è¯»å–æ•°æ®ï¼Œä½¿ç”¨è€…ä¹Ÿå¿…é¡»é€šè¿‡SSHè®¿é—®ä½ çš„ä¸»æœºï¼Œæ‰€ä»¥SSHä¸åˆ©äºå¼€æºé¡¹ç›®</p></blockquote></blockquote><blockquote><p>Gitåè®®</p><blockquote><p>æ˜¯æ‰€æœ‰åè®®é‡Œä¼ è¾“é€Ÿåº¦æœ€å¿«çš„ï¼Œå› ä¸ºæ²¡æœ‰åŠ å¯†å’Œæˆæƒçš„å¼€é”€ï¼›å®ƒçš„ç¼ºç‚¹æ˜¯ç”±äºæ²¡æœ‰åŠ å¯†å’Œæˆæƒï¼Œè¦ä¹ˆè°éƒ½å¯ä»¥å…‹éš†è¿™ä¸ªä»“åº“ï¼Œè¦ä¹ˆè°ä¹Ÿä¸èƒ½ï¼Œå®ƒä¹Ÿæ˜¯æœ€éš¾æ¶è®¾çš„åè®®ï¼Œè¿˜è¦æ±‚é˜²ç«å¢™å¼€æ”¾9418ç«¯å£ï¼Œä½†æ˜¯ä¼ä¸šé˜²ç«å¢™ä¸€èˆ¬éƒ½ä¸ä¼šå¼€æ”¾è¿™ä¸ªéæ ‡å‡†ç«¯å£ã€‚Gitåè®®ä¸€èˆ¬å’Œå…¶ä»–åè®®(ä¾‹å¦‚HTTPS)æ­é…ä½¿ç”¨ï¼Œä½¿ç”¨Gitåè®®è¿›è¡Œæ‹‰å–ï¼Œä½¿ç”¨HTTPSåè®®è¿›è¡Œæ¨é€ã€‚</p></blockquote></blockquote><blockquote><p>Localåè®®</p><blockquote><p>ä¸€èˆ¬ä¸ä¼šç”¨åˆ°ï¼Œæ‰€æœ‰æ²¡æœ‰å»äº†è§£è¿™æ–¹é¢çš„çŸ¥è¯†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªè¡Œæœç´¢</p></blockquote></blockquote></li></ol><h4 id="Git-å¸¸ç”¨å‘½ä»¤"><a href="#Git-å¸¸ç”¨å‘½ä»¤" class="headerlink" title="Git å¸¸ç”¨å‘½ä»¤"></a>Git å¸¸ç”¨å‘½ä»¤</h4><ul><li><p><code>git help &lt;verb&gt;</code> è·å–æŒ‡å®šGitå‘½ä»¤çš„å¸®åŠ©æ–‡æ¡£</p><blockquote><p>ç¤ºä¾‹ï¼š</p><p><code>git help add</code> è·å–addå‘½ä»¤çš„å¸®åŠ©æ–‡æ¡£</p><p><code>-a</code> åˆ—å‡ºæ‰€æœ‰çš„Gitå‘½ä»¤</p><p><code>-c(--config)</code> åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„é…ç½®å˜é‡</p><p><code>git add -h</code> ç®€æ˜“ç‰ˆçš„å¸®åŠ©æ–‡æ¡£</p><blockquote><p>ç­‰ä»·å‘½ä»¤ï¼š</p><p>git &lt;verb&gt; â€“help</p><p>man git-&lt;verb&gt;  </p></blockquote></blockquote></li><li><p><code>git rm &lt;path&gt;</code> åˆ é™¤æŒ‡å®šæ–‡ä»¶</p><blockquote><p><code>--cached(--staged)</code> ä»æš‚å­˜åŒºåˆ é™¤æŒ‡å®šæ–‡ä»¶</p><blockquote><p>å¦‚æœä¸å°å¿ƒæŠŠè¦å¿½ç•¥çš„æ–‡ä»¶æ·»åŠ åˆ°äº†Gitä»“åº“ä¸­ï¼Œåç»­å³ä½¿åœ¨å¿½ç•¥æ–‡ä»¶ä¸­å£°æ˜ä¹Ÿè¿˜æ˜¯ä¼šåœ¨æ¯æ¬¡æäº¤æ—¶æç¤ºä½ è¯¥æ–‡ä»¶æœªæš‚å­˜ï¼›è¿™æ—¶å¯ä»¥ä½¿ç”¨è¯¥å‘½ä»¤ä»æš‚å­˜åŒºåˆ é™¤æŒ‡å®šæ–‡ä»¶ï¼Œè¯¥æ“ä½œä¸ä¼šå½±å“å·¥ä½œåŒºã€‚</p></blockquote><p><code>-n(--try-run)</code> åˆ—å‡ºéœ€è¦åˆ é™¤çš„æ–‡ä»¶  </p></blockquote></li><li><p><code>git describe &lt;commit&gt;</code> æ ¹æ®æŒ‡å®šæäº¤å¯¹è±¡ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²æ„å»ºå·ã€‚å®ƒç”±æäº¤å¯¹è±¡æœ€è¿‘çš„æ ‡ç­¾åã€è‡ªè¯¥æ ‡ç­¾ä¹‹åçš„æäº¤æ•°ç›®å’Œä½ æ‰€æè¿°çš„æäº¤çš„éƒ¨åˆ†å“ˆå¸Œå€¼æ„æˆ(å¯ä»¥ä¸ºæäº¤é™„ä¸Šä¸€ä¸ªå¯è¯»çš„åç§°)ã€‚</p></li><li><p><code>git reflog</code> æ˜¾ç¤ºæ‰€æœ‰çš„å¼•ç”¨æ—¥å¿—</p><blockquote><p>reflogçš„æœ¬è´¨åªæ˜¯è®°å½•HEADæŒ‡é’ˆå‘ç”Ÿå˜åŒ–çš„è®°å½•ï¼Œå®ƒåªå­˜åœ¨äºæœ¬åœ°ä»“åº“ï¼Œä¸€èˆ¬æƒ…å†µä¸‹Gitåªä¼šä¿ç•™æœ€è¿‘å‡ ä¸ªæœˆ(é»˜è®¤æ˜¯90å¤©)çš„è®°å½•  </p></blockquote></li><li><p><code>git reflog --date=local --all | grep &lt;åˆ†æ”¯å&gt;</code> è·å–æŒ‡å®šåˆ†æ”¯çš„HEADå˜æ›´è®°å½•</p><blockquote><p>å¯ä»¥ç”¨æ¥æŸ¥çœ‹æŸä¸ªåˆ†æ”¯æ˜¯åŸºäºå“ªä¸ªåˆ†æ”¯åˆ›å»ºçš„ï¼Œç”±äºreflogæ‰€ä»¥åªèƒ½åœ¨åˆ›å»ºåˆ†æ”¯çš„é‚£å°ç”µè„‘ä¸Šæ‰èƒ½ç”Ÿæ•ˆå¹¶ä¸”æ—¶é—´å¤ªé•¿ä¹Ÿä¼šå¤±æ•ˆã€‚  </p></blockquote></li><li><p><code>git clean</code> ç§»é™¤é‚£äº›æ²¡æœ‰è¢«Gitè·Ÿè¸ªçš„æ–‡ä»¶ï¼Œè¯¥å‘½ä»¤éœ€è¦æ­é…ä»¥ä¸‹é€‰é¡¹æ‰§è¡Œ</p><blockquote><p><code>-d</code> é€’å½’åˆ é™¤å­ç›®å½•ä¸‹çš„æ–‡ä»¶&#x2F;æ–‡ä»¶å¤¹</p><p><code>-f</code>å¦‚æœ<code>clean.requireForce</code>æ²¡æœ‰è¢«è®¾ç½®ä¸ºfalseï¼Œåˆ™å¿…é¡»è¦ä½¿ç”¨<code>-f</code>å‘Šè¯‰Gitéœ€è¦åˆ é™¤é‚£äº›æ–‡ä»¶</p><p><code>-n(--dry-run)</code> åªæ˜¾ç¤ºé‚£äº›ä¼šè¢«ç§»é™¤çš„æ–‡ä»¶</p><p><code>-x</code> é»˜è®¤æƒ…å†µä¸‹ä¸ä¼šåˆ é™¤è¢«å¿½ç•¥çš„æ–‡ä»¶ï¼Œ-xè¡¨ç¤ºå°†ç§»é™¤é‚£äº›è¢«å¿½ç•¥çš„æ–‡ä»¶</p><p><code>-X</code> ä»…åˆ é™¤è¢«å¿½ç•¥çš„æœªè·Ÿè¸ªæ–‡ä»¶  </p></blockquote></li><li><p><code>git gc</code> æ‰‹åŠ¨å¯¹Gitä»“åº“è¿›è¡Œæ‰“åŒ…ä¼˜åŒ–</p><blockquote><p><code>--aggressive</code> åŠ ä¸Šæ­¤é€‰é¡¹Gitå°†ä¼šèŠ±è´¹æ›´å¤šæ—¶é—´ä¼˜åŒ–ä»“åº“</p></blockquote></li><li><p><code>git fsck</code> éªŒè¯æ•°æ®åº“ä¸­å¯¹è±¡çš„æœ‰æ•ˆæ€§</p><blockquote><p><code>--unreachable</code> æ‰“å°é‚£äº›å­˜åœ¨ä½†æ— æ³•ä»ä»»ä½•èŠ‚ç‚¹è®¿é—®çš„å¯¹è±¡  </p></blockquote></li><li><p><code>git restore</code> æ¢å¤å·¥ä½œåŒºçš„æ–‡ä»¶</p><blockquote><p><code>--staged &lt;path&gt;</code> å°†æŒ‡å®šæ–‡ä»¶ä»æš‚å­˜åŒºç§»é™¤</p><p><code>-s(--source) &lt;tree_id&gt; &lt;path&gt;</code> ä½¿ç”¨æŒ‡å®šæ ‘ä¸­çš„æ–‡ä»¶æ¢å¤å·¥ä½œåŒºçš„æŒ‡å®šæ–‡ä»¶</p></blockquote></li><li><p><code>git clone -d &lt;åˆ†æ”¯å&gt; &lt;path&gt; --depth=&lt;number&gt;</code> å…‹éš†æŒ‡å®šä»“åº“ä¸‹æŒ‡å®šåˆ†æ”¯çš„numberæ¡æäº¤å†å²</p><blockquote><p>ç¤ºä¾‹ï¼š</p><p><code>git clone -b master &lt;path&gt; --depth=1</code> åªå…‹éš†è¿œç¨‹ä»“åº“çš„masteråˆ†æ”¯çš„æœ€è¿‘ä¸€æ¡æäº¤</p></blockquote></li></ul><h4 id="Git-Config"><a href="#Git-Config" class="headerlink" title="Git Config"></a>Git Config</h4><ul><li><p><code>git config --list</code> æŸ¥çœ‹Gité…ç½®ä¿¡æ¯ï¼Œé…ç½®ä¿¡æ¯å¯èƒ½ä¼šé‡å¤ï¼Œå¦‚æœå­˜åœ¨é‡å¤Gitä¼šä»¥æœ€åä¸€ä¸ªå€¼ä¸ºå‡†ã€‚</p><blockquote><p><code>--show-origin</code> æ˜¾ç¤ºè¯¥é…ç½®çš„æ¥æº(è·¯å¾„)</p></blockquote></li><li><p><code>git config &lt;èŒƒå›´&gt; &lt;é€‰é¡¹&gt; &lt;å€¼&gt;</code> åœ¨æŒ‡å®šèŒƒå›´å†…è®¾ç½®æŒ‡å®šé…ç½®ä¿¡æ¯ã€‚</p><blockquote><p>ç¤ºä¾‹ï¼š</p><p><code>git config --global user.name &#39;author&#39;</code> åœ¨å…¨å±€èŒƒå›´å†…è®¾ç½®æäº¤è€…çš„åç§°ã€‚<br>Git Configæ€»å…±æœ‰3ä¸ªèŒƒå›´ï¼Œåˆ†åˆ«æ˜¯systemã€globalã€local(é»˜è®¤å€¼)ï¼Œæƒé‡ä¾æ¬¡é€’å¢ï¼Œsystemçš„å½±å“èŒƒå›´æ˜¯æœ€å¤§çš„ï¼Œé’ˆå¯¹å½“å‰ç”µè„‘ä¸‹çš„æ‰€æœ‰Gitä»“åº“éƒ½ç”Ÿæ•ˆï¼›globalé’ˆå¯¹å½“å‰ç”¨æˆ·ä¸‹çš„æ‰€æœ‰Gitä»“åº“ç”Ÿæ•ˆï¼›localåªå¯¹å½“å‰Gitä»“åº“ç”Ÿæ•ˆã€‚  </p></blockquote></li><li><p><code>git config --global merge.conflictstyle diff3</code> ä¿®æ”¹åˆå¹¶å†²çªæ ·å¼ä¸ºdiff3ï¼Œè¿™ç§æ ·å¼ä¸‹ä¼šé¢å¤–æ˜¾ç¤ºbaseçš„å†…å®¹ï¼Œå¦‚å›¾5ã€‚</p><p>  <img src="%E6%88%AA%E5%B1%8F2021-08-10%2010.03.08.png"> å›¾5</p></li><li><p><code>git config --global help.autocorrect 50</code> è®¾ç½®è¯¥é€‰é¡¹åï¼Œå½“GitåŒ¹é…äº†ç›¸ä¼¼çš„å‘½ä»¤æ—¶ä¼šåœ¨å€’è®¡æ—¶ç»“æŸåè‡ªåŠ¨æ‰§è¡Œè¯¥å‘½ä»¤</p></li><li><p><code>git config --global core.autocrlf true</code> å¯ç”¨è¯¥åŠŸèƒ½çš„è¯å½“ä½ æäº¤æ—¶Gitä¼šè‡ªåŠ¨æŠŠå›è½¦å’Œæ¢è¡Œè½¬æ¢æˆä¸€ä¸ªæ¢è¡Œç¬¦ï¼Œè€Œåœ¨æ£€å‡ºä»£ç æ—¶æŠŠä¸€ä¸ªæ¢è¡Œç¬¦è½¬æ¢æˆå›è½¦å’Œæ¢è¡Œã€‚</p><blockquote><p>åœ¨Windowsçš„æŸäº›ç¼–è¾‘å™¨ä¸­ï¼Œæ¢è¡Œç¬¦æ˜¯ç”±å›è½¦ç¬¦å’Œæ¢è¡Œç¬¦2ä¸ªå‘½ä»¤ç»„æˆçš„ï¼Œè€Œåœ¨macOSå’ŒLinuxç³»ç»Ÿä¸­æ¢è¡Œç¬¦åªæœ‰ä¸€ä¸ªç¬¦å·ã€‚å¦‚æœåŒä¸€ä¸ªé¡¹ç›®åœ¨Windowså’Œå…¶ä»–å¹³å°ä¸Šå¼€å‘ï¼Œå¯èƒ½ä¼šé‡åˆ°ç©ºæ ¼å†²çªã€‚</p><p><code>input</code> è®¾ç½®ä¸ºinputå‘Šè¯‰Gitåœ¨æäº¤æ—¶æŠŠå›è½¦å’Œæ¢è¡Œè½¬æ¢æˆæ¢è¡Œï¼Œæ£€å‡ºæ—¶ä¸è½¬æ¢</p></blockquote></li><li><p><code>core.whitespace</code> ç©ºæ ¼å¤„ç†æ–¹æ¡ˆï¼ŒGitæä¾›äº†6ç§å¤„ç†å¤šä½™ç©ºç™½å­—ç¬¦çš„ä¸»è¦é€‰é¡¹ï¼Œ3é¡¹é»˜è®¤å¼€å¯ï¼Œ3é¡¹é»˜è®¤å…³é—­</p><blockquote><p>é»˜è®¤å¼€å¯ï¼šblank-at-eol(æŸ¥æ‰¾è¡Œå°¾çš„ç©ºæ ¼)ï¼Œblank-at-eof(ç›¯ä½æ–‡ä»¶åº•éƒ¨çš„ç©ºè¡Œ)ï¼Œspace-before-tab(è­¦æƒ•è¡Œå¤´tabå‰é¢çš„ç©ºæ ¼)</p><p>é»˜è®¤å…³é—­ï¼šindent-with-non-tab(æªå‡ºä»¥ç©ºæ ¼è€Œétabå¼€å¤´çš„è¡Œï¼Œä½ å¯ä»¥ç”¨tabwidthé€‰é¡¹æ§åˆ¶å®ƒ)ï¼Œtab-in-indent(ç›‘è§†åœ¨è¡Œå¤´è¡¨ç¤ºç¼©è¿›çš„tab)ï¼Œcr-at-eol(å‘Šè¯‰Gitå¿½ç•¥è¡Œå°¾çš„å›è½¦)</p></blockquote></li></ul><p>å¦‚æœæƒ³å…³é—­æŸä¸ªé€‰é¡¹ï¼Œå¯ä»¥åœ¨è¾“å…¥è®¾ç½®é€‰é¡¹æ—¶ä¸æŒ‡å®šå®ƒæˆ–åœ¨å®ƒå‰é¢åŠ ä¸ª ï¼</p><ul><li><p><code>git config &lt;èŒƒå›´&gt; alias.&lt;åˆ«å&gt; &#39;&lt;å…¨å&gt;&#39;</code> åœ¨æŒ‡å®šèŒƒå›´å†…è®¾ç½®ä¸€ä¸ªGitåˆ«åã€‚</p><blockquote><p>ç¤ºä¾‹ï¼š</p><p><code>git config --global alias.st &#39;status&#39;</code> åœ¨å…¨å±€èŒƒå›´å†…ç»™statusè®¾ç½®ä¸€ä¸ªåˆ«åstã€‚</p><p>åˆ«åé€šå¸¸ç”¨æ¥ç®€åŒ–å‘½ä»¤ï¼Œå¦‚æœæƒ³ç»™éGitå‘½ä»¤èµ·åˆ«åï¼Œä¾‹å¦‚gitkï¼Œå¯ä»¥è¿™æ ·è®¾ç½®<code>git config --global alias.gitk &#39;!gitk&#39;</code>ï¼Œå½“ä½ è°ƒç”¨â€git gitkâ€æ—¶ä¼šæ‰§è¡Œâ€gitkâ€å‘½ä»¤ã€‚</p><blockquote><p>ä¸€äº›å¸¸ç”¨çš„åˆ«åï¼š</p><p><code>git config --global alias.co checkout</code></p><p><code>git config --global alias.br branch</code></p><p><code>git config --global alias.ci commit</code></p><p><code>git config --global alias.st status</code></p><p><code>git config --global alias.s &#39;status -s&#39;</code></p><p><code>git config --global alias.last &#39;log -1&#39;</code>  </p></blockquote></blockquote></li><li><p><code>git config &lt;èŒƒå›´&gt; --unset alias.&lt;name&gt;</code> åˆ é™¤æŒ‡å®šåˆ«å</p></li></ul><h4 id="Git-Diff"><a href="#Git-Diff" class="headerlink" title="Git Diff"></a>Git Diff</h4><ul><li><p><code>git diff</code> æ˜¾ç¤ºå·¥ä½œåŒºå’Œæš‚å­˜åŒºä¹‹é—´çš„å·®å¼‚</p><blockquote><p><code>--cached(--staged)</code> æ˜¾ç¤ºæš‚å­˜åŒºå’Œæœ€æ–°æäº¤ä¹‹å‰çš„å·®å¼‚</p><p><code>--check</code> æ‰“å°æ‰€æœ‰å¯èƒ½çš„ç©ºæ ¼é”™è¯¯</p><p><code>--ours</code> å†²çªæ—¶æŸ¥çœ‹åˆå¹¶å¼•å…¥äº†ä»€ä¹ˆ</p><p><code>--theirs -b</code> å†²çªæ—¶æŸ¥çœ‹åˆå¹¶çš„ç»“æœä¸å¦ä¸€è¾¹æœ‰ä»€ä¹ˆä¸åŒï¼Œ-bè¡¨ç¤ºå»é™¤ç©ºæ ¼</p><p><code>--base</code> å†²çªæ—¶æŸ¥çœ‹æ–‡ä»¶åœ¨ä¸¤è¾¹æ˜¯å¦‚ä½•æ”¹åŠ¨çš„</p></blockquote></li></ul><h4 id="Git-Log"><a href="#Git-Log" class="headerlink" title="Git Log"></a>Git Log</h4><ul><li><p><code>git log</code> æ˜¾ç¤ºå½“å‰åˆ†æ”¯ä¸‹çš„æäº¤å†å²</p><blockquote><p><code>-n</code> æ˜¾ç¤ºæŒ‡å®šæ•°é‡çš„æäº¤è®°å½•ï¼Œä¾‹å¦‚<code>git log -2</code>æ˜¾ç¤ºæœ€è¿‘2æ¡æäº¤è®°å½•</p><p><code>--show-signature</code> æ˜¾ç¤ºGPGç­¾åä¿¡æ¯</p><p><code>--stat</code> æ˜¾ç¤ºæäº¤æ—¶çš„ç®€ç•¥ä¿¡æ¯</p><p><code>--abbrev-commit</code> æ˜¾ç¤ºç®€çŸ­çš„å“ˆå¸Œå€¼</p><p><code>--relative-date</code> æ˜¾ç¤ºä¸€ä¸ªç›¸å¯¹æ—¶é—´(ä¾‹å¦‚ 9 hours ago)</p><p><code>--graph</code> åœ¨æ—¥å¿—æ—ä»¥ASCIIå›¾å½¢æ˜¾ç¤ºåˆ†æ”¯å’Œåˆå¹¶å†å²</p><p><code>--oneline</code> â€“pretty&#x3D;onelineå’Œâ€“abbrev-commitçš„ç¼©å†™</p><p><code>--pretty=</code>  ä½¿ç”¨å…¶ä»–æ ¼å¼æ˜¾ç¤ºæäº¤å†å²</p><blockquote><p><code>oneline</code> å°†æ¯æ¡æäº¤æ”¾åœ¨ä¸€è¡Œæ˜¾ç¤º</p><p><code>short</code> ä¸æ˜¾ç¤ºæäº¤æ—¶é—´</p><p><code>full</code> ä¸æ˜¾ç¤ºæäº¤æ—¶é—´ä½†é¢å¤–æ˜¾ç¤ºæäº¤è€…ä¿¡æ¯</p><p><code>fuller</code> æ˜¾ç¤ºæäº¤è€…ä¿¡æ¯ä»¥åŠæäº¤æ—¶é—´</p><p><code>format</code> è‡ªå®šä¹‰æ˜¾ç¤ºé£æ ¼(è‡ªå®šä¹‰é£æ ¼å¯ä»¥ä¸å—Gitç‰ˆæœ¬å½±å“)</p><blockquote><p>ç¤ºä¾‹ï¼š</p><p><code>git log --pretty=format:&quot;%Cred%h%Creset - %C(yellow)%an%Creset, %C(green)%ar%Creset : %s&quot;</code> ä¸€è¡Œæ˜¾ç¤ºç®€å†™çš„æäº¤å“ˆå¸Œå€¼ - ä½œè€…åç§°, æäº¤ç›¸å¯¹æ—¶é—´ : æäº¤è¯´æ˜ã€‚</p><p>formatå¯æ¥å—çš„é€‰é¡¹å¦‚ä¸‹ï¼š</p><p><code>%H</code> æäº¤çš„å®Œæ•´å“ˆå¸Œå€¼</p><p><code>%h</code> æäº¤çš„ç®€å†™å“ˆå¸Œå€¼</p><p><code>%T</code> æ ‘çš„å®Œæ•´å“ˆå¸Œå€¼</p><p><code>%t</code> æ ‘çš„ç®€å†™å“ˆå¸Œå€¼</p><p><code>%P</code> çˆ¶æäº¤çš„å®Œæ•´å“ˆå¸Œå€¼</p><p><code>%p</code> çˆ¶æäº¤çš„ç®€å†™å“ˆå¸Œå€¼</p><p><code>%an</code> ä½œè€…çš„åç§°</p><p><code>%ae</code> ä½œè€…çš„ç”µå­é‚®ä»¶åœ°å€</p><p><code>%ad</code> ä½œè€…çš„ä¿®è®¢æ—¥æœŸ</p><p><code>%ar</code> ä½œè€…çš„ä¿®è®¢æ—¥æœŸï¼ŒæŒ‰å¤šä¹…ä»¥å‰çš„æ–¹å¼æ˜¾ç¤ºï¼Œä¾‹å¦‚20 hours ago</p><p><code>%cn</code> æäº¤è€…çš„åç§°</p><p><code>%ce</code> æäº¤è€…çš„ç”µå­é‚®ä»¶åœ°å€</p><p><code>%cd</code> æäº¤æ—¥æœŸ</p><p><code>%cr</code> æäº¤æ—¥æœŸï¼ŒæŒ‰å¤šä¹…ä»¥å‰çš„æ–¹å¼æ˜¾ç¤º</p><p><code>%s</code> æäº¤è¯´æ˜</p><p>Gitæ”¯æŒçš„é¢œè‰²é€‰é¡¹ï¼š</p><p>normalã€blackã€redã€greenã€yellowã€blueã€magentaã€cyanã€white</p><p>Gitæ”¯æŒçš„å­—ä½“å±æ€§</p><p>boldã€dimã€ulã€blinkã€reverse</p></blockquote></blockquote><p><code>--author</code> æ˜¾ç¤ºå’ŒæŒ‡å®šä½œè€…çš„æäº¤è®°å½•</p><p><code>--committer</code> æ˜¾ç¤ºå’ŒæŒ‡å®šæäº¤è€…çš„æäº¤è®°å½•</p><p><code>--grep</code> æ˜¾ç¤ºæäº¤è¯´æ˜ä¸­åŒ…å«æŒ‡å®šå­—ç¬¦ä¸²çš„æäº¤è®°å½•</p><p><code>-S</code> æ˜¾ç¤ºå¯¹æŒ‡å®šå­—ç¬¦ä¸²è¿›è¡Œäº†ä¿®æ”¹çš„æäº¤è®°å½•(å¸¸ç”¨æ¥æŸ¥æ‰¾æŸä¸ªå‡½æ•°çš„ä¿®æ”¹æäº¤è®°å½•)</p><p><code>-G &lt;æ­£åˆ™è¡¨è¾¾å¼&gt;</code> ä½¿ç”¨æ­£åˆ™æŸ¥æ‰¾ç›¸å…³çš„æäº¤è®°å½•</p><p><code>-- &lt;path&gt;</code> æ˜¾ç¤ºæŒ‡å®šè·¯å¾„ä¸‹çš„ä¿®æ”¹è®°å½•(å¸¸ç”¨æ¥å’Œå…¶ä»–é€‰é¡¹æ­é…æŸ¥æ‰¾æŸä¸ªæ–‡ä»¶ä¸‹æŸä¸ªå‡½æ•°çš„ä¿®æ”¹æäº¤è®°å½•ï¼Œä¸€èˆ¬å†™åœ¨æœ€å)</p><p><code>-L</code> æ˜¾ç¤ºæŒ‡å®šæ–‡ä»¶ä¸­æŒ‡å®šå‡½æ•°çš„ç›¸å…³ä¿®æ”¹æäº¤è®°å½•</p><blockquote><p>ç¤ºä¾‹ï¼š</p><p><code>git log -L :firstApplication:WXReader/AppDelegate.m</code> æ˜¾ç¤ºAppDelegate.mæ–‡ä»¶ä¸‹ä¸firstApplicationç›¸å…³çš„ä¿®æ”¹æäº¤</p></blockquote><p><code>--no-merges</code> ä¸æ˜¾ç¤ºåˆå¹¶æäº¤</p><p><code>--after(--since)</code> æ˜¾ç¤ºæŒ‡å®šæ—¶é—´ä¹‹åçš„æäº¤è®°å½•</p><p><code>--before(--until)</code> æ˜¾ç¤ºæŒ‡å®šæ—¶é—´ä¹‹å‰çš„æäº¤è®°å½•</p><blockquote><p><code>--after</code>å’Œ<code>--before</code>å¯ä»¥æ­é…æŒ‡å®šçš„æ—¶é—´å€¼ï¼Œä¾‹å¦‚â€2008-08-08â€ï¼Œä¹Ÿå¯ä»¥æ˜¯â€2 years 1 day 3 minutes agoâ€ã€â€2.weeaksâ€è¿™æ ·çš„ç›¸å¯¹æ—¥æœŸ</p><p>ç¤ºä¾‹ï¼š</p><p><code>git log --author=&#39;internetwei&#39; --after=&quot;2020-01-01&quot; --before=&quot;2020-06-01&quot; --no-merges -- WXReader/Book/BookRack/BookReader</code> æ˜¾ç¤ºä½œè€…internetweiåœ¨2020å¹´1æœˆ1å·åˆ°2020å¹´6æœˆ1å·ä¹‹é—´å¯¹<code>WXReader/Book/BookRack/BookReader</code>è¿™ä¸ªæ–‡ä»¶å¤¹(åŒ…æ‹¬æ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰çš„æ–‡ä»¶)æœ‰å…³çš„æ‰€æœ‰ä¿®æ”¹æäº¤ä½†ä¸åŒ…æ‹¬åˆå¹¶æäº¤</p></blockquote><p><code>&lt;åˆ†æ”¯1&gt;..&lt;åˆ†æ”¯2&gt;</code> æ˜¾ç¤ºåˆ†æ”¯2æœ‰ä½†åˆ†æ”¯1æ²¡æœ‰çš„æäº¤è®°å½•(å¸¸ç”¨æ¥æ£€æŸ¥åˆ†æ”¯å“ªäº›æäº¤æœªæ¨é€)</p><blockquote><p>å’Œ..è¯­æ³•ç­‰ä»·çš„å‘½ä»¤ï¼š</p><p><code>git log ^&lt;åˆ†æ”¯1&gt; &lt;åˆ†æ”¯2&gt;</code></p><p><code>git log &lt;åˆ†æ”¯2&gt; --not &lt;åˆ†æ”¯1&gt;</code></p><p>ä¸Šé¢ä¸¤ç§å‘½ä»¤æ˜¯..è¯­æ³•çš„æ‰©å±•ï¼Œé™¤äº†æŸ¥è¯¢2ä¸ªå¼•ç”¨ï¼Œè¿˜æ”¯æŒæŸ¥è¯¢è¶…è¿‡2ä¸ªå¼•ç”¨ï¼Œä¾‹å¦‚<code>git log refA refB ^refC</code>è¡¨ç¤ºæ˜¾ç¤ºæ‰€æœ‰è¢«<code>refA</code>æˆ–<code>refB</code>åŒ…å«ä½†ä¸è¢«<code>refC</code>åŒ…å«çš„æäº¤è®°å½•</p></blockquote><p><code>&lt;åˆ†æ”¯1&gt;...&lt;åˆ†æ”¯2&gt;</code> æ˜¾ç¤ºåˆ†æ”¯1å’Œåˆ†æ”¯2ä¸å…±æœ‰çš„æäº¤</p><blockquote><p><code>--left-right</code> å’Œâ€¦ç­‰ç±»ä¼¼è¯­æ³•æ­é…ä½¿ç”¨ï¼Œå¯ä»¥ç”¨&lt;ã€&gt;è¡¨ç¤ºå·¦å³åˆ†æ”¯  </p></blockquote></blockquote></li><li><p><code>git shortlog</code> æ˜¾ç¤ºå½“å‰åˆ†æ”¯çš„ä¿®æ”¹æ—¥å¿—æ–‡æ¡£</p><blockquote><p>ç¤ºä¾‹ï¼š</p><p><code>git shortlog --no-merges master --not v1.0</code> æ˜¾ç¤ºmasteråˆ†æ”¯ä»v1.0æ ‡ç­¾åçš„æ‰€æœ‰éåˆå¹¶æäº¤æäº¤æ—¥å¿—</p></blockquote></li></ul><h4 id="Git-Rebase"><a href="#Git-Rebase" class="headerlink" title="Git Rebase"></a>Git Rebase</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Mergeå’ŒRebaseçš„åŒºåˆ«ï¼š</span><br><span class="line"></span><br><span class="line">åœ¨Gitä¸­ç”¨æ¥æ•´åˆä¸åŒåˆ†æ”¯çš„ä¿®æ”¹æœ‰ä¸¤ç§åŠæ³•ï¼Œä¸€ç§æ˜¯mergeï¼Œå¦ä¸€ç§æ˜¯rebaseï¼Œè¿™ä¸¤ç§æ–¹æ¡ˆæœ€ç»ˆçš„ç»“æœæ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œåªä¸è¿‡æäº¤å†å²ä¸ä¸€æ ·ç½¢äº†ï¼ŒRebaseæ˜¯å°†ä¸€ç³»åˆ—çš„æäº¤æŒ‰ç…§åŸæœ‰æ¬¡åºä¾æ¬¡åº”ç”¨åˆ°å¦ä¸€ä¸ªåˆ†æ”¯ä¸Šï¼Œè¿™æ ·åšå¯ä»¥ä½¿æäº¤å†å²æ›´åŠ æ•´æ´ï¼›è€Œåˆå¹¶æ˜¯æŠŠæœ€ç»ˆç»“æœåˆåœ¨ä¸€èµ·ã€‚</span><br><span class="line"></span><br><span class="line">æå–æŸæ¬¡æäº¤ä¸­å¼•å…¥çš„è¡¥ä¸å’Œä¿®æ”¹ï¼Œç„¶ååœ¨å½“å‰åˆ†æ”¯çš„åŸºç¡€ä¸Šåº”ç”¨ä¸€æ¬¡ï¼Œè¿™ç§æ“ä½œå°±å«åšrebaseã€‚</span><br><span class="line"></span><br><span class="line">rebaseåçš„æäº¤å†å²å¦‚å›¾6ï¼Œmergeæäº¤å†å²å¦‚å›¾7ï¼ŒåŒæ ·çš„æäº¤ï¼Œä½¿ç”¨mergeå’Œrebaseçš„åŒºåˆ«ä¸€ç›®äº†ç„¶ã€‚</span><br><span class="line"></span><br><span class="line">ä½ å¯ä»¥è‡ªç”±é€‰æ‹©`rebase`æˆ–`merge`ï¼Œä¸è¿‡å¦‚æœä½ é€‰æ‹©`rebase`çš„è¯ï¼Œè¯·è®°ä½åªå¯¹å°šæœªæ¨é€æˆ–åˆ†äº«ç»™åˆ«äººçš„æäº¤è¿›è¡Œ`rebase`æ“ä½œã€‚</span><br></pre></td></tr></table></figure><p><img src="%E6%88%AA%E5%B1%8F2021-08-03%2010.45.35.png"> å›¾6</p><p><img src="%E6%88%AA%E5%B1%8F2021-08-03%2010.49.53.png"> å›¾7</p><ul><li><p><code>git rebase &lt;åˆ†æ”¯&gt;</code> å°†å½“å‰åˆ†æ”¯ä¸Šçš„æäº¤ä¾æ¬¡å˜åŸºåˆ°ç›®æ ‡åˆ†æ”¯ä¸Š</p></li><li><p><code>git rebase &lt;åˆ†æ”¯1&gt; &lt;åˆ†æ”¯2&gt;</code> å°†åˆ†æ”¯2ä¸Šçš„æäº¤ä¾æ¬¡å˜åŸºåˆ°åˆ†æ”¯1ä¸Š</p><blockquote><p>ç¤ºä¾‹ï¼š</p><p><code>git rebase master experiment</code> å°†experimentåˆ†æ”¯ä¸Šçš„æäº¤å†…å®¹ä¾æ¬¡å˜åŸºåˆ°masteråˆ†æ”¯ä¸Šï¼Œå¦‚å›¾8</p><p><img src="0b1bc478bd2f48d5a25d5b886ec99f8d~tplv-k3u1fbpfcp-zoom-1.image"> å›¾8</p><p>åˆ‡æ¢åˆ°masteråˆ†æ”¯å†åˆå¹¶experimentåˆ†æ”¯å°±ä¸ä¼šæœ‰åˆ†å‰çš„æäº¤å†å²äº†ï¼Œå¦‚å›¾9</p><p><img src="6518e127a0e446b8b790c21f620f7c26~tplv-k3u1fbpfcp-zoom-1.image"> å›¾9</p><blockquote><p>rebaseçš„åŸç†ï¼š</p><ol><li><p>é¦–å…ˆæ‰¾åˆ°è¿™2ä¸ªåˆ†æ”¯çš„æœ€è¿‘å…±åŒç¥–å…ˆC2</p></li><li><p>ç„¶åå¯¹æ¯”å½“å‰åˆ†æ”¯ç›¸å¯¹äºè¯¥ç¥–å…ˆçš„å†æ¬¡æäº¤ï¼Œæå–ç›¸åº”çš„ä¿®æ”¹å¹¶å­˜ä¸ºä¸´æ—¶æ–‡ä»¶</p></li><li><p>ç„¶åå°†å½“å‰åˆ†æ”¯æŒ‡å‘ç›®æ ‡åŸºåº•C3</p></li><li><p>æœ€åä»¥æ­¤å°†ä¹‹å‰ä¿å­˜çš„ä¸´æ—¶æ–‡ä»¶çš„ä¿®æ”¹ä¾æ¬¡åº”ç”¨</p></li></ol></blockquote></blockquote></li><li><p><code>git rebase --onto &lt;åˆ†æ”¯1&gt; &lt;åˆ†æ”¯2&gt; &lt;åˆ†æ”¯3&gt;</code> æ‰¾åˆ°åˆ†æ”¯3åœ¨åˆ†æ”¯2åˆ†æ­§åçš„æäº¤ï¼Œç„¶åæŠŠè¿™äº›æäº¤åœ¨åˆ†æ”¯1ä¸Šä¾æ¬¡åº”ç”¨ä¸€é</p><blockquote><p>ç¤ºä¾‹ï¼š</p><p><code>git rebase --onto master server client</code> æ‰¾åˆ°clientåˆ†æ”¯ï¼Œæ‰¾å‡ºå®ƒä»serveråˆ†æ”¯åˆ†æ­§ä¹‹åçš„æäº¤ï¼Œç„¶åæŠŠè¿™äº›æäº¤åœ¨masteråˆ†æ”¯ä¸Šé‡æ”¾ä¸€éï¼Œå¦‚å›¾10æ‰€ç¤º</p></blockquote><p>  <img src="567d0c68f2854ef08fa29313a8ecaee7~tplv-k3u1fbpfcp-zoom-1.image"> å›¾10</p></li><li><p><code>git rebase -i &lt;åŒºé—´&gt;</code> å¯¹æŒ‡å®šåŒºé—´å†…çš„æäº¤è¿›è¡Œäº¤äº’å¼å˜åŸº</p><blockquote><p>ç¤ºä¾‹ï¼š</p><p><code>git rebase -i HEAD~2</code> å¯¹æœ€è¿‘3æ¬¡æäº¤è¿›è¡Œäº¤äº’å¼å˜åŸºï¼Œäº¤äº’å¼å˜åŸºçš„åŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œå¯ä»¥å®ç°â€œå°†ä»»æ„æäº¤å‹ç¼©æˆä¸€ä¸ªæäº¤â€ã€â€œå°†ä¸€ä¸ªæäº¤æ‹†æˆå¤šä¸ªæäº¤â€ã€â€œä¿®æ”¹ä»»æ„æäº¤çš„æäº¤è¯´æ˜â€ã€â€œé‡æ–°æ’åºâ€ã€â€œç§»é™¤æäº¤â€ç­‰åŠŸèƒ½</p></blockquote></li><li><p><code>git commit --amend</code> ä¿®æ”¹æœ€æ–°çš„æäº¤ä¿¡æ¯</p><blockquote><p>è™½ç„¶å®ƒæ˜¯commitå¼€å¤´çš„å‘½ä»¤ï¼Œä¸è¿‡å®ƒçš„æœ¬è´¨å°±æ˜¯rebaseæ“ä½œï¼Œæ‰€ä»¥æŠŠå®ƒæ”¾åœ¨rebaseé‡Œ</p><p>è¯¥å‘½ä»¤æœ‰2ä¸ªä½œç”¨ï¼š</p><ol><li><p>ä¿®æ”¹æœ€æ–°çš„æäº¤è¯´æ˜ï¼›ç¡®ä¿å½“å‰æš‚å­˜åŒºæ˜¯å¹²å‡€çš„ï¼Œç„¶åè¿è¡Œæ­¤å‘½ä»¤ï¼Œå®ƒä¼šå°†ä½ å¸¦åˆ°æäº¤è¯´æ˜ç¼–è¾‘æ¡†ï¼Œé‡æ–°ç¼–è¾‘æäº¤ä¿¡æ¯ç„¶åä¿å­˜é€€å‡ºå³å¯ã€‚</p></li><li><p>è¡¥å……æäº¤æ–‡ä»¶ï¼›ä¾‹å¦‚ä¸Šæ¬¡æäº¤æ—¶å¿˜è®°æ·»åŠ ä¸€ä¸ªæ–‡ä»¶ï¼Œæˆ–è€…ä¸Šæ¬¡æäº¤çš„æ–‡ä»¶åˆæœ‰ä¿®æ”¹äº†ï¼Œè€Œè¿™æ¬¡ä¿®æ”¹åº”è¯¥å’Œä¸Šæ¬¡æäº¤æ˜¯ä¸€èµ·çš„ï¼›é¦–å…ˆå°†éœ€è¦è¡¥å……æäº¤çš„æ–‡ä»¶æ·»åŠ åˆ°æš‚å­˜åŒºï¼Œç¡®ä¿æš‚å­˜åŒºçš„æ–‡ä»¶æ˜¯ä½ è¦è¡¥å……æäº¤çš„ï¼Œç„¶åè¿è¡Œæ­¤å‘½ä»¤ï¼Œç¼–è¾‘æäº¤ä¿¡æ¯ä¿å­˜é€€å‡ºå³å¯ã€‚</p></li></ol></blockquote></li><li><p><code>git cherry-pick &lt;commit&gt;</code> å°†æŒ‡å®šæäº¤çš„ä¿®æ”¹åœ¨å½“å‰åˆ†æ”¯çš„åŸºç¡€ä¸Šé‡æ”¾ä¸€éå¹¶æäº¤</p></li></ul><h4 id="Git-Remote"><a href="#Git-Remote" class="headerlink" title="Git Remote"></a>Git Remote</h4><ul><li><p><code>git remote</code> æ˜¾ç¤ºæ‰€æœ‰è¿œç¨‹ä»“åº“çš„åç§°</p><blockquote><p><code>-v</code> æ˜¾ç¤ºè¿œç¨‹ä»“åº“çš„å…·ä½“ä¿¡æ¯</p><p><code>show &lt;ä»“åº“å&gt;</code> æ˜¾ç¤ºæŒ‡å®šè¿œç¨‹ä»“åº“çš„è¯¦ç»†ä¿¡æ¯</p><p><code>ls-remote &lt;ä»“åº“å&gt;</code> æ˜¾ç¤ºæŒ‡å®šè¿œç¨‹ä»“åº“çš„å®Œæ•´å¼•ç”¨åˆ—è¡¨</p><p><code>prune &lt;ä»“åº“å&gt;</code> åˆ é™¤æœ¬åœ°é•œåƒä»“åº“å­˜åœ¨ä½†è¿œç¨‹å·²åˆ é™¤çš„åˆ†æ”¯ä¿¡æ¯</p><p><code>git remote set-url &lt;ä»“åº“å&gt; &lt;url&gt;</code> ä¿®æ”¹æŒ‡å®šä»“åº“çš„åœ°å€  </p></blockquote></li><li><p><code>git fetch &lt;ä»“åº“å&gt;</code> æ‹‰å–æŒ‡å®šä»“åº“çš„ä¿¡æ¯å¹¶æ›´æ–°æœ¬åœ°çš„ä»“åº“ä¿¡æ¯(è¿™åªä¼šæ›´æ–°æœ¬åœ°çš„è¿œç¨‹é•œåƒä»“åº“ï¼Œä¸ä¼šä¿®æ”¹æœ¬åœ°åˆ†æ”¯å’Œå·¥ä½œåŒºå†…å®¹)</p></li><li><p><code>git pull</code> æ‹‰å–ä¸Šæ¸¸åˆ†æ”¯çš„æ–°æäº¤å¹¶åˆå¹¶ï¼Œå®ƒæ˜¯<code>fetch</code>å’Œ<code>merge</code>2ä¸ªå‘½ä»¤çš„ç¼©å†™</p><blockquote><p>pull å‘½ä»¤éœ€è¦è¯¥åˆ†æ”¯æ‹¥æœ‰ä¸Šæ¸¸åˆ†æ”¯ï¼Œå¦‚æœæ²¡æœ‰ä¸Šæ¸¸åˆ†æ”¯ä¼šæç¤ºé”™è¯¯ä¿¡æ¯ï¼Œå®ƒä¼šè¿è¡Œ<code>git fetch</code>å°†è¿œç¨‹ä»“åº“çš„ä¿¡æ¯æ‹‰å–ä¸‹æ¥ï¼Œç„¶åè¿è¡Œ<code>git merge</code>åˆå¹¶è¿œç¨‹çš„æäº¤</p></blockquote></li><li><p><code>git branch -u(--set-upstream-to) &lt;è¿œç¨‹åˆ†æ”¯å¼•ç”¨&gt;</code> è®¾ç½®&#x2F;ä¿®æ”¹å½“å‰åˆ†æ”¯çš„ä¸Šæ¸¸åˆ†æ”¯å¼•ç”¨</p><blockquote><p><code>git branch -u origin/dev</code> è®¾ç½®&#x2F;ä¿®æ”¹å½“å‰åˆ†æ”¯çš„ä¸Šæ¸¸åˆ†æ”¯ä¸ºoriginä»“åº“çš„devåˆ†æ”¯</p><p>å½“æŸä¸ªåˆ†æ”¯æ‹¥æœ‰ä¸Šæ¸¸åˆ†æ”¯åï¼Œå¯ä»¥ä½¿ç”¨{u(upstream)}ä»£æ›¿ä¸Šæ¸¸åˆ†æ”¯</p></blockquote></li><li><p><code>git push</code> å°†å½“å‰åˆ†æ”¯çš„æ–°æäº¤æ¨é€åˆ°ä¸Šæ¸¸åˆ†æ”¯</p><blockquote><p><code>git push origin refs/head/dev:refs/head/dev</code> è¿™æ˜¯æ¨é€å‘½ä»¤çš„å…¨ç§°ï¼Œå°†æœ¬åœ°devåˆ†æ”¯æ¨é€åˆ°è¿œç¨‹devåˆ†æ”¯ä¸Š</p><p><code>git push origin v1.0</code> æ¨é€æŒ‡å®šæ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“(é»˜è®¤æ¨é€å¹¶ä¸ä¼šæ¨é€æ ‡ç­¾)</p><p><code>git push origin --tags</code> æ¨é€æ‰€æœ‰æ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“</p><p><code>git push origin --delete dev</code> åˆ é™¤è¿œç¨‹ä»“åº“çš„devåˆ†æ”¯</p><p><code>git push origin --delete v1.0</code> åˆ é™¤è¿œç¨‹ä»“åº“çš„v1.0åˆ†æ”¯</p><p><code>git push origin --delete</code>å‘½ä»¤å®é™…æ˜¯<code>git push origin :refs/head/dev</code>ï¼Œæ¨é€ä¸€ä¸ªç©ºå¯¹è±¡è¦†ç›–è¿œç¨‹ä»“åº“çš„devåˆ†æ”¯(è¿™ä¹ˆåšåªæ˜¯ä»æœåŠ¡å™¨ä¸Šç§»é™¤ä¸€ä¸ªæŒ‡é’ˆï¼ŒGité€šå¸¸ä¼šå°†æ•°æ®ä¿å­˜ä¸€æ®µæ—¶é—´ç›´åˆ°åƒåœ¾å›æ”¶æœºåˆ¶è¿è¡Œã€‚</p></blockquote></li></ul><h4 id="Git-Tag"><a href="#Git-Tag" class="headerlink" title="Git Tag"></a>Git Tag</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tagå’ŒBranchçš„åŒºåˆ«ï¼š</span><br><span class="line"></span><br><span class="line">ç›¸åŒç‚¹ï¼šéƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘commitå¯¹è±¡çš„æŒ‡é’ˆ</span><br><span class="line"></span><br><span class="line">ä¸åŒç‚¹ï¼šTagçš„ä½ç½®æ˜¯å›ºå®šçš„ï¼Œæ°¸è¿œæŒ‡å‘ä¸€ä¸ªå…·ä½“çš„commitå¯¹è±¡ã€‚è€ŒBranchä¼šéšç€åˆ†æ”¯çš„æäº¤æˆ–å›æ»šå˜åŒ–ä½ç½®ã€‚</span><br><span class="line"></span><br><span class="line">è½»é‡Tagå’Œé™„æ³¨Tagçš„åŒºåˆ«ï¼š</span><br><span class="line"></span><br><span class="line">è½»é‡Tagå°±åƒä¸€ä¸ªä¸ä¼šæ”¹å˜çš„åˆ†æ”¯ï¼Œå®ƒåªæ˜¯æŸä¸ªç‰¹å®šæäº¤çš„å¼•ç”¨ï¼›è€Œé™„æ³¨Tagåˆ™æ˜¯ä¸€ä¸ªå®Œæ•´çš„Gitå¯¹è±¡ï¼Œå®ƒåŒ…å«æ‰“æ ‡ç­¾è€…çš„ç›¸å…³ä¿¡æ¯ã€æ‰“æ ‡ç­¾çš„æ—¶é—´ã€æ‰“æ ‡ç­¾çš„è¯´æ˜ï¼Œè¿˜æ”¯æŒGPGç­¾åå’ŒéªŒè¯ã€‚</span><br></pre></td></tr></table></figure><ul><li><p><code>git tag &lt;æ ‡ç­¾å&gt;</code> ç»™å½“å‰æäº¤åˆ›å»ºä¸€ä¸ªè½»é‡Tag</p><blockquote><p><code>-a</code> åˆ›å»ºä¸€ä¸ªé™„æ³¨Tag</p><p><code>&lt;hash&gt;</code> å°¾éšä¸€ä¸ªå“ˆå¸Œå€¼ï¼Œå¯ä»¥ç»™æŒ‡å®šæäº¤åˆ›å»ºTag</p><p><code>-s</code> ä½¿ç”¨GPGå¯¹æ ‡ç­¾è¿›è¡Œç­¾å</p><p><code>-l(--list) &quot;v1.*&quot;</code> æ˜¾ç¤ºæ‰€æœ‰ä»¥â€v1.â€å¼€å¤´çš„æ ‡ç­¾ï¼Œæ”¯æŒæ­£åˆ™åŒ¹é…</p><p><code>-v</code> ä½¿ç”¨GPGéªŒè¯ç­¾å(å‰ææ˜¯ç­¾åè€…çš„å…¬é’¥éœ€è¦åœ¨ä½ çš„é’¥åŒ™é“¾ä¸­)</p></blockquote></li></ul><h4 id="Git-Branch"><a href="#Git-Branch" class="headerlink" title="Git Branch"></a>Git Branch</h4><ul><li><p><code>git branch</code> æ˜¾ç¤ºæ‰€æœ‰æœ¬åœ°åˆ†æ”¯</p><blockquote><p><code>-v</code> æ˜¾ç¤ºåˆ†æ”¯å¯¹åº”çš„æœ€æ–°æäº¤</p><p><code>-vv</code> æ˜¾ç¤ºåˆ†æ”¯ä¸ä¸Šæ¸¸åˆ†æ”¯çš„è½å&#x2F;é¢†å…ˆæƒ…å†µ</p><p><code>-merged</code> æ˜¾ç¤ºä¸å½“å‰åˆ†æ”¯å·²åˆå¹¶çš„åˆ†æ”¯</p><p><code>--no-merged</code> æ˜¾ç¤ºä¸å½“å‰åˆ†æ”¯æœªåˆå¹¶çš„åˆ†æ”¯</p></blockquote></li></ul><h4 id="Git-Merge"><a href="#Git-Merge" class="headerlink" title="Git Merge"></a>Git Merge</h4><ul><li><p><code>git merge &lt;åˆ†æ”¯å&gt;</code> åˆå¹¶æŒ‡å®šåˆ†æ”¯</p><blockquote><p><code>--squash</code> å°†åˆå¹¶äº§ç”Ÿçš„å¤šä¸ªæäº¤å‹ç¼©æˆä¸€ä¸ªæäº¤</p><p><code>--verify-signature</code> æ‹’ç»åˆå¹¶é‚£äº›GPGç­¾åéªŒè¯ä¸é€šè¿‡çš„æäº¤</p><p><code>-Xignore-space-change</code> å°†ä¸€ä¸ªç©ºç™½ç¬¦ä¸å¤šä¸ªè¿ç»­çš„ç©ºç™½å­—ç¬¦è§†ä½œç­‰ä»·</p><p><code>-Xignore-all-space</code> åˆå¹¶æ—¶å®Œå…¨å¿½ç•¥ç©ºç™½ä¿®æ”¹</p><p><code>-Xours</code> é‡åˆ°å†²çªæ—¶ä¿ç•™å½“å‰åˆ†æ”¯çš„ä¿®æ”¹å†…å®¹</p><p><code>-Xtheirs</code> é‡åˆ°å†²çªæ—¶ä¿ç•™ç›®æ ‡åˆ†æ”¯çš„ä¿®æ”¹å†…å®¹  </p></blockquote></li><li><p><code>git merge-base &lt;åˆ†æ”¯1&gt; &lt;åˆ†æ”¯2&gt;</code> è·å–2ä¸ªåˆ†æ”¯æœ€è¿‘çš„å…¬å…±æäº¤</p></li><li><p><code>git merge --verity-signature -S &lt;åˆ†æ”¯å&gt;</code> ç”Ÿæˆä¸€ä¸ªç­¾åçš„åˆå¹¶æäº¤</p></li><li><p><code>git merge -s ours &lt;åˆ†æ”¯å&gt;</code> åšä¸€æ¬¡å‡çš„åˆå¹¶ï¼Œè®°å½•ä¸€ä¸ªä»¥ä¸¤è¾¹åˆ†æ”¯ä½œä¸ºçˆ¶ç»“ç‚¹çš„æ–°åˆå¹¶æäº¤ï¼Œä½†æ˜¯å®ƒç”šè‡³æ ¹æœ¬ä¸å…³æ³¨ä½ æ­£åˆå¹¶å…¥çš„åˆ†æ”¯ï¼Œå®ƒåªä¼šç®€å•åœ°æŠŠå½“å‰åˆ†æ”¯çš„ä»£ç å½“ä½œåˆå¹¶ç»“æœè®°å½•ä¸‹æ¥</p><blockquote><p>å‡å¦‚ä½ æœ‰ä¸€ä¸ªåˆ†å‰çš„releaseåˆ†æ”¯å¹¶ä¸”åœ¨ä¸Šé¢åšäº†ä¸€äº›ä½ æƒ³è¦åœ¨æœªæ¥æŸä¸ªæ—¶å€™åˆå¹¶å›masterçš„å·¥ä½œï¼Œä¸æ­¤åŒæ—¶masteråˆ†æ”¯ä¸Šçš„æŸäº›bugfixéœ€è¦å‘åç§»æ¤å›releaseåˆ†æ”¯ï¼Œä½ å¯ä»¥åˆå¹¶bugfixåˆ†æ”¯è¿›å…¥releaseåˆ†æ”¯åŒæ—¶ä¹Ÿmerge -s ours åˆå¹¶è¿›å…¥ä½ çš„masteråˆ†æ”¯(å³ä½¿é‚£ä¸ªä¿®å¤å·²ç»åœ¨é‚£é‡Œäº†)è¿™æ ·å½“ä½ ä¹‹åå†æ¬¡åˆå¹¶releaseåˆ†æ”¯æ—¶ï¼Œå°±ä¸ä¼šæœ‰æ¥è‡ªbugfixçš„å†²çªã€‚</p></blockquote></li></ul><h4 id="Git-é‚®ç®±å·¥ä½œ"><a href="#Git-é‚®ç®±å·¥ä½œ" class="headerlink" title="Git é‚®ç®±å·¥ä½œ"></a>Git é‚®ç®±å·¥ä½œ</h4><ul><li><p><code>git format-patch -M &lt;åˆ†æ”¯å&gt;</code> ç”Ÿæˆå½“å‰åˆ†æ”¯å’ŒæŒ‡å®šåˆ†æ”¯ä¹‹é—´ä¸å…±æœ‰çš„æäº¤è¡¥ä¸æ–‡ä»¶åˆ°æ ¹ç›®å½•ä¸‹(æœ‰å‡ ä¸ªæäº¤å°±ä¼šç”Ÿæˆå‡ ä¸ªè¡¥ä¸æ–‡ä»¶)</p><blockquote><p>ç¤ºä¾‹ï¼š</p><p><code>git format-patch -M origin/master</code> ç”Ÿæˆå½“å‰åˆ†æ”¯å’Œorigin&#x2F;masteråˆ†æ”¯ä¹‹é—´ä¸å…±æœ‰çš„æäº¤è¡¥ä¸æ–‡ä»¶åˆ°æ ¹ç›®å½•ä¸‹(è¿™ä¼šç”Ÿæˆä¸€ä»½å¯ä»¥é‚®å¯„çš„mboxæ ¼å¼çš„æ–‡ä»¶ï¼Œå®ƒå°†æ¯ä¸€ä¸ªæäº¤è½¬æ¢ä¸ºä¸€å°ç”µå­é‚®ä»¶)ã€‚<code>-M</code>è¡¨ç¤ºå…è®¸Gitæ£€æŸ¥æ˜¯å¦æœ‰å¯¹æ–‡ä»¶é‡å‘½åçš„æäº¤</p></blockquote></li><li><p><code>git apply --check &lt;path&gt;</code> æ£€æŸ¥æŒ‡å®šè·¯å¾„ä¸‹çš„è¡¥ä¸å†…å®¹æ˜¯å¦å¯ä»¥è¢«åº”ç”¨</p></li><li><p><code>git apply &lt;path&gt;</code> åº”ç”¨æŒ‡å®šè·¯å¾„ä¸‹çš„è¡¥ä¸å†…å®¹</p></li><li><p><code>git am &lt;path&gt;</code> å’Œ<code>git apply</code>åŠŸèƒ½ç±»ä¼¼ï¼Œä¸è¿‡æ¯”å®ƒæ›´æ™ºèƒ½</p><blockquote><p><code>--resolved</code> ç»§ç»­åº”ç”¨ä¸‹ä¸€ä¸ªè¡¥ä¸</p><p><code>-3</code> è¡¨ç¤ºå½“åº”ç”¨è¡¥ä¸å‘ç”Ÿå†²çªæ—¶Gitä¼šå°è¯•è¿›è¡Œä¸‰æ–¹åˆå¹¶ï¼Œè¯¥é€‰é¡¹é»˜è®¤æ˜¯å…³é—­çš„</p><p><code>am</code>çš„å«ä¹‰ï¼šåº”ç”¨(Apply)ä¸€ç³»åˆ—æ¥è‡ªé‚®ç®±(Mailbox)çš„è¡¥ä¸</p><p><code>git apply</code>ç”¨äºåº”ç”¨<code>git diff</code>æˆ–<code>Unix diff</code>å‘½ä»¤åˆ›å»ºçš„è¡¥ä¸ï¼Œå®ƒå’Œ<code>patch -p1</code>å‘½ä»¤å‡ ä¹æ˜¯ç­‰æ•ˆçš„ï¼Œä½†æ˜¯<code>git apply</code>æ›´åŠ ä¸¥æ ¼ï¼Œç›¸å¯¹äº<code>patch</code>æ¥è¯´å®ƒèƒ½å¤Ÿæ¥å—çš„æ¨¡ç³ŠåŒ¹é…æ›´å°‘ï¼Œ<code>git apply</code>é‡‡ç”¨äº†ä¸€ç§â€è¦ä¹ˆå…¨éƒ¨åº”ç”¨ï¼Œè¦ä¹ˆå°±å…¨éƒ¨æ’¤é”€â€çš„æ¨¡å‹ï¼Œå³è¡¥ä¸åªæœ‰å…¨éƒ¨å†…å®¹éƒ½è¢«åº”ç”¨å’Œå…¨éƒ¨ä¸è¢«åº”ç”¨ä¸¤ç§çŠ¶æ€ï¼Œå¦‚æœè¡¥ä¸æ˜¯ç”¨<code>git format-patch</code>æ¥åˆ›å»ºçš„ï¼Œé‚£ä¹ˆå»ºè®®ä½¿ç”¨<code>git am</code>æ¥åº”ç”¨è¡¥ä¸ï¼Œåªæœ‰å¯¹è€å¼çš„è¡¥ä¸ï¼Œä½ æ‰å¿…é¡»ä½¿ç”¨<code>git apply</code></p></blockquote></li></ul><h4 id="Git-Rerere"><a href="#Git-Rerere" class="headerlink" title="Git Rerere"></a>Git Rerere</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Rerereæ˜¯â€œé‡ç”¨å·²è®°å½•çš„å†²çªè§£å†³æ–¹æ¡ˆâ€çš„æ„æ€ï¼Œå®ƒæ˜¯ä¸€ç§ç®€åŒ–å†²çªè§£å†³çš„æ–¹æ³•ï¼Œå½“å¯åŠ¨rerereæ—¶ï¼ŒGitä¼šç»´æŠ¤ä¸€äº›æˆåŠŸåˆå¹¶ä¹‹å‰å’Œä¹‹åçš„é•œåƒï¼Œå½“Gitå‘ç°ä¹‹å‰å·²ç»ä¿®å¤è¿‡ç±»ä¼¼çš„å†²çªæ—¶ï¼Œä¾¿ä¼šä½¿ç”¨ä¹‹å‰çš„ä¿®å¤æ–¹æ¡ˆè€Œä¸éœ€è¦ä½ çš„å¹²é¢„</span><br></pre></td></tr></table></figure><ul><li><p><code>git config --global rerere.enabled true</code> å¯ç”¨RerereåŠŸèƒ½</p><blockquote><p>å¯¹äºå·²ç»åˆ›å»ºçš„ä»“åº“å¦‚æœæƒ³å¯åŠ¨RerereåŠŸèƒ½ï¼Œéœ€è¦æ‰‹åŠ¨åœ¨.gitæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸€ä¸ªrr-cacheæ–‡ä»¶å¤¹</p><p>å¼€å¯Rerereåä¼šå¢åŠ æœ¬åœ°ä»“åº“çš„ä½“ç§¯ï¼Œrr-cacheæ–‡ä»¶å¤¹åªå­˜åœ¨äºæœ¬åœ°ä»“åº“ï¼Œä¸ä¼šæ¨é€åˆ°è¿œç¨‹  </p></blockquote></li><li><p><code>git checkout --conflict=merge &lt;path&gt;</code> å°†æŒ‡å®šæ–‡ä»¶æ¢å¤åˆ°Rerereæ‰§è¡Œå‰çš„çŠ¶æ€</p></li></ul><h4 id="Git-å½’æ¡£"><a href="#Git-å½’æ¡£" class="headerlink" title="Git å½’æ¡£"></a>Git å½’æ¡£</h4><ul><li><p><code>git archive &lt;commit&gt; --prefix=&#39;&lt;è§£å‹åçš„æ–‡ä»¶å&gt;/&#39; | gzip &gt; &lt;å‹ç¼©åŒ…çš„åç§°&gt;.tar.gz</code> åŸºäºæŒ‡å®šæäº¤å¯¹è±¡åˆ›å»ºä¸€ä¸ªå½“å‰æ‰€æœ‰å¿«ç…§å†…å®¹çš„å‹ç¼©æ–‡ä»¶</p><blockquote><p>ç¤ºä¾‹ï¼š</p><p><code>git archive master --prefix=&#39;project/&#39; &gt; gzip &gt; master.tar.gz</code> åŸºäºmasteræœ€æ–°æäº¤çš„æ‰€æœ‰å¿«ç…§å†…å®¹åˆ›å»ºä¸€ä¸ªtar.gzå‹ç¼©æ–‡ä»¶</p><p>git archive master â€“prefix&#x3D;â€™project&#x2F;â€˜ â€“format&#x3D;zip &gt; `git describe master`.zip åŸºäºmasteræœ€æ–°æäº¤çš„æ‰€æœ‰å¿«ç…§å†…å®¹åˆ›å»ºä¸€ä¸ªzipå‹ç¼©æ–‡ä»¶  </p></blockquote></li><li><p><code>git bundle</code> å¯¹åˆ†æ”¯è¿›è¡Œæ‰“åŒ…</p><blockquote><p>ç¤ºä¾‹ï¼š</p><p><code>git bundle create repo.bundle HEAD master</code> å¯¹masteråˆ†æ”¯çš„æ‰€æœ‰æäº¤å†å²è¿›è¡Œæ‰“åŒ…  </p></blockquote></li><li><p><code>git bundle verify &lt;path&gt;</code> æ£€æŸ¥æŒ‡å®šbundleåŒ…æ˜¯å¦åˆæ³•</p></li><li><p><code>git bundle list-heads &lt;path&gt;</code> åˆ—å‡ºæŒ‡å®šbundleåŒ…çš„å¼•ç”¨</p></li></ul><h4 id="Git-Stash"><a href="#Git-Stash" class="headerlink" title="Git Stash"></a>Git Stash</h4><ul><li><p><code>git stash</code> è´®è—æ‰€æœ‰å·²è·Ÿè¸ªçš„æœªæäº¤æ–‡ä»¶ï¼Œå¹¶è¿˜åŸæš‚å­˜åŒºå’Œå·¥ä½œåŒºçš„ä¿®æ”¹å˜åŒ–</p><blockquote><p><code>-u(--include-untracked)</code> è´®è—æ‰€æœ‰å·²è·Ÿè¸ªå’Œæœªè·Ÿè¸ªçš„æ–‡ä»¶(ä¸åŒ…æ‹¬å¿½ç•¥æ–‡ä»¶)</p><p><code>-a(--all)</code> è´®è—æ‰€æœ‰æ–‡ä»¶(åŒ…æ‹¬å¿½ç•¥æ–‡ä»¶)</p><p><code>--keep-index</code> ä¿å­˜åˆ°è´®è—çš„åŒæ—¶ä¸æ¸…ç©ºæš‚å­˜åŒºçš„å†…å®¹</p><p><code>list</code> æŸ¥çœ‹æ‰€æœ‰è´®è—æ–‡ä»¶åˆ—è¡¨</p><p><code>apply</code> æ¢å¤æœ€æ–°çš„è´®è—æ–‡ä»¶ä½†ä¸åˆ é™¤ï¼Œå¯ä»¥æŒ‡å®šæŸä¸ªè´®è—æ–‡ä»¶</p><p><code>pop</code> å’Œapplyå‘½ä»¤ä¸€æ ·ä½†æ˜¯ä¼šè‡ªåŠ¨åˆ é™¤è´®è—æ–‡ä»¶(ä»…åœ¨æ¢å¤æˆåŠŸæ—¶è‡ªåŠ¨åˆ é™¤)</p><p><code>--index</code> å¦‚æœåœ¨<code>pop</code>å’Œ<code>apply</code>æ—¶åŠ ä¸Šæ­¤é€‰é¡¹ä¼šæŠŠè´®è—å‰åœ¨æš‚å­˜åŒºçš„å†…å®¹é‡æ–°åŠ åˆ°æš‚å­˜åŒºä¸­ï¼Œé»˜è®¤å…¨éƒ¨æ¢å¤åœ¨å·¥ä½œåŒº  </p></blockquote></li><li><p><code>git stash &lt;è´®è—æ–‡ä»¶&gt; &lt;åˆ†æ”¯å&gt;</code> ä½¿ç”¨æŒ‡å®šè´®è—æ–‡ä»¶åˆ›å»ºä¸€ä¸ªåˆ†æ”¯</p></li></ul><h4 id="Git-Add"><a href="#Git-Add" class="headerlink" title="Git Add"></a>Git Add</h4><ul><li><p><code>git add</code> å°†æ–‡ä»¶åŠ å…¥åˆ°æš‚å­˜åŒºä¸­</p><blockquote><p><code>-i(--interactive)</code> ä½¿ç”¨äº¤äº’å¼ç»ˆç«¯æ¨¡å¼è¿›è¡Œæš‚å­˜</p><p><code>-p(--patch)</code> è‡ªå®šä¹‰æš‚å­˜è¡¥ä¸æ–‡ä»¶(è¯¥å‘½ä»¤åªæ˜¯-içš„ä¸€ä¸ªå­å‘½ä»¤)</p></blockquote></li></ul><h4 id="Git-Commit"><a href="#Git-Commit" class="headerlink" title="Git Commit"></a>Git Commit</h4><ul><li><p><code>git commit</code> å°†æš‚å­˜åŒºçš„æ–‡ä»¶æäº¤åˆ°Gitä»“åº“</p><blockquote><p><code>-S</code> ä½¿ç”¨GPGç­¾åæ­¤æ¬¡æäº¤</p><p><code>-m &quot;æ³¨é‡Š&quot;</code> ä½¿ç”¨æŒ‡å®šæ³¨é‡Šä½œä¸ºæäº¤å†…å®¹</p><p><code>-a</code> å°†å·²è·Ÿè¸ªçš„æ‰€æœ‰æ–‡ä»¶åŠ å…¥åˆ°æš‚å­˜åŒº(æœªè·Ÿè¸ªçš„æ–‡ä»¶ä¸ä¼šåŠ å…¥åˆ°æš‚å­˜åŒº)</p><p><code>-am</code> -aå’Œ-mè¿™2ä¸ªå‘½ä»¤çš„ç¼©å†™</p></blockquote></li></ul><h4 id="Git-æœç´¢"><a href="#Git-æœç´¢" class="headerlink" title="Git æœç´¢"></a>Git æœç´¢</h4><ul><li><p><code>git grep &lt;å­—ç¬¦ä¸²&gt;</code> åœ¨å·¥ä½œåŒºä¸­æœç´¢æŒ‡å®šå­—ç¬¦ä¸²å‡ºç°çš„æ‰€æœ‰ä½ç½®</p><blockquote><p>ç¤ºä¾‹ï¼š</p><p><code>git grep --break --heading -n -e &#39;#define&#39; --and \( -e kEncryptionSecret -e kEncryptionKey \) v4.6.0</code> æŸ¥çœ‹åœ¨v4.6.0æ ‡ç­¾çš„Gitä»£ç åº“ä¸­å®šä¹‰äº†å¸¸é‡ååŒ…å«â€kEncryptionSecretâ€æˆ–â€kEncryptionKeyâ€è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²çš„ä½ç½®</p><p><code>-n(--line-number)</code> æ˜¾ç¤ºåœ¨æ–‡ä»¶ä¸­çš„è¡Œæ•°</p><p><code>-c(--count)</code> æ˜¾ç¤ºåœ¨æ–‡ä»¶ä¸­åŒ¹é…çš„æ•°é‡</p><p><code>-p(--show-function)</code> æ˜¾ç¤ºè¯¥å­—ç¬¦ä¸²ä¸Šä¸‹æ–‡å†…å®¹</p></blockquote></li></ul><h4 id="Git-Subtree"><a href="#Git-Subtree" class="headerlink" title="Git Subtree"></a>Git Subtree</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¿™é‡Œæ²¡æœ‰æåˆ° git submodule(å­æ¨¡å—)ï¼Œå› ä¸ºä½¿ç”¨å­æ¨¡å—ç›¸æ¯”Subtreeæ›´éº»çƒ¦ï¼Œä¾‹å¦‚åœ¨æœ‰å­æ¨¡å—çš„ä»“åº“ä¸­åˆ‡æ¢åˆ†æ”¯éœ€è¦é‡æ–°åˆå§‹åŒ–ä¸€ä¸‹å­æ¨¡å—ï¼Œgit subtreeå¯ä»¥å®ç°git submoduleçš„åŠŸèƒ½ï¼Œå¹¶ä¸”æ¯”git submoduleæ›´ç®€å•ã€‚</span><br></pre></td></tr></table></figure><ul><li><p><code>git subtree add --prefix=&lt;path&gt; &lt;link&gt; &lt;åˆ†æ”¯å&gt;</code> æ·»åŠ æŒ‡å®šä»“åº“ä¸‹çš„æŒ‡å®šåˆ†æ”¯å†…å®¹åˆ°æŒ‡å®šè·¯å¾„ä¸‹</p><blockquote><p>ç¤ºä¾‹ï¼š</p><p><code>git subtree add --prefix=sub/libpng &lt;link&gt; master</code> æ‹‰å–æŒ‡å®šä»“åº“ä¸‹masteråˆ†æ”¯åˆ°sub&#x2F;libpngæ–‡ä»¶å¤¹ä¸‹  </p></blockquote></li><li><p><code>git subtree pull --prefix=&lt;path&gt; &lt;link&gt; &lt;åˆ†æ”¯å&gt;</code> æ‹‰å–å­æ ‘çš„ä¿®æ”¹æäº¤</p></li><li><p><code>git subtree push --prefix=&lt;path&gt; &lt;link&gt; &lt;åˆ†æ”¯å&gt;</code> æ¨é€å­æ ‘çš„ä¿®æ”¹æäº¤</p></li></ul><h4 id="Git-Filter"><a href="#Git-Filter" class="headerlink" title="Git Filter"></a>Git Filter</h4><ul><li><p><code>git filter-branch</code> é‡å†™æäº¤å†å²</p><blockquote><p>ç¤ºä¾‹ï¼š</p><p><code>git filter-branch --tree-filter &#39;rm -f password.txt&#39; HEAD</code> ä»Gitä»“åº“ä¸­åˆ é™¤password.txtï¼Œâ€“tree-filterè¡¨ç¤ºæ£€å‡ºé¡¹ç›®çš„æ¯ä¸€ä¸ªæäº¤åè¿è¡ŒæŒ‡å®šçš„å‘½ä»¤ç„¶åé‡æ–°æäº¤ç»“æœï¼Œå¦‚æœè¦è®©ä¸Šè¿°å‘½ä»¤åœ¨æ‰€æœ‰åˆ†æ”¯ä¸Šè¿è¡Œï¼Œå¯ä»¥åŠ ä¸Šâ€“all</p><p><code>git filter-branch --subdirectory-filter trunk HEAD</code> å°†trunkå­ç›®å½•è®¾ç½®ä¸ºé¡¹ç›®çš„æ ¹ç›®å½•ï¼ŒGitä¼šè‡ªåŠ¨ç§»é™¤æ‰€æœ‰ä¸å½±å“å­ç›®å½•çš„æäº¤</p></blockquote>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git filter-branch --commit-filter &#x27;</span><br><span class="line">if [ &quot;$GIT_AUTHOR_EMAIL&quot; = &quot;internetwei@foxmail.com&quot; ];</span><br><span class="line">then</span><br><span class="line">        GIT_AUTHOR_NAME=&quot;Scott Chacon&quot;;</span><br><span class="line">        GIT_AUTHOR_EMAIL=&quot;schacon@example.com&quot;;</span><br><span class="line">        git commit-tree &quot;$@&quot;;</span><br><span class="line">else</span><br><span class="line">        git commit-tree &quot;$@&quot;;</span><br><span class="line">fi&#x27; HEAD </span><br><span class="line"></span><br><span class="line">éå†æ‰€æœ‰æäº¤ï¼Œå¦‚æœä½œè€…é‚®ä»¶åœ°å€æ˜¯internetwei@foxmail.comåˆ™ä¿®æ”¹ä½œè€…åç§°å’Œé‚®ä»¶åœ°å€(å³ä½¿æŸä¸ªæäº¤ä¸ç”¨ä¿®æ”¹ä½†æ˜¯å®ƒçš„å“ˆå¸Œå€¼ä¹Ÿä¼šæ›´æ”¹)</span><br></pre></td></tr></table></figure></li><li><p><code>git filter-repo</code> é‡å†™æäº¤å†å²</p><blockquote><p>Gitå®˜æ–¹å»ºè®®ä½¿ç”¨git filter-repoè€Œä¸æ˜¯git filter-branchï¼Œå› ä¸ºgit filter-branchåœ¨é‡å†™æäº¤å†å²æ—¶å……æ»¡å¤§é‡çš„é™·é˜±ï¼Œæ€§èƒ½ä¹Ÿå¾ˆä½ï¼Œå®ƒçš„è®¾è®¡æ¶æ„åœ¨æ¥å£çš„æ¯ä¸€å±‚éƒ½å­˜åœ¨æ³„æ¼ï¼Œè¿™ä½¿å¾—å®ƒå‡ ä¹ä¸å¯èƒ½åœ¨ä¸å‘åå…¼å®¹çš„æƒ…å†µä¸‹æ›´æ”¹è®¾è®¡çš„ä»»ä½•å†…å®¹ã€‚ç›¸æ¯”è¾ƒè€Œè¨€git filter-repoçš„åŠŸèƒ½æ›´å¤šï¼Œè€Œä¸”æ€§èƒ½ä¹Ÿé«˜å‡ºå¾ˆå¤š(æœ‰èµ„æ–™è¯´ç”¨git filter-repoå‡ ä¸ªå°æ—¶å®Œæˆçš„ä»»åŠ¡ç”¨git filter-branchéœ€è¦ç­‰å¾…3ä¸ªæœˆ)ã€‚</p><p><code>git filter-repo --path-rename &lt;old_name:new_name&gt;</code> éå†æäº¤å†å²ï¼Œå°†ä½œè€…åä»old_nameä¿®æ”¹ä¸ºnew_name</p><p><code>--tag-rename &lt;old_tag:new_tag&gt;</code> éå†æäº¤å†å²ï¼Œé‡å‘½åä»¥oldå¼€å¤´çš„æ ‡ç­¾å¹¶ä»¥newå¼€å¤´ï¼Œä¾‹å¦‚<code>--tag-rename foo:bar</code>ä¼šå°†foo-1.2æ”¹ä¸ºbar-1.2</p><p>æƒ³å­¦ä¹ git filter-repoè¯·æŸ¥çœ‹<a href="https://htmlpreview.github.io/?https://github.com/newren/git-filter-repo/blob/docs/html/git-filter-repo.html">git filter-repoå‘½ä»¤æ‰‹å†Œ</a></p></blockquote></li></ul><h4 id="Git-Show"><a href="#Git-Show" class="headerlink" title="Git Show"></a>Git Show</h4><ul><li><p><code>git show &lt;åˆ†æ”¯å&gt;@&#123;yesterday&#125;</code> æŸ¥çœ‹æŒ‡å®šåˆ†æ”¯åœ¨æ˜¨å¤©çš„æœ€åä¸€æ¬¡æäº¤å¯¹è±¡</p><blockquote><p>yesterdayå¯ä»¥æ˜¯å…¶ä»–ä»»æ„Gitå¯ä»¥è¯†åˆ«çš„æ—¶é—´  </p></blockquote></li><li><p><code>git show &lt;commit&gt;:&lt;path&gt;</code> æŸ¥çœ‹æŒ‡å®šæäº¤ä¸‹æŒ‡å®šæ–‡ä»¶çš„å†…å®¹</p></li></ul><h4 id="Git-Reset"><a href="#Git-Reset" class="headerlink" title="Git Reset"></a>Git Reset</h4><ul><li><p><code>git reset --soft &lt;commit&gt;</code> å°†å½“å‰åˆ†æ”¯ç§»åŠ¨åˆ°æŒ‡å®šæäº¤ä¸Š(è¿™æ ·åšä¼šå¯¼è‡´Gitä»“åº“å’Œæš‚å­˜åŒºä¸å·¥ä½œåŒºçš„å†…å®¹ä¸ä¸€è‡´ï¼Œè€Œæš‚å­˜åŒºå’Œå·¥ä½œåŒºçš„å†…å®¹ä¸€è‡´ï¼Œæ‰€ä»¥Gitä¼šæç¤ºä½ è¿›è¡Œcommitæ“ä½œå’ŒGitä»“åº“ä¿æŒä¸€è‡´)ï¼Œå¦‚å›¾11ã€‚</p><p>   <img src="646fd8d8cf5941a1a2a3bbd2c140423c~tplv-k3u1fbpfcp-zoom-1.image"> å›¾11</p></li><li><p><code>git reset --mixed &lt;commit&gt;</code> é»˜è®¤è¡Œä¸ºï¼Œå°†å½“å‰åˆ†æ”¯ç§»åŠ¨åˆ°æŒ‡å®šæäº¤ä¸Šå¹¶ä¸”æ›´æ–°æš‚å­˜åŒºçš„å†…å®¹(è¿™æ ·åšä¼šå¯¼è‡´Gitä»“åº“å’Œæš‚å­˜åŒºçš„å†…å®¹ä¸€è‡´ï¼Œä½†æ˜¯å’Œå·¥ä½œåŒºçš„å†…å®¹ä¸ä¸€è‡´ï¼Œè¿™æ—¶Gitä¼šæäº¤ä½ è¿›è¡Œaddæ“ä½œå°†éœ€è¦æäº¤çš„æ–‡ä»¶æ·»åŠ åˆ°æš‚å­˜åŒº)ï¼Œå¦‚å›¾12</p><p>   <img src="aefb6b8501144712b39ccb51ad152e54~tplv-k3u1fbpfcp-zoom-1.image"> å›¾12</p></li><li><p><code>git reset --hard &lt;commit&gt;</code> å°†å½“å‰åˆ†æ”¯ç§»åŠ¨åˆ°æŒ‡å®šæäº¤ä¸Šå¹¶ä¸”æ›´æ–°æš‚å­˜åŒºå’Œå·¥ä½œåŒºçš„å†…å®¹ï¼Œè¿™ä¹Ÿæ˜¯resetå”¯ä¸€å±é™©çš„å‘½ä»¤(è¿™æ ·åšGitä¼šä½¿ç”¨ç‰ˆæœ¬åº“ä¸­çš„å†…å®¹æ›´æ–°(è¦†ç›–)æš‚å­˜åŒºå’Œå·¥ä½œåŒºçš„å†…å®¹)ï¼Œå¦‚å›¾13</p><p>   <img src="63c1aeeafb13499885b805f05815048a~tplv-k3u1fbpfcp-zoom-1.image"> å›¾13</p></li><li><p><code>git reset &lt;path&gt;</code> å°†æŒ‡å®šæ–‡ä»¶ä»æš‚å­˜åŒºä¸­åˆ é™¤</p><blockquote><p>å®ƒæœ¬è´¨ä¸Šè°ƒç”¨çš„æ˜¯<code>git reset --mixed HEAD &lt;path&gt;</code>å‘½ä»¤ï¼Œä½¿ç”¨ç‰ˆæœ¬åº“ä¸­çš„æŒ‡å®šæ–‡ä»¶è¦†ç›–æš‚å­˜åŒºçš„æ–‡ä»¶ï¼Œæ‰€ä»¥å®ƒå¯ä»¥å°†æ–‡ä»¶ä»æš‚å­˜åŒºä¸­ç§»é™¤</p></blockquote></li></ul><h4 id="Git-Checkout"><a href="#Git-Checkout" class="headerlink" title="Git Checkout"></a>Git Checkout</h4><ul><li><p><code>git checkout -b &lt;åˆ†æ”¯å&gt;</code> åˆ›å»ºå¹¶åˆ‡æ¢åˆ°æŒ‡å®šåˆ†æ”¯</p><blockquote><p>è¯¥å‘½ä»¤å…¶å®æ˜¯<code>git branch &lt;åˆ†æ”¯å&gt;</code>å’Œ<code>git checkout &lt;åˆ†æ”¯å&gt;</code>çš„ç¼©å†™</p><p>åˆ‡æ¢åˆ†æ”¯å»ºè®®ä½¿ç”¨<code>git switch &lt;åˆ†æ”¯å&gt;</code>ï¼Œä¸€æ˜¯å› ä¸ºswitchæ¯”checkoutæ›´å®¹æ˜“ç†è§£ï¼ŒäºŒæ˜¯å› ä¸ºswitchå‘½ä»¤æ¯”checkoutå‘½ä»¤æ›´å®‰å…¨(ä¾‹å¦‚æœ¬åœ°æœ‰ä¸€ä¸ªæ–‡ä»¶åå’ŒæŸä¸€ä¸ªåˆ†æ”¯åŒåï¼Œå½“ä½ ä½¿ç”¨git checkout &lt;æ–‡ä»¶&#x2F;åˆ†æ”¯å&gt; æ—¶å¯èƒ½ä¼šä¸å°å¿ƒè¦†ç›–å·¥ä½œåŒºçš„å†…å®¹)</p></blockquote></li><li><p><code>git checkout -- &lt;path&gt;</code> æ’¤é”€å·¥ä½œåŒºæŒ‡å®šæ–‡ä»¶çš„ä¿®æ”¹</p><blockquote><p>è¯¥å‘½ä»¤ä¼šä½¿ç”¨å½“å‰ç‰ˆæœ¬åº“ä¸­çš„æŒ‡å®šæ–‡ä»¶è¦†ç›–å·¥ä½œåŒºçš„æŒ‡å®šæ–‡ä»¶ï¼Œå¦‚æœå·¥ä½œåŒºçš„æ–‡ä»¶æœ‰ä»»ä½•ä¿®æ”¹å°†ä¼šä¸¢å¤±</p></blockquote></li></ul><h4 id="Git-Revert"><a href="#Git-Revert" class="headerlink" title="Git Revert"></a>Git Revert</h4><ul><li><p><code>git revert &lt;commit&gt;</code> è¿˜åŸæŒ‡å®šæäº¤çš„å†…å®¹</p><blockquote><p>è¯¥å‘½ä»¤ç”¨äºå°†æŸæ¬¡æäº¤çš„å†…å®¹é‡ç½®å¹¶ç”Ÿæˆä¸€æ¬¡æ–°æäº¤</p></blockquote></li></ul><h4 id="Git-Blame"><a href="#Git-Blame" class="headerlink" title="Git Blame"></a>Git Blame</h4><ul><li><p><code>git blame -L &lt;range&gt; &lt;path&gt;</code> æŸ¥çœ‹æŒ‡å®šæ–‡ä»¶ä¸­æŒ‡å®šèŒƒå›´å†…çš„ä¿®æ”¹æäº¤è®°å½•</p><blockquote><p>ç¤ºä¾‹ï¼š</p><p><code>git blame -L 68,100 WXYZ_BookReaderViewController.m</code> æŸ¥çœ‹WXYZ_BookReaderViewController.mæ–‡ä»¶æœ‰å…³ç¬¬68åˆ°100è¡Œçš„ä¿®æ”¹æäº¤è®°å½•</p><p><code>-C</code> è¯¥é€‰é¡¹è¡¨ç¤ºGitä¼šåˆ†æä½ æ­£åœ¨æ ‡æ³¨çš„æ–‡ä»¶ï¼Œå¹¶ä¸”å°è¯•æ‰¾å‡ºæ–‡ä»¶ä¸­ä»£ç ç‰‡æ®µçš„åŸå§‹å‡ºå¤„</p></blockquote></li></ul><h4 id="Git-Bisect"><a href="#Git-Bisect" class="headerlink" title="Git Bisect"></a>Git Bisect</h4><ul><li><p><code>git bisect</code> ä½¿ç”¨äºŒåˆ†æœç´¢æŸ¥æ‰¾å¼•å…¥é”™è¯¯çš„æäº¤</p><blockquote><p>ä½¿ç”¨æµç¨‹ï¼š</p><p><code>git bisect start</code> å¯åŠ¨äºŒåˆ†æŸ¥æ‰¾</p><p><code>git bisect bad</code> å‘Šè¯‰Gitå½“å‰æäº¤æ˜¯æœ‰é—®é¢˜çš„</p><p><code>git bisect good &lt;commit&gt;</code> å‘Šè¯‰Gitæ²¡æœ‰é—®é¢˜çš„æäº¤æ˜¯å“ªä¸€æ¬¡</p><p><code>git bisect good</code> å‘Šè¯‰Gitå½“å‰æäº¤æ²¡æœ‰é—®é¢˜</p><p><code>git bisect reset</code> ç»“æŸäºŒåˆ†æŸ¥æ‰¾</p><p><code>git biesect start &lt;bad_id&gt; &lt;good_id&gt;</code> å¿«é€Ÿæ‰§è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸æ­£å¸¸çš„æäº¤ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ­£å¸¸çš„æäº¤</p><p><code>git bisect run &lt;path&gt;</code> æ‰§è¡Œè„šæœ¬è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾</p></blockquote></li></ul><h4 id="Git-Replace"><a href="#Git-Replace" class="headerlink" title="Git Replace"></a>Git Replace</h4><ul><li><p><code>git replace</code> æ›¿æ¢æŒ‡å®šå¯¹è±¡</p><blockquote><p><code>git replace &lt;commit1&gt; &lt;commit2&gt;</code> å°†commit1æ›¿æ¢ä¸ºcommit2</p></blockquote></li></ul><h4 id="Git-åº•å±‚å‘½ä»¤"><a href="#Git-åº•å±‚å‘½ä»¤" class="headerlink" title="Git åº•å±‚å‘½ä»¤"></a>Git åº•å±‚å‘½ä»¤</h4><ul><li><p><code>git ls-files</code> æ˜¾ç¤ºæœ‰å…³ç´¢å¼•å’Œå·¥ä½œæ ‘ä¸­æ–‡ä»¶çš„ä¿¡æ¯</p><blockquote><p><code>-u(--unmerged)</code> æ˜¾ç¤ºå†²çªå¯¹è±¡çš„å“ˆå¸Œå€¼</p><p><code>-s(--stage)</code> æ˜¾ç¤ºæš‚å­˜åŒºå½“å‰çŠ¶æ€  </p></blockquote></li><li><p><code>git rev-list</code> æŒ‰æ—¶é—´å€’åºåˆ—å‡ºæäº¤å¯¹è±¡</p><blockquote><p><code>--count &lt;åˆ†æ”¯å&gt;</code> æŸ¥çœ‹æŒ‡å®šåˆ†æ”¯çš„æäº¤æ•°é‡  </p></blockquote></li><li><p><code>git cat-file</code> æŸ¥çœ‹æŒ‡å®šå¯¹è±¡çš„å†…å®¹æˆ–ç±»å‹å’Œå¤§å°ä¿¡æ¯</p><blockquote><p><code>-p</code> è·å–æŒ‡å®šå¯¹è±¡çš„å†…å®¹æˆ–ç±»å‹ä¿¡æ¯</p><p><code>-t</code> è·å–æŒ‡å®šå¯¹è±¡çš„ç±»å‹</p><p><code>-s</code> è·å–æŒ‡å®šå¯¹è±¡çš„å¤§å°  </p></blockquote></li><li><p><code>git ls-tree</code> åˆ—å‡ºæ ‘å¯¹è±¡çš„å†…å®¹</p><blockquote><p><code>-r</code> é€’å½’å­æ ‘å¯¹è±¡ä¸‹çš„å†…å®¹  </p></blockquote></li><li><p><code>git update-ref</code> æ›´æ–°å­˜å‚¨åœ¨refä¸­çš„å¯¹è±¡åç§°</p><blockquote><p>ç¤ºä¾‹ï¼š</p><p><code>git update-ref refs/tags/v1.0 c7cfb9</code> ç»™æŒ‡å®šæäº¤å¯¹è±¡æ·»åŠ ä¸€ä¸ªè½»é‡æ ‡ç­¾  </p></blockquote></li><li><p><code>git count-objects -v</code> æŸ¥çœ‹ä»“åº“çš„è¯¦ç»†å ç”¨ç©ºé—´</p></li><li><p><code>git for-each-ref</code> æ˜¾ç¤ºæ‰€æœ‰çš„å¼•ç”¨</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘å·¥å…· </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ObjC é£æ ¼æŒ‡å—</title>
      <link href="/2021/08/07/iOS/ObjC%20%E9%A3%8E%E6%A0%BC%E6%8C%87%E5%8D%97/"/>
      <url>/2021/08/07/iOS/ObjC%20%E9%A3%8E%E6%A0%BC%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç”± å¸ƒå¤š(budo) å‘å¸ƒäº 2023-10-26 â€¢ æœ€åæ›´æ–°äº 2023-10-29</p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åˆ¶å®šé£æ ¼æŒ‡å—ä¸»è¦çš„ç›®çš„æ˜¯ç»Ÿä¸€å›¢é˜Ÿçš„ä»£ç é£æ ¼ä¸æ ·å¼ï¼Œæé«˜å·¥ä½œæ•ˆç‡ä¸é˜…è¯»æ€§è¿˜æœ‰ç»´æŠ¤æ€§ï¼›<br>è¿™ç¯‡æ–‡ç« è™½ç„¶æ˜¯OCé£æ ¼æŒ‡å—ï¼Œä½†æ˜¯æœ‰äº›é£æ ¼æ˜¯æ‰€æœ‰ç¼–ç¨‹è¯­è¨€é€šç”¨çš„ï¼Œå¦å¤–å®ƒè¿˜å‚è€ƒäº†<a href="https://github.com/alibaba/Alibaba-Java-Coding-Guidelines">é˜¿é‡Œå·´å·´Javaä»£ç è§„èŒƒ</a>ï¼Œæƒ³ä¸åˆ°å§ã€‚</p><h2 id="åŸåˆ™"><a href="#åŸåˆ™" class="headerlink" title="åŸåˆ™"></a>åŸåˆ™</h2><h3 id="ä¼˜åŒ–é˜…è¯»ä½“éªŒï¼Œè€Œéå†™ä»£ç çš„ä½“éªŒ"><a href="#ä¼˜åŒ–é˜…è¯»ä½“éªŒï¼Œè€Œéå†™ä»£ç çš„ä½“éªŒ" class="headerlink" title="ä¼˜åŒ–é˜…è¯»ä½“éªŒï¼Œè€Œéå†™ä»£ç çš„ä½“éªŒ"></a>ä¼˜åŒ–é˜…è¯»ä½“éªŒï¼Œè€Œéå†™ä»£ç çš„ä½“éªŒ</h3><p>&nbsp;&nbsp;&nbsp; ä»£ç åº“é€šå¸¸å…·æœ‰è¾ƒé•¿çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶ä¸”èŠ±åœ¨é˜…è¯»ä»£ç ä¸Šçš„æ—¶é—´ä¹Ÿè¿œå¤šäºç¼–å†™ä»£ç çš„æ—¶é—´ã€‚æ‰€ä»¥æˆ‘ä»¬åº”è¯¥æ˜ç¡®ä¸€ä¸ªç›®æ ‡ï¼šå»ä¼˜åŒ–åˆ«äººé˜…è¯»ã€ç»´æŠ¤æˆ‘ä»¬ä»£ç æ—¶çš„ä½“éªŒï¼Œè€Œä¸æ˜¯ä¼˜åŒ–å†™ä»£ç æ—¶çš„ä½“éªŒ(<code>ä¾‹å¦‚éšä¾¿ä½¿ç”¨ç¼©å†™è¿›è¡Œç¼–ç ï¼Œä»£ç é‡å˜å°‘äº†ï¼Œä½†æ˜¯å¢åŠ äº†é˜…è¯»å’Œç»´æŠ¤çš„éš¾åº¦</code>)ã€‚</p><p>&nbsp;&nbsp;&nbsp; é€‚å½“çš„è§„èŒƒé™åˆ¶å’Œæ ‡å‡†ä¸æ˜¯æ¶ˆç­ä»£ç å†…å®¹çš„åˆ›é€ æ€§ã€ä¼˜é›…æ€§ï¼Œè€Œæ˜¯é™åˆ¶è¿‡åº¦ä¸ªæ€§åŒ–ï¼Œä»¥ä¸€ç§æ™®éè®¤å¯çš„æ–¹å¼ä¸€èµ·åšäº‹ï¼Œè¿›è€Œæé«˜å·¥ä½œæ•ˆç‡ï¼Œé™ä½æ²Ÿé€šæˆæœ¬ã€‚æé«˜ç¨³å®šæ€§ã€‚</p><h3 id="ä¸ä¸Šä¸‹æ–‡å°½é‡ä¿æŒä¸€è‡´"><a href="#ä¸ä¸Šä¸‹æ–‡å°½é‡ä¿æŒä¸€è‡´" class="headerlink" title="ä¸ä¸Šä¸‹æ–‡å°½é‡ä¿æŒä¸€è‡´"></a>ä¸ä¸Šä¸‹æ–‡å°½é‡ä¿æŒä¸€è‡´</h3><p>&nbsp;&nbsp;&nbsp; å°½é‡ä¿æŒä»£ç åº“ä¸­çš„é£æ ¼æ ·å¼ä¸€è‡´ã€‚åœ¨æ•´ä¸ªä»£ç åº“ä¸­å§‹ç»ˆä¿æŒä¸€ç§é£æ ¼å¯ä»¥è®©å·¥ç¨‹å¸ˆæ›´ä¸“æ³¨äºå…¶ä»–(æ›´é‡è¦çš„)é—®é¢˜ã€‚ä¸€è‡´æ€§è¿˜å¯ä»¥å®ç°æ›´å¥½çš„è‡ªåŠ¨åŒ–ã€‚</p><p>&nbsp;&nbsp;&nbsp; å¦‚æœé£æ ¼æŒ‡å—ä¸­æ²¡æœ‰è¯´æ˜ï¼Œé‚£ä¹ˆå°±æŒ‰ç…§ä»£ç åº“ä¹‹å‰çš„é£æ ¼æ ·å¼æˆ–è€…å‚è€ƒ <code>Apple SDK</code> çš„é£æ ¼æ ·å¼ã€‚</p><h2 id="å‘½åé£æ ¼"><a href="#å‘½åé£æ ¼" class="headerlink" title="å‘½åé£æ ¼"></a>å‘½åé£æ ¼</h2><h3 id="é€šç”¨å‘½åé£æ ¼"><a href="#é€šç”¨å‘½åé£æ ¼" class="headerlink" title="é€šç”¨å‘½åé£æ ¼"></a>é€šç”¨å‘½åé£æ ¼</h3><ul><li><p><strong>[å¿…é¡»]</strong> æ¸…æ™°å’Œç®€æ´(<code>å¥½çš„åç§°åº”è¯¥æ˜¯èƒ½è‡ªæˆ‘æè¿°çš„</code>)ï¼Œç®€æ´çš„åŸåˆ™æ˜¯ä¸ºäº†ä¿æŒæ›´å¥½çš„æ¸…æ™°åº¦å’Œå¯è¯»æ€§ï¼Œè®°ä½ <strong>ä¸è¦æœ¬æœ«å€’ç½®</strong>ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">// ç§»é™¤ä¸€ä¸ªå¯¹è±¡ã€‚</span><br><span class="line">1. removeObject:</span><br><span class="line">// ä½¿ç”¨æŒ‡å®šå­—ç¬¦ä¸²æ›¿æ¢å‡ºç°è¿‡çš„å­—ç¬¦ä¸²ã€‚</span><br><span class="line">2. stringByReplacingOccurrencesOfString: withString:</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">// è¦ç§»é™¤ä»€ä¹ˆï¼Ÿ</span><br><span class="line">1. remove:</span><br><span class="line">// è¦å°†ä»€ä¹ˆæ›¿æ¢æˆä»€ä¹ˆï¼Ÿæ˜¯å…¨éƒ¨éƒ½æ›¿æ¢è¿˜æ˜¯åªæ›¿æ¢ç¬¬ä¸€ä¸ªåŒ¹é…çš„ä½ç½®ï¼Ÿ</span><br><span class="line">2. replace(&quot;1&quot;, &quot;2&quot;)</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> ä¸€è‡´æ€§ï¼šå‘½ååº”è¯¥å’Œä¸Šä¸‹æ–‡ä¹ƒè‡³å…¨å±€ä¿æŒä¸€è‡´æ€§ï¼Œç›¸åŒç±»å‹æˆ–è€…å…·æœ‰ç›¸åŒä½œç”¨æ–¹æ³•çš„åç§°åº”è¯¥ç›¸åŒæˆ–ç±»ä¼¼ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">1. NSDictionaryã€NSArrayã€NSSetè¿™äº›ç±»ä¸­åå« count çš„æ–¹æ³•æ‰€ä½“ç°çš„ä½œç”¨éƒ½æ˜¯ä¸€æ ·çš„ã€‚</span><br><span class="line">2. ç³»ç»Ÿçš„ä¸€äº›ä»£ç†æ–¹æ³•å’Œé€šçŸ¥çš„åç§°ä¹Ÿä¼šåˆ»æ„ä¿æŒä¸€è‡´ï¼Œ</span><br><span class="line">   ä¾‹å¦‚ `UIApplicationDelegate`åè®®ä¸­çš„ `applicationDidBecomeActive` æ–¹æ³•å</span><br><span class="line">   å°±å’Œ `UIApplicationDidBecomeActiveNotification`é€šçŸ¥çš„åç§°æ˜¯ä¸€è‡´çš„ã€‚</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> ç¦æ­¢è‡ªæˆ‘æŒ‡æ¶‰ï¼šå‘½åä¸è¦è‡ªæˆ‘æŒ‡æ¶‰(é€šçŸ¥ã€æ©ç æˆ–å¸¸é‡ç­‰é™¤å¤–)ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">NSString</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">NSStringObject</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> ç¦æ­¢è¿‡åº¦ç¼©å†™å’Œè‡ªåˆ›ç¼©å†™ï¼Œä¸€äº›é€šç”¨ç¼©å†™åé™¤å¤–(ä¾‹å¦‚ATMã€GPSã€maxã€minç­‰)ï¼Œå…·ä½“è¯·å‚è€ƒ <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CodingGuidelines/Articles/APIAbbreviations.html#//apple_ref/doc/uid/20001285-BCIHCGAE">å¯æ¥å—çš„ç¼©å†™è¯åˆ—è¡¨</a>ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips:</span><br><span class="line">é˜…è¯»è€…å¯èƒ½æ¥è‡ªä¸åŒçš„åœ°æ–¹æ¥å—ä¸åŒçš„æ•™è‚²å’Œä¸åŒçš„æ–‡åŒ–ï¼Œ</span><br><span class="line">ä»–ä»¬ä¸ä¸€å®šä¼šæ˜ç™½ä½ å†™çš„ç¼©å†™çš„æ„æ€ã€‚</span><br><span class="line"></span><br><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">setBackgroundColor</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">setBgColor</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> ç¦æ­¢ä½¿ç”¨æ— æ„ä¹‰çš„æ‹¼éŸ³ï¼Œå›½é™…é€šç”¨åã€åœ°åã€äººåé™¤å¤–ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">Beijingã€Alibaba</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">// æ‰“æŠ˜</span><br><span class="line">DaZhePromotion</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> ä»£ç å’Œæ³¨é‡Šä¸­é¿å…ä½¿ç”¨ä»»ä½•è¯­è¨€çš„ç§æ—æ­§è§†æ€§è¯è¯­ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">secondaryã€main</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">slaveã€master</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> ç¦æ­¢ä»¥newã€allocã€copyã€mutableCopyç­‰å…³é”®å­—ä½œä¸ºåç§°çš„å¼€å§‹éƒ¨åˆ†ã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> ç”±äº <strong>OC</strong> æ²¡æœ‰å‘½åç©ºé—´çš„æ¦‚å¿µï¼Œæ‰€ä»¥å…¨å±€åç§°(<code>ç±»åã€åè®®åã€å…¨å±€å¸¸é‡åã€å…¨å±€å˜é‡åã€å‡½æ•°åã€typedefåç§°</code>)å¿…é¡»æ·»åŠ å‰ç¼€ï¼Œå‰ç¼€ç”±3ä¸ªåŠä»¥ä¸Šå­—ç¬¦ç»„æˆä¸”å…¨éƒ¨å¤§å†™ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips: </span><br><span class="line">ç”±äºç³»ç»Ÿä¿ç•™ä»»æ„ä¸¤ä¸ªå­—ç¬¦ä½œä¸ºå‰ç¼€çš„ä½¿ç”¨æƒ(NSã€UIã€CGã€CFã€CAã€WKã€MKã€CIã€NCç­‰ç­‰)ï¼Œ</span><br><span class="line">ä¸ºäº†é¿å…å’Œç³»ç»Ÿå‘½åå†²çªï¼Œæ‰€ä»¥å‰ç¼€è‡³å°‘ç”±3ä¸ªå­—ç¬¦ç»„æˆã€‚</span><br><span class="line"></span><br><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">ZTYLoginViewController</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">ZTLoginViewController</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> å¦‚æœæŸä¸ªå…¨å±€åç§°(<code>ä¾‹å¦‚å‡½æ•°åã€é€šçŸ¥åã€åè®®æ–¹æ³•å</code>)å’ŒæŸä¸ªç±»æœ‰æ‰€å…³è”ï¼Œé‚£ä¹ˆè¯·ä½¿ç”¨ç›¸å…³ç±»åä½œä¸ºå…¶å‰ç¼€ï¼Œå¦åˆ™è¯·ä½¿ç”¨é€šç”¨å‰ç¼€ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">UIApplicationDidBecomeActiveNotification</span><br><span class="line">MAGUserLoginSuccessNotification</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> å‘½åé£æ ¼ç»Ÿä¸€ä½¿ç”¨ <strong>é©¼å³°å‘½åæ–¹å¼</strong> ï¼Œå±€éƒ¨å˜é‡åç­‰ç‰¹æ®Šåç§°å¯ä»¥ä¸éµå®ˆã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">totalRemain</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">total_remain</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> æˆå‘˜å˜é‡åç§°å¿…é¡»ä»¥_ä½œä¸ºå¼€å§‹éƒ¨åˆ†ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">_nameString</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">nameString</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> åœ¨ç»™å¸¸é‡æˆ–å˜é‡å‘½åæ—¶ï¼Œè¯·å°†è¡¨ç¤ºç±»å‹çš„åè¯æ”¾åœ¨è¯å°¾ï¼Œä»¥æé«˜è¾¨è¯†åº¦ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">nameLabelã€nameString</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">name</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> å¦‚æœæ¨¡å—ã€æ¥å£ã€ç±»ã€æ–¹æ³•ä½¿ç”¨äº†æŸç§æ¨¡å¼ï¼Œåœ¨å‘½åæ—¶å°½é‡ä½“ç°å‡ºå…·ä½“æ¨¡å¼ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">OrderFactoryã€LoginProxy</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> å»ºè®®ç»™ä¸´æ—¶å˜é‡åç§°æ·»åŠ å‰ç¼€ï¼Œä»¥æé«˜è¾¨è¯†åº¦(<code>ç‰¹æ®Šæƒ…å†µé™¤å¤–ï¼Œä¾‹å¦‚forå¾ªç¯é‡Œé¢çš„i</code>)ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">// tè¡¨ç¤ºtemp</span><br><span class="line">t_label</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">label</span><br></pre></td></tr></table></figure></li></ul><h3 id="ç±»åé£æ ¼"><a href="#ç±»åé£æ ¼" class="headerlink" title="ç±»åé£æ ¼"></a>ç±»åé£æ ¼</h3><ul><li><p><strong>[å¿…é¡»]</strong> ä¸€ä¸ªå®Œæ•´çš„ç±»åç”± <strong>å‰ç¼€+åç§°+ç±»å‹</strong> 3ä¸ªéƒ¨åˆ†ç»„æˆã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">MAGLoginViewControler</span><br><span class="line"></span><br><span class="line">å‰ç¼€ï¼šMAG</span><br><span class="line">åç§°ï¼šLogin</span><br><span class="line">ç±»å‹ï¼šViewControler</span><br></pre></td></tr></table></figure></li></ul><h3 id="åˆ†ç±»å‘½åé£æ ¼"><a href="#åˆ†ç±»å‘½åé£æ ¼" class="headerlink" title="åˆ†ç±»å‘½åé£æ ¼"></a>åˆ†ç±»å‘½åé£æ ¼</h3><ul><li><p><strong>[å¿…é¡»]</strong> åˆ†ç±»å‘½åé£æ ¼å’Œç±»åç±»ä¼¼ï¼Œç”± <strong>å‰ç¼€+åç§°</strong> 2ä¸ªéƒ¨åˆ†ç»„æˆã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">UIView (MAGAdd)</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">UIView (Add)</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> åˆ†ç±»ä¸­çš„æ–¹æ³•åå¿…é¡»è¦æ·»åŠ å‰ç¼€ï¼Œé˜²æ­¢è¦†ç›–ç³»ç»Ÿæˆ–3æ–¹åº“çš„ç§æœ‰æ–¹æ³•ï¼Œå‰ç¼€éœ€è¦ä¿æŒå”¯ä¸€æ€§(<code>ä¾‹å¦‚mp_</code>)ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">mp_substringFromString</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">substringFromString</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> åˆ†ç±»ä¸­å»ºè®®ä¸è¦å£°æ˜å±æ€§ï¼Œå°½é‡æŒªåˆ°ä¸»ç±»ä¸­å£°æ˜ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips: </span><br><span class="line">å°½ç®¡ä»æŠ€æœ¯ä¸Šæ¥è®²å¯ä»¥åœ¨åˆ†ç±»ä¸­å£°æ˜å±æ€§ï¼Œä½†æ˜¯è¿™ä¹ˆåšéœ€è¦æ ¼å¤–å°å¿ƒï¼Œ</span><br><span class="line">å› ä¸ºå®ƒå¾ˆå®¹æ˜“å‡ºç°å†…å­˜ä¸Šæˆ–å…¶ä»–ä¸€äº›é—®é¢˜ï¼Œè€Œä¸”å‡ºç°é—®é¢˜å¾ˆéš¾æ’æŸ¥ã€‚</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> å¦‚æœä¸€ä¸ªç±»æ¯”è¾ƒå¤æ‚ï¼Œå»ºè®®ä½¿ç”¨åˆ†ç±»é‡æ–°ç»„ç»‡ç»“æ„å’Œä»£ç (<code>å¯ä»¥å‚è€ƒç³»ç»Ÿçš„UIView</code>)ã€‚</p></li></ul><h3 id="æšä¸¾å‘½åé£æ ¼"><a href="#æšä¸¾å‘½åé£æ ¼" class="headerlink" title="æšä¸¾å‘½åé£æ ¼"></a>æšä¸¾å‘½åé£æ ¼</h3><ul><li><p><strong>[å¿…é¡»]</strong> æšä¸¾åç§°çš„å‰ç¼€åº”è¯¥å’Œ <strong>typedef</strong> çš„åç§°ä¿æŒä¸€è‡´ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">typedef NS_ENUM(NSInteger, MGradientChangeDirection) &#123;</span><br><span class="line">    MGradientChangeDirectionLevel,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">typedef NS_ENUM(NSInteger, MGradientChangeDirection) &#123;</span><br><span class="line">    level,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul><h3 id="æ–¹æ³•å‘½åé£æ ¼"><a href="#æ–¹æ³•å‘½åé£æ ¼" class="headerlink" title="æ–¹æ³•å‘½åé£æ ¼"></a>æ–¹æ³•å‘½åé£æ ¼</h3><ul><li><p><strong>[å¿…é¡»]</strong> æ–¹æ³•åç§°çš„å¼€å¤´ä¸€èˆ¬ä»¥å°å†™å­—æ¯å¼€å§‹ï¼Œç‰¹æ®Šå•è¯é™¤å¤–(<code>ä¾‹å¦‚HTTPã€URL</code>)ã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> æ–¹æ³•åç§°ç¦æ­¢ç›´æ¥ä½¿ç”¨_ä½œä¸ºå¼€å§‹éƒ¨åˆ†ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips: </span><br><span class="line">ç”±äºç³»ç»Ÿçš„ç§æœ‰æ–¹æ³•é€šå¸¸ä»¥_ä½œä¸ºå¼€å§‹éƒ¨åˆ†ï¼Œè¿™ä¹ˆåšå¯ä»¥é¿å…ä¸å°å¿ƒè¦†ç›–ç³»ç»Ÿç§æœ‰æ–¹æ³•ã€‚</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> ç§æœ‰æ–¹æ³•å¿…é¡»æ·»åŠ å‰ç¼€ï¼Œå‰ç¼€éœ€è¦ä¿æŒå”¯ä¸€æ€§(<code>ä¾‹å¦‚mp_</code>)ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips: </span><br><span class="line">ç»™ç§æœ‰æ–¹æ³•æ·»åŠ å‰ç¼€æœ‰å¦‚ä¸‹å¥½å¤„ï¼š</span><br><span class="line">1. æé«˜è¾¨è¯†åº¦ï¼Œæé«˜ä»£ç å¯è¯»æ€§ã€‚</span><br><span class="line">2. é¿å…ä¸å°å¿ƒè¦†ç›–ç³»ç»Ÿæˆ–æ¡†æ¶çš„ç§æœ‰æ–¹æ³•ã€‚</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> å¦‚æœæ–¹æ³•è¿”å›æŸä¸ªå±æ€§å€¼ï¼Œé‚£ä¹ˆè¯·ç›´æ¥ä½¿ç”¨å±æ€§åä½œä¸ºæ–¹æ³•åã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">- (CGSize)cellSize;</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">- (CGSize)getCellSize;</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> æ–¹æ³•çš„æ¯ä¸ªå‚æ•°å‰å¿…é¡»æ·»åŠ æœ‰æ•ˆå…³é”®å­—ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">- (void)sendAction:(SEL)aSelector </span><br><span class="line">          toObject:(id)anObject </span><br><span class="line">       forAllCells:(BOOL)flag;</span><br><span class="line">       </span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">- (void)sendAction:(SEL)aSelector </span><br><span class="line">                  :(id)anObject </span><br><span class="line">                  :(BOOL)flag;</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> å¦‚æœæŸä¸ªæ–¹æ³•æ˜¯ç”±é€šçŸ¥è§¦å‘çš„ï¼Œé‚£ä¹ˆè¯·ä½¿ç”¨ <code>Notification</code> å…³é”®å­—ä½œä¸ºåç§°åç¼€ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">appDidBecomeActiveNotification</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">appDidBecomeActive</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> å°½é‡ä¸è¦ä½¿ç”¨â€œandâ€è¿æ¥æ¥æ”¶è€…å±æ€§ï¼Œå°½ç®¡andè¯»èµ·æ¥è¿˜ç®—é¡ºå£ï¼Œä½†éšç€ä½ åˆ›å»ºçš„æ–¹æ³•å‚æ•°çš„å¢åŠ ï¼Œè¿™å°†ä¼šå¸¦æ¥ä¸€ç³»åˆ—çš„é—®é¢˜ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">- (int)runModalForDirectory:(NSString *)path </span><br><span class="line">                       file:(NSString *)name </span><br><span class="line">                      types:(NSArray *)fileTypes;</span><br><span class="line">                      </span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">- (int)runModalForDirectory:(NSString *)path </span><br><span class="line">                    andFile:(NSString *)name </span><br><span class="line">                   andTypes:(NSArray *)fileTypes;</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> å¦‚æœæ–¹æ³•æè¿°äº†ä¸¤ä¸ªç‹¬ç«‹çš„åŠ¨ä½œï¼Œåˆ™å¯ä»¥ä½¿ç”¨ <code>and</code> è¿æ¥ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">- (BOOL)openFile:(NSString *)fullPath </span><br><span class="line"> withApplication:(NSString *)appName </span><br><span class="line">   andDeactivate:(BOOL)flag;</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> å°½é‡ä¸è¦ä½¿ç”¨ <code>get</code> ä½œä¸ºæ–¹æ³•åç§°çš„å¼€å§‹éƒ¨åˆ†ï¼Œé™¤éè¿™ä¸ªæ–¹æ³•é—´æ¥è¿”å›å¯¹è±¡æˆ–å€¼ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">- (UIColor *)backgroundColor;</span><br><span class="line">- (void)getLineDash:(float *)pattern count:(int *)count phase:(float *)phase;</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">- (UIColor *)getBackgroundColor;</span><br></pre></td></tr></table></figure></li></ul><h3 id="åè®®å‘½åé£æ ¼"><a href="#åè®®å‘½åé£æ ¼" class="headerlink" title="åè®®å‘½åé£æ ¼"></a>åè®®å‘½åé£æ ¼</h3><ul><li><p><strong>[å¿…é¡»]</strong> åè®®ä¸­çš„æ–¹æ³•åä»¥è§¦å‘æ¶ˆæ¯çš„å¯¹è±¡åå¼€å¤´ï¼Œçœç•¥ç±»åå‰ç¼€å¹¶é¦–å­—æ¯å°å†™ï¼Œå¦‚æœå®ƒæ²¡æœ‰å…³è”ä»»ä½•ç±»åˆ™å¯ä»¥å¿½ç•¥è¿™ä¸ªè§„åˆ™ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">- (BOOL)tableView:(NSTableView *)tableView </span><br><span class="line">  shouldSelectRow:(int)row;</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> é™¤éåè®®æ–¹æ³•åªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œå¦åˆ™å†’å·éœ€ç´§è·Ÿåœ¨ç±»ååé¢ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">1. - (BOOL)tableView:(NSTableView *)tableView </span><br><span class="line">     shouldSelectRow:(int)row;</span><br><span class="line">  </span><br><span class="line">2. - (BOOL)applicationOpenUntitledFile:(NSApplication *)sender;</span><br></pre></td></tr></table></figure></li></ul><h3 id="é€šçŸ¥å‘½åé£æ ¼"><a href="#é€šçŸ¥å‘½åé£æ ¼" class="headerlink" title="é€šçŸ¥å‘½åé£æ ¼"></a>é€šçŸ¥å‘½åé£æ ¼</h3><ul><li><p><strong>[å¿…é¡»]</strong> ä¸€ä¸ªå®Œæ•´çš„é€šçŸ¥åç§°ç”± <strong>å…³è”çš„ç±»å&#x2F;é€šç”¨å‰ç¼€+åç§°+Notification</strong> 3ä¸ªéƒ¨åˆ†ç»„æˆã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">UIApplicationDidBecomeActiveNotification</span><br><span class="line"></span><br><span class="line">å…³è”çš„ç±»ï¼šUIApplication</span><br><span class="line">é€šçŸ¥åç§°ï¼šDidBecomeActive</span><br><span class="line">å›ºå®šåç¼€ï¼šNotification</span><br></pre></td></tr></table></figure></li></ul><h3 id="å¸¸é‡å‘½åé£æ ¼"><a href="#å¸¸é‡å‘½åé£æ ¼" class="headerlink" title="å¸¸é‡å‘½åé£æ ¼"></a>å¸¸é‡å‘½åé£æ ¼</h3><ul><li><p><strong>[å¿…é¡»]</strong> å¦‚æœå¸¸é‡å±€é™äºæŸä¸ª <strong>ç¼–è¯‘å•å…ƒ</strong>(<code>é€šå¸¸æŒ‡æŸä¸ªç±»çš„å®ç°æ–‡ä»¶å†…</code>) ä¹‹å†…ï¼Œé€šå¸¸åœ¨å‰é¢åŠ å°å†™å­—æ¯kä½œä¸ºå‰ç¼€ï¼Œè‹¥å¸¸é‡åœ¨å…¨å±€å¯è§ï¼Œé€šå¸¸ä»¥ç±»åä½œä¸ºå‰ç¼€ï¼Œç„¶åé‡‡ç”¨é¦–å­—æ¯å¤§å†™é©¼å³°å‘½åæ–¹å¼ã€‚</p>   <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">// å±€éƒ¨å¯è§</span><br><span class="line">const CGFloat kAnimationDuration = 2.0;</span><br><span class="line">// å…¨å±€å¯è§</span><br><span class="line">const CGFloat UIActivityIndicatorViewAnimationDuration = 2.0;</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> constå¦‚æœä¿®é¥°çš„æ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼Œåˆ™æ”¾åœ¨æœ€å·¦ä¾§ï¼Œå¦‚æœä¿®é¥°çš„æ˜¯å¯¹è±¡ï¼Œåˆ™æ”¾åœ¨å˜é‡åå‰é¢ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">const NSInteger age</span><br><span class="line">NSString * const name</span><br></pre></td></tr></table></figure></li></ul><h3 id="å¼‚å¸¸ç±»å‘½åé£æ ¼"><a href="#å¼‚å¸¸ç±»å‘½åé£æ ¼" class="headerlink" title="å¼‚å¸¸ç±»å‘½åé£æ ¼"></a>å¼‚å¸¸ç±»å‘½åé£æ ¼</h3><ul><li><strong>[å¿…é¡»]</strong> ä¸€ä¸ªå®Œæ•´çš„å¼‚å¸¸ç±»åç§°ç”± <strong>å‰ç¼€+åç§°+Exception</strong> 3ä¸ªéƒ¨åˆ†ç»„æˆã€‚</li></ul><h3 id="æ–‡ä»¶å‘½åé£æ ¼"><a href="#æ–‡ä»¶å‘½åé£æ ¼" class="headerlink" title="æ–‡ä»¶å‘½åé£æ ¼"></a>æ–‡ä»¶å‘½åé£æ ¼</h3><ul><li><p><strong>[å¿…é¡»]</strong> æ–‡ä»¶åå…¨éƒ¨å°å†™ï¼Œä½¿ç”¨_è¿æ¥ä¸åŒçš„æ¨¡å—ï¼Œæ¨¡å—ä¸­çš„å•è¯å¯ä»¥ä½¿ç”¨é©¼å³°å‘½åã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> æ–‡ä»¶åç§°ç”± <strong>æ‰€å±æ¨¡å—+æè¿°</strong> 2ä¸ªéƒ¨åˆ†ç»„æˆã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">public_back@2x.png</span><br></pre></td></tr></table></figure></li></ul><h3 id="æ³¨é‡Šé£æ ¼"><a href="#æ³¨é‡Šé£æ ¼" class="headerlink" title="æ³¨é‡Šé£æ ¼"></a>æ³¨é‡Šé£æ ¼</h3><ul><li><p><strong>[å¿…é¡»]</strong> æ³¨é‡Šè¯·éµå®ˆ <a href="https://www.doxygen.nl/index.html">Doxygen</a> é£æ ¼ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ä¸€ä¸ªå¥½çš„ä¾‹å­ï¼š</span><br><span class="line">/**</span><br><span class="line"> * @brief å…³äºè¿™ä¸ªæ–¹æ³•çš„ä¸€ä¸ªç®€çŸ­è¯´æ˜ã€‚</span><br><span class="line"> * @discussion ä¸€æ®µè¯¦ç»†çš„æè¿°ã€‚</span><br><span class="line"> * @warning ä¸€äº›è­¦å‘Šä¿¡æ¯ã€‚</span><br><span class="line"> * @note æè¿°ä¸€äº›éœ€è¦æ³¨æ„çš„äº‹æƒ…ã€‚</span><br><span class="line"> * @param obj1 å‚æ•°1çš„è¯´æ˜ã€‚</span><br><span class="line"> * @return è¿”å›å€¼çš„è¯´æ˜ã€‚</span><br><span class="line"> * @code</span><br><span class="line"> * ç¤ºä¾‹ä»£ç ï¼š</span><br><span class="line"> * id temp = [self testFunction:@&quot;111&quot;];</span><br><span class="line"> * @endcode</span><br><span class="line"> *</span><br><span class="line"> * @par åˆ†å‰²çº¿ï¼Œä¸Šé¢æ˜¯ä¸€äº›å¸¸ç”¨çš„æ³¨é‡Šè¯­æ³•ï¼Œä¸‹é¢æ˜¯ä¸å¸¸ç”¨çš„æ³¨é‡Šè¯­æ³•ã€‚</span><br><span class="line"> *</span><br><span class="line"> * @todo å³å°†è¦åšçš„äº‹æƒ…ã€‚</span><br><span class="line"> * @bug å¯èƒ½å­˜åœ¨çš„BUGï¼Œæˆ–è€…å¯¹ç¼ºé™·çš„è¯´æ˜ã€‚</span><br><span class="line"> * @since è¯´æ˜ä»ä»€ä¹ˆç‰ˆæœ¬ã€ä»€ä¹ˆæ—¶é—´åŠ å…¥æ­¤ä»£ç ã€‚</span><br><span class="line"> * @exception å¯¹å¯èƒ½å­˜åœ¨çš„å¼‚å¸¸çš„è§£é‡Šã€‚</span><br><span class="line"> * @pre ç”¨æ¥è¯´æ˜æ‰§è¡Œæ–¹æ³•æ‰€éœ€è¦çš„å‰ææ¡ä»¶ã€‚</span><br><span class="line"> * @post ç”¨æ¥è¯´æ˜æ‰§è¡Œæ–¹æ³•ä¹‹åçš„ä½¿ç”¨æ¡ä»¶ã€‚</span><br><span class="line"> * @author ä½œè€…åç§°ã€‚</span><br><span class="line"> * @remark ä¸€äº›è¯„è®ºä¿¡æ¯ã€‚</span><br><span class="line"> * @copyright ç‰ˆæƒä¿¡æ¯ã€‚</span><br><span class="line"> * @version å½“å‰çš„å·¥ç¨‹ç‰ˆæœ¬ã€‚</span><br><span class="line"> * @par ä¸€ä¸ªæ–°çš„åç§°</span><br><span class="line"> *</span><br><span class="line"> * å¼€å§‹ä¸€ä¸ªæ–°æ®µè½ã€‚</span><br><span class="line"> */</span><br><span class="line">- (id)testFunction:(NSString *)obj1 &#123;</span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>  æ•ˆæœå›¾<br>  <img src="f01e7d9511334d728efdf822fe013f79~tplv-k3u1fbpfcp-zoom-1.image" alt="å›¾ç‰‡"></p></li><li><p><strong>[å¿…é¡»]</strong> æ³¨é‡Šçš„ä½œç”¨æ˜¯ç”¨äºè§£é‡Šé‚£äº›å¤æ‚ä¸å®¹æ˜“ç†è§£çš„é€»è¾‘ï¼Œä»¥åŠéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œè€Œä¸æ˜¯å‘Šè¯‰åˆ«äººè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨ï¼Œä½œç”¨åº”è¯¥åœ¨åç§°ä¸­ä½“ç°å‡ºæ¥ï¼Œæä¾›ä¸€ä¸ªåˆç†çš„åç§°æ¯”ä½¿ç”¨æ™¦æ¶©çš„åç§°ç„¶åè¯•å›¾é€šè¿‡æ³¨é‡Šæ¥è§£é‡Šå®ƒä»¬è¦å¥½çš„å¤šã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> å¦‚æœä¿®æ”¹äº†å®ç°ç»†èŠ‚ï¼Œè¯·è®°å¾—ä¿®æ”¹æ³¨é‡Šã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> æ³¨é‡Šä¸è¦å†™çš„å¤ªå†—é•¿æˆ–å¤ªç®€çŸ­ï¼Œè¿™æ ·éƒ½ä¸åˆ©äºåˆ«äººå¿«é€Ÿç†è§£ã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> æ³¨é‡Šçš„åŒæ–œçº¿å’Œå†…å®¹ä¹‹é—´æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªç©ºæ ¼ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">// è¿™æ˜¯ç¤ºä¾‹æ³¨é‡Šï¼Œè¯·æ³¨æ„åœ¨åŒæ–œçº¿åæœ‰ä¸€ä¸ªç©ºæ ¼ã€‚</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> æ³¨é‡Šä¸­çš„è¯­å¥ä¹Ÿéœ€è¦æ·»åŠ é€‚é‡çš„æ ‡ç‚¹ç¬¦å·å’Œç©ºæ ¼å¸®åŠ©åˆ«äººç†è§£ã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> å¯¹äºä»£ç æ³¨é‡Šéœ€è¦è°¨æ…ï¼Œä»£ç è¢«æ³¨é‡Šä¸€èˆ¬æœ‰2ç§å¯èƒ½ï¼Œ1. åç»­ä¼šæ¢å¤æ­¤æ®µä»£ç é€»è¾‘ï¼› 2. æ°¸ä¹…ä¸ç”¨ï¼›å¯¹äºç¬¬1ç§æƒ…å†µéœ€æ·»åŠ ç›¸åº”æ³¨é‡Šï¼Œå¦‚æœæ²¡æœ‰æ³¨é‡Šä¿¡æ¯éš¾ä»¥çŸ¥æ™“æ³¨é‡ŠåŠ¨æœºï¼Œåè€…å»ºè®®ç›´æ¥åˆ é™¤ã€‚å¦‚æœæœ‰éœ€è¦å¯ä»¥é€šè¿‡ä»£ç ä»“åº“æŸ¥é˜…å†å²ä»£ç ã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> å¦‚æœæŸä¸ªæ–¹æ³•æ˜¯æœ‰é—®é¢˜çš„ï¼Œå¯ä»¥ä½¿ç”¨ç‰¹æ®Šæ³¨é‡Šæ¥æé†’åˆ«äººå’Œè‡ªå·±ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">// MARK: - æ–¹æ³•é›†</span><br><span class="line">// TODO: ç­‰å¾…å®ç°</span><br><span class="line">// FIXME: æœ‰bugï¼Œéœ€è¦ä¿®æ”¹</span><br><span class="line">// !!!: é€»è¾‘æ··ä¹±ï¼Œéœ€è¦å®Œå–„</span><br><span class="line">// ???: å…·ä½“å¹²ä»€ä¹ˆç”¨çš„ï¼Ÿ</span><br><span class="line">- (void)testFunction;</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> è¡Œå°¾æ³¨è§£å’Œä»£ç ä¿æŒ2ä¸ªç©ºæ ¼ï¼Œå¦‚æœåç»­è¡Œæœ‰å¤šä¸ªæ³¨é‡Šï¼Œå°†å®ƒä»¬æ’åˆ—èµ·æ¥é€šå¸¸ä¼šæ›´å…·å¯è¯»æ€§ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹:</span><br><span class="line">[self doSomethingWithALongName];  // Two spaces before the comment.</span><br><span class="line">[self doSomethingShort];          // More spacing to align the comment.</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> åˆ«ç»™ç³Ÿç³•çš„ä»£ç åŠ æ³¨é‡Šï¼Œé‡æ„å®ƒã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tips: </span><br><span class="line">æ³¨é‡Šä¸èƒ½ç¾åŒ–ç³Ÿç³•çš„ä»£ç ã€‚å½“ä¼å›¾ä½¿ç”¨æ³¨é‡Šå‰ï¼Œå…ˆè€ƒè™‘æ˜¯å¦å¯ä»¥é€šè¿‡è°ƒæ•´ç»“æ„ï¼Œå‘½åç­‰æ“ä½œï¼Œæ¶ˆé™¤å†™æ³¨é‡Šçš„å¿…è¦ã€‚</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> å¦‚æœä¸€ä¸ªç±»æ¯”è¾ƒå¤æ‚æˆ–è€…æœ‰éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œé‚£ä¹ˆè¯·åœ¨å£°æ˜å®ƒçš„åœ°æ–¹åŠ ä¸Šæ³¨é‡Šå¸®åŠ©åˆ«äººå¿«é€Ÿç†è§£ï¼Œå¦‚æœæœ‰å¿…è¦å¯ä»¥ä½¿ç”¨ <a href="https://wwi.lanzout.com/iyHlYz0lxqf"><strong>Monodraw</strong></a> å·¥å…·ç»˜åˆ¶ASCIIå›¾å½¢æé«˜å¯è¯»æ€§ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p>  monodrawç¤ºä¾‹å›¾(è¿™å¼ å›¾å¾ˆæ¸…æ¥šçš„å‘åˆ«äººè¡¨è¾¾è¿™ä¸ªç±»çš„ä½œç”¨)<br>  <img src="63b45029f3684dfba4de6f7b4a6e8a8a~tplv-k3u1fbpfcp-zoom-1.image" alt="monodrawç¤ºä¾‹å›¾"></p></li></ul><h2 id="ç¼–ç é£æ ¼"><a href="#ç¼–ç é£æ ¼" class="headerlink" title="ç¼–ç é£æ ¼"></a>ç¼–ç é£æ ¼</h2><ul><li><p><strong>[å¿…é¡»]</strong> ä¸è¦å¢åŠ å¤šä½™ç©ºæ ¼æ¥ä½¿ä¸Šä¸‹ä»£ç çš„ç­‰å·å¯¹é½ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">int a1 = 1;</span><br><span class="line">long a2 = 3;</span><br><span class="line">NSString *a3 = @&quot;&quot;;</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">int a1       = 1;</span><br><span class="line">long a2      = 3;</span><br><span class="line">NSString *a3 = @&quot;&quot;;</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> é€—å·(,)åé¢ã€äºŒå…ƒè¿ç®—ç¬¦çš„å·¦å³åº”è¯¥æ·»åŠ 1ä¸ªç©ºæ ¼ï¼Œå°æ‹¬å·å·¦å³ä¸è¦æœ‰ç©ºæ ¼ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">kColorRGB(255, 255, 255);</span><br><span class="line">int a = 3 + 4;</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">kColorRGB(255,255,255)</span><br><span class="line">int a = 3+4;</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> å°½é‡ä½¿ç”¨ if return ä»£æ›¿ if elseï¼Œif åµŒå¥—æœ€å¥½ä¸è¶…è¿‡5å±‚ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">if (x == 1) &#123;</span><br><span class="line">â€¦â€¦</span><br><span class="line">return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (x == 2) &#123;</span><br><span class="line">â€¦â€¦</span><br><span class="line">return;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">if (x == 1) &#123;</span><br><span class="line">â€¦â€¦</span><br><span class="line">&#125; else if (x == 2) &#123;</span><br><span class="line">â€¦â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> å°½é‡é¿å…é‡‡ç”¨å–åé€»è¾‘è¿ç®—ç¬¦ï¼Œå› ä¸ºå–åé€»è¾‘ä¸åˆ©äºå¿«é€Ÿç†è§£ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">if (array == nil) &#123;</span><br><span class="line">â€¦â€¦</span><br><span class="line">&#125;</span><br><span class="line">åä¾‹ï¼š</span><br><span class="line">if (!array) &#123;</span><br><span class="line">â€¦â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="ç»“æ„é£æ ¼"><a href="#ç»“æ„é£æ ¼" class="headerlink" title="ç»“æ„é£æ ¼"></a>ç»“æ„é£æ ¼</h2><ul><li><p><strong>[å¿…é¡»]</strong> æ–‡ä»¶å†…éƒ¨ä½¿ç”¨çš„å¸¸é‡ã€é™æ€å˜é‡åœ¨@interfaceä¹‹å‰å£°æ˜ï¼Œå¦‚æœæ²¡æœ‰@interfaceå°±åœ¨@implementationå‰å£°æ˜ã€‚</p></li><li><p><strong>[å¿…é¡»]</strong> åŒä¸€ç±»å‹çš„å±æ€§å£°æ˜æ”¾åœ¨ä¸€å—æ˜¾ç¤ºï¼Œä¸­é—´ç”¨ä¸€è¡Œç©ºæ ¼åŒºåˆ†ï¼Œä¸åŒç±»å‹çš„å£°æ˜ç”¨2è¡Œç©ºæ ¼éš”å¼€ï¼Œå±æ€§å£°æ˜çš„å¼€å§‹å’Œæœ«å°¾éƒ½è¦æ·»åŠ ä¸€è¡Œç©ºæ ¼ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹ï¼š</span><br><span class="line">@interface MineViewController ()</span><br><span class="line"></span><br><span class="line">@property (nonatomic, weak) UIView *headView;</span><br><span class="line"></span><br><span class="line">@property (nonatomic, weak) UITableView *tableView;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@property (nonatomic, copy) NSArray *dataSourceArray;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> ä¸åŒä½œç”¨çš„æ–¹æ³•æŒ‰ç…§é¡ºåºè¿›è¡Œæ’åºï¼Œç”Ÿå‘½å‘¨æœŸç›¸å…³çš„æ–¹æ³• &gt; å…¬å¼€æ–¹æ³• &gt; ç§æœ‰æ–¹æ³• &gt; ç»§æ‰¿æ–¹æ³• &gt; é€šçŸ¥æ–¹æ³• &gt; åè®®æ–¹æ³• &gt; getter&#x2F;setteræ–¹æ³•ï¼Œç®€å•çš„è¯´å°±æ˜¯è¶Šé‡è¦è¶Šå¸¸ç”¨çš„æ–¹æ³•è¶Šé å‰ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#pragma mark - LifeCycle(ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„ä»£ç æ”¾åœ¨æœ€ä¸Šé¢)</span><br><span class="line">- (void)dealloc &#123;&#125;</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;&#125;</span><br><span class="line"></span><br><span class="line">- (void)viewWillAppear:(BOOL)animated &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#pragma mark - Public(å…¬å¼€æ–¹æ³•)</span><br><span class="line">// code...</span><br><span class="line">// ä¸‹ç©ºä¸¤è¡Œ</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#pragma mark - Private(ç§æœ‰æ–¹æ³•)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#pragma mark - Override(éœ€è¦è¦†ç›–çˆ¶ç±»çš„æ–¹æ³•)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#pragma mark - Notification(é€šçŸ¥æ–¹æ³•)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#pragma mark - Delegate(Delegateéœ€è¦å®ç°çš„æ–¹æ³•)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#pragma mark - Getter/Setter</span><br></pre></td></tr></table></figure></li><li><p><strong>[å¿…é¡»]</strong> æ–¹æ³•çš„å£°æ˜é¡ºåºåº”è¯¥ä¸ºç±»æ–¹æ³• &gt; åˆå§‹åŒ–æ–¹æ³• &gt; å®ä¾‹æ–¹æ³•ã€‚</p></li><li><p><strong>[å»ºè®®]</strong> ä¸åŒé€»è¾‘ã€ä¸åŒè¯­ä¹‰ã€ä¸åŒä¸šåŠ¡çš„ä»£ç ä¹‹é—´æ’å…¥ä¸€ä¸ªç©ºè¡Œåˆ†éš”å¼€ä»¥æå‡å¯è¯»æ€§ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹:</span><br><span class="line">[self createSubviews];</span><br><span class="line">[self createTableview];</span><br><span class="line"></span><br><span class="line">[self netRequest];</span><br></pre></td></tr></table></figure></li><li><p><strong>[å»ºè®®]</strong> å¤´æ–‡ä»¶åŒ…å«é¡ºåºåº”è¯¥æ˜¯ç³»ç»Ÿå¤´æ–‡ä»¶ &gt; SDKå¤´æ–‡ä»¶ &gt; å…¶ä»–ä¾èµ–çš„å¤´æ–‡ä»¶ï¼Œç”¨ä¸€ä¸ªç©ºè¡Œåˆ†éš”é€»è¾‘ä¸Šä¸åŒçš„å¤´æ–‡ä»¶ï¼Œåœ¨æ¯ä¸ªç»„ä¸­ï¼ŒåŒ…å«çš„å†…å®¹å»ºè®®æŒ‰é¦–å­—æ¯é¡ºåºæ’åˆ—ã€‚</p>  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ­£ä¾‹:</span><br><span class="line">#import &quot;ProjectX/BazViewController.h&quot;</span><br><span class="line"></span><br><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;vector&gt;</span><br><span class="line"></span><br><span class="line">#include &quot;base/basictypes.h&quot;</span><br><span class="line">#include &quot;base/integral_types.h&quot;</span><br><span class="line">#include &quot;util/math/mathutil.h&quot;</span><br><span class="line"></span><br><span class="line">#import &quot;ProjectX/BazModel.h&quot;</span><br><span class="line">#import &quot;Shared/Util/Foo.h&quot;</span><br></pre></td></tr></table></figure></li></ul><p>ä¸€ä¸ªå¥½çš„å¤´æ–‡ä»¶ä¾‹å­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#import &lt;UIKit/UIKit.h&gt;</span><br><span class="line"></span><br><span class="line">#import &quot;WXYZ_ADDefine.h&quot;</span><br><span class="line">    </span><br><span class="line">@class WXYZ_ADModel;</span><br><span class="line">    </span><br><span class="line">NS_ASSUME_NONNULL_BEGIN</span><br><span class="line">    </span><br><span class="line">/// æä¾›ç»™å¤–éƒ¨ä½¿ç”¨çš„å¹¿å‘Šå®ä¾‹å¯¹è±¡ï¼Œæ‰€æœ‰éœ€è¦ä½¿ç”¨å¹¿å‘Šçš„åœ°æ–¹éƒ½åº”è¯¥ä½¿ç”¨ WXYZ_ADView åˆ›å»ºã€‚</span><br><span class="line">@interface WXYZ_ADView : UIView</span><br><span class="line">    </span><br><span class="line">/// å¹¿å‘Šç›¸å…³å±æ€§ï¼Œkeyè¡¨ç¤ºå¹¿å‘Šæ ‡é¢˜ï¼Œvalueè¡¨ç¤ºå¹¿å‘Šå®½åº¦ã€‚</span><br><span class="line">@property(nonatomic, copy) NSDictionary&lt;NSString *, NSNumber *&gt; *attributes;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">/// æ ¹æ®å¹¿å‘Šç±»å‹å’Œå¹¿å‘Šä½ç½®è¿”å›æ˜¯å¦ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦éœ€è¦å±•ç¤ºå¹¿å‘Šã€‚</span><br><span class="line">+ (BOOL)canLoadADWithADType:(WXYZ_ADViewType)adType adPosition:(WXYZ_ADViewPosition)adPosition;</span><br><span class="line">    </span><br><span class="line">/// æ ¹æ®å¹¿å‘Šç±»å‹å’Œå¹¿å‘Šä½ç½®åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªadViewå¯¹è±¡ã€‚</span><br><span class="line">/// @discussion å¦‚æœå¹¿å‘Šå¼€å…³æ˜¯å…³é—­çŠ¶æ€åˆ™è¿”å›nilã€‚</span><br><span class="line">/// @param adType å¹¿å‘Šç±»å‹</span><br><span class="line">/// @param adPosition å¹¿å‘Šä½ç½®</span><br><span class="line">+ (nullable instancetype)createADViewWithType:(WXYZ_ADViewType)adType adPosition:(WXYZ_ADViewPosition)adPosition;</span><br><span class="line">    </span><br><span class="line">/// è®¾ç½®adModelå°†ä¼šæ›´æ–°æ­£åœ¨æ˜¾ç¤ºçš„å¹¿å‘Šå†…å®¹ã€‚</span><br><span class="line">- (void)setAdModel:(WXYZ_ADModel *)adModel;</span><br><span class="line">    </span><br><span class="line">+ (instancetype)allocWithZone:(struct _NSZone *)zone UNAVAILABLE_ATTRIBUTE;</span><br><span class="line">    </span><br><span class="line">+ (instancetype)new UNAVAILABLE_ATTRIBUTE;</span><br><span class="line">    </span><br><span class="line">+ (instancetype)alloc UNAVAILABLE_ATTRIBUTE;</span><br><span class="line">    </span><br><span class="line">- (instancetype)initWithFrame:(CGRect)frame UNAVAILABLE_ATTRIBUTE;</span><br><span class="line">    </span><br><span class="line">- (instancetype)init UNAVAILABLE_ATTRIBUTE;</span><br><span class="line">    </span><br><span class="line">@end</span><br><span class="line">    </span><br><span class="line">NS_ASSUME_NONNULL_END</span><br></pre></td></tr></table></figure><ol><li>ä½¿ç”¨ <strong>@class</strong> å‘å‰å£°æ˜ <code>WXYZ_ADModel</code>è€Œä¸æ˜¯ç”¨ <code>#import</code>åŒ…å«ã€‚</li><li>@interface ä¹‹å‰æœ‰å…³äºç±»çš„è¯´æ˜æ³¨é‡Šï¼Œå¸®åŠ©åˆ«äººåœ¨ä½¿ç”¨è¿™ä¸ªç±»æ—¶å¿«é€Ÿäº†è§£è¿™ä¸ªç±»çš„ä½œç”¨ä»¥åŠéœ€è¦æ³¨æ„çš„åœ°æ–¹ã€‚</li><li>å­—å…¸ä½¿ç”¨äº†æ³›å‹å£°æ˜å­—å…¸åŒ…å«çš„ç±»å‹ï¼Œå¹¶ä¸”åœ¨æ³¨é‡Šä¸­è¯¦ç»†çš„è¯´æ˜äº†å­—å…¸åŒ…å«çš„å†…å®¹ã€‚</li><li>å±æ€§å’Œç¬¬ä¸€ä¸ªæ–¹æ³•ä¹‹é—´æœ‰2ä¸ªç©ºæ ¼æ¥åŒºåˆ†å®ƒä»¬æ²¡æœ‰å…³è”æ€§ã€‚</li><li>æ¯ä¸ªå±æ€§å’Œè¿”å›å€¼éƒ½æœ‰æ˜¯å¦ä¸ºç©ºçš„çŠ¶æ€ï¼Œä¾‹å¦‚ <code>+ createADViewWithType</code> æ–¹æ³•ä½¿ç”¨ <code>nullable</code> è¡¨æ˜äº†è¿”å›å€¼å¯èƒ½ä¸ºç©ºçš„çŠ¶æ€ï¼Œå¹¶ä¸”åœ¨æ³¨é‡Šä¸­è¯´æ˜äº†ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè¿”å›ç©ºå¯¹è±¡ã€‚</li><li>éµå®ˆäº†ç±»æ–¹æ³• &gt; åˆå§‹åŒ–æ–¹æ³• &gt; å®ä¾‹æ–¹æ³•çš„è§„åˆ™ã€‚</li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol><li><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CodingGuidelines/CodingGuidelines.html">Cocoaç¼–ç è§„èŒƒ</a></li><li><a href="https://github.com/alibaba/Alibaba-Java-Coding-Guidelines">é˜¿é‡Œå·´å·´Javaä»£ç è§„èŒƒ</a></li><li><a href="https://book.douban.com/subject/25829244/">Effective Objective-C 2.0  ç¼–å†™é«˜è´¨é‡iOSä¸OS Xä»£ç çš„52ä¸ªæœ‰æ•ˆæ–¹æ³•</a></li><li><a href="https://google.github.io/styleguide/objcguide.html">Googleçš„Objective-Cé£æ ¼æŒ‡å—</a></li><li><a href="https://www.bilibili.com/video/BV1gi421i7nz/?spm_id_from=333.999.0.0&vd_source=6327e0feef1a22aae76d47cc73e13ccd">ç»™ä»£ç èµ·åå­—çš„ä¸‰è¦ä¸‰ä¸è¦å‡†åˆ™</a></li></ol><!-- >å‘½åè§„èŒƒæŠŠå‘½ååšåˆ°å‡†ç¡®ä¸”è¯¦ç»†ï¼Œä¸ä»…ä»…æ˜¯è¡¨é¢åŠŸå¤«ï¼Œå®ƒèƒ½å¤Ÿæå¤§çš„å½±å“å·¥ä½œæ•ˆç‡ã€‚å¥½çš„åç§°èƒ½å‡å°‘ä»£ç çš„æ­§ä¹‰ï¼Œæå‡å›¢é˜Ÿçš„é˜…è¯»æ•ˆç‡ã€‚èƒ½é™ä½ç»´æŠ¤çš„éš¾åº¦ã€‚ä¸‰è¦ï¼šå¦‚æœä¸€ä¸ªåå­—ï¼Œéœ€è¦åœ¨æ—è¾¹å†™ä¸Šæ³¨é‡Šï¼Œå°±è¯´æ˜è¿™ä¸ªåç§°ä¸å¤Ÿå¥½ã€‚æŠŠä¿¡æ¯ä½“ç°åœ¨åç§°é‡Œï¼Œä¾‹å¦‚ `reportCutOffDate` æ¯” `date` å¥½ã€‚ä¾‹å¦‚ `if (orderCreatedDate < reportCutOffDate)` æ¯” `if (date2 < date1)` å¥½ã€‚- è¦åŒºåˆ†åº¦    ä¾‹å¦‚ `genenorReport` å°±ä¸å¤Ÿå¥½ï¼Œreport æœ‰å¯èƒ½æœ‰å¤šç§ç±»å‹ï¼Œä¾‹å¦‚ AReport, BReport. åº”è¯¥åœ¨åç§°ä¸­ä½“ç°è¿™æ˜¯ä»€ä¹ˆ  .- è¦è¯†åˆ«åº¦- è¦å¤Ÿè¯¦ç»†ä¸‰ä¸è¦ï¼šå¾ˆå¤šäººä¸ºçš„ï¼Œä¸ºäº†è§„èŒƒè€Œè§„èŒƒçš„è¡Œä¸ºï¼Œå¾€å¾€éƒ½æ²¡æœ‰å¥½ä¸‹åœºã€‚å› ä¸ºä»–ä»¬éƒ½ä¼šä½ä¼°äº†äº‹ç‰©çš„å¤æ‚åº¦å’Œæœªæ¥çš„ä¸ç¡®å®šæ€§ã€‚ä¸€ä¸ªå‘½åï¼Œåªè¦å®¢è§‚ä¸Šæ²¡æœ‰é”™è¯¯ã€‚ä¸å½±å“ç†è§£ã€ä¸äº§ç”Ÿæ­§ä¹‰ã€ä¸å¢åŠ ç»´æŠ¤æˆæœ¬ã€‚å°±åº”è¯¥è¢«æ¥å—ã€‚æˆ‘ä»¬æ›´åº”è¯¥å…³å¿ƒçš„æ˜¯æ­£ç¡®æ€§å’Œå‡†ç¡®æ€§ï¼Œè€Œä¸æ˜¯ç»Ÿä¸€è§„èŒƒã€‚åŸå­èƒ½çš„å‘½åè§„åˆ™ï¼šæ­£ç¡®æ€§(correctness)ã€å‡†ç¡®æ€§(precision)ã€ä¸€è‡´æ€§(consistency)- ä¸è¦è§„èŒƒ- ä¸è¦ä¸»è§‚- ä¸è¦é€ å­—--> ]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
          <category> å¼€å‘è§„èŒƒ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ObjC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Markdownè¯­æ³•å¤‡å¿˜å½•</title>
      <link href="/2021/03/08/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Markdown%E8%AF%AD%E6%B3%95%E5%A4%87%E5%BF%98%E5%BD%95/"/>
      <url>/2021/03/08/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Markdown%E8%AF%AD%E6%B3%95%E5%A4%87%E5%BF%98%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç”± å¸ƒå¤š(budo) å‘å¸ƒäº 2021-03-08</p></blockquote><p>è¿™ä¸æ˜¯ä¸€ç¯‡æ•™ä½ å¦‚ä½•å…¥é—¨ Markdown è¯­æ³•çš„æ–‡ç« ï¼Œå®ƒå­˜åœ¨çš„ç›®çš„æ˜¯è®°å½•æˆ‘ä»¬å¹³å¸¸ä¸ç»å¸¸ä½¿ç”¨çš„è¯­æ³•ï¼Œä¾‹å¦‚å¦‚ä½•è°ƒæ•´å›¾ç‰‡çš„å®½åº¦ä¿¡æ¯ï¼›ç”±äºè¿™äº›è¯­æ³•æˆ‘ä»¬ä¸ç»å¸¸ä½¿ç”¨ï¼Œæ‰€ä»¥åˆ°ç”¨æ—¶æ€»æ˜¯ä¼šå¿˜è®°ï¼Œæ­¤æ—¶å°±éœ€è¦ä¸€ç¯‡æ–‡ç« æ¥è®°å½•è¿™äº›ä¸å¸¸ç”¨çš„è¯­æ³•ï¼Œéœ€è¦ç”¨åˆ°ä½†åˆå¿˜è®°çš„æ—¶å€™æ‰“å¼€æ¥çœ‹ä¸€ä¸‹å³å¯ã€‚</p><p>åŸºäºè¿™ä¸ªåŸåˆ™ï¼Œæ–‡ç« ä¸ä¼šæœ‰å¦‚ä½•å£°æ˜æ ‡é¢˜è¿™æ ·çš„è¯­æ³•ã€‚</p><blockquote><p>æ³¨æ„ï¼šæ–‡ç« ä¸­ç”¨åˆ°äº†å¾ˆå¤š HTML è¯­æ³•ï¼ŒæŸäº›å¹³å°å¯èƒ½ä¸æ”¯æŒè¿™äº›è¯­æ³•ã€‚</p></blockquote><hr><h3 id="å¤šè¡Œæ®µè½"><a href="#å¤šè¡Œæ®µè½" class="headerlink" title="å¤šè¡Œæ®µè½"></a>å¤šè¡Œæ®µè½</h3><p>é»˜è®¤æƒ…å†µä¸‹å¤šè¡Œç©ºç™½å†…å®¹åªä¼šæ˜¾ç¤ºä¸€è¡Œï¼›å¯ä»¥ä½¿ç”¨ <code>&lt;br&gt;&lt;/br&gt;</code> å®ç°å¤šè¡Œæ•ˆæœã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ç¬¬ä¸€è¡Œ</span><br><span class="line"></span><br><span class="line">&lt;br&gt;&lt;/br&gt;</span><br><span class="line">&lt;br&gt;&lt;/br&gt;</span><br><span class="line">ç¬¬äºŒè¡Œ</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€è¡Œ</p><p><br></br><br><br></br><br>ç¬¬äºŒè¡Œ</p><h3 id="å•è¡Œæ³¨é‡Š"><a href="#å•è¡Œæ³¨é‡Š" class="headerlink" title="å•è¡Œæ³¨é‡Š"></a>å•è¡Œæ³¨é‡Š</h3><p>ç”±äºæ˜¯æ³¨é‡Šå†…å®¹ï¼Œæ‰€ä»¥ä½ çœ‹ä¸åˆ°å®é™…å†…å®¹ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡(<code>å¦‚æœä½ çœ‹åˆ°äº†å®é™…å†…å®¹ï¼Œè¯´æ˜è¯¥å¹³å°ä¸æ”¯æŒè¯¥è¯­æ³•</code>)ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[//]: è¿™æ˜¯ä¸€è¡Œæ³¨é‡Š</span><br></pre></td></tr></table></figure><h3 id="å¤šè¡Œæ³¨é‡Š"><a href="#å¤šè¡Œæ³¨é‡Š" class="headerlink" title="å¤šè¡Œæ³¨é‡Š"></a>å¤šè¡Œæ³¨é‡Š</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line">æˆ‘æ˜¯ç¬¬ä¸€è¡Œæ³¨é‡Šï¼Œ</span><br><span class="line">æˆ‘æ˜¯ç¬¬äºŒè¡Œæ³¨é‡Šã€‚</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure><!--æˆ‘æ˜¯ç¬¬ä¸€è¡Œæ³¨é‡Šï¼Œæˆ‘æ˜¯ç¬¬äºŒè¡Œæ³¨é‡Šã€‚--><h3 id="ç©ºæ ¼"><a href="#ç©ºæ ¼" class="headerlink" title="ç©ºæ ¼"></a>ç©ºæ ¼</h3><p><span id="anchor1">é»˜è®¤æƒ…å†µä¸‹</span>å¤šä¸ªç©ºæ ¼åªä¼šæ˜¾ç¤ºä¸ºä¸€ä¸ªç©ºæ ¼ï¼Œå¯ä»¥ä½¿ç”¨ <code>&amp;nbsp;</code> å®ç°å¤šä¸ªç©ºæ ¼çš„æ•ˆæœã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ–‡å­—1 &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;æ–‡å­—2</span><br></pre></td></tr></table></figure><p>æ–‡å­—1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ–‡å­—2</p><h3 id="é“¾æ¥çš„æ‚¬åœæ–‡æ¡ˆ"><a href="#é“¾æ¥çš„æ‚¬åœæ–‡æ¡ˆ" class="headerlink" title="é“¾æ¥çš„æ‚¬åœæ–‡æ¡ˆ"></a>é“¾æ¥çš„æ‚¬åœæ–‡æ¡ˆ</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ç™¾åº¦](https://www.baidu.com &quot;å½“é¼ æ ‡æ‚¬åœåœ¨æ–‡å­—ä¸Šæ–¹æ—¶ï¼Œä½ ä¼šçœ‹åˆ°å®ƒ&quot;)</span><br></pre></td></tr></table></figure><p><a href="https://www.baidu.com/" title="å½“é¼ æ ‡æ‚¬åœåœ¨æ–‡å­—ä¸Šæ–¹æ—¶ï¼Œä½ ä¼šçœ‹åˆ°å®ƒ">ç™¾åº¦</a>(<code>ps: æŠŠé¼ æ ‡æ‚¬åœåœ¨ã€Œç™¾åº¦ã€ä¸Šï¼Œä½ èƒ½çœ‹åˆ°æ‚¬åœæ–‡æ¡ˆ</code>)</p><h3 id="å›¾ç‰‡çš„æ‚¬åœæ–‡æ¡ˆ"><a href="#å›¾ç‰‡çš„æ‚¬åœæ–‡æ¡ˆ" class="headerlink" title="å›¾ç‰‡çš„æ‚¬åœæ–‡æ¡ˆ"></a>å›¾ç‰‡çš„æ‚¬åœæ–‡æ¡ˆ</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">![é˜¿è¥¿æ²³å›¾ç‰‡](https://p.upyun.com/docs/cloud/demo.jpg &quot;å½“é¼ æ ‡æ‚¬åœåœ¨æ–‡å­—ä¸Šæ–¹æ—¶ï¼Œä½ ä¼šçœ‹åˆ°å®ƒ&quot;)</span><br></pre></td></tr></table></figure><p><img src="demo.jpg" alt="é˜¿è¥¿æ²³å›¾ç‰‡" title="å½“é¼ æ ‡æ‚¬åœåœ¨æ–‡å­—ä¸Šæ–¹æ—¶ï¼Œä½ ä¼šçœ‹åˆ°å®ƒ"></p><h3 id="å›¾ç‰‡è‡ªå®šä¹‰å¯¹é½æ–¹å¼å’Œå°ºå¯¸ç­‰å‚æ•°"><a href="#å›¾ç‰‡è‡ªå®šä¹‰å¯¹é½æ–¹å¼å’Œå°ºå¯¸ç­‰å‚æ•°" class="headerlink" title="å›¾ç‰‡è‡ªå®šä¹‰å¯¹é½æ–¹å¼å’Œå°ºå¯¸ç­‰å‚æ•°"></a>å›¾ç‰‡è‡ªå®šä¹‰å¯¹é½æ–¹å¼å’Œå°ºå¯¸ç­‰å‚æ•°</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;div style=&quot;text-align: center;background-color: #b6ffc8;&quot;&gt;</span><br><span class="line">    &lt;img </span><br><span class="line">        src=&quot;https://p.upyun.com/docs/cloud/demo.jpg&quot; </span><br><span class="line">        alt=&quot;é˜¿è¥¿æ²³å›¾ç‰‡&quot; </span><br><span class="line">        title=&quot;é˜¿è¥¿æ²³å›¾ç‰‡Title&quot; </span><br><span class="line">        style=&quot;width:300px;height:300px;&quot;</span><br><span class="line">    &gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><div style="text-align: center;background-color: #b6ffc8;">    <img         src="demo.jpg"         alt="é˜¿è¥¿æ²³å›¾ç‰‡"         title="é˜¿è¥¿æ²³å›¾ç‰‡Title"         style="width:300px;height:300px;"    ></div><h3 id="ä»£ç é«˜äº®"><a href="#ä»£ç é«˜äº®" class="headerlink" title="ä»£ç é«˜äº®"></a>ä»£ç é«˜äº®</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">```c</span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    printf(&quot;Hello World!&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">```</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> * argv[])</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤§éƒ¨åˆ†è¯­è¨€çš„å…³é”®å­—éƒ½æ˜¯å…¶åç§°çš„å°å†™å½¢å¼ï¼Œä¾‹å¦‚ JavaScript å¯¹åº”çš„å…³é”®å­—æ˜¯ javascriptï¼Œæ•…è€Œæˆ‘åªè®°å½•äº†ä¸€äº›ç‰¹æ®Šçš„å…³é”®å­—ï¼š</p><table><thead><tr><th align="center">è¯­è¨€å</th><th align="center">å…³é”®å­—</th></tr></thead><tbody><tr><td align="center">C++</td><td align="center">cpp</td></tr><tr><td align="center">c#</td><td align="center">cs</td></tr><tr><td align="center">Objective-C</td><td align="center">objc</td></tr></tbody></table><h3 id="è·³è½¬åˆ°æŒ‡å®šæ ‡é¢˜"><a href="#è·³è½¬åˆ°æŒ‡å®šæ ‡é¢˜" class="headerlink" title="è·³è½¬åˆ°æŒ‡å®šæ ‡é¢˜"></a>è·³è½¬åˆ°æŒ‡å®šæ ‡é¢˜</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ç‚¹å‡»è·³è½¬åˆ°ã€Œå¤šè¡Œæ®µè½ã€æ ‡é¢˜](#å¤šè¡Œæ®µè½)</span><br></pre></td></tr></table></figure><p><a href="#%E5%A4%9A%E8%A1%8C%E6%AE%B5%E8%90%BD">ç‚¹å‡»è·³è½¬åˆ°ã€Œå¤šè¡Œæ®µè½ã€æ ‡é¢˜</a></p><h3 id="è·³è½¬åˆ°æŒ‡å®šæ–‡æ¡ˆ"><a href="#è·³è½¬åˆ°æŒ‡å®šæ–‡æ¡ˆ" class="headerlink" title="è·³è½¬åˆ°æŒ‡å®šæ–‡æ¡ˆ"></a>è·³è½¬åˆ°æŒ‡å®šæ–‡æ¡ˆ</h3><p>è¦è·³è½¬å¤„çš„æ–‡æ¡ˆå¿…é¡»è¿™æ ·å†™ï¼š<code>&lt;span id=&quot;anchor1&quot;&gt;é»˜è®¤æƒ…å†µä¸‹&lt;/span&gt;</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ç‚¹å‡»è·³è½¬åˆ°æŒ‡å®šä½ç½®ã€Œé»˜è®¤æƒ…å†µä¸‹ã€](#anchor1)</span><br></pre></td></tr></table></figure><p><a href="#anchor1">ç‚¹å‡»è·³è½¬åˆ°æŒ‡å®šä½ç½®ã€Œé»˜è®¤æƒ…å†µä¸‹ã€</a></p><h3 id="è„šæ³¨"><a href="#è„šæ³¨" class="headerlink" title="è„šæ³¨"></a>è„šæ³¨</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è„šæ³¨1[^1]</span><br></pre></td></tr></table></figure><p>è„šæ³¨1 <a href="%E8%84%9A%E6%B3%A81">^1</a></p><h3 id="ä»»åŠ¡åˆ—è¡¨"><a href="#ä»»åŠ¡åˆ—è¡¨" class="headerlink" title="ä»»åŠ¡åˆ—è¡¨"></a>ä»»åŠ¡åˆ—è¡¨</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- [x] å·²å®Œæˆçš„ä»»åŠ¡</span><br><span class="line">- [ ] æœªå®Œæˆçš„ä»»åŠ¡</span><br></pre></td></tr></table></figure><ul><li><input checked="" disabled="" type="checkbox"> å·²å®Œæˆçš„ä»»åŠ¡</li><li><input disabled="" type="checkbox"> æœªå®Œæˆçš„ä»»åŠ¡</li></ul><h3 id="åˆ é™¤çº¿"><a href="#åˆ é™¤çº¿" class="headerlink" title="åˆ é™¤çº¿"></a>åˆ é™¤çº¿</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¿™æ˜¯ ~~åˆ é™¤çº¿~~</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ <del>åˆ é™¤çº¿</del></p><h3 id="å­—ä½“"><a href="#å­—ä½“" class="headerlink" title="å­—ä½“"></a>å­—ä½“</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;font face=&quot;é»‘ä½“&quot; size=5&gt;æˆ‘æ˜¯é»‘ä½“å­—&lt;/font&gt;</span><br><span class="line">&lt;font face=&quot;å¾®è½¯é›…é»‘&quot; size=5&gt;æˆ‘æ˜¯å¾®è½¯é›…é»‘&lt;/font&gt;</span><br></pre></td></tr></table></figure><p><font face="é»‘ä½“" size=5>æˆ‘æ˜¯é»‘ä½“å­—</font><br><font face="å¾®è½¯é›…é»‘" size=5>æˆ‘æ˜¯å¾®è½¯é›…é»‘</font></p><h3 id="æ–‡å­—é¢œè‰²"><a href="#æ–‡å­—é¢œè‰²" class="headerlink" title="æ–‡å­—é¢œè‰²"></a>æ–‡å­—é¢œè‰²</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;font color=#0099ff&gt;æˆ‘çš„æ–‡å­—é¢œè‰²æ˜¯è“è‰²&lt;/font&gt;</span><br></pre></td></tr></table></figure><p><font color=#0099ff>æˆ‘çš„æ–‡å­—é¢œè‰²æ˜¯è“è‰²</font></p><h3 id="ä¸Šæ ‡"><a href="#ä¸Šæ ‡" class="headerlink" title="ä¸Šæ ‡"></a>ä¸Šæ ‡</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">n&lt;sup&gt;2&lt;/sup&gt; = n * n</span><br></pre></td></tr></table></figure><p>n<sup>2</sup> &#x3D; n * n</p><h3 id="ä¸‹æ ‡"><a href="#ä¸‹æ ‡" class="headerlink" title="ä¸‹æ ‡"></a>ä¸‹æ ‡</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">H&lt;sub&gt;2&lt;/sub&gt;O</span><br></pre></td></tr></table></figure><p>H<sub>2</sub>O</p><h3 id="èƒŒæ™¯é¢œè‰²"><a href="#èƒŒæ™¯é¢œè‰²" class="headerlink" title="èƒŒæ™¯é¢œè‰²"></a>èƒŒæ™¯é¢œè‰²</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;p style=&quot;background-color: #b6ffc8;&quot;&gt;&lt;font color=#000&gt;èƒŒæ™¯æ˜¯ç»¿è‰²&lt;/font&gt;&lt;/p&gt;</span><br></pre></td></tr></table></figure><p style="background-color: #b6ffc8;"><font color=#000>èƒŒæ™¯æ˜¯ç»¿è‰²</font></p><h3 id="æ–‡å­—å¯¹é½æ–¹å¼"><a href="#æ–‡å­—å¯¹é½æ–¹å¼" class="headerlink" title="æ–‡å­—å¯¹é½æ–¹å¼"></a>æ–‡å­—å¯¹é½æ–¹å¼</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;p style=&quot;text-align: left;background-color: #b6ffc8;&quot;&gt;&lt;font color=#000&gt;æ–‡å­—å·¦å¯¹é½&lt;/font&gt;&lt;/p&gt;</span><br><span class="line">&lt;p style=&quot;text-align: center;background-color: #b6ffc8;&quot;&gt;&lt;font color=#000&gt;æ–‡å­—å±…ä¸­å¯¹é½&lt;/font&gt;&lt;/p&gt;</span><br><span class="line">&lt;p style=&quot;text-align: right;background-color: #b6ffc8;&quot;&gt;&lt;font color=#000&gt;æ–‡å­—å³å¯¹é½&lt;/font&gt;&lt;/p&gt;</span><br></pre></td></tr></table></figure><p style="text-align: left;background-color: #b6ffc8;"><font color=#000>æ–‡å­—å·¦å¯¹é½</font></p><p style="text-align: center;background-color: #b6ffc8;"><font color=#000>æ–‡å­—å±…ä¸­å¯¹é½</font></p><p style="text-align: right;background-color: #b6ffc8;"><font color=#000>æ–‡å­—å³å¯¹é½</font></p><h3 id="æ’å…¥éŸ³é¢‘"><a href="#æ’å…¥éŸ³é¢‘" class="headerlink" title="æ’å…¥éŸ³é¢‘"></a>æ’å…¥éŸ³é¢‘</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;iframe </span><br><span class="line">    frameborder=&quot;no&quot; </span><br><span class="line">    border=&quot;0&quot; </span><br><span class="line">    marginwidth=&quot;0&quot; </span><br><span class="line">    marginheight=&quot;0&quot; </span><br><span class="line">    width=100% </span><br><span class="line">    height=auto </span><br><span class="line">    src=&quot;https://music.163.com/outchain/player?type=2&amp;id=528478901&amp;auto=1&amp;height=66&quot;&gt;</span><br><span class="line">&lt;/iframe&gt;</span><br></pre></td></tr></table></figure><iframe     frameborder="no"     border="0"     marginwidth="0"     marginheight="0"     width=100%     height=auto     src="https://music.163.com/outchain/player?type=2&id=528478901&auto=1&height=66"></iframe><h3 id="æ’å…¥è§†é¢‘"><a href="#æ’å…¥è§†é¢‘" class="headerlink" title="æ’å…¥è§†é¢‘"></a>æ’å…¥è§†é¢‘</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;iframe </span><br><span class="line">    src=&quot;https://player.bilibili.com/player.html?aid=10631344&amp;cid=17548810&amp;page=1&quot; </span><br><span class="line">    scrolling=&quot;no&quot; </span><br><span class="line">    style=&quot;border:0;width:100%;height:auto;min-height:790px;&quot;</span><br><span class="line">    allowfullscreen=&quot;true&quot;&gt; </span><br><span class="line">&lt;/iframe&gt;</span><br></pre></td></tr></table></figure><iframe     src="https://player.bilibili.com/player.html?aid=10631344&cid=17548810&page=1"     scrolling="no"     style="border:0;width:100%;height:auto;min-height:790px;"    allowfullscreen="true"> </iframe><h3 id="ä½¿ç”¨Mermaidç”»å›¾"><a href="#ä½¿ç”¨Mermaidç”»å›¾" class="headerlink" title="ä½¿ç”¨Mermaidç”»å›¾"></a>ä½¿ç”¨Mermaidç”»å›¾</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">```mermaid</span><br><span class="line">sequenceDiagram</span><br><span class="line">    participant Alice</span><br><span class="line">    participant Bob</span><br><span class="line">    Alice-&gt;John: Hello John, how are you?</span><br><span class="line">    loop Healthcheck</span><br><span class="line">        John-&gt;John: Fight against hypochondria</span><br><span class="line">    end</span><br><span class="line">    Note right of John: Rational thoughts &lt;br/&gt;prevail...</span><br><span class="line">    John--&gt;Alice: Great!</span><br><span class="line">    John-&gt;Bob: How about you?</span><br><span class="line">    Bob--&gt;John: Jolly good!</span><br><span class="line">```</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant Alice</span><br><span class="line">    participant Bob</span><br><span class="line">    Alice-&gt;John: Hello John, how are you?</span><br><span class="line">    loop Healthcheck</span><br><span class="line">        John-&gt;John: Fight against hypochondria</span><br><span class="line">    end</span><br><span class="line">    Note right of John: Rational thoughts &lt;br/&gt;prevail...</span><br><span class="line">    John--&gt;Alice: Great!</span><br><span class="line">    John-&gt;Bob: How about you?</span><br><span class="line">    Bob--&gt;John: Jolly good!</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘å·¥å…· </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Markdown </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LLDynamicLaunchScreençš„è®¾è®¡æ€è·¯</title>
      <link href="/2021/03/07/iOS/LLDynamicLaunchScreen%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/"/>
      <url>/2021/03/07/iOS/LLDynamicLaunchScreen%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç”± å¸ƒå¤š(budo) å‘å¸ƒäº 2021-03-07</p></blockquote><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;åŠ¨æ€ä¿®æ”¹iPhoneä¸ŠAPPçš„å¯åŠ¨å›¾ï¼Œå°†å®ƒä¿®æ”¹ä¸ºç”¨æˆ·å–œæ¬¢çš„å›¾ç‰‡ï¼Œè¿™æ ·ç”¨æˆ·æ¯æ¬¡æ‰“å¼€APPç¬¬ä¸€çœ¼å°±å¯ä»¥çœ‹åˆ°è‡ªå·±å–œæ¬¢çš„å›¾ç‰‡ï¼Œè¿™å¯¹äºç”¨æˆ·æ¥è¯´æ˜¯ä¸æ˜¯æŒºçˆ½å‘¢ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;å…¶å®è¿™ä¸ªæƒ³æ³•æˆ‘å¾ˆæ—©ä¹‹å‰å°±èŒå‘äº†(å¤§æ¦‚æ˜¯2019å¹´ä¸ŠåŠå¹´)ï¼Œæœ‰ä¸€æ¬¡æˆ‘å‘ç°è‹¹æœæä¾›äº†æ–¹æ³•å¯ä»¥åŠ¨æ€ä¿®æ”¹APPçš„Logoï¼Œå°±èŒå‘äº†åŠ¨æ€ä¿®æ”¹å¯åŠ¨å›¾çš„æƒ³æ³•ï¼Œå½“æ—¶æŸ¥é˜…äº†ä¸€äº›èµ„æ–™ï¼Œç„¶åè‡ªå·±é€šè¿‡å®è·µå‘ç°ç¡®å®å¯ä»¥ä¸æ›´æ–°APPåŠ¨æ€ä¿®æ”¹å¯åŠ¨å›¾ã€‚ä¸è¿‡å› ä¸ºå½“æ—¶å…¬å¸çš„APPå¹¶ä¸éœ€è¦è¿™ä¸ªåŠŸèƒ½ï¼Œè€Œä¸”å¤§éƒ¨åˆ†çš„è½¯ä»¶å‚å•†ä¹Ÿå¹¶æ²¡æœ‰æ³¨æ„åˆ°è¿™ä¸€å—çš„ç”¨æˆ·ä½“éªŒï¼Œæ‰€æœ‰çš„APPä¹Ÿéƒ½ä¸æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰å¯åŠ¨å›¾ï¼Œæ‰€ä»¥å½“æ—¶ä¹Ÿå°±æ²¡ç»§ç»­å¾€ä¸‹æ·±ç©¶äº†ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;æ—¶é—´çœ¨çœ¼å°±æ¥åˆ°äº†2020å¹´ä¸‹åŠå¹´ï¼Œå½“æ—¶å› ä¸ºå…¬å¸çš„APPè¦å®ç°æš—é»‘æ¨¡å¼ï¼Œä½†æ˜¯è¿™ä¸ªAPPå·²ç»æ›´æ–°è¿­ä»£äº†3å¹´å¤šï¼Œåœ¨æ‰€æœ‰é¡µé¢æ·»åŠ ä¿®æ”¹è‰²å€¼çš„ä»£ç å·¥ä½œé‡å¤ªå¤§ï¼Œè€Œä¸”æˆ‘ä»¬çš„APPæ”¯æŒiOS10ä½†æ˜¯ç³»ç»Ÿçš„æš—é»‘APIæœ€ä½æ”¯æŒiOS13ï¼Œç„¶åè‡ªå·±å°±å†™äº†ä¸€ä¸ªæš—é»‘æ¡†æ¶<a href="https://github.com/internetWei/llDark">LLDark</a>ï¼Œå½“APPé›†æˆå¥½è¿™ä¸ªæš—é»‘æ¡†æ¶åï¼Œå‘ç°APPå¼ºè¡Œåˆ‡æ¢æˆä¸€ä¸ªæ¨¡å¼åï¼ŒAPPçš„å¯åŠ¨å›¾å´æ²¡æœ‰è·ŸéšAPPçš„æ¨¡å¼å˜åŒ–ï¼Œè€Œæ˜¯è·Ÿéšç³»ç»Ÿæ¨¡å¼ï¼Œç®€å•çš„è¯´å°±æ˜¯APPå¼ºè¡Œè®¾ç½®æˆäº†æµ…è‰²æ¨¡å¼ï¼Œä½†æ˜¯ç³»ç»Ÿæ˜¯æ·±è‰²æ¨¡å¼ï¼Œå½“ç”¨æˆ·æ‰“å¼€APPæ—¶å¯åŠ¨å›¾ä¼šæ˜¾ç¤ºæ·±è‰²(ç³»ç»Ÿ)çš„å¯åŠ¨å›¾è€Œä¸æ˜¯æµ…è‰²(APP)çš„å¯åŠ¨å›¾ã€‚å¯¹äºå¤§éƒ¨åˆ†çš„äººæ¥è¯´å¯èƒ½è§‰å¾—è¿™ä¸ªé—®é¢˜å¯ä»¥è·³è¿‡ï¼Œå› ä¸ºå¤§éƒ¨åˆ†çš„APPä¹Ÿéƒ½è¿™æ ·ï¼Œä½†æ˜¯æˆ‘æ˜¯ä¸€ä¸ªå®Œç¾ä¸»ä¹‰è€…ï¼Œä¸ºäº†èƒ½è®©ç”¨æˆ·æœ‰ä¸€ä¸ªå®Œç¾çš„ä½“éªŒï¼Œç„¶åæˆ‘å°±å†™äº†<a href="https://github.com/internetWei/LLDynamicLaunchScreen">LLDynamicLaunchScreen</a>ï¼Œå®ƒæœ€åˆçš„ç›®çš„åªæ˜¯ä¸ºäº†é…åˆ<a href="https://github.com/internetWei/llDark">LLDark</a>å®ç°å®Œç¾çš„æš—é»‘æ¨¡å¼ï¼Œåé¢è€ƒè™‘åˆ°å¯èƒ½æœ‰APPæ³¨æ„åˆ°äº†è¿™ä¸€å—çš„ç”¨æˆ·ä½“éªŒæƒ³è¦å®ç°åŠ¨æ€ä¿®æ”¹å¯åŠ¨å›¾ï¼Œæ‰€ä»¥å°±æŠŠå®ƒæŠ½ç¦»å‡ºæ¥å¹¶å¼€æºäº†<a href="https://github.com/internetWei/LLDynamicLaunchScreen">LLDynamicLaunchScreen</a>ã€‚</p><h3 id="å…³äºå¯åŠ¨å›¾çš„å‘"><a href="#å…³äºå¯åŠ¨å›¾çš„å‘" class="headerlink" title="å…³äºå¯åŠ¨å›¾çš„å‘"></a>å…³äºå¯åŠ¨å›¾çš„å‘</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;å¯åŠ¨å›¾è«åå…¶å¦™å˜æˆé»‘è‰²çš„è¿™ä¸ªBUGå·²ç»æœ‰å¾ˆå¤šAPPé‡åˆ°äº†ï¼Œæˆ‘å…¬å¸çš„APPä¹Ÿé‡åˆ°äº†ï¼Œæˆ‘æ‰‹æœºä¸Šçš„å¾®ä¿¡ä¹Ÿé‡åˆ°äº†ï¼ŒåŸºæœ¬å¯ä»¥ç¡®å®šæ˜¯è‹¹æœçš„BUGã€‚å¦‚å›¾1.1(è¿™æ˜¯æˆ‘åœ¨æ‰‹æœºä¸Šå½•åˆ¶çš„ï¼Œå½•åˆ¶æ—¶é—´ä¸º2021å¹´3æœˆ7å·)ï¼Œå¤§å®¶å¯ä»¥å‘ç°æˆ‘åœ¨æ‰“å¼€å¾®ä¿¡APPæ—¶å±å¹•æ˜¯ä¸€ç‰‡é»‘è‰²çš„ï¼Œæˆ‘æ‹¿åŒäº‹çš„æ‰‹æœºæµ‹è¯•äº†å‘ç°ä»–çš„æ‰‹æœºæ‰“å¼€å¾®ä¿¡APPå¯åŠ¨å›¾ä¾æ—§æ˜¯åŸæ¥çš„ä¸€ä¸ªåœ°çƒå’Œä¸€ä¸ªäººï¼Œæ‰€ä»¥ç¡®å®šä¸æ˜¯å¾®ä¿¡æŠŠå¯åŠ¨å›¾æ¢æˆäº†é»‘è‰²(åŒäº‹æ‰‹æœºä¸Šçš„å¾®ä¿¡ç‰ˆæœ¬å’Œæˆ‘æ‰‹æœºä¸Šçš„å¾®ä¿¡ç‰ˆæœ¬æ˜¯ä¸€è‡´çš„ï¼Œè€Œä¸”æˆ‘ä»¬çš„ç³»ç»Ÿç‰ˆæœ¬å·ä¹Ÿä¸€è‡´)ã€‚</p><table><thead><tr><th align="center"><img src="202103061844.gif"></th></tr></thead><tbody><tr><td align="center">å›¾1.1</td></tr></tbody></table><p>&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://github.com/internetWei/LLDynamicLaunchScreen">LLDynamicLaunchScreen</a>æ”¯æŒä¿®å¤å¦‚ä¸Šé—®é¢˜ï¼Œæ‚¨åªéœ€è¦å°†å®ƒé›†æˆåˆ°æ‚¨çš„å·¥ç¨‹ä¸­å³å¯ï¼Œä»€ä¹ˆäº‹æƒ…éƒ½ä¸ç”¨åšï¼Œå›¾2.1è¿™æ ·çš„æƒ…å†µå°†å¯èƒ½ä¸ä¼šå‡ºç°åœ¨æ‚¨çš„APPä¸­ï¼Œæœ€åçš„æƒ…å†µæ˜¯ç”¨æˆ·ç¬¬ä¸€æ¬¡æ‰“å¼€APPæ—¶å¯èƒ½ä¼šå‡ºç°ã€‚</p><table><thead><tr><th align="center"><img src="202102141921.jpg"></th></tr></thead><tbody><tr><td align="center">å›¾2.1</td></tr></tbody></table><h3 id="LLDynamicLaunchScreenä»‹ç»"><a href="#LLDynamicLaunchScreenä»‹ç»" class="headerlink" title="LLDynamicLaunchScreenä»‹ç»"></a>LLDynamicLaunchScreenä»‹ç»</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;<code>LLDynamicLaunchScreen</code>é™¤äº†æ”¯æŒä¸Šè¿°æåˆ°çš„è‡ªåŠ¨ä¿®å¤å¯åŠ¨å›¾è«åå…¶å¦™å˜æˆé»‘è‰²çš„BUGï¼Œè¿˜æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€ä¿®æ”¹APPçš„ä»»æ„å¯åŠ¨å›¾ï¼Œä»…éœ€ä¸€è¡Œä»£ç å³å¯ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;ç›®å‰å¸‚åœºä¸Šå¹¶æ²¡æœ‰å’Œ<code>LLDynamicLaunchScreen</code>ç±»ä¼¼çš„æ¡†æ¶ï¼Œgithubä¸Šæœ‰ä¸€ä¸ª<code>DynamicLaunchImage</code>æ¡†æ¶ä¹Ÿå®ç°äº†åŠ¨æ€æ›¿æ¢å¯åŠ¨å›¾çš„åŠŸèƒ½ï¼Œä½†æ˜¯æˆ‘å¹¶ä¸å»ºè®®æ‚¨ä½¿ç”¨å®ƒï¼Œå…·ä½“åŸå› æˆ‘ä¼šåœ¨ä¸‹é¢çš„å¯¹æ¯”ä¸­è¯¦ç»†æè¿°ã€‚</p><h3 id="å…³äºLLDynamicLaunchScreenå’ŒDynamicLaunchImage"><a href="#å…³äºLLDynamicLaunchScreenå’ŒDynamicLaunchImage" class="headerlink" title="å…³äºLLDynamicLaunchScreenå’ŒDynamicLaunchImage"></a>å…³äºLLDynamicLaunchScreenå’ŒDynamicLaunchImage</h3><ol><li><p><code>LLDynamicLaunchScreen</code>æ˜¯æˆ‘å¼€å‘çš„ä¸€æ¬¾ç”¨äºä¿®å¤iOSä¸ŠAPPå¯åŠ¨å›¾å¼‚å¸¸å’ŒåŠ¨æ€ä¿®æ”¹å¯åŠ¨å›¾çš„æ¡†æ¶ï¼Œå®ƒå®ç°äº†å¦‚ä¸‹åŠŸèƒ½:</p><ol><li>é›†æˆåè‡ªåŠ¨ä¿®å¤APPå¯åŠ¨å›¾å¼‚å¸¸æ˜¾ç¤ºã€‚</li><li>é›†æˆè€…åªéœ€è¦ä¸€è¡Œä»£ç å³å¯ä¿®æ”¹å¯åŠ¨å›¾ã€‚</li><li>æ”¯æŒä¿®æ”¹ä»»æ„ç±»å‹çš„å¯åŠ¨å›¾(æš—é»‘ç«–å±å¯åŠ¨å›¾ã€æš—é»‘æ¨ªå±å¯åŠ¨å›¾ã€æµ…è‰²ç«–å±å¯åŠ¨å›¾ã€æµ…è‰²æ¨ªå±å¯åŠ¨å›¾)ã€‚</li><li>å½“ç”¨æˆ·æ›´æ–°APPåè‡ªåŠ¨æ¢å¤ä¸Šä¸€æ¬¡è®¾ç½®çš„å¯åŠ¨å›¾ã€‚</li><li>æ”¯æŒè·å–å½“å‰æ˜¾ç¤ºçš„å¯åŠ¨å›¾å’Œä»»æ„ç±»å‹çš„å¯åŠ¨å›¾ã€‚</li></ol></li><li><p><code>DynamicLaunchImage</code>æ˜¯ç™¾åº¦å›¢é˜Ÿå¼€å‘çš„ä¸€æ¬¾åŠ¨æ€ä¿®æ”¹å¯åŠ¨å›¾çš„æ¡†æ¶ï¼Œå®ƒåªå®ç°äº†ä¸€ä¸ªåŠ¨æ€ä¿®æ”¹å¯åŠ¨å›¾çš„åŠŸèƒ½ï¼Œè€Œä¸”å½“ç”¨æˆ·æ›´æ–°APPåï¼Œ<code>DynamicLaunchImage</code>å¹¶æ²¡æœ‰è®°å½•ç”¨æˆ·ä¸Šæ¬¡çš„ä¿®æ”¹ä¿¡æ¯ï¼Œå®ƒä¼šå¯¼è‡´ç”¨æˆ·æ›´æ–°ç‰ˆæœ¬åä¸¢å¤±ä¹‹å‰è®¾ç½®çš„å¯åŠ¨å›¾ï¼Œè¿™æ˜¯è‡´å‘½çš„ï¼›å¹¶ä¸”å®ƒä¹Ÿä¸æ”¯æŒå•ç‹¬ä¿®æ”¹æš—é»‘ç³»å¯åŠ¨å›¾æˆ–è€…å•ç‹¬ä¿®æ”¹æµ…è‰²ç³»å¯åŠ¨å›¾ï¼›æœ€è‡´å‘½çš„æ˜¯å®ƒçš„å¼€å‘è€…å¹¶æ²¡æœ‰ç»§ç»­ç»´æŠ¤å®ƒï¼Œæˆ‘æäº¤äº†ä¸€ä¸ªissueså¹¶æ²¡æœ‰äººå»è·Ÿè¿›å¤„ç†ã€‚æ‰€ä»¥å»ºè®®æ‚¨ä½¿ç”¨<a href="https://github.com/internetWei/LLDynamicLaunchScreen">LLDynamicLaunchScreen</a>ã€‚</p></li></ol><h3 id="LLDynamicLaunchScreençš„å…·ä½“æ€è·¯"><a href="#LLDynamicLaunchScreençš„å…·ä½“æ€è·¯" class="headerlink" title="LLDynamicLaunchScreençš„å…·ä½“æ€è·¯"></a>LLDynamicLaunchScreençš„å…·ä½“æ€è·¯</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;<code>LLDynamicLaunchScreen</code>å®ƒçš„æ ¸å¿ƒåŠŸèƒ½å…¶å®å°±æ˜¯æ›¿æ¢ç³»ç»Ÿæœ¬åœ°çš„å¯åŠ¨å›¾ï¼Œä½†æ˜¯æ›¿æ¢çš„è¿‡ç¨‹ä¸­æœ‰å¦‚ä¸‹çš„é—®é¢˜(åªåˆ—ä¸¾äº†ä¸€äº›æ¯”è¾ƒé‡è¦çš„é—®é¢˜):</p><ol><li>æ›¿æ¢ç³»ç»Ÿæœ¬åœ°çš„å¯åŠ¨å›¾ä½†ä¸èƒ½ä¿®æ”¹åŸåç§°ï¼Œå¦åˆ™ç³»ç»Ÿä¼šé‡æ–°ç”Ÿæˆå¯åŠ¨å›¾ï¼Œè¿™å°±éœ€è¦çŸ¥é“æœ¬åœ°çš„å¯åŠ¨å›¾åç§°å¯¹åº”çš„æ˜¯å“ªä¸ªå…·ä½“çš„å¯åŠ¨å›¾(ä¾‹å¦‚æœ¬åœ°å¯åŠ¨å›¾a.pngä»£è¡¨çš„æ˜¯æ·±è‰²ç«–å±å¯åŠ¨å›¾è¿˜æ˜¯æµ…è‰²åšå±å¯åŠ¨å›¾è¿˜æ˜¯â€¦)ã€‚</li><li>ä¸ºäº†å®ç°è‡ªåŠ¨ä¿®å¤å¯åŠ¨å›¾å¼‚å¸¸ï¼Œéœ€è¦åœ¨APPå¯åŠ¨åæ ¹æ®storyboardæ–‡ä»¶ç”Ÿæˆä¸€æ•´å¥—çš„å¯åŠ¨å›¾æ–‡ä»¶å¹¶ä¸”æ›¿æ¢æœ¬åœ°çš„å¯åŠ¨å›¾ï¼Œå¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°ä¸€ä¸ªé—®é¢˜ä¸ç®¡åœ¨ä»€ä¹ˆæ—¶å€™ç”Ÿæˆä¸ç³»ç»Ÿç›¸åæ¨¡å¼çš„å¯åŠ¨å›¾æ€»æ˜¯å¤±è´¥(ä¾‹å¦‚å½“å‰ç³»ç»Ÿæ˜¯æµ…è‰²æ¨¡å¼ï¼Œé‚£ä¹ˆåœ¨ç”Ÿæˆæ·±è‰²å¯åŠ¨å›¾æ—¶å®é™…è·å–åˆ°çš„æ€»æ˜¯æµ…è‰²å¯åŠ¨å›¾)ï¼Œåé¢é€šè¿‡KVOçš„æ€æƒ³è§£å†³äº†è¿™ä¸ªéš¾é¢˜ï¼Œå…·ä½“æ€è·¯æ˜¯åˆ©ç”¨è¿è¡Œæ—¶åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„<code>UIViewControler</code>å¯¹è±¡å¹¶å°†å®ƒä¸ç³»ç»Ÿçš„<code>UIViewController</code>çš„isaæŒ‡é’ˆè¿›è¡Œäº’æ¢ï¼Œç„¶åç›‘å¬å®ƒçš„<code>viewDidAppear:</code>æ–¹æ³•çš„å®ç°ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œå†å»ç”Ÿæˆå¯åŠ¨å›¾å°±å¯ä»¥äº†ï¼Œå½“ç›‘å¬å®Œæˆåä¼šè‡ªåŠ¨é‡Šæ”¾åˆ›å»ºçš„å¯¹è±¡ç„¶åå°†isaæŒ‡é’ˆè¿˜åŸå›å»ã€‚</li><li>åœ¨iOS13ä»¥ä¸‹çš„çœŸæœºä¸­æ²¡æœ‰å¯åŠ¨å›¾æ–‡ä»¶å¤¹çš„è¯»å–å’Œä¿®æ”¹æƒé™ï¼Œé’ˆå¯¹è¿™ä¸ªé—®é¢˜ç¡®å®æ„äº†å¾ˆå¤šå¤©ï¼Œå°±åœ¨æˆ‘æƒ³æ”¾å¼ƒiOS13ä»¥ä¸‹ç³»ç»Ÿå¯ä»¥åŠ¨æ€ä¿®æ”¹å¯åŠ¨å›¾çš„æƒ³æ³•å‰ï¼Œæˆ‘çœ‹åˆ°äº†<code>DynamicLaunchImage</code>çš„ä¸€ç¯‡å®ç°æ–‡ç« ï¼Œæ–‡ç« ä¸­æåˆ°å®ƒä¹Ÿé‡åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œå¹¶ä¸”é€šè¿‡<code>moveItemAtPath: toPath: error:</code>è¿™ä¸ªæ–¹æ³•è§£å†³äº†ã€‚ç»è¿‡æµ‹è¯•å‘ç°ç¡®å®å¯ä»¥å˜ç›¸çš„è¾¾åˆ°è·å–å¯åŠ¨å›¾ä¿¡æ¯å¹¶ä¸”æ›¿æ¢å¯åŠ¨å›¾çš„åŠŸèƒ½ï¼Œåœ¨è¿™é‡Œæ„Ÿè°¢<code>DynamicLaunchImage</code>æä¾›çš„æ€è·¯ã€‚</li></ol><p>&nbsp;&nbsp;&nbsp;&nbsp;å…·ä½“çš„å®ç°ç»†èŠ‚å¤§å®¶å¯ä»¥é˜…è¯»<a href="https://github.com/internetWei/LLDynamicLaunchScreen">LLDynamicLaunchScreen</a>æºç ï¼Œä¾‹å¦‚å®ƒæ˜¯æ€ä¹ˆåœ¨ç”¨æˆ·æ›´æ–°ç‰ˆæœ¬åè‡ªåŠ¨è¿˜åŸè‡³ä¹‹å‰çš„è®¾ç½®ã€‚</p><p>&nbsp;&nbsp;&nbsp;&nbsp;å¦‚æœæ‚¨æœ‰æ›´å¥½çš„æ„è§æˆ–è€…å‘ç°æœ‰ä»»ä½•BUGï¼Œæ¬¢è¿æ‚¨æäº¤<a href="https://github.com/internetWei/LLDynamicLaunchScreen/issues">issues</a>æˆ–è€…è”ç³»æˆ‘ã€‚</p><h3 id="ä¸è¶³ä¹‹å¤„"><a href="#ä¸è¶³ä¹‹å¤„" class="headerlink" title="ä¸è¶³ä¹‹å¤„"></a>ä¸è¶³ä¹‹å¤„</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºiOSç³»ç»Ÿçš„é™åˆ¶ï¼Œæ›´æ–°APPåç¬¬ä¸€æ¬¡æ‰“å¼€ä¼šæ˜¾ç¤ºé»˜è®¤å¯åŠ¨å›¾ï¼Œä¹‹åæ‰ä¼šæ˜¾ç¤ºè‡ªå®šä¹‰çš„å¯åŠ¨å›¾ã€‚å¦å¤–å®ƒæš‚æ—¶å¯¹iPadçš„æ”¯æŒæ€§ä¸æ˜¯å¾ˆå¥½ï¼Œå› ä¸ºiPadæœ‰å¤šè¾¾10ç§å¯åŠ¨å›¾æ ·å¼ï¼Œå»ºè®®ä¸è¦è¦iPadä¸­ä½¿ç”¨å®ƒï¼Œåç»­æˆ‘ä¼šå‡çº§å®ƒæ”¯æŒiPadã€‚<code>LLDynamicLaunchScreen</code>å®ƒä¸æ”¯æŒéLaunchScreené…ç½®çš„å¯åŠ¨å›¾(ç°åœ¨åº”è¯¥æ²¡æœ‰APPæ²¡æœ‰ä½¿ç”¨LaunchScreené€‚é…å¯åŠ¨å›¾äº†å§)ã€‚</p><h3 id="LLDynamicLaunchScreenæ•ˆæœå›¾"><a href="#LLDynamicLaunchScreenæ•ˆæœå›¾" class="headerlink" title="LLDynamicLaunchScreenæ•ˆæœå›¾"></a>LLDynamicLaunchScreenæ•ˆæœå›¾</h3><table><thead><tr><th align="center"><img src="160c58e9014740029800c2ffc4752965~tplv-k3u1fbpfcp-zoom-1.image"></th></tr></thead><tbody><tr><td align="center"><a href="https://github.com/internetWei/LLDynamicLaunchScreen">LLDynamicLaunchScreen</a></td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ObjC </tag>
            
            <tag> Framework </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iOSé€‚é…æ·±è‰²æ¨¡å¼æœ€ä½³æ–¹æ³•ï¼Œç»å¯¹å¹²è´§</title>
      <link href="/2020/12/05/iOS/iOS%E9%80%82%E9%85%8D%E6%B7%B1%E8%89%B2%E6%A8%A1%E5%BC%8F%E6%9C%80%E4%BD%B3%E6%96%B9%E6%B3%95%EF%BC%8C%E7%BB%9D%E5%AF%B9%E5%B9%B2%E8%B4%A7/"/>
      <url>/2020/12/05/iOS/iOS%E9%80%82%E9%85%8D%E6%B7%B1%E8%89%B2%E6%A8%A1%E5%BC%8F%E6%9C%80%E4%BD%B3%E6%96%B9%E6%B3%95%EF%BC%8C%E7%BB%9D%E5%AF%B9%E5%B9%B2%E8%B4%A7/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç”± å¸ƒå¤š(budo) å‘å¸ƒäº 2020-12-05</p></blockquote><h1 id="LLDark"><a href="#LLDark" class="headerlink" title="LLDark"></a>LLDark</h1><p>é€‚ç”¨äºiOSçš„å¼ºå¤§æ·±è‰²ä¸»é¢˜æ¡†æ¶ï¼Œå¿«é€Ÿé€‚é…æ·±è‰²æ¨¡å¼ã€‚<br>å›½å†…ç”¨æˆ·å¯ä»¥è®¿é—®<a href="https://gitee.com/internetWei/llDark">è¿™ä¸ªé“¾æ¥</a></p><h1 id="ç‰¹æ€§"><a href="#ç‰¹æ€§" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h1><ul><li>é›†æˆç®€å•ï¼Œåªéœ€æ”¹åŠ¨å°‘é‡ä»£ç å³å¯å®Œç¾é€‚é…ã€‚</li><li>é«˜æ€§èƒ½ï¼Œä»…åœ¨éœ€è¦æ›´æ–°é¡µé¢æ—¶æ›´æ–°æŒ‡å®šé¡µé¢ï¼Œæœ‰ç›¸å…³ç¼“å­˜ç­–ç•¥ç¼©çŸ­åˆ·æ–°æ—¶é•¿ã€‚</li><li>åŠŸèƒ½å¼ºå¤§ï¼Œæ‰€æœ‰ä½¿ç”¨UIColorã€UIImageã€CGColorçš„åœ°æ–¹å‡å¯å®Œç¾é€‚é…ã€‚</li><li>å…¼å®¹iOS13ä»¥ä¸‹æœºå‹ã€‚</li><li>æ”¯æŒä»ç½‘ç»œä¸Šè·å–æ·±è‰²ä¸»é¢˜é…ç½®ã€‚</li><li>è‡ªåŠ¨é€‚é…å¯åŠ¨å›¾ä¸ºAPPå½“å‰ä¸»é¢˜æ¨¡å¼ã€‚</li></ul><h1 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h1><p><img src="eb36809a0d784094abb1f173d36e0f5e~tplv-k3u1fbpfcp-zoom-1.image" alt="Manual.gif"> <img src="c62d05b8d9b14c1e9b5fc86d5c4e15fc~tplv-k3u1fbpfcp-zoom-1.image" alt="System.gif"> <img src="ea92ed26bf5e466392e0edf9dc9abe0b~tplv-k3u1fbpfcp-zoom-1.image" alt="Screen.gif"></p><h1 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h1><h3 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h3><p>é…ç½®æ·±è‰²èµ„æºï¼š<br>åœ¨å·¥ç¨‹ä»»æ„NSObjectåˆ†ç±»(å»ºè®®å•ç‹¬æ–°å»ºä¸€ä¸ªä¸»é¢˜åˆ†ç±»)ä¸­åˆ›å»º<code>+ (NSDictionary&lt;id, id&gt; *)llDarkTheme</code>ç±»æ–¹æ³•ï¼Œå­—å…¸çš„keyè¡¨ç¤ºæµ…è‰²ä¸»é¢˜ä¸‹çš„é¢œè‰²&#x2F;å›¾ç‰‡åç§°&#x2F;å›¾ç‰‡åœ°å€ï¼Œå­—å…¸çš„valueè¡¨ç¤ºæ·±è‰²ä¸»é¢˜ä¸‹çš„é¢œè‰²&#x2F;å›¾ç‰‡åç§°&#x2F;å›¾ç‰‡åœ°å€ã€‚å¯å‚è€ƒæ ·ä¾‹ä»£ç ï¼š</p><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="built_in">NSDictionary</span>&lt;<span class="type">id</span>, <span class="type">id</span>&gt; *)llDarkTheme &#123;</span><br><span class="line">    <span class="keyword">return</span> @&#123;</span><br><span class="line">             <span class="built_in">UIColor</span>.whiteColor : kColorRGB(<span class="number">27</span>, <span class="number">27</span>, <span class="number">27</span>),</span><br><span class="line">             kColorRGB(<span class="number">240</span>, <span class="number">238</span>, <span class="number">245</span>) : kColorRGB(<span class="number">39</span>, <span class="number">39</span>, <span class="number">39</span>),</span><br><span class="line">             [<span class="built_in">UIColor</span> colorWithRed:<span class="number">14.0</span> / <span class="number">255.0</span> green:<span class="number">255.0</span> / <span class="number">255.0</span> blue:<span class="number">0.0</span> alpha:<span class="number">1.0</span>] : [<span class="built_in">UIColor</span> colorWithRed:<span class="number">0.0</span> green:<span class="number">14.0</span> / <span class="number">255.0</span> blue:<span class="number">255.0</span> / <span class="number">255.0</span> alpha:<span class="number">1.0</span>],</span><br><span class="line">             <span class="string">@&quot;background_light&quot;</span> : <span class="string">@&quot;background_dark&quot;</span>,</span><br><span class="line">             <span class="string">@&quot;~/path/background_light.png&quot;</span> : <span class="string">@&quot;~/path/background_dark.png&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Tips:<br><code>1.ä¸å¿…æŠŠæ‰€æœ‰æƒ…å†µä¸‹çš„é¢œè‰²/å›¾ç‰‡éƒ½å¡«å†™è¿›å»ï¼Œå¯¹äºå¶å°”æˆ–å°‘æ•°ä½¿ç”¨åˆ°çš„æ·±è‰²é¢œè‰²å¯ä»¥å‚è€ƒé«˜çº§ç”¨æ³•å•ç‹¬é€‚é…ã€‚ 2.å›¾ç‰‡åç§°ä¸ç”¨è€ƒè™‘å€å›¾å…³ç³»ï¼›å¦‚æœå¡«å†™çš„æ˜¯å›¾ç‰‡è·¯å¾„ä¸€å®šè¦å¡«å†™å®Œæ•´çš„å›¾ç‰‡è·¯å¾„(åŒ…å«åç¼€)ã€‚</code></p><h3 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h3><p>UIColorå’ŒCGColoråªéœ€è¦è¿½åŠ .themeColor(nil)å³å¯ã€‚<br>UIImageåªéœ€è¦å°†imageNamedæˆ–imageWithContentsOfFileæ›¿æ¢ä¸ºthemeImageå³å¯ã€‚</p><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// UIColor</span></span><br><span class="line"><span class="built_in">UIColor</span>.redColor; <span class="comment">// ä¹‹å‰çš„ç”¨æ³•</span></span><br><span class="line"><span class="built_in">UIColor</span>.redColor.themeColor(<span class="literal">nil</span>); <span class="comment">// ç°åœ¨çš„ç”¨æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// CGColor</span></span><br><span class="line"><span class="built_in">UIColor</span>.redColor.CGColor; <span class="comment">// ä¹‹å‰çš„ç”¨æ³•</span></span><br><span class="line"><span class="built_in">UIColor</span>.redColor.themeCGColor(<span class="literal">nil</span>); <span class="comment">// ç°åœ¨çš„ç”¨æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// UIImage</span></span><br><span class="line">[<span class="built_in">UIImage</span> imageNamed:<span class="string">@&quot;lightImageName&quot;</span>]; <span class="comment">// ä¹‹å‰çš„ç”¨æ³•</span></span><br><span class="line">[<span class="built_in">UIImage</span> themeImage:<span class="string">@&quot;lightImageName&quot;</span>]; <span class="comment">// ç°åœ¨çš„ç”¨æ³•</span></span><br></pre></td></tr></table></figure><p>Tips:<br><code>1.themeImageé€‚é…äº†imageNamedå’ŒimageWithContentsOfFileä¸¤ä¸ªæ–¹æ³•ï¼Œå¯ä»¥ä¼ é€’å›¾ç‰‡åç§°ï¼Œä¹Ÿå¯ä»¥ä¼ é€’å›¾ç‰‡è·¯å¾„ã€‚ 2.åªæœ‰é€‚é…è¿‡çš„Colorå’ŒImageåœ¨ä¸»é¢˜åˆ‡æ¢æ—¶æ‰ä¼šåˆ·æ–°ã€‚ </code></p><h3 id="é«˜çº§ç”¨æ³•"><a href="#é«˜çº§ç”¨æ³•" class="headerlink" title="é«˜çº§ç”¨æ³•"></a>é«˜çº§ç”¨æ³•</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span>themeColor()é‡Œé¢çš„å‚æ•°å¦‚æœæ˜¯å…·ä½“çš„Colorå¯¹è±¡ï¼Œæ·±è‰²ä¸»é¢˜åˆ™ä¼šä½¿ç”¨æŒ‡å®šçš„Colorå¯¹è±¡åˆ·æ–°,</span><br><span class="line">å¦‚æœæ˜¯<span class="literal">nil</span>åˆ™ä¼šè¿”å›llDarkThemeä¸­é…ç½®çš„æ·±è‰²é¢œè‰²åˆ·æ–°ï¼Œ</span><br><span class="line">å¦‚æœllDarkThemeæœªé…ç½®åˆ™ä¼šè¿”å›æµ…è‰²ä¸»é¢˜ä¸‹çš„é¢œè‰²ã€‚</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>themeCGColor()å‚æ•°çš„ä½œç”¨å’ŒthemeColor()å‚æ•°ä½œç”¨ä¸€æ ·ã€‚</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>themeImage()æœ‰<span class="number">2</span>ä¸ªå‚æ•°ï¼Œå‚æ•°å¯ä»¥æ˜¯å›¾ç‰‡åç§°ï¼Œä¹Ÿå¯ä»¥æ˜¯å›¾ç‰‡åœ°å€,</span><br><span class="line">ç¬¬<span class="number">1</span>ä¸ªå‚æ•°è¡¨ç¤ºæµ…è‰²ä¸»é¢˜ä¸‹ä½¿ç”¨çš„å›¾ç‰‡(å¿…å¡«)ï¼Œ</span><br><span class="line">ç¬¬<span class="number">2</span>ä¸ªå‚æ•°è¡¨ç¤ºæ·±è‰²ä¸»é¢˜ä¸‹ä½¿ç”¨çš„å›¾ç‰‡(å¯ä»¥ä¸ºç©º)ï¼Œ</span><br><span class="line">ç¬¬<span class="number">2</span>ä¸ªå‚æ•°ä¸ºç©ºçš„è¯å’ŒthemeColor()ä¸ºç©ºçš„å¤„ç†æ–¹å¼ä¸€æ ·ã€‚</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>appearanceBindUpdaterï¼Œæ‰€æœ‰ç»§æ‰¿è‡ª<span class="built_in">UIView</span>çš„å¯¹è±¡éƒ½æ‹¥æœ‰è¿™ä¸ªå±æ€§ï¼Œ</span><br><span class="line">å¯¹è±¡éœ€è¦åˆ·æ–°æ—¶ä¼šè°ƒç”¨å®ƒï¼Œå¯ä»¥åœ¨è¿™é‡Œå®ç°è‡ªå·±çš„åˆ·æ–°é€»è¾‘ã€‚</span><br><span class="line">ä»…åœ¨éœ€è¦åˆ·æ–°æ—¶ä¼šè°ƒç”¨ï¼Œä¸»é¢˜æ›´æ”¹ä¸ä¸€å®šéœ€è¦åˆ·æ–°UIã€‚</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>userInterfaceStyleï¼Œç±»ä¼¼iOS13ç³»ç»Ÿçš„overrideUserInterfaceStyleæ–¹æ³•ï¼Œ</span><br><span class="line">ä½†æ˜¯åŠŸèƒ½æ¯”overrideUserInterfaceStyleæ›´åŠ å¼ºå¤§ï¼Œ</span><br><span class="line">å®ƒæ”¯æŒæ‰€æœ‰çš„å¯¹è±¡ï¼Œä¾‹å¦‚<span class="built_in">CALayer</span>ã€‚</span><br><span class="line">å®ƒæ”¯æŒiOS13ä»¥ä¸‹çš„ç³»ç»Ÿä½¿ç”¨ã€‚</span><br><span class="line"></span><br><span class="line"><span class="number">6.</span>themeDidChangeï¼Œæ‰€æœ‰å¯¹è±¡éƒ½æ‹¥æœ‰è¿™ä¸ªå±æ€§ï¼Œä½œç”¨å’ŒThemeDidChangeNotificationä¸€æ ·ï¼Œ</span><br><span class="line">themeDidChangeä¼šåœ¨å¯¹è±¡é‡Šæ”¾æ—¶è¢«é‡Šæ”¾æ‰ï¼Œ</span><br><span class="line">å¯ä»¥åœ¨å¤šä¸ªåœ°æ–¹ä½¿ç”¨ï¼Œä¸ä¿è¯å›è°ƒé¡ºåºï¼Œ</span><br><span class="line">ä¸åŒäºappearanceBindUpdaterï¼Œåªè¦ä¸»é¢˜å‘ç”Ÿæ”¹å˜å°±ä¼šè°ƒç”¨themeDidChangeã€‚</span><br><span class="line"></span><br><span class="line"><span class="number">7.</span>systemThemeDidChangeï¼Œæ‰€æœ‰å¯¹è±¡éƒ½æ‹¥æœ‰è¿™ä¸ªå±æ€§ï¼Œä½œç”¨å’ŒSystemThemeDidChangeNotificationä¸€æ ·ï¼Œ</span><br><span class="line">é‡Šæ”¾æ—¶æœºå’ŒthemeDidChangeä¸€æ ·ï¼Œ</span><br><span class="line">å¯ä»¥åœ¨å¤šä¸ªåœ°æ–¹ä½¿ç”¨ï¼Œä¸ä¿è¯å›è°ƒé¡ºåºï¼Œ</span><br><span class="line">åªè¦ç³»ç»Ÿä¸»é¢˜å‘ç”Ÿæ”¹å˜å°±ä¼šè°ƒç”¨systemThemeDidChangeã€‚</span><br><span class="line"></span><br><span class="line"><span class="number">8.</span>darkStyleï¼Œæ‰€æœ‰<span class="built_in">UIImageView</span>å¯¹è±¡éƒ½æ‹¥æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œç”¨äºé€‚é…æ²¡æœ‰æ·±è‰²å›¾ç‰‡çš„å›¾ç‰‡å¯¹è±¡ï¼Œä¾‹å¦‚ç½‘ç»œå›¾ç‰‡ã€‚</span><br><span class="line">darkStyleæœ‰<span class="number">3</span>ä¸ªå‚æ•°ï¼Œç¬¬<span class="number">1</span>ä¸ªå‚æ•°å†³å®šå¦‚ä½•é€‚é…æ·±è‰²ä¸»é¢˜ï¼Œç›®å‰æœ‰LLDarkStyleSaturationå’ŒLLDarkStyleMaskä¸¤ç§ï¼Œ</span><br><span class="line">LLDarkStyleMaskä½¿ç”¨è’™å±‚é€‚é…ï¼ŒLLDarkStyleSaturationé€šè¿‡é™ä½åŸå›¾é¥±åˆåº¦é€‚é…ã€‚</span><br><span class="line">ç¬¬<span class="number">2</span>ä¸ªå‚æ•°å†³å®šè’™å±‚é€æ˜åº¦/é¥±åˆåº¦å€¼ï¼Œå…·ä½“ä½¿ç”¨å¯çœ‹æºç æ³¨é‡Šã€‚</span><br><span class="line">ç¬¬<span class="number">3</span>ä¸ªå‚æ•°å¯ä»¥ä¸º<span class="literal">nil</span>ï¼Œä½¿ç”¨LLDarkStyleSaturationæ—¶éœ€è¦ä¼ é€’ä¸€ä¸ªå”¯ä¸€å­—ç¬¦ä¸²å½“åšæ ‡è¯†ç¬¦ï¼Œé€šå¸¸æ˜¯å›¾ç‰‡çš„urlã€‚</span><br><span class="line">æ ·ä¾‹ä»£ç ï¼š</span><br><span class="line"><span class="built_in">UIImageView</span> *imageView = [[<span class="built_in">UIImageView</span> alloc] init];</span><br><span class="line"><span class="built_in">NSString</span> *url = <span class="string">@&quot;å›¾ç‰‡URL&quot;</span>;</span><br><span class="line">imageView.darkStyle(LLDarkStyleSaturation, <span class="number">0.2</span>, url);</span><br><span class="line"><span class="comment">// imageView.darkStyle(LLDarkStyleMask, 0.5, nil);</span></span><br><span class="line"></span><br><span class="line"><span class="number">9.</span>updateDarkTheme:ï¼Œå¦‚æœéœ€è¦è¿è¡Œæ—¶ä¿®æ”¹æ·±è‰²ä¸»é¢˜é…ç½®ä¿¡æ¯ï¼Œæˆ–è€…éœ€è¦ä»ç½‘ç»œä¸Šè·å–æ·±è‰²ä¸»é¢˜é…ç½®ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨updateDarkTheme:æ¥è¾¾åˆ°ç›®çš„ã€‚</span><br><span class="line">è¯·ç¡®ä¿åœ¨ç¬¬<span class="number">1</span>ä¸ªUIå¯¹è±¡åŠ è½½å‰é…ç½®å¥½æ·±è‰²ä¸»é¢˜ä¿¡æ¯ï¼Œå¦åˆ™ä¼šæ— æ•ˆã€‚</span><br><span class="line">æ ·ä¾‹ä»£ç :</span><br><span class="line"><span class="built_in">NSDictionary</span> *darkTheme = @&#123;</span><br><span class="line">    <span class="built_in">UIColor</span>.whiteColor : kColorRGB(<span class="number">27</span>, <span class="number">27</span>, <span class="number">27</span>),</span><br><span class="line">    kColorRGB(<span class="number">240</span>, <span class="number">238</span>, <span class="number">245</span>) : kColorRGB(<span class="number">39</span>, <span class="number">39</span>, <span class="number">39</span>),</span><br><span class="line">    [<span class="built_in">UIColor</span> colorWithRed:<span class="number">14.0</span> / <span class="number">255.0</span> green:<span class="number">255.0</span> / <span class="number">255.0</span> blue:<span class="number">0.0</span> alpha:<span class="number">1.0</span>] : [<span class="built_in">UIColor</span> colorWithRed:<span class="number">0.0</span> green:<span class="number">14.0</span> / <span class="number">255.0</span> blue:<span class="number">255.0</span> /  <span class="number">255.0</span> alpha:<span class="number">1.0</span>],</span><br><span class="line">    <span class="string">@&quot;background_light&quot;</span> : <span class="string">@&quot;background_dark&quot;</span>,</span><br><span class="line">    <span class="string">@&quot;~/path/background_light.png&quot;</span> : <span class="string">@&quot;~/path/background_dark.png&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line">[LLDarkSource updateDarkTheme:darkTheme];</span><br><span class="line"></span><br><span class="line"><span class="number">10.</span>thirdControlClassNameï¼Œå¦‚æœéœ€è¦æ”¯æŒç¬¬<span class="number">3</span>æ–¹æ§ä»¶çš„åˆ·æ–°æ–¹æ³•ï¼Œå¯ä»¥åœ¨appearanceBindUpdaterä¸­å•ç‹¬å®ç°åˆ·æ–°é€»è¾‘ï¼Œä¹Ÿå¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ–¹æ³•å®ç°åˆ·æ–°é€»è¾‘ï¼Œæ›´åŠ æ¨èå¦‚ä¸‹æ–¹æ³•ã€‚</span><br><span class="line">é¦–å…ˆéœ€è¦å®ç°thirdControlClassNameè¿™ä¸ªç±»æ–¹æ³•ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„åŒ…å«ç¬¬<span class="number">3</span>æ–¹æ§ä»¶çš„ç±»åå­—ç¬¦ä¸²ã€‚</span><br><span class="line">ç„¶åå®ç°refresh+ç±»åå­—ç¬¦ä¸²çš„å¯¹è±¡æ–¹æ³•ï¼Œåœ¨æ–¹æ³•é‡Œå®ç°ç¬¬<span class="number">3</span>æ–¹æ§ä»¶çš„åˆ·æ–°é€»è¾‘ï¼Œå¯ä»¥å‚è€ƒLLThird.mæ–‡ä»¶ä¸­å·²ç»å®ç°çš„YYLabelçš„åˆ·æ–°é€»è¾‘ã€‚</span><br><span class="line">è¯¦æƒ…å¯ä»¥ä¸‹è½½å·¥ç¨‹æŸ¥çœ‹Demoäº†è§£å…·ä½“å®ç°ã€‚</span><br></pre></td></tr></table></figure><p>é«˜çº§ç”¨æ³•ä¸­ç¬¬8æ¡darkStyleæ–¹æ³•çš„æ ·ä¾‹å›¾(ä¸ºäº†çªå‡ºæ•ˆæœç‰¹æ„å°†é¥±åˆåº¦å’Œé€æ˜åº¦è°ƒæ•´çš„å¾ˆä½)ï¼š<br><img src="1241324201ce4deea2ab431d547b9a62~tplv-k3u1fbpfcp-zoom-1.image" alt="137a9000178656346577e"> </p><h1 id="å¿«é€Ÿé€‚é…"><a href="#å¿«é€Ÿé€‚é…" class="headerlink" title="å¿«é€Ÿé€‚é…"></a>å¿«é€Ÿé€‚é…</h1><p>ä»…éœ€è¦3æ­¥å³å¯å¿«é€Ÿå®Œç¾é€‚é…æ·±è‰²ä¸»é¢˜æ¨¡å¼ï¼Œç»æµ‹è¯•å¤§éƒ¨åˆ†å·¥ç¨‹éƒ½èƒ½åœ¨0.5å¤©å†…é€‚é…å®Œæˆï¼Œ<br>å°‘é‡å·¥ç¨‹1å¤©å†…é€‚é…å®Œæˆï¼Œæå°‘éœ€è¦1å¤©ä»¥ä¸Šçš„å·¥ä½œé‡è¿›è¡Œé€‚é…ã€‚</p><ol><li>é…ç½®æ·±è‰²ä¸»é¢˜èµ„æºï¼Œå¯å‚è€ƒ<code>å‰æ</code>ï¼Œä¹Ÿå¯ä»¥å‚è€ƒ<code>é«˜çº§æ–¹æ³•9</code>ä»ç½‘ç»œä¸­è·å–èµ„æºé€‚é…ã€‚</li><li>å°†éœ€è¦é€‚é…çš„Colorå’ŒImageé€‚é…ä¸ºä¸»é¢˜Colorå’Œä¸»é¢˜Imageï¼Œé€‚é…æ–¹æ³•å¯å‚è€ƒ<code>åŸºç¡€ç”¨æ³•</code>å’Œ<code>é«˜çº§ç”¨æ³•</code>ã€‚</li><li>è¿è¡Œå·¥ç¨‹ï¼Œæ£€æŸ¥å®Œæ•´æ€§ã€‚</li></ol><p>Tips:<br>å¦‚æœæ‚¨è¿˜éœ€è¦é€‚é…<code>WKWebView</code>ï¼Œå¯ä»¥<a href="https://www.jianshu.com/p/be578117f84c">ç‚¹å‡»é“¾æ¥</a>å‚è€ƒæ–‡ç« è¿›è¡Œé€‚é…ã€‚</p><h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><h3 id="CocoaPods"><a href="#CocoaPods" class="headerlink" title="CocoaPods"></a>CocoaPods</h3><ol><li>å°† cocoapods æ›´æ–°è‡³æœ€æ–°ç‰ˆæœ¬ã€‚</li><li>åœ¨ Podfile ä¸­æ·»åŠ  pod â€˜LLDarkâ€™ã€‚</li><li>æ‰§è¡Œ pod install æˆ– pod updateã€‚</li><li>å¯¼å…¥ &lt;LLDark&#x2F;LLDark.h&gt;ã€‚</li></ol><h3 id="æ‰‹åŠ¨å®‰è£…"><a href="#æ‰‹åŠ¨å®‰è£…" class="headerlink" title="æ‰‹åŠ¨å®‰è£…"></a>æ‰‹åŠ¨å®‰è£…</h3><ol><li>ä¸‹è½½ LLDark æ–‡ä»¶å¤¹å†…çš„æ‰€æœ‰å†…å®¹ã€‚</li><li>å°† LLDark å·¥ç¨‹ä¸­çš„LLDarkæ–‡ä»¶å¤¹æ·»åŠ (æ‹–æ”¾)åˆ°ä½ çš„å·¥ç¨‹ã€‚</li><li>å¯¼å…¥ â€œLLDark.hâ€ã€‚</li></ol><h1 id="ç³»ç»Ÿè¦æ±‚"><a href="#ç³»ç»Ÿè¦æ±‚" class="headerlink" title="ç³»ç»Ÿè¦æ±‚"></a>ç³»ç»Ÿè¦æ±‚</h1><p>è¯¥é¡¹ç›®æœ€ä½æ”¯æŒiOS9.0å’ŒXcode10.0ï¼Œå¦‚æœæƒ³åœ¨æ›´ä½ç³»ç»Ÿä¸Šä½¿ç”¨è¯·è”ç³»ä½œè€…ã€‚</p><h1 id="æ³¨æ„ç‚¹"><a href="#æ³¨æ„ç‚¹" class="headerlink" title="æ³¨æ„ç‚¹"></a>æ³¨æ„ç‚¹</h1><ol><li>éœ€è¦è‡ªå·±ç›‘å¬ä¸»é¢˜æ¨¡å¼ä¿®æ”¹çŠ¶æ€æ é¢œè‰²ã€‚</li></ol><h1 id="å·²çŸ¥é—®é¢˜"><a href="#å·²çŸ¥é—®é¢˜" class="headerlink" title="å·²çŸ¥é—®é¢˜"></a>å·²çŸ¥é—®é¢˜</h1><ul><li>éœ€è¦é€‚é…æ·±è‰²ä¸»é¢˜çš„å›¾ç‰‡èµ„æºè¯·ä¸è¦æ”¾åœ¨Assets.xcassetsä¸­ï¼Œå¦åˆ™å¯èƒ½ä¼šè·å–ä¸åˆ°ã€‚</li><li>æš‚æ—¶ä¸æ”¯æŒå…¶ä»–ä¸»é¢˜æ¨¡å¼ï¼Œåç»­ä¼šæ”¯æŒå¤šç§ä¸»é¢˜è‡ªç”±æ­é…ã€‚</li></ul><h1 id="è”ç³»ä½œè€…"><a href="#è”ç³»ä½œè€…" class="headerlink" title="è”ç³»ä½œè€…"></a>è”ç³»ä½œè€…</h1><p>å¦‚æœä½ æœ‰æ›´å¥½çš„æ”¹è¿›ï¼Œplease pull reqeust me</p><p>å¦‚æœä½ æœ‰ä»»ä½•æ›´å¥½çš„æ„è§ï¼Œè¯·åˆ›å»ºä¸€ä¸ª<a href="https://github.com/internetWei/llDark/issues">Issue</a></p><p>å¯ä»¥é€šè¿‡æ­¤é‚®ç®±è”ç³»ä½œè€…<code>internetwei@foxmail.com</code></p><h1 id="è®¸å¯è¯"><a href="#è®¸å¯è¯" class="headerlink" title="è®¸å¯è¯"></a>è®¸å¯è¯</h1><p>LLDark ä½¿ç”¨ MIT è®¸å¯è¯ï¼Œè¯¦æƒ…è§ LICENSE æ–‡ä»¶ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ObjC </tag>
            
            <tag> Framework </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
